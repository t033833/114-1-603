
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂâõÂ•ΩÂ≠∏ÔºöË™≤Â†Ç‰∫íÂãïso easy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* --- ÂÖ®Êñ∞ÂàùÂßãÁï´Èù¢ÁæéÂåñÊ®£Âºè --- */
        body.initial-view-background {
            background-color: #f0f4f8; /* Fallback */
            background-image:
                radial-gradient(circle at 1px 1px, #d1d5db 1px, transparent 0),
                radial-gradient(circle at 20px 20px, #d1d5db 1px, transparent 0);
            background-size: 40px 40px;
        }

        .role-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #ffffff;
            padding: 1.25rem 1rem;
            border-radius: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
            transition: all 0.3s ease-in-out;
            text-align: center;
        }
        @media (min-width: 640px) {
            .role-card {
                padding: 1.5rem 1.25rem;
            }
        }
        @media (min-width: 768px) {
            .role-card {
                padding: 2rem 1.5rem;
            }
        }
        .role-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
            border-color: #93c5fd; /* Light blue border on hover */
        }
        .role-card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.3s ease-in-out;
        }
        @media (min-width: 640px) {
            .role-card-icon {
                width: 70px;
                height: 70px;
                font-size: 2.25rem;
            }
        }
        @media (min-width: 768px) {
            .role-card-icon {
                width: 80px;
                height: 80px;
                font-size: 2.5rem;
            }
        }
        .role-card .btn {
            font-size: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        @media (min-width: 640px) {
            .role-card .btn {
                font-size: 1.1rem;
                padding-top: 0.625rem;
                padding-bottom: 0.625rem;
            }
        }
        /* --- ÂàùÂßãÁï´Èù¢Ê®£ÂºèÁµêÊùü --- */

        /* Ëá™Ë®ÇÊ®£Âºè */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8; /* ÊüîÂíåÁöÑËÉåÊôØËâ≤ */
        }
        /* Èö±ËóèÂÖÉÁ¥†ÁöÑÈÄöÁî® class */
        .hidden {
            display: none;
        }
        /* ÊåâÈàïÊ®£Âºè (Áõ¥Êé•Âú® HTML ‰∏≠‰ΩøÁî® Tailwind classÔºå‰∏ç‰ΩøÁî® @apply) */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            line-height: 1.75rem;
            font-weight: 700;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn-primary { background-color: #2563eb; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-green { background-color: #16a34a; }
        .btn-green:hover { background-color: #15803d; }
        .btn-orange { background-color: #ea580c; }
        .btn-orange:hover { background-color: #c2410c; }
        .btn-purple { background-color: #9333ea; }
        .btn-purple:hover { background-color: #7e22ce; }
        .btn-red { background-color: #dc2626; }
        .btn-red:hover { background-color: #b91c1c; }
        .btn-teal { background-color: #0d9488; } /* New Teal color */
        .btn-teal:hover { background-color: #0f766e; }
        .btn-gray { background-color: #9ca3af; cursor: not-allowed; }

        /* Êê∂Á≠îÊåâÈàïÊ®£Âºè */
        .quick-answer-btn {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 24px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        .quick-answer-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }
        .quick-answer-btn:active {
            transform: scale(0.95);
        }
        .quick-answer-btn.locked {
            background: #9ca3af;
            cursor: not-allowed;
            animation: none;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Áπ™ÂúñÊùø Canvas Ê®£Âºè */
        #drawing-canvas {
            border: 2px solid #cbd5e1;
            border-radius: 0.5rem;
            cursor: crosshair;
            touch-action: none; /* Èò≤Ê≠¢Âú® canvas ‰∏äÁπ™ÂúñÊôÇËß∏ÁôºÈ†ÅÈù¢ÊªæÂãï */
            display: block; /* Ensures it takes up its own line and respects margins */
            margin: 0 auto; /* Center the canvas */
            background-color: white; /* Áπ™ÂúñÁï´Â∏ÉËÉåÊôØËâ≤ */
            flex-grow: 1; /* Allow canvas to take available vertical space */
            width: 100%; /* Ensure canvas takes full width within its container */
        }
        /* Â≠∏Áîü‰ΩúÁ≠îÁµêÊûúÂç°Áâá */
        .student-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            margin-bottom: 0.75rem;
            word-break: break-all;
        }

        /* Êñ∞Â¢ûÔºöÁî®ÊñºÂ≠∏Áîü‰ΩúÁ≠îÂàóË°®ÁöÑÂç°ÁâáÊ®£Âºè */
        .student-response-item {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Â∞áÂÖßÂÆπÂêëÂ∑¶Â∞çÈΩä */
            justify-content: flex-start; /* Â∞áÂÖßÂÆπÂêë‰∏äÂ∞çÈΩä */
            text-align: left; /* Â∞áÊñáÊú¨ÂêëÂ∑¶Â∞çÈΩä */
            transition: border 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Add transition for smooth border change */
        }
        .student-response-item .name-box {
            background-color: #d1e7dd; /* Light green for name */
            color: #0f5132; /* Dark green text */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            width: 100%; /* Take full width within its grid column */
        }
        .student-response-item .name-box span {
            max-width: 100px; /* Max width for name text only */
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            display: inline-block;
        }
        .student-response-item .answer-box {
            background-color: white; /* Changed to white */
            color: #0e7490; /* Dark blue text */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%; /* Take full width within its grid column */
            word-break: break-word;
            flex-grow: 1; /* Allow answer box to take available space */
            min-height: 48px; /* Ensure a consistent height regardless of content */
            display: flex; /* To vertically center content */
            align-items: center;
            justify-content: center;
        }
        .student-response-item .answer-box img {
            max-width: 100%; /* Make images responsive within the answer box */
            height: auto;
            max-height: 120px; /* Limit image height to prevent large images */
            object-fit: contain; /* Ensure image fits without cropping */
            display: block; /* Remove extra space below image */
            margin: 0 auto; /* Center image if it's smaller than max-width */
        }
        .student-response-item .answer-box audio {
            width: 100%;
            max-width: 200px; /* Limit audio player width */
        }
        /* New: Styles for custom multiple choice answers in teacher monitor */
        .student-response-item .mc-question-answer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #334155;
        }
        .student-response-item .mc-question-answer .icon {
            font-size: 1.1rem;
        }
        .student-response-item .mc-question-answer .correct-icon {
            color: #16a34a; /* Green */
        }
        .student-response-item .mc-question-answer .incorrect-icon {
            color: #dc2626; /* Red */
        }
        .student-response-item .mc-question-answer .question-text {
            font-weight: 500;
        }
        .student-response-item .mc-question-answer .student-choice {
            font-weight: bold;
            color: #2563eb; /* Blue */
        }

        /* ‰∫íË©ïÊäïÁ•®Áõ∏ÈóúÊ®£Âºè */
        .peer-review-work-item {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }
        
        .peer-review-work-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .peer-review-work-item .work-author {
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        
        .peer-review-work-item .work-content {
            flex-grow: 1;
            margin-bottom: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .peer-review-work-item .work-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .peer-review-work-item .work-content p {
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .peer-review-work-item .vote-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .peer-review-work-item .vote-btn {
            background: none;
            border: 2px solid transparent;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            position: relative;
        }
        
        .peer-review-work-item .vote-btn:hover {
            background-color: #fef7f7;
            transform: scale(1.1);
            border-color: #fca5a5;
        }
        
        .peer-review-work-item .vote-btn.voted {
            color: #dc2626;
            background-color: #fef2f2;
            border-color: #dc2626;
            animation: pulse 2s infinite;
        }
        
        .peer-review-work-item .vote-btn:not(.voted) {
            color: #9ca3af;
            border-color: #e5e7eb;
        }
        
        .peer-review-work-item .vote-btn:not(.voted):hover {
            color: #dc2626;
            background-color: #fef7f7;
        }
        
        /* Pulse animation for voted buttons */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        /* Tooltip for vote buttons */
        .peer-review-work-item .vote-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #374151;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .peer-review-work-item .vote-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        .peer-review-work-item .vote-count {
            font-weight: bold;
            color: #dc2626;
            font-size: 1.1rem;
        }
        
        .peer-review-work-item .vote-count.zero {
            color: #9ca3af;
        }

        /* ÊïôÂ∏´Á´ØÊäïÁ•®Áµ±Ë®àÊ®£Âºè */
        .vote-stats-item {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        
        .vote-stats-item .stats-author {
            background-color: #dbeafe;
            color: #1e40af;
            padding: 0.375rem 0.75rem;
            border-radius: 0.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .vote-stats-item .stats-content {
            flex-grow: 1;
            margin-bottom: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .vote-stats-item .stats-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem;
            max-height: 120px;
            object-fit: contain;
        }
        
        .vote-stats-item .stats-content p {
            padding: 0.375rem;
            background-color: white;
            border-radius: 0.375rem;
            color: #374151;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .vote-stats-item .stats-votes {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem;
            background-color: #fef2f2;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
        }
        
        .vote-stats-item .stats-votes .vote-icon {
            color: #dc2626;
            font-size: 1.2rem;
        }
        
        .vote-stats-item .stats-votes .vote-count {
            font-weight: bold;
            color: #dc2626;
            font-size: 1.1rem;
        }
        
        .vote-stats-item .stats-votes .vote-count.zero {
            color: #9ca3af;
        }


        /* ÊîæÂ§ßÁπ™Âúñ Modal Ê®£Âºè */
        .magnified-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .magnified-image-modal-content {
            position: relative;
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto; /* Allow scrolling for large content */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        /* ÊéíÂ∫èÈ°åÂíåÈÖçÂ∞çÈ°åÁöÑÊ®°ÊÖãÊ°ÜÊ®£Âºè */
        #sequencing-settings-modal-content,
        #matching-settings-modal-content {
            max-width: 95%;
            max-height: 95vh;
            width: 1200px;
            justify-content: flex-start;
            align-items: stretch;
        }
        .magnified-image-modal-content img {
            max-width: 100%;
            max-height: 80vh; /* Limit image height within modal */
            object-fit: contain;
        }
        .magnified-image-modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #333;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .magnified-image-modal-close:hover {
            background-color: #eee;
        }

        /* Dropdown styles for drawing tools */
        .drawing-tool-select {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background-color: white;
            font-size: 1rem;
            height: 44px; /* Match button height for alignment */
            cursor: pointer;
            min-width: 100px; /* Ensure dropdown has minimum width */
            appearance: none; /* Remove default dropdown arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }

        /* Styles for color swatch in dropdown */
        .color-option-text {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .color-swatch {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #ccc;
            flex-shrink: 0; /* Prevent shrinking when text is long */
        }
        /* Hidden select for visual color swatch */
        #current-color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #2563eb; /* Highlight selected color */
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }

        /* Made by link styling */
        .made-by-text {
            background-color: #e0f7fa; /* Light blue background */
            color: #007bff; /* Blue text */
            padding: 8px 15px;
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-decoration: none; /* Remove underline */
            transition: background-color 0.3s ease;
        }
        .made-by-text:hover {
            background-color: #cceeff; /* Lighter blue on hover */
            color: #0056b3;
        }

        /* üöÄ ENHANCED: Modal for student list with improved RWD */
        #student-list-modal-content {
            padding: 1rem sm:1.5rem md:2rem;
            max-width: 90vw;
            width: 100%;
        }
        /* üöÄ ENHANCED: Modal student list with responsive grid layout (RWD) */
        #modal-student-names {
            display: grid;
            grid-template-columns: 1fr; /* ÊâãÊ©üÔºöÂñÆÂàó */
            gap: 0.5rem;
            padding: 0.75rem;
            max-height: 50vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #f0f9ff 0%, #f8fafc 100%);
            border-radius: 0.75rem;
            border: 2px solid #e0f2f7;
        }
        @media (min-width: 640px) {
            #modal-student-names {
                grid-template-columns: repeat(2, 1fr); /* Âπ≥ÊùøÔºö2Âàó */
                gap: 0.625rem;
                padding: 1rem;
                max-height: 55vh;
            }
        }
        @media (min-width: 1024px) {
            #modal-student-names {
                grid-template-columns: repeat(3, 1fr); /* Ê°åÈù¢Ôºö3Âàó */
                max-height: 60vh;
            }
        }
        /* üöÄ FIX: Á©∫ÁãÄÊÖãÂÆπÂô®Ë∑®Ë∂äÊâÄÊúâÂàó‰∏¶Â±Ö‰∏≠È°ØÁ§∫ */
        #modal-student-names .empty-state-container {
            grid-column: 1 / -1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 140px;
            padding: 2rem 1rem;
        }
        /* üöÄ NEW: Â≠∏ÁîüÂç°ÁâáÊäΩÁ±§Ë¢´ÈÅ∏‰∏≠ÊôÇÁöÑÈ´ò‰∫ÆÊ®£Âºè */
        #modal-student-names .modal-selected-student-border {
            background-color: #fef3c7 !important;
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3) !important;
        }
        /* No specific styling for the last-child within the grid items, as gap handles spacing */

        /* NEW: Styles for Unsubmitted Students Modal */
        #modal-unsubmitted-student-names {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            padding: 0.5rem;
            max-height: 64vh;
            overflow-y: auto;
            background-color: #fef2f2; /* Light red background */
            border-radius: 0.5rem;
            border: 1px solid #fca5a5; /* Red border */
        }
        #modal-unsubmitted-student-names p {
            background-color: #fee2e2; /* Lighter red background for each name */
            padding: 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.9rem;
            color: #b91c1c; /* Darker red text */
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0;
        }
        @media (min-width: 768px) { /* md breakpoint */
            #modal-unsubmitted-student-names {
                grid-template-columns: repeat(5, 1fr);
            }
        }


        /* Styles for Chart Modal - RWD Optimized */
        #statistics-modal-content {
            padding: 0.75rem;
            max-width: 95vw;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: auto;
        }
        @media (min-width: 640px) {
            #statistics-modal-content {
                padding: 1.25rem;
                max-width: 650px;
                gap: 1rem;
            }
        }
        @media (min-width: 768px) {
            #statistics-modal-content {
                padding: 1.5rem;
                max-width: 750px;
            }
        }
        #chart-container {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }
        @media (min-width: 640px) {
            #chart-container {
                padding: 1rem;
                overflow-x: visible;
            }
        }
        #chart-svg {
            display: block;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 0.5rem;
            flex-shrink: 0;
            width: 100%;
            height: auto;
            min-height: 280px;
            max-height: 400px;
        }
        @media (min-width: 640px) {
            #chart-svg {
                min-height: 320px;
            }
        }
        @media (min-width: 768px) {
            #chart-svg {
                min-height: 360px;
            }
        }
        /* Èï∑Ê¢ùÂúñÊ®£ÂºèÂÑ™Âåñ */
        #chart-svg .bar {
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        #chart-svg .bar:hover {
            opacity: 0.8;
        }
        #chart-svg text {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #students-by-answer-list-container {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background-color: #f8fafc;
        }
        @media (min-width: 640px) {
            #students-by-answer-list-container {
                padding: 0.75rem;
            }
        }
        #students-by-answer-list-container h5 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        /* New style for the paragraph containing names */
        #students-by-answer-names {
            word-wrap: break-word; /* Allow long names to wrap */
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* New CSS for selected student border */
        .selected-student-border {
            border: 4px solid #ef4444; /* Tailwind red-500 */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); /* Optional: add a glow effect */
        }

        /* üöÄ ENHANCED: Selected student highlight in the modal - More prominent for RWD */
        .modal-selected-student-border {
            background: linear-gradient(135deg, #fca5a5 0%, #fecaca 100%) !important; /* Bold red gradient */
            border: 3px solid #dc2626 !important; /* Dark red border */
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8), inset 0 0 8px rgba(255, 255, 255, 0.3) !important; /* Strong glow + inset light */
            transform: scale(1.05); /* Slightly enlarge for emphasis */
            transition: all 0.3s ease-in-out;
            color: #ffffff !important; /* White text for better contrast */
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        .modal-selected-student-border:hover {
            transform: scale(1.08);
            box-shadow: 0 0 20px rgba(220, 38, 38, 1), inset 0 0 10px rgba(255, 255, 255, 0.4) !important;
        }

        /* üöÄ OPTIMIZED: Student-side chart containers - Full RWD support */
        #student-chart-container-tf,
        #student-chart-container-mc {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            width: 100%;
        }
        @media (min-width: 640px) {
            #student-chart-container-tf,
            #student-chart-container-mc {
                padding: 1rem;
            }
        }
        @media (min-width: 1024px) {
            #student-chart-container-tf,
            #student-chart-container-mc {
                padding: 1.25rem;
            }
        }
        #student-chart-svg-tf,
        #student-chart-svg-mc {
            display: block;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 0.5rem;
            width: 100%;
            height: auto;
        }
        #student-chart-container-tf h4,
        #student-chart-container-mc h4 {
            font-size: 0.875rem;
            font-weight: bold;
            color: #1e40af;
            margin: 0 0 0.5rem 0;
        }
        @media (min-width: 640px) {
            #student-chart-container-tf h4,
            #student-chart-container-mc h4 {
                font-size: 1rem;
                margin: 0 0 0.75rem 0;
            }
        }
        @media (min-width: 1024px) {
            #student-chart-container-tf h4,
            #student-chart-container-mc h4 {
                font-size: 1.125rem;
                margin: 0 0 1rem 0;
            }
        }

        /* AI Text Summary Modal Styles */
        #ai-summary-modal-content {
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative; /* Needed for close button positioning */
        }
        #ai-summary-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #ai-summary-result-list {
            list-style-type: none; /* Removed decimal numbering */
            padding-left: 0; /* Removed default padding for list */
            font-size: 1rem;
        }
        /* Default style for list items (successful results) */
        #ai-summary-result-list li {
            margin-bottom: 0.4rem;
            padding: 0.2rem 0;
            border-bottom: 1px dashed #e2e8f0;
            color: black; /* Changed to black */
            font-weight: bold; /* Added bold */
        }
        #ai-summary-result-list li:last-child {
            border-bottom: none;
        }
        /* Style for error messages within the list */
        #ai-summary-result-list li.error-message {
            color: white; /* White color for error messages */
            background-color: #dc2626; /* A red background for visual emphasis (optional, but good for error) */
            padding: 0.5rem;
            border-radius: 0.25rem;
            text-align: center;
        }
        #ai-loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px; /* Ensure some height for spinner */
            color: #2563eb;
            font-size: 1.1rem;
        }

        /* AI Settings Modal Styles */
        #ai-settings-modal-content {
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
        }
        #ai-settings-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #ai-settings-modal-content label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
            display: block;
        }
        #ai-settings-modal-content select,
        #ai-settings-modal-content input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            background-color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }
        #ai-settings-modal-content input[type="password"] {
            background-image: none; /* Remove dropdown arrow for password field */
        }
        .settings-button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .settings-button-group .btn {
            width: auto;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        /* New: URL Dispatch Modal Styles */
        #url-dispatch-settings-modal-content {
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
        }
        #url-dispatch-settings-modal-content h4 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #334155;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #url-dispatch-settings-modal-content label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
            display: block;
        }
        #url-dispatch-settings-modal-content input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        .checkbox-container input[type="checkbox"] {
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            color: #2563eb;
        }

        /* New: Student-side URL Dispatch Styles */
        #interaction-url-dispatch {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 1rem;
        }
        .url-card {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: inherit;
        }
        .url-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .url-card-icon {
            font-size: 4rem;
            color: #2563eb;
        }
        .url-card-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3a8a;
        }
        .url-card-link {
            font-size: 1rem;
            color: #6b7280;
            word-break: break-all;
        }
        .youtube-embed-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            background-color: #000; /* Ê∑ªÂä†ÈªëËâ≤ËÉåÊôØÔºåÂ¶ÇÊûúÂΩ±ÁâáËºâÂÖ•Â§±ÊïóÊúÉÁúãÂà∞ */
        }
        .youtube-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* NEW: Pause Overlay for Student */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999; /* Below modals */
            border-radius: 0.5rem; /* Match container border-radius */
            text-align: center;
            padding: 1rem;
        }
        .pause-overlay p {
            font-size: 2rem;
            font-weight: bold;
            color: #dc2626; /* Red text */
            margin-bottom: 1rem;
        }
        .pause-overlay i {
            font-size: 4rem;
            color: #ef4444; /* Lighter red icon */
        }

        /* NEW: HTML Dispatch Styles */
        /* This ID is now reused for the combined dispatch, but the content will be in the iframe */
        #interaction-html-dispatch {
            position: fixed; /* Use fixed positioning to cover entire screen */
            top: 0;
            left: 0;
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 0;
            border: none;
            overflow: hidden; /* Prevent scrolling at container level */
            background-color: white;
            z-index: 1000; /* Ensure it's above other content */
        }
        #html-content-iframe {
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 0;
            border: none;
            background-color: white;
            display: block; /* Ensure no inline spacing */
        }

        /* HTML Dispatch Status Indicator */
        .html-dispatch-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(239, 68, 68, 0.9); /* Red background with transparency */
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001; /* Above the HTML content */
            animation: blink-glow 1.5s ease-in-out infinite alternate;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        @keyframes blink-glow {
            0% {
                opacity: 0.7;
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            }
            100% {
                opacity: 1;
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(239, 68, 68, 0.6);
            }
        }

        /* üéÆ MEMORY GAME: 3D Card Flip Animation */
        .memory-card {
            perspective: 1000px;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease !important;
        }
        
        .memory-card.flip-animation {
            animation: cardFlip3D 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes cardFlip3D {
            0% { transform: rotateY(0deg) rotateX(0deg); }
            45% { transform: rotateY(90deg) rotateX(5deg); }
            100% { transform: rotateY(0deg) rotateX(0deg) scale(1.02); }
        }

        /* üü¢ Success Match: Green Glow + Bounce */
        .memory-card.matched-success {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6), 0 0 40px rgba(16, 185, 129, 0.3) !important;
            animation: successBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            border: 3px solid #34d399 !important;
        }

        @keyframes successBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1.1); }
        }

        /* üî¥ Failed Match: Red Shake */
        .memory-card.matched-fail {
            animation: failShake 0.5s ease-in-out forwards;
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5) !important;
        }

        @keyframes failShake {
            0%, 100% { transform: translateX(0) rotateZ(0deg); }
            10% { transform: translateX(-8px) rotateZ(-2deg); }
            20% { transform: translateX(8px) rotateZ(2deg); }
            30% { transform: translateX(-8px) rotateZ(-2deg); }
            40% { transform: translateX(8px) rotateZ(2deg); }
            50% { transform: translateX(-8px) rotateZ(-2deg); }
            60% { transform: translateX(8px) rotateZ(2deg); }
            70% { transform: translateX(-4px) rotateZ(-1deg); }
            80% { transform: translateX(4px) rotateZ(1deg); }
            90% { transform: translateX(-2px) rotateZ(-0.5deg); }
        }

        /* üèÜ Best Score Display */
        #best-score-display {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: white;
            text-align: center;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
        }

        /* NEW: Styles for enlarged default multiple-choice buttons with RWD */
        #interaction-multiple-choice.enlarged-buttons #default-mc-options .answer-btn {
            width: 10rem; /* Mobile */
            height: 10rem;
            font-size: 6rem;
        }
        @media (min-width: 640px) {
            #interaction-multiple-choice.enlarged-buttons #default-mc-options .answer-btn {
                width: 12rem; /* Tablet */
                height: 12rem;
                font-size: 7rem;
            }
        }
        @media (min-width: 768px) {
            #interaction-multiple-choice.enlarged-buttons #default-mc-options .answer-btn {
                width: 14rem; /* Desktop */
                height: 14rem;
                font-size: 8rem;
            }
        }
        
        /* MODIFIED: MC Settings Modal for AI Question Generation */
        #multiple-choice-settings-modal {
            align-items: center; /* Center modal vertically */
        }

        #multiple-choice-settings-modal-content {
            max-width: 800px; /* Wider modal for two columns */
            max-height: 95vh; /* Increase max height */
            height: auto; /* Allow dynamic height */
            justify-content: flex-start; /* Align content to top */
            align-items: stretch; /* Stretch to full width */
            padding: 1.5rem; /* Increase padding */
            margin-top: 0; /* Remove top margin */
        }

        /* Sequencing Question Styles - RWD Optimized */
        .sequencing-item {
            background-color: white;
            border-radius: 0.75rem;
            padding: 0.875rem 1rem;
            margin-bottom: 0.625rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        @media (min-width: 640px) {
            .sequencing-item {
                padding: 1rem 1.25rem;
                margin-bottom: 0.75rem;
                gap: 1rem;
                font-size: 1.125rem;
            }
        }
        @media (min-width: 768px) {
            .sequencing-item {
                padding: 1.125rem 1.5rem;
                margin-bottom: 0.875rem;
                font-size: 1.25rem;
            }
        }
        .sequencing-item::before {
            content: '‚ãÆ‚ãÆ';
            color: #9ca3af;
            font-size: 1.25rem;
            line-height: 1;
            margin-right: -0.25rem;
            transition: color 0.2s ease;
        }
        .sequencing-item:hover {
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-3px);
            border-color: #93c5fd;
        }
        .sequencing-item:hover::before {
            color: #3b82f6;
        }
        .sequencing-item:active {
            cursor: grabbing;
        }
        .sequencing-item.dragging {
            opacity: 0.75;
            cursor: grabbing;
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
            z-index: 1000;
            animation: pulse-drag 0.6s ease-in-out infinite;
        }
        @keyframes pulse-drag {
            0%, 100% { transform: scale(1.05) rotate(2deg); }
            50% { transform: scale(1.08) rotate(2deg); }
        }
        .sequencing-item.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: translateY(0);
        }
        .sequencing-item-number {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        @media (min-width: 640px) {
            .sequencing-item-number {
                width: 2.5rem;
                height: 2.5rem;
            }
        }
        @media (min-width: 768px) {
            .sequencing-item-number {
                width: 2.75rem;
                height: 2.75rem;
                font-size: 1.125rem;
            }
        }
        .sequencing-item:hover .sequencing-item-number {
            transform: rotate(360deg);
        }
        .sequencing-item-text {
            flex: 1;
            line-height: 1.5;
        }
        .sequencing-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 0.5rem;
        }
        @media (min-width: 640px) {
            .sequencing-container {
                padding: 0;
            }
        }

        /* Matching Question Styles - RWD Optimized */
        .matching-container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            position: relative;
            padding: 0 0.5rem;
        }
        @media (min-width: 640px) {
            .matching-container {
                gap: 1.5rem;
                padding: 0;
            }
        }
        @media (min-width: 768px) {
            .matching-container {
                gap: 2.5rem;
            }
        }
        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 2;
        }
        @media (min-width: 640px) {
            .matching-column {
                gap: 1rem;
            }
        }
        .matching-item {
            background-color: white;
            border-radius: 0.75rem;
            padding: 0.875rem 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid #e5e7eb;
            font-size: 0.9375rem;
            font-weight: 500;
            min-height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
        }
        @media (min-width: 640px) {
            .matching-item {
                padding: 1rem 1.25rem;
                min-height: 4rem;
                font-size: 1.0625rem;
            }
        }
        @media (min-width: 768px) {
            .matching-item {
                padding: 1.125rem 1.5rem;
                min-height: 4.5rem;
                font-size: 1.125rem;
            }
        }
        .matching-item:hover {
            box-shadow: 0 6px 12px rgba(236, 72, 153, 0.12);
            transform: translateY(-2px) scale(1.02);
            border-color: #f9a8d4;
        }
        .matching-item.selected {
            border-color: #ec4899;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.15), 0 6px 16px rgba(236, 72, 153, 0.2);
            animation: pulse-select 1.5s ease-in-out infinite;
            transform: scale(1.05);
        }
        @keyframes pulse-select {
            0%, 100% { 
                box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.15), 0 6px 16px rgba(236, 72, 153, 0.2);
            }
            50% { 
                box-shadow: 0 0 0 6px rgba(236, 72, 153, 0.25), 0 8px 20px rgba(236, 72, 153, 0.3);
            }
        }
        .matching-item.selected::after {
            content: '‚úì';
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: white;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
            animation: pop-in 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes pop-in {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        .matching-item.matched {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            cursor: default;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.15);
        }
        .matching-item.matched:hover {
            transform: none;
        }
        .matching-item.matched::before {
            content: '‚úì';
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
        }
        .matching-item.answer-revealed {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            cursor: default;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.15);
        }
        .matching-item.answer-revealed:hover {
            transform: none;
        }
        #matching-svg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .matching-line {
            stroke: url(#lineGradient);
            stroke-width: 4;
            fill: none;
            stroke-linecap: round;
            opacity: 0;
            animation: draw-line 0.5s ease-out forwards;
            filter: drop-shadow(0 2px 4px rgba(236, 72, 153, 0.3));
        }
        @media (min-width: 768px) {
            .matching-line {
                stroke-width: 5;
            }
        }
        @keyframes draw-line {
            from {
                stroke-dasharray: 1000;
                stroke-dashoffset: 1000;
                opacity: 0;
            }
            to {
                stroke-dasharray: 1000;
                stroke-dashoffset: 0;
                opacity: 1;
            }
        }
        .matching-line.correct {
            stroke: url(#lineGradientCorrect);
            filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.3));
        }
        .matching-line.incorrect {
            stroke: url(#lineGradientIncorrect);
            filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3));
        }

        /* Confetti Container for Quick Answer Success */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* Ëû¢ÂÖâÁ≠ÜÂäüËÉΩÊ®£Âºè - Â≠∏ÁîüÁ´ØËàáÊïôÂ∏´Á´ØÂÖ±Áî® */
        .highlighter-btn,
        .teacher-highlighter-btn {
            position: relative;
            padding: 0;
            border: 2px solid transparent;
            border-radius: 0.375rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .highlighter-btn:hover,
        .teacher-highlighter-btn:hover {
            transform: scale(1.1);
            border-color: #6366f1;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        .highlighter-btn.active,
        .teacher-highlighter-btn.active {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .highlighter-preview {
            width: 20px;
            height: 20px;
            border-radius: 0.25rem;
            display: block;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        /* Ëû¢ÂÖâÁ≠ÜÊ®ôË®ªÊïàÊûú */
        .highlight {
            padding: 2px 0;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .highlight:hover {
            opacity: 0.7;
        }
        .highlight-yellow {
            background-color: rgba(254, 240, 138, 0.6);
        }
        .highlight-green {
            background-color: rgba(134, 239, 172, 0.6);
        }
        .highlight-pink {
            background-color: rgba(249, 168, 212, 0.6);
        }
        .highlight-blue {
            background-color: rgba(147, 197, 253, 0.6);
        }
        .highlight-orange {
            background-color: rgba(253, 186, 116, 0.6);
        }
        
        /* RWD ÈüøÊáâÂºèË™øÊï¥ */
        @media (min-width: 640px) {
            .highlighter-btn,
            .teacher-highlighter-btn {
                width: 32px;
                height: 32px;
            }
            .highlighter-preview {
                width: 24px;
                height: 24px;
            }
        }
    </style>
    
    <!-- Canvas Confetti Library for Celebration Effects -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.4/dist/confetti.browser.min.js"></script>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 md:p-6">

        <div id="entry-view" class="w-full h-screen flex flex-col items-center justify-center p-4">
            <!-- Âª∫ÁΩÆË™™ÊòéÊåâÈàï -->
            <div class="absolute top-2 right-2 sm:top-4 sm:right-4 z-10">
                <a href="/set.html" target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-2 py-1.5 sm:px-3 sm:py-2 md:px-4 md:py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white text-xs sm:text-sm md:text-base font-medium rounded-lg shadow-md transition-all duration-200 hover:shadow-lg whitespace-nowrap">
                    <i class="fas fa-play-circle mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                    <span class="hidden sm:inline">Âª∫ÁΩÆÊìç‰ΩúÊâãÂÜä</span>
                    <span class="sm:hidden">ÊâãÂÜä</span>
                </a>
            </div>
            
            <div class="w-full max-w-3xl bg-white/80 backdrop-blur-sm p-5 sm:p-8 md:p-12 rounded-2xl shadow-xl text-center border border-gray-200">
        
                <div class="flex flex-col md:flex-row items-center justify-center mb-4 sm:mb-6">
                    <i class="fas fa-rocket text-4xl sm:text-5xl text-indigo-500 mb-3 md:mb-0 md:mr-6"></i>
                    <div>
                        <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold text-gray-800 leading-tight">ÂâõÂ•ΩÂ≠∏ÔºöË™≤Â†Ç‰∫íÂãïso easy</h1>
                        <p class="text-base sm:text-lg text-gray-600 mt-1 sm:mt-2">‰∏ÄÂÄãÂ∞àÁÇ∫Áèæ‰ª£Ë™≤Â†ÇË®≠Ë®àÁöÑÂç≥ÊôÇ‰∫íÂãïÂ∑•ÂÖ∑</p>
                    </div>
                </div>
                
                <hr class="my-6 sm:my-8 border-gray-200">
        
                <p class="text-lg sm:text-xl font-medium text-gray-700 mb-4 sm:mb-6">Ë´ãÈÅ∏ÊìáÊÇ®ÁöÑËßíËâ≤‰ª•ÈñãÂßã</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 sm:gap-6 md:gap-8">
                    <div class="role-card group">
                        <div class="role-card-icon bg-blue-100 text-blue-500 group-hover:bg-blue-500 group-hover:text-white">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mt-3 sm:mt-4">ÊàëÊòØÊïôÂ∏´</h2>
                        <p class="text-sm sm:text-base text-gray-500 my-2 min-h-[3rem] sm:h-12">Âª∫Á´ãÊïôÂÆ§ÔºåÁôºËµ∑‰∫íÂãïÔºåÂç≥ÊôÇÊü•ÁúãÂ≠∏ÁîüÂèçÈ•ã„ÄÇ</p>
                        <button id="teacher-entry-btn" class="btn btn-primary !w-full text-sm sm:text-base">Âª∫Á´ãÊàñÈÄ≤ÂÖ•ÊïôÂÆ§</button>
                    </div>
                    <div class="role-card group">
                         <div class="role-card-icon bg-green-100 text-green-500 group-hover:bg-green-500 group-hover:text-white">
                            <i class="fas fa-user-graduate"></i>
                         </div>
                         <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mt-3 sm:mt-4">ÊàëÊòØÂ≠∏Áîü</h2>
                         <p class="text-sm sm:text-base text-gray-500 my-2 min-h-[3rem] sm:h-12">Ëº∏ÂÖ•ÊïôÂÆ§‰ª£Á¢ºÔºåÂèÉËàáË™≤Â†ÇÂïèÁ≠îËàá‰∫íÂãï„ÄÇ</p>
                        <button id="student-entry-btn" class="btn btn-green !w-full text-sm sm:text-base">Âä†ÂÖ•Ë™≤Â†Ç</button>
                    </div>
                </div>
            </div>
        
            <div class="text-center mt-4 sm:mt-3 text-gray-600 space-y-2 sm:space-y-2">
                <p class="text-xs px-2 truncate hidden">App ID: <span id="app-id-display"></span> <span class="hidden sm:inline">&nbsp;&bull;&nbsp;</span> <span class="sm:hidden">‚Ä¢</span> User ID: <span id="user-id-display" class="break-all"></span></p>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-3 px-2">
                    <a href="https://kentxchang.blogspot.tw" target="_blank" rel="noopener noreferrer" class="w-full sm:w-auto px-4 py-2 sm:px-5 sm:py-2 rounded-lg bg-indigo-100 text-indigo-700 hover:bg-indigo-200 text-sm sm:text-base font-semibold transition-colors shadow-sm">
                       üë®‚Äçüè´ Made by ÈòøÂâõËÄÅÂ∏´
                    </a>
                    <span class="hidden sm:inline text-gray-400 text-lg">|</span>
                    <a href="https://www.smes.tyc.edu.tw/modules/tadnews/page.php?ncsn=11&nsn=16#a5" target="_blank" rel="noopener noreferrer" class="w-full sm:w-auto px-4 py-2 sm:px-5 sm:py-2 rounded-lg bg-purple-100 text-purple-700 hover:bg-purple-200 text-sm sm:text-base font-semibold transition-colors shadow-sm">
                       ‚ú® Refined by ÈòøÂá±ËÄÅÂ∏´
                    </a>
                </div>
            </div>
        </div>

        <div id="teacher-classroom-code-view" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ÊïôÂ∏´ÁôªÂÖ•ÔºöË´ãËº∏ÂÖ•ÊïôÂÆ§‰ª£Á¢º</h2>
            <div class="max-w-sm mx-auto">
                <input type="text" id="teacher-classroom-code-input" placeholder="Ë´ãËº∏ÂÖ•Ëá™Ë®ÇÊïôÂÆ§‰ª£Á¢º" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="teacher-classroom-code-submit-btn" class="btn btn-primary mt-4">ÈÄ≤ÂÖ•ÊïôÂ∏´Èù¢Êùø ‚û°Ô∏è</button>
                <button id="teacher-classroom-code-back-btn" class="btn btn-gray mt-2">ËøîÂõû ‚Ü©Ô∏è</button>
            </div>
        </div>

        <div id="teacher-menu-view" class="hidden text-center relative px-2 sm:px-4 pt-20 sm:pt-0">
            <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 mb-3 sm:mb-8">ÊïôÂ∏´Èù¢ÊùøÔºöË´ãÈÅ∏Êìá‰∫íÂãïÊ®°Âºè</h2>
            
            <!-- üöÄ ENHANCED: È†ÇÈÉ®ÊéßÂà∂ÂçÄÔºöÊ©´Êéí‰ΩàÂ±ÄÔºåÊâãÊ©üÁ´ØÁ∑äÊπäÈñìË∑ù -->
            <div class="absolute top-2 left-2 right-2 z-10 sm:static sm:mb-6 flex flex-row justify-between items-center gap-1 sm:gap-3 md:gap-4 flex-wrap sm:flex-nowrap">
                <!-- Â∑¶ÂÅ¥ÂçÄÂüüÔºö‰∏ãË™≤ÊåâÈàï + ÊïôÂÆ§‰ª£Á¢º -->
                <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                    <!-- üöÄ ENHANCED: Prominent end-class button with improved RWD visibility -->
                    <button id="end-class-session-menu-btn" class="btn btn-red font-bold text-sm sm:text-base md:text-lg lg:text-xl h-11 sm:h-12 md:h-13 px-3 sm:px-4 md:px-5 lg:px-6 py-2 sm:py-2.5 md:py-3 flex items-center justify-center gap-1.5 whitespace-nowrap shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105 hover:bg-red-600 border-2 border-red-700" title="‰∏ãË™≤‰∏¶Ê∏ÖÁ©∫Ë≥áÊñô">
                        <i class="fas fa-door-open text-lg sm:text-xl md:text-2xl"></i> <span>‰∏ãË™≤ üîö</span>
                    </button>
                    <!-- üöÄ ENHANCED: Prominent classroom code display with click-to-QR functionality -->
                    <div id="teacher-menu-classroom-code-display" class="cursor-pointer select-none text-center sm:text-left text-sm sm:text-base md:text-xl font-bold text-gray-900 bg-gradient-to-r from-yellow-200 to-yellow-100 px-3 sm:px-4 md:px-5 py-2 sm:py-2.5 md:py-3 rounded-lg border-3 border-yellow-400 shadow-md hover:shadow-lg hover:from-yellow-300 hover:to-yellow-200 transition-all duration-200 whitespace-nowrap transform hover:scale-105" title="ÈªûÊìäÈñãÂïüQRÁ¢ºÊéÉÁ¢ºÈÄ≤ÂÖ•">
                        <span class="hidden sm:inline text-yellow-700">üè´ ÊïôÂÆ§‰ª£Á¢º: </span><span class="sm:hidden text-yellow-700">üì± </span><span id="teacher-menu-code-value" class="text-blue-700 font-bold text-lg sm:text-xl md:text-2xl">---</span>
                    </div>
                </div>
                
                <!-- Âè≥ÂÅ¥ÂçÄÂüüÔºöQR Code ÊåâÈàï + Â≠∏ÁîüÁµ±Ë®à -->
                <div class="flex items-center gap-1 sm:gap-2 md:gap-3 flex-shrink-0 ml-auto">
                    <!-- QR Code ÊåâÈàï -->
                    <button id="show-qrcode-btn-menu" class="btn bg-teal-600 hover:bg-teal-700 text-white font-semibold text-xs sm:text-sm md:text-base h-9 sm:h-10 md:h-11 px-2 sm:px-3 md:px-4 flex items-center justify-center gap-1 whitespace-nowrap shadow-md transition-all hover:shadow-lg rounded-lg border border-teal-700">
                        <i class="fas fa-qrcode"></i> <span class="hidden xs:inline">QR Code</span>
                    </button>
                    
                    <!-- Â≠∏ÁîüÁµ±Ë®àÂç°Áâá -->
                    <div class="flex items-center gap-1 sm:gap-2 p-1 sm:p-2 md:p-3 rounded-lg bg-blue-50 border border-blue-200 shadow-sm">
                        <div id="student-status-area" class="text-gray-700 text-xs sm:text-sm md:text-base font-semibold flex items-center gap-1 cursor-pointer hover:text-blue-700 transition-colors">
                            <i class="fas fa-users text-blue-600"></i> <span id="active-student-count" class="font-bold text-blue-700">0</span>
                        </div>
                        <button id="refresh-student-count-btn" class="text-blue-600 hover:text-blue-800 hover:bg-blue-200 transition-colors text-sm md:text-base p-0.5 rounded" title="Êõ¥Êñ∞Áµ±Ë®à">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3 md:gap-4 mx-auto max-w-2xl md:max-w-4xl lg:max-w-5xl">
                <button data-mode="true_false" class="btn btn-primary aspect-square w-full flex flex-col items-center justify-center p-1">
                    <span class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-60 mb-2 sm:mb-3">A.</span>
                    <span class="text-3xl sm:text-4xl md:text-5xl lg:text-5xl font-bold leading-tight">ÊòØÈùûÈ°å</span>
                </button>
                <button id="choice-sequencing-matching-menu-btn" class="btn btn-green aspect-square w-full flex flex-col items-center justify-center p-1">
                    <span class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-60 mb-2 sm:mb-3">B.</span>
                    <span class="text-2xl sm:text-3xl md:text-4xl lg:text-4xl font-bold leading-tight">ÈÅ∏Êìá/ÊéíÂ∫è<br class="hidden sm:inline">/ÈÖçÂ∞ç</span>
                </button>
                <button data-mode="text_input" class="btn btn-orange aspect-square w-full flex flex-col items-center justify-center p-1">
                    <span class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-60 mb-2 sm:mb-3">C.</span>
                    <span class="text-3xl sm:text-4xl md:text-5xl lg:text-5xl font-bold leading-tight">ÊñáÂ≠óÈ°å</span>
                </button>
                <button data-mode="drawing" class="btn btn-purple aspect-square w-full flex flex-col items-center justify-center p-1">
                    <span class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-60 mb-2 sm:mb-3">D.</span>
                    <span class="text-3xl sm:text-4xl md:text-5xl lg:text-5xl font-bold leading-tight">Áπ™ÂúñÈ°å</span>
                </button>
                <button data-mode="url_dispatch" class="btn btn-teal aspect-square w-full flex flex-col items-center justify-center p-1">
                    <span class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-60 mb-2 sm:mb-3">E.</span>
                    <span class="text-2xl sm:text-3xl md:text-4xl lg:text-4xl font-bold leading-tight">Ê¥æÈÄÅÁ∂≤ÂùÄ<br class="hidden sm:inline">/HTML</span>
                </button>
                <button data-mode="recording" class="btn bg-indigo-600 hover:bg-indigo-700 aspect-square w-full flex flex-col items-center justify-center p-1">
                    <span class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-60 mb-2 sm:mb-3">F.</span>
                    <span class="text-3xl sm:text-4xl md:text-5xl lg:text-5xl font-bold leading-tight">ÈåÑÈü≥È°å</span>
                </button>
                <button id="reading-comprehension-settings-btn" class="btn bg-red-500 hover:bg-red-600 aspect-square w-full flex flex-col items-center justify-center p-1">
                    <span class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-60 mb-2 sm:mb-3">G.</span>
                    <span class="text-3xl sm:text-4xl md:text-5xl lg:text-5xl font-bold leading-tight">Èñ±ËÆÄÊ∏¨È©ó</span>
                </button>
                <button data-mode="quick_answer" class="btn bg-orange-500 hover:bg-orange-600 aspect-square w-full flex flex-col items-center justify-center p-1">
                    <span class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-60 mb-2 sm:mb-3">H.</span>
                    <span class="text-3xl sm:text-4xl md:text-5xl lg:text-5xl font-bold leading-tight">Êê∂Á≠î</span>
                </button>
                <button id="quick-poll-settings-btn" class="btn bg-lime-500 hover:bg-lime-600 aspect-square w-full flex flex-col items-center justify-center p-1">
                    <span class="text-base sm:text-lg md:text-xl lg:text-2xl opacity-60 mb-2 sm:mb-3">I.</span>
                    <span class="text-3xl sm:text-4xl md:text-5xl lg:text-5xl font-bold leading-tight">Âø´ÈÄüÊäïÁ•®</span>
                </button>
            </div>
            <div class="mt-6 sm:mt-8 flex flex-col items-center px-2">
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-4 w-full sm:w-auto">
                    <label for="teacher-image-upload-input" class="btn btn-purple !w-full sm:!w-auto text-xs sm:text-base h-9 sm:h-11 px-2 sm:px-4 py-1 sm:py-2 flex items-center justify-center cursor-pointer">
                        <i class="fas fa-upload mr-1 sm:mr-2"></i> <span class="hidden xs:inline">‰∏äÂÇ≥Áπ™ÂúñËÉåÊôØÂúñÁâá (ÊïôÂ∏´Áî®) üñºÔ∏è</span><span class="xs:hidden">‰∏äÂÇ≥ËÉåÊôØ üñºÔ∏è</span>
                    </label>
                    <input type="file" id="teacher-image-upload-input" accept="image/*" class="hidden">
                    <button id="clear-teacher-background-btn" class="btn btn-red !w-full sm:!w-auto text-xs sm:text-base h-9 sm:h-11 px-2 sm:px-4 py-1 sm:py-2 flex items-center justify-center">
                        <i class="fas fa-trash mr-1 sm:mr-2"></i> <span class="hidden xs:inline">Ê∏ÖÈô§ËÉåÊôØÂúñ üóëÔ∏è</span><span class="xs:hidden">Ê∏ÖÈô§ üóëÔ∏è</span>
                    </button>
                </div>
                <p id="teacher-image-status" class="text-gray-600 text-xs sm:text-sm mt-2 text-center">ÁõÆÂâçÊ≤íÊúâËÉåÊôØÂúñÁâá„ÄÇÂèØÈÅ∏ÊìáÊ™îÊ°àÊàñÁõ¥Êé•Ë≤º‰∏ä(Ctrl+V)„ÄÇ</p>
                <div id="teacher-image-preview-container" class="mt-4 hidden border border-gray-300 rounded-lg p-2 max-w-xs w-full">
                    <img id="teacher-image-preview" src="" alt="ËÉåÊôØÂúñÁâáÈ†êË¶Ω" class="w-full h-auto rounded-md object-contain">
                </div>
            </div>

            <div class="mt-6 flex justify-center gap-4 sm:gap-8 pb-4">
                <button id="ai-settings-btn" class="text-gray-500 hover:text-blue-700 transition-colors text-2xl sm:text-3xl" title="AI Ë®≠ÂÆö">
                    <i class="fas fa-robot"></i>
                </button>
                <button id="url-dispatch-settings-btn" class="text-gray-500 hover:text-teal-700 transition-colors text-2xl sm:text-3xl" title="Ë®≠ÂÆöÊ¥æÈÄÅÁ∂≤ÂùÄ/HTML">
                    <i class="fas fa-link"></i>
                </button>
            </div>
        </div>
        
        <div id="teacher-monitor-view" class="hidden px-2 sm:px-4">
            <!-- üöÄ NEW: ÂØ¶ÊôÇÁãÄÊÖãÂÑÄË°®ÊùøÔºàRWD ÂÑ™ÂåñÔºâ -->
            <div id="teacher-dashboard" class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-400 rounded-lg p-3 sm:p-4 md:p-5 mb-4 sm:mb-6 shadow-md">
                <h3 class="text-base sm:text-lg md:text-xl font-bold text-blue-800 mb-3 sm:mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-line"></i> <span class="hidden xs:inline">Ë™≤Â†Ç</span>ÂØ¶ÊôÇÁãÄÊÖã
                </h3>
                
                <!-- RWD ‰ΩàÂ±ÄÔºöÊâãÊ©üÂ†ÜÁñä„ÄÅÂπ≥Êùø 2+1„ÄÅÊ°åÈù¢ 3 Ê¨Ñ -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3 md:gap-4">
                    <!-- 1. Êèê‰∫§ÈÄ≤Â∫¶Ê¢ùÔºà‰ΩîÊªøÂØ¨Â∫¶Êàñ 1/2Ôºâ -->
                    <div class="bg-white rounded-lg p-3 sm:p-4 border border-blue-200 shadow-sm sm:col-span-1 lg:col-span-1">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs sm:text-sm font-bold text-gray-700 flex items-center gap-1">
                                <i class="fas fa-check-circle text-green-600"></i> <span class="hidden xs:inline">Êèê‰∫§</span><span class="xs:hidden">ÈÄ≤Â∫¶</span>
                            </label>
                            <span id="submission-percentage" class="text-xs sm:text-sm font-bold text-blue-700">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-5 sm:h-6 overflow-hidden">
                            <div id="submission-progress-bar" class="bg-gradient-to-r from-green-400 to-green-600 h-full rounded-full transition-all duration-300 flex items-center justify-center">
                                <span class="text-xs font-bold text-white">0/0</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">Â∑≤Êèê‰∫§ <span id="submitted-count">0</span>/<span id="total-students">0</span></p>
                    </div>
                    
                    <!-- 2. Âú®Á∑öÂ≠∏ÁîüË®àÊï∏ÔºàÂÑ™ÂåñÁâà RWDÔºâ -->
                    <div class="bg-gradient-to-br from-blue-100 via-blue-50 to-indigo-100 rounded-lg p-3 sm:p-4 md:p-5 border-3 border-blue-500 shadow-lg hover:shadow-xl transition-shadow">
                        <label class="text-xs sm:text-sm md:text-base font-bold text-blue-800 flex items-center gap-1.5 mb-3 sm:mb-4">
                            <i class="fas fa-users text-blue-700 text-base sm:text-lg"></i> <span class="hidden xs:inline">Âú®Á∑ö</span>Â≠∏ÁîüÊï∏
                        </label>
                        <div class="flex items-center justify-between gap-3 sm:gap-4">
                            <!-- Â≠∏ÁîüÊï∏Â≠óÂçÄÂ°ä -->
                            <div class="flex-shrink-0">
                                <div class="bg-white rounded-lg p-2 sm:p-3 border-2 border-blue-400 shadow-md">
                                    <div class="text-4xl xs:text-5xl sm:text-6xl md:text-7xl font-black text-blue-600 text-center w-16 xs:w-20 sm:w-24" id="online-student-count">0</div>
                                </div>
                            </div>
                            <!-- Ë©≥Á¥∞Ë≥áË®äÂçÄÂ°ä -->
                            <div class="flex-1 min-w-0">
                                <p class="text-xs sm:text-sm md:text-base font-bold text-blue-700 truncate">
                                    <span id="total-joined-count">ÂÖ± 0 ‰∫∫</span>
                                </p>
                                <p id="offline-count" class="text-xs sm:text-sm md:text-base text-red-600 font-bold truncate mt-1">
                                    0 Èõ¢Á∑ö
                                </p>
                                <div class="mt-2 sm:mt-2 bg-blue-200 rounded-full h-1.5 overflow-hidden">
                                    <div id="online-student-progress" class="bg-gradient-to-r from-blue-500 to-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3. ÂàÜÂøÉÂ≠∏ÁîüÊèêÈÜí -->
                    <div class="bg-white rounded-lg p-3 sm:p-4 border-2 border-yellow-300 shadow-sm hover:shadow-lg transition-shadow sm:col-span-2 lg:col-span-1">
                        <label class="text-xs sm:text-sm font-bold text-gray-700 flex items-center gap-1 mb-2">
                            <i class="fas fa-exclamation-circle text-orange-500"></i> <span class="hidden xs:inline">ÂàÜÂøÉ</span><span class="xs:hidden">Ë≠¶Â†±</span>
                        </label>
                        <div id="distraction-alert" class="bg-yellow-50 rounded-lg p-2 sm:p-3 border border-yellow-200 min-h-14 sm:min-h-16 max-h-24 overflow-y-auto">
                            <div id="distracted-students-list" class="text-xs sm:text-sm text-gray-700">
                                <p class="text-gray-500">Êö´ÁÑ°ÂàÜÂøÉÂ≠∏Áîü</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col gap-3 mb-6">
                <!-- Á¨¨‰∏ÄË°åÔºö‰∏ãË™≤ÊåâÈàï + QR Code ÂäüËÉΩÂçÄ -->
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-3">
                    <!-- üöÄ Â∑¶ÂÅ¥Ôºö‰∏ãË™≤ÊåâÈàï -->
                    <button id="end-class-session-monitor-btn" class="btn bg-red-700 hover:bg-red-800 w-full sm:w-auto text-base sm:text-lg md:text-xl font-semibold h-12 sm:h-13 md:h-14 px-4 sm:px-5 md:px-6 py-2 flex items-center justify-center shadow-lg border-2 border-red-900" title="‰∏ãË™≤‰∏¶Ê∏ÖÁ©∫Ë≥áÊñô">
                        <i class="fas fa-exclamation-triangle mr-2 text-lg sm:text-xl"></i> <span id="end-class-monitor-button-text">‚ö†Ô∏è ‰∏ãË™≤ÁµêÊùüË™≤Á®ã</span>
                    </button>
                    
                    <!-- üöÄ Âè≥ÂÅ¥ÔºöQR Code ÂäüËÉΩÂçÄÂàÜ -->
                    <div class="flex flex-row sm:flex-row gap-2 sm:gap-3 flex-wrap sm:flex-nowrap">
                        <button id="show-qrcode-btn" class="btn bg-teal-600 hover:bg-teal-700 text-white font-semibold w-full sm:w-auto text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-4 md:px-5 flex items-center justify-center gap-1.5 whitespace-nowrap shadow-md transition-all hover:shadow-lg rounded-lg border border-teal-700">
                            <i class="fas fa-qrcode text-base sm:text-lg md:text-xl"></i> <span>Ë™≤Â†Ç QR Code üîê</span>
                        </button>
                    </div>
                </div>
                
                <!-- Á¨¨‰∫åË°åÔºöÂäüËÉΩÊåâÈàïÂçÄÔºàBento Box ÈüøÊáâÂºèÁ∂≤Ê†ºÔºâ -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                    <button id="toggle-pause-btn" class="btn bg-gray-500 hover:bg-gray-600 text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3">
                        <i class="fas fa-pause mr-1 sm:mr-2"></i> <span id="toggle-pause-btn-text">Êö´ÂÅúÂõûË¶Ü ‚è∏Ô∏è</span>
                    </button>
                    <button id="reset-answers-btn" class="btn btn-green text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3">
                        <i class="fas fa-redo mr-1 sm:mr-2"></i> <span>ÈáçÊñ∞ÈñãÂßã üîÑ</span>
                    </button>
                    <button id="draw-lottery-btn" class="btn btn-orange text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3">ÊäΩÁ±§ üé≤</button>
                    <button id="show-unsubmitted-students-btn" class="btn btn-orange text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">Êú™‰ΩúÁ≠îÂ≠∏Áîü üìù</button>
                    <button id="ai-text-summary-btn" class="btn btn-purple text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">AI ÊñáÂ≠óÂàÜÊûê ü§ñ</button>
                    <button id="download-media-btn" class="btn btn-purple text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">‰∏ãËºâÊâÄÊúâÂ™íÈ´î üíæ</button>
                    <button id="show-statistics-btn" class="btn btn-primary text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">È°ØÁ§∫Áµ±Ë®à üìä</button>
                    <button id="start-peer-review-btn" class="btn btn-teal text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">ÈñãÂßã‰∫íË©ï ‚ù§Ô∏è</button>
                    <button id="view-questions-btn" class="btn bg-indigo-600 hover:bg-indigo-700 text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">Êü•ÁúãÈ°åÁõÆ üìù</button>
                    <button id="view-reading-questions-btn" class="btn bg-red-600 hover:bg-red-700 text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">È°ØÁ§∫È°åÁõÆ üìñ</button>
                    <button id="rescore-all-students-btn" class="btn bg-green-600 hover:bg-green-700 text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">Êõ¥Êñ∞Â≠∏ÁîüÁ≠îÊ°à ‚úèÔ∏è</button>
                    <button id="show-matching-answer-btn" class="btn bg-pink-600 hover:bg-pink-700 text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">È°ØÁ§∫Á≠îÊ°à üí°</button>
                    <button id="show-sequencing-answer-btn" class="btn bg-cyan-600 hover:bg-cyan-700 text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">È°ØÁ§∫Á≠îÊ°à üí°</button>
                    <button id="download-responses-btn" class="btn btn-green text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 hidden">‰∏ãËºâÂõûÊáâ üì•</button>
                    <button id="end-interaction-btn" class="btn btn-primary text-sm sm:text-base md:text-lg h-10 sm:h-11 md:h-12 px-3 sm:px-2 md:px-3 font-bold shadow-md md:col-span-2 lg:col-span-3">‚úÖ ÁµêÊùü‰∫íÂãïÔºåÂõûÂà∞ÈÅ∏ÂñÆ</button>
                </div>
            </div>
            <!-- üöÄ NEW: Teacher-side answer display area -->
            <div id="teacher-answer-display" class="hidden bg-blue-50 p-4 rounded-lg mb-4 border-2 border-blue-300">
                <h3 class="text-xl font-bold text-blue-800 mb-3 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span id="teacher-answer-title">Ê≠£Á¢∫Á≠îÊ°à</span>
                </h3>
                <div id="teacher-answer-content" class="text-gray-800"></div>
            </div>
            
            <div id="student-responses-container" class="bg-gray-100 p-4 rounded-lg h-96 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                <p class="text-gray-500 text-center col-span-full">Ê≠£Âú®Á≠âÂæÖÂ≠∏Áîü‰ΩúÁ≠î...</p>
            </div>
            
            <div id="peer-review-stats-container" class="hidden mt-6">
                <div class="bg-white p-4 rounded-lg border">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">üìä Âç≥ÊôÇÊäïÁ•®Áµ±Ë®à</h3>
                    <div id="peer-review-stats-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <p class="text-gray-500 text-center col-span-full">Â∞öÊú™ÈñãÂßã‰∫íË©ï...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- üöÄ NEW: Ë™≤Â†Ç QR Code Ê®°ÊÖãÊ°Ü -->
        <div id="qrcode-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 max-w-lg w-11/12">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">üì± Ë™≤Â†Ç QR Code</h2>
                    <button id="close-qrcode-modal" class="text-gray-500 hover:text-red-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="text-center">
                    <p class="text-gray-700 mb-4 font-semibold">Ë™≤Â†Ç‰ª£Á¢ºÔºö<span id="qrcode-classroom-code" class="text-xl text-blue-600"></span></p>
                    <div id="qrcode-container" class="flex justify-center mb-4">
                        <!-- QR Code Â∞áÂãïÊÖãÁîüÊàêÂú®ÈÄôË£° -->
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Â≠∏ÁîüÁî®Âπ≥ÊùøÊéÉÊèèÊ≠§ QR Code Âø´ÈÄüÈÄ≤ÂÖ•Ë™≤Â†Ç</p>
                    <!-- üöÄ NEW: Copy classroom link button for computer-based sharing -->
                    <div class="space-y-2">
                        <button id="download-qrcode-btn" class="btn btn-green w-full">
                            <i class="fas fa-download mr-2"></i> ‰∏ãËºâ QR Code
                        </button>
                        <button id="copy-classroom-link-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold w-full flex items-center justify-center gap-2 transition-all hover:shadow-lg">
                            <i class="fas fa-link"></i> <span>Ë§áË£ΩË™≤Â†ÇÈÄ£Áµê üìã</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-name-view" class="text-center hidden px-4">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800 mb-4 sm:mb-6">Ë´ãËº∏ÂÖ•ÊïôÂÆ§‰ª£Á¢ºËàáÊÇ®ÁöÑÂßìÂêç</h2>
            <div class="max-w-sm mx-auto space-y-3 sm:space-y-4">
                <input type="text" id="student-classroom-code-input" placeholder="Ë´ãËº∏ÂÖ•ÊïôÂÆ§‰ª£Á¢º" class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg text-base sm:text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="student-name-input" placeholder="‰æãÂ¶ÇÔºöÁéãÂ∞èÊòé" class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg text-base sm:text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="submit-name-btn" class="btn btn-primary w-full mt-4 text-base sm:text-lg px-6 sm:px-8 py-2.5 sm:py-3">ÈÄ≤ÂÖ•ÊïôÂÆ§ üö™</button>
                <!-- üöÄ NEW: Back button to switch role on mobile -->
                <button id="student-back-to-role-btn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold w-full mt-2 sm:mt-4 text-sm sm:text-base px-4 sm:px-6 py-2 sm:py-2.5 flex items-center justify-center gap-2 transition-all hover:shadow-lg rounded-lg">
                    <i class="fas fa-arrow-left text-lg sm:text-xl"></i> <span>ËøîÂõûÂàáÊèõËßíËâ≤ ‚Ü©Ô∏è</span>
                </button>
            </div>
        </div>
        
        <div id="student-waiting-view" class="text-center hidden py-6">
             <h2 id="student-welcome-msg" class="text-3xl font-bold text-gray-800 mb-4 sm:mb-6"></h2>
             
             <!-- ‚è≥ Waiting Indicator (Moved to top) -->
             <div id="waiting-loading" class="max-w-2xl mx-auto px-4 mb-4 sm:mb-6">
                 <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-400 rounded-lg p-3 sm:p-4 shadow-md">
                     <div class="flex items-center justify-center space-x-2 sm:space-x-3 text-lg sm:text-xl font-semibold text-orange-600">
                        <i class="fas fa-hourglass-half fa-pulse text-orange-500"></i>
                        <p class="text-sm sm:text-base md:text-lg">Ë´ãÁ≠âÂæÖËÄÅÂ∏´ÈñãÂßã‰∫íÂãï...</p>
                    </div>
                 </div>
             </div>
             
             <!-- üéÆ NEW: Waiting Game Section -->
             <div class="max-w-2xl mx-auto px-4">
                 <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg p-5 sm:p-6 mb-6 border-2 border-purple-200 shadow-lg">
                     <h3 class="text-xl sm:text-2xl md:text-3xl font-bold text-purple-700 mb-4 sm:mb-5">üéÆ ÊâìÁôºÊôÇÈñìÂ∞èÈÅäÊà≤</h3>
                     
                     <!-- Game Stats -->
                     <div class="grid grid-cols-3 gap-2 sm:gap-3 mb-5 sm:mb-6">
                         <div class="bg-white rounded-lg p-2 sm:p-3 border border-purple-200 shadow-sm">
                             <p class="text-xs sm:text-sm text-gray-600">ÈÖçÂ∞ç</p>
                             <p class="text-xl sm:text-2xl md:text-3xl font-bold text-purple-600" id="game-matches">0</p>
                         </div>
                         <div class="bg-white rounded-lg p-2 sm:p-3 border border-purple-200 shadow-sm">
                             <p class="text-xs sm:text-sm text-gray-600">ÊôÇÈñì</p>
                             <p class="text-xl sm:text-2xl md:text-3xl font-bold text-blue-600" id="game-time">0Áßí</p>
                         </div>
                         <div class="bg-white rounded-lg p-2 sm:p-3 border border-purple-200 shadow-sm">
                             <p class="text-xs sm:text-sm text-gray-600">ÁøªËΩâ</p>
                             <p class="text-xl sm:text-2xl md:text-3xl font-bold text-orange-600" id="game-moves">0</p>
                         </div>
                     </div>

                     <!-- Memory Game Grid -->
                     <div id="memory-game-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-1.5 sm:gap-2 md:gap-3 mb-5 sm:mb-6">
                         <!-- Cards will be generated here -->
                     </div>

                     <!-- Game Controls -->
                     <div class="flex gap-3 justify-center flex-wrap">
                         <button id="start-game-btn" class="btn btn-primary px-6">üéØ ÈñãÂßãÈÅäÊà≤</button>
                         <button id="reset-game-btn" class="btn bg-orange-500 hover:bg-orange-600 text-white px-6 hidden">üîÑ ÈáçÊñ∞ÈñãÂßã</button>
                     </div>

                     <!-- Game Completion Message -->
                     <div id="game-completion-msg" class="hidden mt-5 sm:mt-6 p-3 sm:p-4 bg-green-100 border-2 border-green-400 rounded-lg shadow-md">
                         <p class="text-lg sm:text-xl font-bold text-green-700 mb-2">üéâ ÊÅ≠ÂñúÔºÅÂÖ®ÈÉ®ÈÖçÂ∞çÂÆåÊàêÔºÅ</p>
                         <p class="text-xs sm:text-sm md:text-base text-gray-700">Áî®ÊôÇ: <span id="final-time"></span> Áßí | ÁøªËΩâÊ¨°Êï∏: <span id="final-moves"></span> Ê¨°</p>
                     </div>
                 </div>
             </div>
        </div>
        
        <div id="student-interaction-view" class="hidden relative">
            <div id="student-pause-overlay" class="pause-overlay hidden">
                <p>ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶Ü</p>
                <i class="fas fa-hand-paper"></i>
            </div>

            <div id="interaction-true-false" class="hidden px-4 sm:px-6">
                <h3 class="text-2xl font-bold text-center mb-6">ÊòØÈùûÈ°å</h3>
                <div class="flex flex-col gap-4 sm:gap-6 md:gap-8 justify-center items-center w-full max-w-6xl mx-auto">
                    <!-- Á≠îÊ°àÊåâÈàïÂçÄÂ°ä -->
                    <div class="flex justify-center gap-4 sm:gap-6 flex-shrink-0">
                        <button data-answer="O" class="answer-btn text-5xl sm:text-6xl lg:text-6xl w-28 sm:w-32 h-28 sm:h-32 rounded-full bg-green-500 text-white flex items-center justify-center shadow-lg transform hover:scale-110 transition">O</button>
                        <button data-answer="X" class="answer-btn text-5xl sm:text-6xl lg:text-6xl w-28 sm:w-32 h-28 sm:h-32 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg transform hover:scale-110 transition">X</button>
                    </div>
                    <!-- üöÄ RWD OPTIMIZED: Student-side chart container for true/false -->
                    <div id="student-chart-container-tf" class="hidden w-full bg-white p-3 sm:p-4 md:p-5 rounded-lg border-2 border-blue-300 shadow-md">
                        <h4 class="text-sm sm:text-base md:text-lg font-bold text-center mb-2 sm:mb-3 md:mb-4">üìä Âç≥ÊôÇÁµ±Ë®à</h4>
                        <svg id="student-chart-svg-tf" width="100%" height="280" viewBox="0 0 600 280" preserveAspectRatio="xMidYMid meet" style="background-color: #fff; border-radius: 0.5rem;"></svg>
                    </div>
                </div>
            </div>
            <div id="interaction-multiple-choice" class="hidden flex flex-col items-center px-4 sm:px-6 w-full">
                <h3 class="text-2xl font-bold text-center mb-4 sm:mb-6">ÈÅ∏ÊìáÈ°å</h3>
                <div class="flex flex-col gap-6 sm:gap-8 md:gap-8 w-full items-center justify-center max-w-6xl mx-auto">
                    <!-- Á≠îÊ°àÈÅ∏È†ÖÂçÄÂ°ä -->
                    <div class="flex flex-col items-center w-full flex-shrink-0">
                        <div id="default-mc-options" class="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4 w-full max-w-xs sm:max-w-sm md:max-w-md">
                             <button data-answer="1" class="answer-btn btn bg-blue-500 hover:bg-blue-600 h-16 sm:h-20 md:h-24 text-4xl sm:text-5xl md:text-6xl">1</button>
                             <button data-answer="2" class="answer-btn btn bg-yellow-500 hover:bg-yellow-600 h-16 sm:h-20 md:h-24 text-4xl sm:text-5xl md:text-6xl">2</button>
                             <button data-answer="3" class="answer-btn btn bg-green-500 hover:bg-green-600 h-16 sm:h-20 md:h-24 text-4xl sm:text-5xl md:text-6xl">3</button>
                             <button data-answer="4" class="answer-btn btn bg-red-500 hover:bg-red-600 h-16 sm:h-20 md:h-24 text-4xl sm:text-5xl md:text-6xl">4</button>
                        </div>
                        <div id="custom-mc-questions-container" class="hidden w-full max-w-2xl space-y-6 text-left mt-4">
                            </div>
                        <button id="submit-custom-mc-btn" class="btn btn-primary mt-4 hidden max-w-sm mx-auto">ÈÄÅÂá∫ÂÖ®ÈÉ®Á≠îÊ°à ‚úâÔ∏è</button>
                    </div>
                    <!-- üöÄ RWD OPTIMIZED: Student-side chart container for multiple choice -->
                    <div id="student-chart-container-mc" class="hidden w-full bg-white p-3 sm:p-4 md:p-5 rounded-lg border-2 border-blue-300 shadow-md">
                        <h4 class="text-sm sm:text-base md:text-lg font-bold text-center mb-2 sm:mb-3 md:mb-4">üìä Âç≥ÊôÇÁµ±Ë®à</h4>
                        <svg id="student-chart-svg-mc" width="100%" height="280" viewBox="0 0 600 280" preserveAspectRatio="xMidYMid meet" style="background-color: #fff; border-radius: 0.5rem;"></svg>
                    </div>
                </div>
            </div>
            <div id="interaction-text-input" class="hidden text-center">
                 <h3 class="text-2xl font-bold text-center mb-6">ÊñáÂ≠óÈ°å</h3>
                 <textarea id="text-input-area" rows="6" class="w-full p-3 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ë´ãÂú®Ê≠§Ëº∏ÂÖ•ÊÇ®ÁöÑÂõûÁ≠î..."></textarea>
                 <button id="submit-text-btn" class="btn btn-primary mt-4 max-w-sm mx-auto">ÈÄÅÂá∫ÂõûÁ≠î ‚úâÔ∏è</button>
            </div>
            <div id="interaction-drawing" class="hidden text-center flex flex-col h-full min-h-screen">
                <h3 class="text-2xl font-bold text-center mb-4">Áπ™ÂúñÈ°å</h3>
                <div class="flex flex-wrap justify-center md:justify-start items-center gap-4 mb-4 p-2 bg-gray-50 rounded-lg shadow-sm flex-shrink-0">
                    <button id="pen-tool-btn" class="p-2 rounded-lg border-2 border-blue-500 transition-all duration-150 ease-in-out h-11 flex items-center" title="Áï´Á≠Ü">
                        <i class="fas fa-paint-brush mr-1"></i> Áï´Á≠Ü ‚úèÔ∏è
                    </button>
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 font-medium flex items-center" for="color-select">
                            <span id="current-color-swatch" class="color-swatch mr-2 bg-black"></span> È°èËâ≤:
                        </label>
                        <select id="color-select" class="drawing-tool-select">
                            <option value="black" style="background-color: black; color: white;">ÈªëËâ≤</option>
                            <option value="red" style="background-color: red; color: white;">Á¥ÖËâ≤</option>
                            <option value="blue" style="background-color: blue; color: white;">ËóçËâ≤</option>
                            <option value="green" style="background-color: green; color: white;">Á∂†Ëâ≤</option>
                            <option value="yellow" style="background-color: yellow; color: black;">ÈªÉËâ≤</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-gray-700 font-medium" for="size-select">Á≤óÁ¥∞:</label>
                        <select id="size-select" class="drawing-tool-select">
                            <option value="2">Á¥∞</option>
                            <option value="5">‰∏≠</option>
                            <option value="10">Á≤ó</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="eraser-btn" class="p-2 rounded-lg border-2 border-transparent hover:bg-gray-200 transition-all duration-150 ease-in-out h-11" title="Ê©°ÁöÆÊì¶"><i class="fas fa-eraser mr-1"></i> Ê©°ÁöÆÊì¶ üßº</button>
                        <button id="clear-canvas-btn" class="p-2 rounded-lg border-2 border-transparent hover:bg-gray-200 transition-all duration-150 ease-in-out h-11" title="Ê∏ÖÈô§Áï´Â∏É"><i class="fas fa-trash mr-1"></i> Ê∏ÖÈô§ üßπ</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="student-image-upload-input" class="btn btn-purple !w-auto text-base h-11 px-4 py-2 flex items-center justify-center cursor-pointer">
                            <i class="fas fa-upload mr-2"></i> ‰∏äÂÇ≥ÂúñÁâá üñºÔ∏è
                        </label>
                        <input type="file" id="student-image-upload-input" accept="image/*" class="hidden">
                        <button id="clear-student-image-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">
                            <i class="fas fa-trash mr-2"></i> Ê∏ÖÈô§ÂúñÁâá üóëÔ∏è
                        </button>
                    </div>
                    <div class="flex items-center gap-2 mt-2 md:mt-0 ml-auto">
                        <button id="submit-drawing-btn" class="btn btn-primary !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">ÈÄÅÂá∫ üöÄ</button> </div>
                </div>
                <canvas id="drawing-canvas"></canvas>
            </div>
            <div id="interaction-url-dispatch" class="hidden">
                </div>
            <div id="interaction-recording" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4">
                <h3 class="text-2xl font-bold text-center mb-6">ÈåÑÈü≥È°å</h3>
                <div class="flex items-center justify-center space-x-3 text-xl text-gray-600 mb-6">
                    <i id="recording-status-icon" class="fas fa-microphone-alt text-gray-400"></i>
                    <p id="recording-status-text">Ê∫ñÂÇôÈåÑÈü≥...</p>
                </div>
                <div class="flex flex-wrap justify-center gap-4 mb-6">
                    <button id="start-recording-btn" class="btn btn-green !w-40 !h-16 flex items-center justify-center text-lg">
                        <i class="fas fa-play mr-2"></i> ÈñãÂßãÈåÑÈü≥ ‚ñ∂Ô∏è
                    </button>
                    <button id="stop-recording-btn" class="btn btn-red !w-40 !h-16 flex items-center justify-center text-lg" disabled>
                        <i class="fas fa-stop mr-2"></i> ÂÅúÊ≠¢ÈåÑÈü≥ ‚èπÔ∏è
                    </button>
                    <button id="play-recording-btn" class="btn btn-primary !w-40 !h-16 flex items-center justify-center text-lg" disabled>
                        <i class="fas fa-volume-up mr-2"></i> Ë©¶ËÅΩ üîä
                    </button>
                    <button id="reset-recording-btn" class="btn btn-orange !w-40 !h-10 flex items-center justify-center text-lg" disabled>
                        <i class="fas fa-redo mr-2"></i> ÈáçÈåÑ üîÑ
                    </button>
                </div>
                <audio id="audio-preview" controls class="w-full max-w-md mb-6 hidden"></audio>
                <button id="submit-recording-btn" class="btn btn-primary mt-4 max-w-sm mx-auto" disabled>
                    <i class="fas fa-paper-plane mr-2"></i> ÈÄÅÂá∫ÈåÑÈü≥ ‚úâÔ∏è
                </button>
            </div>
            <div id="interaction-reading-comprehension" class="hidden p-4">
                <h3 class="text-2xl font-bold text-center mb-4">Èñ±ËÆÄÊ∏¨È©ó</h3>

                <!-- ÂâçÂçÅÂêçÊéíË°åÊ¶ú -->
                <div id="reading-leaderboard" class="max-w-full mx-auto mb-4 hidden">
                    <div class="bg-gradient-to-r from-yellow-50 via-white to-yellow-50 border-2 border-yellow-300 rounded-lg p-3 sm:p-4 shadow-md">
                        <h4 class="text-base sm:text-lg font-bold text-yellow-700 mb-3 flex items-center justify-center">
                            <i class="fas fa-trophy mr-2"></i>ÂâçÂçÅÂêçÊéíË°åÊ¶ú üèÜ
                        </h4>
                        <div id="reading-leaderboard-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-5 gap-2 sm:gap-3">
                            <!-- ÊéíË°åÊ¶úÂ∞áÂãïÊÖãÁîüÊàêÂú®ÈÄôË£° -->
                        </div>
                    </div>
                </div>

                <!-- ÈüøÊáâÂºèÂ∑¶Âè≥ÂàÜÊ¨ÑÂÆπÂô®ÔºöÊ°åÈù¢50/50ÔºåÂπ≥Êùø45/55ÔºåÊâãÊ©ü‰∏ä‰∏ãÂ†ÜÁñä -->
                <div class="flex flex-col md:flex-row gap-4 max-w-full mx-auto">
                    
                    <!-- Â∑¶ÂÅ¥/‰∏äÊñπÔºöÊñáÁ´†ÂçÄ -->
                    <div class="w-full md:w-[45%] lg:w-1/2 flex flex-col">
                        <!-- ÊñáÁ´†Ê®ôÈ°åËàáÂ≠óÊï∏Áµ±Ë®à -->
                        <div class="bg-blue-50 border border-blue-200 rounded-t-lg px-4 py-2 flex items-center justify-between">
                            <h4 class="text-sm sm:text-base font-bold text-blue-700 flex items-center">
                                <i class="fas fa-book-open mr-2"></i>Èñ±ËÆÄÊñáÁ´†
                            </h4>
                            <span id="reading-word-count" class="text-xs sm:text-sm text-blue-600 font-medium">
                                ÂÖ± 0 Â≠ó
                            </span>
                        </div>
                        
                        <!-- Ëû¢ÂÖâÁ≠ÜÂ∑•ÂÖ∑Âàó -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-x border-blue-200 px-3 py-2 flex flex-wrap items-center gap-2">
                            <span class="text-xs sm:text-sm font-medium text-gray-700 mr-1">
                                <i class="fas fa-highlighter mr-1"></i><span class="hidden sm:inline">Ëû¢ÂÖâÁ≠Ü</span>
                            </span>
                            <button class="highlighter-btn" data-color="yellow" title="ÈªÉËâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-yellow-300"></span>
                            </button>
                            <button class="highlighter-btn" data-color="green" title="Á∂†Ëâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-green-300"></span>
                            </button>
                            <button class="highlighter-btn" data-color="pink" title="Á≤âËâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-pink-300"></span>
                            </button>
                            <button class="highlighter-btn" data-color="blue" title="ËóçËâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-blue-300"></span>
                            </button>
                            <button class="highlighter-btn" data-color="orange" title="Ê©òËâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-orange-300"></span>
                            </button>
                            <div class="h-4 w-px bg-gray-300 mx-1"></div>
                            <button id="eraser-btn-reading" class="px-2 py-1 text-xs sm:text-sm bg-amber-400 hover:bg-amber-500 text-gray-800 font-semibold rounded transition-colors flex items-center gap-1" title="ÈªûÊìäÂïüÁî®Ê©°ÁöÆÊì¶ÔºåÂÜçÈÅ∏‰∏≠Ë¶ÅÊì¶Èô§ÁöÑÈ´ò‰∫Æ">
                                <i class="fas fa-eraser text-xs"></i>
                                <span class="hidden sm:inline">üßºÊì¶Èô§</span>
                            </button>
                            <button id="clear-highlights-btn" class="px-2 py-1 text-xs sm:text-sm bg-red-500 hover:bg-red-600 text-white rounded transition-colors flex items-center gap-1" title="Ê∏ÖÈô§ÊâÄÊúâÊ®ôË®ª">
                                <i class="fas fa-eraser text-xs"></i>
                                <span class="hidden sm:inline">Ê∏ÖÈô§</span>
                            </button>
                        </div>
                        
                        <!-- ÊñáÁ´†ÂÖßÂÆπÊªæÂãïÂçÄÔºàÂõ∫ÂÆöÈ´òÂ∫¶Ôºâ -->
                        <div class="relative flex-1 bg-gray-50 border border-t-0 border-blue-200 rounded-b-lg overflow-hidden">
                            <div id="reading-text-display" class="h-[40vh] md:h-[60vh] overflow-y-auto p-4 sm:p-6 text-left text-sm sm:text-base leading-relaxed whitespace-pre-wrap"></div>
                            
                            <!-- ÂõûÂà∞È†ÇÈÉ®ÊµÆÂãïÊåâÈàï -->
                            <button id="reading-scroll-top-btn" class="hidden absolute bottom-4 right-4 bg-blue-500 hover:bg-blue-600 text-white rounded-full w-10 h-10 sm:w-12 sm:h-12 shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110 z-10">
                                <i class="fas fa-arrow-up text-base sm:text-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Âè≥ÂÅ¥/‰∏ãÊñπÔºöÈ°åÁõÆÂçÄ -->
                    <div class="w-full md:w-[55%] lg:w-1/2 flex flex-col">
                        <!-- È°åÁõÆÊ®ôÈ°åËàáÈÄ≤Â∫¶È°ØÁ§∫ -->
                        <div class="bg-green-50 border border-green-200 rounded-t-lg px-4 py-2 flex items-center justify-between">
                            <h4 class="text-sm sm:text-base font-bold text-green-700 flex items-center">
                                <i class="fas fa-clipboard-list mr-2"></i>È°åÁõÆ
                            </h4>
                            <span id="reading-question-progress" class="text-xs sm:text-sm text-green-600 font-medium">
                                Â∑≤Á≠î 0 / ÂÖ± 0 È°å
                            </span>
                        </div>
                        
                        <!-- È°åÁõÆÂàóË°®ÊªæÂãïÂçÄÔºàÂõ∫ÂÆöÈ´òÂ∫¶Ôºâ -->
                        <div class="flex-1 bg-white border border-t-0 border-green-200 rounded-b-lg overflow-hidden">
                            <div id="reading-questions-container" class="h-[40vh] md:h-[60vh] overflow-y-auto p-4 space-y-4 sm:space-y-6">
                                <!-- È°åÁõÆÂ∞áÂãïÊÖãÁîüÊàêÂú®ÈÄôË£° -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÈÄÅÂá∫Á≠îÊ°àÊåâÈàï -->
                <div class="text-center mt-4">
                    <button id="submit-reading-btn" class="btn btn-primary max-w-sm mx-auto">ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è</button>
                </div>
            </div>
            <div id="interaction-quick-answer" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4 relative">
                <h3 class="text-2xl md:text-3xl font-bold text-center mb-4 md:mb-6">Êê∂Á≠îÈ°å</h3>
                <p id="quick-answer-status-text" class="text-base md:text-lg text-gray-600 mb-4 md:mb-6">Á≠âÂæÖÊê∂Á≠îÈñãÂßã...</p>
                <div id="quick-answer-button-container" class="absolute inset-0 pointer-events-none">
                    <!-- Êê∂Á≠îÊåâÈàïÂ∞áÊúÉÂãïÊÖãÁîüÊàêÂú®ÈÄôË£° -->
                </div>
                <div id="quick-answer-result" class="hidden relative z-10">
                    <div id="confetti-container" class="confetti-container"></div>
                    <h2 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-green-600 mb-3 md:mb-4 animate-bounce">üéâ Êê∂Á≠îÊàêÂäüÔºÅ</h2>
                    <p class="text-lg sm:text-xl md:text-2xl text-gray-700 font-medium px-4">‰Ω†ÊòØÁ¨¨‰∏ÄÂÄãÈªûÂà∞ÊåâÈàïÁöÑÂ≠∏ÁîüÔºÅ</p>
                </div>
                <div id="quick-answer-locked" class="hidden">
                    <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-red-600 mb-3 md:mb-4">‚è∞ Êê∂Á≠îÁµêÊùü</h2>
                    <p class="text-lg sm:text-xl md:text-2xl text-gray-700 px-4">ÂÖ∂‰ªñÂêåÂ≠∏Â∑≤Á∂ìÊê∂Á≠îÊàêÂäü‰∫ÜÔºÅ</p>
                </div>
            </div>
            <div id="interaction-sequencing" class="hidden text-center">
                <h3 class="text-2xl font-bold text-center mb-2">ÊéíÂ∫èÈ°å</h3>
                <p id="sequencing-question-text" class="text-lg text-gray-700 mb-6"></p>
                <div class="sequencing-container">
                    <div id="sequencing-items-container" class="mb-6">
                        <!-- ÊéíÂ∫èÈ†ÖÁõÆÂ∞áÂãïÊÖãÁîüÊàêÂú®ÈÄôË£° -->
                    </div>
                    <button id="submit-sequencing-btn" class="btn btn-primary max-w-sm mx-auto">ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è</button>
                </div>
            </div>
            <div id="interaction-matching" class="hidden text-center">
                <h3 class="text-2xl font-bold text-center mb-2">ÈÖçÂ∞çÈ°å</h3>
                <p id="matching-question-text" class="text-lg text-gray-700 mb-6"></p>
                <div class="matching-container">
                    <svg id="matching-svg-canvas"></svg>
                    <div class="matching-column" id="matching-column-a" style="z-index: 2;">
                        <!-- AÈ†ÖÁõÆÂàóË°® -->
                    </div>
                    <div class="matching-column" id="matching-column-b" style="z-index: 2;">
                        <!-- BÈ†ÖÁõÆÂàóË°® -->
                    </div>
                </div>
                <button id="submit-matching-btn" class="btn btn-primary max-w-sm mx-auto mt-6">ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è</button>
            </div>

            <div id="interaction-quick-poll" class="hidden text-center flex flex-col items-center justify-center h-full min-h-screen p-4">
                <h3 class="text-2xl font-bold text-center mb-4">Âø´ÈÄüÊäïÁ•®</h3>
                <p id="quick-poll-question-display" class="text-xl text-gray-800 mb-8 font-medium px-4"></p>

                <!-- ÊäïÁ•®ÈÅ∏È†ÖÂÆπÂô® -->
                <div id="quick-poll-options-container" class="w-full max-w-2xl">
                    <!-- ÈÅ∏È†ÖÊåâÈàïÂ∞áÊúÉÂãïÊÖãÁîüÊàêÂú®ÈÄôË£° -->
                </div>

                <!-- Â∑≤ÊäïÁ•®ÁãÄÊÖã -->
                <div id="quick-poll-voted-status" class="hidden mt-8">
                    <div class="bg-green-100 border-2 border-green-500 rounded-lg p-6">
                        <i class="fas fa-check-circle text-green-600 text-5xl mb-3"></i>
                        <h4 class="text-2xl font-bold text-green-700 mb-2">ÊäïÁ•®ÊàêÂäüÔºÅ</h4>
                        <p class="text-gray-700">ÊÑüË¨ùÊÇ®ÁöÑÂèÉËàá</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-peer-review-view" class="hidden">
            <div class="flex flex-col h-full min-h-screen">
                <div class="flex-shrink-0 mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">‰ΩúÂìÅËßÄÊë©ËàáÊäïÁ•®</h2>
                    <p class="text-lg text-gray-600 text-center mb-6">ÈªûÊìäÊÑõÂøÉÊäïÁ•®ÔºåÂÜçÈªûÊìäÂèØÂèñÊ∂àÔºÅÊúÄÂ§öÂèØÊäï <span class="font-bold text-red-600">3</span> ÂÄã‰∏çÂêå‰ΩúÂìÅ</p>
                    <div class="text-center mb-4">
                        <span class="inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-medium">
                            Â∑≤ÊäïÁ•®Ôºö<span id="current-vote-count">0</span> / 3
                        </span>
                    </div>
                </div>
                
                <div id="peer-review-works-container" class="flex-1 bg-gray-100 p-4 rounded-lg overflow-y-auto">
                    <div id="peer-review-works-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-gray-500 text-center col-span-full">ËºâÂÖ•‰ΩúÂìÅ‰∏≠...</p>
                    </div>
                </div>
                
                <div class="flex-shrink-0 mt-4 text-center">
                    <button id="exit-peer-review-btn" class="btn btn-gray !w-auto text-base h-11 px-6 py-2">
                        <i class="fas fa-arrow-left mr-2"></i> ËøîÂõûÁ≠âÂæÖ
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg hidden z-50 transition-all duration-300 transform" role="alert">
        <p id="message-content"></p>
        <button id="close-message-btn" class="absolute top-1 right-2 text-white text-xl leading-none">√ó</button>
    </div>

    <div id="magnified-image-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content">
            <button id="magnified-image-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <img id="magnified-image" src="" alt="ÊîæÂ§ßÁπ™Âúñ">
        </div>
    </div>

    <div id="student-list-modal" class="magnified-image-modal hidden">
        <div id="student-list-modal-content" class="magnified-image-modal-content max-w-md w-[95%] sm:w-[85%] md:w-[75%] max-h-[85vh] overflow-hidden flex flex-col">
            <button id="student-list-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-lg sm:text-xl md:text-2xl font-semibold mb-3 sm:mb-4 text-gray-800 text-center flex-shrink-0">ÁõÆÂâçÂú®Á∑öÂ≠∏Áîü</h4>
            <button id="modal-draw-lottery-btn" class="btn btn-orange !w-auto text-sm sm:text-base mb-3 sm:mb-4 px-4 sm:px-5 py-2 sm:py-2.5 transition-all hover:shadow-lg mx-auto flex-shrink-0">ÊäΩÁ±§ üé≤</button>
            <div id="modal-student-names" class="flex-1 overflow-y-auto min-h-[140px] max-h-[50vh] bg-gray-50 rounded-lg p-3 sm:p-4 border border-gray-200">
                <div class="empty-state-container w-full h-full min-h-[120px] flex flex-col items-center justify-center text-center py-8 sm:py-10">
                    <div class="w-14 h-14 sm:w-16 sm:h-16 mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                        <i class="fas fa-users text-gray-300 text-2xl sm:text-3xl"></i>
                    </div>
                    <span class="block text-gray-400 text-base sm:text-lg font-medium">Ê≤íÊúâÂ≠∏ÁîüÂú®Á∑ö</span>
                    <span class="block text-gray-300 text-sm sm:text-base mt-2">Á≠âÂæÖÂ≠∏ÁîüÂä†ÂÖ•Ë™≤Â†Ç...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="statistics-modal" class="magnified-image-modal hidden">
        <div id="statistics-modal-content" class="magnified-image-modal-content">
            <button id="chart-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 id="chart-title" class="text-lg sm:text-xl md:text-2xl font-bold mb-2 sm:mb-4 text-gray-800 text-center">‰ΩúÁ≠îÁµ±Ë®à</h4>
            <div id="chart-container" class="w-full">
                <svg id="chart-svg" viewBox="0 0 500 350" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
            <div id="students-by-answer-list-container" class="hidden mt-3">
                <h5 id="students-by-answer-list-title" class="text-sm sm:text-base font-bold mb-2 text-gray-700"></h5>
                <p id="students-by-answer-names" class="text-xs sm:text-sm text-gray-700 break-words"></p> 
            </div>
            <div class="flex justify-center gap-2 sm:gap-4 mt-4 sm:mt-6 flex-wrap">
                <button id="download-statistics-btn" class="btn btn-green !w-auto text-xs sm:text-sm md:text-base h-9 sm:h-10 md:h-11 px-3 sm:px-4 md:px-6">
                    <i class="fas fa-download mr-1 sm:mr-2"></i><span class="hidden sm:inline">‰∏ãËºâÁµ±Ë®à</span><span class="sm:hidden">‰∏ãËºâ</span> (CSV)
                </button>
            </div>
        </div>
    </div>

    <div id="ai-summary-modal" class="magnified-image-modal hidden">
        <div id="ai-summary-modal-content">
            <button id="ai-summary-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4>AI ÊñáÂ≠óÂàÜÊûê - ÁÜ±ÈñÄË©ûÂΩô</h4>
            <div id="ai-loading-spinner" class="hidden">
                <p>ÊñáÂ≠óÂàÜÊûê‰∏≠....</p>
            </div>
            <ul id="ai-summary-result-list">
                </ul>
        </div>
    </div>

    <div id="ai-settings-modal" class="magnified-image-modal hidden">
        <div id="ai-settings-modal-content" class="magnified-image-modal-content max-w-lg mx-auto p-4 sm:p-6">
            <button id="ai-settings-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 mb-4 sm:mb-6">AI Ë®≠ÂÆö</h4>
            <div class="space-y-4 sm:space-y-6">
                <div>
                    <label for="ai-source-select" class="block text-sm sm:text-base md:text-lg font-medium text-gray-700 mb-2">AI Ê®°Âûã‰æÜÊ∫ê:</label>
                    <select id="ai-source-select" class="w-full px-3 py-3 sm:px-4 sm:py-4 text-base sm:text-lg md:text-xl font-semibold text-gray-800 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white cursor-pointer" style="appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23374151'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E&quot;); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.5em 1.5em;">
                        <option value="gemini-default" class="text-base sm:text-lg md:text-xl">‰ΩøÁî®ÁõÆÂâç Gemini (‰∏çÂèØ‰ΩøÁî®)</option>
                        <option value="gemini-custom" selected class="text-base sm:text-lg md:text-xl">Ëá™Ë®Ç Gemini API Key</option>
                    </select>
                </div>
                <div id="gemini-api-key-group" class="hidden">
                    <div class="flex items-center justify-between mb-2">
                        <label for="gemini-api-key-input" class="block text-sm sm:text-base md:text-lg font-medium text-gray-700">Gemini API Key:</label>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-xs sm:text-sm text-blue-600 hover:text-blue-800 hover:underline font-semibold">
                            <i class="fas fa-key mr-1"></i>ÂèñÂæóÂÖçË≤ª API Key
                        </a>
                    </div>
                    <input type="password" id="gemini-api-key-input" placeholder="Ë´ãË≤º‰∏äÊÇ®ÁöÑ Gemini API Key" class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg text-sm sm:text-base md:text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="settings-button-group mt-6 sm:mt-8">
                <button id="save-ai-settings-btn" class="btn btn-primary w-full sm:w-auto text-base sm:text-lg px-6 py-3">ÂÑ≤Â≠òË®≠ÂÆö üíæ</button>
            </div>
        </div>
    </div>

    <div id="url-dispatch-settings-modal" class="magnified-image-modal hidden">
        <div id="url-dispatch-settings-modal-content" class="magnified-image-modal-content">
            <button id="url-dispatch-settings-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4>Ë®≠ÂÆöÊ¥æÈÄÅÁ∂≤ÂùÄ/HTML</h4>
            <div class="w-full space-y-4">
                <div class="flex items-center justify-center gap-6 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="dispatchType" value="url" class="form-radio text-blue-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-700 font-medium">Ê¥æÈÄÅÁ∂≤ÂùÄ</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="dispatchType" value="html" class="form-radio text-blue-600 h-5 w-5">
                        <span class="ml-2 text-gray-700 font-medium">Ê¥æÈÄÅ HTML</span>
                    </label>
                </div>

                <div id="url-dispatch-section">
                    <div>
                        <label for="dispatch-url-input">Á∂≤ÂùÄ:</label>
                        <input type="text" id="dispatch-url-input" placeholder="Ë´ãË≤º‰∏äË¶ÅÊ¥æÈÄÅÁöÑÁ∂≤ÂùÄ" class="w-full">
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="is-youtube-checkbox">
                        <label for="is-youtube-checkbox">Ê≠§ÈÄ£ÁµêÁÇ∫ YouTube ÂΩ±Áâá</label>
                    </div>
                </div>

                <div id="html-dispatch-section" class="hidden">
                    <div class="flex flex-col items-center">
                        <div class="flex gap-4 mb-4">
                            <label for="dispatch-html-upload-input" class="btn bg-yellow-600 !w-auto text-base h-11 px-4 py-2 flex items-center justify-center cursor-pointer">
                                <i class="fas fa-file-upload mr-2"></i> ‰∏äÂÇ≥ HTML Ê™îÊ°à ‚¨ÜÔ∏è
                            </label>
                            <input type="file" id="dispatch-html-upload-input" accept=".html" class="hidden">
                            <button id="clear-dispatch-html-btn" class="btn btn-red !w-auto text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i class="fas fa-trash mr-2"></i> Ê∏ÖÈô§ HTML üóëÔ∏è
                            </button>
                        </div>
                        <p id="dispatch-html-status" class="text-gray-600 text-sm mt-2">ÁõÆÂâçÊ≤íÊúâ HTML Ê™îÊ°à„ÄÇ</p>
                    </div>
                </div>
            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="clear-dispatch-settings-btn" class="btn btn-red">Ê∏ÖÈô§Ë®≠ÂÆö üßπ</button>
                <button id="save-dispatch-settings-btn" class="btn btn-primary">ÂÑ≤Â≠òË®≠ÂÆö üíæ</button>
            </div>
        </div>
    </div>

    <div id="unsubmitted-students-modal" class="magnified-image-modal hidden">
        <div id="unsubmitted-students-modal-content" class="magnified-image-modal-content">
            <button id="unsubmitted-students-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">Êú™‰ΩúÁ≠îÂ≠∏ÁîüÂêçÂñÆ</h4>
            <div id="modal-unsubmitted-student-names">
                <p class="text-gray-500 text-sm">ÊâÄÊúâÂ≠∏ÁîüÁöÜÂ∑≤‰ΩúÁ≠îÊàñÁÑ°Â≠∏ÁîüÂú®Á∑ö</p>
            </div>
        </div>
    </div>

    <!-- Êü•ÁúãÈ°åÁõÆÊ®°ÊÖãÊ°Ü -->
    <div id="view-questions-modal" class="magnified-image-modal hidden">
        <div id="view-questions-modal-content" class="magnified-image-modal-content">
            <button id="view-questions-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">Êü•ÁúãÈ°åÁõÆËàáÊ≠£Á¢∫Á≠îÊ°à</h4>
            <div id="questions-display-container" class="w-full space-y-4 max-h-96 overflow-y-auto">
                <!-- È°åÁõÆÂÖßÂÆπÂ∞áÂãïÊÖãÂ°´ÂÖ• -->
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="save-correct-answers-btn" class="btn btn-green !w-auto px-6">ÂÑ≤Â≠ò‰øÆÊîπ</button>
                <button id="cancel-questions-view-btn" class="btn bg-gray-500 hover:bg-gray-600 !w-auto px-6">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- Êü•ÁúãÈñ±ËÆÄÊ∏¨È©óÈ°åÁõÆÊ®°ÊÖãÊ°Ü -->
    <div id="view-reading-questions-modal" class="magnified-image-modal hidden">
        <div id="view-reading-questions-modal-content" class="magnified-image-modal-content" style="max-width: 1200px;">
            <button id="view-reading-questions-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">üìñ Èñ±ËÆÄÊ∏¨È©óÈ°åÁõÆ</h4>

            <!-- üöÄ NEW: ÈüøÊáâÂºèÂ∑¶Âè≥ÂàÜÊ¨ÑÂÆπÂô® -->
            <div class="flex flex-col md:flex-row gap-4 md:gap-6">
                
                <!-- Â∑¶ÂÅ¥ÔºöÈñ±ËÆÄÊñáÊú¨È°ØÁ§∫ (ËóçËâ≤‰∏ªÈ°å) -->
                <div class="w-full md:w-[45%] lg:w-1/2">
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 h-full flex flex-col">
                        <h5 class="text-lg font-bold text-blue-800 mb-3 flex items-center gap-2">
                            üìÑ Èñ±ËÆÄÊñáÊú¨
                            <span id="view-reading-word-count" class="text-sm font-normal text-blue-600">(ÂÖ± 0 Â≠ó)</span>
                        </h5>
                        
                        <!-- ÊïôÂ∏´Á´ØËû¢ÂÖâÁ≠ÜÂ∑•ÂÖ∑Âàó -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg px-3 py-2 mb-3 flex flex-wrap items-center gap-2">
                            <span class="text-xs sm:text-sm font-medium text-gray-700 mr-1">
                                <i class="fas fa-highlighter mr-1"></i><span class="hidden sm:inline">Ëû¢ÂÖâÁ≠Ü</span>
                            </span>
                            <button class="teacher-highlighter-btn" data-color="yellow" title="ÈªÉËâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-yellow-300"></span>
                            </button>
                            <button class="teacher-highlighter-btn" data-color="green" title="Á∂†Ëâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-green-300"></span>
                            </button>
                            <button class="teacher-highlighter-btn" data-color="pink" title="Á≤âËâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-pink-300"></span>
                            </button>
                            <button class="teacher-highlighter-btn" data-color="blue" title="ËóçËâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-blue-300"></span>
                            </button>
                            <button class="teacher-highlighter-btn" data-color="orange" title="Ê©òËâ≤Ëû¢ÂÖâÁ≠Ü">
                                <span class="highlighter-preview bg-orange-300"></span>
                            </button>
                            <div class="h-4 w-px bg-gray-300 mx-1"></div>
                            <button id="teacher-eraser-btn-reading" class="px-2 py-1 text-xs sm:text-sm bg-amber-400 hover:bg-amber-500 text-gray-800 font-semibold rounded transition-colors flex items-center gap-1" title="ÈªûÊìäÂïüÁî®Ê©°ÁöÆÊì¶ÔºåÂÜçÈÅ∏‰∏≠Ë¶ÅÊì¶Èô§ÁöÑÈ´ò‰∫Æ">
                                <i class="fas fa-eraser text-xs"></i>
                                <span class="hidden sm:inline">üßºÊì¶Èô§</span>
                            </button>
                            <button id="teacher-clear-highlights-btn" class="px-2 py-1 text-xs sm:text-sm bg-red-500 hover:bg-red-600 text-white rounded transition-colors flex items-center gap-1" title="Ê∏ÖÈô§ÊâÄÊúâÊ®ôË®ª">
                                <i class="fas fa-eraser text-xs"></i>
                                <span class="hidden sm:inline">Ê∏ÖÈô§</span>
                            </button>
                        </div>
                        
                        <div id="view-reading-text-display" class="bg-white p-4 rounded-lg border border-blue-200 text-base leading-relaxed whitespace-pre-wrap h-[40vh] md:h-[60vh] overflow-y-auto">
                            <!-- ÊñáÊú¨ÂÖßÂÆπÂ∞áÂãïÊÖãÂ°´ÂÖ• -->
                        </div>
                    </div>
                </div>

                <!-- Âè≥ÂÅ¥ÔºöÈ°åÁõÆÈ°ØÁ§∫ (Á∂†Ëâ≤‰∏ªÈ°å) -->
                <div class="w-full md:w-[55%] lg:w-1/2">
                    <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 h-full flex flex-col">
                        <h5 class="text-lg font-bold text-green-800 mb-3 flex items-center gap-2">
                            ‚ùì È°åÁõÆËàáÁ≠îÊ°à
                            <span id="view-reading-questions-count" class="text-sm font-normal text-green-600">(ÂÖ± 0 È°å)</span>
                        </h5>
                        <div id="view-reading-questions-display" class="space-y-4 h-[40vh] md:h-[60vh] overflow-y-auto bg-white p-4 rounded-lg border border-green-200">
                            <!-- È°åÁõÆÂÖßÂÆπÂ∞áÂãïÊÖãÂ°´ÂÖ• -->
                        </div>
                    </div>
                </div>
                
            </div>

            <div class="flex justify-end gap-4 mt-6">
                <button id="close-reading-questions-view-btn" class="btn btn-primary !w-auto px-6">ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <!-- üöÄ NEW: ‰øÆÊîπÈñ±ËÆÄÊ∏¨È©óÁ≠îÊ°àÊ®°ÊÖãÊ°Ü -->
    <div id="edit-reading-answer-modal" class="magnified-image-modal hidden">
        <div id="edit-reading-answer-modal-content" class="magnified-image-modal-content" style="max-width: 600px;">
            <button id="edit-reading-answer-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">‚úèÔ∏è ‰øÆÊîπÁ≠îÊ°à</h4>
            
            <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm text-gray-600 mb-1">È°åÁõÆÁ∑®Ëôü</p>
                <p id="edit-answer-question-number" class="font-bold text-lg text-gray-800 mb-3"></p>
                <p class="text-sm text-gray-600 mb-1">È°åÁõÆÂÖßÂÆπ</p>
                <p id="edit-answer-question-text" class="font-medium text-gray-800"></p>
            </div>

            <div class="mb-4">
                <p class="text-sm font-bold text-gray-700 mb-3">Ë´ãÈÅ∏ÊìáÊñ∞ÁöÑÊ≠£Á¢∫Á≠îÊ°àÊàñÈÄÅÂàÜÔºö</p>
                <div id="edit-answer-options-container" class="space-y-2">
                    <!-- ÈÅ∏È†ÖÊåâÈàïÂ∞áÂãïÊÖãÂ°´ÂÖ• -->
                </div>
                <button id="give-points-btn" class="w-full p-3 text-left rounded-lg border-2 bg-gradient-to-r from-yellow-50 to-amber-50 border-yellow-400 hover:bg-yellow-100 transition-all duration-200 mt-2">
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-lg text-yellow-600">üéÅ</span>
                        <span class="text-yellow-800 font-medium">ÈÄÅÂàÜÈ°åÔºàÂÖ®Áè≠Â≠∏ÁîüÁç≤ÂæóË©≤È°åÊªøÂàÜÔºâ</span>
                    </div>
                </button>
            </div>

            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-300 rounded-lg">
                <div class="flex items-start gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                    <div class="text-sm text-yellow-800">
                        <p class="font-bold mb-1">‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ†Ö</p>
                        <p>‰øÆÊîπÁ≠îÊ°àÂæåÔºåÁ≥ªÁµ±Â∞áËá™ÂãïÈáçÊñ∞Ë®àÁÆóÊâÄÊúâÂ∑≤Êèê‰∫§Â≠∏ÁîüÁöÑÊàêÁ∏æÔºàÂåÖÊã¨Âü∫Á§éÂàÜÂíåÁ∏ΩÂàÜÔºâ„ÄÇÁ≠ÜË®òÂä†ÂàÜ‰∏çÂèóÂΩ±Èüø„ÄÇ</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-6">
                <button id="confirm-edit-answer-btn" class="btn bg-orange-500 hover:bg-orange-600 !w-auto px-6" disabled>
                    Á¢∫Ë™ç‰øÆÊîπ
                </button>
                <button id="cancel-edit-answer-btn" class="btn bg-gray-500 hover:bg-gray-600 !w-auto px-6">
                    ÂèñÊ∂à
                </button>
            </div>
        </div>
    </div>

    <div id="multiple-choice-settings-modal" class="magnified-image-modal hidden">
        <div id="multiple-choice-settings-modal-content" class="magnified-image-modal-content">
            <button id="multiple-choice-settings-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">ÈÅ∏ÊìáÈ°åË®≠ÂÆö</h4>
            <div class="w-full space-y-4">
                <div class="flex items-center justify-center gap-6 mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="mcQuestionType" value="none" class="form-radio text-blue-600 h-5 w-5" checked>
                        <span class="ml-2 text-gray-700 font-medium">ÁÑ°È°åÁõÆÂá∫È°å (È†êË®≠ 1-4 ÈÅ∏È†Ö)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="mcQuestionType" value="custom" class="form-radio text-blue-600 h-5 w-5">
                        <span class="ml-2 text-gray-700 font-medium">Ëá™Ë®ÇÈ°åÁõÆÂá∫È°å</span>
                    </label>
                </div>

                <div id="custom-mc-questions-section" class="hidden w-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <div class="flex flex-col space-y-2">
                            <label for="custom-mc-questions-textarea" class="block text-gray-700 text-sm font-bold">
                                Ë´ãËº∏ÂÖ•È°åÁõÆ (ÊàñÁî± AI ÁîüÊàê)
                            </label>
                            <p class="text-gray-600 text-xs">Ê†ºÂºè: È°åÁõÆ,Ê≠£Á¢∫Á≠îÊ°à(1-4ÊàñA-D),ÈÅ∏È†Ö1,ÈÅ∏È†Ö2,ÈÅ∏È†Ö3,ÈÅ∏È†Ö4 (ÊØèË°å‰∏ÄÈ°å)</p>
                            <textarea id="custom-mc-questions-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow" placeholder="‰æãÂ¶ÇÔºö
Âè∞ÁÅ£ÁöÑÈ¶ñÈÉΩÂú®Âì™Ë£°?,1,Âè∞Âåó,Âè∞‰∏≠,Âè∞Âçó,È´òÈõÑ
2+2=?,B,3,4,5,6"></textarea>
                            <p id="custom-mc-questions-status" class="text-red-500 text-sm mt-2 hidden">Ê†ºÂºèÈåØË™§ÊàñÈ°åÁõÆÁÇ∫Á©∫ÔºåË´ãÊ™¢Êü•Ëº∏ÂÖ•„ÄÇ</p>
                        </div>

                        <div class="flex flex-col space-y-4 bg-gray-50 p-4 rounded-lg border">
                            <h5 class="text-lg font-bold text-gray-800 text-center">ü§ñ AI Êô∫ËÉΩÂá∫È°å</h5>
                            <div>
                                <label for="ai-mc-topic-textarea" class="block text-gray-700 text-sm font-bold mb-2">Âá∫È°å‰∏ªÈ°å„ÄÅÁØÑÂúçÊàñË¶ÅÊ±Ç:</label>
                                <textarea id="ai-mc-topic-textarea" rows="3" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‰æãÂ¶ÇÔºö
- ÈóúÊñºÂè∞ÁÅ£Ê≠∑Âè≤ÁöÑÈÅ∏ÊìáÈ°å
- ÈóúÊñºÂÖâÂêà‰ΩúÁî®ÁöÑÂúã‰∏≠Á®ãÂ∫¶ÊòØÈùûÈ°å
- Ë´ãÂá∫ÊúâÈóúËÅñË™ïÁØÄÁöÑËã±ÊñáÂñÆÂ≠óÈÅ∏ÊìáÈ°å"></textarea>
                            </div>
                            <div>
                                <label for="ai-mc-count-input" class="block text-gray-700 text-sm font-bold mb-2">Âá∫È°åÊï∏Èáè (1-10):</label>
                                <input type="number" id="ai-mc-count-input" min="1" max="10" value="5" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="text-center">
                                <button id="ai-generate-mc-btn" class="btn btn-purple !w-auto text-base h-11 px-4 py-2 flex items-center justify-center mx-auto">
                                    <i id="ai-mc-btn-icon" class="fas fa-magic mr-2"></i>
                                    <span id="ai-mc-btn-text">AI ÈñãÂßãÂá∫È°å</span>
                                </button>
                            </div>
                            <div id="ai-mc-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span>AI ÊÄùËÄÉ‰∏≠ÔºåË´ãÁ®çÂÄô...</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- È°åÂ∫´ÁÆ°ÁêÜÂçÄÂ°ä -->
                <div id="question-bank-management-section" class="hidden w-full mt-6 bg-blue-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 text-center mb-4">üìö È°åÂ∫´ÁÆ°ÁêÜ</h5>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- È°åÂ∫´ËºâÂÖ•ÂçÄ -->
                        <div class="flex flex-col space-y-2">
                            <label class="block text-gray-700 text-sm font-bold">ÂæûÊ™îÊ°àËºâÂÖ•È°åÂ∫´</label>
                            <input type="file" id="question-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="load-question-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">ËºâÂÖ•È°åÂ∫´</button>
                        </div>

                        <!-- È°åÂ∫´ÂÑ≤Â≠òÂçÄ -->
                        <div class="flex flex-col space-y-2">
                            <label class="block text-gray-700 text-sm font-bold">ÂÑ≤Â≠òÁõÆÂâçÈ°åÁõÆÁÇ∫È°åÂ∫´</label>
                            <input type="text" id="question-bank-name-input" placeholder="Ëº∏ÂÖ•È°åÂ∫´ÂêçÁ®±" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="save-question-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">ÂÑ≤Â≠òÈ°åÂ∫´</button>
                        </div>
                    </div>

                    <!-- È°åÂ∫´ÂàóË°® -->
                    <div class="mt-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Â∑≤ÂÑ≤Â≠òÁöÑÈ°åÂ∫´</label>
                        <div id="question-bank-list" class="space-y-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-white">
                            <div class="text-gray-500 text-sm italic text-center">ÁõÆÂâçÊ≤íÊúâÂÑ≤Â≠òÁöÑÈ°åÂ∫´</div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="start-mc-interaction-btn" class="btn btn-primary">Á¢∫Ë™ç‰∏¶ÈñãÂßã‰∫íÂãï üöÄ</button>
                <button id="cancel-mc-settings-btn" class="btn btn-gray">ÂèñÊ∂à ‚Ü©Ô∏è</button>
            </div>
        </div>
    </div>

    <!-- B. ÈÅ∏Êìá/ÊéíÂ∫è/ÈÖçÂ∞çÈ°åÈÅ∏ÂñÆÊ®°ÊÖãÊ°Ü -->
    <div id="choice-sequencing-matching-menu-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content" style="max-width: 400px;">
            <button id="choice-sequencing-matching-menu-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-6 text-gray-800 text-center">B. Ë´ãÈÅ∏ÊìáÈ°åÂûã</h4>
            <div class="space-y-4">
                <button id="open-multiple-choice-settings-btn" class="btn btn-green w-full text-xl py-4">‚úì ÈÅ∏ÊìáÈ°å</button>
                <button id="open-sequencing-settings-btn" class="btn bg-cyan-500 hover:bg-cyan-600 w-full text-xl py-4">üìã ÊéíÂ∫èÈ°å</button>
                <button id="open-matching-settings-btn" class="btn bg-pink-500 hover:bg-pink-600 w-full text-xl py-4">üîó ÈÖçÂ∞çÈ°å</button>
            </div>
        </div>
    </div>

    <!-- ÊéíÂ∫è/ÈÖçÂ∞çÈ°åÈÅ∏ÂñÆÊ®°ÊÖãÊ°Ü -->
    <div id="sequencing-matching-menu-modal" class="magnified-image-modal hidden">
        <div class="magnified-image-modal-content" style="max-width: 400px;">
            <button id="sequencing-matching-menu-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-6 text-gray-800 text-center">Ë´ãÈÅ∏ÊìáÈ°åÂûã</h4>
            <div class="space-y-4">
                <button id="sequencing-settings-btn" class="btn bg-cyan-500 hover:bg-cyan-600 w-full text-xl py-4">üìã ÊéíÂ∫èÈ°å</button>
                <button id="matching-settings-btn" class="btn bg-pink-500 hover:bg-pink-600 w-full text-xl py-4">üîó ÈÖçÂ∞çÈ°å</button>
            </div>
        </div>
    </div>

    <!-- ÊéíÂ∫èÈ°åË®≠ÂÆöÊ®°ÊÖãÊ°Ü -->
    <div id="sequencing-settings-modal" class="magnified-image-modal hidden">
        <div id="sequencing-settings-modal-content" class="magnified-image-modal-content">
            <button id="sequencing-settings-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <div class="w-full">
                <!-- È°åÂûãÂàáÊèõÊåâÈàï -->
                <div class="flex justify-center mb-4 gap-2">
                    <button id="switch-to-matching-btn" class="btn bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 text-sm">
                        üîó ÂàáÊèõÂà∞ÈÖçÂ∞çÈ°å
                    </button>
                </div>
                <h4 class="text-2xl font-bold mb-4 text-gray-800">ÊéíÂ∫èÈ°åË®≠ÂÆö</h4>

                <!-- ‰∏äÊñπÔºöÂ∑¶Âè≥ÂÖ©Ê¨ÑÂ∏ÉÂ±Ä -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- Â∑¶Ê¨ÑÔºöÈ°åÁõÆËº∏ÂÖ• -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <label for="sequencing-items-textarea" class="block text-gray-700 text-sm font-bold mb-2">üìù ÊéíÂ∫èÈ†ÖÁõÆÔºàÊØèË°å‰∏ÄÂÄãÔºåÊåâÊ≠£Á¢∫È†ÜÂ∫èËº∏ÂÖ•Ôºâ</label>
                    <textarea id="sequencing-items-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="‰æãÂ¶ÇÔºö
ÊâìÈñãÊ™îÊ°à
Á∑®ËºØÂÖßÂÆπ
ÂÑ≤Â≠òÊ™îÊ°à
ÈóúÈñâÊ™îÊ°à"></textarea>
                    <p class="text-gray-600 text-xs mt-1">üí° ÊèêÁ§∫ÔºöË´ã‰æùÁÖßÊ≠£Á¢∫È†ÜÂ∫èËº∏ÂÖ•È†ÖÁõÆÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÊâì‰∫ÇÁµ¶Â≠∏Áîü‰ΩúÁ≠î</p>
                </div>

                <!-- Âè≥Ê¨ÑÔºöAIÊô∫ËÉΩÂá∫È°å -->
                <div class="bg-purple-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 mb-3">ü§ñ AI Êô∫ËÉΩÂá∫È°å</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Âá∫È°å‰∏ªÈ°åÊàñË¶ÅÊ±ÇÔºö</label>
                            <textarea id="ai-seq-topic-textarea" rows="2" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‰æãÂ¶ÇÔºöË´ãÁîüÊàêÂÖâÂêà‰ΩúÁî®ÁöÑÊ≠•È©üÊéíÂ∫è"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">È†ÖÁõÆÊï∏Èáè (3-10):</label>
                            <input type="number" id="ai-seq-count-input" min="3" max="10" value="5" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="text-center">
                            <button id="ai-generate-seq-btn" class="btn btn-purple w-full text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i id="ai-seq-btn-icon" class="fas fa-magic mr-2"></i>
                                <span id="ai-seq-btn-text">AI ÈñãÂßãÂá∫È°å</span>
                            </button>
                        </div>
                        <div id="ai-seq-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            <span>AI ÊÄùËÄÉ‰∏≠ÔºåË´ãÁ®çÂÄô...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰∏ãÊñπÔºöÈ°åÂ∫´ÁÆ°ÁêÜÂçÄÂ°äÔºàÂÖ®ÂØ¨Ôºâ -->
            <div class="w-full bg-blue-50 p-4 rounded-lg border">
                <h5 class="text-lg font-bold text-gray-800 mb-3">üìö È°åÂ∫´ÁÆ°ÁêÜ</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">ÂæûÊ™îÊ°àËºâÂÖ•È°åÂ∫´</label>
                        <input type="file" id="seq-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="load-seq-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">ËºâÂÖ•È°åÂ∫´</button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">ÂÑ≤Â≠òÁõÆÂâçÈ°åÁõÆÁÇ∫È°åÂ∫´</label>
                        <input type="text" id="seq-bank-name-input" placeholder="Ëº∏ÂÖ•È°åÂ∫´ÂêçÁ®±" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="save-seq-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">ÂÑ≤Â≠òÈ°åÂ∫´</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Â∑≤ÂÑ≤Â≠òÁöÑÈ°åÂ∫´</label>
                    <div id="seq-bank-list" class="space-y-2 max-h-20 overflow-y-auto border rounded-md p-2 bg-white">
                        <div class="text-gray-500 text-sm italic text-center">ÁõÆÂâçÊ≤íÊúâÂÑ≤Â≠òÁöÑÈ°åÂ∫´</div>
                    </div>
                </div>
            </div>

                <div class="settings-button-group mt-4">
                    <button id="start-sequencing-interaction-btn" class="btn bg-cyan-500 hover:bg-cyan-600">Á¢∫Ë™ç‰∏¶ÈñãÂßã‰∫íÂãï üöÄ</button>
                    <button id="cancel-sequencing-settings-btn" class="btn btn-gray">ÂèñÊ∂à ‚Ü©Ô∏è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÖçÂ∞çÈ°åË®≠ÂÆöÊ®°ÊÖãÊ°Ü -->
    <div id="matching-settings-modal" class="magnified-image-modal hidden">
        <div id="matching-settings-modal-content" class="magnified-image-modal-content">
            <button id="matching-settings-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <div class="w-full">
                <!-- È°åÂûãÂàáÊèõÊåâÈàï -->
                <div class="flex justify-center mb-4 gap-2">
                    <button id="switch-to-sequencing-btn" class="btn bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-2 text-sm">
                        üìã ÂàáÊèõÂà∞ÊéíÂ∫èÈ°å
                    </button>
                </div>
                <h4 class="text-2xl font-bold mb-4 text-gray-800">ÈÖçÂ∞çÈ°åË®≠ÂÆö</h4>

                <!-- ‰∏äÊñπÔºöÂ∑¶Âè≥ÂÖ©Ê¨ÑÂ∏ÉÂ±Ä -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- Â∑¶Ê¨ÑÔºöÈ°åÁõÆËº∏ÂÖ• -->
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <label for="matching-pairs-textarea" class="block text-gray-700 text-sm font-bold mb-2">üìù ÈÖçÂ∞çÈ†ÖÁõÆÔºàÊØèË°å‰∏ÄÂ∞çÔºåÁî®ÈÄóËôüÊàñTabÂàÜÈöîÔºâ</label>
                    <textarea id="matching-pairs-textarea" rows="6" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="‰æãÂ¶ÇÔºö
Âè∞Âåó,Âè∞ÁÅ£È¶ñÈÉΩ
Êù±‰∫¨,Êó•Êú¨È¶ñÈÉΩ
È¶ñÁàæ,ÈüìÂúãÈ¶ñÈÉΩ
Âåó‰∫¨,‰∏≠ÂúãÈ¶ñÈÉΩ"></textarea>
                    <p class="text-gray-600 text-xs mt-1">üí° ÊèêÁ§∫ÔºöÊØèË°å‰∏ÄÂ∞çÈÖçÂ∞çÈ†ÖÁõÆÔºåÁî®ÈÄóËôüÔºà,ÔºâÊàñTabÈçµÂàÜÈöîÂ∑¶Âè≥ÂÖ©ÂÅ¥</p>
                </div>

                <!-- Âè≥Ê¨ÑÔºöAIÊô∫ËÉΩÂá∫È°å -->
                <div class="bg-purple-50 p-4 rounded-lg border">
                    <h5 class="text-lg font-bold text-gray-800 mb-3">ü§ñ AI Êô∫ËÉΩÂá∫È°å</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Âá∫È°å‰∏ªÈ°åÊàñË¶ÅÊ±ÇÔºö</label>
                            <textarea id="ai-match-topic-textarea" rows="2" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‰æãÂ¶ÇÔºöÂúãÂÆ∂ËàáÈ¶ñÈÉΩÁöÑÈÖçÂ∞ç"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">ÈÖçÂ∞çÊï∏Èáè (3-10):</label>
                            <input type="number" id="ai-match-count-input" min="3" max="10" value="5" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="text-center">
                            <button id="ai-generate-match-btn" class="btn btn-purple w-full text-base h-11 px-4 py-2 flex items-center justify-center">
                                <i id="ai-match-btn-icon" class="fas fa-magic mr-2"></i>
                                <span id="ai-match-btn-text">AI ÈñãÂßãÂá∫È°å</span>
                            </button>
                        </div>
                        <div id="ai-match-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            <span>AI ÊÄùËÄÉ‰∏≠ÔºåË´ãÁ®çÂÄô...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰∏ãÊñπÔºöÈ°åÂ∫´ÁÆ°ÁêÜÂçÄÂ°äÔºàÂÖ®ÂØ¨Ôºâ -->
            <div class="w-full bg-blue-50 p-4 rounded-lg border">
                <h5 class="text-lg font-bold text-gray-800 mb-3">üìö È°åÂ∫´ÁÆ°ÁêÜ</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">ÂæûÊ™îÊ°àËºâÂÖ•È°åÂ∫´</label>
                        <input type="file" id="match-bank-file-input" accept=".txt" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="load-match-bank-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1">ËºâÂÖ•È°åÂ∫´</button>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="block text-gray-700 text-sm font-bold">ÂÑ≤Â≠òÁõÆÂâçÈ°åÁõÆÁÇ∫È°åÂ∫´</label>
                        <input type="text" id="match-bank-name-input" placeholder="Ëº∏ÂÖ•È°åÂ∫´ÂêçÁ®±" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="save-match-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1">ÂÑ≤Â≠òÈ°åÂ∫´</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Â∑≤ÂÑ≤Â≠òÁöÑÈ°åÂ∫´</label>
                    <div id="match-bank-list" class="space-y-2 max-h-20 overflow-y-auto border rounded-md p-2 bg-white">
                        <div class="text-gray-500 text-sm italic text-center">ÁõÆÂâçÊ≤íÊúâÂÑ≤Â≠òÁöÑÈ°åÂ∫´</div>
                    </div>
                </div>
            </div>

                <div class="settings-button-group mt-4">
                    <button id="start-matching-interaction-btn" class="btn bg-pink-500 hover:bg-pink-600">Á¢∫Ë™ç‰∏¶ÈñãÂßã‰∫íÂãï üöÄ</button>
                    <button id="cancel-matching-settings-btn" class="btn btn-gray">ÂèñÊ∂à ‚Ü©Ô∏è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊïôÂ∏´ÂØÜÁ¢ºÈ©óË≠âÊ®°ÊÖãÊ°Ü -->
    <div id="teacher-password-modal" class="magnified-image-modal hidden">
        <div id="teacher-password-modal-content" class="magnified-image-modal-content">
            <button id="teacher-password-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">ÊïôÂ∏´ÁôªÂÖ•È©óË≠â</h4>
            <div class="w-full space-y-4">
                <input type="password" id="teacher-password-input" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex justify-center gap-4">
                    <button id="teacher-password-submit-btn" class="btn btn-primary px-8">Á¢∫Ë™ç</button>
                    <button id="teacher-password-cancel-btn" class="btn btn-gray px-8">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Èñ±ËÆÄÊ∏¨È©óË®≠ÂÆöÊ®°ÊÖãÊ°Ü -->
    <div id="reading-comprehension-settings-modal" class="magnified-image-modal hidden">
        <div id="reading-comprehension-settings-modal-content" class="magnified-image-modal-content" style="max-width: 900px;">
            <button id="reading-comprehension-settings-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800">Èñ±ËÆÄÊ∏¨È©óË®≠ÂÆö</h4>
            <div class="w-full space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- üì± ÊâãÊ©üÁ´ØÊúÄ‰∏äÈù¢/ÈõªËÖ¶Á´ØÂ∑¶ÂÅ¥ÔºöAIÁîüÊàêËàáÈ°åÂ∫´ÁÆ°ÁêÜ -->
                    <div class="flex flex-col space-y-4 order-first md:order-first">
                        <!-- AI ÁîüÊàêÂçÄÂ°ä -->
                        <div class="bg-purple-50 p-4 rounded-lg border flex-1">
                            <h5 class="text-lg font-bold text-gray-800 text-center mb-4">ü§ñ PIRLS AI Âá∫È°å</h5>
                            <div class="space-y-3">
                                <div>
                                    <label for="ai-reading-topic-textarea" class="block text-gray-700 text-sm font-bold mb-2">Âá∫È°åË¶ÅÊ±ÇÔºö</label>
                                    <textarea id="ai-reading-topic-textarea" rows="3" class="w-full p-2 border rounded-md text-base focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="‰æãÂ¶ÇÔºö
- Ê†πÊìöÂ∑¶ÊñπÊñáÊú¨ÁîüÊàê PIRLS Èñ±ËÆÄÁêÜËß£È°å
- ÊàñÁõ¥Êé•ÊèèËø∞‰∏ªÈ°åÔºåAI ÊúÉÁîüÊàêÊñáÊú¨+È°åÁõÆ"></textarea>
                                </div>
                                <div class="text-sm text-gray-600 bg-white p-2 rounded border">
                                    <p class="font-bold mb-1">PIRLS ÂõõÂ±§Ê¨°ÈÖçÁΩÆÔºö</p>
                                    <ul class="list-disc list-inside text-xs space-y-1">
                                        <li>Â±§Ê¨°1 (Áõ¥Êé•ÊèêÂèñ)Ôºö3È°å</li>
                                        <li>Â±§Ê¨°2 (Áõ¥Êé•Êé®Ë´ñ)Ôºö3È°å</li>
                                        <li>Â±§Ê¨°3 (Ë©ÆÈáãÊï¥Âêà)Ôºö2È°å</li>
                                        <li>Â±§Ê¨°4 (ÊØîËºÉË©ï‰º∞)Ôºö2È°å</li>
                                    </ul>
                                </div>
                                <button id="ai-generate-reading-btn" class="btn btn-purple !w-full text-base h-11 px-4 py-2 flex items-center justify-center">
                                    <i id="ai-reading-btn-icon" class="fas fa-magic mr-2"></i>
                                    <span id="ai-reading-btn-text">AI ÈñãÂßãÂá∫È°å</span>
                                </button>
                                <div id="ai-reading-loading-spinner" class="hidden flex items-center justify-center text-purple-600 pt-2">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    <span>AI ÊÄùËÄÉ‰∏≠ÔºåË´ãÁ®çÂÄô...</span>
                                </div>
                            </div>
                        </div>

                        <!-- È°åÂ∫´ÁÆ°ÁêÜÂçÄÂ°ä -->
                        <div class="bg-blue-50 p-4 rounded-lg border">
                            <h5 class="text-lg font-bold text-gray-800 text-center mb-4">üìö È°åÂ∫´ÁÆ°ÁêÜ</h5>
                            <div class="space-y-3">
                                <!-- ËºâÂÖ•È°åÂ∫´ -->
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">ÂæûÊ™îÊ°àËºâÂÖ•È°åÂ∫´</label>
                                    <div class="space-y-2">
                                        <div>
                                            <label class="block text-gray-600 text-xs mb-1">‰∏äÂÇ≥ÊñáÊú¨ (.txt)</label>
                                            <input type="file" id="reading-text-file-input" accept=".txt" class="w-full p-1 border rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-gray-600 text-xs mb-1">‰∏äÂÇ≥È°åÁõÆ (.txt)</label>
                                            <input type="file" id="reading-questions-file-input" accept=".txt" class="w-full p-1 border rounded-md text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                        <button id="load-reading-files-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm h-8 px-3 py-1 w-full">ËºâÂÖ•Ê™îÊ°à</button>
                                    </div>
                                </div>

                                <!-- ÂÑ≤Â≠òÈ°åÂ∫´ -->
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">ÂÑ≤Â≠òÁõÆÂâçÈ°åÁõÆÁÇ∫È°åÂ∫´</label>
                                    <input type="text" id="reading-question-bank-name-input" placeholder="Ëº∏ÂÖ•È°åÂ∫´ÂêçÁ®±" class="w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                                    <button id="save-reading-question-bank-btn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm h-8 px-3 py-1 w-full">ÂÑ≤Â≠òÈ°åÂ∫´</button>
                                </div>

                                <!-- È°åÂ∫´ÂàóË°® -->
                                <div>
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="block text-gray-700 text-sm font-bold">Â∑≤ÂÑ≤Â≠òÁöÑÈ°åÂ∫´</label>
                                        <button onclick="importReadingBankFromFile()" class="text-green-600 hover:text-green-700 text-xs" title="ÂåØÂÖ•È°åÂ∫´">
                                            <i class="fas fa-upload mr-1"></i>ÂåØÂÖ•
                                        </button>
                                    </div>
                                    <div id="reading-question-bank-list" class="space-y-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-white">
                                        <div class="text-gray-500 text-sm italic text-center">ÁõÆÂâçÊ≤íÊúâÂÑ≤Â≠òÁöÑÈ°åÂ∫´</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üì± ÊâãÊ©üÁ´ØÁ¨¨‰∫å/ÈõªËÖ¶Á´ØÂè≥ÂÅ¥ÔºöÊñáÊú¨ËàáÈ°åÁõÆËº∏ÂÖ• -->
                    <div class="flex flex-col space-y-4 order-last md:order-last">
                        <!-- ÊñáÊú¨Ëº∏ÂÖ•Ê°Ü -->
                        <div>
                            <label for="reading-text-textarea" class="block text-gray-700 text-sm font-bold mb-2">
                                Èñ±ËÆÄÊñáÊú¨Ôºö
                            </label>
                            <textarea id="reading-text-textarea" rows="8" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ë´ãËº∏ÂÖ•Èñ±ËÆÄÊñáÊú¨ÂÖßÂÆπ..."></textarea>
                        </div>

                        <!-- È°åÁõÆËº∏ÂÖ•Ê°Ü -->
                        <div>
                            <label for="reading-questions-textarea" class="block text-gray-700 text-sm font-bold mb-2">
                                È°åÁõÆË®≠ÂÆöÔºö
                            </label>
                            <p class="text-gray-600 text-xs mb-2">Ê†ºÂºè: È°åÁõÆ,Ê≠£Á¢∫Á≠îÊ°à(1-4ÊàñA-D),ÈÅ∏È†Ö1,ÈÅ∏È†Ö2,ÈÅ∏È†Ö3,ÈÅ∏È†Ö4<span class="text-gray-500">,[Â±§Ê¨°(1-4)ÈÅ∏Â°´]</span><br>
                            <span class="text-gray-500">ÊîØÊè¥ÈÄóËôü(,)ÊàñTabÂàÜÈöîÔºåÊØèË°å‰∏ÄÈ°å</span></p>
                            <textarea id="reading-questions-textarea" rows="8" class="w-full p-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="‰æãÂ¶ÇÔºö
‰∏ªËßíÁöÑÂêçÂ≠óÊòØ‰ªÄÈ∫º?,2,Â∞èÊòé,Â∞èËèØ,Â∞èÁæé,Â∞èÂº∑,1
Êú¨ÊñáÁöÑ‰∏ªÊó®ÊòØ?,A,ÂèãË™ºÁöÑÈáçË¶Å,Á´∂Áà≠ÁöÑÊÑèÁæ©,Â≠∏ÁøíÁöÑÂÉπÂÄº,ÂÆ∂Â∫≠ÁöÑÊ∫´Êöñ
ÊïÖ‰∫ãÁôºÁîüÁöÑÂú∞ÈªûÂú®Âì™Ë£°?,3,Â≠∏Ê†°,ÂÖ¨Âúí,ÂúñÊõ∏È§®,ÂÆ∂Ë£°"></textarea>
                            <p id="reading-questions-status" class="text-red-500 text-sm mt-2 hidden">Ê†ºÂºèÈåØË™§ÊàñÈ°åÁõÆÁÇ∫Á©∫ÔºåË´ãÊ™¢Êü•Ëº∏ÂÖ•„ÄÇ</p>
                        </div>
                    </div>

                </div>
            </div>
            <div class="settings-button-group mt-6 w-full">
                <button id="start-reading-interaction-btn" class="btn btn-primary">Á¢∫Ë™ç‰∏¶ÈñãÂßã‰∫íÂãï üöÄ</button>
                <button id="cancel-reading-settings-btn" class="btn btn-gray">ÂèñÊ∂à ‚Ü©Ô∏è</button>
            </div>
        </div>
    </div>

    <!-- Âø´ÈÄüÊäïÁ•®Ë®≠ÂÆöÊ®°ÊÖãÊ°Ü -->
    <div id="quick-poll-settings-modal" class="magnified-image-modal hidden">
        <div id="quick-poll-settings-modal-content" class="magnified-image-modal-content w-11/12 sm:w-96 md:w-full" style="max-width: 650px;">
            <button id="quick-poll-settings-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            
            <!-- Ê®ôÈ°åÂçÄÂüü -->
            <div class="w-full mb-3 sm:mb-5">
                <h4 class="text-lg sm:text-2xl md:text-3xl font-bold text-center text-gray-800">‚ö° Âø´ÈÄüÊäïÁ•®Ë®≠ÂÆö</h4>
                <p class="text-xs sm:text-sm text-gray-500 text-center mt-1 sm:mt-2">ÈÅ∏ÊìáÊäïÁ•®È°ûÂûã‰∏¶ÈñãÂßãÊî∂ÈõÜÂ≠∏ÁîüÊÑèË¶ã</p>
            </div>
            
            <div class="w-full space-y-3 sm:space-y-4">
                <!-- ÊäïÁ•®È°ûÂûãÈÅ∏Êìá - Âç°ÁâáÂºèË®≠Ë®à -->
                <div>
                    <label class="block text-gray-700 text-xs sm:text-base font-bold mb-2 sm:mb-3 flex items-center gap-2">
                        <i class="fas fa-list-check text-lime-600"></i> <span>ÊäïÁ•®È°ûÂûãÔºö</span>
                    </label>
                    <div class="space-y-1.5 sm:space-y-2">
                        <!-- ÂøÉÊÉÖÁ¨¶Ëôü -->
                        <label class="flex items-start gap-2 sm:gap-3 p-2.5 sm:p-4 border-2 border-gray-200 rounded cursor-pointer hover:bg-lime-50 hover:border-lime-400 transition-all">
                            <input type="radio" name="pollType" value="emoji" class="form-radio text-lime-600 h-5 w-5 mt-0.5 flex-shrink-0" checked>
                            <div class="flex-1 min-w-0">
                                <span class="block text-gray-700 font-semibold text-xs sm:text-base">üòä ÂøÉÊÉÖÁ¨¶Ëôü</span>
                                <span class="block text-gray-500 text-xs">ÈñãÂøÉ üòä / ÊôÆÈÄö üòê / Èõ£ÈÅé üòï</span>
                            </div>
                        </label>
                        
                        <!-- Á∞°ÂñÆÈÅ∏Êìá -->
                        <label class="flex items-start gap-2 sm:gap-3 p-2.5 sm:p-4 border-2 border-gray-200 rounded cursor-pointer hover:bg-lime-50 hover:border-lime-400 transition-all">
                            <input type="radio" name="pollType" value="simple" class="form-radio text-lime-600 h-5 w-5 mt-0.5 flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <span class="block text-gray-700 font-semibold text-xs sm:text-base">‚úã Á∞°ÂñÆÈÅ∏È†Ö</span>
                                <span class="block text-gray-500 text-xs">ÂêåÊÑè / ‰∏çÂêåÊÑè / ‰∏çÁ¢∫ÂÆö</span>
                            </div>
                        </label>
                        
                        <!-- 1-5 ÂàÜ -->
                        <label class="flex items-start gap-2 sm:gap-3 p-2.5 sm:p-4 border-2 border-gray-200 rounded cursor-pointer hover:bg-lime-50 hover:border-lime-400 transition-all">
                            <input type="radio" name="pollType" value="rating5" class="form-radio text-lime-600 h-5 w-5 mt-0.5 flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <span class="block text-gray-700 font-semibold text-xs sm:text-base">‚≠ê Êï∏Â≠óÁ≠âÁ¥ö (1-5)</span>
                                <span class="block text-gray-500 text-xs">1 ÂàÜÔΩû5 ÂàÜË©ïÂàÜ</span>
                            </div>
                        </label>
                        
                        <!-- 1-10 ÂàÜ -->
                        <label class="flex items-start gap-2 sm:gap-3 p-2.5 sm:p-4 border-2 border-gray-200 rounded cursor-pointer hover:bg-lime-50 hover:border-lime-400 transition-all">
                            <input type="radio" name="pollType" value="rating10" class="form-radio text-lime-600 h-5 w-5 mt-0.5 flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <span class="block text-gray-700 font-semibold text-xs sm:text-base">üéØ Êï∏Â≠óÁ≠âÁ¥ö (1-10)</span>
                                <span class="block text-gray-500 text-xs">1 ÂàÜÔΩû10 ÂàÜË©ïÂàÜ</span>
                            </div>
                        </label>
                        
                        <!-- Ëá™Ë®ÇÈÅ∏È†Ö -->
                        <label class="flex items-start gap-2 sm:gap-3 p-2.5 sm:p-4 border-2 border-gray-200 rounded cursor-pointer hover:bg-lime-50 hover:border-lime-400 transition-all">
                            <input type="radio" name="pollType" value="custom" class="form-radio text-lime-600 h-5 w-5 mt-0.5 flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <span class="block text-gray-700 font-semibold text-xs sm:text-base">üìù Ëá™Ë®ÇÈÅ∏È†Ö</span>
                                <span class="block text-gray-500 text-xs">Ëá™Ë°åË®≠ÂÆöÊäïÁ•®ÈÅ∏È†Ö</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Ëá™Ë®ÇÈÅ∏È†ÖËº∏ÂÖ•ÂçÄ -->
                <div id="custom-poll-options-section" class="hidden bg-blue-50 p-2.5 sm:p-4 rounded border-2 border-blue-200">
                    <label for="custom-poll-options-input" class="block text-gray-700 text-xs sm:text-sm font-bold mb-2 flex items-center gap-2">
                        <i class="fas fa-keyboard text-blue-600"></i> <span>Ëá™Ë®ÇÈÅ∏È†ÖÔºàÊØèË°å‰∏ÄÂÄãÔºâÔºö</span>
                    </label>
                    <textarea id="custom-poll-options-input" rows="3" class="w-full px-2.5 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded text-xs sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‰æãÂ¶ÇÔºö&#10;ÈÅ∏È†Ö A&#10;ÈÅ∏È†Ö B&#10;ÈÅ∏È†Ö C"></textarea>
                </div>

                <!-- ÂåøÂêçË®≠ÂÆö -->
                <div class="bg-amber-50 p-2.5 sm:p-4 rounded border-2 border-amber-200">
                    <label class="flex items-center gap-2 sm:gap-3 cursor-pointer">
                        <input type="checkbox" id="quick-poll-anonymous-checkbox" checked class="form-checkbox h-5 w-5 text-lime-600 rounded flex-shrink-0">
                        <span class="text-gray-700 font-semibold text-xs sm:text-base flex items-center gap-1">
                            <i class="fas fa-mask text-amber-600 flex-shrink-0"></i> <span>ÂåøÂêçÊäïÁ•®</span>
                            <span class="text-gray-500 font-normal text-xs">Ôºà‰∏çË®òÈåÑÂßìÂêçÔºâ</span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- ÊåâÈàïÂçÄÂüü -->
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 mt-4 sm:mt-6 w-full">
                <button id="start-quick-poll-btn" class="btn bg-lime-500 hover:bg-lime-600 text-white font-bold flex-1 h-10 sm:h-12 text-sm sm:text-lg rounded transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-1.5 sm:gap-2">
                    <i class="fas fa-play text-sm sm:text-base"></i> <span>ÈñãÂßãÊäïÁ•® üöÄ</span>
                </button>
                <button id="cancel-quick-poll-settings-btn" class="btn bg-gray-400 hover:bg-gray-500 text-white font-bold flex-1 h-10 sm:h-12 text-sm sm:text-lg rounded transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-1.5 sm:gap-2">
                    <i class="fas fa-times text-sm sm:text-base"></i> <span>ÂèñÊ∂à ‚Ü©Ô∏è</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Âø´ÈÄüÊäïÁ•®Áµ±Ë®àÊ®°ÊÖãÊ°Ü -->
    <div id="quick-poll-stats-modal" class="magnified-image-modal hidden">
        <div id="quick-poll-stats-modal-content" class="magnified-image-modal-content" style="max-width: 900px; max-height: 90vh;">
            <button id="quick-poll-stats-modal-close-btn" class="magnified-image-modal-close">√ó</button>
            <h4 class="text-2xl font-bold mb-4 text-gray-800 text-center">ÊäïÁ•®Áµ±Ë®àÁµêÊûú</h4>
            <p id="quick-poll-stats-question" class="text-lg text-gray-700 mb-4 text-center font-medium"></p>

            <!-- ‰∏äÊñπÂçÄÂ°äÔºöÂ∑¶Âè≥ÂÖ©Ê¨ÑÂ∏ÉÂ±Ä -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <!-- Â∑¶Ê¨ÑÔºöÂúñË°®È°ûÂûãÂàáÊèõÂíåÁµ±Ë®àË≥áË®ä -->
                <div>
                    <!-- ÂúñË°®È°ûÂûãÂàáÊèõ -->
                    <div class="flex justify-center gap-4 mb-4">
                        <button id="chart-type-bar-btn" class="btn bg-blue-500 hover:bg-blue-600 !w-auto text-sm h-10 px-4">Èï∑Ê¢ùÂúñ</button>
                        <button id="chart-type-pie-btn" class="btn btn-gray !w-auto text-sm h-10 px-4">ÂúìÈ§ÖÂúñ</button>
                    </div>

                    <!-- ÊäïÁ•®Áµ±Ë®àË≥áË®ä -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <p class="text-gray-600 text-sm">Á∏ΩÊäïÁ•®Êï∏</p>
                                <p id="poll-total-votes" class="text-3xl font-bold text-lime-600">0</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">Âú®Á∑öÂ≠∏ÁîüÊï∏</p>
                                <p id="poll-online-students" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Âè≥Ê¨ÑÔºöË©≥Á¥∞Êï∏ÊìöË°®Ê†º -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border px-4 py-2 text-left">ÈÅ∏È†Ö</th>
                                <th class="border px-4 py-2 text-right">Á•®Êï∏</th>
                                <th class="border px-4 py-2 text-right">ÁôæÂàÜÊØî</th>
                            </tr>
                        </thead>
                        <tbody id="quick-poll-stats-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- D3.js ÂúñË°®ÂÆπÂô® -->
            <div class="bg-white border rounded-lg p-4 overflow-x-auto" style="min-height: 500px;">
                <svg id="quick-poll-chart-svg" width="800" height="450"></svg>
            </div>

            <div class="flex justify-center gap-4 mt-6">
                <button id="download-poll-results-btn" class="btn btn-green !w-auto text-base h-11 px-6">
                    <i class="fas fa-download mr-2"></i>‰∏ãËºâÁµêÊûú (CSV)
                </button>
                <button id="end-quick-poll-btn" class="btn btn-red !w-auto text-base h-11 px-6">
                    <i class="fas fa-stop mr-2"></i>ÁµêÊùüÊäïÁ•®
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Ë®≠ÂÆöÊ™î -->
    <script>
        // Firebase configuration for the classroom interaction app
        // Ëã•Ë¶Å‰ΩøÁî®Ëá™Â∑±ÁöÑ Firebase Ë≥áÊñôÂ∫´ÔºåË´ã‰øÆÊîπ‰ª•‰∏ãÈÖçÁΩÆ
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyAfUqiWJ_XjLl5Iq7is0WUA-1JQjfa9roI",
            authDomain: "project-7687936977482579527.firebaseapp.com",
            projectId: "project-7687936977482579527",
            storageBucket: "project-7687936977482579527.firebasestorage.app",
            messagingSenderId: "824411810210",
            appId: "1:824411810210:web:605ed18e63716f98a3aafb"
        });
    </script>

    <script type="module">
        // Import Firebase SDK functions.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Added signOut
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc, getDocs, updateDoc, writeBatch, deleteField, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        // Max dimension (px) for user uploaded images to prevent excessively large files.
        const MAX_IMAGE_DIMENSION = 1024; 
        // JPEG compression quality (0.0 to 1.0).
        const JPEG_QUALITY = 0.8; 

        // Firebase configuration.
        const firebaseConfig = JSON.parse(__firebase_config);

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); 
        const db = getFirestore(app);

        // Use __app_id for the base Firestore path.
        const baseAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-classroom-app';
        let userId = null;
        let studentName = null;
        let currentRole = null; // 'teacher' or 'student'
        let classroomCode = null; // NEW: Stores the teacher-defined or student-entered classroom code.
        let currentInteractionMode = null; // To track the active mode for statistics.
        let allStudentResponses = []; // Global variable to store all student responses for charting and lottery.
        let activeStudentNames = []; // NEW: Global variable to store names of all currently active students.
        let pendingKickStudents = new Set(); // üöÄ NEW: Ê≠£Âú®Ë¢´Ë∏¢Âá∫ÁöÑÂ≠∏ÁîüÔºåÈò≤Ê≠¢ presence listener ÈáçÊñ∞Ê∑ªÂä†
        let activeStudentsPresenceMap = new Map(); // üöÄ NEW: Â≠òÂÑ≤ÊâÄÊúâÂú®Á∑öÂ≠∏ÁîüÁöÑÂÆåÊï¥ presence Êï∏ÊìöÔºàÂåÖÂê´ÂàÜÂøÉÁãÄÊÖãÔºâ
        let lastSelectedStudentCard = null; // To track the previously selected card for the lottery feature.
        let isResponsePaused = false; // NEW: Global state for response pause.
        let lastSelectedModalStudent = null; // NEW: To track the previously selected student in the modal for lottery.

        let interactionModeUnsubscribe = null;
        let questionBanks = []; // Question Bank storage in memory (will be cleared when class ends)
        let sequencingQuestionBanks = []; // Sequencing Question Bank storage
        let matchingQuestionBanks = []; // Matching Question Bank storage
        let studentResponsesUnsubscribe = null;
        let studentChartListenerUnsubscribe = null; // üöÄ NEW: Student-side chart listener for syncing
        let classroomPresenceUnsubscribe = null; // Unsubscribe function for classroom presence listener.
        let lotteryUnsubscribe = null; // NEW: Listener for lottery results
        let quickAnswerUnsubscribe = null; // NEW: Listener for quick answer updates
        
        // üöÄ CRITICAL: Global chart manager for student-side real-time chart sync
        let studentChartManager = null;
        let currentChartMode = null;
        let currentChartResponses = [];
        
        // Student attention monitoring variables
        let studentDistractionCount = 0; // Á¥ØË®àÂàÜÂøÉÊ¨°Êï∏
        let isStudentCurrentlyDistracted = false; // Áï∂ÂâçÊòØÂê¶ÂàÜÂøÉ
        let attentionMonitoringActive = false; // Èò≤Ê≠¢ÈáçË§áË®ªÂÜäÁõ£ËÅΩÂô®
        
        // üöÄ NEW: ‰øùÂ≠ò attention ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÁöÑÂºïÁî®Ôºå‰ª•‰æøË¢´Ë∏¢Âá∫ÊôÇËÉΩÂ§†ÁßªÈô§
        let attentionVisibilityHandler = null;
        let attentionBlurHandler = null;
        let attentionFocusHandler = null;

        // Quick Poll variables
        let quickPollActive = false;
        let quickPollData = null; // Stores current poll configuration
        let quickPollVotesUnsubscribe = null; // Listener for vote updates
        let currentChartType = 'bar'; // 'bar' or 'pie'
        let quickPollOptions = []; // Stores current poll options

        // Drawing specific variables.
        const canvas = document.getElementById('drawing-canvas'); // Main canvas for student display.
        const ctx = canvas.getContext('2d'); // 2D context of the main canvas.

        let backgroundCanvas = document.createElement('canvas'); // Canvas for teacher's background image.
        let backgroundCtx = backgroundCanvas.getContext('2d');

        let studentImageCanvas = document.createElement('canvas'); 
        let studentImageCtx = studentImageCanvas.getContext('2d');
        let studentUploadedImageDataURL = null; // Stores the scaled and compressed student uploaded image Data URL.

        let drawingCanvas = document.createElement('canvas'); // Canvas for student's drawing strokes.
        let drawingCtx = drawingCanvas.getContext('2d');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        let teacherUploadedBackgroundImageDataURL = null; // Stores the scaled and compressed background image Data URL from Firestore.

        // AI Settings Global Object
        let aiSettings = {
            aiSource: 'gemini-custom', // 'gemini-default' or 'gemini-custom'
            geminiApiKey: '' // Custom API key if 'gemini-custom' is selected
        };
        
        // MODIFIED: Combined Dispatch Settings Global Object
        let dispatchSettings = {
            type: 'url', // 'url' or 'html'
            url: '',
            isYoutube: false, // Only relevant if type is 'url'
            htmlContent: null // Only relevant if type is 'html'
        };

        // New: Recording specific variables
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let audioDataURL = null;
        let audioStream = null; // To store the MediaStream object

        // NEW: Custom Multiple Choice Questions (Teacher side)
        let customMultipleChoiceQuestions = []; // Stores parsed questions from teacher input

        // NEW: Reading Comprehension Data (Teacher side)
        let readingComprehensionData = {
            text: '',
            questions: [] // Array of {question, correctAnswer, options, level}
        };

        // üöÄ NEW: Track currently displayed content in teacher's "View Questions" modal
        let lastViewedReadingContentHash = null;

        // NEW: Store student's current answers (not yet submitted) for reading comprehension
        let currentReadingAnswers = [];

        // NEW: Reading Comprehension Question Banks
        let readingQuestionBanks = [];

        // NEW: Sequencing and Matching Questions (Teacher side)
        let sequencingData = {
            question: '',
            correctOrder: [] // Array of items in correct order
        };
        let matchingData = {
            question: '',
            pairs: [] // Array of {left, right} objects
        };
        let currentMatchingSelection = {
            leftItem: null,
            rightItem: null
        };
        let currentMultipleChoiceQuestions = null; // Stores questions from Firestore for student/teacher monitor
        
        // üöÄ NEW: Student-side tracking for sequencing/matching settings to detect changes
        let lastSequencingSettings = null;
        let lastMatchingSettings = null;

        // NEW: Peer Review System Variables
        let peerReviewActive = false; // Whether peer review is currently active
        let peerReviewUnsubscribe = null; // Unsubscribe function for peer review votes listener
        let studentVotedWorks = new Set(); // Track which works this student has voted for
        let allPeerReviewVotes = {}; // Global object to store all votes data
        const MAX_VOTES_PER_STUDENT = 3; // Maximum votes per student per interaction
        
        // Canvas content preservation
        let savedCanvasState = null; // Save student's drawing when switching to peer review
        

        // ============================================================================
        // üöÄ OPTIMIZATION MODULE - Core Utilities
        // ============================================================================

        /**
         * Â∑•ÂÖ∑ÂáΩÂºèÊ®°ÁµÑ - Utility Functions Module
         * Êèê‰æõÈÄöÁî®ÁöÑËºîÂä©ÂáΩÂºèÔºåÂåÖÊã¨ÁØÄÊµÅ„ÄÅÈò≤Êäñ„ÄÅÂúñÁâáÂ£ìÁ∏ÆÁ≠â
         */
        const Utils = (function() {
            /**
             * ÁØÄÊµÅÂáΩÂºè - ÈôêÂà∂ÂáΩÂºèÂü∑Ë°åÈ†ªÁéá
             * @param {Function} func - Ë¶ÅÁØÄÊµÅÁöÑÂáΩÂºè
             * @param {number} delay - Âª∂ÈÅ≤ÊôÇÈñìÔºàÊØ´ÁßíÔºâ
             * @returns {Function} ÁØÄÊµÅÂæåÁöÑÂáΩÂºè
             */
            function throttle(func, delay = 16) {
                let lastCall = 0;
                let timeoutId = null;
                
                return function throttled(...args) {
                    const now = Date.now();
                    const timeSinceLastCall = now - lastCall;
                    
                    if (timeSinceLastCall >= delay) {
                        lastCall = now;
                        func.apply(this, args);
                    } else {
                        if (timeoutId) clearTimeout(timeoutId);
                        timeoutId = setTimeout(() => {
                            lastCall = Date.now();
                            func.apply(this, args);
                        }, delay - timeSinceLastCall);
                    }
                };
            }

            /**
             * Èò≤ÊäñÂáΩÂºè - Âª∂ÈÅ≤Âü∑Ë°åÔºåÂú®ÂÅúÊ≠¢Ëß∏ÁôºÂæåÊâçÂü∑Ë°å
             * @param {Function} func - Ë¶ÅÈò≤ÊäñÁöÑÂáΩÂºè
             * @param {number} delay - Âª∂ÈÅ≤ÊôÇÈñìÔºàÊØ´ÁßíÔºâ
             * @returns {Function} Èò≤ÊäñÂæåÁöÑÂáΩÂºè
             */
            function debounce(func, delay = 300) {
                let timeoutId = null;
                
                return function debounced(...args) {
                    if (timeoutId) clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            }

            /**
             * Â£ìÁ∏Æ‰∏¶Ë™øÊï¥ÂúñÁâáÂ§ßÂ∞è
             * @param {string} dataURL - ÂúñÁâáÁöÑ Data URL
             * @param {number} maxWidth - ÊúÄÂ§ßÂØ¨Â∫¶
             * @param {number} maxHeight - ÊúÄÂ§ßÈ´òÂ∫¶
             * @param {number} quality - Â£ìÁ∏ÆÂìÅË≥™ (0-1)
             * @returns {Promise<string>} Â£ìÁ∏ÆÂæåÁöÑ Data URL
             */
            function compressImage(dataURL, maxWidth = 1024, maxHeight = 1024, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        
                        // Ë®àÁÆóÁ∏ÆÊîæÊØî‰æã
                        if (width > maxWidth || height > maxHeight) {
                            const widthRatio = maxWidth / width;
                            const heightRatio = maxHeight / height;
                            const ratio = Math.min(widthRatio, heightRatio);
                            
                            width = Math.floor(width * ratio);
                            height = Math.floor(height * ratio);
                        }
                        
                        // ÂâµÂª∫ canvas ÈÄ≤Ë°åÂ£ìÁ∏Æ
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ËΩâÊèõÁÇ∫ JPEG Ê†ºÂºè‰ª•Áç≤ÂæóÊõ¥Â•ΩÁöÑÂ£ìÁ∏Æ
                        const compressed = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressed);
                    };
                    
                    img.onerror = () => reject(new Error('ÂúñÁâáËºâÂÖ•Â§±Êïó'));
                    img.src = dataURL;
                });
            }

            /**
             * Ê∑±Êã∑Ë≤ùÁâ©‰ª∂
             * @param {any} obj - Ë¶ÅÊã∑Ë≤ùÁöÑÁâ©‰ª∂
             * @returns {any} Êã∑Ë≤ùÂæåÁöÑÁâ©‰ª∂
             */
            function deepClone(obj) {
                if (obj === null || typeof obj !== 'object') return obj;
                if (obj instanceof Date) return new Date(obj.getTime());
                if (obj instanceof Array) return obj.map(item => deepClone(item));
                
                const clonedObj = {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        clonedObj[key] = deepClone(obj[key]);
                    }
                }
                return clonedObj;
            }

            return {
                throttle,
                debounce,
                compressImage,
                deepClone
            };
        })();

        /**
         * Áõ£ËÅΩÂô®ÁÆ°ÁêÜÊ®°ÁµÑ - Listener Manager Module
         * Áµ±‰∏ÄÁÆ°ÁêÜÊâÄÊúâ Firebase Áõ£ËÅΩÂô®ÔºåÁ¢∫‰øùÊ≠£Á¢∫Ê∏ÖÁêÜÈÅøÂÖçË®òÊÜ∂È´îÊ¥©Êºè
         */
        const ListenerManager = (function() {
            const listeners = new Map();
            
            /**
             * Ë®ªÂÜäÁõ£ËÅΩÂô®
             * @param {string} name - Áõ£ËÅΩÂô®ÂêçÁ®±
             * @param {Function} unsubscribe - ÂèñÊ∂àË®ÇÈñ±ÂáΩÂºè
             */
            function register(name, unsubscribe) {
                // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÂêåÂêçÁõ£ËÅΩÂô®ÔºåÂÖàÊ∏ÖÁêÜ
                if (listeners.has(name)) {
                    const oldUnsubscribe = listeners.get(name);
                    if (typeof oldUnsubscribe === 'function') {
                        try {
                            oldUnsubscribe();
                        } catch (error) {
                            console.warn(`Ê∏ÖÁêÜÁõ£ËÅΩÂô® ${name} ÊôÇÁôºÁîüÈåØË™§:`, error);
                        }
                    }
                }
                listeners.set(name, unsubscribe);
            }
            
            /**
             * ÂèñÊ∂àÊåáÂÆöÁõ£ËÅΩÂô®
             * @param {string} name - Áõ£ËÅΩÂô®ÂêçÁ®±
             */
            function unregister(name) {
                if (listeners.has(name)) {
                    const unsubscribe = listeners.get(name);
                    if (typeof unsubscribe === 'function') {
                        try {
                            unsubscribe();
                        } catch (error) {
                            console.warn(`ÂèñÊ∂àÁõ£ËÅΩÂô® ${name} ÊôÇÁôºÁîüÈåØË™§:`, error);
                        }
                    }
                    listeners.delete(name);
                }
            }
            
            /**
             * Ê∏ÖÁêÜÊâÄÊúâÁõ£ËÅΩÂô®
             */
            function clearAll() {
                listeners.forEach((unsubscribe, name) => {
                    if (typeof unsubscribe === 'function') {
                        try {
                            unsubscribe();
                        } catch (error) {
                            console.warn(`Ê∏ÖÁêÜÁõ£ËÅΩÂô® ${name} ÊôÇÁôºÁîüÈåØË™§:`, error);
                        }
                    }
                });
                listeners.clear();
            }
            
            /**
             * Áç≤ÂèñÁï∂ÂâçË®ªÂÜäÁöÑÁõ£ËÅΩÂô®Êï∏Èáè
             * @returns {number} Áõ£ËÅΩÂô®Êï∏Èáè
             */
            function count() {
                return listeners.size;
            }
            
            /**
             * Ê™¢Êü•Áõ£ËÅΩÂô®ÊòØÂê¶Â≠òÂú®
             * @param {string} name - Áõ£ËÅΩÂô®ÂêçÁ®±
             * @returns {boolean} ÊòØÂê¶Â≠òÂú®
             */
            function has(name) {
                return listeners.has(name);
            }
            
            /**
             * üöÄ NEW: Áç≤ÂèñÊâÄÊúâÁõ£ËÅΩÂô®ÂêçÁ®±ÂàóË°®
             * @returns {Array} Áõ£ËÅΩÂô®ÂêçÁ®±Èô£Âàó
             */
            function getAll() {
                return Array.from(listeners.keys());
            }
            
            /**
             * üöÄ NEW: Ê™¢Ê∏¨ÂíåÊ∏ÖÁêÜÂ≠§Á´ãË®àÊôÇÂô®
             */
            function detectOrphanedTimers() {
                const activeTimers = new Set();
                // ÊéÉÊèèÊâÄÊúâÁî®Âà∞ÁöÑË®àÊôÇÂô® ID
                for (let i = 1; i < 100000; i++) {
                    // ÈÄôÊòØ‰∏ÄÂÄãÁ∞°ÂåñÁöÑÊ™¢Ê∏¨ÔºåÂØ¶ÈöõÊáâË©≤ËøΩËπ§ÊâÄÊúâ setInterval/setTimeout
                    // Áî®‰∏ÄÂÄãÂÖ®Â±ÄË®àÊôÇÂô®Ê±†‰æÜÁÆ°ÁêÜ
                }
                return activeTimers.size;
            }
            
            return {
                register,
                unregister,
                clearAll,
                count,
                has,
                getAll,
                detectOrphanedTimers
            };
        })();

        /**
         * Ëû¢ÂÖâÁ≠ÜÁÆ°ÁêÜÊ®°ÁµÑ - Highlighter Manager Module
         * ÁÆ°ÁêÜÂ≠∏ÁîüÁ´ØÂíåÊïôÂ∏´Á´ØÈñ±ËÆÄÊ∏¨È©óÁöÑËû¢ÂÖâÁ≠ÜÊ®ôË®ªÂäüËÉΩ
         */
        const HighlighterManager = (function() {
            // Â≠∏ÁîüÁ´ØÁãÄÊÖã
            let studentColor = 'yellow';
            let studentInitialized = false;
            let studentEraserMode = false; // üöÄ NEW: Ê©°ÁöÆÊì¶Ê®°ÂºèÁãÄÊÖã
            
            // ÊïôÂ∏´Á´ØÁãÄÊÖã
            let teacherColor = 'yellow';
            let teacherInitialized = false;
            let teacherEraserMode = false; // üöÄ NEW: Ê©°ÁöÆÊì¶Ê®°ÂºèÁãÄÊÖã
            
            const STUDENT_STORAGE_PREFIX = 'reading_highlights_';
            const TEACHER_STORAGE_PREFIX = 'teacher_reading_highlights_';
            
            /**
             * Áç≤ÂèñËû¢ÂÖâÁ≠ÜÂ≠òÂÑ≤ÈçµÔºàÂü∫ÊñºËßíËâ≤ÂíåÊïôÂÆ§‰ª£Á¢ºÔºâ
             */
            function getStorageKey(mode = 'student') {
                const prefix = mode === 'teacher' ? TEACHER_STORAGE_PREFIX : STUDENT_STORAGE_PREFIX;
                return prefix + (classroomCode || 'default');
            }
            
            /**
             * Ë®àÁÆóÊñáÁ´†ÂÖßÂÆπÂìàÂ∏åÔºàÁî®ÊñºÈ©óË≠âÊ®ôË®ªÊòØÂê¶ÂåπÈÖçÁï∂ÂâçÊñáÁ´†Ôºâ
             */
            function getContentHash(text) {
                if (!text) return '';
                // Á∞°ÂñÆÂìàÂ∏åÂáΩÊï∏
                let hash = 0;
                for (let i = 0; i < text.length; i++) {
                    const char = text.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return hash.toString();
            }
            
            /**
             * üöÄ NEW: Áç≤Âèñ Range Âú®Á¥îÊñáÊú¨‰∏≠ÁöÑËµ∑ÂßãÂÅèÁßªÈáè
             * @param {Range} range - DOM Range Â∞çË±°
             * @param {Element} container - ÂÆπÂô®ÂÖÉÁ¥†
             * @returns {number} Ëµ∑Âßã‰ΩçÁΩÆÂÅèÁßªÈáè
             */
            function getRangeOffset(range, container) {
                const preRange = document.createRange();
                preRange.selectNodeContents(container);
                preRange.setEnd(range.startContainer, range.startOffset);
                return preRange.toString().length;
            }
            
            /**
             * üöÄ FIXED: Ê†πÊìöÁ¥îÊñáÊú¨ÂÅèÁßªÈáèÂâµÂª∫ DOM RangeÔºà‰øÆÊ≠£ÂÅèÁßªÈáèË®àÁÆóÔºâ
             * @param {Element} container - ÂÆπÂô®ÂÖÉÁ¥†
             * @param {number} startOffset - Ëµ∑ÂßãÂÅèÁßªÈáè
             * @param {number} length - ÊñáÊú¨Èï∑Â∫¶
             * @returns {Range|null} DOM Range Â∞çË±°
             */
            function createRangeFromOffset(container, startOffset, length) {
                const range = document.createRange();
                let charCount = 0;
                let startNode = null;
                let startNodeOffset = 0;
                let endNode = null;
                let endNodeOffset = 0;
                let foundStart = false;
                
                const walker = document.createTreeWalker(
                    container,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                let node;
                while (node = walker.nextNode()) {
                    const nodeLength = node.textContent.length;
                    
                    // üöÄ FIXED: Êü•ÊâæËµ∑Âßã‰ΩçÁΩÆ
                    if (!foundStart && charCount + nodeLength > startOffset) {
                        startNode = node;
                        startNodeOffset = startOffset - charCount;
                        // üöÄ CRITICAL FIX: Á´ãÂç≥È©óË≠âËµ∑ÂßãÂÅèÁßªÈáè‰ΩøÁî®Áï∂ÂâçÁØÄÈªûÁöÑÈï∑Â∫¶
                        if (startNodeOffset > nodeLength) {
                            startNodeOffset = nodeLength;
                        }
                        if (startNodeOffset < 0) {
                            startNodeOffset = 0;
                        }
                        foundStart = true;
                    }
                    
                    // üöÄ FIXED: Êü•ÊâæÁµêÊùü‰ΩçÁΩÆ
                    if (foundStart && charCount + nodeLength >= startOffset + length) {
                        endNode = node;
                        endNodeOffset = startOffset + length - charCount;
                        // üöÄ CRITICAL FIX: È©óË≠âÁµêÊùüÂÅèÁßªÈáè‰ΩøÁî®Áï∂ÂâçÁØÄÈªûÁöÑÈï∑Â∫¶
                        if (endNodeOffset > nodeLength) {
                            endNodeOffset = nodeLength;
                        }
                        if (endNodeOffset < 0) {
                            endNodeOffset = 0;
                        }
                        break;
                    }
                    
                    charCount += nodeLength;
                }
                
                // üöÄ ÈÇäÁïåÊÉÖÊ≥ÅËôïÁêÜÔºöÂ¶ÇÊûúÁµêÊùü‰ΩçÁΩÆÂâõÂ•ΩÂú®ÊñáÊú¨Êú´Â∞æ
                if (startNode && !endNode && foundStart) {
                    endNode = node; // ‰ΩøÁî®ÊúÄÂæå‰∏ÄÂÄãÁØÄÈªû
                    endNodeOffset = node ? node.textContent.length : 0;
                }
                
                if (startNode && endNode) {
                    try {
                        range.setStart(startNode, startNodeOffset);
                        range.setEnd(endNode, endNodeOffset);
                        return range;
                    } catch (e) {
                        console.warn('[createRangeFromOffset] Failed to create range:', e, {
                            startOffset,
                            length,
                            startNodeOffset,
                            endNodeOffset,
                            startNodeText: startNode.textContent.substring(0, 20),
                            endNodeText: endNode.textContent.substring(0, 20)
                        });
                        return null;
                    }
                }
                
                console.warn('[createRangeFromOffset] Could not find nodes for range:', {
                    startOffset,
                    length,
                    foundStart,
                    totalChars: charCount
                });
                return null;
            }
            
            /**
             * ÈÄöÁî®ÂàùÂßãÂåñËû¢ÂÖâÁ≠ÜÂäüËÉΩ
             * @param {string} mode - 'student' Êàñ 'teacher'
             * @param {object} config - ÈÖçÁΩÆÂ∞çË±°
             */
            function initMode(mode, config) {
                const {
                    buttonSelector,
                    textDisplayId,
                    clearButtonId,
                    eraserButtonId,
                    colorStateRef,
                    initializedRef,
                    eraserModeRef
                } = config;
                
                if (initializedRef.value) {
                    console.log(`[Highlighter:${mode}] Already initialized`);
                    return;
                }
                
                console.log(`[Highlighter:${mode}] Initializing highlighter functionality`);
                
                // Ë®≠ÁΩÆÈ°èËâ≤ÈÅ∏ÊìáÊåâÈàï‰∫ã‰ª∂
                const colorButtons = document.querySelectorAll(buttonSelector);
                colorButtons.forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                });
                
                // ÈáçÊñ∞Áç≤ÂèñÊåâÈàï‰∏¶Á∂ÅÂÆö‰∫ã‰ª∂
                const newColorButtons = document.querySelectorAll(buttonSelector);
                newColorButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        newColorButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        colorStateRef.value = this.getAttribute('data-color');
                        // üöÄ NEW: ÈÅ∏ÊìáÈ°èËâ≤ÊôÇÈóúÈñâÊ©°ÁöÆÊì¶Ê®°Âºè
                        eraserModeRef.value = false;
                        const eraserBtn = document.getElementById(eraserButtonId);
                        if (eraserBtn) {
                            eraserBtn.classList.remove('border-2', 'border-red-500');
                            eraserBtn.classList.add('border-transparent');
                        }
                        console.log(`[Highlighter:${mode}] Color changed to:`, colorStateRef.value);
                    });
                });
                
                // Ë®≠ÁΩÆÁ¨¨‰∏ÄÂÄãÊåâÈàïÁÇ∫È†êË®≠ÈÅ∏‰∏≠
                if (newColorButtons.length > 0) {
                    newColorButtons[0].classList.add('active');
                }
                
                // üöÄ NEW: Ë®≠ÁΩÆÊ©°ÁöÆÊì¶ÊåâÈàï‰∫ã‰ª∂
                const eraserBtn = document.getElementById(eraserButtonId);
                if (eraserBtn) {
                    console.log(`[Highlighter:${mode}] üîç Found eraser button, setting up event listener`);
                    const newEraserBtn = eraserBtn.cloneNode(true);
                    eraserBtn.parentNode.replaceChild(newEraserBtn, eraserBtn);
                    newEraserBtn.addEventListener('click', function() {
                        eraserModeRef.value = !eraserModeRef.value;
                        if (eraserModeRef.value) {
                            // ÂïüÂãïÊ©°ÁöÆÊì¶Ê®°Âºè
                            newColorButtons.forEach(b => b.classList.remove('active'));
                            newEraserBtn.classList.add('border-2', 'border-red-500');
                            newEraserBtn.classList.remove('border-transparent');
                            console.log(`[Highlighter:${mode}] ‚úì Eraser mode activated`);
                        } else {
                            // ÈóúÈñâÊ©°ÁöÆÊì¶Ê®°ÂºèÔºåÂõûÂà∞Á¨¨‰∏ÄÂÄãÈ°èËâ≤ÊåâÈàï
                            if (newColorButtons.length > 0) {
                                newColorButtons[0].classList.add('active');
                            }
                            newEraserBtn.classList.remove('border-2', 'border-red-500');
                            newEraserBtn.classList.add('border-transparent');
                            console.log(`[Highlighter:${mode}] ‚úì Eraser mode deactivated`);
                        }
                    });
                    console.log(`[Highlighter:${mode}] ‚úì Eraser button initialized`);
                } else {
                    console.warn(`[Highlighter:${mode}] ‚ö†Ô∏è Eraser button NOT found - ID: ${eraserButtonId}`);
                }
                
                // Ë®≠ÁΩÆÊñáÂ≠óÈÅ∏Êìá‰∫ã‰ª∂
                const textDisplay = document.getElementById(textDisplayId);
                if (textDisplay) {
                    const handler = (e) => handleTextSelection(mode, colorStateRef, textDisplayId, eraserModeRef);
                    textDisplay.removeEventListener('mouseup', handler);
                    textDisplay.removeEventListener('touchend', handler);
                    textDisplay.addEventListener('mouseup', handler);
                    textDisplay.addEventListener('touchend', handler);
                }
                
                // Ë®≠ÁΩÆÊ∏ÖÈô§ÊåâÈàï‰∫ã‰ª∂
                const clearBtn = document.getElementById(clearButtonId);
                if (clearBtn) {
                    const newClearBtn = clearBtn.cloneNode(true);
                    clearBtn.parentNode.replaceChild(newClearBtn, clearBtn);
                    newClearBtn.addEventListener('click', () => clearAllHighlights(mode, textDisplayId));
                }
                
                initializedRef.value = true;
                console.log(`[Highlighter:${mode}] ‚úì Initialization complete`);
            }
            
            /**
             * ÂàùÂßãÂåñÂ≠∏ÁîüÁ´ØËû¢ÂÖâÁ≠ÜÂäüËÉΩ
             */
            function init() {
                if (currentRole !== 'student') {
                    console.log('[Highlighter] Skip init - not student role');
                    return;
                }
                
                // üöÄ NEW: Âª∂ÈÅ≤‰ª•Á¢∫‰øù DOM ÂÆåÂÖ®Â∞±Á∑íÔºå‰∏¶ÈáçÁΩÆÂàùÂßãÂåñÊ®ôË™å‰ª•ÊîØÊè¥ÈáçÊñ∞ÂàùÂßãÂåñ
                setTimeout(() => {
                    console.log('[Highlighter:student] Delayed init started - verifying DOM elements');
                    
                    // Ê™¢Êü•ÂøÖË¶ÅÁöÑ DOM ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
                    const eraserBtn = document.getElementById('eraser-btn-reading');
                    const textDisplay = document.getElementById('reading-text-display');
                    
                    if (!eraserBtn) {
                        console.warn('[Highlighter:student] eraser-btn-reading not found in DOM');
                    }
                    if (!textDisplay) {
                        console.warn('[Highlighter:student] reading-text-display not found in DOM');
                    }
                    
                    // ÈáçÁΩÆÂàùÂßãÂåñÊ®ôË™åÔºåÂÖÅË®±ÈáçÊñ∞ÂàùÂßãÂåñ
                    studentInitialized = false;
                    
                    initMode('student', {
                        buttonSelector: '.highlighter-btn',
                        textDisplayId: 'reading-text-display',
                        clearButtonId: 'clear-highlights-btn',
                        eraserButtonId: 'eraser-btn-reading', // üöÄ FIXED: Avoid ID conflict with drawing eraser
                        colorStateRef: { get value() { return studentColor; }, set value(v) { studentColor = v; } },
                        initializedRef: { get value() { return studentInitialized; }, set value(v) { studentInitialized = v; } },
                        eraserModeRef: { get value() { return studentEraserMode; }, set value(v) { studentEraserMode = v; } } // üöÄ NEW
                    });
                }, 100);
            }
            
            /**
             * üöÄ CRITICAL FIX: Initialize global chart manager in global scope
             */
            studentChartManager = (() => {
                let studentChartSvgTf = null;
                let studentChartSvgMc = null;
                
                function init() {
                    studentChartSvgTf = d3.select("#student-chart-svg-tf");
                    studentChartSvgMc = d3.select("#student-chart-svg-mc");
                    console.log('[üë®‚Äçüéì Student Chart] ‚úÖ Manager initialized globally');
                }
                
                function drawStudentPieChart(data, totalValidResponses, svgElement) {
                    svgElement.selectAll("*").remove();
                    const svgViewBox = svgElement.attr("viewBox").split(" ");
                    const width = parseInt(svgViewBox[2]);
                    const height = parseInt(svgViewBox[3]);
                    const radius = Math.min(width, height) / 2 - 30;
                    const g = svgElement.append("g").attr("transform", `translate(${width / 2},${height / 2})`);
                    const color = d3.scaleOrdinal().domain(Object.keys(data)).range(['#16a34a', '#dc2626']);
                    const pie = d3.pie().value(d => d[1]).sort(null);
                    const arc = d3.arc().innerRadius(0).outerRadius(radius);
                    const arcs = g.selectAll(".arc").data(pie(Object.entries(data))).enter().append("g").attr("class", "arc");
                    
                    arcs.append("path")
                        .attr("d", arc)
                        .attr("fill", d => color(d.data[0]))
                        .attr("stroke", "white").style("stroke-width", "2px");
                    
                    arcs.append("text")
                        .attr("transform", d => `translate(${arc.centroid(d)})`)
                        .attr("dy", "0.35em")
                        .text(d => {
                            const percentage = totalValidResponses > 0 ? ((d.data[1] / totalValidResponses) * 100).toFixed(1) : 0;
                            return `${d.data[0]}: ${d.data[1]} (${percentage}%)`;
                        })
                        .style("font-size", "12px").style("text-anchor", "middle").style("fill", "white").style("pointer-events", "none");
                }
                
                function drawStudentBarChart(data, totalValidResponses, svgElement) {
                    svgElement.selectAll("*").remove();
                    const svgViewBox = svgElement.attr("viewBox").split(" ");
                    const svgWidth = parseInt(svgViewBox[2]);
                    const svgHeight = parseInt(svgViewBox[3]);
                    
                    const margin = {top: 25, right: 30, bottom: 40, left: 40};
                    const width = svgWidth - margin.left - margin.right;
                    const height = svgHeight - margin.top - margin.bottom;
                    
                    const x = d3.scaleBand().range([0, width]).padding(0.25).domain(Object.keys(data));
                    const y = d3.scaleLinear().range([height, 0]).domain([0, d3.max(Object.values(data)) || 1]);
                    const color = d3.scaleOrdinal().domain(Object.keys(data)).range(['#2563eb', '#ca8a04', '#16a34a', '#dc2626']);
                    const g = svgElement.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                    
                    g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
                        .selectAll("text").style("font-size", "11px").style("font-weight", "600");
                    
                    g.append("g").call(d3.axisLeft(y).ticks(Math.min(8, d3.max(Object.values(data)) || 1)).tickFormat(d3.format('d')))
                        .selectAll("text").style("font-size", "10px");
                    
                    g.selectAll(".bar").data(Object.entries(data)).enter().append("rect")
                        .attr("class", "bar").attr("x", d => x(d[0])).attr("y", d => y(d[1]))
                        .attr("width", x.bandwidth()).attr("height", d => height - y(d[1]))
                        .attr("fill", d => color(d[0])).attr("rx", 3).attr("ry", 3).style("cursor", "pointer");
                    
                    g.selectAll(".bar-label").data(Object.entries(data)).enter().append("text")
                        .attr("class", "bar-label").attr("x", d => x(d[0]) + x.bandwidth() / 2)
                        .attr("y", d => y(d[1]) - 5).attr("text-anchor", "middle")
                        .style("font-size", "10px").style("font-weight", "500").style("pointer-events", "none")
                        .text(d => {
                            const percentage = totalValidResponses > 0 ? ((d[1] / totalValidResponses) * 100).toFixed(0) : 0;
                            return `${d[1]}`;
                        });
                }
                
                function updateChart(responses, mode) {
                    const filteredResponses = responses.filter(r => {
                        if (mode === 'true_false' && (r.answer === 'O' || r.answer === 'X')) return true;
                        if (mode === 'multiple_choice' && (r.answer >= '1' && r.answer <= '4')) return true;
                        return false;
                    });
                    
                    if (filteredResponses.length === 0) return;
                    
                    if (mode === 'true_false') {
                        const chartData = { 'O': 0, 'X': 0 };
                        filteredResponses.forEach(r => { chartData[r.answer]++; });
                        if (studentChartSvgTf) drawStudentPieChart(chartData, filteredResponses.length, studentChartSvgTf);
                    } else if (mode === 'multiple_choice') {
                        const chartData = { '1': 0, '2': 0, '3': 0, '4': 0 };
                        filteredResponses.forEach(r => { chartData[r.answer]++; });
                        if (studentChartSvgMc) drawStudentBarChart(chartData, filteredResponses.length, studentChartSvgMc);
                    }
                }
                
                return { init, updateChart };
            })();
            
            /**
             * ÂàùÂßãÂåñÊïôÂ∏´Á´ØËû¢ÂÖâÁ≠ÜÂäüËÉΩ
             */
            function initTeacher() {
                initMode('teacher', {
                    buttonSelector: '.teacher-highlighter-btn',
                    textDisplayId: 'view-reading-text-display',
                    clearButtonId: 'teacher-clear-highlights-btn',
                    eraserButtonId: 'teacher-eraser-btn-reading', // üöÄ FIXED: Avoid ID conflict with drawing eraser
                    colorStateRef: { get value() { return teacherColor; }, set value(v) { teacherColor = v; } },
                    initializedRef: { get value() { return teacherInitialized; }, set value(v) { teacherInitialized = v; } },
                    eraserModeRef: { get value() { return teacherEraserMode; }, set value(v) { teacherEraserMode = v; } } // üöÄ NEW
                });
            }
            
            /**
             * üöÄ NEW: ËôïÁêÜÊ©°ÁöÆÊì¶ÈÇèËºØ - ÁßªÈô§ÈÅ∏‰∏≠ÂçÄÂüüÂÖßÁöÑÊâÄÊúâÊ®ôË®ò
             */
            function handleEraserSelection(mode, range, textDisplayId) {
                const textDisplay = document.getElementById(textDisplayId);
                if (!textDisplay) return;
                
                try {
                    // Áç≤ÂèñÈÅ∏‰∏≠ÁØÑÂúçÂÖßÁöÑÊâÄÊúâ mark.highlight ÂÖÉÁ¥†
                    const marks = textDisplay.querySelectorAll('mark.highlight');
                    const rangeStart = range.getBoundingClientRect().left;
                    const rangeEnd = range.getBoundingClientRect().right;
                    
                    let erasedCount = 0;
                    marks.forEach(mark => {
                        const markRect = mark.getBoundingClientRect();
                        // Ê™¢Êü•ÊòØÂê¶ÊúâÈáçÁñä
                        if (markRect.right > rangeStart && markRect.left < rangeEnd) {
                            // Ê™¢Êü•ÈÅ∏‰∏≠ÊñáÊú¨ÊòØÂê¶ÂåÖÂê´ÊàñËàáË©≤Ê®ôË®òÊúâ‰∫§ÈõÜ
                            const markText = mark.textContent;
                            const selectedText = window.getSelection().toString();
                            
                            // Â¶ÇÊûúÈÅ∏‰∏≠ÊñáÊú¨ÂåÖÂê´ÊàñÂåÖÂê´ÊñºÊ®ôË®òÊñáÊú¨ÔºåÂâáÁßªÈô§Ë©≤Ê®ôË®ò
                            if (selectedText.includes(markText) || markText.includes(selectedText)) {
                                const parent = mark.parentNode;
                                while (mark.firstChild) {
                                    parent.insertBefore(mark.firstChild, mark);
                                }
                                parent.removeChild(mark);
                                erasedCount++;
                                console.log(`[Highlighter:${mode}] ‚úì Erased highlight: ${markText.substring(0, 20)}...`);
                            }
                        }
                    });
                    
                    if (erasedCount > 0) {
                        // ‰øùÂ≠òÊì¶Èô§ÂæåÁöÑÁµêÊûú
                        saveHighlights(mode, textDisplayId);
                        console.log(`[Highlighter:${mode}] ‚úì ${erasedCount} highlight(s) erased`);
                    }
                } catch (error) {
                    console.warn(`[Highlighter:${mode}] Error during erase:`, error);
                }
            }
            
            /**
             * ËôïÁêÜÊñáÂ≠óÈÅ∏Êìá - ‰ΩøÁî®ÂÆâÂÖ®ÁöÑÊñáÊú¨ÁØÄÈªûÊìç‰Ωú
             */
            function handleTextSelection(mode, colorStateRef, textDisplayId, eraserModeRef) {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                
                if (!selectedText || selectedText.length === 0) return;
                
                console.log(`[Highlighter:${mode}] Text selected:`, selectedText.substring(0, 20) + '...', 'Eraser mode:', eraserModeRef.value);
                
                try {
                    const range = selection.getRangeAt(0);
                    const textDisplay = document.getElementById(textDisplayId);
                    
                    // Á¢∫‰øùÈÅ∏ÊìáÂú®ÊñáÁ´†ÂçÄÂüüÂÖß
                    if (!textDisplay.contains(range.commonAncestorContainer)) {
                        return;
                    }
                    
                    // üöÄ NEW: Ê™¢Êü•ÊòØÂê¶Âú®Ê©°ÁöÆÊì¶Ê®°Âºè
                    if (eraserModeRef.value) {
                        // ‰ΩøÁî®Êõ¥Á∞°ÂñÆÁöÑÊñπÂºèÔºöÁõ¥Êé•Êü•ÊâæÈÅ∏‰∏≠ÁØÑÂúçÂÖßÁöÑÊ®ôË®ò‰∏¶ÁßªÈô§
                        const marks = textDisplay.querySelectorAll('mark.highlight');
                        let erasedCount = 0;
                        
                        marks.forEach(mark => {
                            // Ê™¢Êü•Ë©≤Ê®ôË®òÁöÑÊñáÊú¨ÊòØÂê¶ËàáÈÅ∏‰∏≠ÊñáÊú¨Êúâ‰∫§ÈõÜ
                            const markRange = document.createRange();
                            markRange.selectNodeContents(mark);
                            
                            try {
                                const comparison = range.compareBoundaryPoints(Range.START_TO_END, markRange);
                                const comparison2 = range.compareBoundaryPoints(Range.END_TO_START, markRange);
                                
                                // Â¶ÇÊûúÊúâ‰∫§ÈõÜÔºåÂâáÁßªÈô§Ë©≤Ê®ôË®ò
                                if (comparison >= 0 && comparison2 <= 0) {
                                    const parent = mark.parentNode;
                                    while (mark.firstChild) {
                                        parent.insertBefore(mark.firstChild, mark);
                                    }
                                    parent.removeChild(mark);
                                    erasedCount++;
                                    console.log(`[Highlighter:${mode}] ‚úì Erased: ${mark.textContent.substring(0, 20)}...`);
                                }
                            } catch (e) {
                                console.warn(`[Highlighter:${mode}] Error comparing ranges:`, e);
                            }
                        });
                        
                        if (erasedCount > 0) {
                            saveHighlights(mode, textDisplayId);
                            console.log(`[Highlighter:${mode}] ‚úì Total erased: ${erasedCount}`);
                        }
                    } else {
                        // Ê≠£Â∏∏Ëû¢ÂÖâÁ≠ÜÊ®ôË®òÊ®°Âºè
                        // üöÄ FIXED: ‰ΩøÁî®Êõ¥ÂÆâÂÖ®ÁöÑÊñπÂºèËôïÁêÜË∑®ÁØÄÈªûÈÅ∏Êìá
                        // ÊèêÂèñÈÅ∏ÊìáÁöÑÂÖßÂÆπ‰∏¶Áî® mark ÂåÖË£ù
                        const fragment = range.extractContents();
                        const mark = document.createElement('mark');
                        mark.className = `highlight highlight-${colorStateRef.value}`;
                        mark.setAttribute('data-color', colorStateRef.value);
                        // üöÄ NEW: Ë®òÈåÑÊØèÂÄãÊ®ôË®ªÁöÑÁç®Á´ãÊôÇÈñìÊà≥ÔºàÁî®ÊñºË©ïÂàÜÂàÜÊûêÔºâ
                        mark.setAttribute('data-timestamp', Date.now().toString());
                        mark.appendChild(fragment);
                        
                        // ÊèíÂÖ•Ê®ôË®ªÂÖÉÁ¥†
                        range.insertNode(mark);
                        
                        // ‰øùÂ≠òÊ®ôË®ªÔºàÂåÖÂê´ÊñáÁ´†ÂÖßÂÆπÂìàÂ∏åÁî®ÊñºÈ©óË≠âÔºâ
                        saveHighlights(mode, textDisplayId);
                        
                        console.log(`[Highlighter:${mode}] ‚úì Highlight applied`);
                    }
                    
                } catch (error) {
                    console.warn(`[Highlighter:${mode}] Could not process selection:`, error.message);
                    // Ê∏ÖÈô§ÈÅ∏ÊìáÈÅøÂÖçÂç°‰Ωè
                    selection.removeAllRanges();
                }
                
                // Ê∏ÖÈô§ÈÅ∏Êìá
                selection.removeAllRanges();
            }
            
            /**
             * üöÄ FIXED: ‰øùÂ≠òÊ®ôË®ªÂà∞ localStorageÔºà‰ΩøÁî®ÂÅèÁßªÈáèËÄåÈùûÁ¥îÊñáÊú¨Ôºâ
             */
            function saveHighlights(mode, textDisplayId) {
                const textDisplay = document.getElementById(textDisplayId);
                if (!textDisplay || !readingComprehensionData) return;
                
                const highlights = [];
                const marks = textDisplay.querySelectorAll('mark.highlight');
                
                // üöÄ ‰ΩøÁî®ÂÅèÁßªÈáè‰øùÂ≠òÊ®ôË®ª‰ΩçÁΩÆ
                marks.forEach((mark) => {
                    try {
                        const range = document.createRange();
                        range.selectNodeContents(mark);
                        
                        // Ë®àÁÆóÊ®ôË®ªÂú®Êï¥ÂÄãÂÆπÂô®Á¥îÊñáÊú¨‰∏≠ÁöÑËµ∑Âßã‰ΩçÁΩÆ
                        const startOffset = getRangeOffset(range, textDisplay);
                        const text = mark.textContent;
                        const color = mark.getAttribute('data-color');
                        // üöÄ NEW: ËÆÄÂèñÊØèÂÄãÊ®ôË®ªÁöÑÊôÇÈñìÊà≥
                        const timestamp = mark.getAttribute('data-timestamp') || Date.now().toString();
                        
                        highlights.push({
                            startOffset: startOffset,
                            length: text.length,
                            text: text, // ‰øùÁïôÊñáÊú¨Áî®ÊñºË™øË©¶
                            color: color,
                            timestamp: parseInt(timestamp) // üöÄ NEW: ‰øùÂ≠òÊôÇÈñìÊà≥
                        });
                    } catch (e) {
                        console.warn(`[Highlighter:${mode}] Failed to save highlight:`, e);
                    }
                });
                
                // Ê∑ªÂä†ÂÖßÂÆπÂìàÂ∏åÁî®ÊñºÈ©óË≠â
                const contentHash = getContentHash(readingComprehensionData.text);
                const saveData = {
                    version: 2, // ÁâàÊú¨ËôüÂçáÁ¥öÁÇ∫ 2
                    contentHash: contentHash,
                    highlights: highlights,
                    timestamp: new Date().getTime()
                };
                
                try {
                    const storageKey = getStorageKey(mode);
                    console.log(`[Highlighter:${mode}] üîç DEBUG: Saving to storageKey =`, storageKey);
                    console.log(`[Highlighter:${mode}] üîç DEBUG: classroomCode =`, classroomCode);
                    console.log(`[Highlighter:${mode}] üîç DEBUG: Saving`, highlights.length, 'highlights');
                    
                    localStorage.setItem(storageKey, JSON.stringify(saveData));
                    console.log(`[Highlighter:${mode}] ‚úÖ Saved`, highlights.length, 'highlights (offset-based) with hash:', contentHash);
                    
                    // È©óË≠â‰øùÂ≠òÊàêÂäü
                    const verification = localStorage.getItem(storageKey);
                    console.log(`[Highlighter:${mode}] üîç DEBUG: Verification - data saved successfully?`, !!verification);
                } catch (error) {
                    console.error(`[Highlighter:${mode}] ‚ùå Failed to save highlights:`, error);
                }
            }
            
            /**
             * üöÄ FIXED: ÊÅ¢Âæ©Ê®ôË®ªÂæû localStorageÔºà‰ΩøÁî®ÂÅèÁßªÈáèÁ≤æÁ¢∫ÊÅ¢Âæ©Ôºâ
             */
            function restoreHighlights(mode = 'student', textDisplayId = 'reading-text-display') {
                // Â≠∏ÁîüÁ´ØÊ™¢Êü•ËßíËâ≤
                if (mode === 'student' && currentRole !== 'student') {
                    console.log(`[Highlighter:${mode}] Skip restore - not student role`);
                    return;
                }
                
                if (!readingComprehensionData) {
                    console.log(`[Highlighter:${mode}] Skip restore - no reading data`);
                    return;
                }
                
                try {
                    const saved = localStorage.getItem(getStorageKey(mode));
                    if (!saved) {
                        console.log(`[Highlighter:${mode}] No saved highlights found`);
                        return;
                    }
                    
                    const saveData = JSON.parse(saved);
                    
                    // È©óË≠âÂÖßÂÆπÂìàÂ∏åÔºåÂ¶ÇÊûú‰∏çÂåπÈÖçÂâáÊ∏ÖÈô§ËàäÊ®ôË®ª
                    const currentHash = getContentHash(readingComprehensionData.text);
                    if (saveData.contentHash && saveData.contentHash !== currentHash) {
                        console.log(`[Highlighter:${mode}] Content hash mismatch, clearing old highlights`);
                        localStorage.removeItem(getStorageKey(mode));
                        return;
                    }
                    
                    const highlights = saveData.highlights || saveData;
                    if (!Array.isArray(highlights) || highlights.length === 0) {
                        console.log(`[Highlighter:${mode}] No highlights to restore`);
                        return;
                    }
                    
                    console.log(`[Highlighter:${mode}] Restoring`, highlights.length, 'highlights (version:', saveData.version || 1, ')');
                    
                    const textDisplay = document.getElementById(textDisplayId);
                    if (!textDisplay) return;
                    
                    // üöÄ FIXED: Ê†πÊìöÁâàÊú¨‰ΩøÁî®‰∏çÂêåÁöÑÊÅ¢Âæ©ÈÇèËºØ
                    if (saveData.version === 2) {
                        // Êñ∞ÁâàÊú¨Ôºö‰ΩøÁî®ÂÅèÁßªÈáèÊÅ¢Âæ©ÔºàÊîØÊåÅË∑® HTML Ê®ôÁ±§Ôºâ
                        let successCount = 0;
                        let failCount = 0;
                        
                        highlights.forEach((h, index) => {
                            if (typeof h.startOffset !== 'number' || !h.length || !h.color) {
                                console.warn(`[Highlighter:${mode}] Skip invalid highlight #${index}:`, h);
                                failCount++;
                                return; // üöÄ ÁπºÁ∫åËôïÁêÜ‰∏ã‰∏ÄÂÄãÊ®ôË®ª
                            }
                            
                            try {
                                const range = createRangeFromOffset(textDisplay, h.startOffset, h.length);
                                if (range) {
                                    const mark = document.createElement('mark');
                                    mark.className = `highlight highlight-${h.color}`;
                                    mark.setAttribute('data-color', h.color);
                                    // üöÄ NEW: ÊÅ¢Âæ©ÊôÇÈñìÊà≥ÔºàÁî®ÊñºË©ïÂàÜÂàÜÊûêÔºâ
                                    if (h.timestamp) {
                                        mark.setAttribute('data-timestamp', h.timestamp.toString());
                                    }
                                    mark.appendChild(range.extractContents());
                                    range.insertNode(mark);
                                    successCount++;
                                    console.log(`[Highlighter:${mode}] ‚úì Restored highlight #${index} at offset ${h.startOffset} (${h.text?.substring(0, 20)}...)`);
                                } else {
                                    console.warn(`[Highlighter:${mode}] Failed to create range for highlight #${index}:`, h);
                                    failCount++;
                                }
                            } catch (err) {
                                console.warn(`[Highlighter:${mode}] Error restoring highlight #${index}:`, err, h);
                                failCount++; // üöÄ Ë®òÈåÑÂ§±Êïó‰ΩÜÁπºÁ∫åËôïÁêÜ
                            }
                        });
                        
                        console.log(`[Highlighter:${mode}] Restoration summary: ${successCount} succeeded, ${failCount} failed out of ${highlights.length}`);
                    } else {
                        // ËàäÁâàÊú¨Ôºö‰ΩøÁî®ÊñáÊú¨ÂåπÈÖçÊÅ¢Âæ©ÔºàÂêëÂæåÂÖºÂÆπÔºâ
                        console.log(`[Highlighter:${mode}] Using legacy text-based restore`);
                        highlights.forEach(h => {
                            if (!h.text || !h.color) return;
                            
                            const walker = document.createTreeWalker(
                                textDisplay,
                                NodeFilter.SHOW_TEXT,
                                null,
                                false
                            );
                            
                            const nodesToHighlight = [];
                            let node;
                            
                            while (node = walker.nextNode()) {
                                const index = node.textContent.indexOf(h.text);
                                if (index !== -1) {
                                    nodesToHighlight.push({ node, index, text: h.text });
                                    break; // Âè™ÂåπÈÖçÁ¨¨‰∏ÄÊ¨°Âá∫Áèæ
                                }
                            }
                            
                            nodesToHighlight.forEach(({ node, index, text }) => {
                                try {
                                    const range = document.createRange();
                                    range.setStart(node, index);
                                    range.setEnd(node, index + text.length);
                                    
                                    const mark = document.createElement('mark');
                                    mark.className = `highlight highlight-${h.color}`;
                                    mark.setAttribute('data-color', h.color);
                                    mark.appendChild(range.extractContents());
                                    range.insertNode(mark);
                                } catch (err) {
                                    console.warn(`[Highlighter:${mode}] Failed to restore individual highlight:`, err);
                                }
                            });
                        });
                    }
                    
                    console.log(`[Highlighter:${mode}] ‚úì Highlights restored successfully`);
                } catch (error) {
                    console.warn(`[Highlighter:${mode}] Failed to restore highlights:`, error);
                    // Ê∏ÖÈô§ÊêçÂ£ûÁöÑÊï∏Êìö
                    try {
                        localStorage.removeItem(getStorageKey(mode));
                    } catch (e) {}
                }
            }
            
            /**
             * Ê∏ÖÈô§ÊâÄÊúâÊ®ôË®ª
             */
            function clearAllHighlights(mode = 'student', textDisplayId = 'reading-text-display') {
                console.log(`[Highlighter:${mode}] Clearing all highlights`);
                const textDisplay = document.getElementById(textDisplayId);
                if (!textDisplay) return;
                
                const marks = textDisplay.querySelectorAll('mark.highlight');
                marks.forEach(mark => {
                    const parent = mark.parentNode;
                    while (mark.firstChild) {
                        parent.insertBefore(mark.firstChild, mark);
                    }
                    parent.removeChild(mark);
                });
                
                // Ê∏ÖÈô§Â≠òÂÑ≤
                try {
                    localStorage.removeItem(getStorageKey(mode));
                    console.log(`[Highlighter:${mode}] ‚úì All highlights cleared`);
                } catch (error) {
                    console.warn(`[Highlighter:${mode}] Failed to clear storage:`, error);
                }
            }
            
            /**
             * ÈáçÁΩÆËû¢ÂÖâÁ≠ÜÁãÄÊÖã
             */
            function reset(mode = 'student') {
                console.log(`[Highlighter:${mode}] Resetting highlighter`);
                const textDisplayId = mode === 'teacher' ? 'view-reading-text-display' : 'reading-text-display';
                const buttonSelector = mode === 'teacher' ? '.teacher-highlighter-btn' : '.highlighter-btn';
                
                clearAllHighlights(mode, textDisplayId);
                
                if (mode === 'teacher') {
                    teacherColor = 'yellow';
                } else {
                    studentColor = 'yellow';
                }
                
                const colorButtons = document.querySelectorAll(buttonSelector);
                colorButtons.forEach((btn, index) => {
                    btn.classList.toggle('active', index === 0);
                });
            }
            
            /**
             * ÊïôÂ∏´Á´ØÔºöÊÅ¢Âæ©Ê®ôË®ª
             */
            function restoreTeacherHighlights() {
                restoreHighlights('teacher', 'view-reading-text-display');
            }
            
            /**
             * ÊïôÂ∏´Á´ØÔºöÊ∏ÖÈô§ÊâÄÊúâÊ®ôË®ª
             */
            function clearTeacherHighlights() {
                clearAllHighlights('teacher', 'view-reading-text-display');
            }
            
            /**
             * ÊïôÂ∏´Á´ØÔºöÈáçÁΩÆËû¢ÂÖâÁ≠Ü
             */
            function resetTeacher() {
                reset('teacher');
            }
            
            return {
                // Â≠∏ÁîüÁ´ØÊñπÊ≥ï
                init,
                reset: () => reset('student'),
                restoreHighlights: () => restoreHighlights('student', 'reading-text-display'),
                clearAllHighlights: () => clearAllHighlights('student', 'reading-text-display'),
                
                // ÊïôÂ∏´Á´ØÊñπÊ≥ï
                initTeacher,
                resetTeacher,
                restoreTeacherHighlights,
                clearTeacherHighlights
            };
        })();

        /**
         * üöÄ NEW: Á≠ÜË®òË©ïÂàÜÂºïÊìéÊ®°ÁµÑ - Highlight Scoring Engine
         * ÂàÜÊûêÂ≠∏ÁîüËû¢ÂÖâÁ≠ÜÊ®ôË®ªÂìÅË≥™‰∏¶Ë®àÁÆóÂä†ÂàÜ
         */
        const HighlightScoringEngine = (function() {
            
            /**
             * ÁÆóÊ≥ï 1: È°èËâ≤Â§öÊ®£ÊÄßË©ïÂàÜ
             * ‰ΩøÁî® 1 Á®ÆÈ°èËâ≤: +0 ÂàÜ
             * ‰ΩøÁî® 2-3 Á®ÆÈ°èËâ≤: +2 ÂàÜ
             * ‰ΩøÁî® 4-5 Á®ÆÈ°èËâ≤: +5 ÂàÜ
             */
            function calculateColorDiversity(highlights) {
                if (!highlights || highlights.length === 0) return 0;
                
                const uniqueColors = new Set(highlights.map(h => h.color));
                const colorCount = uniqueColors.size;
                
                if (colorCount === 1) return 0;
                if (colorCount >= 2 && colorCount <= 3) return 2;
                if (colorCount >= 4) return 5;
                
                return 0;
            }
            
            /**
             * ÁÆóÊ≥ï 2: Á≤æÁ¢∫Â∫¶Ë©ïÂàÜÔºàÈÅøÂÖçÈÅéÂ∫¶Ê®ôË®ªÔºâ
             * Ë¶ÜËìãÁéá < 15%: +5 ÂàÜ
             * Ë¶ÜËìãÁéá 15-30%: +3 ÂàÜ
             * Ë¶ÜËìãÁéá 30-50%: +1 ÂàÜ
             * Ë¶ÜËìãÁéá > 50%: 0 ÂàÜ
             */
            function calculatePrecision(highlights, totalTextLength) {
                if (!highlights || highlights.length === 0 || !totalTextLength) return 0;
                
                const totalHighlightedLength = highlights.reduce((sum, h) => sum + h.length, 0);
                const coverageRate = (totalHighlightedLength / totalTextLength) * 100;
                
                if (coverageRate < 15) return 5;
                if (coverageRate < 30) return 3;
                if (coverageRate < 50) return 1;
                
                return 0;
            }
            
            /**
             * ÁÆóÊ≥ï 3: ÂàÜÊÆµÊ®ôË®ªË©ïÂàÜÔºàÈÅøÂÖç‰∏ÄÁ≠ÜÂà∞Â∫ïÔºâ
             * Ê®ôË®ªÊÆµËêΩÊï∏ ‚â• 3 ÂÄã‰∏çÈÄ£Á∫åÂçÄÂüü: +3 ÂàÜ
             */
            function calculateSegmentation(highlights) {
                if (!highlights || highlights.length === 0) return 0;
                
                // ÊåâËµ∑Âßã‰ΩçÁΩÆÊéíÂ∫è
                const sorted = [...highlights].sort((a, b) => a.startOffset - b.startOffset);
                
                let segmentCount = 1;
                for (let i = 1; i < sorted.length; i++) {
                    const prevEnd = sorted[i - 1].startOffset + sorted[i - 1].length;
                    const currentStart = sorted[i].startOffset;
                    
                    // Â¶ÇÊûúÁï∂ÂâçÊ®ôË®ªËàáÂâç‰∏ÄÂÄãÊ®ôË®ª‰∏çÈÄ£Á∫åÔºàÈñìÈöî > 10 Â≠óÁ¨¶ÔºâÔºåÁÆó‰ΩúÊñ∞ÊÆµËêΩ
                    if (currentStart - prevEnd > 10) {
                        segmentCount++;
                    }
                }
                
                return segmentCount >= 3 ? 3 : 0;
            }
            
            /**
             * ÁÆóÊ≥ï 4: Á≠îÈ°åÈóúËÅØÂ∫¶Ë©ïÂàÜ
             * Ê®ôË®ªÂÖßÂÆπÂåÖÂê´Ê≠£Á¢∫Á≠îÊ°àË≠âÊìö: ÊØèÈ°å +2 ÂàÜ
             */
            function calculateRelevance(highlights, questions, studentAnswers) {
                if (!highlights || !questions || !studentAnswers || highlights.length === 0) return 0;
                
                let relevanceScore = 0;
                
                // Â∞áÊâÄÊúâÊ®ôË®ªÊñáÂ≠óÂêà‰Ωµ
                const highlightedText = highlights.map(h => h.text.toLowerCase()).join(' ');
                
                // Ê™¢Êü•ÊØèÂÄãÂïèÈ°å
                questions.forEach((q, index) => {
                    const studentAnswer = studentAnswers[index];
                    if (!studentAnswer) return;
                    
                    // Áç≤ÂèñÂ≠∏ÁîüÈÅ∏ÊìáÁöÑÈÅ∏È†ÖÊñáÂ≠ó
                    const selectedOption = q.options[studentAnswer - 1];
                    if (!selectedOption) return;
                    
                    // Ê™¢Êü•Ê®ôË®ª‰∏≠ÊòØÂê¶ÂåÖÂê´ÈÅ∏È†ÖÁöÑÈóúÈçµË©ûÔºàËá≥Â∞ë3ÂÄãÂ≠óÁöÑË©ûÁµÑÔºâ
                    const optionWords = selectedOption.toLowerCase().match(/[\u4e00-\u9fa5]{3,}/g) || [];
                    
                    let hasRelevance = false;
                    for (const word of optionWords) {
                        if (highlightedText.includes(word)) {
                            hasRelevance = true;
                            break;
                        }
                    }
                    
                    if (hasRelevance) {
                        relevanceScore += 2;
                    }
                });
                
                return relevanceScore;
            }
            
            /**
             * ÁÆóÊ≥ï 5: ÊôÇÈñìÂàÜÈÖçÂêàÁêÜÊÄßË©ïÂàÜ
             * Ê®ôË®ªÊôÇÈñìË∑®Â∫¶ > 30ÁßíÔºàÈÅøÂÖç‰∏ÄÊ¨°ÊÄßÂÖ®ÈÅ∏Ôºâ: +2 ÂàÜ
             */
            function calculateTimeDistribution(highlights) {
                if (!highlights || highlights.length < 2) return 0;
                
                const timestamps = highlights.map(h => h.timestamp).filter(t => t);
                if (timestamps.length < 2) return 0;
                
                const minTime = Math.min(...timestamps);
                const maxTime = Math.max(...timestamps);
                const timeSpan = (maxTime - minTime) / 1000; // ËΩâÊèõÁÇ∫Áßí
                
                // Ê®ôË®ªÊôÇÈñìË∑®Â∫¶ > 30ÁßíÔºåË°®Á§∫ÈÄêÊ≠•Ê®ôË®ª
                return timeSpan > 30 ? 2 : 0;
            }
            
            /**
             * Á∂úÂêàË©ïÂàÜÂáΩÊï∏
             * @param {Object} params - Ë©ïÂàÜÂèÉÊï∏
             * @param {Array} params.highlights - Ê®ôË®ªÊï∏ÁµÑ
             * @param {number} params.totalTextLength - ÊñáÁ´†Á∏ΩÂ≠óÊï∏
             * @param {Array} params.questions - È°åÁõÆÊï∏ÁµÑ
             * @param {Array} params.studentAnswers - Â≠∏ÁîüÁ≠îÊ°àÊï∏ÁµÑ
             * @returns {Object} Ë©ïÂàÜÁµêÊûú
             */
            function calculateScore(params) {
                const { highlights, totalTextLength, questions, studentAnswers } = params;
                
                if (!highlights || highlights.length === 0) {
                    return {
                        totalScore: 0,
                        breakdown: {
                            colorDiversity: 0,
                            precision: 0,
                            segmentation: 0,
                            relevance: 0,
                            timeDistribution: 0
                        },
                        stats: {
                            highlightCount: 0,
                            colorCount: 0,
                            coverageRate: 0,
                            segmentCount: 0
                        }
                    };
                }
                
                // Áµ±Ë®àË≥áË®äÔºàÂÖàÁÆóË¶ÜËìãÁéáÔºåÁî®ÊñºÊ±∫ÂÆöÊòØÂê¶Âä†ÂàÜÔºâ
                const uniqueColors = new Set(highlights.map(h => h.color));
                const totalHighlightedLength = highlights.reduce((sum, h) => sum + h.length, 0);
                const coverageRate = totalTextLength ? (totalHighlightedLength / totalTextLength) * 100 : 0;
                
                // üöÄ Èò≤Ê≠¢‰∫ÇÁï´Âä†ÂàÜÔºöÂ¶ÇÊûúË¶ÜËìãÁéá > 60%ÔºàÂÖ®ÈÅ∏ÊàñÂ§ßÈÉ®ÂàÜÔºâÔºå‰∏çÂä†ÂàÜ
                let colorDiversity = 0;
                let precision = 0;
                let segmentation = 0;
                let relevance = 0;
                let timeDistribution = 0;
                let totalScore = 0;
                
                if (coverageRate > 60) {
                    // Ë¶ÜËìãÁéáÂ§™È´ò = ‰∫ÇÁï´ÔºåÊâÄÊúâÈ†ÖÁõÆÈÉΩ‰∏çÂä†ÂàÜ
                    console.log(`[calculateScore] Ë¶ÜËìãÁéá ${coverageRate.toFixed(1)}% Ë∂ÖÈÅé60%Ôºå‰∏çÂä†ÂàÜ`);
                } else {
                    // Ë¶ÜËìãÁéáÂêàÁêÜÊâçÈñãÂßãË®àÁÆóÂêÑÈ†ÖÂàÜÊï∏
                    colorDiversity = calculateColorDiversity(highlights);
                    precision = calculatePrecision(highlights, totalTextLength);
                    segmentation = calculateSegmentation(highlights);
                    relevance = calculateRelevance(highlights, questions, studentAnswers);
                    timeDistribution = calculateTimeDistribution(highlights);
                    
                    // Á∏ΩÂàÜÔºàÂêÑÈ†ÖÂä†ÂàÜÁ¥ØË®àÔºåÁÑ°‰∏äÈôêÔºâ
                    const rawTotal = colorDiversity + precision + segmentation + relevance + timeDistribution;
                    totalScore = rawTotal;
                }
                
                const sorted = [...highlights].sort((a, b) => a.startOffset - b.startOffset);
                let segmentCount = 1;
                for (let i = 1; i < sorted.length; i++) {
                    const prevEnd = sorted[i - 1].startOffset + sorted[i - 1].length;
                    const currentStart = sorted[i].startOffset;
                    if (currentStart - prevEnd > 10) {
                        segmentCount++;
                    }
                }
                
                // üöÄ NEW: Ë®àÁÆóÊôÇÈñìÁµ±Ë®à
                const timestamps = highlights.map(h => h.timestamp).filter(t => t);
                let timeSpanSeconds = 0;
                if (timestamps.length >= 2) {
                    const minTime = Math.min(...timestamps);
                    const maxTime = Math.max(...timestamps);
                    timeSpanSeconds = Math.round((maxTime - minTime) / 1000);
                }
                
                return {
                    totalScore,
                    breakdown: {
                        colorDiversity,
                        precision,
                        segmentation,
                        relevance,
                        timeDistribution
                    },
                    stats: {
                        highlightCount: highlights.length,
                        colorCount: uniqueColors.size,
                        coverageRate: coverageRate.toFixed(1),
                        segmentCount,
                        timeSpanSeconds
                    }
                };
            }
            
            return {
                calculateScore
            };
        })();

        /**
         * Ê®°ÊÖãË¶ñÁ™óÁÆ°ÁêÜÊ®°ÁµÑ - Modal Manager Module
         * Áµ±‰∏ÄÁÆ°ÁêÜÊâÄÊúâÊ®°ÊÖãË¶ñÁ™óÁöÑÈ°ØÁ§∫ÂíåÈö±Ëóè
         */
        const ModalManager = (function() {
            /**
             * È°ØÁ§∫Ê®°ÊÖãË¶ñÁ™ó
             * @param {string|HTMLElement} modalIdOrElement - Ê®°ÊÖãË¶ñÁ™ó ID ÊàñÂÖÉÁ¥†
             */
            function show(modalIdOrElement) {
                const modal = typeof modalIdOrElement === 'string' 
                    ? document.getElementById(modalIdOrElement)
                    : modalIdOrElement;
                    
                if (modal) {
                    modal.classList.remove('hidden');
                    // Ê∑ªÂä†Ê∑°ÂÖ•ÂãïÁï´
                    modal.style.animation = 'fadeIn 0.2s ease-in-out';
                } else {
                    console.warn('Êâæ‰∏çÂà∞Ê®°ÊÖãË¶ñÁ™ó:', modalIdOrElement);
                }
            }
            
            /**
             * Èö±ËóèÊ®°ÊÖãË¶ñÁ™ó
             * @param {string|HTMLElement} modalIdOrElement - Ê®°ÊÖãË¶ñÁ™ó ID ÊàñÂÖÉÁ¥†
             */
            function hide(modalIdOrElement) {
                const modal = typeof modalIdOrElement === 'string' 
                    ? document.getElementById(modalIdOrElement)
                    : modalIdOrElement;
                    
                if (modal) {
                    modal.classList.add('hidden');
                } else {
                    console.warn('Êâæ‰∏çÂà∞Ê®°ÊÖãË¶ñÁ™ó:', modalIdOrElement);
                }
            }
            
            /**
             * ÂàáÊèõÊ®°ÊÖãË¶ñÁ™óÈ°ØÁ§∫ÁãÄÊÖã
             * @param {string|HTMLElement} modalIdOrElement - Ê®°ÊÖãË¶ñÁ™ó ID ÊàñÂÖÉÁ¥†
             */
            function toggle(modalIdOrElement) {
                const modal = typeof modalIdOrElement === 'string' 
                    ? document.getElementById(modalIdOrElement)
                    : modalIdOrElement;
                    
                if (modal) {
                    if (modal.classList.contains('hidden')) {
                        show(modal);
                    } else {
                        hide(modal);
                    }
                } else {
                    console.warn('Êâæ‰∏çÂà∞Ê®°ÊÖãË¶ñÁ™ó:', modalIdOrElement);
                }
            }
            
            /**
             * Èö±ËóèÊâÄÊúâÊ®°ÊÖãË¶ñÁ™ó
             */
            function hideAll() {
                document.querySelectorAll('.magnified-image-modal').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }
            
            return {
                show,
                hide,
                toggle,
                hideAll
            };
        })();

        /**
         * ËºâÂÖ•ÊåáÁ§∫Âô®Ê®°ÁµÑ - Loading Indicator Module
         * È°ØÁ§∫ÂÖ®Â±ÄËºâÂÖ•ÂãïÁï´
         */
        const LoadingIndicator = (function() {
            let loadingElement = null;
            
            /**
             * È°ØÁ§∫ËºâÂÖ•ÊåáÁ§∫Âô®
             * @param {string} message - ËºâÂÖ•Ë®äÊÅØ
             */
            function show(message = 'ËºâÂÖ•‰∏≠...') {
                // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåÂÖàÁßªÈô§
                if (loadingElement) hide();
                
                loadingElement = document.createElement('div');
                loadingElement.id = 'global-loading-indicator';
                loadingElement.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    backdrop-filter: blur(3px);
                `;
                
                loadingElement.innerHTML = `
                    <div style="background: white; padding: 2rem 3rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-3"></i>
                        <p class="text-lg text-gray-800 font-medium">${message}</p>
                    </div>
                `;
                
                document.body.appendChild(loadingElement);
            }
            
            /**
             * Èö±ËóèËºâÂÖ•ÊåáÁ§∫Âô®
             */
            function hide() {
                if (loadingElement && loadingElement.parentElement) {
                    loadingElement.remove();
                    loadingElement = null;
                }
            }
            
            /**
             * Ê™¢Êü•ÊòØÂê¶Ê≠£Âú®È°ØÁ§∫
             * @returns {boolean} ÊòØÂê¶È°ØÁ§∫‰∏≠
             */
            function isShowing() {
                return loadingElement !== null && loadingElement.parentElement !== null;
            }
            
            return {
                show,
                hide,
                isShowing
            };
        })();

        /**
         * È°åÂ∫´ÁÆ°ÁêÜÈÄöÁî®È°û - Question Bank Manager Class
         * Áµ±‰∏ÄÁÆ°ÁêÜÂêÑÁ®ÆÈ°åÂûãÁöÑÈ°åÂ∫´ÔºàÊéíÂ∫èÈ°å„ÄÅÈÖçÂ∞çÈ°å„ÄÅÈÅ∏ÊìáÈ°å„ÄÅÈñ±ËÆÄÊ∏¨È©óÔºâ
         */
        class QuestionBankManager {
            constructor(storageKey, bankArray) {
                this.storageKey = storageKey;
                this.banks = bankArray || [];
            }
            
            /**
             * ÂÑ≤Â≠òÈ°åÂ∫´
             * @param {Object} bank - È°åÂ∫´Áâ©‰ª∂ {name, ...otherData}
             * @returns {boolean} ÊòØÂê¶ÊàêÂäü
             */
            save(bank) {
                if (!bank || !bank.name) {
                    console.warn('È°åÂ∫´ÂøÖÈ†àÂåÖÂê´ name Â±¨ÊÄß');
                    return false;
                }
                
                const existingIndex = this.banks.findIndex(b => b.name === bank.name);
                if (existingIndex !== -1) {
                    this.banks[existingIndex] = bank;
                } else {
                    this.banks.push(bank);
                }
                
                return true;
            }
            
            /**
             * ËºâÂÖ•È°åÂ∫´Âà∞ÊåáÂÆö‰ΩçÁΩÆ
             * @param {number} index - È°åÂ∫´Á¥¢Âºï
             * @returns {Object|null} È°åÂ∫´Áâ©‰ª∂
             */
            load(index) {
                if (index >= 0 && index < this.banks.length) {
                    return this.banks[index];
                }
                return null;
            }
            
            /**
             * Âà™Èô§È°åÂ∫´
             * @param {number} index - È°åÂ∫´Á¥¢Âºï
             * @returns {boolean} ÊòØÂê¶ÊàêÂäü
             */
            delete(index) {
                if (index >= 0 && index < this.banks.length) {
                    this.banks.splice(index, 1);
                    return true;
                }
                return false;
            }
            
            /**
             * Áç≤ÂèñÊâÄÊúâÈ°åÂ∫´
             * @returns {Array} È°åÂ∫´Èô£Âàó
             */
            getAll() {
                return this.banks;
            }
            
            /**
             * Ê∏ÖÁ©∫ÊâÄÊúâÈ°åÂ∫´
             */
            clearAll() {
                this.banks.length = 0;
            }
            
            /**
             * Ê†πÊìöÂêçÁ®±ÊêúÂ∞ãÈ°åÂ∫´
             * @param {string} name - È°åÂ∫´ÂêçÁ®±
             * @returns {Object|null} È°åÂ∫´Áâ©‰ª∂
             */
            findByName(name) {
                return this.banks.find(b => b.name === name) || null;
            }
        }

        /**
         * ÈåØË™§ËôïÁêÜÊ®°ÁµÑ - Error Handler Module
         * Áµ±‰∏ÄËôïÁêÜ Firebase ÂíåÂÖ∂‰ªñÈåØË™§
         */
        const ErrorHandler = (function() {
            /**
             * ËôïÁêÜ Firebase ÈåØË™§
             * @param {Error} error - ÈåØË™§Áâ©‰ª∂
             * @param {string} defaultMessage - È†êË®≠ÈåØË™§Ë®äÊÅØ
             */
            function handleFirebaseError(error, defaultMessage = 'Êìç‰ΩúÂ§±Êïó') {
                console.error('[Firebase Error]', error);
                
                let userMessage = defaultMessage;
                
                // Ê†πÊìöÈåØË™§‰ª£Á¢ºÊèê‰æõÊõ¥ÂÖ∑È´îÁöÑË®äÊÅØ
                if (error.code) {
                    switch (error.code) {
                        case 'permission-denied':
                            userMessage = 'Ê¨äÈôê‰∏çË∂≥ÔºåË´ãÈáçÊñ∞ÁôªÂÖ•';
                            // 3ÁßíÂæåËøîÂõûÁôªÂÖ•È†Å
                            setTimeout(() => {
                                if (typeof showView === 'function') {
                                    showView('entry');
                                }
                            }, 3000);
                            break;
                        
                        case 'unavailable':
                        case 'failed-precondition':
                            userMessage = 'Á∂≤Ë∑ØÈÄ£Á∑ö‰∏çÁ©©ÂÆöÔºåË´ãÊ™¢Êü•Á∂≤Ë∑Ø';
                            break;
                        
                        case 'not-found':
                            userMessage = 'Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑË≥áÊñô';
                            break;
                        
                        case 'already-exists':
                            userMessage = 'Ë≥áÊñôÂ∑≤Â≠òÂú®';
                            break;
                        
                        case 'resource-exhausted':
                            userMessage = '‰º∫ÊúçÂô®ÁπÅÂøôÔºåË´ãÁ®çÂæåÂÜçË©¶';
                            break;
                        
                        case 'unauthenticated':
                            userMessage = 'Êú™ÁôªÂÖ•ÊàñÁôªÂÖ•Â∑≤ÈÅéÊúüÔºåË´ãÈáçÊñ∞ÁôªÂÖ•';
                            setTimeout(() => {
                                if (typeof showView === 'function') {
                                    showView('entry');
                                }
                            }, 3000);
                            break;
                        
                        default:
                            userMessage = `${defaultMessage}ÔºàÈåØË™§‰ª£Á¢ºÔºö${error.code}Ôºâ`;
                    }
                }
                
                // È°ØÁ§∫ÈåØË™§Ë®äÊÅØÁµ¶Áî®Êà∂
                if (typeof showMessage === 'function') {
                    showMessage(userMessage, 'error');
                }
                
                return userMessage;
            }
            
            /**
             * ËôïÁêÜ‰∏ÄËà¨ÈåØË™§
             * @param {Error} error - ÈåØË™§Áâ©‰ª∂
             * @param {string} context - ÈåØË™§ÁôºÁîüÁöÑ‰∏ä‰∏ãÊñá
             */
            function handleGenericError(error, context = '') {
                console.error(`[Error${context ? ' in ' + context : ''}]`, error);
                
                const userMessage = context 
                    ? `${context}ÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶`
                    : 'ÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶';
                
                if (typeof showMessage === 'function') {
                    showMessage(userMessage, 'error');
                }
                
                return userMessage;
            }
            
            /**
             * ÂÆâÂÖ®Âü∑Ë°åÁï∞Ê≠•ÂáΩÂºè
             * @param {Function} asyncFn - Áï∞Ê≠•ÂáΩÂºè
             * @param {string} context - ‰∏ä‰∏ãÊñáÊèèËø∞
             * @param {Function} onError - ÈåØË™§ÂõûË™øÔºàÂèØÈÅ∏Ôºâ
             * @returns {Promise} Âü∑Ë°åÁµêÊûú
             */
            async function safeExecute(asyncFn, context = '', onError = null) {
                try {
                    return await asyncFn();
                } catch (error) {
                    // Âà§Êñ∑ÊòØÂê¶ÁÇ∫ Firebase ÈåØË™§
                    if (error.code) {
                        handleFirebaseError(error, `${context}Â§±Êïó`);
                    } else {
                        handleGenericError(error, context);
                    }
                    
                    // Âü∑Ë°åËá™Ë®ÇÈåØË™§ÂõûË™ø
                    if (typeof onError === 'function') {
                        onError(error);
                    }
                    
                    return null;
                }
            }
            
            return {
                handleFirebaseError,
                handleGenericError,
                safeExecute
            };
        })();

        /**
         * DOM Êü•Ë©¢Âø´ÂèñÊ®°ÁµÑ - DOM Query Cache Module
         * Êèê‰æõÂ∏∏Áî® DOM ÂÖÉÁ¥†ÁöÑÂø´ÈÄüÂ≠òÂèñ
         */
        const DOMCache = (function() {
            const cache = {};
            
            /**
             * Áç≤ÂèñÂÖÉÁ¥†ÔºàÂ∏∂Âø´ÂèñÔºâ
             * @param {string} id - ÂÖÉÁ¥† ID
             * @returns {HTMLElement|null} DOM ÂÖÉÁ¥†
             */
            function get(id) {
                if (!cache[id]) {
                    cache[id] = document.getElementById(id);
                }
                return cache[id];
            }
            
            /**
             * ÊâπÈáèÁç≤ÂèñÂÖÉÁ¥†
             * @param {Array<string>} ids - ÂÖÉÁ¥† ID Èô£Âàó
             * @returns {Object} ÂÖÉÁ¥†Áâ©‰ª∂ {id: element}
             */
            function getMany(ids) {
                const elements = {};
                ids.forEach(id => {
                    elements[id] = get(id);
                });
                return elements;
            }
            
            /**
             * Ê∏ÖÈô§Âø´Âèñ
             * @param {string} id - ÂÖÉÁ¥† IDÔºàÂèØÈÅ∏Ôºå‰∏çÊèê‰æõÂâáÊ∏ÖÈô§ÂÖ®ÈÉ®Ôºâ
             */
            function clear(id = null) {
                if (id) {
                    delete cache[id];
                } else {
                    for (const key in cache) {
                        delete cache[key];
                    }
                }
            }
            
            /**
             * È†êËºâÂ∏∏Áî®ÂÖÉÁ¥†
             */
            function preload() {
                const commonIds = [
                    'student-responses-container',
                    'active-student-count',
                    'message-box',
                    'message-content',
                    'text-input-area',
                    'drawing-canvas',
                    'submit-text-btn',
                    'submit-drawing-btn',
                    'student-welcome-msg'
                ];
                
                commonIds.forEach(id => get(id));
            }
            
            return {
                get,
                getMany,
                clear,
                preload
            };
        })();

        // ============================================================================
        // End of Optimization Module
        // ============================================================================

        // --- DOM Elements Caching ---
        const views = {
            entry: document.getElementById('entry-view'),
            teacherClassroomCode: document.getElementById('teacher-classroom-code-view'), // NEW VIEW
            teacherMenu: document.getElementById('teacher-menu-view'),
            teacherMonitor: document.getElementById('teacher-monitor-view'),
            studentName: document.getElementById('student-name-view'),
            studentWaiting: document.getElementById('student-waiting-view'),
            studentInteraction: document.getElementById('student-interaction-view'),
            studentPeerReview: document.getElementById('student-peer-review-view'), // NEW VIEW
        };

        const interactionUIs = {
            true_false: document.getElementById('interaction-true-false'),
            multiple_choice: document.getElementById('interaction-multiple-choice'),
            text_input: document.getElementById('interaction-text-input'),
            drawing: document.getElementById('interaction-drawing'),
            url_dispatch: document.getElementById('interaction-url-dispatch'), // Now handles both URL and HTML
            recording: document.getElementById('interaction-recording'), // New UI
            reading_comprehension: document.getElementById('interaction-reading-comprehension'), // Reading comprehension UI
            quick_answer: document.getElementById('interaction-quick-answer'), // Quick answer UI
            quick_poll: document.getElementById('interaction-quick-poll'), // Quick poll UI
            sequencing: document.getElementById('interaction-sequencing'), // Sequencing UI
            matching: document.getElementById('interaction-matching'), // Matching UI
        };

        // --- Core Logic Functions ---
        /**
         * Displays the specified view section.
         * @param {string} viewName - The name of the view to display (key in `views` object).
         */
        function showView(viewName) {
            const body = document.querySelector('body');
            body.classList.remove('initial-view-background');

            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
                if (viewName === 'entry') {
                    body.classList.add('initial-view-background');
                }
            } else {
                console.error('Êâæ‰∏çÂà∞Ë¶ñÂúñ:', viewName);
            }
        }
        
        /**
         * Displays the UI for a specific interaction mode within the student interface.
         * @param {string} mode - The interaction mode (e.g., 'true_false', 'drawing', 'recording', 'url_dispatch').
         * @param {boolean} [isResumingFromPause=false] - True if this is part of resuming from a paused state.
         */
        function showInteractionUI(mode, isResumingFromPause = false) {
             Object.values(interactionUIs).forEach(ui => ui.classList.add('hidden'));
             // Clear URL dispatch content if switching to another mode
             if (mode !== 'url_dispatch' && interactionUIs.url_dispatch) {
                interactionUIs.url_dispatch.innerHTML = ''; // Clear content for URL/HTML dispatch
                interactionUIs.url_dispatch.style.cssText = ''; // Reset container styles
             }

             if (interactionUIs[mode]) {
                interactionUIs[mode].classList.remove('hidden');
                resetStudentUIState(mode, isResumingFromPause); // Pass the flag

                // Special handling for quick answer mode
                if (mode === 'quick_answer') {
                    console.log('[showInteractionUI] Starting quick answer mode...');
                    startQuickAnswer();
                    console.log('[showInteractionUI] Quick answer started, now setting up listener...');
                    listenToQuickAnswerUpdates();
                    console.log('[showInteractionUI] Quick answer listener registered');
                }
             }
        }

        /**
         * Resets the student UI state, e.g., clears input fields or enables buttons.
         * @param {string} mode - The current interaction mode.
         * @param {boolean} [isResumingFromPause=false] - True if this reset is part of resuming from a paused state.
         */
        function resetStudentUIState(mode, isResumingFromPause = false) {
            const grayClass = 'bg-gray-400';
            const hoverClassMap = {
                '1': 'hover:bg-blue-600', '2': 'hover:bg-yellow-600',
                '3': 'hover:bg-green-600', '4': 'hover:bg-red-600'
            };
            
            // üöÄ FIX: ÊéíÈô§ÊâÄÊúâÂèØËÉΩÂ∑≤Êèê‰∫§ÁöÑÊåâÈàïÔºåÈÅøÂÖçÂú®Áï∞Ê≠•Ê™¢Êü•ÂÆåÊàêÂâçË¶ÜËìãÂ∑≤Êèê‰∫§ÁãÄÊÖã
            // ÈÄô‰∫õÊéß‰ª∂Â∞áÂú®ÂêÑËá™ÁöÑ case ‰∏≠ÂñÆÁç®ËôïÁêÜ
            const excludedSubmitButtons = [
                'submit-reading-btn',
                'submit-text-btn', 
                'submit-drawing-btn',
                'submit-recording-btn',
                'submit-custom-mc-btn',
                'submit-sequencing-btn',
                'submit-matching-btn'
            ];
            
            // Only re-enable controls if they're not submission-related
            document.querySelectorAll('#student-interaction-view button, #student-interaction-view textarea, #student-interaction-view input[type="file"], #student-interaction-view select, #student-interaction-view input[type="radio"]').forEach(el => {
                // Ë∑≥ÈÅéÊâÄÊúâÊèê‰∫§ÊåâÈàïÂíåÁ≠îÊ°àÊåâÈàïÁöÑÈáçÁΩÆÔºåÈÄô‰∫õÂ∞áÂú®ÂêÑËá™ÁöÑ case ‰∏≠ÂñÆÁç®ËôïÁêÜ
                if (excludedSubmitButtons.includes(el.id)) return;
                if (el.classList.contains('answer-btn')) return; // Ë∑≥ÈÅéÊòØÈùûÈ°åÂíåÈÅ∏ÊìáÈ°åÁöÑÁ≠îÊ°àÊåâÈàï
                
                el.disabled = false;
                // Re-add original classes if they were removed by pause state
                if (el.classList.contains('btn-gray')) {
                    el.classList.remove('btn-gray');
                    el.classList.add('btn-primary'); // Assuming primary is default for many
                }
            });
            
            // Canvas ÂíåÂÖ∂‰ªñÂÆπÂô®ÁöÑ pointerEvents Â∞áÂú®ÂêÑËá™ÁöÑ case ‰∏≠ËôïÁêÜ
            // ÈÅøÂÖçÂú®ÈÄôË£°ÂÖ®Â±ÄÂïüÁî®

            switch(mode) {
                case 'true_false':
                    // üöÄ NEW: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Êèê‰∫§ÊòØÈùûÈ°åÁ≠îÊ°àÔºåÊ∞∏‰πÖÈéñÂÆöÂ∑≤Êèê‰∫§ÁöÑÈÅ∏È†Ö
                    (async () => {
                        let hasSubmitted = false;
                        if (currentRole === 'student' && studentName && classroomCode) {
                            try {
                                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                                const docSnap = await getDoc(studentRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.interactionMode === 'true_false' && data.answer) {
                                        hasSubmitted = true;
                                        console.log('[resetStudentUIState] Student has submitted true/false answer, locking buttons');
                                    }
                                }
                            } catch (error) {
                                console.error('[resetStudentUIState] Error checking submission status:', error);
                            }
                        }
                        
                        // Â¶ÇÊûúÂ∑≤Êèê‰∫§ÔºåÈéñÂÆöÊâÄÊúâÊåâÈàï
                        if (hasSubmitted) {
                            interactionUIs[mode].querySelectorAll('.answer-btn').forEach(btn => {
                                btn.disabled = true;
                                btn.classList.remove('bg-green-500', 'bg-red-500');
                                btn.classList.add(grayClass);
                            });
                        } else {
                            // üéØ IMPROVED: Êú™Êèê‰∫§ÔºåÊÅ¢Âæ©ÊåâÈàïÂà∞ÂàùÂßãÁãÄÊÖã
                            interactionUIs[mode].querySelectorAll('.answer-btn').forEach(btn => {
                                btn.disabled = false;
                                btn.classList.remove(grayClass);
                                
                                // ÊÅ¢Âæ©ÂéüÂßãÂÖßÂÆπÂíåÈ°èËâ≤
                                const answer = btn.dataset.answer;
                                if (answer === 'O') {
                                    btn.classList.add('bg-green-500');
                                    btn.innerHTML = `
                                        <i class="fas fa-check text-white" style="font-size: 4rem;"></i>
                                        <p class="text-white text-2xl font-bold mt-2">Ê≠£Á¢∫</p>
                                    `;
                                } else if (answer === 'X') {
                                    btn.classList.add('bg-red-500');
                                    btn.innerHTML = `
                                        <i class="fas fa-times text-white" style="font-size: 4rem;"></i>
                                        <p class="text-white text-2xl font-bold mt-2">ÈåØË™§</p>
                                    `;
                                }
                                
                                // ÁßªÈô§Â∑≤ÈÄÅÂá∫Ê®ôË®ò
                                btn.removeAttribute('data-original-text');
                                btn.removeAttribute('data-submitted');
                            });
                        }
                    })();
                    break;
                case 'multiple_choice':
                    // üöÄ NEW: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Êèê‰∫§ÈÅ∏ÊìáÈ°åÁ≠îÊ°àÔºàÂåÖÂê´ÈªòË™ç1-4ÂíåËá™Ë®ÇÈÅ∏ÊìáÈ°åÔºâ
                    (async () => {
                        let hasSubmitted = false;
                        let submittedInteractionMode = null;
                        if (currentRole === 'student' && studentName && classroomCode) {
                            try {
                                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                                const docSnap = await getDoc(studentRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.interactionMode === 'multiple_choice' && data.answer) {
                                        hasSubmitted = true;
                                        submittedInteractionMode = data.interactionMode;
                                        console.log('[resetStudentUIState] Student has submitted multiple choice answer, locking buttons');
                                    }
                                }
                            } catch (error) {
                                console.error('[resetStudentUIState] Error checking submission status:', error);
                            }
                        }
                        
                        const defaultMcOptions = document.getElementById('default-mc-options');
                        
                        // Â¶ÇÊûúÂ∑≤Êèê‰∫§ÔºåÈéñÂÆöÊâÄÊúâÊåâÈàï
                        if (hasSubmitted) {
                            // ÈéñÂÆöÈªòË™çÈÅ∏ÊìáÈ°åÊåâÈàï
                            defaultMcOptions.querySelectorAll('.answer-btn').forEach(btn => {
                                btn.disabled = true;
                                btn.classList.remove('bg-blue-500', 'bg-yellow-500', 'bg-green-500', 'bg-red-500');
                                btn.classList.add(grayClass);
                                // Remove hover classes
                                btn.classList.remove(hoverClassMap['1'], hoverClassMap['2'], hoverClassMap['3'], hoverClassMap['4']);
                            });
                            
                            // ÈéñÂÆöËá™Ë®ÇÈÅ∏ÊìáÈ°åÊèê‰∫§ÊåâÈàï
                            const submitBtn = document.getElementById('submit-custom-mc-btn');
                            submitBtn.disabled = true;
                            submitBtn.classList.remove('btn-primary');
                            submitBtn.classList.add('btn-gray');
                            submitBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                        } else {
                            // üéØ IMPROVED: Êú™Êèê‰∫§ÔºåÊÅ¢Âæ©ÊåâÈàïÂà∞ÂàùÂßãÁãÄÊÖã
                            defaultMcOptions.querySelectorAll('.answer-btn').forEach(btn => {
                                btn.disabled = false;
                                btn.classList.remove(grayClass);
                                
                                // ÊÅ¢Âæ©ÂéüÂßãÂÖßÂÆπÂíåÈ°èËâ≤
                                const answer = btn.dataset.answer;
                                if (answer === '1') {
                                    btn.classList.add('bg-blue-500', hoverClassMap['1']);
                                    btn.innerHTML = '<span class="text-white text-6xl sm:text-7xl md:text-8xl font-bold">1</span>';
                                } else if (answer === '2') {
                                    btn.classList.add('bg-yellow-500', hoverClassMap['2']);
                                    btn.innerHTML = '<span class="text-white text-6xl sm:text-7xl md:text-8xl font-bold">2</span>';
                                } else if (answer === '3') {
                                    btn.classList.add('bg-green-500', hoverClassMap['3']);
                                    btn.innerHTML = '<span class="text-white text-6xl sm:text-7xl md:text-8xl font-bold">3</span>';
                                } else if (answer === '4') {
                                    btn.classList.add('bg-red-500', hoverClassMap['4']);
                                    btn.innerHTML = '<span class="text-white text-6xl sm:text-7xl md:text-8xl font-bold">4</span>';
                                }
                                
                                // ÁßªÈô§Â∑≤ÈÄÅÂá∫Ê®ôË®ò
                                btn.removeAttribute('data-original-text');
                                btn.removeAttribute('data-submitted');
                            });
                            
                            // Reset custom MC options (but preserve submission state)
                            document.getElementById('custom-mc-questions-container').innerHTML = '';
                            // Âè™ÊúâÂú®‰∏çÊòØÂæûÊö´ÂÅúÁãÄÊÖãÊÅ¢Âæ©ÊôÇÊâçÈáçÁΩÆÊåâÈàï
                            if (!isResumingFromPause) {
                                const submitBtn = document.getElementById('submit-custom-mc-btn');
                                submitBtn.disabled = false;
                                submitBtn.classList.remove('btn-gray');
                                submitBtn.classList.add('btn-primary');
                                submitBtn.textContent = 'ÈÄÅÂá∫ÂÖ®ÈÉ®Á≠îÊ°à ‚úâÔ∏è';
                            }
                        }
                    })();
                    break;
                case 'text_input':
                    // üöÄ NEW: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Êèê‰∫§ÊñáÂ≠óÈ°åÁ≠îÊ°àÔºåÊ∞∏‰πÖÈéñÂÆöÂ∑≤Êèê‰∫§ÁöÑÊåâÈàï
                    (async () => {
                        let hasSubmitted = false;
                        if (currentRole === 'student' && studentName && classroomCode) {
                            try {
                                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                                const docSnap = await getDoc(studentRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.interactionMode === 'text_input' && data.answer) {
                                        hasSubmitted = true;
                                        console.log('[resetStudentUIState] Student has submitted text answer, locking button');
                                    }
                                }
                            } catch (error) {
                                console.error('[resetStudentUIState] Error checking submission status:', error);
                            }
                        }
                        
                        const submitTextBtn = document.getElementById('submit-text-btn');
                        
                        // Â¶ÇÊûúÂ∑≤Êèê‰∫§ÔºåÈéñÂÆöÊåâÈàï
                        if (hasSubmitted) {
                            submitTextBtn.disabled = true;
                            submitTextBtn.classList.remove('btn-primary');
                            submitTextBtn.classList.add('btn-gray');
                            submitTextBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                            document.getElementById('text-input-area').disabled = true;
                        } else {
                            document.getElementById('text-input-area').value = '';
                            document.getElementById('text-input-area').disabled = false;
                            submitTextBtn.disabled = false;
                            submitTextBtn.classList.remove('btn-gray');
                            submitTextBtn.classList.add('btn-primary');
                            submitTextBtn.textContent = 'ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è';
                        }
                    })();
                    break;
                case 'drawing':
                    // üöÄ NEW: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Êèê‰∫§Áπ™ÂúñÁ≠îÊ°àÔºåÊ∞∏‰πÖÈéñÂÆöÂ∑≤Êèê‰∫§ÁöÑÊåâÈàï
                    (async () => {
                        let hasSubmitted = false;
                        if (currentRole === 'student' && studentName && classroomCode) {
                            try {
                                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                                const docSnap = await getDoc(studentRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.interactionMode === 'drawing' && data.answer) {
                                        hasSubmitted = true;
                                        console.log('[resetStudentUIState] Student has submitted drawing answer, locking button');
                                    }
                                }
                            } catch (error) {
                                console.error('[resetStudentUIState] Error checking submission status:', error);
                            }
                        }
                        
                        const submitDrawingBtn = document.getElementById('submit-drawing-btn');
                        
                        // Â¶ÇÊûúÂ∑≤Êèê‰∫§ÔºåÈéñÂÆöÊåâÈàïÂíåÁï´Â∏É
                        if (hasSubmitted) {
                            submitDrawingBtn.disabled = true;
                            submitDrawingBtn.classList.remove('btn-primary');
                            submitDrawingBtn.classList.add('btn-gray');
                            submitDrawingBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                            canvas.style.pointerEvents = 'none'; // Á¶ÅÁî®Áï´Â∏É‰∫§‰∫í
                        } else {
                            // Only clear the drawing canvas if it's NOT resuming from a pause.
                            if (!isResumingFromPause) {
                                clearDrawingCanvas(); // Clears only the student's drawing layer.
                                studentUploadedImageDataURL = null; // Clear student uploaded image too
                                studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                            }
                            
                            submitDrawingBtn.disabled = false;
                            submitDrawingBtn.classList.remove('btn-gray');
                            submitDrawingBtn.classList.add('btn-primary');
                            submitDrawingBtn.textContent = 'ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è';
                            canvas.style.pointerEvents = 'auto'; // ÂïüÁî®Áï´Â∏É‰∫§‰∫í
                            
                            // Reset drawing tools to default values.
                            const colorSelect = document.getElementById('color-select');
                            const sizeSelect = document.getElementById('size-select');
                            const penToolBtn = document.getElementById('pen-tool-btn');
                            const eraserBtn = document.getElementById('eraser-btn');

                            colorSelect.value = 'black';
                            sizeSelect.value = '2';
                            drawingCtx.strokeStyle = 'black'; 
                            drawingCtx.lineWidth = 2;
                            drawingCtx.globalCompositeOperation = 'source-over'; 
                            
                            penToolBtn.classList.add('border-blue-500');
                            eraserBtn.classList.remove('border-blue-500');

                            updateColorSwatch(colorSelect.value);
                        }
                    })();
                    break;
                case 'url_dispatch': // This mode now handles both URL and HTML
                    // Content is dynamically generated, no specific reset needed here beyond clearing in showInteractionUI
                    break;
                case 'recording':
                    // üöÄ NEW: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Êèê‰∫§ÈåÑÈü≥Á≠îÊ°àÔºåÊ∞∏‰πÖÈéñÂÆöÂ∑≤Êèê‰∫§ÁöÑÊåâÈàï
                    (async () => {
                        let hasSubmitted = false;
                        if (currentRole === 'student' && studentName && classroomCode) {
                            try {
                                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                                const docSnap = await getDoc(studentRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.interactionMode === 'recording' && data.answer) {
                                        hasSubmitted = true;
                                        console.log('[resetStudentUIState] Student has submitted recording answer, locking buttons');
                                    }
                                }
                            } catch (error) {
                                console.error('[resetStudentUIState] Error checking submission status:', error);
                            }
                        }
                        
                        // Â¶ÇÊûúÂ∑≤Êèê‰∫§ÔºåÈéñÂÆöÊâÄÊúâÊåâÈàï
                        if (hasSubmitted) {
                            document.getElementById('start-recording-btn').disabled = true;
                            document.getElementById('stop-recording-btn').disabled = true;
                            document.getElementById('play-recording-btn').disabled = true;
                            document.getElementById('reset-recording-btn').disabled = true;
                            const submitRecordingBtn = document.getElementById('submit-recording-btn');
                            submitRecordingBtn.disabled = true;
                            submitRecordingBtn.classList.remove('btn-primary');
                            submitRecordingBtn.classList.add('btn-gray');
                            submitRecordingBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                            recordingStatusText.textContent = 'Â∑≤ÈÄÅÂá∫ÈåÑÈü≥Á≠îÊ°à';
                        } else {
                            // Reset recording state
                            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                                mediaRecorder.stop();
                            }
                            if (audioStream) {
                                audioStream.getTracks().forEach(track => track.stop());
                            }
                            audioChunks = [];
                            audioBlob = null;
                            audioDataURL = null;
                            document.getElementById('audio-preview').classList.add('hidden');
                            document.getElementById('audio-preview').src = '';
                            document.getElementById('start-recording-btn').disabled = false;
                            document.getElementById('stop-recording-btn').disabled = true;
                            document.getElementById('play-recording-btn').disabled = true;
                            document.getElementById('reset-recording-btn').disabled = true;
                            document.getElementById('submit-recording-btn').disabled = true;
                            recordingStatusText.textContent = 'Ê∫ñÂÇôÈåÑÈü≥...';
                            recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                            recordingStatusIcon.classList.add('text-gray-400');
                        }
                    })();
                    break;
                case 'quick_answer':
                    // Reset quick answer state
                    document.getElementById('quick-answer-status-text').textContent = 'Á≠âÂæÖÊê∂Á≠îÈñãÂßã...';
                    document.getElementById('quick-answer-result').classList.add('hidden');
                    document.getElementById('quick-answer-locked').classList.add('hidden');
                    document.getElementById('quick-answer-button-container').innerHTML = '';
                    document.getElementById('quick-answer-button-container').classList.add('pointer-events-none');
                    break;
                case 'sequencing':
                    // üöÄ NEW: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Êèê‰∫§ÊéíÂ∫èÈ°åÁ≠îÊ°àÔºåÊ∞∏‰πÖÈéñÂÆöÂ∑≤Êèê‰∫§ÁöÑÊåâÈàï
                    (async () => {
                        let hasSubmitted = false;
                        if (currentRole === 'student' && studentName && classroomCode) {
                            try {
                                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                                const docSnap = await getDoc(studentRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.interactionMode === 'sequencing' && data.answer) {
                                        hasSubmitted = true;
                                        console.log('[resetStudentUIState] Student has submitted sequencing answer, locking button');
                                    }
                                }
                            } catch (error) {
                                console.error('[resetStudentUIState] Error checking submission status:', error);
                            }
                        }
                        
                        const submitSequencingBtn = document.getElementById('submit-sequencing-btn');
                        
                        // Â¶ÇÊûúÂ∑≤Êèê‰∫§ÔºåÈéñÂÆöÊåâÈàï
                        if (hasSubmitted) {
                            submitSequencingBtn.disabled = true;
                            submitSequencingBtn.classList.remove('btn-primary');
                            submitSequencingBtn.classList.add('btn-gray');
                            submitSequencingBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                            // Á¶ÅÁî®ÊéíÂ∫èÈ†ÖÁõÆÁöÑÊãñÂãï
                            document.getElementById('sequencing-items-container').style.pointerEvents = 'none';
                        } else {
                            // üöÄ FIX: ‰∏çË¶ÅÂú®ÈÄôË£°Ê∏ÖÁ©∫ÂÆπÂô®ÔºÅ
                            // setupSequencingUI ÊúÉÂú®ÈúÄË¶ÅÊôÇËá™Â∑±Ê∏ÖÁ©∫‰∏¶ÈáçÊñ∞Â°´ÂÖÖ
                            // Â¶ÇÊûúÈÄôË£°Ê∏ÖÁ©∫ÔºåÊúÉÂ∞éËá¥Âú®ÂæåÁ∫åÂø´ÁÖßÊõ¥Êñ∞ÊôÇÔºàsettingsChanged=falseÔºâÂÆπÂô®Ë¢´Ê∏ÖÁ©∫‰ΩÜ‰∏çÈáçÊñ∞Ê∏≤Êüì
                            document.getElementById('sequencing-items-container').style.pointerEvents = 'auto';
                            submitSequencingBtn.disabled = false;
                            submitSequencingBtn.classList.remove('btn-gray');
                            submitSequencingBtn.classList.add('btn-primary');
                            submitSequencingBtn.textContent = 'ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è';
                        }
                    })();
                    break;
                case 'matching':
                    // üöÄ NEW: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Êèê‰∫§ÈÖçÂ∞çÈ°åÁ≠îÊ°àÔºåÊ∞∏‰πÖÈéñÂÆöÂ∑≤Êèê‰∫§ÁöÑÊåâÈàï
                    (async () => {
                        let hasSubmitted = false;
                        if (currentRole === 'student' && studentName && classroomCode) {
                            try {
                                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                                const docSnap = await getDoc(studentRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.interactionMode === 'matching' && data.answer) {
                                        hasSubmitted = true;
                                        console.log('[resetStudentUIState] Student has submitted matching answer, locking button');
                                    }
                                }
                            } catch (error) {
                                console.error('[resetStudentUIState] Error checking submission status:', error);
                            }
                        }
                        
                        const submitMatchingBtn = document.getElementById('submit-matching-btn');
                        
                        // Â¶ÇÊûúÂ∑≤Êèê‰∫§ÔºåÈéñÂÆöÊåâÈàï
                        if (hasSubmitted) {
                            submitMatchingBtn.disabled = true;
                            submitMatchingBtn.classList.remove('btn-primary');
                            submitMatchingBtn.classList.add('btn-gray');
                            submitMatchingBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                            // Á¶ÅÁî®ÈÖçÂ∞çÈ†ÖÁõÆÁöÑÈªûÊìä
                            document.getElementById('matching-column-a').style.pointerEvents = 'none';
                            document.getElementById('matching-column-b').style.pointerEvents = 'none';
                        } else {
                            // üöÄ FIX: ‰∏çË¶ÅÂú®ÈÄôË£°Ê∏ÖÁ©∫ÂÆπÂô®ÔºÅ
                            // setupMatchingUI ÊúÉÂú®ÈúÄË¶ÅÊôÇËá™Â∑±Ê∏ÖÁ©∫‰∏¶ÈáçÊñ∞Â°´ÂÖÖ
                            // Â¶ÇÊûúÈÄôË£°Ê∏ÖÁ©∫ÔºåÊúÉÂ∞éËá¥Âú®ÂæåÁ∫åÂø´ÁÖßÊõ¥Êñ∞ÊôÇÔºàsettingsChanged=falseÔºâÂÆπÂô®Ë¢´Ê∏ÖÁ©∫‰ΩÜ‰∏çÈáçÊñ∞Ê∏≤Êüì
                            document.getElementById('matching-column-a').style.pointerEvents = 'auto';
                            document.getElementById('matching-column-b').style.pointerEvents = 'auto';
                            submitMatchingBtn.disabled = false;
                            submitMatchingBtn.classList.remove('btn-gray');
                            submitMatchingBtn.classList.add('btn-primary');
                            submitMatchingBtn.textContent = 'ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è';
                            currentMatchingSelection.leftItem = null;
                            currentMatchingSelection.rightItem = null;
                        }
                    })();
                    break;
                case 'reading_comprehension':
                    // üöÄ FIX: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Êèê‰∫§ÔºåÊ∞∏‰πÖÈéñÂÆöÂ∑≤Êèê‰∫§ÁöÑÁ≠îÊ°à
                    (async () => {
                        const submitReadingBtn = document.getElementById('submit-reading-btn');
                        
                        // Ê™¢Êü• Firebase ‰∏≠ÊòØÂê¶Â∑≤ÊúâÊèê‰∫§Ë®òÈåÑ
                        let hasSubmitted = false;
                        if (currentRole === 'student' && studentName && classroomCode) {
                            try {
                                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                                const docSnap = await getDoc(studentRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.interactionMode === 'reading_comprehension' && data.answer) {
                                        hasSubmitted = true;
                                        console.log('[resetStudentUIState] Student has submitted reading answer, locking button');
                                    }
                                }
                            } catch (error) {
                                console.error('[resetStudentUIState] Error checking submission status:', error);
                            }
                        }
                        
                        // Â¶ÇÊûúÂ∑≤Êèê‰∫§ÔºåÊ∞∏‰πÖÈéñÂÆöÊåâÈàï
                        if (hasSubmitted) {
                            submitReadingBtn.disabled = true;
                            submitReadingBtn.classList.remove('btn-primary');
                            submitReadingBtn.classList.add('btn-gray');
                            submitReadingBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                        }
                        // Âê¶ÂâáÔºåÂè™ÊúâÂú®‰∏çÊòØÂæûÊö´ÂÅúÊÅ¢Âæ©ÊôÇÊâçÈáçÁΩÆÊåâÈàï
                        else if (!isResumingFromPause) {
                            submitReadingBtn.disabled = false;
                            submitReadingBtn.classList.remove('btn-gray');
                            submitReadingBtn.classList.add('btn-primary');
                            submitReadingBtn.textContent = 'ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è';
                        }
                    })();
                    break;
                case 'quick_poll':
                    // Reset quick poll state
                    document.getElementById('quick-poll-options-container').innerHTML = '';
                    document.getElementById('quick-poll-options-container').classList.remove('hidden');
                    document.getElementById('quick-poll-voted-status').classList.add('hidden');
                    document.getElementById('quick-poll-question-display').textContent = '';
                    break;
            }
        }

        /**
         * Toggles the enabled/disabled state of student interaction elements.
         * @param {boolean} disable - True to disable, false to enable.
         */
        function toggleStudentInteractionElements(disable) {
            const studentInteractionView = document.getElementById('student-interaction-view');
            // Select all interactive elements within the student interaction view, excluding the pause overlay itself.
            const interactiveElements = studentInteractionView.querySelectorAll(
                'button, textarea, input[type="file"], select, input[type="radio"]' // Added input[type="radio"]
            );

            interactiveElements.forEach(el => {
                // Only disable if the element is not the pause overlay itself or its children
                if (!el.closest('#student-pause-overlay')) {
                    if (disable) {
                        el.disabled = disable;
                        // Add a class for visual feedback if needed, e.g., gray out
                        if (el.tagName === 'BUTTON' && !el.classList.contains('btn-gray')) {
                            el.classList.add('btn-gray');
                            el.classList.remove('btn-primary', 'btn-green', 'btn-orange', 'btn-purple', 'btn-teal', 'bg-indigo-600', 'hover:bg-indigo-700', 'bg-yellow-600', 'hover:bg-yellow-700'); // Remove original colors
                        }
                    } else {
                        // üéØ CRITICAL FIX: Ê™¢Êü•ÊòØÂê¶Â∑≤Êèê‰∫§Á≠îÊ°àÔºåÈò≤Ê≠¢ÈáçÊñ∞ÂïüÁî®Â∑≤ÈéñÂÆöÁöÑÊåâÈàï
                        const hasDataSubmitted = el.hasAttribute('data-submitted');
                        const hasDataAttribute = el.hasAttribute('data-original-text');
                        const textContent = el.textContent || '';
                        const hasSubmittedText = textContent.includes('Â∑≤ÈÄÅÂá∫') || textContent.includes('‚úì');
                        const hasSubmitted = hasDataSubmitted || hasDataAttribute || hasSubmittedText;
                        
                        // üéØ Â¶ÇÊûúÊåâÈàïÂ∑≤Êèê‰∫§Ôºå‰øùÊåÅÁ¶ÅÁî®ÁãÄÊÖã
                        if (hasSubmitted) {
                            el.disabled = true; // ‰øùÊåÅÁ¶ÅÁî®
                            return; // Ë∑≥ÈÅéÂæåÁ∫åÁöÑÊ®£ÂºèÊÅ¢Âæ©ÈÇèËºØ
                        }
                        
                        // Êú™Êèê‰∫§ÁöÑÊåâÈàïÊâçÈáçÊñ∞ÂïüÁî®
                        el.disabled = false;
                        
                        // Re-enable and restore original styles
                        if (el.tagName === 'BUTTON' && el.classList.contains('btn-gray')) {
                            el.classList.remove('btn-gray');
                            // Restore based on common button types or specific IDs
                            if (el.id === 'submit-text-btn' || el.id === 'submit-drawing-btn' || el.id === 'submit-recording-btn' || el.id === 'submit-custom-mc-btn' || el.id === 'submit-reading-btn' || el.id === 'submit-sequencing-btn' || el.id === 'submit-matching-btn') {
                                el.classList.add('btn-primary');
                            } else if (el.classList.contains('answer-btn')) {
                                // For answer buttons, re-apply their specific colors
                                if (el.dataset.answer === 'O') el.classList.add('bg-green-500');
                                else if (el.dataset.answer === 'X') el.classList.add('bg-red-500');
                                else if (el.dataset.answer === '1') el.classList.add('bg-blue-500');
                                else if (el.dataset.answer === '2') el.classList.add('bg-yellow-500');
                                else if (el.dataset.answer === '3') el.classList.add('bg-green-500');
                                else if (el.dataset.answer === '4') el.classList.add('bg-red-500');
                            } else if (el.id === 'start-recording-btn') {
                                el.classList.add('btn-green');
                            } else if (el.id === 'stop-recording-btn') {
                                el.classList.add('btn-red');
                            } else if (el.id === 'play-recording-btn') {
                                el.classList.add('btn-primary');
                            } else if (el.id === 'reset-recording-btn') {
                                el.classList.add('btn-orange');
                            } else if (el.id === 'pen-tool-btn') {
                                el.classList.add('border-blue-500'); // Pen button border
                            }
                        }
                    }
                }
            });

            // Handle canvas interaction separately
            canvas.style.pointerEvents = disable ? 'none' : 'auto';

            // Handle recording specific buttons that might be disabled by default
            if (currentInteractionMode === 'recording' && !disable) {
                // Only enable start if not already recording
                if (mediaRecorder && mediaRecorder.state === 'inactive') {
                    document.getElementById('start-recording-btn').disabled = false;
                }
                // Other recording buttons remain disabled until recording starts/stops
            }
        }
        
        /**
         * Displays a custom message box.
         * @param {string} message - The message to display.
         * @param {'info' | 'success' | 'error' | 'warning'} type - The message type, influencing its color.
         * @param {number} duration - Auto-hide duration in milliseconds (default: 3000). Set to 0 for no auto-hide.
         * @param {boolean} allowHtml - Whether to render message as HTML (default: false).
         * @param {boolean} requireManualClose - Whether to show close button and require manual close (default: false).
         */
        function showMessage(message, type = 'info', duration = 3000, allowHtml = false, requireManualClose = false) {
            const msgBox = document.getElementById('message-box');
            const msgContent = document.getElementById('message-content');
            
            // Ë®≠ÁΩÆÊ∂àÊÅØÂÖßÂÆπÔºàÊîØÊåÅHTMLÊàñÁ¥îÊñáÊú¨Ôºâ
            if (allowHtml) {
                msgContent.innerHTML = message;
            } else {
                msgContent.textContent = message;
            }
            
            // Âü∫Á§éÊ®£ÂºèÔºàRWDÈüøÊáâÂºèÔºâ
            msgBox.className = 'fixed top-4 left-1/2 -translate-x-1/2 px-4 sm:px-6 py-3 sm:py-4 rounded-lg shadow-2xl transition-all duration-300 transform text-white font-semibold max-w-[95vw] sm:max-w-2xl';
            msgBox.style.zIndex = '10001';
            
            // È°èËâ≤Ê®£Âºè
            switch (type) {
                case 'success': msgBox.classList.add('bg-green-500'); break;
                case 'error': msgBox.classList.add('bg-red-500'); break;
                case 'warning': msgBox.classList.add('bg-yellow-500'); break;
                case 'info': msgBox.classList.add('bg-blue-500'); break;
                default: msgBox.classList.add('bg-blue-500'); break;
            }
            
            // Â¶ÇÊûúÈúÄË¶ÅÊâãÂãïÈóúÈñâÔºåÊ∑ªÂä†ÈóúÈñâÊåâÈàï
            if (requireManualClose) {
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '‚úï';
                closeBtn.className = 'absolute top-2 right-2 sm:top-3 sm:right-3 w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition-all text-white font-bold text-sm sm:text-lg';
                closeBtn.onclick = () => {
                    msgBox.classList.add('hidden');
                    // Ê∏ÖÈô§ÈóúÈñâÊåâÈàï
                    const existingCloseBtn = msgBox.querySelector('button');
                    if (existingCloseBtn) existingCloseBtn.remove();
                };
                msgBox.appendChild(closeBtn);
            }
            
            msgBox.classList.remove('hidden');
            
            // Ëá™ÂãïÈö±ËóèÔºàÂ¶ÇÊûú‰∏çÈúÄË¶ÅÊâãÂãïÈóúÈñâ‰∏îduration > 0Ôºâ
            if (!requireManualClose && duration > 0) {
                setTimeout(() => {
                    msgBox.classList.add('hidden');
                }, duration);
            }
        }

        /**
         * ÁîüÊàêÁµ±‰∏ÄÁöÑÊ™îÊ°àÂêçÁ®±ÔºàÂåÖÂê´ÊïôÂÆ§‰ª£Á¢ºÂíåÊôÇÈñìÊà≥Ë®òÔºâ
         * @param {string} baseName - Ê™îÊ°àÂü∫Á§éÂêçÁ®±Ôºà‰æãÂ¶ÇÔºö'Â≠∏ÁîüÂõûÊáâ'„ÄÅ'ÊòØÈùûÈ°åÁµ±Ë®à'Ôºâ
         * @param {string} extension - Ê™îÊ°àÂâØÊ™îÂêçÔºà‰æãÂ¶ÇÔºö'csv'„ÄÅ'zip'Ôºâ
         * @returns {string} ÂÆåÊï¥Ê™îÂêçÔºàÊ†ºÂºèÔºöÊïôÂÆ§‰ª£Á¢º_Ê™îÊ°àÂêçÁ®±_YYYYMMDD_HHMMSS.ÂâØÊ™îÂêçÔºâ
         */
        function generateFilename(baseName, extension) {
            const now = new Date();
            const timestamp = now.getFullYear() +
                            String(now.getMonth() + 1).padStart(2, '0') +
                            String(now.getDate()).padStart(2, '0') + '_' +
                            String(now.getHours()).padStart(2, '0') +
                            String(now.getMinutes()).padStart(2, '0') +
                            String(now.getSeconds()).padStart(2, '0');
            
            const classroomPrefix = classroomCode ? `${classroomCode}_` : '';
            return `${classroomPrefix}${baseName}_${timestamp}.${extension}`;
        }

        /**
         * Question Bank Management Functions
         */
        function updateQuestionBankList() {
            const list = document.getElementById('question-bank-list');
            if (questionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">ÁõÆÂâçÊ≤íÊúâÂÑ≤Â≠òÁöÑÈ°åÂ∫´</div>';
            } else {
                list.innerHTML = questionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadQuestionBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">ËºâÂÖ•</button>
                            <button onclick="deleteQuestionBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">Âà™Èô§</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadQuestionBankFromFile() {
            const fileInput = document.getElementById('question-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('Ë´ãÈÅ∏Êìá‰∏ÄÂÄãtxtÊ™îÊ°à', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('Âè™ËÉΩ‰∏äÂÇ≥txtÊ†ºÂºèÁöÑÊ™îÊ°à', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');

                // Check if bank with same name exists
                const existingIndex = questionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`È°åÂ∫´„Äå${fileName}„ÄçÂ∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÅË¶ÜËìãÔºü`)) {
                        questionBanks[existingIndex] = { name: fileName, content: content };
                    } else {
                        return;
                    }
                } else {
                    questionBanks.push({ name: fileName, content: content });
                }

                updateQuestionBankList();
                showMessage(`È°åÂ∫´„Äå${fileName}„ÄçËºâÂÖ•ÊàêÂäü`, 'success');
                fileInput.value = ''; // Clear file input
            };

            reader.onerror = function() {
                showMessage('ËÆÄÂèñÊ™îÊ°àÊôÇÁôºÁîüÈåØË™§', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveQuestionBankFromTextarea() {
            const nameInput = document.getElementById('question-bank-name-input');
            const textarea = document.getElementById('custom-mc-questions-textarea');
            const name = nameInput.value.trim();
            const content = textarea.value.trim();

            if (!name) {
                showMessage('Ë´ãËº∏ÂÖ•È°åÂ∫´ÂêçÁ®±', 'error');
                return;
            }

            if (!content) {
                showMessage('È°åÁõÆÂÖßÂÆπ‰∏çËÉΩÁÇ∫Á©∫', 'error');
                return;
            }

            // Check if bank with same name exists
            const existingIndex = questionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`È°åÂ∫´„Äå${name}„ÄçÂ∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÅË¶ÜËìãÔºü`)) {
                    questionBanks[existingIndex] = { name: name, content: content };
                } else {
                    return;
                }
            } else {
                questionBanks.push({ name: name, content: content });
            }

            updateQuestionBankList();
            showMessage(`È°åÂ∫´„Äå${name}„ÄçÂÑ≤Â≠òÊàêÂäü`, 'success');
            nameInput.value = ''; // Clear name input
        }

        function loadQuestionBankToTextarea(index) {
            if (index >= 0 && index < questionBanks.length) {
                const textarea = document.getElementById('custom-mc-questions-textarea');
                textarea.value = questionBanks[index].content;
                showMessage(`È°åÂ∫´„Äå${questionBanks[index].name}„ÄçÂ∑≤ËºâÂÖ•Âà∞Ëº∏ÂÖ•Ê°Ü`, 'success');
            }
        }

        function deleteQuestionBank(index) {
            if (index >= 0 && index < questionBanks.length) {
                const bankName = questionBanks[index].name;
                if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§È°åÂ∫´„Äå${bankName}„ÄçÂóéÔºü`)) {
                    questionBanks.splice(index, 1);
                    updateQuestionBankList();
                    showMessage(`È°åÂ∫´„Äå${bankName}„ÄçÂ∑≤Âà™Èô§`, 'success');
                }
            }
        }

        // Make functions globally accessible for onclick handlers
        window.loadQuestionBankToTextarea = loadQuestionBankToTextarea;
        window.deleteQuestionBank = deleteQuestionBank;

        function clearAllQuestionBanks() {
            questionBanks = [];
            updateQuestionBankList();

            // Clear reading comprehension question banks
            readingQuestionBanks = [];
            localStorage.removeItem('readingQuestionBanks');
            updateReadingBankList();
        }

        // ==================== Sequencing Question Bank Functions ====================

        function updateSequencingBankList() {
            const list = document.getElementById('seq-bank-list');
            if (sequencingQuestionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">ÁõÆÂâçÊ≤íÊúâÂÑ≤Â≠òÁöÑÈ°åÂ∫´</div>';
            } else {
                list.innerHTML = sequencingQuestionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadSequencingBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">ËºâÂÖ•</button>
                            <button onclick="deleteSequencingBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">Âà™Èô§</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadSequencingBankFromFile() {
            const fileInput = document.getElementById('seq-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('Ë´ãÈÅ∏Êìá‰∏ÄÂÄãtxtÊ™îÊ°à', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('Âè™ËÉΩ‰∏äÂÇ≥txtÊ†ºÂºèÁöÑÊ™îÊ°à', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');
                const lines = content.split('\n').map(line => line.trim()).filter(line => line);

                if (lines.length < 2) {
                    showMessage('È°åÂ∫´Ê†ºÂºèÈåØË™§ÔºöËá≥Â∞ëÈúÄË¶Å2ÂÄãÊéíÂ∫èÈ†ÖÁõÆ', 'error');
                    return;
                }

                const question = 'ÊéíÂ∫èÈ°å';
                const items = lines.join('\n');

                const existingIndex = sequencingQuestionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`È°åÂ∫´„Äå${fileName}„ÄçÂ∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÅË¶ÜËìãÔºü`)) {
                        sequencingQuestionBanks[existingIndex] = { name: fileName, question: question, items: items };
                    } else {
                        return;
                    }
                } else {
                    sequencingQuestionBanks.push({ name: fileName, question: question, items: items });
                }

                updateSequencingBankList();
                showMessage(`È°åÂ∫´„Äå${fileName}„ÄçËºâÂÖ•ÊàêÂäü`, 'success');
                fileInput.value = '';
            };

            reader.onerror = function() {
                showMessage('ËÆÄÂèñÊ™îÊ°àÊôÇÁôºÁîüÈåØË™§', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveSequencingBank() {
            const nameInput = document.getElementById('seq-bank-name-input');
            const itemsTextarea = document.getElementById('sequencing-items-textarea');

            const name = nameInput.value.trim();
            const question = 'ÊéíÂ∫èÈ°å';
            const items = itemsTextarea.value.trim();

            if (!name) {
                showMessage('Ë´ãËº∏ÂÖ•È°åÂ∫´ÂêçÁ®±', 'error');
                return;
            }

            if (!items) {
                showMessage('ÊéíÂ∫èÈ†ÖÁõÆ‰∏çËÉΩÁÇ∫Á©∫', 'error');
                return;
            }

            const existingIndex = sequencingQuestionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`È°åÂ∫´„Äå${name}„ÄçÂ∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÅË¶ÜËìãÔºü`)) {
                    sequencingQuestionBanks[existingIndex] = { name: name, question: question, items: items };
                } else {
                    return;
                }
            } else {
                sequencingQuestionBanks.push({ name: name, question: question, items: items });
            }

            updateSequencingBankList();
            showMessage(`È°åÂ∫´„Äå${name}„ÄçÂÑ≤Â≠òÊàêÂäü`, 'success');
            nameInput.value = '';
        }

        function loadSequencingBankToTextarea(index) {
            if (index >= 0 && index < sequencingQuestionBanks.length) {
                const bank = sequencingQuestionBanks[index];
                document.getElementById('sequencing-items-textarea').value = bank.items;
                showMessage(`È°åÂ∫´„Äå${bank.name}„ÄçÂ∑≤ËºâÂÖ•Âà∞Ëº∏ÂÖ•Ê°Ü`, 'success');
            }
        }

        function deleteSequencingBank(index) {
            if (index >= 0 && index < sequencingQuestionBanks.length) {
                const bankName = sequencingQuestionBanks[index].name;
                if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§È°åÂ∫´„Äå${bankName}„ÄçÂóéÔºü`)) {
                    sequencingQuestionBanks.splice(index, 1);
                    updateSequencingBankList();
                    showMessage(`È°åÂ∫´„Äå${bankName}„ÄçÂ∑≤Âà™Èô§`, 'success');
                }
            }
        }

        // ==================== Matching Question Bank Functions ====================

        function updateMatchingBankList() {
            const list = document.getElementById('match-bank-list');
            if (matchingQuestionBanks.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-sm italic text-center">ÁõÆÂâçÊ≤íÊúâÂÑ≤Â≠òÁöÑÈ°åÂ∫´</div>';
            } else {
                list.innerHTML = matchingQuestionBanks.map((bank, index) => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <span class="text-sm font-medium text-gray-700">${bank.name}</span>
                        <div class="flex gap-2">
                            <button onclick="loadMatchingBankToTextarea(${index})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded">ËºâÂÖ•</button>
                            <button onclick="deleteMatchingBank(${index})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded">Âà™Èô§</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadMatchingBankFromFile() {
            const fileInput = document.getElementById('match-bank-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('Ë´ãÈÅ∏Êìá‰∏ÄÂÄãtxtÊ™îÊ°à', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.txt')) {
                showMessage('Âè™ËÉΩ‰∏äÂÇ≥txtÊ†ºÂºèÁöÑÊ™îÊ°à', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const fileName = file.name.replace('.txt', '');
                const lines = content.split('\n').map(line => line.trim()).filter(line => line);

                if (lines.length < 2) {
                    showMessage('È°åÂ∫´Ê†ºÂºèÈåØË™§ÔºöËá≥Â∞ëÈúÄË¶Å2ÁµÑÈÖçÂ∞çÈ†ÖÁõÆ', 'error');
                    return;
                }

                const question = 'ÈÖçÂ∞çÈ°å';
                const pairs = lines.join('\n');

                const existingIndex = matchingQuestionBanks.findIndex(bank => bank.name === fileName);
                if (existingIndex !== -1) {
                    if (confirm(`È°åÂ∫´„Äå${fileName}„ÄçÂ∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÅË¶ÜËìãÔºü`)) {
                        matchingQuestionBanks[existingIndex] = { name: fileName, question: question, pairs: pairs };
                    } else {
                        return;
                    }
                } else {
                    matchingQuestionBanks.push({ name: fileName, question: question, pairs: pairs });
                }

                updateMatchingBankList();
                showMessage(`È°åÂ∫´„Äå${fileName}„ÄçËºâÂÖ•ÊàêÂäü`, 'success');
                fileInput.value = '';
            };

            reader.onerror = function() {
                showMessage('ËÆÄÂèñÊ™îÊ°àÊôÇÁôºÁîüÈåØË™§', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function saveMatchingBank() {
            const nameInput = document.getElementById('match-bank-name-input');
            const pairsTextarea = document.getElementById('matching-pairs-textarea');

            const name = nameInput.value.trim();
            const question = 'ÈÖçÂ∞çÈ°å';
            const pairs = pairsTextarea.value.trim();

            if (!name) {
                showMessage('Ë´ãËº∏ÂÖ•È°åÂ∫´ÂêçÁ®±', 'error');
                return;
            }

            if (!pairs) {
                showMessage('ÈÖçÂ∞çÈ†ÖÁõÆ‰∏çËÉΩÁÇ∫Á©∫', 'error');
                return;
            }

            const existingIndex = matchingQuestionBanks.findIndex(bank => bank.name === name);
            if (existingIndex !== -1) {
                if (confirm(`È°åÂ∫´„Äå${name}„ÄçÂ∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÅË¶ÜËìãÔºü`)) {
                    matchingQuestionBanks[existingIndex] = { name: name, question: question, pairs: pairs };
                } else {
                    return;
                }
            } else {
                matchingQuestionBanks.push({ name: name, question: question, pairs: pairs });
            }

            updateMatchingBankList();
            showMessage(`È°åÂ∫´„Äå${name}„ÄçÂÑ≤Â≠òÊàêÂäü`, 'success');
            nameInput.value = '';
        }

        function loadMatchingBankToTextarea(index) {
            if (index >= 0 && index < matchingQuestionBanks.length) {
                const bank = matchingQuestionBanks[index];
                document.getElementById('matching-pairs-textarea').value = bank.pairs;
                showMessage(`È°åÂ∫´„Äå${bank.name}„ÄçÂ∑≤ËºâÂÖ•Âà∞Ëº∏ÂÖ•Ê°Ü`, 'success');
            }
        }

        function deleteMatchingBank(index) {
            if (index >= 0 && index < matchingQuestionBanks.length) {
                const bankName = matchingQuestionBanks[index].name;
                if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§È°åÂ∫´„Äå${bankName}„ÄçÂóéÔºü`)) {
                    matchingQuestionBanks.splice(index, 1);
                    updateMatchingBankList();
                    showMessage(`È°åÂ∫´„Äå${bankName}„ÄçÂ∑≤Âà™Èô§`, 'success');
                }
            }
        }

        // Make functions globally accessible
        window.loadSequencingBankToTextarea = loadSequencingBankToTextarea;
        window.deleteSequencingBank = deleteSequencingBank;
        window.loadMatchingBankToTextarea = loadMatchingBankToTextarea;
        window.deleteMatchingBank = deleteMatchingBank;

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        // --- Firebase Functions ---
        /**
         * NEW: (Teacher) Announces the drawn student to Firestore.
         * @param {string} studentName - The name of the student who was drawn.
         */
        async function announceDrawnStudent(studentName) {
            if (!classroomCode) return;
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            try {
                await setDoc(controlRef, {
                    lastDrawnStudent: {
                        name: studentName,
                        timestamp: new Date() // ‰ΩøÁî®Êñ∞ Date Áâ©‰ª∂‰æÜÁ¢∫‰øùÊØèÊ¨°ÈÉΩËÉΩËß∏ÁôºÁõ£ËÅΩ
                    }
                }, { merge: true });
            } catch (error) {
                console.error("Failed to announce drawn student:", error);
                showMessage("ÂÆ£Â∏ÉÊäΩÁ±§ÁµêÊûúÂ§±Êïó„ÄÇ", "error");
            }
        }
        /**
         * (Teacher) Sets the current interaction mode and clears old student response data.
         * @param {string} mode - 'true_false', 'multiple_choice', 'text_input', 'drawing', 'url_dispatch', 'recording', or 'waiting'.
         * @param {object} [options={}] - Optional settings for the mode, e.g., custom questions.
         */
        async function setInteractionMode(mode, options = {}) {
            console.log(`[üéØ Main] Setting mode to: ${mode}, currentRole: ${currentRole}, forceReset: ${options.forceReset || false}`);
            currentInteractionMode = mode;
            
            // üöÄ NEW: ÂàùÂßãÂåñÂ≠∏ÁîüÁ´ØÂúñË°®ÁÆ°ÁêÜÂô®ÔºàÂè™Âú®ÊòØÈùûÈ°åÊàñÈÅ∏ÊìáÈ°åÊôÇÔºâ
            if ((mode === 'true_false' || mode === 'multiple_choice') && currentRole === 'student') {
                console.log(`[üë®‚Äçüéì Student Chart] INIT START - mode: ${mode}, classroomCode: ${classroomCode}`);
                studentChartManager.init();
                console.log('[üë®‚Äçüéì Student Chart] Chart manager initialized');
                
                // Ë®≠ÁΩÆÂ≠∏ÁîüÁ´ØÂúñË°®Áõ£ËÅΩÂô® - Áõ£ËÅΩÊïôÂ∏´ÁöÑ„ÄåÈ°ØÁ§∫Áµ±Ë®à„ÄçÊ®ôË™å
                console.log(`[üë®‚Äçüéì Student Chart] Calling setupStudentChartListener for mode: ${mode}`);
                setupStudentChartListener(mode);
                
                // ÂàùÂßãÊôÇÈö±ËóèÂúñË°® - Á≠âÂæÖÊïôÂ∏´Êåâ„ÄåÈ°ØÁ§∫Áµ±Ë®à„Äç
                if (mode === 'true_false') {
                    const containerTf = document.getElementById('student-chart-container-tf');
                    if (containerTf) containerTf.classList.add('hidden');
                    const containerMc = document.getElementById('student-chart-container-mc');
                    if (containerMc) containerMc.classList.add('hidden');
                } else if (mode === 'multiple_choice') {
                    const containerMc = document.getElementById('student-chart-container-mc');
                    if (containerMc) containerMc.classList.add('hidden');
                    const containerTf = document.getElementById('student-chart-container-tf');
                    if (containerTf) containerTf.classList.add('hidden');
                }
            } else if (currentRole === 'student') {
                // Èö±ËóèÂúñË°®ÂÆπÂô®Â∞çÊñºÂÖ∂‰ªñÊ®°ÂºèÔºå‰∏¶Ê∏ÖÈô§Áõ£ËÅΩÂô®
                const containerTf = document.getElementById('student-chart-container-tf');
                const containerMc = document.getElementById('student-chart-container-mc');
                if (containerTf) containerTf.classList.add('hidden');
                if (containerMc) containerMc.classList.add('hidden');
                
                // Ê∏ÖÈô§ËàäÁöÑÂúñË°®Áõ£ËÅΩÂô®
                if (studentChartListenerUnsubscribe) {
                    studentChartListenerUnsubscribe();
                    studentChartListenerUnsubscribe = null;
                }
                
                // üöÄ CRITICAL: Clear old score listener when switching modes
                // Prevents ghost notifications from previous interaction mode
                if (ListenerManager.has('studentScoreUpdate')) {
                    ListenerManager.unregister('studentScoreUpdate');
                    console.log('[showInteractionUI] ‚úì Cleared old studentScoreUpdate listener for mode switch');
                }
            }
            
            // Use classroomCode in the Firestore path
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            const showStatisticsBtn = document.getElementById('show-statistics-btn');
            
            // üöÄ NEW: Setup teacher answer listener for matching and sequencing modes
            if (mode === 'matching' || mode === 'sequencing') {
                setupTeacherAnswerListener();
            }
            const downloadMediaBtn = document.getElementById('download-media-btn');
            const aiTextSummaryBtn = document.getElementById('ai-text-summary-btn');
            const showUnsubmittedStudentsBtn = document.getElementById('show-unsubmitted-students-btn'); // NEW
            const viewQuestionsBtn = document.getElementById('view-questions-btn'); // NEW
            const viewReadingQuestionsBtn = document.getElementById('view-reading-questions-btn'); // NEW
            const downloadResponsesBtn = document.getElementById('download-responses-btn'); // NEW
            const showMatchingAnswerBtn = document.getElementById('show-matching-answer-btn'); // NEW
            const showSequencingAnswerBtn = document.getElementById('show-sequencing-answer-btn'); // NEW

            // MODIFIED: Show statistics button for true_false, multiple_choice, and reading_comprehension
            showStatisticsBtn.classList.toggle('hidden', mode !== 'true_false' && mode !== 'multiple_choice' && mode !== 'reading_comprehension');
            
            // NEW: Show answer buttons for matching and sequencing modes
            showMatchingAnswerBtn.classList.toggle('hidden', mode !== 'matching');
            showSequencingAnswerBtn.classList.toggle('hidden', mode !== 'sequencing');

            // NEW: Show view questions button only for multiple_choice with custom questions
            const hasCustomQuestions = mode === 'multiple_choice' && options.customQuestions && options.customQuestions.length > 0;
            viewQuestionsBtn.classList.toggle('hidden', !hasCustomQuestions);

            // NEW: Show view reading questions button only for reading_comprehension
            viewReadingQuestionsBtn.classList.toggle('hidden', mode !== 'reading_comprehension');
            
            // üöÄ NEW: Show rescore all students button only for reading_comprehension
            const rescoreAllStudentsBtn = document.getElementById('rescore-all-students-btn');
            rescoreAllStudentsBtn.classList.toggle('hidden', mode !== 'reading_comprehension');
            
            // NEW: Show peer review button only for text_input and drawing modes
            const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
            startPeerReviewBtn.classList.toggle('hidden', mode !== 'text_input' && mode !== 'drawing');
            
            // NEW: Reset peer review button state when starting new interaction
            if (mode !== 'waiting') {
                peerReviewActive = false;
                startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> ÈñãÂßã‰∫íË©ï ‚ù§Ô∏è';
                document.getElementById('peer-review-stats-container').classList.add('hidden');
                
                // Reset peer review status in Firebase for new interaction
                const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                setDoc(peerReviewRef, { active: false }).catch(error => {
                    console.error('Error resetting peer review status:', error);
                });
                
                // Clear student voting history for new interaction
                studentVotedWorks.clear();
                
                // Clear saved canvas state for new interaction
                savedCanvasState = null;
            }
            downloadMediaBtn.classList.toggle('hidden', mode !== 'drawing' && mode !== 'recording');
            aiTextSummaryBtn.classList.toggle('hidden', mode !== 'text_input');
            // NEW: Show unsubmitted students button for specific modes
            showUnsubmittedStudentsBtn.classList.toggle('hidden', mode === 'waiting' || mode === 'url_dispatch');
            // NEW: Show download responses button for text_input, multiple_choice with custom questions, and reading_comprehension
            const showDownloadBtn = mode === 'text_input' || (mode === 'multiple_choice' && hasCustomQuestions) || mode === 'reading_comprehension';
            downloadResponsesBtn.classList.toggle('hidden', !showDownloadBtn);


            // NEW: Hide pause button for URL/HTML dispatch modes
            const togglePauseBtn = document.getElementById('toggle-pause-btn');
            togglePauseBtn.classList.toggle('hidden', mode === 'url_dispatch');


            try {
                // Clear previous student responses unless it's a waiting state.
                if (mode !== 'waiting') {
                    const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                    const querySnapshot = await getDocs(studentsColRef);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    console.log("[Teacher] Cleared all previous student responses.");
                    lastSelectedStudentCard = null; // Clear highlight on monitor view
                }

                // Prepare data payload for Firestore.
                const payload = { 
                    active_mode: mode,
                    backgroundImage: teacherUploadedBackgroundImageDataURL || null,
                    teacherId: userId, // Store teacher ID
                    isPaused: isResponsePaused, // Use current local pause state
                    lastDrawnStudent: null, // <-- Âú®Ê≠§Êñ∞Â¢û (Ê∏ÖÈô§‰∏äÊ¨°ÊäΩÁ±§Á¥ÄÈåÑ)
                    showMatchingAnswer: false, // Reset matching answer display
                    showSequencingAnswer: false, // Reset sequencing answer display
                    // üöÄ NEW: Force UI reset with monotonic token when options.forceReset is true
                    modeResetToken: options.forceReset ? Date.now() : (window.lastModeResetToken || 0)
                };
                
                // Store the token globally for comparison
                window.lastModeResetToken = payload.modeResetToken;

                // MODIFIED: Add combined dispatch settings if in that mode.
                if (mode === 'url_dispatch') {
                    payload.dispatchSettings = dispatchSettings; // Send the entire dispatchSettings object
                } else {
                    payload.dispatchSettings = null; // Clear dispatch settings if not in URL_DISPATCH mode
                }

                // NEW: Add custom multiple choice questions if in that mode.
                // If mode is multiple_choice and options.customQuestions is explicitly null, it means no custom questions.
                if (mode === 'multiple_choice' && options.hasOwnProperty('customQuestions')) {
                    payload.multiple_choice_questions = options.customQuestions;
                } else {
                    payload.multiple_choice_questions = null; // Clear if not multiple_choice mode or if customQuestions not provided
                }
                currentMultipleChoiceQuestions = payload.multiple_choice_questions; // Update global for teacher monitor

                // NEW: Add sequencing settings if in that mode
                if (mode === 'sequencing' && options.question && options.correctOrder) {
                    payload.sequencingSettings = {
                        question: options.question,
                        correctOrder: options.correctOrder
                    };
                } else {
                    payload.sequencingSettings = null;
                }

                // NEW: Add matching settings if in that mode
                if (mode === 'matching' && options.question && options.pairs) {
                    payload.matchingSettings = {
                        question: options.question,
                        pairs: options.pairs
                    };
                } else {
                    payload.matchingSettings = null;
                }

                // NEW: Add reading comprehension data if in that mode
                if (mode === 'reading_comprehension' && options.readingData) {
                    payload.readingComprehensionData = options.readingData;
                    // üöÄ CRITICAL FIX: Use serverTimestamp() to ensure all students receive identical unified timer
                    payload.readingStartedAt = serverTimestamp();
                    console.log('[setInteractionMode] ‚úÖ readingStartedAt set to serverTimestamp() for synchronized 180-second countdown');
                    // üöÄ CRITICAL FIX: ÂêåÊôÇË®≠ÁΩÆÂÖ®Â±ÄËÆäÈáèÔºåÁ¢∫‰øùÁõ£ËÅΩÂô®ÂèØ‰ª•Á´ãÂç≥Ë®™Âïè
                    readingComprehensionData = options.readingData;
                    console.log('[setInteractionMode] ‚úì readingComprehensionData set globally (reading comprehension mode)');
                    console.log('[setInteractionMode] üìä Payload being sent to Firestore:', JSON.stringify({
                        readingComprehensionData: !!payload.readingComprehensionData,
                        readingStartedAt: '‚úì serverTimestamp()',
                        mode: mode
                    }));
                } else {
                    payload.readingComprehensionData = null;
                    payload.readingStartedAt = null;
                    if (mode !== 'reading_comprehension') {
                        readingComprehensionData = {}; // Ê∏ÖÁ©∫‰ΩÜ‰∏çÂà™Èô§ÂÖ®Â±ÄËÆäÈáè
                    }
                }

                await setDoc(controlRef, payload, { merge: true });

                // Handle student responses listener based on mode
                if (studentResponsesUnsubscribe) {
                    studentResponsesUnsubscribe();
                    studentResponsesUnsubscribe = null;
                }

                if (mode === 'url_dispatch') { // Now handles both URL and HTML
                    // For URL/HTML dispatch, listen to student submissions for real-time distraction updates
                    listenToStudentSubmissions(mode);
                } else if (mode === 'waiting') {
                    // When going to 'waiting' mode, ensure the student responses container is cleared
                    // and shows the "waiting" message.
                    document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">Ê≠£Âú®Á≠âÂæÖÂ≠∏Áîü‰ΩúÁ≠î...</p>';
                } else if (mode === 'reading_comprehension') {
                    // üöÄ FIXED: ÊïôÂ∏´Á´ØËÆÄÈ°åÊ®°ÂºèÁèæÂú®‰ΩøÁî® listenToStudentSubmissions ‰æÜÂç≥ÊôÇÁõ£ÊéßÂ≠∏ÁîüÂç°Áâá + ÊéíË°åÊ¶ú
                    console.log('[Teacher] Setting up reading comprehension listener (student cards + leaderboard)');
                    // üöÄ CRITICAL FIX: Á¢∫‰øù readingComprehensionData ÂÖ®Â±ÄËÆäÈáèË¢´Ë®≠ÁΩÆ
                    if (options.readingData) {
                        readingComprehensionData = options.readingData;
                        console.log('[Teacher] ‚úì readingComprehensionData set from options:', readingComprehensionData);
                    } else {
                        console.warn('[Teacher] ‚ö†Ô∏è readingData not provided in options');
                    }
                    // Ê∏ÖÈô§ËàäÁöÑÂ≠∏ÁîüÂç°ÁâáÂÆπÂô®
                    document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">Á≠âÂæÖÂ≠∏ÁîüÂä†ÂÖ•...</p>';
                    
                    // üöÄ CRITICAL FIX: **Âº∑Âà∂ÈáçÊñ∞Ë®ªÂÜä** presence Áõ£ËÅΩÂô®‰∏¶ **Á≠âÂæÖÈ¶ñÊ¨°Âø´ÁÖßÂÆåÊàê**
                    console.log('[Teacher] üîç Step 1: Force re-registering presence listener for reading comprehension');
                    if (ListenerManager.has('classroomPresence')) {
                        ListenerManager.unregister('classroomPresence');
                        console.log('[Teacher] ‚úì Unregistered old presence listener');
                    }
                    
                    // Á≠âÂæÖ presence Áõ£ËÅΩÂô®ÂÆåÊàêÈ¶ñÊ¨°Âø´ÁÖßÔºàÁ¢∫‰øù activeStudentsPresenceMap Â∑≤Â°´ÂÖÖÔºâ
                    await listenToClassroomPresence(); 
                    console.log('[Teacher] ‚úÖ Presence listener initialized, activeStudentsPresenceMap populated');
                    
                    // üöÄ KEY FIX: ÁèæÂú®ÂèØ‰ª•ÂÆâÂÖ®Âú∞Âª∫Á´ãÂ≠∏ÁîüÊèê‰∫§Áõ£ËÅΩÂô®Ôºàpresence Êï∏ÊìöÂ∑≤Â∞±Á∑íÔºâ
                    console.log('[Teacher] üîç Step 2: Setting up student submissions listener for reading comprehension');
                    listenToStudentSubmissions(mode);
                } else { // For other interaction modes (true_false, multiple_choice, text_input, drawing, recording, quick_answer)
                    // üöÄ OPTIMIZED: Á¢∫‰øùÊâÄÊúâÊ®°ÂºèÈÉΩÊúâ presence Áõ£ËÅΩÂô®ÔºàÂàùÊ¨°ÈÄ≤ÂÖ•ÊôÇË®ªÂÜäÔºåÂæåÁ∫åÊ®°ÂºèÂàáÊèõÊôÇ‰øùÊåÅÔºâ
                    if (!ListenerManager.has('classroomPresence')) {
                        console.log('[Teacher] üîç Initializing presence listener for mode:', mode);
                        listenToClassroomPresence();
                    }
                    listenToStudentSubmissions(mode); // Ensure this listener is active
                }

            } catch (error) {
                console.error("Ë®≠ÂÆö‰∫íÂãïÊ®°ÂºèÊàñÊ∏ÖÈô§Â≠∏ÁîüË≥áÊñôÂ§±Êïó:", error);
                showMessage("Êìç‰ΩúÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñËÅØÁπ´ÁÆ°ÁêÜÂì°„ÄÇ", "error");
            }
        }

        /**
         * üöÄ NEW: (Teacher) Êõ¥Êñ∞ÂØ¶ÊôÇÁãÄÊÖãÂÑÄË°®Êùø - Êèê‰∫§ÈÄ≤Â∫¶Ê¢ù„ÄÅÂú®Á∑öÂ≠∏ÁîüË®àÊï∏„ÄÅÂàÜÂøÉÊèêÈÜí
         * @param {string} mode - Áï∂Ââç‰∫íÂãïÊ®°Âºè
         */
        function updateTeacherDashboard(mode) {
            try {
                // Âè™Âú®ÊïôÂ∏´ËßíËâ≤ÂíåÁõ£ÊéßË¶ñÂúñ‰∏≠Êõ¥Êñ∞
                if (currentRole !== 'teacher') return;
                
                const dashboard = document.getElementById('teacher-dashboard');
                if (!dashboard || dashboard.classList.contains('hidden')) return;
                
                // === 1. Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ùÔºöÂ∑≤Êèê‰∫§/Êú™Êèê‰∫§ ===
                let submittedCount = 0;
                let totalStudents = activeStudentNames.length;
                
                if (allStudentResponses && allStudentResponses.length > 0) {
                    submittedCount = allStudentResponses.filter(r => r.answer !== null && r.answer !== undefined).length;
                }
                
                const submissionPercentage = totalStudents > 0 ? Math.round((submittedCount / totalStudents) * 100) : 0;
                
                // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù DOM
                const progressBar = document.getElementById('submission-progress-bar');
                const progressPercentage = document.getElementById('submission-percentage');
                const submittedCountSpan = document.getElementById('submitted-count');
                const totalStudentsSpan = document.getElementById('total-students');
                
                if (progressBar) {
                    progressBar.style.width = submissionPercentage + '%';
                    progressBar.innerHTML = `<span class="text-xs font-bold text-white">${submittedCount}/${totalStudents}</span>`;
                }
                if (progressPercentage) progressPercentage.textContent = submissionPercentage + '%';
                if (submittedCountSpan) submittedCountSpan.textContent = submittedCount;
                if (totalStudentsSpan) totalStudentsSpan.textContent = totalStudents;
                
                // === 2. Êõ¥Êñ∞Âú®Á∑öÂ≠∏ÁîüË®àÊï∏ ===
                const onlineCount = activeStudentNames.length;
                const offlineCount = Math.max(0, totalStudents - onlineCount);
                
                const onlineCountSpan = document.getElementById('online-student-count');
                const totalJoinedSpan = document.getElementById('total-joined-count');
                const offlineCountSpan = document.getElementById('offline-count');
                const onlineProgressBar = document.getElementById('online-student-progress');
                
                if (onlineCountSpan) onlineCountSpan.textContent = onlineCount;
                if (totalJoinedSpan) totalJoinedSpan.textContent = `ÂÖ± ${totalStudents} ‰∫∫Âä†ÂÖ•`;
                if (offlineCountSpan) {
                    offlineCountSpan.textContent = `${offlineCount} ‰∫∫Èõ¢Á∑ö`;
                    offlineCountSpan.style.display = offlineCount > 0 ? 'block' : 'none';
                }
                
                // üöÄ NEW: Êõ¥Êñ∞Âú®Á∑öÂ≠∏ÁîüÈÄ≤Â∫¶Ê¢ù
                if (onlineProgressBar && totalStudents > 0) {
                    const onlinePercentage = Math.round((onlineCount / totalStudents) * 100);
                    onlineProgressBar.style.width = onlinePercentage + '%';
                }
                
                // === 3. Êõ¥Êñ∞ÂàÜÂøÉÂ≠∏ÁîüÊèêÈÜí ===
                let distractedCount = 0;
                const distractedStudentsList = document.getElementById('distracted-students-list');
                if (distractedStudentsList) {
                    const distractedStudents = [];
                    
                    // ÈÅçÊ≠∑ÊâÄÊúâÂú®Á∑öÂ≠∏ÁîüÔºåÊâæÂá∫ÂàÜÂøÉÁöÑ
                    activeStudentNames.forEach(studentName => {
                        const presenceData = activeStudentsPresenceMap.get(studentName);
                        if (presenceData && presenceData.isDistracted) {
                            distractedStudents.push({
                                name: studentName,
                                count: presenceData.distractionCount || 0
                            });
                        }
                    });
                    
                    distractedCount = distractedStudents.length;
                    
                    if (distractedStudents.length === 0) {
                        distractedStudentsList.innerHTML = '<p class="text-gray-500">Êö´ÁÑ°ÂàÜÂøÉÂ≠∏Áîü</p>';
                    } else {
                        // ÊåâÂàÜÂøÉÊ¨°Êï∏ÈôçÂ∫èÊéíÂ∫è
                        distractedStudents.sort((a, b) => b.count - a.count);
                        
                        // üöÄ PRIVACY FIX: Èö±ÂØÜÈ°ØÁ§∫ÂàÜÂøÉ‰ø°ÊÅØ - Âè™È°ØÁ§∫ÂêçÂ≠óÔºå‰∏çÈ°ØÁ§∫ÂÖ∑È´îÊ¨°Êï∏ÔºåÈò≤Ê≠¢Â≠∏ÁîüÁúãÂà∞ÈÅäÁé©ÂøÉÊÖãÂàÜÂøÉ
                        let html = '<div class="space-y-1">';
                        distractedStudents.forEach((student, idx) => {
                            // Áî®ÂúñÊ®ôË°®Á§∫Âö¥ÈáçÁ®ãÂ∫¶Ôºöüî¥ ÊúÄÂö¥ÈáçÔºàÁ¨¨‰∏Ä‰ΩçÔºâÔºåüü° ÂÖ∂‰ªñÔºàÈöêÂØÜÊòæÁ§∫Ôºå‰∏çÊòæÁ§∫Êï∞Â≠óÔºâ
                            const icon = idx === 0 ? 'üî¥' : 'üü°'; 
                            html += `
                                <div class="flex items-center p-1.5 bg-yellow-100 rounded border-l-2 border-orange-500">
                                    <span class="font-semibold text-sm">${icon} ${student.name}</span>
                                </div>
                            `;
                        });
                        html += '</div>';
                        distractedStudentsList.innerHTML = html;
                        
                        // üöÄ NEW: Â¶ÇÊûúÊúâÊñ∞ÂàÜÂøÉÂ≠∏ÁîüÔºåÊí≠ÊîæÊèêÈÜíËÅ≤Èü≥ÔºàÂèØÈÅ∏Ôºâ
                        if (distractedStudents.length > 0) {
                            const alert = document.getElementById('distraction-alert');
                            alert.classList.remove('ring-0');
                            alert.classList.add('ring-2', 'ring-orange-500');
                            console.log(`[Dashboard] ‚ö†Ô∏è ${distractedStudents.length} ‰ΩçÂ≠∏ÁîüÊ≠£Âú®ÂàÜÂøÉÔºàË©≥Á¥∞ÂàÜÂøÉÊ¨°Êï∏Èö±ÂØÜ‰ª•Èò≤ÈÅäÁé©Ôºâ`);
                        }
                    }
                }
                
                console.log(`[Dashboard] ‚úÖ Updated - Submitted: ${submittedCount}/${totalStudents} (${submissionPercentage}%), Online: ${onlineCount}, Distracted: ${distractedCount}`);
                
            } catch (error) {
                console.error('[Dashboard] Error updating dashboard:', error);
            }
        }

        /**
         * üöÄ NEW: (Teacher) Show confirmation dialog before switching mode
         * Prevents accidental mode switches and data loss
         * @param {string} newMode - The mode to switch to
         * @param {function} onConfirm - Callback function if confirmed
         */
        function showModeConfirmationDialog(newMode, onConfirm) {
            const modeNames = {
                'true_false': 'ÊòØÈùûÈ°å',
                'multiple_choice': 'Ë§áÈÅ∏È°å',
                'quick_answer': 'Âø´ÈÄüÊê∂Á≠î',
                'drawing_board': 'Áπ™ÂúñÊùø',
                'peer_review': '‰∫íË©ïÊäïÁ•®',
                'sequencing': 'ÊéíÂ∫èÈ°å',
                'matching': 'ÈÖçÂ∞çÈ°å',
                'reading_comprehension': 'Èñ±ËÆÄÊ∏¨È©ó',
                'waiting': 'Á≠âÂæÖ‰∏≠'
            };
            
            const modeLabel = modeNames[newMode] || newMode;
            
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDialog.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-11/12">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-exclamation-circle text-orange-500 mr-2"></i>Á¢∫Ë™çÂàáÊèõÊ®°Âºè
                    </h3>
                    <p class="text-gray-700 mb-6">
                        ÊÇ®Âç≥Â∞áÂàáÊèõËá≥ <span class="font-bold text-blue-600">${modeLabel}</span> Ê®°Âºè„ÄÇ
                        <br><br>
                        Áï∂ÂâçÊ®°ÂºèÁöÑÂ≠∏ÁîüÂõûÊáâÂ∞áË¢´‰øùÂ≠ò„ÄÇÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü
                    </p>
                    <div class="flex gap-3">
                        <button class="btn btn-primary flex-1">
                            <i class="fas fa-check mr-2"></i> Á¢∫Ë™çÂàáÊèõ
                        </button>
                        <button class="btn bg-gray-500 hover:bg-gray-600 flex-1">
                            <i class="fas fa-times mr-2"></i> ÂèñÊ∂à
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            const buttons = confirmDialog.querySelectorAll('button');
            buttons[0].addEventListener('click', () => {
                confirmDialog.remove();
                if (onConfirm) onConfirm();
                showMessage(`‚úÖ Â∑≤ÂàáÊèõËá≥ ${modeLabel} Ê®°Âºè`, 'success');
            });
            buttons[1].addEventListener('click', () => {
                confirmDialog.remove();
                showMessage('Â∑≤ÂèñÊ∂àÂàáÊèõÊ®°Âºè', 'info');
            });
            
            confirmDialog.addEventListener('click', (e) => {
                if (e.target === confirmDialog) {
                    confirmDialog.remove();
                    showMessage('Â∑≤ÂèñÊ∂àÂàáÊèõÊ®°Âºè', 'info');
                }
            });
        }

        /**
         * üöÄ NEW: (Teacher) È°ØÁ§∫Ë™≤Â†Ç QR Code Ê®°ÊÖãÊ°Ü
         * Áî®ÊñºÂø´ÈÄüÊéÉÊèèÈÄ≤ÂÖ•ÊïôÂÆ§ÔºåÁÑ°ÈúÄÊâãÂãïËº∏ÂÖ•Ë™≤Â†ÇÁ¢º
         */
        function showQRCodeModal() {
            const modal = document.getElementById('qrcode-modal');
            const container = document.getElementById('qrcode-container');
            const classroomCodeSpan = document.getElementById('qrcode-classroom-code');
            
            if (!classroomCode) {
                showMessage('Â∞öÊú™Ë®≠ÂÆöË™≤Â†Ç‰ª£Á¢ºÔºåË´ãÂÖàÈñãÂßã‰∏äË™≤', 'error');
                return;
            }
            
            // Ê∏ÖÁ©∫ËàäÁöÑ QR Code
            container.innerHTML = '';
            
            // Ë®≠ÁΩÆË™≤Â†Ç‰ª£Á¢ºÊñáÂ≠ó
            classroomCodeSpan.textContent = classroomCode;
            
            // ÁîüÊàê QR Code - ‰ΩøÁî®Ë™≤Â†Ç‰ª£Á¢º‰ΩúÁÇ∫ÂÖßÂÆπ
            // Ê†ºÂºèÔºöË™≤Â†ÇÁ¢ºÔºåÁî®Êà∂ÈÄöÈÅéÊéÉÊèèÂèØÂø´ÈÄüÈÄ≤ÂÖ•
            const qrUrl = `${window.location.origin}${window.location.pathname}?classroom=${classroomCode}`;
            
            try {
                new QRCode(container, {
                    text: qrUrl,
                    width: 250,
                    height: 250,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                console.log('[QRCode] ‚úÖ Ë™≤Â†Ç QR Code Â∑≤ÁîüÊàê');
            } catch (error) {
                console.error('[QRCode] ‚ùå QR Code ÁîüÊàêÂ§±Êïó:', error);
                showMessage('QR Code ÁîüÊàêÂ§±ÊïóÔºåË´ãÈáçË©¶', 'error');
                return;
            }
            
            // È°ØÁ§∫Ê®°ÊÖãÊ°Ü
            modal.classList.remove('hidden');
        }

        /**
         * üöÄ NEW: (Teacher) ÈóúÈñâ QR Code Ê®°ÊÖãÊ°Ü
         */
        function closeQRCodeModal() {
            const modal = document.getElementById('qrcode-modal');
            modal.classList.add('hidden');
        }

        /**
         * üöÄ NEW: (Teacher) ‰∏ãËºâ QR Code ÁÇ∫ÂúñÁâá
         */
        function downloadQRCode() {
            const container = document.getElementById('qrcode-container');
            const canvas = container.querySelector('canvas');
            
            if (!canvas) {
                showMessage('QR Code Â∞öÊú™ÁîüÊàê', 'error');
                return;
            }
            
            try {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `classroom-qrcode-${classroomCode}-${new Date().toISOString().split('T')[0]}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showMessage('QR Code Â∑≤‰∏ãËºâ', 'success');
                });
            } catch (error) {
                console.error('[QRCode] ‰∏ãËºâÂ§±Êïó:', error);
                showMessage('‰∏ãËºâ QR Code Â§±Êïó', 'error');
            }
        }

        /**
         * NEW: (Student) Displays the lottery winner in an overlay.
         * @param {string} winnerName - The name of the student who was drawn.
         */
         function showLotteryWinner(winnerName) {
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®‰∏ÄÂÄãÊäΩÁ±§ÁµêÊûúÁöÑÁï´Èù¢
            let overlay = document.getElementById('lottery-winner-overlay');
            if (overlay) overlay.remove(); // ÁßªÈô§ËàäÁöÑ

            overlay = document.createElement('div');
            overlay.id = 'lottery-winner-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.5s ease-in-out;
            `;

            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ëá™Â∑±Ë¢´ÊäΩ‰∏≠
            const isWinner = (winnerName === studentName);
            const winnerMessage = isWinner ? "ÊÅ≠Âñú‰Ω†Ë¢´ÊäΩ‰∏≠‰∫ÜÔºÅ" : `ÊäΩ‰∏≠‰∫ÜÔºö ${winnerName}`;
            const iconColor = isWinner ? '#4ade80' : '#60a5fa'; // Á∂†Ëâ≤ (Ëá™Â∑±) Êàñ ËóçËâ≤ (Âà•‰∫∫)

            overlay.innerHTML = `
                <div style="text-align: center; color: white; font-size: 3rem; font-weight: bold;">
                    <i class="fas fa-dice" style="color: ${iconColor}; font-size: 6rem; margin-bottom: 20px;"></i>
                    <h1 style="margin: 20px 0; color: white;">${winnerMessage}</h1>
                    <p style="font-size: 1.5rem; color: #d1d5db;">ÈªûÊìä‰ªªÊÑè‰ΩçÁΩÆÈóúÈñâ</p>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; transform: scale(0.8); }
                        to { opacity: 1; transform: scale(1); }
                    }
                </style>
            `;

            overlay.addEventListener('click', () => {
                overlay.remove();
            });

            document.body.appendChild(overlay);

            // 5 ÁßíÂæåËá™ÂãïÈóúÈñâ
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.remove();
                }
            }, 5000);
        }

        /**
         * NEW: (Student) Listens for lottery results from the teacher.
         * üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager ÁÆ°ÁêÜÁõ£ËÅΩÂô®
         */
        function listenToLottery() {
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            let lastTimestamp = null; // Áî®ÊñºÈò≤Ê≠¢ÈáçË§áÈ°ØÁ§∫Âêå‰∏ÄÂÄãÊäΩÁ±§ÁµêÊûú

            const unsubscribe = onSnapshot(controlRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const drawnStudent = data.lastDrawnStudent;

                    if (drawnStudent && drawnStudent.name) {
                        // ËΩâÊèõ Firestore ÊôÇÈñìÊà≥
                        const eventTimestamp = drawnStudent.timestamp?.toMillis(); 
                        
                        // Ê™¢Êü•ÈÄôÊòØÂê¶ÊòØ‰∏ÄÂÄãÊñ∞ÁöÑÊäΩÁ±§‰∫ã‰ª∂
                        if (eventTimestamp && eventTimestamp !== lastTimestamp) {
                            lastTimestamp = eventTimestamp;
                            
                            // üöÄ FIX: ÁßªÈô§Êê∂Á≠îÊ®°ÂºèÁöÑÈôêÂà∂ÔºåËÆìÊâÄÊúâÊ®°ÂºèÈÉΩËÉΩÈ°ØÁ§∫ÊäΩÁ±§ÁµêÊûú
                            console.log('[Lottery] Showing lottery winner:', drawnStudent.name);
                            showLotteryWinner(drawnStudent.name);
                        }
                    }
                }
            });
            
            // ‰ΩøÁî® ListenerManager Ë®ªÂÜäÁõ£ËÅΩÂô®
            ListenerManager.register('lottery', unsubscribe);
            // ÂêåÊôÇ‰øùÁïôËàäËÆäÊï∏‰ª•‰øùÊåÅÂÖºÂÆπÊÄß
            lotteryUnsubscribe = unsubscribe;
        }

        /**
         * NEW: (Student) Monitors student attention by detecting page visibility changes and window blur/focus events.
         * When student switches tabs or navigates away, their distraction status is updated in Firebase.
         */
        async function startStudentAttentionMonitoring() {
            if (!studentName || !userId || !classroomCode) {
                console.warn('[Attention] Cannot start monitoring: student info not set');
                return;
            }

            // Èò≤Ê≠¢ÈáçË§áË®ªÂÜäÁõ£ËÅΩÂô®
            if (attentionMonitoringActive) {
                console.log('[Attention] Monitoring already active, skipping duplicate registration');
                return;
            }

            console.log('[Attention] Starting student attention monitoring for:', studentName);
            
            // ÂàùÂßãÂåñÁãÄÊÖãËÆäÈáèÔºàÂÖàË®≠ÁΩÆÔºåÁ¢∫‰øù‰∫ã‰ª∂Áõ£ËÅΩÂô®ÂèØ‰ª•‰ΩøÁî®Ôºâ
            isStudentCurrentlyDistracted = false;
            studentDistractionCount = 0;
            attentionMonitoringActive = true;

            // Êõ¥Êñ∞ÂàÜÂøÉÁãÄÊÖãÂà∞ Firebase
            const updateDistractionStatus = async (isDistracted) => {
                try {
                    // üöÄ FIX: ÂØ´ÂÖ• presence ÈõÜÂêàÔºåËÄå‰∏çÊòØ studentResponses ÈõÜÂêà
                    const presenceRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence', userId);
                    
                    if (isDistracted && !isStudentCurrentlyDistracted) {
                        // Â≠∏ÁîüÂâõÈñãÂßãÂàÜÂøÉ
                        studentDistractionCount++;
                        isStudentCurrentlyDistracted = true;
                        
                        await setDoc(presenceRef, {
                            name: studentName,
                            isDistracted: true,
                            distractionCount: studentDistractionCount,
                            lastDistractionTime: new Date(),
                            timestamp: new Date()
                        }, { merge: true });
                        
                        console.log(`[Attention] ‚úÖ Student ${studentName} is distracted (count: ${studentDistractionCount})`);
                        console.log(`[Attention] Firebase presence updated with isDistracted: true`);
                    } else if (!isDistracted && isStudentCurrentlyDistracted) {
                        // Â≠∏ÁîüÂõûÂà∞È†ÅÈù¢
                        isStudentCurrentlyDistracted = false;
                        
                        await setDoc(presenceRef, {
                            name: studentName,
                            isDistracted: false,
                            distractionCount: studentDistractionCount,
                            returnTime: new Date(),
                            timestamp: new Date()
                        }, { merge: true });
                        
                        console.log(`[Attention] ‚úÖ Student ${studentName} returned to page`);
                        console.log(`[Attention] Firebase presence updated with isDistracted: false`);
                    } else {
                        console.log(`[Attention] No state change - isDistracted: ${isDistracted}, current: ${isStudentCurrentlyDistracted}`);
                    }
                } catch (error) {
                    console.error('[Attention] ‚ùå Failed to update distraction status:', error);
                }
            };

            // üöÄ FIX: ÂÖàÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            if (attentionVisibilityHandler) {
                document.removeEventListener('visibilitychange', attentionVisibilityHandler);
            }
            if (attentionBlurHandler) {
                window.removeEventListener('blur', attentionBlurHandler);
            }
            if (attentionFocusHandler) {
                window.removeEventListener('focus', attentionFocusHandler);
            }
            
            // üöÄ FIX: ‰øùÂ≠ò‰∫ã‰ª∂ËôïÁêÜÁ®ãÂ∫èÁöÑÂºïÁî®Ôºå‰ª•‰æøË¢´Ë∏¢Âá∫ÊôÇËÉΩÂ§†ÁßªÈô§
            attentionVisibilityHandler = () => {
                if (!attentionMonitoringActive || !classroomCode) return; // üöÄ GUARD: Â¶ÇÊûúÂ∑≤ÂÅúÊ≠¢Áõ£ÊéßÊàñÁÑ°Ë™≤Â†ÇÁ¢ºÂâáË∑≥ÈÅé
                const hidden = document.hidden;
                console.log(`[Attention] üìã visibilitychange event - document.hidden: ${hidden}`);
                if (hidden) {
                    console.log('[Attention] üî¥ Page hidden - student switched tab or minimized window');
                    updateDistractionStatus(true);
                } else {
                    console.log('[Attention] üü¢ Page visible - student returned to tab');
                    updateDistractionStatus(false);
                }
            };
            
            attentionBlurHandler = () => {
                if (!attentionMonitoringActive || !classroomCode) return; // üöÄ GUARD
                console.log('[Attention] üî¥ Window blur - student switched to another window');
                updateDistractionStatus(true);
            };
            
            attentionFocusHandler = () => {
                if (!attentionMonitoringActive || !classroomCode) return; // üöÄ GUARD
                console.log('[Attention] üü¢ Window focus - student returned to window');
                updateDistractionStatus(false);
            };

            // Áõ£ËÅΩÈ†ÅÈù¢ÂèØË¶ãÊÄßËÆäÂåñÔºàÂàÜÈ†ÅÂàáÊèõÔºâ- Chrome/Edge/Firefox ÊîØÊè¥
            document.addEventListener('visibilitychange', attentionVisibilityHandler);

            // Áõ£ËÅØË¶ñÁ™óÂ§±ÁÑ¶/Áç≤ÂæóÁÑ¶ÈªûÔºàÂàáÊèõÂà∞ÂÖ∂‰ªñÊáâÁî®Á®ãÂºèÔºâ
            window.addEventListener('blur', attentionBlurHandler);
            window.addEventListener('focus', attentionFocusHandler);

            // üöÄ FIX: ÂàùÂßãÂåñ presence ÊñáÊ™îÔºåÁ¢∫‰øùÂ≠∏ÁîüÂâõÂä†ÂÖ•ÊôÇÂ∞±ËÉΩË¢´ÊïôÂ∏´Á´ØÁõ£Êéß
            // üöÄ CRITICAL FIX: ÂâµÂª∫ÊôÇÈñìÂêåÊ≠• PromiseÔºå‰æõË®àÊôÇÂô®‰ΩøÁî®
            let resolveTimeSync;
            window.serverTimeSyncPromise = new Promise((resolve) => {
                resolveTimeSync = resolve;
            });
            
            try {
                const presenceRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence', userId);
                
                // üöÄ CRITICAL FIX: Ë®àÁÆó‰º∫ÊúçÂô®ÊôÇÈñìÂÅèÁßªÈáèÔºåÁî®ÊñºÊ†°Ê≠£Èñ±ËÆÄÊ∏¨È©óË®àÊôÇÂô®
                // Ê≠•È©ü 1: Ë®òÈåÑÊú¨Âú∞ÊôÇÈñì T1ÔºåÂØ´ÂÖ• serverTimestamp
                const localTimeBeforeWrite = Date.now();
                await setDoc(presenceRef, {
                    name: studentName,
                    isDistracted: false,
                    distractionCount: 0,
                    joinTime: new Date(),
                    timestamp: new Date(),
                    serverSyncTime: serverTimestamp()
                }, { merge: true });
                
                // Ê≠•È©ü 2: ËÆÄÂèñ‰º∫ÊúçÂô®ÊôÇÈñìÊà≥ÔºåË®àÁÆóÂÅèÁßªÈáè
                const presenceDoc = await getDoc(presenceRef);
                if (presenceDoc.exists()) {
                    const data = presenceDoc.data();
                    if (data.serverSyncTime) {
                        const serverTime = data.serverSyncTime.toMillis ? data.serverSyncTime.toMillis() : data.serverSyncTime.getTime();
                        const localTimeAfterRead = Date.now();
                        // ‰º∞Ë®àÁ∂≤Ë∑ØÂª∂ÈÅ≤ÔºàÂæÄËøîÊôÇÈñìÁöÑ‰∏ÄÂçäÔºâ
                        const networkLatency = (localTimeAfterRead - localTimeBeforeWrite) / 2;
                        // Ë®àÁÆóÂÅèÁßªÈáèÔºö‰º∫ÊúçÂô®ÊôÇÈñì - Êú¨Âú∞ÊôÇÈñìÔºàËÄÉÊÖÆÁ∂≤Ë∑ØÂª∂ÈÅ≤Ôºâ
                        window.serverTimeOffset = serverTime - (localTimeBeforeWrite + networkLatency);
                        window.serverTimeOffsetReady = true; // ÊòéÁ¢∫Ê®ôË®òÂÅèÁßªÈáèÂ∑≤Â∞±Á∑í
                        console.log(`[TimeSync] ‚úÖ ‰º∫ÊúçÂô®ÊôÇÈñìÂÅèÁßªÈáèË®àÁÆóÂÆåÊàê:`);
                        console.log(`[TimeSync]   - Êú¨Âú∞ÊôÇÈñì: ${new Date(localTimeBeforeWrite).toISOString()}`);
                        console.log(`[TimeSync]   - ‰º∫ÊúçÂô®ÊôÇÈñì: ${new Date(serverTime).toISOString()}`);
                        console.log(`[TimeSync]   - Á∂≤Ë∑ØÂª∂ÈÅ≤: ${networkLatency.toFixed(0)}ms`);
                        console.log(`[TimeSync]   - ÂÅèÁßªÈáè: ${window.serverTimeOffset.toFixed(0)}ms (${(window.serverTimeOffset / 1000).toFixed(1)}Áßí)`);
                        console.log(`[TimeSync]   - Ë™™Êòé: Ê≠£ÂÄº=Êú¨Âú∞ÊôÇÈñìÊÖ¢Êñº‰º∫ÊúçÂô®ÔºåË≤†ÂÄº=Êú¨Âú∞ÊôÇÈñìÂø´Êñº‰º∫ÊúçÂô®`);
                        resolveTimeSync({ success: true, offset: window.serverTimeOffset });
                    } else {
                        console.warn('[TimeSync] ‚ö†Ô∏è serverSyncTime ‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®Êú¨Âú∞ÊôÇÈñì');
                        window.serverTimeOffset = 0;
                        window.serverTimeOffsetReady = true;
                        resolveTimeSync({ success: false, offset: 0, reason: 'serverSyncTime not found' });
                    }
                } else {
                    console.warn('[TimeSync] ‚ö†Ô∏è presence ÊñáÊ™î‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®Êú¨Âú∞ÊôÇÈñì');
                    window.serverTimeOffset = 0;
                    window.serverTimeOffsetReady = true;
                    resolveTimeSync({ success: false, offset: 0, reason: 'presence doc not found' });
                }
                
                console.log(`[Attention] ‚úÖ Initialized presence monitoring for ${studentName}`);
                console.log(`[Attention] üìä Initial state - isDistracted: false, count: 0`);
                
                // üöÄ NEW: Ë®≠ÁΩÆË¢´Ë∏¢Âá∫Ê™¢Ê∏¨Áõ£ËÅΩÂô® - Áõ£ÊéßËá™Â∑±ÁöÑ presence ÊñáÊ™îÊòØÂê¶Ë¢´Âà™Èô§
                setupKickedOutDetection(presenceRef);
            } catch (error) {
                console.error('[Attention] ‚ùå Failed to initialize presence monitoring:', error);
                // ÂàùÂßãÂåñÂ§±ÊïóÊôÇË®≠ÁΩÆÈªòË™çÂÅèÁßªÈáèÁÇ∫ 0
                window.serverTimeOffset = 0;
                window.serverTimeOffsetReady = true; // Ê®ôË®òÁÇ∫Â∑≤Â∞±Á∑íÔºà‰ΩøÁî®ÈôçÁ¥öÂÄºÔºâ
                resolveTimeSync({ success: false, offset: 0, reason: error.message });
            }
        }
        
        /**
         * üöÄ NEW: (Student) Ë®≠ÁΩÆË¢´Ë∏¢Âá∫Ê™¢Ê∏¨Áõ£ËÅΩÂô®
         * Áï∂ÊïôÂ∏´Âà™Èô§Â≠∏ÁîüÁöÑ presence ÊñáÊ™îÊôÇÔºåËá™ÂãïËß∏ÁôºÂº∑Âà∂ÁôªÂá∫
         * @param {DocumentReference} presenceRef - Â≠∏ÁîüÁöÑ presence ÊñáÊ™îÂºïÁî®
         */
        function setupKickedOutDetection(presenceRef) {
            let isFirstSnapshot = true;
            
            const unsubscribeKicked = onSnapshot(presenceRef, (docSnap) => {
                // Ë∑≥ÈÅéÈ¶ñÊ¨°Âø´ÁÖßÔºàÈ¶ñÊ¨°Âø´ÁÖßÊôÇÊñáÊ™îÊáâË©≤Â≠òÂú®Ôºâ
                if (isFirstSnapshot) {
                    isFirstSnapshot = false;
                    if (docSnap.exists()) {
                        console.log('[KickDetection] ‚úÖ ÈñãÂßãÁõ£ÊéßË¢´Ë∏¢Âá∫ÁãÄÊÖã');
                    }
                    return;
                }
                
                // Â¶ÇÊûúÊñáÊ™î‰∏çÂ≠òÂú®ÔºåË°®Á§∫Ë¢´ÊïôÂ∏´Ë∏¢Âá∫
                if (!docSnap.exists()) {
                    console.log('[KickDetection] üö® Presence ÊñáÊ™îË¢´Âà™Èô§ - Ë¢´ÊïôÂ∏´Ë∏¢Âá∫ÔºÅ');
                    handleKickedOut();
                }
            }, (error) => {
                console.error('[KickDetection] ‚ùå Áõ£ËÅΩÈåØË™§:', error);
            });
            
            // ‰ΩøÁî® ListenerManager Ë®ªÂÜäÁõ£ËÅΩÂô®
            ListenerManager.register('kickedOutDetection', unsubscribeKicked);
        }
        
        /**
         * üöÄ NEW: (Student) ËôïÁêÜË¢´Ë∏¢Âá∫ÁöÑÊÉÖÊ≥Å - È°ØÁ§∫ÊèêÁ§∫‰∏¶Âº∑Âà∂ÁôªÂá∫
         */
        function handleKickedOut() {
            console.log('[KickDetection] üö® ÈñãÂßãËôïÁêÜË¢´Ë∏¢Âá∫...');
            
            // üöÄ CRITICAL: ÂÖàË®≠ÁΩÆ attentionMonitoringActive = false ‰ª•ÈòªÊ≠¢‰∫ã‰ª∂Áõ£ËÅΩÂô®ÁπºÁ∫åÈÅãË°å
            attentionMonitoringActive = false;
            
            // üöÄ NEW: ÁßªÈô§ attention ‰∫ã‰ª∂Áõ£ËÅΩÂô®
            if (attentionVisibilityHandler) {
                document.removeEventListener('visibilitychange', attentionVisibilityHandler);
                attentionVisibilityHandler = null;
                console.log('[KickDetection] ‚úì Â∑≤ÁßªÈô§ visibilitychange Áõ£ËÅΩÂô®');
            }
            if (attentionBlurHandler) {
                window.removeEventListener('blur', attentionBlurHandler);
                attentionBlurHandler = null;
                console.log('[KickDetection] ‚úì Â∑≤ÁßªÈô§ blur Áõ£ËÅΩÂô®');
            }
            if (attentionFocusHandler) {
                window.removeEventListener('focus', attentionFocusHandler);
                attentionFocusHandler = null;
                console.log('[KickDetection] ‚úì Â∑≤ÁßªÈô§ focus Áõ£ËÅΩÂô®');
            }
            
            // Ê∏ÖÈô§ÊâÄÊúâ Firestore Áõ£ËÅΩÂô®
            ListenerManager.unregister('kickedOutDetection');
            ListenerManager.clearAll();
            
            // ÂèñÊ∂àË®ÇÈñ±Â≠∏ÁîüÁ´ØÁõ£ËÅΩÂô®
            if (studentResponsesUnsubscribe) {
                studentResponsesUnsubscribe();
                studentResponsesUnsubscribe = null;
            }
            if (classroomPresenceUnsubscribe) {
                classroomPresenceUnsubscribe();
                classroomPresenceUnsubscribe = null;
            }
            if (interactionModeUnsubscribe) {
                interactionModeUnsubscribe();
                interactionModeUnsubscribe = null;
            }
            
            // ÈáçÁΩÆÂ≠∏ÁîüÁãÄÊÖã
            classroomCode = null;
            studentName = null;
            currentInteractionMode = null;
            isResponsePaused = false;
            studentDistractionCount = 0;
            isStudentCurrentlyDistracted = false;
            
            // Êõ¥Êñ∞ UI - ÈáçÁΩÆÁî®Êà∂ ID È°ØÁ§∫
            const userIdDisplay = document.getElementById('user-id-display');
            if (userIdDisplay) {
                userIdDisplay.textContent = userId;
            }
            
            // üöÄ CRITICAL: Á´ãÂç≥Â∞éËà™Âà∞ÂÖ•Âè£È†ÅÈù¢
            showView('entry');
            
            // È°ØÁ§∫ÈÄ£Á∑ö‰∏≠Êñ∑ÊèêÁ§∫ overlayÔºàÂ©âËΩâË®äÊÅØÔºâ
            const kickedOverlay = document.createElement('div');
            kickedOverlay.id = 'kicked-out-overlay';
            kickedOverlay.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            kickedOverlay.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-11/12 text-center">
                    <div class="text-6xl mb-4">üîÑ</div>
                    <h3 class="text-xl font-bold text-blue-700 mb-4">
                        <i class="fas fa-sync-alt mr-2"></i>ÈúÄË¶ÅÈáçÊñ∞Âä†ÂÖ•Ë™≤Â†Ç
                    </h3>
                    <p class="text-gray-700 mb-6">
                        ÊÇ®ÁöÑË™≤Â†ÇÈÄ£Á∑öÂ∑≤‰∏≠Êñ∑„ÄÇ<br/>
                        Ë´ãÈáçÊñ∞Ëº∏ÂÖ•ÂßìÂêçÂä†ÂÖ•Ë™≤Â†Ç„ÄÇ
                    </p>
                    <button id="kicked-return-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold transition-colors">
                        Â•ΩÁöÑÔºåÊàëÁü•ÈÅì‰∫Ü
                    </button>
                </div>
            `;
            document.body.appendChild(kickedOverlay);
            
            // Á∂ÅÂÆöÊåâÈàïÈªûÊìä‰∫ã‰ª∂ - ÁßªÈô§ overlay
            const returnBtn = document.getElementById('kicked-return-btn');
            if (returnBtn) {
                returnBtn.addEventListener('click', () => {
                    const overlay = document.getElementById('kicked-out-overlay');
                    if (overlay) overlay.remove();
                });
            }
            
            console.log('[KickDetection] ‚úÖ Â≠∏ÁîüÂ∑≤Ë¢´Âº∑Âà∂ÁôªÂá∫‰∏¶Â∞éËà™Ëá≥ÂÖ•Âè£È†ÅÈù¢');
        }

        /**
         * (Student) Listens for changes in the teacher's interaction mode and switches the student interface accordingly.
         * üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager ÁÆ°ÁêÜÁõ£ËÅΩÂô®
         */
        function listenToInteractionMode() {
            // Use classroomCode in the Firestore path
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control'); 

            interactionModeUnsubscribe = onSnapshot(controlRef, async (docSnap) => {
                const studentPauseOverlay = document.getElementById('student-pause-overlay');
                const interactionMultipleChoice = document.getElementById('interaction-multiple-choice'); // Get the MC container

                if (!docSnap.exists()) {
                    // Teacher has ended the class session (control document deleted)
                    console.log("[Student] Teacher has ended the class session.");
                    classroomCode = null; // Clear student's classroom code
                    studentName = null; // Clear student's name
                    document.getElementById('user-id-display').textContent = userId; // Reset user ID display
                    showMessage('ËÄÅÂ∏´Â∑≤ÁµêÊùüË™≤Á®ãÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáËßíËâ≤„ÄÇ', 'info');
                    showView('entry'); // Go back to the initial entry screen
                    // Unsubscribe from student responses and presence if they were active
                    if (studentResponsesUnsubscribe) {
                        studentResponsesUnsubscribe();
                        studentResponsesUnsubscribe = null;
                    }
                    // IMPORTANT: Unsubscribe student's presence listener as well when class ends
                    if (classroomPresenceUnsubscribe) {
                        classroomPresenceUnsubscribe();
                        classroomPresenceUnsubscribe = null;
                    }
                    studentPauseOverlay.classList.add('hidden'); // Hide overlay if class ends
                    currentInteractionMode = null; // Reset global mode for student
                    isResponsePaused = false; // Reset global pause state for student
                    attentionMonitoringActive = false; // Reset attention monitoring flag
                    studentDistractionCount = 0; // Reset distraction count
                    isStudentCurrentlyDistracted = false; // Reset distraction state
                    return; // Exit the function as the session is over
                }

                const data = docSnap.data();
                const newMode = data.active_mode || 'waiting';
                const newIsResponsePaused = data.isPaused || false;
                const newBackgroundImage = data.backgroundImage || null;
                const newMultipleChoiceQuestions = data.multiple_choice_questions || null;
                const newResetTimestamp = data.resetTimestamp || null;
                const newModeResetToken = data.modeResetToken || 0;

                // Determine if the interaction mode itself has changed
                const modeChanged = (currentInteractionMode !== newMode);
                // Determine if the pause state has changed within the same mode
                const pauseStateChanged = (currentInteractionMode === newMode && isResponsePaused !== newIsResponsePaused);
                // Determine if we are resuming from a pause (mode is same, was paused, now not paused)
                const isResumingFromPause = (currentInteractionMode === newMode) && isResponsePaused && !newIsResponsePaused;
                // üéØ NEW: Determine if teacher clicked "Reset Answers" button
                const resetRequested = (window.lastResetTimestamp !== newResetTimestamp && newResetTimestamp !== null);
                // üöÄ NEW: Determine if teacher forced a mode reset (e.g., quick answer restart)
                const modeResetTokenChanged = (window.lastStudentModeResetToken !== newModeResetToken && newModeResetToken !== 0);


                // Update global states *before* acting on them
                currentInteractionMode = newMode;
                isResponsePaused = newIsResponsePaused;
                teacherUploadedBackgroundImageDataURL = newBackgroundImage; // Update teacher background image
                currentMultipleChoiceQuestions = newMultipleChoiceQuestions; // Update custom MC questions
                window.lastResetTimestamp = newResetTimestamp; // Track reset timestamp
                window.lastStudentModeResetToken = newModeResetToken; // Track mode reset token


                console.log(`[Student] Detected mode: ${currentInteractionMode}, Paused: ${isResponsePaused}, Mode Changed: ${modeChanged}, pauseStateChanged: ${pauseStateChanged}, resetRequested: ${resetRequested}, modeResetTokenChanged: ${modeResetTokenChanged}`);

                // üöÄ CRITICAL FIX: Initialize student chart listener for true_false and multiple_choice modes
                if (modeChanged && (currentInteractionMode === 'true_false' || currentInteractionMode === 'multiple_choice')) {
                    console.log(`[üë®‚Äçüéì Student Chart] INITIALIZING in mode listener - mode: ${currentInteractionMode}, classroomCode: ${classroomCode}`);
                    try {
                        if (studentChartManager) {
                            studentChartManager.init();
                            console.log('[üë®‚Äçüéì Student Chart] ‚úÖ studentChartManager initialized');
                            currentChartMode = currentInteractionMode;
                        } else {
                            console.warn('[üë®‚Äçüéì Student Chart] ‚ö†Ô∏è studentChartManager not available');
                        }
                        setupStudentChartListener(currentInteractionMode);
                        // Hide containers initially
                        const containerTf = document.getElementById('student-chart-container-tf');
                        const containerMc = document.getElementById('student-chart-container-mc');
                        if (containerTf) containerTf.classList.add('hidden');
                        if (containerMc) containerMc.classList.add('hidden');
                    } catch (error) {
                        console.error('[üë®‚Äçüéì Student Chart] Error initializing chart:', error);
                    }
                }

                if (currentInteractionMode === 'waiting') {
                    showView('studentWaiting');
                    studentPauseOverlay.classList.add('hidden'); // Hide overlay in waiting view
                } else {
                    showView('studentInteraction');

                    // Call showInteractionUI if mode changed OR token changed OR if this is the first time entering this mode
                    // We determine "first time" by checking if any interaction UI is currently visible
                    const anyUIVisible = Object.values(interactionUIs).some(ui => !ui.classList.contains('hidden'));

                    if (modeChanged || modeResetTokenChanged || !anyUIVisible) {
                        console.log(`[Student] Calling showInteractionUI (modeChanged: ${modeChanged}, tokenChanged: ${modeResetTokenChanged}, firstTime: ${!anyUIVisible})`);
                        
                        // üöÄ CRITICAL FIX: ÈáçÊñ∞ÈñãÂßãÊôÇÊ∏ÖÈô§ËÆÄÈ°åÁöÑ Firebase Êèê‰∫§Ë®òÈåÑÔºåÁ¢∫‰øùÈÅ∏È†ÖÊÅ¢Âæ©ÈªëËâ≤
                        if (modeResetTokenChanged && currentInteractionMode === 'reading_comprehension') {
                            console.log('[Student] Clearing reading comprehension Firebase record for reset');
                            try {
                                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                                await updateDoc(studentRef, {
                                    answer: deleteField(),
                                    interactionMode: deleteField(),
                                    timestamp: deleteField()
                                }).catch(error => {
                                    // Ë®òÈåÑÂøΩÁï• 404 ÈåØË™§ÔºàÂ≠∏ÁîüË®òÈåÑÂèØËÉΩ‰∏çÂ≠òÂú®Ôºâ
                                    if (error.code !== 'not-found') {
                                        console.error('[Student] Error clearing reading answers:', error);
                                    }
                                });
                            } catch (e) {
                                console.error('[Student] Error clearing reading answers:', e);
                            }
                        }
                        
                        // üöÄ FIX: Unsubscribe old quick answer listener when restarting
                        if (modeResetTokenChanged && currentInteractionMode === 'quick_answer' && quickAnswerUnsubscribe) {
                            console.log('[Student] Unsubscribing old quick answer listener before restart');
                            quickAnswerUnsubscribe();
                            quickAnswerUnsubscribe = null;
                        }
                        
                        // üöÄ CRITICAL FIX: Clear studentScoreUpdate listener when switching away from reading_comprehension
                        // This prevents ghost notifications from appearing in other modes (e.g., quick_answer)
                        if (modeChanged && ListenerManager.has('studentScoreUpdate')) {
                            ListenerManager.unregister('studentScoreUpdate');
                            console.log('[Student] ‚úì Cleared studentScoreUpdate listener on mode change to:', currentInteractionMode);
                        }
                        
                        // üöÄ CRITICAL FIX: Also clear reading comprehension leaderboard listener
                        if (modeChanged && ListenerManager.has('readingLeaderboard')) {
                            ListenerManager.unregister('readingLeaderboard');
                            console.log('[Student] ‚úì Cleared readingLeaderboard listener on mode change to:', currentInteractionMode);
                        }
                        
                        showInteractionUI(currentInteractionMode, false); // Not resuming from pause if mode changed
                    }
                    // If mode hasn't changed and a UI is already visible, we don't need to call showInteractionUI
                    // This preserves the DOM state (including content) during pause/resume

                    // üéØ NEW: If teacher clicked "Reset Answers", reset student UI state
                    if (resetRequested && currentInteractionMode !== 'waiting') {
                        console.log('[Student] Teacher reset all answers, resetting UI state');
                        resetStudentUIState(currentInteractionMode, false);
                    }

                    console.log('[Student] Setting pause overlay, isResponsePaused:', isResponsePaused);
                    if (isResponsePaused) {
                        studentPauseOverlay.classList.remove('hidden');
                        toggleStudentInteractionElements(true); // Disable elements if paused
                    } else {
                        studentPauseOverlay.classList.add('hidden');
                        toggleStudentInteractionElements(false); // Enable elements if not paused
                    }

                    // Specific UI updates that need to happen on every snapshot change
                    if (currentInteractionMode === 'drawing') {
                        requestAnimationFrame(() => {
                            // BUG FIX: Only call setupCanvas (which resizes and clears the drawing canvas)
                            // when the mode truly changes to 'drawing'.
                            // On other updates (like pause/resume or background image change),
                            // we only need to reload images and redraw the combined canvas,
                            // preserving the student's existing drawing.
                            if (modeChanged) {
                                setupCanvas();
                            }
                            loadBackgroundImage(); // Reload background in case teacher changed it
                            loadStudentImage();    // Reload student-uploaded image
                            drawCombinedCanvas();  // Redraw all layers
                        });
                    } else if (currentInteractionMode === 'url_dispatch') { // This mode now handles both URL and HTML
                        const currentDispatchSettings = data.dispatchSettings; // Get the combined settings
                        if (currentDispatchSettings) {
                            if (currentDispatchSettings.type === 'url' && currentDispatchSettings.url) {
                                displayDispatchedUrl(currentDispatchSettings);
                            } else if (currentDispatchSettings.type === 'html' && currentDispatchSettings.htmlContent) {
                                displayDispatchedHtml(currentDispatchSettings.htmlContent);
                            }
                        }
                    } else if (currentInteractionMode === 'multiple_choice') { // NEW: Handle custom multiple choice questions
                        await renderMultipleChoiceQuestions(currentMultipleChoiceQuestions);
                        // Apply/remove enlarged-buttons class based on whether custom questions exist
                        if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                            interactionMultipleChoice.classList.add('enlarged-buttons');
                        } else {
                            interactionMultipleChoice.classList.remove('enlarged-buttons');
                        }
                    } else if (currentInteractionMode === 'sequencing') {
                        const sequencingSettings = data.sequencingSettings;
                        const showSequencingAnswer = data.showSequencingAnswer || false;
                        console.log('[Student] Sequencing mode detected, settings:', sequencingSettings, 'showAnswer:', showSequencingAnswer, 'modeChanged:', modeChanged);
                        if (sequencingSettings) {
                            // üöÄ FIX: Êô∫ËÉΩËÆäÊõ¥Ê™¢Ê∏¨ - Âè™Âú®Ë®≠ÁΩÆÁúüÁöÑÊîπËÆäÊôÇÊâçÈáçÊñ∞Ê∏≤ÊüìUI
                            // ÈÄôÊ®£ÂèØ‰ª•Ôºö
                            // 1. ÊîØÊåÅÊôöÂä†ÂÖ•ÁöÑÂ≠∏ÁîüÂíåÈ†ÅÈù¢Âà∑Êñ∞
                            // 2. ÈÅøÂÖçÂú®ÂÖ∂‰ªñÂø´ÁÖßÊõ¥Êñ∞ÊôÇÊ∏ÖÁ©∫Â≠∏ÁîüÁöÑÈÄ≤Â∫¶
                            const settingsChanged = JSON.stringify(sequencingSettings) !== JSON.stringify(lastSequencingSettings);
                            console.log('[Student] Sequencing settings changed:', settingsChanged);
                            
                            if (settingsChanged) {
                                console.log('[Student] Setting up sequencing UI with new data:', sequencingSettings);
                                setupSequencingUI(sequencingSettings);
                                lastSequencingSettings = JSON.parse(JSON.stringify(sequencingSettings)); // Deep clone
                            } else {
                                console.log('[Student] Sequencing settings unchanged, keeping current UI');
                            }
                            
                            // üöÄ NEW: È°ØÁ§∫Ê≠£Á¢∫Á≠îÊ°àÁöÑÈ†ÜÂ∫èÔºåÊàñÂú®ÈáçÊñ∞ÈñãÂßãÊôÇÊÅ¢Âæ©ÂéüÂßã‰ªãÈù¢
                            if (showSequencingAnswer && !window.lastShowSequencingAnswer) {
                                // ÁãÄÊÖãÂæû false ËÆäÁÇ∫ trueÔºöÈ°ØÁ§∫Á≠îÊ°à
                                console.log('[Student] Showing sequencing correct answers');
                                displaySequencingCorrectAnswers(sequencingSettings);
                            } else if (!showSequencingAnswer && window.lastShowSequencingAnswer) {
                                // ÁãÄÊÖãÂæû true ËÆäÁÇ∫ falseÔºöÈáçÊñ∞ÈñãÂßãÔºåÊÅ¢Âæ©ÂéüÂßã‰ªãÈù¢
                                console.log('[Student] Resetting sequencing UI (teacher clicked reset)');
                                setupSequencingUI(sequencingSettings);
                            }
                            window.lastShowSequencingAnswer = showSequencingAnswer;
                        } else {
                            console.warn('[Student] Sequencing mode active but no settings provided');
                            lastSequencingSettings = null;
                        }
                    } else if (currentInteractionMode === 'matching') {
                        const matchingSettings = data.matchingSettings;
                        const showMatchingAnswer = data.showMatchingAnswer || false;
                        console.log('[Student] Matching mode detected, settings:', matchingSettings, 'showAnswer:', showMatchingAnswer, 'modeChanged:', modeChanged);
                        if (matchingSettings) {
                            // üöÄ FIX: Êô∫ËÉΩËÆäÊõ¥Ê™¢Ê∏¨ - Âè™Âú®Ë®≠ÁΩÆÁúüÁöÑÊîπËÆäÊôÇÊâçÈáçÊñ∞Ê∏≤ÊüìUI
                            // ÈÄôÊ®£ÂèØ‰ª•Ôºö
                            // 1. ÊîØÊåÅÊôöÂä†ÂÖ•ÁöÑÂ≠∏ÁîüÂíåÈ†ÅÈù¢Âà∑Êñ∞
                            // 2. ÈÅøÂÖçÂú®ÂÖ∂‰ªñÂø´ÁÖßÊõ¥Êñ∞ÊôÇÊ∏ÖÁ©∫Â≠∏ÁîüÁöÑÈÄ≤Â∫¶
                            const settingsChanged = JSON.stringify(matchingSettings) !== JSON.stringify(lastMatchingSettings);
                            console.log('[Student] Matching settings changed:', settingsChanged);
                            
                            if (settingsChanged) {
                                console.log('[Student] Setting up matching UI with new data:', matchingSettings);
                                setupMatchingUI(matchingSettings);
                                lastMatchingSettings = JSON.parse(JSON.stringify(matchingSettings)); // Deep clone
                            } else {
                                console.log('[Student] Matching settings unchanged, keeping current UI');
                            }
                            
                            // üöÄ NEW: È°ØÁ§∫Ê≠£Á¢∫Á≠îÊ°àÁöÑÈÄ£Á∑öÔºåÊàñÂú®ÈáçÊñ∞ÈñãÂßãÊôÇÊÅ¢Âæ©ÂéüÂßã‰ªãÈù¢
                            if (showMatchingAnswer && !window.lastShowMatchingAnswer) {
                                // ÁãÄÊÖãÂæû false ËÆäÁÇ∫ trueÔºöÈ°ØÁ§∫Á≠îÊ°à
                                console.log('[Student] Showing matching correct answers');
                                // üöÄ FIX: Wait for DOM to be ready before displaying answers
                                (async () => {
                                    try {
                                        await waitForMatchingDomReady(matchingSettings);
                                        displayMatchingCorrectAnswers(matchingSettings);
                                    } catch (error) {
                                        console.error('[Student] Failed to display matching answers:', error);
                                        showMessage('ÁÑ°Ê≥ïÈ°ØÁ§∫ÈÖçÂ∞çÁ≠îÊ°àÔºåDOMÊú™Ê∫ñÂÇôÂ•Ω„ÄÇ', 'error');
                                    }
                                })();
                            } else if (!showMatchingAnswer && window.lastShowMatchingAnswer) {
                                // ÁãÄÊÖãÂæû true ËÆäÁÇ∫ falseÔºöÈáçÊñ∞ÈñãÂßãÔºåÊÅ¢Âæ©ÂéüÂßã‰ªãÈù¢
                                console.log('[Student] Resetting matching UI (teacher clicked reset)');
                                setupMatchingUI(matchingSettings);
                            }
                            window.lastShowMatchingAnswer = showMatchingAnswer;
                        } else {
                            console.warn('[Student] Matching mode active but no settings provided');
                            lastMatchingSettings = null;
                        }
                    } else if (currentInteractionMode === 'reading_comprehension') {
                        const readingData = data.readingComprehensionData;
                        const readingStartedAt = data.readingStartedAt;
                        console.log('[Student] üéØ Reading comprehension mode detected, modeChanged:', modeChanged, 'readingData:', !!readingData, 'readingStartedAt:', readingStartedAt);
                        
                        // üöÄ CRITICAL FIX: ‰øÆÊîπÊ¢ù‰ª∂ÈÇèËºØ - ‰∏çÂÜçÈôêÂà∂Êñº modeChanged
                        // ÂéüÂßãÂïèÈ°åÔºöÂ≠∏ÁîüÊôöÂä†ÂÖ•ÊôÇ modeChanged=falseÔºåÂ∞éËá¥Ë®àÊôÇÂô®Ê∞∏ÈÅ†‰∏çÂàùÂßãÂåñ
                        // Ëß£Ê±∫ÊñπÊ°àÔºöÂè™Ë¶ÅÊúâ readingDataÔºåÂ∞±ÊáâË©≤È°ØÁ§∫ÂíåÂàùÂßãÂåñË®àÊôÇÂô®
                        // Ê¢ù‰ª∂ÊîπÁÇ∫ÔºöreadingData && (modeChanged || isResumingFromPause || modeResetTokenChanged || ÈòÖËØªÂÜÖÂÆπÊîπÂèò)
                        
                        // Ê£ÄÊü•ÈòÖËØªÂÜÖÂÆπÊòØÂê¶ÊîπÂèòÔºàÁî®‰∫éÊôöÂä†ÂÖ•Â≠¶ÁîüÔºâ
                        const currentReadingHash = readingData ? JSON.stringify(readingData.questions?.length) : null;
                        const contentChanged = currentReadingHash !== window.lastReadingHash;
                        if (contentChanged) window.lastReadingHash = currentReadingHash;
                        
                        console.log('[Student] üìä Reading condition check:', {
                            hasReadingData: !!readingData,
                            modeChanged: modeChanged,
                            isResumingFromPause: isResumingFromPause,
                            modeResetTokenChanged: modeResetTokenChanged,
                            contentChanged: contentChanged,
                            shouldDisplay: readingData && (modeChanged || isResumingFromPause || modeResetTokenChanged || contentChanged)
                        });
                        
                        // üöÄ KEY FIX: Êñ∞Â¢û contentChanged Ê¢ù‰ª∂ÔºåÁ¢∫‰øùÊôöÂä†ÂÖ•ÁöÑÂ≠∏Áîü‰πüËÉΩÂàùÂßãÂåñË®àÊôÇÂô®
                        if (readingData && (modeChanged || isResumingFromPause || modeResetTokenChanged || contentChanged)) {
                            console.log('[Student] ‚úÖ Displaying reading comprehension');
                            console.log('[Student] readingStartedAt from Firestore:', readingStartedAt, 'type:', typeof readingStartedAt, 'constructor:', readingStartedAt?.constructor?.name);
                            // üöÄ CRITICAL FIX: Á¢∫‰øù readingStartedAt Ë¢´Ê≠£Á¢∫ÂÇ≥ÈÅû
                            const actualReadingStartedAt = readingStartedAt;
                            console.log('[Student] ‚úÖ Passing to displayReadingComprehensionForStudent with startedAt:', actualReadingStartedAt);
                            // üöÄ NEW: Attach startedAt timestamp for duration calculation
                            const readingDataWithTime = {...readingData, startedAt: actualReadingStartedAt};
                            displayReadingComprehensionForStudent(readingDataWithTime);
                            // Only reset submit button if mode changed (not when resuming from pause)
                            if (modeChanged) {
                                document.getElementById('submit-reading-btn').disabled = false;
                            }
                        }
                        // ÂïüÂãïÊéíË°åÊ¶úÁõ£ËÅΩÔºàÂ¶ÇÊûúÂ∞öÊú™ÂïüÂãïÔºâ
                        if (modeChanged) {
                            listenToReadingLeaderboard();
                        }
                    } else if (currentInteractionMode === 'quick_poll') {
                        if (modeChanged) {
                            listenToQuickPollConfig();
                        }
                    }
                }
            }, (error) => {
                console.error("[Student] Error listening to interaction mode:", error);
                // This error might indicate a network issue or permission denied, not necessarily class end.
                // So, keep the student in waiting view or current view, and just show an error.
                showMessage("ÁÑ°Ê≥ïÊé•Êî∂ËÄÅÂ∏´Êåá‰ª§ÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ", "error");
            });
            
            // üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager Ë®ªÂÜäÁõ£ËÅΩÂô®
            ListenerManager.register('interactionMode', interactionModeUnsubscribe);
        }
        
        /**
         * üöÄ NEW: (Teacher) Listens to reading comprehension submissions and displays the leaderboard
         */
        function listenToReadingLeaderboardTeacher() {
            if (!classroomCode) {
                console.warn('[TeacherLeaderboard] Classroom code not set');
                return;
            }
            
            // Â¶ÇÊûúÂ∑≤Á∂ìÊúâÁõ£ËÅΩÂô®ÔºåÂÖàË®ªÈä∑
            if (ListenerManager.has('teacherReadingLeaderboard')) {
                console.log('[TeacherLeaderboard] Already listening, skipping');
                return;
            }
            
            console.log('[TeacherLeaderboard] ‚úì Starting to listen for reading comprehension submissions');
            console.log('[TeacherLeaderboard] Initial state - readingComprehensionData:', !!readingComprehensionData, 'questions:', !!(readingComprehensionData && readingComprehensionData.questions));
            
            const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            
            const unsubscribe = onSnapshot(studentsColRef, (querySnapshot) => {
                const studentsData = [];
                let readingSubmissionCount = 0;
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('[TeacherLeaderboard] Document:', doc.id, 'mode:', data.interactionMode, 'answer:', !!data.answer);
                    // Âè™Áõ£ËÅΩËÆÄÈ°åÊèê‰∫§ÁöÑÂ≠∏Áîü
                    if (data.interactionMode === 'reading_comprehension' && data.answer) {
                        readingSubmissionCount++;
                        studentsData.push(data);
                    }
                });
                
                console.log('[TeacherLeaderboard] üìä Received', readingSubmissionCount, 'reading comprehension submissions out of', querySnapshot.size, 'total');
                console.log('[TeacherLeaderboard] Global state - readingComprehensionData available:', !!readingComprehensionData, 'has questions:', !!(readingComprehensionData && readingComprehensionData.questions));
                
                // üöÄ CRITICAL FIX: ÂÑ™ÂÖà‰ΩøÁî®ÂÖ®Â±ÄËÆäÈáèÔºåÂ¶ÇÊûú‰∏çÂèØÁî®ÂâáÂæû Firestore ËÆÄÂèñ
                if (readingComprehensionData && readingComprehensionData.questions) {
                    console.log('[TeacherLeaderboard] ‚úì Using global readingComprehensionData, displaying leaderboard');
                    if (studentsData.length > 0) {
                        updateReadingLeaderboardDisplay(studentsData, false);
                        const leaderboardContainer = document.getElementById('reading-leaderboard');
                        if (leaderboardContainer) {
                            leaderboardContainer.classList.remove('hidden');
                        }
                    } else {
                        console.log('[TeacherLeaderboard] No student submissions yet');
                    }
                } else {
                    console.log('[TeacherLeaderboard] ‚ö†Ô∏è readingComprehensionData not available globally, fetching from Firestore');
                    const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                    getDoc(controlRef).then(controlDoc => {
                        if (controlDoc.exists() && controlDoc.data().readingComprehensionData) {
                            readingComprehensionData = controlDoc.data().readingComprehensionData;
                            console.log('[TeacherLeaderboard] ‚úì readingComprehensionData loaded from Firestore with', readingComprehensionData.questions?.length, 'questions');
                            // ÁèæÂú®ÂèØ‰ª•È°ØÁ§∫ÊéíË°åÊ¶ú
                            if (readingComprehensionData && readingComprehensionData.questions && studentsData.length > 0) {
                                console.log('[TeacherLeaderboard] ‚úì Displaying leaderboard after Firestore fetch');
                                updateReadingLeaderboardDisplay(studentsData, false);
                                const leaderboardContainer = document.getElementById('reading-leaderboard');
                                if (leaderboardContainer) {
                                    leaderboardContainer.classList.remove('hidden');
                                }
                            }
                        } else {
                            console.warn('[TeacherLeaderboard] ‚ùå No readingComprehensionData in control document');
                        }
                    }).catch(error => {
                        console.error('[TeacherLeaderboard] ‚ùå Error fetching from Firestore:', error);
                    });
                }
            }, (error) => {
                console.error('[TeacherLeaderboard] ‚ùå Error listening to submissions:', error);
            });
            
            ListenerManager.register('teacherReadingLeaderboard', unsubscribe);
            console.log('[TeacherLeaderboard] ‚úì Listener registered and watching for reading comprehension submissions');
        }
        
        /**
         * (Student) Updates the reading leaderboard display based on current student responses.
         * üöÄ HELPER: ÊéíË°åÊ¶úÊ∏≤ÊüìÈÇèËºØÔºåÂèØË¢´Áõ£ËÅΩÂô®ÂíåÊâãÂãïË™øÁî®ÂÖ±Áî®
         * @param {Array} studentsData - Array of student response data
         * @param {boolean} shouldScrollToTop - Whether to scroll to leaderboard after update (default: false)
         */
        function updateReadingLeaderboardDisplay(studentsData, shouldScrollToTop = false) {
            console.log('[updateReadingLeaderboardDisplay] üöÄ Called with', studentsData.length, 'students, shouldScrollToTop:', shouldScrollToTop);
            
            const leaderboardContainer = document.getElementById('reading-leaderboard');
            const leaderboardList = document.getElementById('reading-leaderboard-list');
            
            if (!leaderboardContainer || !leaderboardList) {
                console.warn('[Leaderboard] DOM elements not found - leaderboardContainer:', !!leaderboardContainer, 'leaderboardList:', !!leaderboardList);
                return;
            }
            
            console.log('[updateReadingLeaderboardDisplay] ‚úì DOM elements found, clearing old content');
            // üöÄ CRITICAL: Force clear and rebuild
            leaderboardList.innerHTML = '';
            
            const questions = readingComprehensionData.questions;
            
            // Âè™Âú®ÊúâÈ°åÁõÆÊôÇÈ°ØÁ§∫ÊéíË°åÊ¶ú
            if (!questions || questions.length === 0) {
                console.warn('[updateReadingLeaderboardDisplay] No questions found, hiding leaderboard');
                leaderboardContainer.classList.add('hidden');
                return;
            }
            
            console.log('[updateReadingLeaderboardDisplay] ‚úì Found', questions.length, 'questions, processing', studentsData.length, 'students');
            const rankedStudents = [];
            
            // Ë®àÁÆóÊØèÂÄãÂ≠∏ÁîüÁöÑÊ≠£Á¢∫ÁéáÂíåÁ∏ΩÂàÜÔºàÂü∫Á§éÂàÜ+Á≠ÜË®òÂä†ÂàÜÔºâ
            studentsData.forEach(student => {
                if (student.answer) {
                    try {
                        const studentAnswers = JSON.parse(student.answer);
                        
                        // üöÄ CRITICAL FIX: ÂÑ™ÂÖà‰ΩøÁî® Firestore ‰∏≠Â∑≤Êõ¥Êñ∞ÁöÑÂàÜÊï∏ÔºàÁî±ÊïôÂ∏´Á´Ø rescoreAllStudents Ë®àÁÆóÔºâ
                        // ÈÄôÁ¢∫‰øùÁï∂ÊïôÂ∏´‰øÆÊîπÁ≠îÊ°àÂæåÔºåÂ≠∏ÁîüÁ´ØËÉΩÁúãÂà∞ÊúÄÊñ∞ÁöÑÊ≠£Á¢∫ÂàÜÊï∏
                        // Âè™ÊúâÂú®Ê≤íÊúâ Firestore ÂàÜÊï∏ÊôÇÊâçÈÄ≤Ë°åÊú¨Âú∞Ë®àÁÆóÔºà‰æãÂ¶ÇÂ≠∏ÁîüÂâõÊèê‰∫§Á≠îÊ°àÊôÇÔºâ
                        let baseScore, highlightBonus, totalScore, correctCount;
                        
                        // Ê™¢Êü•ÊòØÂê¶Êúâ scoreUpdateTokenÔºàË°®Á§∫ÊïôÂ∏´Â∑≤ÈáçÊñ∞Ë®àÂàÜÔºâ
                        const hasTeacherUpdatedScore = student.scoreUpdateToken && student.baseScore !== undefined;
                        
                        if (hasTeacherUpdatedScore) {
                            // üöÄ ‰ΩøÁî®ÊïôÂ∏´Á´ØÂ∑≤Ë®àÁÆóÂ•ΩÁöÑÂàÜÊï∏ÔºàÂåÖÂê´ÈÄÅÂàÜÈ°åÈÇèËºØÔºâ
                            baseScore = student.baseScore;
                            highlightBonus = (student.highlightAnalysis && student.highlightAnalysis.score) || 0;
                            totalScore = student.totalScore || (baseScore + highlightBonus);
                            correctCount = Math.round((baseScore / 100) * questions.length); // ÂèçÊé®Ê≠£Á¢∫È°åÊï∏
                            console.log(`[Leaderboard] ‚úÖ Using Firestore scores for ${student.name}:`, { baseScore, highlightBonus, totalScore, correctCount, scoreUpdateToken: student.scoreUpdateToken });
                        } else {
                            // Êú¨Âú∞Ë®àÁÆóÔºàÂ≠∏ÁîüÂâõÊèê‰∫§ÊôÇÔºåFirestore Â∞öÊú™Ë¢´ÊïôÂ∏´Êõ¥Êñ∞Ôºâ
                            correctCount = 0;
                            studentAnswers.forEach((ans, index) => {
                                if (questions[index] && ((questions[index].correctAnswer === 0) || (ans === questions[index].correctAnswer))) {
                                    correctCount++;
                                }
                            });
                            baseScore = Math.round((correctCount / questions.length) * 100);
                            highlightBonus = (student.highlightAnalysis && student.highlightAnalysis.score) || 0;
                            totalScore = baseScore + highlightBonus;
                            console.log(`[Leaderboard] Locally calculated scores for ${student.name}:`, { baseScore, highlightBonus, totalScore, correctCount });
                        }
                        
                        // Ê≠£Á¢∫È°åÊï∏Â∑≤Âú®‰∏äÈù¢Ë®àÁÆóÔºåÁõ¥Êé•Áî®ÊñºÈ°ØÁ§∫
                        const accuracy = Math.round((correctCount / questions.length) * 100);
                        
                        rankedStudents.push({
                            name: student.name,
                            correctCount: correctCount,
                            totalQuestions: questions.length,
                            accuracy: accuracy,
                            baseScore: baseScore, // üöÄ NEW: Âü∫Á§éÂàÜÊï∏
                            highlightBonus: highlightBonus, // üöÄ NEW: Á≠ÜË®òÂä†ÂàÜ
                            totalScore: totalScore, // üöÄ NEW: Á∏ΩÂàÜÔºàÂü∫Á§é+Âä†ÂàÜÔºâ
                            highlightAnalysis: student.highlightAnalysis || null, // üöÄ NEW: ÂÆåÊï¥ÁöÑÁ≠ÜË®òÂàÜÊûêÊï∏Êìö
                            timestamp: student.timestamp,
                            durationMs: student.durationMs || null
                        });
                    } catch (e) {
                        // Á≠îÊ°àÊ†ºÂºèÈåØË™§Ôºå‰∏çÂä†ÂÖ•ÊéíÂêç
                        console.warn('[Leaderboard] Invalid answer format for student:', student.name);
                    }
                }
            });
            
            // üöÄ UPDATED: ÊéíÂ∫èÈÇèËºØ - Á∏ΩÂàÜÈôçÂ∫èÔºàÂü∫Á§éÂàÜ+Á≠ÜË®òÂä†ÂàÜÔºâ ‚Üí ‰ΩúÁ≠îÊôÇÈï∑ÂçáÂ∫è ‚Üí Êèê‰∫§ÊôÇÈñìÂçáÂ∫è ‚Üí ÂßìÂêçÂçáÂ∫è
            rankedStudents.sort((a, b) => {
                // 1. ‰∏ªË¶ÅÊéíÂ∫èÔºöÁ∏ΩÂàÜÈ´òÁöÑÂú®ÂâçÔºàÂåÖÂê´Á≠ÜË®òÂä†ÂàÜÔºâ
                if (b.totalScore !== a.totalScore) {
                    return b.totalScore - a.totalScore;
                }
                // 2. Ê¨°Ë¶ÅÊéíÂ∫èÔºö‰ΩúÁ≠îÊôÇÈï∑Áü≠ÁöÑÂú®ÂâçÔºàÂêåÂàÜÊôÇÊõ¥Âø´ÂÆåÊàêÊéíÂêçÊõ¥È´òÔºâ
                if (a.durationMs && b.durationMs) {
                    return a.durationMs - b.durationMs;
                }
                // Â¶ÇÊûúÂè™Êúâ‰∏ÄÊñπÊúâ‰ΩúÁ≠îÊôÇÈï∑ÔºåÊúâ‰ΩúÁ≠îÊôÇÈï∑ÁöÑÊéíÂú®ÂâçÈù¢
                if (a.durationMs && !b.durationMs) return -1;
                if (!a.durationMs && b.durationMs) return 1;
                // 3. Á¨¨‰∏âÊéíÂ∫èÔºöÊèê‰∫§ÊôÇÈñìÊó©ÁöÑÂú®ÂâçÔºà‰ΩúÁÇ∫ÂæåÂÇôÔºâ
                if (a.timestamp && b.timestamp) {
                    const timeA = a.timestamp.toMillis ? a.timestamp.toMillis() : new Date(a.timestamp).getTime();
                    const timeB = b.timestamp.toMillis ? b.timestamp.toMillis() : new Date(b.timestamp).getTime();
                    if (timeA !== timeB) {
                        return timeA - timeB;
                    }
                }
                // 4. ÊúÄÂæåÊéíÂ∫èÔºöÂßìÂêçÂ≠óÊØçÈ†ÜÂ∫è
                return a.name.localeCompare(b.name);
            });
            
            // üöÄ OPTIMIZED: Ë®àÁÆóÊéíÂêç - ÊØèÂÄãÂ≠∏ÁîüÈÉΩÊúâÂîØ‰∏ÄÊéíÂêçÔºàÂü∫ÊñºÂÆåÊï¥ÊéíÂ∫èÔºåÂåÖÊã¨‰ΩúÁ≠îÊôÇÈï∑Ôºâ
            // ‰∏çÂÜçÂè™ÊØîËºÉÊ≠£Á¢∫È°åÊï∏ÔºåËÄåÊòØÁÇ∫ÊéíÂ∫èÂàóË°®‰∏≠ÁöÑÊØèÂÄã‰ΩçÁΩÆÊåáÊ¥æÂîØ‰∏ÄÊéíÂêç
            rankedStudents.forEach((student, index) => {
                student.rank = index + 1;
            });
            
            // Âè™È°ØÁ§∫ÂâçÂçÅÂêç
            const top10 = rankedStudents.slice(0, 10);
            
            if (top10.length > 0) {
                leaderboardContainer.classList.remove('hidden');
                leaderboardList.innerHTML = '';
                
                top10.forEach((student, index) => {
                    const rank = student.rank; // üöÄ UPDATED: ‰ΩøÁî®Ë®àÁÆóÂ•ΩÁöÑÊéíÂêçÔºàÊîØÊè¥‰∏¶ÂàóÔºâ
                    let badgeClass = 'bg-gray-100 text-gray-700 border-gray-300';
                    let icon = '';
                    let rankText = `Á¨¨${rank}Âêç`;
                    
                    if (rank === 1) {
                        badgeClass = 'bg-yellow-100 text-yellow-700 border-yellow-300';
                        icon = 'ü•á';
                        rankText = '';
                    } else if (rank === 2) {
                        badgeClass = 'bg-gray-200 text-gray-700 border-gray-400';
                        icon = 'ü•à';
                        rankText = '';
                    } else if (rank === 3) {
                        badgeClass = 'bg-orange-100 text-orange-700 border-orange-300';
                        icon = 'ü•â';
                        rankText = '';
                    } else if (rank <= 5) {
                        badgeClass = 'bg-blue-100 text-blue-700 border-blue-300';
                        icon = 'üèÖ';
                        rankText = `Á¨¨${rank}Âêç`;
                    } else {
                        badgeClass = 'bg-purple-50 text-purple-600 border-purple-200';
                        icon = '‚≠ê';
                        rankText = `Á¨¨${rank}Âêç`;
                    }
                    
                    // üöÄ NEW: Format time display (duration if available, otherwise relative time)
                    let timeDisplay = '';
                    if (student.durationMs) {
                        const duration = formatDuration(student.durationMs);
                        timeDisplay = `
                            <div class="text-xs text-gray-600 mt-1">
                                <span class="hidden sm:inline">‚è±Ô∏è ${duration.longLabel}</span>
                                <span class="sm:hidden">‚è±Ô∏è ${duration.shortLabel}</span>
                            </div>
                        `;
                    } else if (student.timestamp) {
                        const relativeTime = formatRelativeTime(student.timestamp);
                        timeDisplay = `<div class="text-xs text-gray-500 mt-1">üïí ${relativeTime}</div>`;
                    }
                    
                    // üöÄ NEW: Âä†ÂàÜÈ°ØÁ§∫ÔºàÂ¶ÇÊûúÊúâÁ≠ÜË®òÂä†ÂàÜÔºâ
                    let bonusDisplay = '';
                    if (student.highlightBonus > 0) {
                        bonusDisplay = `
                            <div class="mt-1 text-xs sm:text-sm font-bold text-purple-600">
                                üìù +${student.highlightBonus}ÂàÜ
                            </div>
                        `;
                    }
                    
                    const card = document.createElement('div');
                    card.className = `${badgeClass} border-2 rounded-lg p-2 sm:p-3 text-center transition-all hover:scale-105 hover:shadow-md`;
                    card.innerHTML = `
                        <div class="text-2xl sm:text-3xl mb-1">${icon}</div>
                        <div class="font-bold text-xs sm:text-sm truncate mb-1">${student.name}</div>
                        ${rankText ? `<div class="text-xs font-semibold mb-1">${rankText}</div>` : ''}
                        <div class="text-base sm:text-lg font-bold text-gray-800 mb-1">${Math.round(student.totalScore)}ÂàÜ</div>
                        <div class="text-xs text-gray-600">Âü∫Á§é: ${student.baseScore}ÂàÜ</div>
                        ${bonusDisplay}
                        ${timeDisplay}
                    `;
                    leaderboardList.appendChild(card);
                });
                
                console.log('[updateReadingLeaderboardDisplay] ‚úÖ Rendered', rankedStudents.length, 'students in leaderboard');
                leaderboardContainer.classList.remove('hidden');
                
                // üöÄ NEW: Âè™Âú®Â≠∏ÁîüÊèê‰∫§Á≠îÊ°àÂæåÊâçÊªæÂãïÂà∞ÊéíË°åÊ¶úÔºàÈò≤Ê≠¢‰ΩúÁ≠îÊôÇË¢´ÊâìÊñ∑Ôºâ
                if (shouldScrollToTop) {
                    setTimeout(() => {
                        leaderboardContainer.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        console.log('[Leaderboard] Scrolled to top after submission');
                    }, 300); // Âª∂ÈÅ≤300msÁ¢∫‰øùDOMÂ∑≤Ê∏≤Êüì
                }
            } else {
                // üöÄ FIX: Ê∏ÖÁ©∫ÊéíË°åÊ¶ú‰∏¶Èö±ËóèÂÆπÂô®ÔºåÈò≤Ê≠¢È°ØÁ§∫ËàäÊï∏Êìö
                leaderboardList.innerHTML = '';
                leaderboardContainer.classList.add('hidden');
            }
        }
        
        /**
         * (Student) Listens to all student responses and displays the top 10 leaderboard for reading comprehension.
         * üöÄ NEW: Èñ±ËÆÄÊ∏¨È©óÊéíË°åÊ¶úÁõ£ËÅΩ
         * ‚ú® OPTIMIZED: ‰ΩøÁî®ÂÖ®Âüü readingComprehensionDataÔºåÁî± listenToInteractionMode Êõ¥Êñ∞
         * 
         * ÂØ¶‰ΩúË™™ÊòéÔºö
         * - listenToInteractionMode Â∑≤Á∂ìÁõ£ËÅΩ control ÊñáÊ™î‰∏¶Êõ¥Êñ∞ readingComprehensionData
         * - Êú¨ÂáΩÊï∏Âè™ÈúÄÁõ£ËÅΩ studentResponses ÈõÜÂêàÔºå‰ΩøÁî®Â∑≤Á∂ìÊõ¥Êñ∞ÁöÑÂÖ®ÂüüËÆäÊï∏
         * - Áï∂È°åÁõÆÊõ¥Êñ∞ÊôÇÔºålistenToInteractionMode ÊúÉÈáçÊñ∞Ë™øÁî® displayReadingComprehensionForStudent
         * - ÈÄôÊ®£ÂèØ‰ª•ÈÅøÂÖçÈáçË§áÁõ£ËÅΩÂêå‰∏ÄÂÄãÊñáÊ™îÔºåÊ∏õÂ∞ë Firestore ËÆÄÂèñ
         */
        function listenToReadingLeaderboard() {
            if (!classroomCode) {
                console.warn('[Leaderboard] Classroom code not set');
                return;
            }
            
            // Â¶ÇÊûúÂ∑≤Á∂ìÊúâÁõ£ËÅΩÂô®ÔºåÂÖàË®ªÈä∑
            if (ListenerManager.has('readingLeaderboard')) {
                console.log('[Leaderboard] Already listening, skipping');
                return;
            }
            
            const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            
            const unsubscribe = onSnapshot(studentsColRef, (querySnapshot) => {
                const studentsData = [];
                querySnapshot.forEach(doc => {
                    studentsData.push(doc.data());
                });
                updateReadingLeaderboardDisplay(studentsData);
            }, (error) => {
                console.error('[Leaderboard] Error listening:', error);
            });
            
            ListenerManager.register('readingLeaderboard', unsubscribe);
            console.log('[Leaderboard] Started listening for reading comprehension leaderboard');
        }
        
        /**
         * (Student) Displays the dispatched URL or YouTube video.
         * @param {object} settings - The URL settings object from Firestore.
         */
        function displayDispatchedUrl(settings) {
            const container = interactionUIs.url_dispatch;
            container.innerHTML = ''; // Clear previous content

            if (settings.isYoutube) {
                const videoId = getYouTubeVideoId(settings.url);
                console.log('YouTube URL:', settings.url, 'Video ID:', videoId); // Ë™øË©¶‰ø°ÊÅØ
                if (videoId) {
                    const embedContainer = document.createElement('div');
                    embedContainer.className = 'youtube-embed-container';
                    
                    // Ê∑ªÂä†ËºâÂÖ•‰∏≠ÁöÑÊèêÁ§∫
                    embedContainer.innerHTML = `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>
                        ÂΩ±ÁâáËºâÂÖ•‰∏≠...
                    </div>`;
                    
                    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&showinfo=0&modestbranding=1`;
                    console.log('Embed URL:', embedUrl); // Ë™øË©¶‰ø°ÊÅØ
                    
                    // ÂâµÂª∫iframeÂÖÉÁ¥†
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.frameBorder = '0';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                    iframe.allowFullscreen = true;
                    iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;';
                    
                    // ËºâÂÖ•ÂÆåÊàêÂæåÁßªÈô§ËºâÂÖ•ÊèêÁ§∫
                    iframe.onload = function() {
                        const loadingDiv = embedContainer.querySelector('div');
                        if (loadingDiv) loadingDiv.remove();
                    };
                    
                    // ÈåØË™§ËôïÁêÜ
                    iframe.onerror = function() {
                        embedContainer.innerHTML = `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i><br>
                            ÂΩ±ÁâáËºâÂÖ•Â§±Êïó
                        </div>`;
                    };
                    
                    embedContainer.appendChild(iframe);
                    container.appendChild(embedContainer);
                } else {
                    console.error('ÁÑ°ÊïàÁöÑ YouTube Á∂≤ÂùÄ:', settings.url); // Ë™øË©¶‰ø°ÊÅØ
                    container.innerHTML = `<p class="text-red-500">ÁÑ°ÊïàÁöÑ YouTube Á∂≤ÂùÄ„ÄÇ</p>`;
                }
            } else {
                const card = document.createElement('a');
                card.className = 'url-card';
                card.href = settings.url;
                card.target = '_blank';
                card.rel = 'noopener noreferrer';
                card.innerHTML = `
                    <i class="fas fa-external-link-alt url-card-icon"></i>
                    <p class="url-card-text">ËÄÅÂ∏´ÂàÜ‰∫´‰∫Ü‰∏ÄÂÄãÈÄ£Áµê</p>
                    <p class="url-card-link">${settings.url}</p>
                `;
                container.appendChild(card);
            }
        }

        /**
         * NEW: (Student) Displays the dispatched HTML content in an iframe.
         * @param {string} htmlContent - The HTML content to display.
         */
        function displayDispatchedHtml(htmlContent) {
            const container = interactionUIs.url_dispatch; // Use the same container
            container.innerHTML = ''; // Clear previous content
            
            const iframe = document.createElement('iframe');
            iframe.id = 'html-content-iframe'; // Re-use the ID for consistency if needed, but it's internal to this function now
            iframe.sandbox = 'allow-scripts allow-same-origin allow-popups allow-forms';
            iframe.srcdoc = htmlContent;
            iframe.style.cssText = 'width: 100vw; height: 100vh; margin: 0; padding: 0; border: none; background-color: white; display: block;';
            container.appendChild(iframe);

            // Add status indicator
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'html-dispatch-indicator';
            statusIndicator.textContent = 'ÊïôÂ∏´Ê¥æÈÄÅhtml‰∏≠...';
            container.appendChild(statusIndicator);

            // Apply the specific HTML dispatch container styles to the outer container
            container.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; margin: 0; padding: 0; border: none; overflow: hidden; background-color: white; z-index: 1000;';
        }

        /**
         * Extracts YouTube video ID from various URL formats.
         * @param {string} url - The YouTube URL.
         * @returns {string|null} The video ID or null if not found.
         */
        function getYouTubeVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }


        /**
         * (Student) Submits the answer to Firestore.
         * @param {string | object} answer - The student's answer.
         * @returns {Promise<boolean>} Returns true if successful, false if failed
         */
        async function submitAnswer(answer, extraFields = {}) {
            // NEW: Prevent submission if paused
            if (isResponsePaused) {
                showMessage('ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶ÜÔºåÁÑ°Ê≥ïÈÄÅÂá∫Á≠îÊ°à„ÄÇ', 'error');
                throw new Error('Response is paused');
            }

            if (!studentName || !userId || !classroomCode) {
                console.error("Student name, User ID, or Classroom Code not set. Cannot submit answer.");
                showMessage("Â≠∏ÁîüÂßìÂêç„ÄÅÁî®Êà∂IDÊàñÊïôÂÆ§‰ª£Á¢ºÊú™Ë®≠ÂÆöÔºåÁÑ°Ê≥ïÈÄÅÂá∫Á≠îÊ°à„ÄÇ", "error");
                throw new Error('Student info not set');
            }
            // Use classroomCode in the Firestore path
            const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
            try {
                 await setDoc(studentRef, { 
                    name: studentName,
                    answer: answer,
                    interactionMode: currentInteractionMode, // üéØ CRITICAL FIX: ÂÑ≤Â≠ò‰∫íÂãïÊ®°ÂºèÔºåËÆì resetStudentUIState ËÉΩÊ≠£Á¢∫Ê™¢Êü•Êèê‰∫§ÁãÄÊÖã
                    timestamp: new Date(),
                    ...extraFields // üî• NEW: Allow adding extra fields like modeResetToken
                }, { merge: true });
                console.log(`[Student] ${studentName} submitted answer:`, answer, 'mode:', currentInteractionMode, 'extraFields:', extraFields);
                return true;
            } catch (error) {
                console.error("ÈÄÅÂá∫Á≠îÊ°àÂ§±Êïó:", error);
                showMessage("ÈÄÅÂá∫Á≠îÊ°àÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ", "error");
                throw error;
            }
        }
        
        /**
         * üöÄ NEW: (Teacher) ÂâµÂª∫ÂñÆÂÄãÂ≠∏ÁîüÂç°ÁâáÔºàÁµ±‰∏ÄÁöÑÂç°ÁâáÁîüÊàêÈÇèËºØÔºåÊîØÊåÅÊâÄÊúâ9Á®Æ‰∫íÂãïÊ®°ÂºèÔºâ
         * @param {Object} student - Â≠∏ÁîüÊï∏Êìö
         * @param {HTMLElement} container - Â≠∏ÁîüÂç°ÁâáÂÆπÂô®
         * @param {string} mode - Áï∂Ââç‰∫íÂãïÊ®°Âºè
         * @param {Array} rankedStudents - ÊéíÂêçÊï∏ÊìöÔºàÈñ±ËÆÄÊ∏¨È©óÊ®°Âºè‰ΩøÁî®Ôºâ
         */
        function createStudentCard(student, container, mode, rankedStudents = []) {
            const card = document.createElement('div');
            card.className = 'student-response-item';
            card.setAttribute('data-student-name', student.name);

            let answerContentHTML = '';
            
            // ËôïÁêÜÊâÄÊúâÊ®°ÂºèÁöÑÁ≠îÊ°àÈ°ØÁ§∫
            if (mode === 'url_dispatch') {
                // URL dispatch mode: show online indicator
                answerContentHTML = `<i class="fas fa-check-circle text-green-500 text-2xl"></i>`;
            } else if (student.answer === null || student.answer === undefined) {
                // Â≠∏ÁîüÊú™Êèê‰∫§Á≠îÊ°àÔºàÊâÄÊúâÊ®°ÂºèÈÄöÁî®Ôºâ
                answerContentHTML = `<p class="text-gray-400">Â∞öÊú™‰ΩúÁ≠î</p>`;
            } else if (mode === 'drawing') {
                // Áπ™ÂúñÊ®°Âºè
                if (String(student.answer).startsWith('data:image')) {
                    answerContentHTML = `<img src="${student.answer}" alt="${student.name} ÁöÑÁπ™Âúñ" class="w-full h-auto rounded-md border max-h-32 object-contain cursor-pointer" data-full-image="${student.answer}"/>`;
                } else {
                    answerContentHTML = `<p class="text-gray-500">Áπ™ÂúñÊú™ÂÆåÊàêÊàñÊ†ºÂºèÈåØË™§</p>`;
                }
            } else if (mode === 'recording') {
                // ÈåÑÈü≥Ê®°Âºè
                if (String(student.answer).startsWith('data:audio')) {
                    answerContentHTML = `<audio controls src="${student.answer}" class="w-full"></audio>`;
                } else {
                    answerContentHTML = `<p class="text-gray-500">ÈåÑÈü≥Êú™ÂÆåÊàêÊàñÊ†ºÂºèÈåØË™§</p>`;
                }
            } else if (mode === 'text_input') {
                // ÊñáÂ≠óËº∏ÂÖ•Ê®°Âºè
                answerContentHTML = `<p class="text-gray-700 whitespace-pre-wrap">${student.answer || '(Á©∫ÁôΩ)'}</p>`;
            } else if (mode === 'multiple_choice' && Array.isArray(student.answer) && currentMultipleChoiceQuestions) {
                // Ëá™Ë®ÇÈÅ∏ÊìáÈ°åÊ®°Âºè
                answerContentHTML = `<div class="flex flex-col w-full">`;
                student.answer.forEach((qAns, index) => {
                    const question = currentMultipleChoiceQuestions[qAns.qIndex];
                    if (question) {
                        const isCorrect = (String(qAns.ans) === String(question.correctAnswer));
                        answerContentHTML += `
                            <div class="mc-question-answer">
                                <i class="icon fas ${isCorrect ? 'fa-check-circle correct-icon' : 'fa-times-circle incorrect-icon'}"></i>
                                <span class="question-text">Q${qAns.qIndex + 1}:</span>
                                <span class="student-choice">${qAns.ans}</span>
                            </div>
                        `;
                    }
                });
                answerContentHTML += `</div>`;
            } else if (mode === 'quick_answer') {
                // Êê∂Á≠îÊ®°Âºè
                if (student.answer && student.answer.includes('Êê∂Á≠îÊàêÂäü')) {
                    answerContentHTML = `<div class="text-center">
                        <i class="fas fa-trophy text-yellow-500 text-4xl mb-2"></i>
                        <p class="text-xl font-bold text-green-600">Êê∂Á≠îÊàêÂäüÔºÅ</p>
                        <p class="text-lg text-gray-600">Á¨¨‰∏ÄÂêç</p>
                    </div>`;
                } else {
                    answerContentHTML = `<p class="text-gray-500">Êú™Êê∂Á≠îÊàñÊê∂Á≠îÂ§±Êïó</p>`;
                }
            } else if (mode === 'sequencing') {
                // ÊéíÂ∫èÈ°åÊ®°Âºè
                try {
                    const studentOrder = JSON.parse(student.answer);
                    const correctOrder = sequencingData.correctOrder;
                    let isCorrect = true;

                    answerContentHTML = `<div class="flex flex-col w-full gap-1">`;
                    studentOrder.forEach((item, index) => {
                        const correct = correctOrder[index] === item;
                        if (!correct) isCorrect = false;
                        // üöÄ CRITICAL FIX: ÂÖàÂà§Êñ∑ÈÄÅÂàÜÈ°åÔºåÈÅøÂÖçÈÇèËºØÂèçÂêë
                    const isGivePoints = sequencingData && sequencingData.questions && sequencingData.questions[index] && sequencingData.questions[index].correctAnswer === 0;
                    let iconClass = '';
                    if (isGivePoints) {
                        // ÈÄÅÂàÜÈ°åÔºöÁÑ°Ë´ñÁ≠îÂ∞çÁ≠îÈåØÈÉΩÈ°ØÁ§∫ÈªÉËâ≤‚ö†Ô∏è
                        iconClass = 'fa-exclamation-triangle text-yellow-500'; // ÈÄÅÂàÜÈ°åÔºöÈªÉËâ≤‰∏âËßíÂΩ¢
                    } else if (correct) {
                        iconClass = 'fa-check-circle text-green-500'; // Ê≠£Á¢∫ÔºöÁ∂†Ëâ≤ÂãæÂãæ
                    } else {
                        iconClass = 'fa-times-circle text-red-500'; // ÈåØË™§ÔºöÁ¥ÖËâ≤ÂèâÂèâ
                    }
                    answerContentHTML += `
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas ${iconClass}"></i>
                                <span class="font-bold">${index + 1}.</span>
                                <span>${item}</span>
                            </div>
                        `;
                    });
                    answerContentHTML += `</div>`;
                } catch (e) {
                    answerContentHTML = `<p class="text-gray-500">Á≠îÊ°àÊ†ºÂºèÈåØË™§</p>`;
                }
            } else if (mode === 'matching') {
                // ÈÖçÂ∞çÈ°åÊ®°Âºè
                try {
                    const studentMatches = JSON.parse(student.answer);
                    const correctPairs = matchingData.pairs;
                    let correctCount = 0;

                    answerContentHTML = `<div class="flex flex-col w-full gap-1">`;
                    studentMatches.forEach(match => {
                        const correctPair = correctPairs.find(p => p.left === match.left);
                        // üöÄ CRITICAL FIX: ÂÖàÂà§Êñ∑ÈÄÅÂàÜÈ°åÔºåÈÅøÂÖçÈÇèËºØÂèçÂêë
                        const isGivePointsMatch = correctPair && correctPair.correctAnswer === 0;
                        const isCorrect = isGivePointsMatch || (correctPair && correctPair.right === match.right);
                        if (isCorrect) correctCount++;

                        let matchIconClass = '';
                        if (isGivePointsMatch) {
                            // ÈÄÅÂàÜÈ°åÔºöÁÑ°Ë´ñÁ≠îÂ∞çÁ≠îÈåØÈÉΩÈ°ØÁ§∫ÈªÉËâ≤‚ö†Ô∏è
                            matchIconClass = 'fa-exclamation-triangle text-yellow-500'; // ÈÄÅÂàÜÈ°åÔºöÈªÉËâ≤‰∏âËßíÂΩ¢
                        } else if (isCorrect) {
                            matchIconClass = 'fa-check-circle text-green-500'; // Ê≠£Á¢∫ÔºöÁ∂†Ëâ≤ÂãæÂãæ
                        } else {
                            matchIconClass = 'fa-times-circle text-red-500'; // ÈåØË™§ÔºöÁ¥ÖËâ≤ÂèâÂèâ
                        }
                        answerContentHTML += `
                            <div class="flex items-center gap-2 text-xs">
                                <i class="fas ${matchIconClass}"></i>
                                <span>${match.left}</span>
                                <i class="fas fa-arrow-right text-gray-400"></i>
                                <span>${match.right}</span>
                            </div>
                        `;
                    });
                    answerContentHTML += `<div class="text-xs text-gray-600 mt-1">Ê≠£Á¢∫: ${correctCount}/${studentMatches.length}</div></div>`;
                } catch (e) {
                    answerContentHTML = `<p class="text-gray-500">Á≠îÊ°àÊ†ºÂºèÈåØË™§</p>`;
                }
            } else if (mode === 'reading_comprehension') {
                // Èñ±ËÆÄÊ∏¨È©óÊ®°Âºè
                try {
                    const studentAnswers = JSON.parse(student.answer);
                    const questions = readingComprehensionData.questions;
                    let correctCount = 0;

                    answerContentHTML = `<div class="flex flex-col w-full" style="font-size: 10px; gap: 1px;">`;
                    studentAnswers.forEach((ans, index) => {
                        if (questions[index]) {
                            // üöÄ CRITICAL FIX: ÂÖàÂà§Êñ∑ÈÄÅÂàÜÈ°åÂÜçÂà§Êñ∑Ê≠£Á¢∫ÔºåÈÅøÂÖçÈÇèËºØÂèçÂêë
                            const isGivePointsReading = questions[index].correctAnswer === 0;
                            const isCorrect = isGivePointsReading || (ans === questions[index].correctAnswer);
                            if (isCorrect) correctCount++;

                            // üöÄ FIXED: Ê≠£Á¢∫ÁöÑÂÑ™ÂÖàÁ¥ö - ÈÄÅÂàÜÈ°åÂÑ™ÂÖàÔºåÁÑ∂ÂæåÊ≠£Á¢∫ÔºåÊúÄÂæåÈåØË™§
                            let readingIconClass = '';
                            if (isGivePointsReading) {
                                // ÈÄÅÂàÜÈ°åÔºöÁÑ°Ë´ñÂ≠∏ÁîüÁ≠î‰ªÄÈ∫ºÈÉΩÈ°ØÁ§∫ÈªÉËâ≤‚ö†Ô∏è
                                readingIconClass = 'fa-exclamation-triangle text-yellow-500'; // ÈÄÅÂàÜÈ°åÔºöÈªÉËâ≤‰∏âËßíÂΩ¢
                            } else if (isCorrect) {
                                readingIconClass = 'fa-check-circle text-green-500'; // Ê≠£Á¢∫ÔºöÁ∂†Ëâ≤ÂãæÂãæ
                            } else {
                                readingIconClass = 'fa-times-circle text-red-500'; // ÈåØË™§ÔºöÁ¥ÖËâ≤ÂèâÂèâ
                            }
                            answerContentHTML += `
                                <div class="flex items-center whitespace-nowrap" style="gap: 4px; line-height: 1.3;">
                                    <i class="fas ${readingIconClass}" style="font-size: 11px;"></i>
                                    <span class="font-bold" style="min-width: 22px;">Q${index + 1}</span>
                                    <span class="text-gray-700" style="min-width: 32px;">Á≠î:${ans || 'Êú™'}</span>
                                    ${!isCorrect && ans > 0 && questions[index].correctAnswer !== 0 ? `<span class="text-gray-500" style="font-size: 9px;">(Ê≠£Á¢∫:${questions[index].correctAnswer})</span>` : ''}
                                </div>
                            `;
                        }
                    });
                    
                    // Ë®àÁÆóÊ≠£Á¢∫ÁéáÂíåÊéíÂêç
                    const accuracy = Math.round((correctCount / questions.length) * 100);
                    const rankInfo = rankedStudents.find(r => r.name === student.name);
                    const rank = rankInfo ? rankedStudents.indexOf(rankInfo) + 1 : null;
                    
                    // ÊéíÂêçÂæΩÁ´†È°èËâ≤
                    let rankBadgeClass = 'bg-gray-100 text-gray-700';
                    let rankIcon = '';
                    if (rank === 1) {
                        rankBadgeClass = 'bg-yellow-100 text-yellow-700';
                        rankIcon = 'ü•á ';
                    } else if (rank === 2) {
                        rankBadgeClass = 'bg-gray-200 text-gray-700';
                        rankIcon = 'ü•à ';
                    } else if (rank === 3) {
                        rankBadgeClass = 'bg-orange-100 text-orange-700';
                        rankIcon = 'ü•â ';
                    } else if (rank <= 5) {
                        rankBadgeClass = 'bg-blue-100 text-blue-700';
                        rankIcon = 'üèÖ ';
                    }
                    
                    const rankBadge = rank ? `<span class="px-1.5 py-0.5 ${rankBadgeClass} text-xs font-bold rounded ml-1">${rankIcon}Á¨¨${rank}Âêç</span>` : '';
                    
                    // üöÄ NEW: Format time display for teacher view
                    let teacherTimeDisplay = '';
                    if (student.durationMs) {
                        const duration = formatDuration(student.durationMs);
                        teacherTimeDisplay = `<div class="text-xs text-gray-500 mt-1">‚è±Ô∏è ${duration.longLabel}</div>`;
                    }
                    if (student.timestamp) {
                        const absoluteTime = formatAbsoluteTime(student.timestamp, false);
                        teacherTimeDisplay += `<div class="text-xs text-gray-500 mt-0.5">üìÖ ${absoluteTime}</div>`;
                    }
                    
                    // üöÄ NEW: Á≠ÜË®òË©ïÂàÜÈ°ØÁ§∫
                    let highlightScoreDisplay = '';
                    if (student.highlightAnalysis && student.highlightAnalysis.score > 0) {
                        const analysis = student.highlightAnalysis;
                        const scoreCardId = `highlight-score-${student.name.replace(/\s/g, '-')}`;
                        
                        highlightScoreDisplay = `
                            <div class="mt-2 pt-2 border-t">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-bold text-purple-700">üìù Á≠ÜË®òÂä†ÂàÜ:</span>
                                    <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs font-bold rounded">+${analysis.score} ÂàÜ</span>
                                </div>
                                <div class="text-xs text-gray-600 mt-1 cursor-pointer hover:text-purple-600" onclick="document.getElementById('${scoreCardId}').classList.toggle('hidden')">
                                    <i class="fas fa-info-circle"></i> ÈªûÊìäÊü•ÁúãË©ïÂàÜÊòéÁ¥∞
                                </div>
                                <div id="${scoreCardId}" class="hidden mt-2 p-2 bg-purple-50 rounded text-xs space-y-1">
                                    <div class="font-bold text-purple-800 mb-1">Ë©ïÂàÜÊòéÁ¥∞Ôºö</div>
                                    <div class="flex justify-between"><span>üé® È°èËâ≤Â§öÊ®£ÊÄß:</span><span class="font-bold">+${analysis.breakdown.colorDiversity}</span></div>
                                    <div class="flex justify-between"><span>üéØ Á≤æÁ¢∫Â∫¶:</span><span class="font-bold">+${analysis.breakdown.precision}</span></div>
                                    <div class="flex justify-between"><span>üìç ÂàÜÊÆµÊÄß:</span><span class="font-bold">+${analysis.breakdown.segmentation}</span></div>
                                    <div class="flex justify-between"><span>üîó Á≠îÈ°åÈóúËÅØ:</span><span class="font-bold">+${analysis.breakdown.relevance}</span></div>
                                    <div class="flex justify-between"><span>‚è±Ô∏è ÊôÇÈñìÂàÜÈÖç:</span><span class="font-bold">+${analysis.breakdown.timeDistribution}</span></div>
                                    <div class="mt-2 pt-2 border-t border-purple-200 text-xs text-gray-600">
                                        <div>Ê®ôË®ªÊï∏: ${analysis.stats.highlightCount} ÂÄã</div>
                                        <div>È°èËâ≤Êï∏: ${analysis.stats.colorCount} Á®Æ</div>
                                        <div>Ë¶ÜËìãÁéá: ${analysis.stats.coverageRate}%</div>
                                        <div>ÊÆµËêΩÊï∏: ${analysis.stats.segmentCount} ÊÆµ</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    answerContentHTML += `<div class="font-bold mt-1 pt-1 border-t flex items-center justify-between ${correctCount === questions.length ? 'text-green-600' : 'text-gray-700'}" style="font-size: 10px;">
                        <span>Ê≠£Á¢∫: ${correctCount}/${questions.length} (${accuracy}%)</span>
                        ${rankBadge}
                    </div>
                    ${teacherTimeDisplay}
                    ${highlightScoreDisplay}
                    </div>`;
                } catch (e) {
                    answerContentHTML = `<p class="text-gray-500">Á≠îÊ°àÊ†ºÂºèÈåØË™§</p>`;
                }
            } else {
                // È†êË®≠ÈÅ∏ÊìáÈ°åÊ®°Âºè (1-4)
                answerContentHTML = `<p class="text-2xl font-bold text-blue-600">${student.answer}</p>`;
            }
            
            // ÂæûÂÖ®Â±Ä presence Map ‰∏≠ËÆÄÂèñÂ≠∏ÁîüÂàÜÂøÉÁãÄÊÖãÔºàÊâÄÊúâÊ®°ÂºèÈÄöÁî®Ôºâ
            const presenceData = activeStudentsPresenceMap.get(student.name) || { isDistracted: false, distractionCount: 0 };
            const isDistracted = presenceData.isDistracted;
            // üöÄ PRIVACY FIX: Èö±ÂØÜÂ≠∏ÁîüÂàÜÂøÉÊ¨°Êï∏ÂæΩÁ´† - Èò≤Ê≠¢Â≠∏ÁîüÁúãÂà∞Ê¨°Êï∏Á¥ØÂä†ËÄåÂèçË¶ÜÂàáÊèõÈ†ÅÈù¢
            const distractionWarning = isDistracted 
                ? `<i class="fas fa-exclamation-triangle text-red-600 animate-pulse" title="Â≠∏ÁîüÂàÜÂøÉ‰∏≠"></i>` 
                : '';
            const cardBgClass = isDistracted ? 'bg-red-50 border-2 border-red-400' : '';
            
            card.className = `student-response-item ${cardBgClass}`;
            card.innerHTML = `
                <div class="name-box flex items-center justify-between">
                    <span>${student.name}</span>
                    <div class="flex items-center gap-1">
                        <span class="distraction-status">${distractionWarning}</span>
                        <button class="kick-student-btn hover:bg-red-100 rounded px-2 py-1 transition-colors" data-student-name="${student.name}" title="Ë∏¢ÊéâÊ≠§Â≠∏Áîü">
                            <i class="fas fa-times text-red-600 font-bold"></i>
                        </button>
                    </div>
                </div>
                <div class="answer-box">
                    ${answerContentHTML}
                </div>
            `;
            container.appendChild(card);
            
            // üöÄ NEW: ÁÇ∫Ë∏¢Âá∫ÊåâÈàïÊ∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
            const kickBtn = card.querySelector('.kick-student-btn');
            if (kickBtn) {
                console.log(`[KickBtn] ‚úì ÁÇ∫ ${student.name} Á∂ÅÂÆöË∏¢Âá∫ÊåâÈàï‰∫ã‰ª∂`);
                kickBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    const studentName = e.currentTarget.dataset.studentName;
                    console.log(`[KickBtn] üîî Ë∏¢Âá∫ÊåâÈàïË¢´ÈªûÊìä: ${studentName}`);
                    kickStudentFromClass(studentName);
                });
            } else {
                console.warn(`[KickBtn] ‚ö†Ô∏è Êâæ‰∏çÂà∞ ${student.name} ÁöÑË∏¢Âá∫ÊåâÈàï`);
            }
            
            // ÁâπÊÆäËôïÁêÜÔºöÁπ™ÂúñÊ®°ÂºèÊ∑ªÂä†ÈªûÊìäÊîæÂ§ßÂäüËÉΩ
            if (mode === 'drawing') {
                const imgElement = card.querySelector('.answer-box img');
                if (imgElement) {
                    imgElement.addEventListener('click', (e) => {
                        const fullImageUrl = e.target.dataset.fullImage;
                        showMagnifiedDrawing(fullImageUrl);
                    });
                }
            }
        }

        /**
         * üöÄ NEW: (Teacher) Ë∏¢ÊéâÊüêÂÄãÂ≠∏Áîü - Âº∑Âà∂ÁôªÂá∫Ë©≤Â≠∏Áîü
         * @param {string} studentName - Ë¶ÅË∏¢ÊéâÁöÑÂ≠∏ÁîüÂêçÁ®±
         */
        async function kickStudentFromClass(studentName) {
            console.log(`[KickStudent] üìù kickStudentFromClass Ë¢´Ë™øÁî®: ${studentName}`);
            // Á¢∫Ë™çÂ∞çË©±Ê°Ü
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDialog.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-11/12">
                    <h3 class="text-xl font-bold text-red-700 mb-4">
                        <i class="fas fa-exclamation-circle mr-2"></i>Á¢∫Ë™çË∏¢ÊéâÂ≠∏Áîü
                    </h3>
                    <p class="text-gray-700 mb-6">Á¢∫ÂÆöË¶ÅË∏¢Êéâ <strong>${studentName}</strong> ÂóéÔºü
                    <br/>Ë©≤Â≠∏ÁîüÂ∞áË¢´Âº∑Âà∂ÁôªÂá∫‰∏¶ÈúÄË¶ÅÈáçÊñ∞ÁôªÂÖ•„ÄÇ</p>
                    <div class="flex gap-3 justify-end">
                        <button class="kick-cancel-btn px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded text-gray-800 font-semibold transition-colors">
                            ÂèñÊ∂à
                        </button>
                        <button class="kick-confirm-btn px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white font-semibold transition-colors">
                            Á¢∫Ë™çË∏¢Êéâ
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDialog);
            
            // ÂèñÊ∂àÊåâÈàï
            const cancelBtn = confirmDialog.querySelector('.kick-cancel-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    confirmDialog.remove();
                });
            }
            
            // Á¢∫Ë™çÊåâÈàï
            const confirmBtn = confirmDialog.querySelector('.kick-confirm-btn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', async () => {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'ËôïÁêÜ‰∏≠...';
                    await performKickStudent(studentName);
                    confirmDialog.remove();
                });
            }
        }
        
        /**
         * üöÄ NEW: Âü∑Ë°åË∏¢ÊéâÂ≠∏ÁîüÁöÑÊìç‰Ωú - Âà™Èô§ Firestore ‰∏≠ÁöÑÂ≠∏ÁîüÊï∏Êìö
         * @param {string} studentName - Ë¶ÅË∏¢ÊéâÁöÑÂ≠∏ÁîüÂêçÁ®±
         */
        async function performKickStudent(studentName) {
            try {
                // üöÄ CRITICAL FIX: ÂÖàÊääÂ≠∏ÁîüÂä†ÂÖ• pendingKickStudentsÔºåÈò≤Ê≠¢ presence listener ÈáçÊñ∞Ê∑ªÂä†
                pendingKickStudents.add(studentName);
                console.log(`[Teacher] üîí Â∑≤Â∞á ${studentName} Âä†ÂÖ• pendingKickStudents`);
                
                // üöÄ CRITICAL: ÂÖàÂæûÊú¨Âú∞ÁãÄÊÖãÁßªÈô§ÔºåÁ¢∫‰øù onSnapshot Ëß∏ÁôºÊôÇ‰∏çÊúÉÈáçÊñ∞Ê∏≤ÊüìË©≤Â≠∏Áîü
                activeStudentNames = activeStudentNames.filter(name => name !== studentName);
                activeStudentsPresenceMap.delete(studentName);
                console.log(`[Teacher] üîÑ Â∑≤ÂæûÊú¨Âú∞ÁãÄÊÖãÁßªÈô§: ${studentName}`);
                
                // üöÄ NEW: ÂÖàÁßªÈô§ DOM Âç°ÁâáÔºàÂú®Âà™Èô§ Firestore ÊñáÊ™î‰πãÂâçÔºâ
                removeStudentCardFromDOM(studentName);
                
                // Âà™Èô§Â≠∏ÁîüÊèê‰∫§Ë®òÈåÑÔºà‰ΩøÁî® studentName ‰ΩúÁÇ∫ÊñáÊ™î IDÔºâ
                const responseRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                await deleteDoc(responseRef);
                console.log(`[Teacher] ‚úÖ Â∑≤Âà™Èô§ ${studentName} ÁöÑÊèê‰∫§Ë®òÈåÑ`);
                
                // üöÄ CRITICAL FIX: Â≠∏ÁîüÁ´Ø presence ÊñáÊ™î‰ΩøÁî® userId ‰ΩúÁÇ∫ IDÔºåËÄåÈùû studentName
                // ÈúÄË¶ÅÊü•Ë©¢ presence collection ÊâæÂà∞ name === studentName ÁöÑÊñáÊ™î‰∏¶Âà™Èô§
                const presenceColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
                const presenceQuery = query(presenceColRef, where('name', '==', studentName));
                const presenceSnapshot = await getDocs(presenceQuery);
                
                if (!presenceSnapshot.empty) {
                    // Âà™Èô§ÊâÄÊúâÂåπÈÖçÁöÑ presence ÊñáÊ™îÔºàÈÄöÂ∏∏Âè™Êúâ‰∏ÄÂÄãÔºâ
                    const deletePromises = [];
                    presenceSnapshot.forEach((docSnapshot) => {
                        console.log(`[Teacher] üîç ÊâæÂà∞ ${studentName} ÁöÑ presence ÊñáÊ™îÔºåID: ${docSnapshot.id}`);
                        deletePromises.push(deleteDoc(docSnapshot.ref));
                    });
                    await Promise.all(deletePromises);
                    console.log(`[Teacher] ‚úÖ Â∑≤Âà™Èô§ ${studentName} ÁöÑ presence Ë®òÈåÑ`);
                } else {
                    console.warn(`[Teacher] ‚ö†Ô∏è Êâæ‰∏çÂà∞ ${studentName} ÁöÑ presence ÊñáÊ™î`);
                }
                
                // Êõ¥Êñ∞ÂÑÄË°®Êùø
                updateTeacherDashboard(currentInteractionMode);
                
                console.log(`[Teacher] ‚úÖ Ë∏¢ÊéâÂ≠∏ÁîüÂÆåÊàê: ${studentName}`);
                showMessage(`Â∑≤Ë∏¢Êéâ ${studentName}ÔºåË©≤Â≠∏ÁîüÈúÄË¶ÅÈáçÊñ∞ÁôªÂÖ•„ÄÇ`, 'success');
                
                // üöÄ CLEANUP: Âª∂ÈÅ≤ÁßªÈô§ pendingKickStudentsÔºàÁµ¶ onSnapshot Ë∂≥Â§†ÊôÇÈñìËôïÁêÜÔºâ
                setTimeout(() => {
                    pendingKickStudents.delete(studentName);
                    console.log(`[Teacher] üîì Â∑≤Âæû pendingKickStudents ÁßªÈô§: ${studentName}`);
                }, 2000);
            } catch (error) {
                console.error('[Teacher] ‚ùå Ë∏¢ÊéâÂ≠∏ÁîüÂ§±Êïó:', error);
                showMessage(`Ë∏¢Êéâ ${studentName} Â§±ÊïóÔºö${error.message}`, 'error');
                // üöÄ CLEANUP: Âç≥‰ΩøÂ§±Êïó‰πüË¶ÅÂæû pendingKickStudents ÁßªÈô§
                pendingKickStudents.delete(studentName);
            }
        }
        
        /**
         * üöÄ NEW: Âæû DOM ‰∏≠ÁßªÈô§ÊåáÂÆöÂ≠∏ÁîüÁöÑÂç°Áâá
         * @param {string} studentName - Ë¶ÅÁßªÈô§ÁöÑÂ≠∏ÁîüÂêçÁ®±
         */
        function removeStudentCardFromDOM(studentName) {
            const container = document.getElementById('student-responses-container');
            if (!container) {
                console.warn('[Teacher] ‚ö†Ô∏è student-responses-container ‰∏çÂ≠òÂú®');
                return;
            }
            
            // üöÄ CRITICAL FIX: ‰ΩøÁî®Ê≠£Á¢∫ÁöÑÈÅ∏ÊìáÂô® - class ÊòØ student-response-itemÔºåÂêçÁ®±Âú® data-student-name Â±¨ÊÄß‰∏≠
            const card = container.querySelector(`.student-response-item[data-student-name="${studentName}"]`);
            if (card) {
                card.remove();
                console.log(`[Teacher] üóëÔ∏è Â∑≤Âæû DOM ÁßªÈô§ ${studentName} ÁöÑÂç°Áâá`);
            } else {
                console.warn(`[Teacher] ‚ö†Ô∏è Êâæ‰∏çÂà∞ ${studentName} ÁöÑÂç°Áâá DOM ÂÖÉÁ¥†`);
            }
        }

        // üöÄ NEW: Èò≤ÊäñËÆäÊï∏ÔºåÈò≤Ê≠¢ refreshStudentCardsFromPresence Ë¢´ÈáçË§áËß∏Áôº
        let refreshCardsDebounceTimer = null;
        let refreshCardsInProgress = false;
        
        /**
         * üöÄ NEW: Áï∂ presence ËÆäÂåñÊôÇÔºåÂ¢ûÈáèÊõ¥Êñ∞Â≠∏ÁîüÂç°ÁâáÔºà‰∏çÁ≠âÂæÖ studentResponses snapshotÔºâ
         * ÈÄôËß£Ê±∫‰∫ÜÂ≠∏ÁîüÈáçÊñ∞ÁôªÂÖ•ÂæåÂç°Áâá‰∏çÊúÉÂç≥ÊôÇÂá∫ÁèæÁöÑÂïèÈ°å
         * ‰ΩøÁî®Èò≤ÊäñÊ©üÂà∂Èò≤Ê≠¢Áü≠ÊôÇÈñìÂÖßÈáçË§áËß∏ÁôºÂ∞éËá¥Âç°ÁâáÈáçË§á
         */
        function refreshStudentCardsFromPresence() {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊôÇÂô®
            if (refreshCardsDebounceTimer) {
                clearTimeout(refreshCardsDebounceTimer);
            }
            
            // ‰ΩøÁî®Èò≤ÊäñÔºöÂª∂ÈÅ≤ 100ms Âü∑Ë°åÔºåÂêà‰ΩµÂø´ÈÄüÈÄ£Á∫åÁöÑË™øÁî®
            refreshCardsDebounceTimer = setTimeout(() => {
                _doRefreshStudentCards();
            }, 100);
        }
        
        async function _doRefreshStudentCards() {
            // Èò≤Ê≠¢‰∏¶ÁôºÂü∑Ë°å
            if (refreshCardsInProgress) {
                console.log('[RefreshCards] ‚è≥ Already in progress, skipping');
                return;
            }
            
            if (currentRole !== 'teacher' || !classroomCode) {
                return;
            }
            
            const container = document.getElementById('student-responses-container');
            if (!container) {
                console.log('[RefreshCards] ‚ö†Ô∏è Container not found');
                return;
            }
            
            // Ê™¢Êü•Áï∂ÂâçÊòØÂê¶Âú®ÈúÄË¶ÅÈ°ØÁ§∫Âç°ÁâáÁöÑÊ®°Âºè
            // üöÄ FIX: Êì¥Â±ïÊîØÊè¥ÊâÄÊúâ‰πùÂÆÆÊ†ºÈ°åÂûãÔºåÁ¢∫‰øùÊâÄÊúâÊ®°ÂºèÈÉΩËÉΩÂç≥ÊôÇÁõ£ÊéßÂ≠∏ÁîüÈáçÊñ∞ÁôªÂÖ•
            const validModes = [
                'true_false',           // ÊòØÈùûÈ°å
                'text_input',           // ÊñáÂ≠óÈ°å ‚úÖ Êñ∞Â¢û
                'multiple_choice',      // ÈÅ∏ÊìáÈ°å
                'drawing',              // Áπ™ÂúñÊùø
                'url_dispatch',         // Ê¥æÈÄÅÁ∂≤ÂùÄ/HTML ‚úÖ Êñ∞Â¢û
                'quick_answer',         // Âø´ÂïèÂø´Á≠î/Êê∂Á≠î
                'quick_poll',           // Âø´ÈÄüÊäïÁ•®
                'recording',            // ÈåÑÈü≥/Ë™ûÈü≥
                'reading_comprehension',// Èñ±ËÆÄÊ∏¨È©ó
                'peer_review',          // ÂêåÂÑï‰∫íË©ï
                'voting',               // ÊäïÁ•®
                'sequencing',           // ÊéíÂ∫èÈ°å
                'matching'              // ÈÖçÂ∞çÈ°å
            ];
            if (!validModes.includes(currentInteractionMode)) {
                console.log('[RefreshCards] ‚ÑπÔ∏è Current mode does not require cards:', currentInteractionMode);
                return;
            }
            
            refreshCardsInProgress = true;
            
            try {
                // Áç≤ÂèñÁï∂ÂâçÂ∑≤È°ØÁ§∫ÁöÑÂ≠∏ÁîüÂç°Áâá
                const existingCards = container.querySelectorAll('.student-response-item[data-student-name]');
                const existingStudentNames = new Set();
                existingCards.forEach(card => {
                    existingStudentNames.add(card.getAttribute('data-student-name'));
                });
                
                // üöÄ FIX: Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂÆåÂÖ®ÈáçÊñ∞Ê∏≤Êüì
                // Ê¢ù‰ª∂1: ÂÆπÂô®ÁÇ∫Á©∫ÊàñÂè™ÊúâÊèêÁ§∫ÊñáÂ≠óÔºàÊ≤íÊúâ‰ªª‰ΩïÂ≠∏ÁîüÂç°ÁâáÔºâ
                // Ê¢ù‰ª∂2: ÊúâÂú®Á∑öÂ≠∏Áîü‰ΩÜÊ≤íÊúâÂ∞çÊáâÁöÑÂç°Áâá
                const hasNoCards = existingCards.length === 0;
                const hasOnlineStudents = activeStudentNames.length > 0;
                const needsFullRender = hasNoCards && hasOnlineStudents;
                
                if (needsFullRender) {
                    console.log(`[RefreshCards] üîÑ Full render needed: ${activeStudentNames.length} online students, 0 cards`);
                    
                    // Âæû Firestore Áç≤ÂèñÊâÄÊúâÂ≠∏ÁîüÁöÑÂõûÊáâ
                    const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                    let responsesMap = new Map();
                    
                    try {
                        const snapshot = await getDocs(studentsColRef);
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            responsesMap.set(data.name, data);
                        });
                    } catch (error) {
                        console.warn('[RefreshCards] ‚ö†Ô∏è Failed to fetch responses:', error);
                    }
                    
                    // üöÄ CRITICAL FIX: Áï∞Ê≠•Êìç‰ΩúÂÆåÊàêÂæåÔºåÂÜçÊ¨°Ê™¢Êü•ÂÆπÂô®ÁãÄÊÖã
                    // Èò≤Ê≠¢Ëàá listenToStudentSubmissions Á´∂ÊÖãÊ¢ù‰ª∂Â∞éËá¥ÈáçË§áÂç°Áâá
                    const cardsAfterAwait = container.querySelectorAll('.student-response-item[data-student-name]');
                    if (cardsAfterAwait.length > 0) {
                        console.log(`[RefreshCards] ‚ö†Ô∏è Skipping render - ${cardsAfterAwait.length} cards already exist (created by onSnapshot)`);
                        return;
                    }
                    
                    // Ê∏ÖÁ©∫ÂÆπÂô®ÔºàÂú®Á¢∫Ë™çÊ≤íÊúâÂÖ∂‰ªñÈÄ≤Á®ãÂâµÂª∫Âç°ÁâáÂæåÊâçÊ∏ÖÁ©∫Ôºâ
                    container.innerHTML = '';
                    
                    // ÁÇ∫ÊâÄÊúâÂú®Á∑öÂ≠∏ÁîüÂâµÂª∫Âç°Áâá
                    activeStudentNames.forEach(studentName => {
                        // üöÄ CRITICAL: ÂâµÂª∫ÂâçÊúÄÂæå‰∏ÄÊ¨°Ê™¢Êü•ÔºåÈò≤Ê≠¢ÈáçË§á
                        const existingCard = container.querySelector(`.student-response-item[data-student-name="${studentName}"]`);
                        if (existingCard) {
                            console.log(`[RefreshCards] ‚ö†Ô∏è Card for ${studentName} already exists, skipping`);
                            return;
                        }
                        const studentData = responsesMap.get(studentName) || { name: studentName, answer: null };
                        createStudentCard(studentData, container, currentInteractionMode);
                    });
                    
                    // üöÄ FIX: Âº∑Âà∂ÁÄèË¶ΩÂô®ÈáçÁπ™ÔºåÁ¢∫‰øùÂç°ÁâáÁ´ãÂç≥È°ØÁ§∫
                    void container.offsetHeight; // Ëß∏ÁôºÂêåÊ≠•ÈáçÊéí
                    requestAnimationFrame(() => {
                        container.style.opacity = '0.99';
                        requestAnimationFrame(() => {
                            container.style.opacity = '1';
                        });
                    });
                    
                    console.log(`[RefreshCards] ‚úÖ Full render completed: ${activeStudentNames.length} cards created`);
                    return;
                }
                
                // ÊâæÂá∫ÈúÄË¶ÅÊñ∞Â¢ûÁöÑÂ≠∏ÁîüÔºàÂú®Á∑ö‰ΩÜÊ≤íÊúâÂç°ÁâáÔºâ
                const newStudents = activeStudentNames.filter(name => !existingStudentNames.has(name));
                
                if (newStudents.length === 0) {
                    console.log('[RefreshCards] ‚ÑπÔ∏è No new students to add');
                    return;
                }
                
                console.log(`[RefreshCards] üÜï Adding cards for ${newStudents.length} new students:`, newStudents);
                
                // ÂòóË©¶Âæû Firestore Áç≤ÂèñÈÄô‰∫õÂ≠∏ÁîüÁöÑÂõûÊáâÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
                const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                let responsesMap = new Map();
                
                try {
                    const snapshot = await getDocs(studentsColRef);
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (newStudents.includes(data.name)) {
                            responsesMap.set(data.name, data);
                        }
                    });
                } catch (error) {
                    console.warn('[RefreshCards] ‚ö†Ô∏è Failed to fetch responses:', error);
                }
                
                // ÁßªÈô§„ÄåÊ≤íÊúâÂ≠∏ÁîüÂú®Á∑ö„ÄçÊèêÁ§∫ÔºàÂ¶ÇÊûúÊúâÔºâ
                const noStudentMsg = container.querySelector('.text-gray-500.text-center');
                if (noStudentMsg) {
                    noStudentMsg.remove();
                }
                
                // ÁÇ∫ÊØèÂÄãÊñ∞Â≠∏ÁîüÂâµÂª∫Âç°ÁâáÔºàÂÜçÊ¨°Ê™¢Êü•Èò≤Ê≠¢ÈáçË§áÔºâ
                let addedCount = 0;
                newStudents.forEach(studentName => {
                    // üöÄ CRITICAL: ÂâµÂª∫ÂâçÂÜçÊ¨°Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®
                    const existingCard = container.querySelector(`.student-response-item[data-student-name="${studentName}"]`);
                    if (existingCard) {
                        console.log(`[RefreshCards] ‚ö†Ô∏è Card for ${studentName} already exists, skipping`);
                        return;
                    }
                    
                    const studentData = responsesMap.get(studentName) || { name: studentName, answer: null };
                    createStudentCard(studentData, container, currentInteractionMode);
                    addedCount++;
                });
                
                if (addedCount > 0) {
                    console.log(`[RefreshCards] ‚úÖ Added ${addedCount} new student cards`);
                    
                    // üöÄ FIX: Âº∑Âà∂ÁÄèË¶ΩÂô®ÈáçÁπ™ÔºåÁ¢∫‰øùÂç°ÁâáÁ´ãÂç≥È°ØÁ§∫
                    void container.offsetHeight;
                    requestAnimationFrame(() => {
                        container.style.opacity = '0.99';
                        requestAnimationFrame(() => {
                            container.style.opacity = '1';
                        });
                    });
                }
            } finally {
                refreshCardsInProgress = false;
            }
        }

        /**
         * (Teacher) Listens for all student submissions and dynamically displays them.
         * üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager ÁÆ°ÁêÜÁõ£ËÅΩÂô®
         * @param {string} mode - The current interaction mode, used to determine the answer type.
         */
        function listenToStudentSubmissions(mode) {
             // Use classroomCode in the Firestore path
             const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
             const container = document.getElementById('student-responses-container');

             const unsubscribe = onSnapshot(studentsColRef, (querySnapshot) => {
                container.innerHTML = ''; 
                lastSelectedStudentCard = null; 
                
                // REMOVED: document.getElementById('responded-student-count').textContent = querySnapshot.size; 

                // üöÄ NEW: ÁÇ∫ÊâÄÊúâÊ®°ÂºèÁµ±‰∏ÄËôïÁêÜ - È°ØÁ§∫ÊâÄÊúâÂú®Á∑öÂ≠∏ÁîüÔºàÂåÖÊã¨Êú™Êèê‰∫§ÁöÑÔºâ
                // ÂâµÂª∫‰∏ÄÂÄã Map ‰æÜÂø´ÈÄüÊü•ÊâæÂ∑≤Êèê‰∫§Á≠îÊ°àÁöÑÂ≠∏Áîü
                const responsesMap = new Map();
                querySnapshot.forEach((doc) => {
                    const student = doc.data();
                    responsesMap.set(student.name, student);
                });
                
                // ÁÇ∫ÊâÄÊúâÂú®Á∑öÂ≠∏ÁîüÂâµÂª∫ÈüøÊáâÊï∏ÁµÑÔºàÂåÖÊã¨Êú™Êèê‰∫§Á≠îÊ°àÁöÑÔºâ
                let responses = [];
                activeStudentNames.forEach(studentName => {
                    if (responsesMap.has(studentName)) {
                        // Â≠∏ÁîüÂ∑≤Êèê‰∫§Á≠îÊ°à
                        responses.push(responsesMap.get(studentName));
                    } else {
                        // Â≠∏ÁîüÊú™Êèê‰∫§Á≠îÊ°àÔºåÂâµÂª∫‰Ωî‰ΩçÊï∏Êìö
                        responses.push({
                            name: studentName,
                            answer: null
                        });
                    }
                });
                
                // üöÄ FIX: Âç≥‰ΩøÊ≤íÊúâÂ≠∏ÁîüÂú®Á∑öÔºå‰πüË¶ÅËôïÁêÜÔºàÊ∏ÖÁ©∫ÂÆπÂô®Ôºâ
                if (responses.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center col-span-full">Ê≤íÊúâÂ≠∏ÁîüÂú®Á∑ö...</p>';
                    allStudentResponses = [];
                    clearStudentsByAnswerList();
                    return;
                }
                
                // Ë®àÁÆóÈñ±ËÆÄÊ∏¨È©óÊéíÂêçÔºàÂ¶ÇÊûúÊòØÈñ±ËÆÄÊ∏¨È©óÊ®°ÂºèÔºâ
                let rankedStudents = [];
                if (mode === 'reading_comprehension' && readingComprehensionData.questions) {
                    responses.forEach(student => {
                        if (student.answer) {
                            try {
                                const studentAnswers = JSON.parse(student.answer);
                                const questions = readingComprehensionData.questions;
                                let correctCount = 0;
                                studentAnswers.forEach((ans, index) => {
                                    if (questions[index] && ans === questions[index].correctAnswer) {
                                        correctCount++;
                                    }
                                });
                                const accuracy = Math.round((correctCount / questions.length) * 100);
                                
                                // üöÄ CRITICAL FIX: ÂÑ™ÂÖà‰ΩøÁî® Firestore ‰∏≠ÁöÑÊ¨äÂ®ÅÂàÜÊï∏ÔºåÁ¢∫‰øùÊïôÂ∏´Á´ØÊéíÂêçËàáÂ≠∏ÁîüÁ´Ø‰∏ÄËá¥
                                let baseScore, highlightBonus, totalScore;
                                if (student.baseScore !== undefined && student.totalScore !== undefined) {
                                    baseScore = student.baseScore;
                                    highlightBonus = student.highlightAnalysis ? student.highlightAnalysis.score : 0;
                                    totalScore = student.totalScore;
                                } else {
                                    baseScore = accuracy;
                                    highlightBonus = (student.highlightAnalysis && student.highlightAnalysis.score) || 0;
                                    totalScore = baseScore + highlightBonus;
                                }
                                
                                rankedStudents.push({
                                    name: student.name,
                                    correctCount: correctCount,
                                    totalQuestions: questions.length,
                                    accuracy: accuracy,
                                    baseScore: baseScore,
                                    highlightBonus: highlightBonus,
                                    totalScore: totalScore,
                                    timestamp: student.timestamp,
                                    durationMs: student.durationMs || null
                                });
                            } catch (e) {
                                // Á≠îÊ°àÊ†ºÂºèÈåØË™§Ôºå‰∏çÂä†ÂÖ•ÊéíÂêç
                            }
                        }
                    });
                    // üöÄ CRITICAL FIX: ÊéíÂ∫èÈÇèËºØ - Á∏ΩÂàÜÈôçÂ∫èÔºàÂü∫Á§éÂàÜ+Á≠ÜË®òÂä†ÂàÜÔºâ‚Üí ‰ΩúÁ≠îÊôÇÈï∑ÂçáÂ∫è ‚Üí Êèê‰∫§ÊôÇÈñìÂçáÂ∫è ‚Üí ÂßìÂêçÂçáÂ∫è
                    rankedStudents.sort((a, b) => {
                        // 1. ‰∏ªË¶ÅÊéíÂ∫èÔºöÁ∏ΩÂàÜÈ´òÁöÑÂú®ÂâçÔºàÂü∫Á§éÂàÜ + Á≠ÜË®òÂä†ÂàÜÔºâ
                        if (b.totalScore !== a.totalScore) {
                            return b.totalScore - a.totalScore;
                        }
                        // 2. Ê¨°Ë¶ÅÊéíÂ∫èÔºö‰ΩúÁ≠îÊôÇÈï∑Áü≠ÁöÑÂú®ÂâçÔºàÂêåÂàÜÊôÇÊõ¥Âø´ÂÆåÊàêÊéíÂêçÊõ¥È´òÔºâ
                        if (a.durationMs && b.durationMs) {
                            return a.durationMs - b.durationMs;
                        }
                        // Â¶ÇÊûúÂè™Êúâ‰∏ÄÊñπÊúâ‰ΩúÁ≠îÊôÇÈï∑ÔºåÊúâ‰ΩúÁ≠îÊôÇÈï∑ÁöÑÊéíÂú®ÂâçÈù¢
                        if (a.durationMs && !b.durationMs) return -1;
                        if (!a.durationMs && b.durationMs) return 1;
                        // 3. Á¨¨‰∏âÊéíÂ∫èÔºöÊèê‰∫§ÊôÇÈñìÊó©ÁöÑÂú®ÂâçÔºà‰ΩúÁÇ∫ÂæåÂÇôÔºâ
                        if (a.timestamp && b.timestamp) {
                            const timeA = a.timestamp.toMillis ? a.timestamp.toMillis() : new Date(a.timestamp).getTime();
                            const timeB = b.timestamp.toMillis ? b.timestamp.toMillis() : new Date(b.timestamp).getTime();
                            if (timeA !== timeB) {
                                return timeA - timeB;
                            }
                        }
                        // 4. ÊúÄÂæåÊéíÂ∫èÔºöÂßìÂêçÂ≠óÊØçÈ†ÜÂ∫è
                        return a.name.localeCompare(b.name);
                    });
                    
                    // üöÄ NEW: ÈáçÊñ∞ÊéíÂ∫è responses Êï∏ÁµÑÔºöÂ∑≤Êèê‰∫§ÁöÑÊåâÊéíÂêçÔºåÊú™Êèê‰∫§ÁöÑÊåâÂßìÂêçÊéíÂú®ÂæåÈù¢
                    const rankMap = new Map();
                    rankedStudents.forEach((student, index) => {
                        rankMap.set(student.name, index);
                    });
                    
                    responses.sort((a, b) => {
                        const hasAnswerA = a.answer !== null && a.answer !== undefined;
                        const hasAnswerB = b.answer !== null && b.answer !== undefined;
                        
                        // Â∑≤Êèê‰∫§ÁöÑÊéíÂú®ÂâçÈù¢
                        if (hasAnswerA && !hasAnswerB) return -1;
                        if (!hasAnswerA && hasAnswerB) return 1;
                        
                        // ÈÉΩÂ∑≤Êèê‰∫§ÔºöÊåâÊéíÂêç
                        if (hasAnswerA && hasAnswerB) {
                            const rankA = rankMap.has(a.name) ? rankMap.get(a.name) : 9999;
                            const rankB = rankMap.has(b.name) ? rankMap.get(b.name) : 9999;
                            return rankA - rankB;
                        }
                        
                        // ÈÉΩÊú™Êèê‰∫§ÔºöÊåâÂßìÂêç
                        return a.name.localeCompare(b.name);
                    });
                }
                
                // üöÄ NEW: ‰ΩøÁî®Áµ±‰∏ÄÁöÑÂç°ÁâáÁîüÊàêÂáΩÊï∏ÔºàÊîØÊåÅÊâÄÊúâ9Á®ÆÊ®°ÂºèÔºåÂåÖÂê´ÂàÜÂøÉÁãÄÊÖãÁõ£ÊéßÔºâ
                responses.forEach(student => {
                    createStudentCard(student, container, mode, rankedStudents);
                });

                allStudentResponses = responses;

                // Special handling for quick answer mode
                if (mode === 'quick_answer') {
                    console.log('Teacher: Processing quick answer responses:', responses);
                    const quickAnswerWinners = responses.filter(student =>
                        student.answer && student.answer.includes('Êê∂Á≠îÊàêÂäü')
                    );
                    console.log('Teacher: Quick answer winners found:', quickAnswerWinners);

                    if (quickAnswerWinners.length > 0) {
                        const winner = quickAnswerWinners[0]; // First one to answer
                        console.log('Teacher: Showing winner:', winner.name);
                        showQuickAnswerWinner(winner.name);
                    }
                }

                if (!statisticsModal.classList.contains('hidden')) {
                    drawChart(allStudentResponses, currentInteractionMode);
                }
                
                // üöÄ NEW: Êõ¥Êñ∞ÊïôÂ∏´ÂÑÄË°®Êùø - ÂØ¶ÊôÇÊõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù„ÄÅÂú®Á∑öÂ≠∏Áîü„ÄÅÂàÜÂøÉÊèêÈÜí
                updateTeacherDashboard(mode);
             }, (error) => {
                 console.error("[Teacher] Error listening to student submissions:", error);
                 showMessage("ÁÑ°Ê≥ïÁõ£ËÅΩÂ≠∏Áîü‰ΩúÁ≠îÔºåË´ãÊ™¢Êü•ÈÄ£Á∑ö„ÄÇ", "error");
             });
             
             // üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager Ë®ªÂÜäÁõ£ËÅΩÂô®
             ListenerManager.register('studentResponses', unsubscribe);
             studentResponsesUnsubscribe = unsubscribe; // ‰øùÊåÅÂÖºÂÆπÊÄß
        }
        
        /**
         * üöÄ NEW: (Student) Áç®Á´ãÁõ£ËÅΩÂô®Áî®ÊñºÂêåÊ≠•ÂúñË°®Êï∏Êìö
         * Â≠∏ÁîüÁ´ØÁõ£ËÅΩÊïôÂ∏´Á´ØÁöÑ„ÄåÈ°ØÁ§∫Áµ±Ë®à„ÄçÊ®ôË™åÂíåÂÖ∂‰ªñÂ≠∏ÁîüÁöÑÂõûÊáâÔºåÂç≥ÊôÇÊõ¥Êñ∞ÂúñË°®
         * @param {string} mode - 'true_false' Êàñ 'multiple_choice'
         */
        function setupStudentChartListener(mode) {
            console.log(`[üë®‚Äçüéì Student Chart] setupStudentChartListener START - mode: ${mode}, classroomCode: ${classroomCode}, baseAppId: ${baseAppId}`);
            
            if (!classroomCode) {
                console.warn('[üë®‚Äçüéì Student Chart] ‚ùå classroomCode not set, cannot setup chart listener');
                return;
            }
            
            // Ê∏ÖÈô§ËàäÁöÑÁõ£ËÅΩÂô®
            if (studentChartListenerUnsubscribe) {
                console.log('[üë®‚Äçüéì Student Chart] Clearing old listener');
                studentChartListenerUnsubscribe();
                studentChartListenerUnsubscribe = null;
            }
            
            const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            console.log('[üë®‚Äçüéì Student Chart] studentResponses collection path set');
            
            // üöÄ NEW: ÂêåÊôÇÁõ£ËÅΩ control Êñá‰ª∂‰æÜÊ™¢Êü•ÊïôÂ∏´Á´ØÁöÑ showStudentChart Ê®ôË™å
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            console.log('[üë®‚Äçüéì Student Chart] control doc path set');
            let shouldShowChart = false;
            let listenerActive = false;
            
            // Áõ£ËÅΩÊïôÂ∏´Á´ØÁöÑ„ÄåÈ°ØÁ§∫Áµ±Ë®à„ÄçÊ®ôË™å
            const controlUnsubscribe = onSnapshot(controlRef, (controlDoc) => {
                if (controlDoc.exists()) {
                    shouldShowChart = controlDoc.data().showStudentChart === true;
                    console.log('[üë®‚Äçüéì Student Chart] üîî Control doc updated - showStudentChart:', shouldShowChart, 'data:', controlDoc.data());
                    
                    // üöÄ CRITICAL FIX: Áï∂Ê®ôË™åÊõ¥Êñ∞ÊôÇÁ´ãÂç≥‰∏ªÂãïÊ™¢Êü•ÊòØÂê¶ÊáâË©≤È°ØÁ§∫ÂúñË°®
                    if (shouldShowChart && currentChartResponses.length > 0) {
                        console.log('[üë®‚Äçüéì Student Chart] üî• Proactive update triggered by flag change');
                        if (mode === 'true_false') {
                            const containerTf = document.getElementById('student-chart-container-tf');
                            if (containerTf && studentChartManager) {
                                studentChartManager.updateChart(currentChartResponses, 'true_false');
                                containerTf.classList.remove('hidden');
                                console.log('[üë®‚Äçüéì Student Chart] ‚úÖ Chart displayed proactively');
                            }
                        } else if (mode === 'multiple_choice') {
                            const containerMc = document.getElementById('student-chart-container-mc');
                            if (containerMc && studentChartManager) {
                                studentChartManager.updateChart(currentChartResponses, 'multiple_choice');
                                containerMc.classList.remove('hidden');
                                console.log('[üë®‚Äçüéì Student Chart] ‚úÖ Chart displayed proactively');
                            }
                        }
                    }
                } else {
                    console.log('[üë®‚Äçüéì Student Chart] ‚ÑπÔ∏è Control doc does not exist');
                }
            }, (error) => {
                console.warn('[üë®‚Äçüéì Student Chart] ‚ùå Error listening to control settings:', error);
            });
            
            // Áõ£ËÅΩÂ≠∏ÁîüÂõûÊáâ
            const unsubscribe = onSnapshot(studentsColRef, (querySnapshot) => {
                const responses = [];
                querySnapshot.forEach((doc) => {
                    const student = doc.data();
                    responses.push(student);
                });
                
                // üöÄ CRITICAL FIX: ‰øùÂ≠òÊúÄÊñ∞ÁöÑÂõûÊáâ‰ª•‰æøÂú®Ê®ôË™åÊõ¥Êñ∞ÊôÇ‰ΩøÁî®
                currentChartResponses = responses;
                
                console.log(`[üë®‚Äçüéì Student Chart] üîî Responses updated - count: ${responses.length}, shouldShowChart: ${shouldShowChart}, mode: ${mode}`);
                
                // üöÄ KEY: Âè™Âú®ÊïôÂ∏´Êåâ„ÄåÈ°ØÁ§∫Áµ±Ë®à„ÄçÊôÇÊõ¥Êñ∞ÂíåÈ°ØÁ§∫ÂúñË°®
                if (shouldShowChart && responses.length > 0) {
                    if (mode === 'true_false') {
                        const containerTf = document.getElementById('student-chart-container-tf');
                        if (containerTf) {
                            console.log('[üë®‚Äçüéì Student Chart] ‚úÖ Updating true_false chart with', responses.length, 'responses');
                            studentChartManager.updateChart(responses, 'true_false');
                            containerTf.classList.remove('hidden');
                            console.log('[üë®‚Äçüéì Student Chart] ‚úÖ true_false chart shown');
                        } else {
                            console.warn('[üë®‚Äçüéì Student Chart] ‚ùå container student-chart-container-tf not found');
                        }
                    } else if (mode === 'multiple_choice') {
                        const containerMc = document.getElementById('student-chart-container-mc');
                        if (containerMc) {
                            console.log('[üë®‚Äçüéì Student Chart] ‚úÖ Updating multiple_choice chart with', responses.length, 'responses');
                            studentChartManager.updateChart(responses, 'multiple_choice');
                            containerMc.classList.remove('hidden');
                            console.log('[üë®‚Äçüéì Student Chart] ‚úÖ multiple_choice chart shown');
                        } else {
                            console.warn('[üë®‚Äçüéì Student Chart] ‚ùå container student-chart-container-mc not found');
                        }
                    }
                } else if (!shouldShowChart) {
                    console.log('[üë®‚Äçüéì Student Chart] ‚ÑπÔ∏è Hiding charts - shouldShowChart is false');
                    // Èö±ËóèÂúñË°®Áï∂ÊïôÂ∏´ÈóúÈñâÁµ±Ë®à
                    if (mode === 'true_false') {
                        const containerTf = document.getElementById('student-chart-container-tf');
                        if (containerTf) containerTf.classList.add('hidden');
                    } else if (mode === 'multiple_choice') {
                        const containerMc = document.getElementById('student-chart-container-mc');
                        if (containerMc) containerMc.classList.add('hidden');
                    }
                } else {
                    console.log(`[üë®‚Äçüéì Student Chart] ‚ÑπÔ∏è Chart not shown - shouldShowChart: ${shouldShowChart}, responses.length: ${responses.length}`);
                }
            }, (error) => {
                console.error('[üë®‚Äçüéì Student Chart] ‚ùå Error listening to student responses:', error);
            });
            
            studentChartListenerUnsubscribe = () => {
                console.log('[üë®‚Äçüéì Student Chart] Unsubscribing from chart listeners');
                unsubscribe();
                controlUnsubscribe();
            };
            console.log(`[üë®‚Äçüéì Student Chart] ‚úÖ Chart listener setup complete for mode: ${mode}`);
        }

        /**
         * üöÄ NEW: (Teacher) Êõ¥Êñ∞Â≠∏ÁîüÂç°ÁâáÁöÑÂàÜÂøÉÁãÄÊÖãÈ°ØÁ§∫
         * Áï∂ presence Êï∏ÊìöÊõ¥Êñ∞ÊôÇÔºåÂêåÊ≠•Êõ¥Êñ∞‰∏ªË¶ñÂúñ‰∏≠Â∑≤Ê∏≤ÊüìÁöÑÂ≠∏ÁîüÂç°Áâá
         */
        function updateStudentCardsDistractionStatus() {
            const container = document.getElementById('student-responses-container');
            if (!container) {
                console.log('[Distraction] ‚ö†Ô∏è updateStudentCardsDistractionStatus: container not found');
                return;
            }
            
            // ÊâæÂà∞ÊâÄÊúâÂ≠∏ÁîüÂç°Áâá
            const studentCards = container.querySelectorAll('.student-response-item[data-student-name]');
            console.log(`[Distraction] üîç updateStudentCardsDistractionStatus: Found ${studentCards.length} student cards, activeStudentsPresenceMap size: ${activeStudentsPresenceMap.size}`);
            
            studentCards.forEach(card => {
                const studentName = card.getAttribute('data-student-name');
                if (!studentName) return;
                
                // Âæû Map ‰∏≠ËÆÄÂèñÂàÜÂøÉÁãÄÊÖã
                const presenceData = activeStudentsPresenceMap.get(studentName) || { isDistracted: false, distractionCount: 0 };
                const isDistracted = presenceData.isDistracted;
                const distractionCount = presenceData.distractionCount;
                console.log(`[Distraction] üìä Student: ${studentName}, isDistracted: ${isDistracted}, distractionCount: ${distractionCount}`);
                
                // Êõ¥Êñ∞Âç°ÁâáËÉåÊôØÊ®£Âºè
                if (isDistracted) {
                    card.classList.add('bg-red-50', 'border-2', 'border-red-400');
                } else {
                    card.classList.remove('bg-red-50', 'border-2', 'border-red-400');
                }
                
                // üöÄ FIX: Âè™Êõ¥Êñ∞ÂàÜÂøÉÊåáÁ§∫Âô®Ôºå‰∏çË¶ÜËìãÊï¥ÂÄã nameBoxÔºà‰øùÁïôË∏¢Âá∫ÊåâÈàïÔºâ
                const nameBox = card.querySelector('.name-box');
                if (nameBox) {
                    // ÊâæÂà∞ÊàñÂâµÂª∫ÂàÜÂøÉÊåáÁ§∫Âô®ÂÆπÂô®
                    let statusContainer = nameBox.querySelector('.distraction-status');
                    if (!statusContainer) {
                        // Â¶ÇÊûúÊ≤íÊúâÂàÜÂøÉÊåáÁ§∫Âô®ÂÆπÂô®ÔºåÊâæÂà∞ÊåâÈàïÂÆπÂô®‰∏¶Âú®ÊåâÈàïÂâçÊèíÂÖ•
                        const btnContainer = nameBox.querySelector('.flex.items-center.gap-1');
                        if (btnContainer) {
                            statusContainer = document.createElement('span');
                            statusContainer.className = 'distraction-status';
                            btnContainer.insertBefore(statusContainer, btnContainer.firstChild);
                        }
                    }
                    
                    // üöÄ PRIVACY FIX: Âè™Êõ¥Êñ∞ÂàÜÂøÉÊåáÁ§∫Âô®ÁöÑÂÖßÂÆπ
                    if (statusContainer) {
                        if (isDistracted) {
                            statusContainer.innerHTML = `<i class="fas fa-exclamation-triangle text-red-600 animate-pulse" title="Â≠∏ÁîüÂàÜÂøÉ‰∏≠"></i>`;
                        } else {
                            statusContainer.innerHTML = '';
                        }
                    }
                }
            });
        }

        /**
         * (Teacher) Listens for student online presence and updates the active student count list.
         * This listener should be persistent as long as the teacher is in the classroom.
         * üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager ÁÆ°ÁêÜÁõ£ËÅΩÂô®
         * @param {Function} onInitialSnapshotCallback - ÂèØÈÅ∏ÂõûË™øÂáΩÊï∏ÔºåÂú®È¶ñÊ¨°Âø´ÁÖßÂà∞ÈÅîÊôÇË™øÁî®
         * @returns {Promise<void>} - Âú®È¶ñÊ¨°Âø´ÁÖßÂÆåÊàêÊôÇ resolve ÁöÑ Promise
         */
        function listenToClassroomPresence(onInitialSnapshotCallback = null) {
            // Only set up the listener if it's not already active
            if (ListenerManager.has('classroomPresence')) {
                console.log("Presence listener already active. Skipping re-subscription.");
                // Â¶ÇÊûúÂ∑≤Á∂ìÊúâÁõ£ËÅΩÂô®ÔºåÁ´ãÂç≥Ë™øÁî®ÂõûË™øÔºàÊï∏ÊìöÂ∑≤Â∞±Á∑íÔºâ
                if (onInitialSnapshotCallback) {
                    onInitialSnapshotCallback();
                }
                return Promise.resolve();
            }

            if (!classroomCode) {
                console.warn("Classroom code not set, cannot listen to presence.");
                // üöÄ FIX: ËøîÂõûÂ∑≤ resolve ÁöÑ Promise ËÄå‰∏çÊòØ rejectedÔºåÈÅøÂÖçÊú™ËôïÁêÜÁöÑ rejection
                // Ë™øÁî®ËÄÖÂèØ‰ª•ÁπºÁ∫åÂü∑Ë°åÔºåÂè™ÊòØ‰∏çÊúÉÊúâ presence Êï∏Êìö
                if (onInitialSnapshotCallback) {
                    onInitialSnapshotCallback(); // Á´ãÂç≥Ë™øÁî®ÂõûË™ø
                }
                return Promise.resolve(); // ËøîÂõûÊàêÂäüÁöÑ Promise
            }

            // üöÄ NEW: ÂâµÂª∫ Promise ‰ª•ÊîØÊè¥Áï∞Ê≠•Á≠âÂæÖÈ¶ñÊ¨°Âø´ÁÖß
            let initialSnapshotResolve;
            const initialSnapshotPromise = new Promise(resolve => {
                initialSnapshotResolve = resolve;
            });
            let isFirstSnapshot = true; // ËøΩËπ§ÊòØÂê¶ÁÇ∫È¶ñÊ¨°Âø´ÁÖß

            const presenceColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
            const activeStudentCountSpan = document.getElementById('active-student-count');
            const modalStudentNamesDiv = document.getElementById('modal-student-names');
            const monitorContainer = document.getElementById('student-responses-container');

            const unsubscribe = onSnapshot(presenceColRef, (querySnapshot) => {
                console.log(`[Distraction] üîÑ Presence snapshot received: ${querySnapshot.size} students online (first: ${isFirstSnapshot})`);
                // üöÄ FIX: ÂÑ≤Â≠òÂÆåÊï¥ÁöÑÂ≠∏ÁîüÊï∏ÊìöÔºàÂåÖÂê´ÂàÜÂøÉÁãÄÊÖãÔºâÔºåËÄå‰∏çÂè™ÊòØÂßìÂêç
                const activeStudentsData = []; // Êñ∞Â¢ûÔºöÂÑ≤Â≠òÂÆåÊï¥Â≠∏ÁîüË≥áÊñô
                activeStudentNames = []; // ‰øùÊåÅÂêëÂæåÂÖºÂÆπ
                activeStudentsPresenceMap.clear(); // üöÄ NEW: Ê∏ÖÁ©∫ËàäÊï∏Êìö
                
                querySnapshot.forEach(doc => {
                    const studentData = doc.data();
                    
                    // üöÄ CRITICAL FIX: Ë∑≥ÈÅéÊ≠£Âú®Ë¢´Ë∏¢Âá∫ÁöÑÂ≠∏ÁîüÔºåÈò≤Ê≠¢Á´∂Áà≠Ê¢ù‰ª∂Â∞éËá¥Âç°ÁâáÈáçÊñ∞Âá∫Áèæ
                    if (pendingKickStudents.has(studentData.name)) {
                        console.log(`[Distraction] üö´ Ë∑≥ÈÅéÊ≠£Âú®Ë¢´Ë∏¢Âá∫ÁöÑÂ≠∏Áîü: ${studentData.name}`);
                        return; // Ë∑≥ÈÅéÈÄôÂÄãÂ≠∏Áîü
                    }
                    
                    activeStudentNames.push(studentData.name);
                    activeStudentsData.push(studentData); // ÂÑ≤Â≠òÂÆåÊï¥Êï∏Êìö
                    // üöÄ NEW: Â∞áÂÆåÊï¥ÁöÑ presence Êï∏ÊìöÂ≠òÂÖ• MapÔºàkey: Â≠∏ÁîüÂêçÂ≠ó, value: presence Êï∏ÊìöÔºâ
                    activeStudentsPresenceMap.set(studentData.name, {
                        isDistracted: studentData.isDistracted === true,
                        distractionCount: studentData.distractionCount || 0
                    });
                    console.log(`[Distraction] ‚úì Loaded presence for ${studentData.name}: isDistracted=${studentData.isDistracted}, distractionCount=${studentData.distractionCount || 0}`);
                });
                
                activeStudentCountSpan.textContent = activeStudentNames.length;

                // Update the student list modal with distraction status.
                modalStudentNamesDiv.innerHTML = ''; 
                if (lastSelectedModalStudent) { // Clear highlight in modal when list rebuilds
                    lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                    lastSelectedModalStudent = null;
                }

                if (activeStudentsData.length === 0) {
                    modalStudentNamesDiv.innerHTML = `
                        <div class="empty-state-container w-full h-full min-h-[120px] flex flex-col items-center justify-center text-center py-8 sm:py-10">
                            <div class="w-14 h-14 sm:w-16 sm:h-16 mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                                <i class="fas fa-users text-gray-300 text-2xl sm:text-3xl"></i>
                            </div>
                            <span class="block text-gray-400 text-base sm:text-lg font-medium">Ê≤íÊúâÂ≠∏ÁîüÂú®Á∑ö</span>
                            <span class="block text-gray-300 text-sm sm:text-base mt-2">Á≠âÂæÖÂ≠∏ÁîüÂä†ÂÖ•Ë™≤Â†Ç...</span>
                        </div>
                    `;
                } else {
                    // üöÄ FIX: ÊåâÁÖßÂßìÂêçÊéíÂ∫è‰∏¶È°ØÁ§∫Â≠∏ÁîüÂèäÂÖ∂ÂàÜÂøÉÁãÄÊÖã
                    activeStudentsData.sort((a, b) => a.name.localeCompare(b.name)).forEach((student, index) => {
                        const p = document.createElement('div');
                        // üöÄ UIÂÑ™Âåñ: Êõ¥Ê∏ÖÊô∞ÁöÑÂàóË°®Ê®£ÂºèÔºåÈÅ©ÂêàÊâãÊ©üËß∏ÊéßÊìç‰Ωú
                        p.className = 'flex items-center justify-between py-2.5 sm:py-2 px-3 sm:px-4 rounded-lg bg-white hover:bg-blue-50 transition-colors border border-gray-100 shadow-sm mb-2 last:mb-0';
                        p.setAttribute('data-student-name', student.name);
                        
                        // Â∫èËôü + Â≠∏ÁîüÂßìÂêçÂÆπÂô®
                        const nameContainer = document.createElement('div');
                        nameContainer.className = 'flex items-center gap-2 sm:gap-3 min-w-0 flex-1';
                        
                        // Â∫èËôüÂæΩÁ´†
                        const indexBadge = document.createElement('span');
                        indexBadge.className = 'flex-shrink-0 w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center bg-blue-100 text-blue-700 text-xs sm:text-sm font-medium rounded-full';
                        indexBadge.textContent = index + 1;
                        
                        // Â≠∏ÁîüÂßìÂêç
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'truncate text-sm sm:text-base text-gray-700 font-normal';
                        nameSpan.textContent = student.name;
                        nameSpan.title = student.name;
                        
                        nameContainer.appendChild(indexBadge);
                        nameContainer.appendChild(nameSpan);
                        
                        // ÁãÄÊÖãÂíåÊìç‰ΩúÂÆπÂô®
                        const statusContainer = document.createElement('div');
                        statusContainer.className = 'flex items-center gap-2 sm:gap-3 flex-shrink-0 ml-2';
                        
                        // Ê™¢Êü•ÂàÜÂøÉÁãÄÊÖã
                        const isDistracted = student.isDistracted === true;
                        
                        // Ê∑ªÂä†Áï∂ÂâçÂàÜÂøÉË≠¶ÂëäÂúñÊ®ô
                        if (isDistracted) {
                            const warning = document.createElement('i');
                            warning.className = 'fas fa-exclamation-triangle text-red-500 text-sm sm:text-base animate-pulse';
                            warning.title = 'Â≠∏ÁîüÂàÜÂøÉ‰∏≠';
                            statusContainer.appendChild(warning);
                        }
                        
                        // üöÄ NEW: Ê∑ªÂä†Ë∏¢Âá∫ÊåâÈàïÔºàÊïôÂ∏´Â∞àÁî®Ôºâ
                        if (currentRole === 'teacher') {
                            const kickBtn = document.createElement('button');
                            // üöÄ UIÂÑ™Âåñ: Êõ¥Â§ßÁöÑËß∏ÊéßÂçÄÂüüÔºåÈÅ©ÂêàÊâãÊ©üÊìç‰Ωú
                            kickBtn.className = 'modal-kick-btn w-8 h-8 sm:w-7 sm:h-7 flex items-center justify-center bg-red-50 hover:bg-red-100 active:bg-red-200 rounded-full transition-colors';
                            kickBtn.setAttribute('data-student-name', student.name);
                            kickBtn.title = 'Âº∑Âà∂ÁôªÂá∫Ê≠§Â≠∏Áîü';
                            kickBtn.innerHTML = '<i class="fas fa-times text-red-500 text-sm"></i>';
                            
                            // Á∂ÅÂÆöË∏¢Âá∫‰∫ã‰ª∂
                            kickBtn.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                const studentName = kickBtn.getAttribute('data-student-name');
                                console.log(`[Modal KickBtn] üîî Ë∏¢Âá∫ÊåâÈàïË¢´ÈªûÊìä: ${studentName}`);
                                
                                const confirmed = confirm(`Á¢∫ÂÆöË¶ÅÂ∞á„Äå${studentName}„ÄçÂº∑Âà∂ÁôªÂá∫ÂóéÔºü\n\nÂ≠∏ÁîüÂ∞áÈúÄË¶ÅÈáçÊñ∞Ëº∏ÂÖ•ÂßìÂêçÂä†ÂÖ•Ë™≤Â†Ç„ÄÇ`);
                                if (confirmed) {
                                    await performKickStudent(studentName);
                                }
                            });
                            
                            statusContainer.appendChild(kickBtn);
                        }
                        
                        p.appendChild(nameContainer);
                        p.appendChild(statusContainer);
                        modalStudentNamesDiv.appendChild(p);
                    });
                }

                // üöÄ FIX: ÂØ¶ÊôÇÊõ¥Êñ∞‰∏ªË¶ñÂúñ‰∏≠Â≠∏ÁîüÂç°ÁâáÁöÑÂàÜÂøÉÁãÄÊÖã
                
                // üöÄ NEW: Êõ¥Êñ∞ÊïôÂ∏´ÂÑÄË°®Êùø - Âú®Á∑öÂ≠∏ÁîüË®àÊï∏ÂíåÂàÜÂøÉÊèêÈÜíÂØ¶ÊôÇÊõ¥Êñ∞
                updateTeacherDashboard(currentInteractionMode);
                // Áï∂ presence Êõ¥Êñ∞ÊôÇÔºåÊâãÂãïÊõ¥Êñ∞Â∑≤Ê∏≤ÊüìÁöÑÂ≠∏ÁîüÂç°Áâá
                console.log('[Distraction] üéØ Calling updateStudentCardsDistractionStatus() from presence listener');
                updateStudentCardsDistractionStatus();
                
                // üöÄ NEW: Áï∂ÊúâÊñ∞Â≠∏ÁîüÂä†ÂÖ•ÊôÇÔºåÂç≥ÊôÇÂâµÂª∫Âç°ÁâáÔºàËß£Ê±∫ÈáçÊñ∞ÁôªÂÖ•ÂæåÂç°Áâá‰∏çÂá∫ÁèæÁöÑÂïèÈ°åÔºâ
                refreshStudentCardsFromPresence();
                
                // üöÄ NEW: È¶ñÊ¨°Âø´ÁÖßÂÆåÊàêÊôÇË™øÁî®ÂõûË™ø‰∏¶ resolve Promise
                if (isFirstSnapshot) {
                    isFirstSnapshot = false; // Ê®ôË®òÈ¶ñÊ¨°Âø´ÁÖßÂ∑≤ÂÆåÊàê
                    console.log('[Distraction] ‚úÖ Initial presence snapshot completed, triggering callback');
                    
                    // Ë™øÁî®ÂõûË™øÂáΩÊï∏ÔºàÂ¶ÇÊûúÊúâÊèê‰æõÔºâ
                    if (onInitialSnapshotCallback) {
                        onInitialSnapshotCallback();
                    }
                    
                    // Resolve PromiseÔºåËÆìÁ≠âÂæÖÁöÑ‰ª£Á¢ºÂèØ‰ª•ÁπºÁ∫åÂü∑Ë°å
                    if (initialSnapshotResolve) {
                        initialSnapshotResolve();
                    }
                }
            }, (error) => {
                console.error("[Teacher] Error listening to classroom presence:", error);
                // If there's an error, maybe the listener broke, so clear it.
                ListenerManager.unregister('classroomPresence');
                classroomPresenceUnsubscribe = null;
                showMessage("ÁÑ°Ê≥ïÁõ£ËÅΩÂ≠∏ÁîüÂú®Á∑öÁãÄÊÖãÔºåË´ãÊ™¢Êü•ÈÄ£Á∑ö„ÄÇ", "error");
            });
            
            // üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager Ë®ªÂÜäÁõ£ËÅΩÂô®
            ListenerManager.register('classroomPresence', unsubscribe);
            classroomPresenceUnsubscribe = unsubscribe; // ‰øùÊåÅÂÖºÂÆπÊÄß
            
            // üöÄ NEW: ËøîÂõû PromiseÔºåËÆìË™øÁî®ËÄÖÂèØ‰ª•Á≠âÂæÖÈ¶ñÊ¨°Âø´ÁÖßÂÆåÊàê
            return initialSnapshotPromise;
        }

        /**
         * (Teacher) Manually refreshes the online student count and responded student count.
         */
        async function manualRefreshCounts() {
            if (!classroomCode) {
                console.warn("Classroom code not set, cannot manually refresh counts.");
                return;
            }
            // Use classroomCode in the Firestore path
            const presenceColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
            try {
                const presenceSnapshot = await getDocs(presenceColRef);
                activeStudentNames = []; // Clear and re-populate
                presenceSnapshot.forEach(doc => activeStudentNames.push(doc.data().name));
                document.getElementById('active-student-count').textContent = activeStudentNames.length;
            } catch (error) {
                console.error("Manual refresh: Failed to get online student count:", error);
            }

            // Use classroomCode in the Firestore path
            const responsesColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            try {
                const responsesSnapshot = await getDocs(responsesColRef);
                // REMOVED: document.getElementById('responded-student-count').textContent = responsesSnapshot.size;
                
                const responsesData = [];
                responsesSnapshot.forEach(doc => responsesData.push(doc.data()));
                allStudentResponses = responsesData; 

                if (!statisticsModal.classList.contains('hidden')) {
                    drawChart(allStudentResponses, currentInteractionMode);
                }
                showMessage('Áµ±Ë®àÊï∏ÊìöÂ∑≤Êõ¥Êñ∞ÔºÅ', 'info');
            } catch (error) {
                console.error("Manual refresh: Failed to get responded student count:", error);
            }
        }


        // --- Magnified Drawing Modal Functions ---
        const magnifiedImageModal = document.getElementById('magnified-image-modal');
        const magnifiedImage = document.getElementById('magnified-image');
        const magnifiedImageModalCloseBtn = document.getElementById('magnified-image-modal-close-btn');

        function showMagnifiedDrawing(imageUrl) {
            magnifiedImage.src = imageUrl;
            magnifiedImageModal.classList.remove('hidden');
        }

        function hideMagnifiedDrawing() {
            magnifiedImageModal.classList.add('hidden');
            magnifiedImage.src = ''; 
        }

        // --- Student List Modal (Teacher Side) ---
        const studentListModal = document.getElementById('student-list-modal');
        const studentListModalCloseBtn = document.getElementById('student-list-modal-close-btn');

        function showStudentListModal() {
            studentListModal.classList.remove('hidden');
        }

        function hideStudentListModal() {
            studentListModal.classList.add('hidden');
            if (lastSelectedModalStudent) { // Clear highlight in modal when closing
                lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                lastSelectedModalStudent = null;
            }
        }

        // --- NEW: Unsubmitted Students Modal Functions ---
        const unsubmittedStudentsModal = document.getElementById('unsubmitted-students-modal');
        const unsubmittedStudentsModalCloseBtn = document.getElementById('unsubmitted-students-modal-close-btn');
        const modalUnsubmittedStudentNamesDiv = document.getElementById('modal-unsubmitted-student-names');

        /**
         * Calculates the list of students who are active but have not submitted an answer.
         * @param {string[]} activeStudents - Array of names of all active students.
         * @param {Object[]} respondedStudents - Array of response objects from students.
         * @returns {string[]} Sorted array of names of unsubmitted students.
         */
        function getUnsubmittedStudents(activeStudents, respondedStudents) {
            // Âè™Ë®àÁÆóÁúüÊ≠£ÊúâÊèê‰∫§Á≠îÊ°àÁöÑÂ≠∏ÁîüÔºàanswer Â≠óÊÆµ‰∏çÁÇ∫Á©∫Ôºâ
            const respondedNames = new Set(
                respondedStudents
                    .filter(s => s.answer !== undefined && s.answer !== null && s.answer !== '')
                    .map(s => s.name)
            );
            return activeStudents.filter(name => !respondedNames.has(name)).sort();
        }

        /**
         * Displays the modal with the list of unsubmitted students.
         */
        function showUnsubmittedStudentsModal() {
            const unsubmittedNames = getUnsubmittedStudents(activeStudentNames, allStudentResponses);
            modalUnsubmittedStudentNamesDiv.innerHTML = '';
            if (unsubmittedNames.length === 0) {
                modalUnsubmittedStudentNamesDiv.innerHTML = '<p class="text-gray-500 text-sm col-span-full">ÊâÄÊúâÂ≠∏ÁîüÁöÜÂ∑≤‰ΩúÁ≠îÊàñÁÑ°Â≠∏ÁîüÂú®Á∑ö</p>';
            } else {
                unsubmittedNames.forEach(name => {
                    const p = document.createElement('p');
                    p.textContent = name;
                    p.className = 'bg-red-100 p-2 rounded-md text-center text-red-700 font-medium overflow-hidden text-ellipsis whitespace-nowrap';
                    modalUnsubmittedStudentNamesDiv.appendChild(p);
                });
            }
            unsubmittedStudentsModal.classList.remove('hidden');
        }

        /**
         * Hides the unsubmitted students modal.
         */
        function hideUnsubmittedStudentsModal() {
            unsubmittedStudentsModal.classList.add('hidden');
        }


        // --- Statistics Chart Modal (Teacher Side) ---
        const statisticsModal = document.getElementById('statistics-modal');
        const chartModalCloseBtn = document.getElementById('chart-modal-close-btn');
        const chartSvg = d3.select("#chart-svg");
        const studentsByAnswerListContainer = document.getElementById('students-by-answer-list-container');
        const studentsByAnswerListTitle = document.getElementById('students-by-answer-list-title');
        const studentsByAnswerNamesParagraph = document.getElementById('students-by-answer-names');


        async function showStatisticsModal() {
            console.log(`[üë®‚Äçüè´ Teacher] showStatisticsModal called - role: ${currentRole}, classroomCode: ${classroomCode}, mode: ${currentInteractionMode}`);
            statisticsModal.classList.remove('hidden');
            drawChart(allStudentResponses, currentInteractionMode);
            
            // üöÄ NEW: Ë®≠ÁΩÆ Firestore Ê®ôË™åÔºåÈÄöÁü•Â≠∏ÁîüÁ´ØÈ°ØÁ§∫ÂúñË°®
            if (currentRole === 'teacher' && classroomCode && (currentInteractionMode === 'true_false' || currentInteractionMode === 'multiple_choice')) {
                try {
                    const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                    console.log(`[üë®‚Äçüè´ Teacher] Writing to Firestore - path: classrooms/${classroomCode}/settings/control`);
                    await setDoc(controlRef, {
                        showStudentChart: true,
                        chartMode: currentInteractionMode,
                        chartShownAt: new Date()
                    }, { merge: true });
                    console.log('[üë®‚Äçüè´ Teacher] ‚úì Set showStudentChart flag to true in Firestore');
                } catch (error) {
                    console.error('[üë®‚Äçüè´ Teacher] Error setting showStudentChart flag:', error);
                }
            } else {
                console.warn(`[üë®‚Äçüè´ Teacher] showStatisticsModal skipped - role check: ${currentRole === 'teacher'}, classroomCode: ${!!classroomCode}, mode check: ${(currentInteractionMode === 'true_false' || currentInteractionMode === 'multiple_choice')}`);
            }
        }

        async function hideStatisticsModal() {
            statisticsModal.classList.add('hidden');
            chartSvg.selectAll("*").remove();
            clearStudentsByAnswerList();
            
            // üöÄ NEW: Ê∏ÖÈô§ Firestore Ê®ôË™åÔºåÈÄöÁü•Â≠∏ÁîüÁ´ØÈö±ËóèÂúñË°®
            if (currentRole === 'teacher' && classroomCode) {
                try {
                    const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                    await setDoc(controlRef, {
                        showStudentChart: false
                    }, { merge: true });
                    console.log('[Teacher] ‚úì Set showStudentChart flag to false');
                } catch (error) {
                    console.error('[Teacher] Error clearing showStudentChart flag:', error);
                }
            }
        }

        function downloadStudentResponses() {
            if (!allStudentResponses || allStudentResponses.length === 0) {
                showMessage('ÁõÆÂâçÊ≤íÊúâÂ≠∏ÁîüÂõûÊáâÂèØ‰ª•‰∏ãËºâ„ÄÇ', 'warning');
                return;
            }

            let csvData = [];
            let filename = '';
            
            if (currentInteractionMode === 'text_input') {
                // ÊñáÂ≠óÈ°åÊ®°Âºè
                csvData.push('Â≠∏ÁîüÂßìÂêç,Â≠∏ÁîüÂõûÊáâ');
                
                allStudentResponses.forEach(student => {
                    const studentName = student.name || 'Êú™Áü•Â≠∏Áîü';
                    let responseText = student.answer || '';
                    
                    // Ê∏ÖÁêÜÂõûÊáâÊñáÂ≠ó‰∏≠ÁöÑÊèõË°åÁ¨¶ËôüÂíåÈõôÂºïËôüÔºåÈÅøÂÖçÂΩ±ÈüøCSVÊ†ºÂºè
                    responseText = responseText.replace(/[\r\n]/g, ' ').replace(/"/g, '""');
                    
                    // Â¶ÇÊûúÂÖßÂÆπÂåÖÂê´ÈÄóËôüÊàñÈõôÂºïËôüÔºåÈúÄË¶ÅÁî®ÈõôÂºïËôüÂåÖÂúç
                    if (responseText.includes(',') || responseText.includes('"') || responseText.includes('\n')) {
                        responseText = `"${responseText}"`;
                    }
                    
                    csvData.push(`${studentName},${responseText}`);
                });
                
                filename = generateFilename('Â≠∏ÁîüÂõûÊáâ', 'csv');
                
            } else if (currentInteractionMode === 'multiple_choice' && currentMultipleChoiceQuestions) {
                // Ëá™Ë®ÇÈÅ∏ÊìáÈ°åÊ®°Âºè
                
                // Á¨¨‰∏ÄÈÉ®ÂàÜÔºöÈ°åÁõÆË≥áË®ä
                csvData.push('=== È°åÁõÆË≥áË®ä ===');
                csvData.push('È°åËôü,È°åÁõÆÂÖßÂÆπ,ÈÅ∏È†ÖA,ÈÅ∏È†ÖB,ÈÅ∏È†ÖC,ÈÅ∏È†ÖD,Ê≠£Á¢∫Á≠îÊ°à');
                
                currentMultipleChoiceQuestions.forEach((question, index) => {
                    const questionText = `"${question.questionText.replace(/"/g, '""')}"`;
                    const optionA = `"${question.options[0].replace(/"/g, '""')}"`;
                    const optionB = `"${question.options[1].replace(/"/g, '""')}"`;
                    const optionC = `"${question.options[2].replace(/"/g, '""')}"`;
                    const optionD = `"${question.options[3].replace(/"/g, '""')}"`;
                    const correctAnswer = `ÈÅ∏È†Ö${['A', 'B', 'C', 'D'][parseInt(question.correctAnswer) - 1]}`;
                    
                    csvData.push(`Á¨¨${index + 1}È°å,${questionText},${optionA},${optionB},${optionC},${optionD},${correctAnswer}`);
                });
                
                // Á©∫Ë°åÂàÜÈöî
                csvData.push('');
                
                // Á¨¨‰∫åÈÉ®ÂàÜÔºöÂ≠∏ÁîüÁ≠îÈ°åÁµêÊûú
                csvData.push('=== Â≠∏ÁîüÁ≠îÈ°åÁµêÊûú ===');
                
                // Âª∫Á´ãË°®È†≠
                let header = 'Â≠∏ÁîüÂßìÂêç';
                currentMultipleChoiceQuestions.forEach((_, index) => {
                    header += `,Á¨¨${index + 1}È°åÁ≠îÊ°à,Á¨¨${index + 1}È°åÁµêÊûú`;
                });
                header += ',Á∏ΩÂàÜ,Á∏ΩÈ°åÊï∏,Ê≠£Á¢∫Áéá';
                csvData.push(header);
                
                // Âª∫Á´ãÊØèÂÄãÂ≠∏ÁîüÁöÑÁ≠îÈ°åÁµêÊûú
                allStudentResponses.forEach(student => {
                    const studentName = student.name || 'Êú™Áü•Â≠∏Áîü';
                    let row = studentName;
                    let correctCount = 0;
                    let totalQuestions = currentMultipleChoiceQuestions.length;
                    
                    if (Array.isArray(student.answer)) {
                        // ÁÇ∫ÊØèÈ°åÂä†ÂÖ•Á≠îÊ°àÂíåÁµêÊûú
                        currentMultipleChoiceQuestions.forEach((question, questionIndex) => {
                            const studentAnswer = student.answer.find(ans => ans.qIndex === questionIndex);
                            if (studentAnswer) {
                                const answerText = `ÈÅ∏È†Ö${['A', 'B', 'C', 'D'][parseInt(studentAnswer.ans) - 1]}`;
                                const isCorrect = String(studentAnswer.ans) === String(question.correctAnswer);
                                const result = isCorrect ? 'Ê≠£Á¢∫' : 'ÈåØË™§';
                                if (isCorrect) correctCount++;
                                row += `,${answerText},${result}`;
                            } else {
                                row += ',Êú™‰ΩúÁ≠î,ÈåØË™§';
                            }
                        });
                    } else {
                        // Â¶ÇÊûúÂ≠∏ÁîüÊ≤íÊúâÂõûÁ≠îÊàñÊ†ºÂºè‰∏çÊ≠£Á¢∫
                        currentMultipleChoiceQuestions.forEach(() => {
                            row += ',Êú™‰ΩúÁ≠î,ÈåØË™§';
                        });
                    }
                    
                    // Âä†ÂÖ•Áµ±Ë®àË≥áË®ä
                    const accuracy = totalQuestions > 0 ? ((correctCount / totalQuestions) * 100).toFixed(1) : '0.0';
                    row += `,${correctCount},${totalQuestions},${accuracy}%`;
                    
                    csvData.push(row);
                });
                
                filename = generateFilename('ÈÅ∏ÊìáÈ°åÁµêÊûú', 'csv');

            } else if (currentInteractionMode === 'reading_comprehension' && readingComprehensionData.questions) {
                // Èñ±ËÆÄÊ∏¨È©óÊ®°Âºè

                // Á¨¨‰∏ÄÈÉ®ÂàÜÔºöÊñáÊú¨ÂÖßÂÆπ
                csvData.push('=== Èñ±ËÆÄÊñáÊú¨ ===');
                const readingText = `"${readingComprehensionData.text.replace(/"/g, '""')}"`;
                csvData.push(`ÊñáÊú¨ÂÖßÂÆπ,${readingText}`);
                csvData.push('');

                // Á¨¨‰∫åÈÉ®ÂàÜÔºöÈ°åÁõÆË≥áË®ä
                csvData.push('=== È°åÁõÆË≥áË®ä ===');
                csvData.push('È°åËôü,PIRLSÂ±§Ê¨°,È°åÁõÆÂÖßÂÆπ,ÈÅ∏È†Ö1,ÈÅ∏È†Ö2,ÈÅ∏È†Ö3,ÈÅ∏È†Ö4,Ê≠£Á¢∫Á≠îÊ°à');

                readingComprehensionData.questions.forEach((question, index) => {
                    const levelNames = ['Áõ¥Êé•ÊèêÂèñ', 'Áõ¥Êé•Êé®Ë´ñ', 'Ë©ÆÈáãÊï¥Âêà', 'ÊØîËºÉË©ï‰º∞'];
                    const levelName = levelNames[question.level - 1] || 'Êú™ÂàÜÈ°û';
                    const questionText = `"${question.question.replace(/"/g, '""')}"`;
                    const option1 = `"${question.options[0].replace(/"/g, '""')}"`;
                    const option2 = `"${question.options[1].replace(/"/g, '""')}"`;
                    const option3 = `"${question.options[2].replace(/"/g, '""')}"`;
                    const option4 = `"${question.options[3].replace(/"/g, '""')}"`;
                    const correctAnswer = `ÈÅ∏È†Ö${question.correctAnswer}`;

                    csvData.push(`Á¨¨${index + 1}È°å,${levelName},${questionText},${option1},${option2},${option3},${option4},${correctAnswer}`);
                });

                // Á©∫Ë°åÂàÜÈöî
                csvData.push('');

                // Á¨¨‰∏âÈÉ®ÂàÜÔºöÂ≠∏ÁîüÁ≠îÈ°åÁµêÊûúÔºàÂê´ÊéíÂêçÂíå‰ΩúÁ≠îÊôÇÈï∑Ôºâ
                csvData.push('=== Â≠∏ÁîüÁ≠îÈ°åÁµêÊûú ===');

                // üöÄ NEW: Ë®àÁÆóÊéíÂêçÔºàËàá CSV Áµ±Ë®àÂåØÂá∫‰∏ÄËá¥Ôºâ
                const rankedStudents = [];
                allStudentResponses.forEach(student => {
                    try {
                        let studentAnswers = [];
                        if (typeof student.answer === 'string') {
                            studentAnswers = JSON.parse(student.answer);
                        } else if (Array.isArray(student.answer)) {
                            studentAnswers = student.answer;
                        }

                        let correctCount = 0;
                        studentAnswers.forEach((ans, index) => {
                            // üöÄ CRITICAL FIX: ÊîØÊè¥ÈÄÅÂàÜÈ°åÔºàcorrectAnswer === 0 ÊôÇÁÑ°Ê¢ù‰ª∂Ë®àÁÇ∫Ê≠£Á¢∫Ôºâ
                            if (readingComprehensionData.questions[index] && ((readingComprehensionData.questions[index].correctAnswer === 0) || (ans === readingComprehensionData.questions[index].correctAnswer))) {
                                correctCount++;
                            }
                        });

                        // üöÄ FIX: ÂÑ™ÂÖà‰ΩøÁî® Firestore ÂàÜÊï∏ÔºàÊïôÂ∏´‰øÆÊîπÁ≠îÊ°àÂæåÂ∑≤Êõ¥Êñ∞Ôºâ
                        const hasTeacherUpdatedScore = student.scoreUpdateToken && student.baseScore !== undefined;
                        let accuracy, baseScore, totalScore;
                        
                        if (hasTeacherUpdatedScore) {
                            // ‰ΩøÁî® Firestore ‰∏≠ÊïôÂ∏´Â∑≤Ë®àÁÆóÂ•ΩÁöÑÂàÜÊï∏ÔºàÂê´ÈÄÅÂàÜÈ°åÈÇèËºØÔºâ
                            baseScore = student.baseScore;
                            totalScore = student.totalScore || baseScore;
                            accuracy = baseScore; // baseScore Â∞±ÊòØÊ≠£Á¢∫ÁéáÁôæÂàÜÊØî
                            correctCount = Math.round((baseScore / 100) * readingComprehensionData.questions.length);
                            console.log(`[CSV Export] ‚úÖ Using Firestore scores for ${student.name}: baseScore=${baseScore}, totalScore=${totalScore}`);
                        } else {
                            // Êú¨Âú∞Ë®àÁÆóÔºàÂ≠∏ÁîüÂâõÊèê‰∫§ÊôÇÔºåFirestore Â∞öÊú™Ë¢´ÊïôÂ∏´Êõ¥Êñ∞Ôºâ
                            accuracy = Math.round((correctCount / readingComprehensionData.questions.length) * 100);
                            baseScore = accuracy;
                            const highlightBonus = (student.highlightAnalysis && student.highlightAnalysis.score) || 0;
                            totalScore = baseScore + highlightBonus;
                        }
                        
                        rankedStudents.push({
                            name: student.name,
                            correctCount: correctCount,
                            totalQuestions: readingComprehensionData.questions.length,
                            accuracy: accuracy,
                            baseScore: baseScore,
                            totalScore: totalScore,
                            timestamp: student.timestamp,
                            durationMs: student.durationMs || null,
                            answers: studentAnswers,
                            // üöÄ NEW: ÂåÖÂê´Á≠ÜË®òË©ïÂàÜÊï∏Êìö
                            highlightAnalysis: student.highlightAnalysis || null
                        });
                    } catch (e) {
                        console.warn('[CSV Export] Invalid answer format for student:', student.name);
                    }
                });

                // ÊéíÂ∫èÔºàËàá CSV Áµ±Ë®àÂåØÂá∫‰∏ÄËá¥Ôºâ
                rankedStudents.sort((a, b) => {
                    if (b.correctCount !== a.correctCount) return b.correctCount - a.correctCount;
                    if (a.durationMs && b.durationMs) return a.durationMs - b.durationMs;
                    if (a.durationMs && !b.durationMs) return -1;
                    if (!a.durationMs && b.durationMs) return 1;
                    const aTime = a.timestamp?.toMillis ? a.timestamp.toMillis() : (a.timestamp?.getTime ? a.timestamp.getTime() : 0);
                    const bTime = b.timestamp?.toMillis ? b.timestamp.toMillis() : (b.timestamp?.getTime ? b.timestamp.getTime() : 0);
                    return aTime - bTime;
                });

                // üöÄ OPTIMIZED: Ë®àÁÆóÊéíÂêç - ÊØèÂÄãÂ≠∏ÁîüÈÉΩÊúâÂîØ‰∏ÄÊéíÂêçÔºàÂü∫ÊñºÂÆåÊï¥ÊéíÂ∫èÔºåÂåÖÊã¨‰ΩúÁ≠îÊôÇÈï∑Ôºâ
                // ‰∏çÂÜçÂè™ÊØîËºÉÊ≠£Á¢∫È°åÊï∏ÔºåËÄåÊòØÁÇ∫ÊéíÂ∫èÂàóË°®‰∏≠ÁöÑÊØèÂÄã‰ΩçÁΩÆÊåáÊ¥æÂîØ‰∏ÄÊéíÂêç
                rankedStudents.forEach((student, index) => {
                    student.rank = index + 1;
                });

                // Âª∫Á´ãË°®È†≠ÔºàÂåÖÂê´ÊéíÂêçÂíå‰ΩúÁ≠îÊôÇÈï∑Ôºâ
                let header = 'ÊéíÂêç,Â≠∏ÁîüÂßìÂêç,‰ΩúÁ≠îÊôÇÈï∑,Êèê‰∫§ÊôÇÈñì';
                readingComprehensionData.questions.forEach((_, index) => {
                    header += `,Á¨¨${index + 1}È°åÁ≠îÊ°à,Á¨¨${index + 1}È°åÁµêÊûú`;
                });
                header += ',Á∏ΩÂàÜ,Á∏ΩÈ°åÊï∏,Ê≠£Á¢∫Áéá,Á≠ÜË®òÁ∏ΩÂä†ÂàÜ,È°èËâ≤Â§öÊ®£ÊÄßÂàÜÊï∏,Á≤æÁ¢∫Â∫¶ÂàÜÊï∏,ÂàÜÊÆµÂêàÁêÜÊÄßÂàÜÊï∏,Á≠îÊ°àÈóúËÅØÂ∫¶ÂàÜÊï∏,ÊôÇÈñìÂàÜÈÖçÂàÜÊï∏,Á≠ÜË®òÈ°èËâ≤Êï∏,Á≠ÜË®òË¶ÜËìãÁéá,Á≠ÜË®òÊÆµËêΩÊï∏,Ê®ôË®ªÊôÇÈñìË∑®Â∫¶';
                csvData.push(header);

                // Âª∫Á´ãÊØèÂÄãÂ≠∏ÁîüÁöÑÁ≠îÈ°åÁµêÊûúÔºàÊåâÊéíÂêçÊéíÂ∫èÔºâ
                rankedStudents.forEach(student => {
                    const studentName = student.name || 'Êú™Áü•Â≠∏Áîü';
                    
                    // üöÄ NEW: Ê†ºÂºèÂåñ‰ΩúÁ≠îÊôÇÈï∑
                    let durationText = 'Êú™Ë®òÈåÑ';
                    if (student.durationMs) {
                        const duration = formatDuration(student.durationMs);
                        durationText = duration.longLabel.replace('‰ΩúÁ≠î ', '');
                    }

                    // üöÄ NEW: Ê†ºÂºèÂåñÊèê‰∫§ÊôÇÈñì
                    let submissionTime = 'Êú™Áü•';
                    if (student.timestamp) {
                        submissionTime = student.timestamp.toDate 
                            ? student.timestamp.toDate().toLocaleString('zh-TW') 
                            : new Date(student.timestamp).toLocaleString('zh-TW');
                    }

                    // ÈñãÂßãÂª∫Á´ãË°åË≥áÊñôÔºöÊéíÂêç„ÄÅÂßìÂêç„ÄÅ‰ΩúÁ≠îÊôÇÈï∑„ÄÅÊèê‰∫§ÊôÇÈñì
                    let row = `${student.rank},${studentName},${durationText},${submissionTime}`;

                    // ÁÇ∫ÊØèÈ°åÂä†ÂÖ•Á≠îÊ°àÂíåÁµêÊûú
                    readingComprehensionData.questions.forEach((question, questionIndex) => {
                        const studentAnswer = student.answers[questionIndex];
                        if (studentAnswer && studentAnswer > 0) {
                            const answerText = `ÈÅ∏È†Ö${studentAnswer}`;
                            // üöÄ FIX: ÊîØÊè¥ÈÄÅÂàÜÈ°åÔºàcorrectAnswer === 0 ÊôÇÁÑ°Ê¢ù‰ª∂Ë®àÁÇ∫Ê≠£Á¢∫Ôºâ
                            const isCorrect = (question.correctAnswer === 0) || (studentAnswer === question.correctAnswer);
                            const result = isCorrect ? 'Ê≠£Á¢∫' : 'ÈåØË™§';
                            row += `,${answerText},${result}`;
                        } else {
                            // üöÄ FIX: ÈÄÅÂàÜÈ°åÊú™‰ΩúÁ≠î‰πüÁÆóÊ≠£Á¢∫
                            const result = (question.correctAnswer === 0) ? 'Ê≠£Á¢∫' : 'ÈåØË™§';
                            row += `,Êú™‰ΩúÁ≠î,${result}`;
                        }
                    });

                    // Âä†ÂÖ•Áµ±Ë®àË≥áË®ä
                    const accuracy = student.totalQuestions > 0 ? ((student.correctCount / student.totalQuestions) * 100).toFixed(1) : '0.0';
                    row += `,${student.correctCount},${student.totalQuestions},${accuracy}%`;
                    
                    // üöÄ NEW: Âä†ÂÖ•Á≠ÜË®òË©ïÂàÜÊï∏ÊìöÔºàÂÆåÊï¥5È†ÖÊåáÊ®ôÁ¥∞ÂàÜ + ÊôÇÈñìÁµ±Ë®àÔºâ
                    if (student.highlightAnalysis && student.highlightAnalysis.score > 0) {
                        const analysis = student.highlightAnalysis;
                        const breakdown = analysis.breakdown;
                        const timeSpan = analysis.stats.timeSpanSeconds || 0;
                        row += `,+${analysis.score}ÂàÜ,${breakdown.colorDiversity}ÂàÜ,${breakdown.precision}ÂàÜ,${breakdown.segmentation}ÂàÜ,${breakdown.relevance}ÂàÜ,${breakdown.timeDistribution}ÂàÜ,${analysis.stats.colorCount}Á®Æ,${analysis.stats.coverageRate}%,${analysis.stats.segmentCount}ÊÆµ,${timeSpan}Áßí`;
                    } else {
                        row += ',0ÂàÜ,0ÂàÜ,0ÂàÜ,0ÂàÜ,0ÂàÜ,0ÂàÜ,0Á®Æ,0%,0ÊÆµ,0Áßí';
                    }

                    csvData.push(row);
                });

                filename = generateFilename('Èñ±ËÆÄÊ∏¨È©óÁµêÊûú', 'csv');

            } else {
                showMessage('ÁõÆÂâçÊ®°Âºè‰∏çÊîØÊè¥‰∏ãËºâÂäüËÉΩ„ÄÇ', 'warning');
                return;
            }

            // Âª∫Á´ãCSVÂÖßÂÆπ
            const csvContent = csvData.join('\n');

            // Âª∫Á´ã‰∏ãËºâÈÄ£ÁµêÔºåÂä†‰∏äBOMÁ¢∫‰øùÊ≠£Á¢∫È°ØÁ§∫‰∏≠Êñá
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage(`Â∑≤‰∏ãËºâÂ≠∏ÁîüÂõûÊáâÊ™îÊ°à: ${filename}`, 'success');
        }

        // NEW: View Questions Modal Functions
        function showViewQuestionsModal() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                showMessage('ÁõÆÂâçÊ≤íÊúâËá™Ë®ÇÈ°åÁõÆÂèØ‰ª•Êü•Áúã„ÄÇ', 'info');
                return;
            }
            
            const modal = document.getElementById('view-questions-modal');
            const container = document.getElementById('questions-display-container');
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            container.innerHTML = '';
            
            // ÁîüÊàêÈ°åÁõÆÈ°ØÁ§∫HTML
            currentMultipleChoiceQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-50 p-4 rounded-lg border';
                questionDiv.innerHTML = `
                    <h5 class="font-bold text-lg mb-3">Á¨¨ ${index + 1} È°å</h5>
                    <p class="text-gray-800 mb-4">${question.questionText}</p>
                    <div class="space-y-2">
                        <p class="font-medium text-gray-700">ÈÅ∏È†ÖÔºö</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${question.options.map((option, optIndex) => 
                                `<div class="p-2 bg-white rounded border text-sm">
                                    ${String.fromCharCode(65 + optIndex)}. ${option}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê≠£Á¢∫Á≠îÊ°àÔºö</label>
                        <select class="correct-answer-select w-full p-2 border rounded" data-question-index="${index}">
                            ${question.options.map((option, optIndex) => {
                                const optionValue = String.fromCharCode(65 + optIndex);
                                const isSelected = question.correctAnswer === optionValue || question.correctAnswer === (optIndex + 1).toString();
                                return `<option value="${optionValue}" ${isSelected ? 'selected' : ''}>${optionValue}. ${option}</option>`;
                            }).join('')}
                        </select>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
            
            modal.classList.remove('hidden');
        }

        function hideViewQuestionsModal() {
            document.getElementById('view-questions-modal').classList.add('hidden');
        }

        async function saveCorrectAnswers() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                showMessage('Ê≤íÊúâÈ°åÁõÆÂèØ‰ª•ÂÑ≤Â≠ò„ÄÇ', 'error');
                return;
            }
            
            try {
                // Êõ¥Êñ∞currentMultipleChoiceQuestions‰∏≠ÁöÑÊ≠£Á¢∫Á≠îÊ°à
                const selects = document.querySelectorAll('.correct-answer-select');
                selects.forEach(select => {
                    const questionIndex = parseInt(select.getAttribute('data-question-index'));
                    let newCorrectAnswer = select.value;
                    
                    // NEW: Â∞áÂ≠óÊØçÊ†ºÂºèËΩâÊèõÁÇ∫Êï∏Â≠óÊ†ºÂºè‰ª•‰øùÊåÅ‰∏ÄËá¥ÊÄß
                    if (newCorrectAnswer === 'A') newCorrectAnswer = '1';
                    else if (newCorrectAnswer === 'B') newCorrectAnswer = '2';
                    else if (newCorrectAnswer === 'C') newCorrectAnswer = '3';
                    else if (newCorrectAnswer === 'D') newCorrectAnswer = '4';
                    
                    if (currentMultipleChoiceQuestions[questionIndex]) {
                        currentMultipleChoiceQuestions[questionIndex].correctAnswer = newCorrectAnswer;
                    }
                });
                
                // Êõ¥Êñ∞Firestore‰∏≠ÁöÑÈ°åÁõÆË≥áÊñô
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                await updateDoc(controlRef, {
                    multiple_choice_questions: currentMultipleChoiceQuestions
                });
                
                // NEW: Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊôÇÈñìÁ¢∫‰øùFirestoreÊõ¥Êñ∞ÂÆåÊàêÔºåÁÑ∂ÂæåËß∏ÁôºÈáçÊñ∞ÊâπÊîπ
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // NEW: Ëá™ÂãïÈáçÊñ∞ÊâπÊîπÊâÄÊúâÂ≠∏ÁîüÂ∑≤Êèê‰∫§ÁöÑÁ≠îÊ°à
                await regradeAllStudentAnswers();
                
                // NEW: Á¢∫‰øùÊïôÂ∏´Á´ØUI‰ΩøÁî®ÊúÄÊñ∞ÁöÑÊ≠£Á¢∫Á≠îÊ°àÈÄ≤Ë°åÊ∏≤Êüì
                // Áî±ÊñºÈáçÊñ∞ÊâπÊîπÊúÉËß∏ÁôºFirebaseÁõ£ËÅΩÂô®ÔºåUIÊúÉËá™ÂãïÈáçÊñ∞Ê∏≤Êüì
                
                showMessage('Ê≠£Á¢∫Á≠îÊ°àÂ∑≤Êõ¥Êñ∞‰∏¶ÈáçÊñ∞ÊâπÊîπÊâÄÊúâ‰ΩúÁ≠îÔºÅ', 'success');
                hideViewQuestionsModal();
            } catch (error) {
                console.error('Êõ¥Êñ∞Ê≠£Á¢∫Á≠îÊ°àÂ§±Êïó:', error);
                showMessage('Êõ¥Êñ∞Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            }
        }

        // NEW: ÈáçÊñ∞ÊâπÊîπÊâÄÊúâÂ≠∏ÁîüÁ≠îÊ°àÁöÑÂáΩÊï∏
        async function regradeAllStudentAnswers() {
            if (!currentMultipleChoiceQuestions || currentMultipleChoiceQuestions.length === 0) {
                return;
            }

            try {
                const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                const querySnapshot = await getDocs(studentsColRef);
                
                const batch = writeBatch(db);
                let regradeCount = 0;

                querySnapshot.forEach((docSnapshot) => {
                    const studentData = docSnapshot.data();
                    
                    // Âè™ËôïÁêÜÈÅ∏ÊìáÈ°åÁöÑÁ≠îÊ°àÔºàArrayÊ†ºÂºèÔºâ
                    if (Array.isArray(studentData.answer)) {
                        // Êõ¥Êñ∞Â≠∏ÁîüÁ≠îÊ°àÊôÇÈñìÊà≥‰ª•Ëß∏ÁôºUIÈáçÊñ∞Ê∏≤ÊüìÔºàÁ≠îÊ°àÂÖßÂÆπ‰øùÊåÅ‰∏çËÆäÔºâ
                        const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', docSnapshot.id);
                        batch.update(studentRef, {
                            regraded: true,
                            regradeTimestamp: new Date(),
                            timestamp: new Date(), // Êõ¥Êñ∞ÊôÇÈñìÊà≥‰ª•Ëß∏ÁôºÁõ£ËÅΩÂô®ÈáçÊñ∞Ë©ïÂà§Á≠îÊ°à
                            forceUpdate: Math.random() // Ê∑ªÂä†Èö®Ê©üÊï∏Âº∑Âà∂Ëß∏ÁôºÁõ£ËÅΩÂô®
                        });
                        regradeCount++;
                    }
                });

                if (regradeCount > 0) {
                    await batch.commit();
                    console.log(`ÈáçÊñ∞ÊâπÊîπ‰∫Ü ${regradeCount} ‰ΩçÂ≠∏ÁîüÁöÑÁ≠îÊ°à`);
                }
            } catch (error) {
                console.error('ÈáçÊñ∞ÊâπÊîπÁ≠îÊ°àÂ§±Êïó:', error);
                throw error;
            }
        }

        function clearStudentsByAnswerList() {
            studentsByAnswerListContainer.classList.add('hidden');
            studentsByAnswerListTitle.textContent = '';
            studentsByAnswerNamesParagraph.textContent = ''; 
        }

        function displayStudentsForAnswer(answer, mode, questionIndex = null) {
            clearStudentsByAnswerList();
            studentsByAnswerListContainer.classList.remove('hidden');

            let filteredStudents;
            let titleText;

            if (mode === 'multiple_choice' && questionIndex !== null && currentMultipleChoiceQuestions) {
                // For custom multiple choice, filter by specific question and correctness
                const question = currentMultipleChoiceQuestions[questionIndex];
                if (!question) {
                    studentsByAnswerListTitle.textContent = `ÂïèÈ°å ${questionIndex + 1} ‰∏çÂ≠òÂú®„ÄÇ`;
                    studentsByAnswerNamesParagraph.textContent = '';
                    return;
                }
                
                // 'answer' here is 'correct' or 'incorrect'
                if (answer === 'correct') {
                    filteredStudents = allStudentResponses.filter(s => 
                        Array.isArray(s.answer) && 
                        s.answer.some(q => q.qIndex === questionIndex && String(q.ans) === String(question.correctAnswer))
                    );
                    titleText = `ÂïèÈ°å ${questionIndex + 1} Á≠îÂ∞çÁöÑÂ≠∏ÁîüÔºö`;
                } else if (answer === 'incorrect') {
                     filteredStudents = allStudentResponses.filter(s => 
                        Array.isArray(s.answer) && 
                        s.answer.some(q => q.qIndex === questionIndex && String(q.ans) !== String(question.correctAnswer))
                    );
                    titleText = `ÂïèÈ°å ${questionIndex + 1} Á≠îÈåØÁöÑÂ≠∏ÁîüÔºö`;
                } else { // Should not happen with current chart logic
                    filteredStudents = [];
                    titleText = `ÂïèÈ°å ${questionIndex + 1} ÁöÑÂ≠∏ÁîüÔºö`;
                }
            } else {
                // For default multiple choice or true/false
                filteredStudents = allStudentResponses.filter(s => s.answer === answer);
                titleText = `ÈÅ∏Êìá„Äå${answer}„ÄçÁöÑÂ≠∏ÁîüÔºö`;
            }

            const studentNames = filteredStudents.map(s => s.name).sort(); 
            studentsByAnswerListTitle.textContent = studentNames.length > 0 ? `${titleText} ${studentNames.join(', ')}` : `${titleText} Ê≤íÊúâÂ≠∏ÁîüÈÅ∏ÊìáÊ≠§Á≠îÊ°à„ÄÇ`;
            studentsByAnswerNamesParagraph.textContent = ''; // Clear this as the title now contains names
        }

        function drawChart(responses, mode) { // Changed parameter name from 'data' to 'responses' to avoid conflict
            chartSvg.selectAll("*").remove();
            clearStudentsByAnswerList();

            let chartData = {}; // Renamed 'data' to 'chartData'
            const filteredResponses = responses.filter(r => {
                if (mode === 'true_false' && (r.answer === 'O' || r.answer === 'X')) return true;
                if (mode === 'multiple_choice') {
                    if (currentMultipleChoiceQuestions) { // Custom MC
                        return Array.isArray(r.answer);
                    } else { // Default MC
                        return (r.answer >= '1' && r.answer <= '4');
                    }
                }
                if (mode === 'reading_comprehension') {
                    // Check if answer is a valid JSON array
                    try {
                        const parsed = JSON.parse(r.answer);
                        return Array.isArray(parsed);
                    } catch (e) {
                        return false;
                    }
                }
                return false;
            });

            const totalValidResponses = filteredResponses.length;

            if (totalValidResponses === 0) {
                const svgViewBox = chartSvg.attr("viewBox").split(" ");
                const viewBoxWidth = parseInt(svgViewBox[2]);
                const viewBoxHeight = parseInt(svgViewBox[3]);
                chartSvg.append("text")
                    .attr("x", viewBoxWidth / 2)
                    .attr("y", viewBoxHeight / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("ÁõÆÂâçÊ≤íÊúâ‰ΩúÁ≠îË≥áÊñô„ÄÇ");
                return;
            }

            if (mode === 'true_false') {
                chartData = { 'O': 0, 'X': 0 }; // Use chartData
                filteredResponses.forEach(r => { chartData[r.answer]++; });
                drawPieChart(chartData, totalValidResponses); // Pass chartData
            } else if (mode === 'multiple_choice') {
                if (currentMultipleChoiceQuestions) { // Custom Multiple Choice Chart
                    drawCustomMultipleChoiceBarChart(filteredResponses, currentMultipleChoiceQuestions);
                } else { // Default Multiple Choice Chart
                    chartData = { '1': 0, '2': 0, '3': 0, '4': 0 }; // Use chartData
                    filteredResponses.forEach(r => { chartData[r.answer]++; });
                    drawBarChart(chartData, totalValidResponses); // Pass chartData
                }
            } else if (mode === 'reading_comprehension') {
                if (readingComprehensionData && readingComprehensionData.questions) {
                    drawReadingComprehensionChart(filteredResponses, readingComprehensionData.questions);
                }
            }
        }

        function drawPieChart(data, totalValidResponses) {
            const svgViewBox = chartSvg.attr("viewBox").split(" ");
            const width = parseInt(svgViewBox[2]);
            const height = parseInt(svgViewBox[3]);
            const radius = Math.min(width, height) / 2 - 20;
            const g = chartSvg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);
            const color = d3.scaleOrdinal().domain(Object.keys(data)).range(['#16a34a', '#dc2626']); // Green for O, Red for X
            const pie = d3.pie().value(d => d[1]).sort(null);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);
            const arcs = g.selectAll(".arc").data(pie(Object.entries(data))).enter().append("g").attr("class", "arc");

            arcs.append("path")
                .attr("d", arc) 
                .attr("fill", d => color(d.data[0])) 
                .attr("stroke", "white").style("stroke-width", "2px")
                .on("click", (event, d) => displayStudentsForAnswer(d.data[0], 'true_false')); 

            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("dy", "0.35em")
                .text(d => {
                    const percentage = totalValidResponses > 0 ? ((d.data[1] / totalValidResponses) * 100).toFixed(1) : 0;
                    return `${d.data[0]}: ${d.data[1]} (${percentage}%)`;
                }) 
                .style("font-size", "14px").style("text-anchor", "middle").style("fill", "white").style("pointer-events", "none");
        }

        function drawBarChart(data, totalValidResponses) {
            const svgViewBox = chartSvg.attr("viewBox").split(" ");
            const svgWidth = parseInt(svgViewBox[2]);
            const svgHeight = parseInt(svgViewBox[3]);
            
            // üöÄ RWDÂÑ™ÂåñÔºöË™øÊï¥marginÁ¢∫‰øùÈï∑Ê¢ùÂúñÂ±Ö‰∏≠‰∏î‰∏çÊúÉË∑ëÁâà
            const margin = {top: 30, right: 40, bottom: 50, left: 50};
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;
            
            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.25)
                .domain(Object.keys(data));
            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(Object.values(data)) || 1]); 
            const color = d3.scaleOrdinal()
                .domain(Object.keys(data))
                .range(['#2563eb', '#ca8a04', '#16a34a', '#dc2626']);
            const g = chartSvg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // XËª∏
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("font-size", "14px")
                .style("font-weight", "600");
            
            // YËª∏
            g.append("g")
                .call(d3.axisLeft(y).ticks(Math.min(10, d3.max(Object.values(data)) || 1)).tickFormat(d3.format('d')))
                .selectAll("text")
                .style("font-size", "12px");

            // Èï∑Ê¢ù
            g.selectAll(".bar").data(Object.entries(data)).enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d[0]))
                .attr("y", d => y(d[1])) 
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d[1])) 
                .attr("fill", d => color(d[0]))
                .attr("rx", 4)
                .attr("ry", 4)
                .style("cursor", "pointer")
                .on("click", (event, d) => displayStudentsForAnswer(d[0], 'multiple_choice')); 
            
            // Ê®ôÁ±§
            g.selectAll(".bar-label").data(Object.entries(data)).enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d[0]) + x.bandwidth() / 2) 
                .attr("y", d => y(d[1]) - 8) 
                .attr("text-anchor", "middle")
                .style("font-size", "13px")
                .style("font-weight", "500")
                .style("pointer-events", "none")
                .text(d => {
                    const percentage = totalValidResponses > 0 ? ((d[1] / totalValidResponses) * 100).toFixed(0) : 0;
                    return `${d[1]} (${percentage}%)`;
                }); 
        }

        /**
         * NEW: Draws a bar chart for custom multiple choice questions, showing correctness rate per question.
         * @param {Array} responses - All student responses.
         * @param {Array} questions - The custom multiple choice questions.
         */
        function drawCustomMultipleChoiceBarChart(responses, questions) {
            const svgViewBox = chartSvg.attr("viewBox").split(" ");
            const svgWidth = parseInt(svgViewBox[2]);
            const svgHeight = parseInt(svgViewBox[3]);
            
            // üöÄ RWDÂÑ™ÂåñÔºöË™øÊï¥marginÁ¢∫‰øùÈï∑Ê¢ùÂúñÂ±Ö‰∏≠‰∏î‰∏çÊúÉË∑ëÁâà
            const margin = {top: 30, right: 40, bottom: 70, left: 55};
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;
            
            const questionStats = questions.map((q, qIndex) => {
                let correctCount = 0;
                let answeredCount = 0; // Count students who attempted this question

                responses.forEach(studentResponse => {
                    if (Array.isArray(studentResponse.answer)) {
                        const studentQAnswer = studentResponse.answer.find(ans => ans.qIndex === qIndex);
                        if (studentQAnswer) {
                            answeredCount++;
                            if (String(studentQAnswer.ans) === String(q.correctAnswer)) {
                                correctCount++;
                            }
                        }
                    }
                });
                return {
                    questionIndex: qIndex,
                    questionText: `Q${qIndex + 1}`, // Display as Q1, Q2 etc.
                    correctCount: correctCount,
                    answeredCount: answeredCount,
                    correctRate: answeredCount > 0 ? (correctCount / answeredCount) * 100 : 0
                };
            });

            // Filter out questions with no attempts if desired, or show 0%
            const displayStats = questionStats.filter(s => s.answeredCount > 0);
            if (displayStats.length === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("ÁõÆÂâçÊ≤íÊúâÂ≠∏Áîü‰ΩúÁ≠î‰ªª‰ΩïËá™Ë®ÇÈÅ∏ÊìáÈ°å„ÄÇ");
                return;
            }

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.25)
                .domain(displayStats.map(d => d.questionText));

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, 100]);

            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // XËª∏
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-30)")
                .attr("dx", "-0.5em")
                .attr("dy", "0.5em")
                .style("text-anchor", "end")
                .style("font-size", "12px")
                .style("font-weight", "500");

            // YËª∏
            g.append("g")
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => `${d}%`))
                .selectAll("text")
                .style("font-size", "11px");

            // Èï∑Ê¢ù
            g.selectAll(".bar")
                .data(displayStats)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.questionText))
                .attr("y", d => y(d.correctRate))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.correctRate))
                .attr("fill", "#2563eb")
                .attr("rx", 3)
                .attr("ry", 3)
                .style("cursor", "pointer")
                .on("click", (event, d) => displayStudentsForAnswer('correct', 'multiple_choice', d.questionIndex));

            // Ê®ôÁ±§
            g.selectAll(".bar-label")
                .data(displayStats)
                .enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.questionText) + x.bandwidth() / 2)
                .attr("y", d => y(d.correctRate) - 6)
                .attr("text-anchor", "middle")
                .style("font-size", "11px")
                .style("font-weight", "500")
                .style("pointer-events", "none")
                .text(d => `${d.correctRate.toFixed(0)}%`);

            // YËª∏Ê®ôÁ±§
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 15)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "500")
                .text("Á≠îÂ∞çÁéá");
        }

        /**
         * Draw reading comprehension statistics chart with PIRLS level analysis
         */
        function drawReadingComprehensionChart(responses, questions) {
            const svgViewBox = chartSvg.attr("viewBox").split(" ");
            const svgWidth = parseInt(svgViewBox[2]);
            const svgHeight = parseInt(svgViewBox[3]);
            
            // üöÄ RWDÂÑ™ÂåñÔºöË™øÊï¥marginÁ¢∫‰øùÈï∑Ê¢ùÂúñÂ±Ö‰∏≠‰∏î‰∏çÊúÉË∑ëÁâà
            const margin = {top: 30, right: 40, bottom: 80, left: 55};
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            // Calculate statistics for each question
            const questionStats = questions.map((q, qIndex) => {
                let correctCount = 0;
                let answeredCount = 0;

                responses.forEach(studentResponse => {
                    try {
                        const studentAnswers = JSON.parse(studentResponse.answer);
                        if (Array.isArray(studentAnswers) && studentAnswers[qIndex] !== undefined) {
                            answeredCount++;
                            // üöÄ FIX: ÊîØÊè¥ÈÄÅÂàÜÈ°åÔºàcorrectAnswer === 0 ÊôÇÁÑ°Ê¢ù‰ª∂ÁÆóÁÇ∫Ê≠£Á¢∫Ôºâ
                            if ((q.correctAnswer === 0) || (studentAnswers[qIndex] === q.correctAnswer)) {
                                correctCount++;
                            }
                        }
                    } catch (e) {
                        // Invalid answer format
                    }
                });

                return {
                    questionIndex: qIndex,
                    questionText: `Q${qIndex + 1}`,
                    level: q.level,
                    correctCount: correctCount,
                    answeredCount: answeredCount,
                    correctRate: answeredCount > 0 ? (correctCount / answeredCount) * 100 : 0,
                    isGivePoints: q.correctAnswer === 0  // üöÄ NEW: Ê®ôË®òÈÄÅÂàÜÈ°å
                };
            });

            // Calculate PIRLS level statistics
            const levelStats = [1, 2, 3, 4].map(level => {
                const levelQuestions = questionStats.filter(q => q.level === level);
                if (levelQuestions.length === 0) return null;

                const totalCorrect = levelQuestions.reduce((sum, q) => sum + q.correctCount, 0);
                const totalAnswered = levelQuestions.reduce((sum, q) => sum + q.answeredCount, 0);

                return {
                    level: level,
                    correctRate: totalAnswered > 0 ? (totalCorrect / totalAnswered) * 100 : 0,
                    questionCount: levelQuestions.length
                };
            }).filter(s => s !== null);

            const displayStats = questionStats.filter(s => s.answeredCount > 0);
            if (displayStats.length === 0) {
                chartSvg.append("text")
                    .attr("x", chartSvg.attr("width") / 2)
                    .attr("y", chartSvg.attr("height") / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .style("fill", "#666")
                    .text("ÁõÆÂâçÊ≤íÊúâÂ≠∏Áîü‰ΩúÁ≠îÈñ±ËÆÄÊ∏¨È©ó„ÄÇ");
                return;
            }

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.2)
                .domain(displayStats.map(d => d.questionText));

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, 100]);

            const g = chartSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // Define colors for each PIRLS level
            const levelColors = {
                1: '#3b82f6', // Blue - Áõ¥Êé•ÊèêÂèñ
                2: '#8b5cf6', // Purple - Áõ¥Êé•Êé®Ë´ñ
                3: '#f59e0b', // Amber - Ë©ÆÈáãÊï¥Âêà
                4: '#ef4444'  // Red - ÊØîËºÉË©ï‰º∞
            };

            // X-axis
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Y-axis
            g.append("g")
                .call(d3.axisLeft(y).ticks(10).tickFormat(d => `${d}%`));

            // Bars - üöÄ RWDÂÑ™ÂåñÔºöÊ∑ªÂä†ÂúìËßíÔºåÈÄÅÂàÜÈ°åÁî®ÁâπÊÆäÈÇäÊ°Ü
            g.selectAll(".bar")
                .data(displayStats)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.questionText))
                .attr("y", d => y(d.correctRate))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.correctRate))
                .attr("fill", d => levelColors[d.level])
                .attr("rx", 3)
                .attr("ry", 3)
                .attr("stroke", d => d.isGivePoints ? "#FFCC00" : "none")  // üöÄ Êñ∞Â¢ûÔºöÈÄÅÂàÜÈ°åÁî®ÈªÉËâ≤ÈÇäÊ°Ü
                .attr("stroke-width", d => d.isGivePoints ? 3 : 0)
                .style("cursor", "pointer");

            // üöÄ NEW: ÁÇ∫ÈÄÅÂàÜÈ°åÊ∑ªÂä†ÈªÉËâ≤‰∏âËßíÂΩ¢‚ö†Ô∏èÊ®ôË®ò
            g.selectAll(".give-points-badge")
                .data(displayStats.filter(d => d.isGivePoints))
                .enter().append("text")
                .attr("class", "give-points-badge")
                .attr("x", d => x(d.questionText) + x.bandwidth() / 2)
                .attr("y", d => y(d.correctRate) - 18)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("pointer-events", "none")
                .text("‚ö†Ô∏è");

            // Labels on bars - üöÄ RWDÂÑ™ÂåñÔºöÂ≠óÈ´îÊ¨äÈáç
            g.selectAll(".bar-label")
                .data(displayStats)
                .enter().append("text")
                .attr("class", "bar-label")
                .attr("x", d => x(d.questionText) + x.bandwidth() / 2)
                .attr("y", d => y(d.correctRate) - 6)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "500")
                .style("pointer-events", "none")
                .text(d => `${d.correctRate.toFixed(0)}%`);

            // Y-axis label
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 15)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "500")
                .text("Á≠îÂ∞çÁéá");

            // üöÄ PIRLS Level Legend and Statistics - RWDÂÑ™Âåñ
            const legendY = height + 50;
            const levelIcons = ['üìñ', 'üí≠', 'üîó', '‚öñÔ∏è'];
            const levelTexts = ['Áõ¥Êé•ÊèêÂèñ', 'Áõ¥Êé•Êé®Ë´ñ', 'Ë©ÆÈáãÊï¥Âêà', 'ÊØîËºÉË©ï‰º∞'];
            
            // Ë®àÁÆóÈüøÊáâÂºèÈñìË∑ùÔºöÊ†πÊìöÂúñË°®ÂØ¨Â∫¶ÂíåÂ±§Á¥öÊï∏ÈáèËá™ÂãïÈÅ©ÈÖç
            const itemSpacing = Math.max(90, Math.floor((width + margin.left + margin.right) / levelStats.length * 0.85));
            const startX = -margin.left + 10; // ÂæûÂúñË°®Â∑¶ÈÇäÈñãÂßã

            levelStats.forEach((stat, i) => {
                const legendX = startX + i * itemSpacing;
                const fontSize = width < 300 ? '10px' : '11px';
                const boxSize = 14;

                // Color box
                g.append("rect")
                    .attr("x", legendX)
                    .attr("y", legendY)
                    .attr("width", boxSize)
                    .attr("height", boxSize)
                    .attr("fill", levelColors[stat.level])
                    .attr("rx", 2);

                // Text - üöÄ RWDÂÑ™ÂåñÔºöÂãïÊÖãÂ≠óÈ´îÂ§ßÂ∞èÂíåÂ∞çÈΩê
                g.append("text")
                    .attr("x", legendX + boxSize + 8)
                    .attr("y", legendY + 11)
                    .style("font-size", fontSize)
                    .style("font-weight", "500")
                    .style("pointer-events", "none")
                    .text(`${levelIcons[i]} L${stat.level}: ${stat.correctRate.toFixed(0)}%`);
            });
        }


        // --- Sequencing Question Logic ---
        function setupSequencingUI(data) {
            console.log('[setupSequencingUI] Setting up sequencing UI with data:', data);
            const questionText = document.getElementById('sequencing-question-text');
            const container = document.getElementById('sequencing-items-container');

            if (!questionText || !container) {
                console.error('[setupSequencingUI] DOM elements not found!');
                return;
            }

            questionText.textContent = data.question || 'Ë´ã‰æùÁÖßÊ≠£Á¢∫È†ÜÂ∫èÊéíÂàó‰ª•‰∏ãÈ†ÖÁõÆ';
            container.innerHTML = '';

            if (!data.correctOrder || !Array.isArray(data.correctOrder) || data.correctOrder.length === 0) {
                console.error('[setupSequencingUI] Invalid or empty correctOrder array:', data.correctOrder);
                container.innerHTML = '<p class="text-red-500 text-center">ÁÑ°Ê≥ïËºâÂÖ•ÊéíÂ∫èÈ†ÖÁõÆ</p>';
                return;
            }

            // Shuffle items
            const shuffled = [...data.correctOrder].sort(() => Math.random() - 0.5);
            console.log('[setupSequencingUI] Shuffled items:', shuffled);

            shuffled.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'sequencing-item';
                item.draggable = true;
                item.dataset.text = text;
                item.innerHTML = `
                    <div class="sequencing-item-number">${index + 1}</div>
                    <div class="sequencing-item-text">${text}</div>
                `;

                // Drag events
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = document.querySelector('.sequencing-item.dragging');
                    if (dragging && dragging !== item) {
                        const rect = item.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            container.insertBefore(dragging, item);
                        } else {
                            container.insertBefore(dragging, item.nextSibling);
                        }
                    }
                });

                // Touch events for mobile
                let touchStartY = 0;
                item.addEventListener('touchstart', (e) => {
                    touchStartY = e.touches[0].clientY;
                    item.classList.add('dragging');
                });

                item.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (target && target.classList.contains('sequencing-item') && target !== item) {
                        if (touch.clientY < touchStartY) {
                            container.insertBefore(item, target);
                        } else {
                            container.insertBefore(item, target.nextSibling);
                        }
                        touchStartY = touch.clientY;
                    }
                });

                item.addEventListener('touchend', () => {
                    item.classList.remove('dragging');
                });

                container.appendChild(item);
            });

            // Update numbers after any change
            updateSequencingNumbers();
        }

        function updateSequencingNumbers() {
            const items = document.querySelectorAll('.sequencing-item');
            items.forEach((item, index) => {
                const numberDiv = item.querySelector('.sequencing-item-number');
                if (numberDiv) numberDiv.textContent = index + 1;
            });
        }

        // --- Matching Question Logic ---
        function setupMatchingUI(data) {
            console.log('[setupMatchingUI] Setting up matching UI with data:', data);
            const questionText = document.getElementById('matching-question-text');
            const columnA = document.getElementById('matching-column-a');
            const columnB = document.getElementById('matching-column-b');
            const svg = document.getElementById('matching-svg-canvas');

            if (!questionText || !columnA || !columnB || !svg) {
                console.error('[setupMatchingUI] DOM elements not found!');
                return;
            }

            questionText.textContent = data.question || 'Ë´ãÂ∞áÂ∑¶Âè≥ÂÖ©ÂÅ¥Áõ∏ÈóúÁöÑÈ†ÖÁõÆÈÖçÂ∞ç';
            columnA.innerHTML = '';
            columnB.innerHTML = '';
            svg.innerHTML = '';

            if (!data.pairs || !Array.isArray(data.pairs) || data.pairs.length === 0) {
                console.error('[setupMatchingUI] Invalid or empty pairs array:', data.pairs);
                columnA.innerHTML = '<p class="text-red-500">ÁÑ°Ê≥ïËºâÂÖ•ÈÖçÂ∞çÈ†ÖÁõÆ</p>';
                return;
            }

            // Shuffle items
            const leftItems = data.pairs.map(p => p.left).sort(() => Math.random() - 0.5);
            const rightItems = data.pairs.map(p => p.right).sort(() => Math.random() - 0.5);
            console.log('[setupMatchingUI] Left items:', leftItems, 'Right items:', rightItems);

            leftItems.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'matching-item';
                item.dataset.side = 'left';
                item.dataset.text = text;
                item.dataset.index = index;
                // ‚ú® Add safe ID for reliable element selection (avoids special character issues)
                item.id = `matching-left-${index}`;
                item.textContent = text;
                item.addEventListener('click', () => handleMatchingClick(item));
                columnA.appendChild(item);
            });

            rightItems.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'matching-item';
                item.dataset.side = 'right';
                item.dataset.text = text;
                item.dataset.index = index;
                // ‚ú® Add safe ID for reliable element selection (avoids special character issues)
                item.id = `matching-right-${index}`;
                item.textContent = text;
                item.addEventListener('click', () => handleMatchingClick(item));
                columnB.appendChild(item);
            });
        }

        function handleMatchingClick(item) {
            const side = item.dataset.side;

            if (item.classList.contains('matched')) {
                // Unmatch
                const matchedWith = item.dataset.matchedWith;
                delete item.dataset.matchedWith;
                item.classList.remove('matched');

                // Find and unmatch partner
                const partner = document.querySelector(`.matching-item[data-side="${side === 'left' ? 'right' : 'left'}"][data-text="${matchedWith}"]`);
                if (partner) {
                    delete partner.dataset.matchedWith;
                    partner.classList.remove('matched');
                }

                redrawMatchingLines();
                return;
            }

            if (side === 'left') {
                if (currentMatchingSelection.leftItem === item) {
                    currentMatchingSelection.leftItem.classList.remove('selected');
                    currentMatchingSelection.leftItem = null;
                } else {
                    if (currentMatchingSelection.leftItem) {
                        currentMatchingSelection.leftItem.classList.remove('selected');
                    }
                    currentMatchingSelection.leftItem = item;
                    item.classList.add('selected');
                }
            } else {
                if (currentMatchingSelection.rightItem === item) {
                    currentMatchingSelection.rightItem.classList.remove('selected');
                    currentMatchingSelection.rightItem = null;
                } else {
                    if (currentMatchingSelection.rightItem) {
                        currentMatchingSelection.rightItem.classList.remove('selected');
                    }
                    currentMatchingSelection.rightItem = item;
                    item.classList.add('selected');
                }
            }

            // If both sides selected, create match
            if (currentMatchingSelection.leftItem && currentMatchingSelection.rightItem) {
                const left = currentMatchingSelection.leftItem;
                const right = currentMatchingSelection.rightItem;

                left.classList.remove('selected');
                right.classList.remove('selected');
                left.classList.add('matched');
                right.classList.add('matched');

                left.dataset.matchedWith = right.dataset.text;
                right.dataset.matchedWith = left.dataset.text;

                currentMatchingSelection.leftItem = null;
                currentMatchingSelection.rightItem = null;

                redrawMatchingLines();
            }
        }

        function redrawMatchingLines() {
            const svg = document.getElementById('matching-svg-canvas');
            svg.innerHTML = '';

            const container = document.querySelector('.matching-container');
            const rect = container.getBoundingClientRect();
            svg.setAttribute('width', rect.width);
            svg.setAttribute('height', rect.height);

            // üé® Add SVG gradients for beautiful connecting lines
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            
            // Pink gradient for default matching lines
            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradient.setAttribute('id', 'lineGradient');
            gradient.setAttribute('x1', '0%');
            gradient.setAttribute('y1', '0%');
            gradient.setAttribute('x2', '100%');
            gradient.setAttribute('y2', '0%');
            gradient.innerHTML = `
                <stop offset="0%" style="stop-color:#ec4899;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#f472b6;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
            `;
            defs.appendChild(gradient);

            // Green gradient for correct matches
            const gradientCorrect = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradientCorrect.setAttribute('id', 'lineGradientCorrect');
            gradientCorrect.setAttribute('x1', '0%');
            gradientCorrect.setAttribute('y1', '0%');
            gradientCorrect.setAttribute('x2', '100%');
            gradientCorrect.setAttribute('y2', '0%');
            gradientCorrect.innerHTML = `
                <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#34d399;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" />
            `;
            defs.appendChild(gradientCorrect);

            // Red gradient for incorrect matches
            const gradientIncorrect = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradientIncorrect.setAttribute('id', 'lineGradientIncorrect');
            gradientIncorrect.setAttribute('x1', '0%');
            gradientIncorrect.setAttribute('y1', '0%');
            gradientIncorrect.setAttribute('x2', '100%');
            gradientIncorrect.setAttribute('y2', '0%');
            gradientIncorrect.innerHTML = `
                <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#f87171;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
            `;
            defs.appendChild(gradientIncorrect);

            svg.appendChild(defs);

            // Draw matching lines with smooth curves
            let lineIndex = 0;
            document.querySelectorAll('.matching-item.matched[data-side="left"]').forEach(leftItem => {
                const rightText = leftItem.dataset.matchedWith;
                const rightItem = document.querySelector(`.matching-item[data-side="right"][data-text="${rightText}"]`);

                if (rightItem) {
                    const leftRect = leftItem.getBoundingClientRect();
                    const rightRect = rightItem.getBoundingClientRect();

                    const x1 = leftRect.right - rect.left;
                    const y1 = leftRect.top + leftRect.height / 2 - rect.top;
                    const x2 = rightRect.left - rect.left;
                    const y2 = rightRect.top + rightRect.height / 2 - rect.top;

                    // üé® Create smooth Bezier curve with gradient stroke
                    const controlPointX = (x1 + x2) / 2;
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${x1} ${y1} C ${controlPointX} ${y1}, ${controlPointX} ${y2}, ${x2} ${y2}`;
                    line.setAttribute('d', d);
                    line.setAttribute('class', 'matching-line');
                    
                    // ‚ú® Explicitly set stroke with gradient
                    line.setAttribute('stroke', 'url(#lineGradient)');
                    line.setAttribute('stroke-width', window.innerWidth >= 768 ? '5' : '4');
                    line.setAttribute('fill', 'none');
                    line.setAttribute('stroke-linecap', 'round');
                    
                    // üé¨ Stagger animation for visual appeal
                    line.style.animationDelay = `${lineIndex * 0.1}s`;
                    lineIndex++;
                    
                    svg.appendChild(line);
                }
            });
        }

        /**
         * üöÄ NEW: Wait for matching DOM elements to be ready
         * @param {object} settings - The matching settings
         * @returns {Promise} Resolves when DOM is ready, rejects after timeout
         */
        async function waitForMatchingDomReady(settings) {
            const timeout = 500; // 500ms timeout
            const startTime = Date.now();
            
            return new Promise((resolve, reject) => {
                const checkDom = () => {
                    // Check if first left and right items exist
                    const leftItem = document.getElementById('matching-left-0');
                    const rightItem = document.getElementById('matching-right-0');
                    
                    if (leftItem && rightItem) {
                        console.log('[waitForMatchingDomReady] DOM ready, elements found');
                        resolve();
                    } else {
                        const elapsed = Date.now() - startTime;
                        if (elapsed > timeout) {
                            console.error('[waitForMatchingDomReady] Timeout after', elapsed, 'ms, DOM not ready');
                            reject(new Error('Matching DOM timeout'));
                        } else {
                            console.log('[waitForMatchingDomReady] Waiting for DOM... elapsed:', elapsed, 'ms');
                            requestAnimationFrame(checkDom);
                        }
                    }
                };
                
                requestAnimationFrame(checkDom);
            });
        }

        /**
         * üöÄ NEW: Display correct answers for matching questions
         * @param {object} matchingSettings - The matching settings with correct pairs
         */
        function displayMatchingCorrectAnswers(matchingSettings) {
            if (!matchingSettings || !matchingSettings.pairs || !Array.isArray(matchingSettings.pairs)) {
                console.error('[displayMatchingCorrectAnswers] Invalid matching settings:', matchingSettings);
                return;
            }

            console.log('[displayMatchingCorrectAnswers] Displaying correct answers for matching');

            // 1. Clear existing selections and matches (Ê∏ÖÈô§Â≠∏ÁîüÁöÑÈÖçÂ∞çÁãÄÊÖã)
            document.querySelectorAll('.matching-item').forEach(item => {
                item.classList.remove('selected', 'matched');
                delete item.dataset.matchedWith;
            });

            // 2. ‚ú® Find items by text content (since they're shuffled, we can't use fixed indices)
            // Âè™Áï´Á∂†Ëâ≤ÈÄ£Á∑öÂ∞±Â•ΩÔºåÈÄôÊ®£Ë¶ñË¶∫‰∏äÊõ¥Ê∏ÖÊô∞
            matchingSettings.pairs.forEach(pair => {
                // Use Array.from to find items by text content (more reliable than querySelector with special chars)
                const leftItems = Array.from(document.querySelectorAll('.matching-item[data-side="left"]'));
                const rightItems = Array.from(document.querySelectorAll('.matching-item[data-side="right"]'));
                
                const leftItem = leftItems.find(item => item.dataset.text === pair.left);
                const rightItem = rightItems.find(item => item.dataset.text === pair.right);

                if (leftItem && rightItem) {
                    // Âè™Ê®ôË®ò data-matchedWith Âíå ID Áî®ÊñºÁï´Á∑öÔºå‰∏çÊ∑ªÂä† matched È°û
                    leftItem.dataset.matchedWith = rightItem.id;
                    rightItem.dataset.matchedWith = leftItem.id;
                    // Ê∑ªÂä†ÁâπÊÆäÈ°û‰ª•ÂçÄÂàÜÈÄôÊòØÁ≠îÊ°àÈ°ØÁ§∫Ê®°Âºè
                    leftItem.classList.add('answer-revealed');
                    rightItem.classList.add('answer-revealed');
                    console.log(`[displayMatchingCorrectAnswers] Paired: ${leftItem.id} ‚Üî ${rightItem.id}`);
                } else {
                    console.warn(`[displayMatchingCorrectAnswers] Could not find items for pair:`, pair);
                }
            });

            // 3. Redraw lines with correct answer gradient
            const svg = document.getElementById('matching-svg-canvas');
            svg.innerHTML = '';

            const container = document.querySelector('.matching-container');
            const rect = container.getBoundingClientRect();
            svg.setAttribute('width', rect.width);
            svg.setAttribute('height', rect.height);
            svg.setAttribute('style', 'pointer-events: none; z-index: 10;');

            // Add gradients and drop shadow for visual depth
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            
            // Gradient for correct answers
            const gradientCorrect = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradientCorrect.setAttribute('id', 'lineGradientCorrect');
            gradientCorrect.setAttribute('x1', '0%');
            gradientCorrect.setAttribute('y1', '0%');
            gradientCorrect.setAttribute('x2', '100%');
            gradientCorrect.setAttribute('y2', '0%');
            gradientCorrect.innerHTML = `
                <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#34d399;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" />
            `;
            defs.appendChild(gradientCorrect);
            
            // Drop shadow for depth
            const filter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
            filter.setAttribute('id', 'dropShadow');
            filter.innerHTML = `<feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.3"/>`;
            defs.appendChild(filter);
            
            svg.appendChild(defs);

            // Draw correct answer lines using matched IDs
            let lineIndex = 0;
            document.querySelectorAll('.matching-item[data-side="left"].answer-revealed').forEach(leftItem => {
                const rightId = leftItem.dataset.matchedWith;
                const rightItem = document.getElementById(rightId);

                if (rightItem) {
                    const leftRect = leftItem.getBoundingClientRect();
                    const rightRect = rightItem.getBoundingClientRect();

                    const x1 = leftRect.right - rect.left;
                    const y1 = leftRect.top + leftRect.height / 2 - rect.top;
                    const x2 = rightRect.left - rect.left;
                    const y2 = rightRect.top + rightRect.height / 2 - rect.top;

                    const controlPointX = (x1 + x2) / 2;
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${x1} ${y1} C ${controlPointX} ${y1}, ${controlPointX} ${y2}, ${x2} ${y2}`;
                    line.setAttribute('d', d);
                    line.setAttribute('class', 'matching-line');
                    line.setAttribute('stroke', 'url(#lineGradientCorrect)');
                    line.setAttribute('stroke-width', window.innerWidth >= 768 ? '5' : '4');
                    line.setAttribute('fill', 'none');
                    line.setAttribute('stroke-linecap', 'round');
                    line.setAttribute('filter', 'url(#dropShadow)');
                    line.style.animationDelay = `${lineIndex * 0.1}s`;
                    lineIndex++;

                    svg.appendChild(line);
                    console.log(`[displayMatchingCorrectAnswers] Drew line from ${leftItem.id} to ${rightId}`);
                }
            });

            console.log(`[displayMatchingCorrectAnswers] Drew ${lineIndex} lines total`);

            // 4. Disable interaction - remove click handlers by blocking pointer events
            const matchingContainer = document.querySelector('.matching-container');
            if (matchingContainer) {
                matchingContainer.style.pointerEvents = 'none';
            }

            // 5. Show message to student
            showMessage('ËÄÅÂ∏´Â∑≤È°ØÁ§∫Ê≠£Á¢∫Á≠îÊ°àÔºÅ', 'info');
        }

        /**
         * üöÄ NEW: Display correct answers for sequencing questions
         * @param {object} sequencingSettings - The sequencing settings with correct order
         */
        function displaySequencingCorrectAnswers(sequencingSettings) {
            if (!sequencingSettings || !sequencingSettings.correctOrder || !Array.isArray(sequencingSettings.correctOrder)) {
                console.error('[displaySequencingCorrectAnswers] Invalid sequencing settings:', sequencingSettings);
                return;
            }

            console.log('[displaySequencingCorrectAnswers] Displaying correct answers for sequencing');

            const container = document.getElementById('sequencing-items-container');
            if (!container) {
                console.error('[displaySequencingCorrectAnswers] Container not found');
                return;
            }

            // 1. Clear existing items
            container.innerHTML = '';

            // 2. Render items in correct order with visual indicators
            sequencingSettings.correctOrder.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'sequencing-item correct-answer';
                item.draggable = false;
                item.innerHTML = `
                    <div class="sequencing-item-number text-xs sm:text-sm md:text-base px-2 sm:px-2.5 py-1 sm:py-1.5 rounded">${index + 1}</div>
                    <div class="sequencing-item-text flex-1 text-base sm:text-lg md:text-xl">${text}</div>
                    <div class="sequencing-item-check">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 md:w-7 md:h-7 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                `;
                container.appendChild(item);
            });

            // 3. Disable interaction - freeze drag handlers
            const items = container.querySelectorAll('.sequencing-item');
            items.forEach(item => {
                item.draggable = false;
                item.style.pointerEvents = 'none';
            });

            // 4. Disable submit button
            const submitBtn = document.getElementById('submit-sequencing-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
            }

            // 5. Show message to student
            showMessage('ËÄÅÂ∏´Â∑≤È°ØÁ§∫Ê≠£Á¢∫Á≠îÊ°àÔºÅ', 'info');
        }

        /**
         * üöÄ NEW: Teacher listener for answer display flags
         */
        let teacherAnswerUnsubscribe = null; // Track listener to prevent duplicates
        
        function setupTeacherAnswerListener() {
            if (!classroomCode) return;
            
            // üî• Unsubscribe existing listener to prevent memory leak
            if (teacherAnswerUnsubscribe) {
                console.log('[setupTeacherAnswerListener] Unsubscribing existing listener');
                teacherAnswerUnsubscribe();
                teacherAnswerUnsubscribe = null;
            }
            
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            teacherAnswerUnsubscribe = onSnapshot(controlRef, (docSnap) => {
                if (!docSnap.exists()) return;
                const data = docSnap.data();
                
                // Display matching answer if flag is true
                if (data.showMatchingAnswer && data.matchingSettings) {
                    displayTeacherMatchingAnswer(data.matchingSettings);
                }
                
                // Display sequencing answer if flag is true
                if (data.showSequencingAnswer && data.sequencingSettings) {
                    displayTeacherSequencingAnswer(data.sequencingSettings);
                }
            });
            
            console.log('[setupTeacherAnswerListener] New listener registered');
        }

        /**
         * üöÄ NEW: Display correct answers for teacher (matching questions)
         */
        function displayTeacherMatchingAnswer(matchingSettings) {
            const display = document.getElementById('teacher-answer-display');
            const content = document.getElementById('teacher-answer-content');
            const title = document.getElementById('teacher-answer-title');
            
            if (!matchingSettings || !matchingSettings.pairs) return;
            
            title.textContent = 'ÈÖçÂ∞çÈ°åÊ≠£Á¢∫Á≠îÊ°à';
            content.innerHTML = '<ol class="list-decimal list-inside space-y-2 text-lg">' + 
                matchingSettings.pairs.map((pair, i) => 
                    `<li><strong>${pair.left}</strong> ‚Üí ${pair.right}</li>`
                ).join('') + '</ol>';
            display.classList.remove('hidden');
        }

        /**
         * üöÄ NEW: Display correct answers for teacher (sequencing questions)
         */
        function displayTeacherSequencingAnswer(sequencingSettings) {
            const display = document.getElementById('teacher-answer-display');
            const content = document.getElementById('teacher-answer-content');
            const title = document.getElementById('teacher-answer-title');
            
            if (!sequencingSettings || !sequencingSettings.correctOrder) return;
            
            title.textContent = 'ÊéíÂ∫èÈ°åÊ≠£Á¢∫Á≠îÊ°à';
            content.innerHTML = '<ol class="list-decimal list-inside space-y-2 text-lg">' + 
                sequencingSettings.correctOrder.map((item, i) => 
                    `<li>${item}</li>`
                ).join('') + '</ol>';
            display.classList.remove('hidden');
        }

        // --- Drawing Board Logic ---
        function setupCanvas() {
            const canvasElement = document.getElementById('drawing-canvas');
            if (!canvasElement.offsetParent) return; // Don't setup if not visible
            let renderedWidth = canvasElement.clientWidth;
            let renderedHeight = canvasElement.clientHeight;

            canvasElement.width = Math.min(MAX_IMAGE_DIMENSION * 2, Math.max(1, renderedWidth)); 
            canvasElement.height = Math.min(MAX_IMAGE_DIMENSION * 2, Math.max(1, renderedHeight));

            [backgroundCanvas, studentImageCanvas, drawingCanvas].forEach(c => {
                c.width = canvasElement.width;
                c.height = canvasElement.height;
            });

            drawingCtx.lineJoin = 'round';
            drawingCtx.lineCap = 'round';
            drawingCtx.strokeStyle = document.getElementById('color-select').value;
            drawingCtx.lineWidth = parseInt(document.getElementById('size-select').value);
            drawingCtx.globalCompositeOperation = 'source-over';

            // Only clear drawingCanvas if it's a new session, not just a resize within the same session.
            // This is handled by the `resetStudentUIState` function now.
            // For setupCanvas, it's about setting dimensions and initial drawing context properties.
            // The actual clearing should be conditional based on pause state.
            // However, for a fresh setup (e.g., first time entering drawing mode), it should be cleared.
            // The logic in resetStudentUIState is responsible for this.
            // So, here, we just ensure the canvases are ready.
            backgroundCtx.fillStyle = 'white';
            backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
        }

        function loadBackgroundImage() {
            backgroundCtx.clearRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
            backgroundCtx.fillStyle = 'white';
            backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);

            if (teacherUploadedBackgroundImageDataURL) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const canvasRatio = backgroundCanvas.width / backgroundCanvas.height;
                    const imgRatio = tempImg.width / tempImg.height;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    if (imgRatio > canvasRatio) { 
                        drawHeight = backgroundCanvas.width / imgRatio;
                        drawWidth = backgroundCanvas.width;
                        offsetY = (backgroundCanvas.height - drawHeight) / 2;
                        offsetX = 0;
                    } else { 
                        drawWidth = backgroundCanvas.height * imgRatio;
                        drawHeight = backgroundCanvas.height;
                        offsetX = (backgroundCanvas.width - drawWidth) / 2;
                        offsetY = 0;
                    }
                    backgroundCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                    drawCombinedCanvas();
                };
                tempImg.src = teacherUploadedBackgroundImageDataURL;
            } else {
                drawCombinedCanvas();
            }
        }

        function loadStudentImage() {
            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);

            if (studentUploadedImageDataURL) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const canvasRatio = studentImageCanvas.width / studentImageCanvas.height;
                    const imgRatio = tempImg.width / tempImg.height;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    if (imgRatio > canvasRatio) { 
                        drawHeight = studentImageCanvas.width / imgRatio;
                        drawWidth = studentImageCanvas.width;
                        offsetY = (studentImageCanvas.height - drawHeight) / 2;
                        offsetX = 0;
                    } else { 
                        drawWidth = studentImageCanvas.height * imgRatio;
                        drawHeight = studentImageCanvas.height;
                        offsetX = (studentImageCanvas.width - drawWidth) / 2;
                        offsetY = 0;
                    }
                    studentImageCtx.drawImage(tempImg, offsetX, offsetY, drawWidth, drawHeight);
                    drawCombinedCanvas();
                };
                tempImg.src = studentUploadedImageDataURL;
            } else {
                drawCombinedCanvas();
            }
        }

        function drawCombinedCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundCanvas, 0, 0);
            ctx.drawImage(studentImageCanvas, 0, 0);
            ctx.drawImage(drawingCanvas, 0, 0);
        }

        /**
         * üöÄ OPTIMIZED: Áπ™ÂúñÂáΩÂºèÔºàÂ∞áË¢´ÁØÄÊµÅÂåÖË£ùÔºâ
         */
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); 
            const { offsetX, offsetY } = getMousePos(e); 
            drawingCtx.beginPath();
            drawingCtx.moveTo(lastX, lastY);
            drawingCtx.lineTo(offsetX, offsetY);
            drawingCtx.stroke();
            [lastX, lastY] = [offsetX, offsetY];
            drawCombinedCanvas();
        }
        
        // üöÄ OPTIMIZED: ÂâµÂª∫ÁØÄÊµÅÁâàÊú¨ÁöÑÁπ™ÂúñÂáΩÂºèÔºà16ms ‚âà 60 FPSÔºâ
        const throttledDraw = Utils.throttle(draw, 16);

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect(); 
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rawOffsetX = clientX - rect.left;
            const rawOffsetY = clientY - rect.top;
            const scaleX = canvas.width / rect.width; 
            const scaleY = canvas.height / rect.height;
            return { offsetX: rawOffsetX * scaleX, offsetY: rawOffsetY * scaleY };
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const { offsetX, offsetY } = getMousePos(e); 
            [lastX, lastY] = [offsetX, offsetY];
        }

        function stopDrawing() { isDrawing = false; }
        
        function clearDrawingCanvas() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawCombinedCanvas();
        }

        function updateColorSwatch(color) {
            const swatch = document.getElementById('current-color-swatch');
            if (swatch) swatch.style.backgroundColor = color;
        }
        
        // --- AI Settings Modal Functions ---
        const aiSettingsModal = document.getElementById('ai-settings-modal');
        const aiSettingsModalCloseBtn = document.getElementById('ai-settings-modal-close-btn');
        const aiSourceSelect = document.getElementById('ai-source-select');
        const geminiApiKeyGroup = document.getElementById('gemini-api-key-group');
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
        const saveAiSettingsBtn = document.getElementById('save-ai-settings-btn');

        function showAISettingsModal() {
            aiSourceSelect.value = aiSettings.aiSource;
            geminiApiKeyInput.value = aiSettings.geminiApiKey;
            geminiApiKeyGroup.classList.toggle('hidden', aiSettings.aiSource !== 'gemini-custom');
            aiSettingsModal.classList.remove('hidden');
        }

        function hideAISettingsModal() {
            aiSettingsModal.classList.add('hidden');
        }

        function saveAISettings() {
            aiSettings.aiSource = aiSourceSelect.value;
            aiSettings.geminiApiKey = geminiApiKeyInput.value.trim();
            localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
            showMessage('AI Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠òÔºÅ', 'success');
            hideAISettingsModal();
        }

        /**
         * Ê™¢Êü• API KEY ÊòØÂê¶Â∑≤Ë®≠ÂÆö‰∏¶Á¨¶ÂêàÂü∫Êú¨Ê†ºÂºèË¶ÅÊ±Ç
         * Â¶ÇÊûúÊú™Ë®≠ÂÆöÊàñÊ†ºÂºèÊòéÈ°ØÈåØË™§ÔºåÈ°ØÁ§∫Ë≠¶ÂëäË®äÊÅØ‰∏¶ÊâìÈñã AI Ë®≠ÂÆöÊ®°ÊÖãÊ°Ü
         * @returns {boolean} Â¶ÇÊûú API KEY ÈÄöÈÅéÂü∫Êú¨Ê™¢Êü•ËøîÂõû trueÔºåÂê¶ÂâáËøîÂõû false
         */
        function checkAPIKey() {
            const apiKey = aiSettings.geminiApiKey?.trim();
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Á©∫ÊàñÈ†êË®≠ÂÄº
            if (!apiKey || apiKey === '12345678') {
                const errorMsg = '‚ö†Ô∏è Ë´ãÂÖàÂú® AI Ë®≠ÂÆö‰∏≠Â°´ÂØ´ÊÇ®ÁöÑ Google AI Studio API KeyÔºÅ';
                console.error('[API KEY È©óË≠â]', errorMsg, { currentKey: apiKey || '(Á©∫ÂÄº)' });
                showMessage(errorMsg, 'warning');
                // È°ØÁ§∫Ë®äÊÅØÂæåÁ´ãÂç≥ÊâìÈñãË®≠ÂÆöÊ°ÜÔºàË®äÊÅØ z-index Êõ¥È´òÔºå‰∏çÊúÉË¢´ÈÅÆÊìãÔºâ
                showAISettingsModal();
                return false;
            }
            
            // Ê™¢Êü•Âü∫Êú¨Ê†ºÂºèÔºöGoogle API Key ÈÄöÂ∏∏Ëá≥Â∞ë 30 Â≠óÁ¨¶
            if (apiKey.length < 30) {
                const errorMsg = `‚ùå API KEY Ê†ºÂºèÈåØË™§ÔºÅÈÄöÂ∏∏Ëá≥Â∞ëÈúÄË¶Å 30 ÂÄãÂ≠óÁ¨¶ÔºåÊÇ®Âè™Ëº∏ÂÖ•‰∫Ü ${apiKey.length} ÂÄãÂ≠óÁ¨¶„ÄÇ`;
                console.error('[API KEY È©óË≠â] Ê†ºÂºèÊ™¢Êü•Â§±Êïó:', {
                    errorType: 'KEY_TOO_SHORT',
                    expectedMinLength: 30,
                    actualLength: apiKey.length,
                    keyPreview: apiKey.substring(0, 10) + '...',
                    message: errorMsg
                });
                showMessage(errorMsg, 'error');
                // È°ØÁ§∫Ë®äÊÅØÂæåÁ´ãÂç≥ÊâìÈñãË®≠ÂÆöÊ°ÜÔºàË®äÊÅØ z-index Êõ¥È´òÔºå‰∏çÊúÉË¢´ÈÅÆÊìãÔºâ
                showAISettingsModal();
                return false;
            }
            
            return true;
        }

        function loadAISettings() {
            const savedSettings = localStorage.getItem('aiSettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    if (parsedSettings.aiSource) aiSettings.aiSource = parsedSettings.aiSource;
                    // MODIFIED: If geminiApiKey is empty after loading, set default.
                    aiSettings.geminiApiKey = parsedSettings.geminiApiKey || '12345678'; 
                } catch (e) {
                    console.error("Failed to parse AI settings from localStorage:", e);
                    // If parsing fails, set default API key
                    aiSettings.geminiApiKey = '12345678';
                }
            } else {
                // If no settings are saved at all, set default API key
                aiSettings.geminiApiKey = '12345678';
            }
        }

        // --- New: URL/HTML Dispatch Settings Modal Functions (Combined) ---
        const urlDispatchModal = document.getElementById('url-dispatch-settings-modal');
        const urlDispatchModalCloseBtn = document.getElementById('url-dispatch-settings-modal-close-btn');
        
        const urlDispatchSection = document.getElementById('url-dispatch-section');
        const htmlDispatchSection = document.getElementById('html-dispatch-section');
        const dispatchTypeRadios = document.querySelectorAll('input[name="dispatchType"]');

        const urlInput = document.getElementById('dispatch-url-input');
        const isYoutubeCheckbox = document.getElementById('is-youtube-checkbox');
        
        const dispatchHtmlUploadInput = document.getElementById('dispatch-html-upload-input');
        const clearDispatchHtmlBtn = document.getElementById('clear-dispatch-html-btn');
        const dispatchHtmlStatus = document.getElementById('dispatch-html-status');

        function showUrlDispatchSettingsModal() {
            // Set radio button based on current dispatchSettings.type
            document.querySelector(`input[name="dispatchType"][value="${dispatchSettings.type}"]`).checked = true;
            
            // Show/hide sections based on type
            urlDispatchSection.classList.toggle('hidden', dispatchSettings.type === 'html');
            htmlDispatchSection.classList.toggle('hidden', dispatchSettings.type === 'url');

            // Populate URL fields
            urlInput.value = dispatchSettings.url;
            isYoutubeCheckbox.checked = dispatchSettings.isYoutube;

            // Update HTML status
            dispatchHtmlStatus.textContent = dispatchSettings.htmlContent ? 'Â∑≤‰∏äÂÇ≥ HTML Ê™îÊ°à„ÄÇ' : 'ÁõÆÂâçÊ≤íÊúâ HTML Ê™îÊ°à„ÄÇ';

            urlDispatchModal.classList.remove('hidden');
        }

        function hideUrlDispatchSettingsModal() {
            urlDispatchModal.classList.add('hidden');
        }

        function saveDispatchSettings() { // Renamed from saveUrlDispatchSettings
            dispatchSettings.type = document.querySelector('input[name="dispatchType"]:checked').value;

            if (dispatchSettings.type === 'url') {
                dispatchSettings.url = urlInput.value.trim();
                dispatchSettings.isYoutube = isYoutubeCheckbox.checked;
                dispatchSettings.htmlContent = null; // Clear HTML content if switching to URL
            } else { // type === 'html'
                // htmlContent is updated via handleHtmlFile or clearDispatchHtml
                dispatchSettings.url = ''; // Clear URL if switching to HTML
                dispatchSettings.isYoutube = false; // Clear YouTube flag
            }
            
            localStorage.setItem('dispatchSettings', JSON.stringify(dispatchSettings));
            showMessage('Ê¥æÈÄÅË®≠ÂÆöÂ∑≤ÂÑ≤Â≠òÔºÅ', 'success');
            hideUrlDispatchSettingsModal();
        }

        function clearDispatchSettings() { // Renamed from clearUrlDispatchSettings
            urlInput.value = '';
            isYoutubeCheckbox.checked = false;
            dispatchHtmlUploadInput.value = ''; // Clear file input
            dispatchHtmlStatus.textContent = 'ÁõÆÂâçÊ≤íÊúâ HTML Ê™îÊ°à„ÄÇ';

            dispatchSettings = { type: 'url', url: '', isYoutube: false, htmlContent: null }; // Reset global variable
            localStorage.removeItem('dispatchSettings'); // Clear from localStorage
            
            // Reset UI to default (URL selected)
            document.querySelector('input[name="dispatchType"][value="url"]').checked = true;
            urlDispatchSection.classList.remove('hidden');
            htmlDispatchSection.classList.add('hidden');
        }

        function loadDispatchSettings() { // Renamed from loadUrlDispatchSettings
            const savedSettings = localStorage.getItem('dispatchSettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    // Ensure all properties are set, even if null in saved data
                    dispatchSettings.type = parsedSettings.type || 'url';
                    dispatchSettings.url = parsedSettings.url || '';
                    dispatchSettings.isYoutube = parsedSettings.isYoutube || false;
                    dispatchSettings.htmlContent = parsedSettings.htmlContent || null;
                } catch (e) {
                    console.error("Failed to parse dispatch settings from localStorage:", e);
                    // Reset to default if parsing fails
                    dispatchSettings = { type: 'url', url: '', isYoutube: false, htmlContent: null };
                }
            }
        }

        /**
         * NEW: Handles HTML file upload within the combined dispatch settings modal.
         * @param {File} file - The HTML file to process.
         */
        function handleDispatchHtmlFile(file) {
            if (!file || !file.type.includes('html')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                dispatchSettings.htmlContent = event.target.result; // Update global state
                dispatchHtmlStatus.textContent = `Â∑≤‰∏äÂÇ≥Ê™îÊ°à: ${file.name}`;
                showMessage('HTML Ê™îÊ°àÂ∑≤‰∏äÂÇ≥ÔºÅ', 'success');
            };
            reader.readAsText(file);
        }


        // --- New: Recording Functions (Student Side) ---
        const startRecordingBtn = document.getElementById('start-recording-btn');
        const stopRecordingBtn = document.getElementById('stop-recording-btn');
        const playRecordingBtn = document.getElementById('play-recording-btn');
        const resetRecordingBtn = document.getElementById('reset-recording-btn');
        const submitRecordingBtn = document.getElementById('submit-recording-btn');
        const audioPreview = document.getElementById('audio-preview');
        const recordingStatusText = document.getElementById('recording-status-text');
        const recordingStatusIcon = document.getElementById('recording-status-icon');

        /**
         * Starts the audio recording process.
         */
        async function startRecording() {
            try {
                // Request access to microphone
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Try to use audio/wav first for better iOS compatibility.
                // Fallback to audio/webm if wav is not supported.
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/wav')) {
                    mimeType = 'audio/wav';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4'; // Another common format
                } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                    mimeType = 'audio/ogg';
                }

                mediaRecorder = new MediaRecorder(audioStream, { mimeType: mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType }); // Use the actual mimeType recorded
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        audioDataURL = reader.result;
                        audioPreview.src = audioDataURL;
                        audioPreview.classList.remove('hidden');
                        playRecordingBtn.disabled = false;
                        resetRecordingBtn.disabled = false;
                        submitRecordingBtn.disabled = false;
                        recordingStatusText.textContent = 'ÈåÑÈü≥ÂÆåÊàêÔºåÂèØË©¶ËÅΩÊàñÈÄÅÂá∫';
                        recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                        recordingStatusIcon.classList.add('text-green-500');
                    };
                    reader.readAsDataURL(audioBlob);

                    // Stop all tracks to release microphone
                    audioStream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                startRecordingBtn.disabled = true;
                stopRecordingBtn.disabled = false;
                playRecordingBtn.disabled = true;
                resetRecordingBtn.disabled = true;
                submitRecordingBtn.disabled = true;
                recordingStatusText.textContent = 'Ê≠£Âú®ÈåÑÈü≥...';
                recordingStatusIcon.classList.remove('text-gray-400');
                recordingStatusIcon.classList.add('fa-spin', 'text-red-500');
                showMessage('ÈñãÂßãÈåÑÈü≥', 'info');
            } catch (err) {
                console.error('ÁÑ°Ê≥ïÂèñÂæóÈ∫•ÂÖãÈ¢®Ê¨äÈôê:', err);
                showMessage('ÁÑ°Ê≥ïÂèñÂæóÈ∫•ÂÖãÈ¢®Ê¨äÈôêÔºåË´ãÊ™¢Êü•Ë®≠ÂÆö„ÄÇ', 'error');
                // Reset buttons if permission fails
                startRecordingBtn.disabled = false;
                stopRecordingBtn.disabled = true;
                playRecordingBtn.disabled = true;
                resetRecordingBtn.disabled = true;
                submitRecordingBtn.disabled = true;
                recordingStatusText.textContent = 'ÈåÑÈü≥Â§±Êïó';
                recordingStatusIcon.classList.remove('fa-spin', 'text-red-500');
                recordingStatusIcon.classList.add('text-gray-400');
            }
        }

        /**
         * Stops the audio recording.
         */
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                stopRecordingBtn.disabled = true;
            }
        }

        /**
         * Plays the recorded audio.
         */
        function playRecording() {
            if (audioPreview.src) {
                audioPreview.play();
                showMessage('Ê≠£Âú®Êí≠ÊîæÈåÑÈü≥', 'info');
            } else {
                showMessage('Ê≤íÊúâÂèØÊí≠ÊîæÁöÑÈåÑÈü≥', 'info');
            }
        }

        /**
         * Resets the recording state, allowing for a new recording.
         */
        function resetRecording() {
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            audioChunks = [];
            audioBlob = null;
            audioDataURL = null;
            audioPreview.src = '';
            audioPreview.classList.add('hidden');

            startRecordingBtn.disabled = false;
            stopRecordingBtn.disabled = true;
            playRecordingBtn.disabled = true;
            resetRecordingBtn.disabled = true;
            submitRecordingBtn.disabled = true;
            recordingStatusText.textContent = 'Ê∫ñÂÇôÈåÑÈü≥...';
            recordingStatusIcon.classList.remove('fa-spin', 'text-red-500', 'text-green-500');
            recordingStatusIcon.classList.add('text-gray-400');
            showMessage('ÈåÑÈü≥Â∑≤ÈáçÁΩÆ', 'info');
        }

        // --- End Recording Functions ---

        /**
         * (Teacher) Ends the entire class session, clears all student data and presence for the current classroom code.
         */
        async function endClassSession() {
            // ‰∫åÊ¨°Á¢∫Ë™çÊ©üÂà∂ÔºöÈò≤Ê≠¢Ë™§Êåâ‰∏ãË™≤ÊåâÈàï
            const confirmed = confirm(
                '‚ö†Ô∏è ÊÇ®Á¢∫ÂÆöË¶Å‰∏ãË™≤ÂóéÔºü\n\n' +
                '‰∏ãË™≤ÂæåÂ∞áÊúÉÔºö\n' +
                '‚Ä¢ Ê∏ÖÁ©∫ÊâÄÊúâÂ≠∏ÁîüÂõûÊáâË≥áÊñô\n' +
                '‚Ä¢ ÁµêÊùüÁï∂ÂâçÊïôÂÆ§\n' +
                '‚Ä¢ Â≠∏ÁîüÂ∞áÁÑ°Ê≥ïÁπºÁ∫å‰ΩúÁ≠î\n\n' +
                'Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºåË´ãÁ¢∫Ë™çÊòØÂê¶Ë¶ÅÁπºÁ∫åÔºü'
            );
            
            // Â¶ÇÊûúÁî®Êà∂ÈªûÊìäÂèñÊ∂àÔºåÂâá‰∏çÂü∑Ë°å‰∏ãË™≤Êìç‰Ωú
            if (!confirmed) {
                showMessage('Â∑≤ÂèñÊ∂à‰∏ãË™≤Êìç‰Ωú', 'info');
                return;
            }
            
            markClassEnded(); // Mark that class has been properly ended
            clearAllQuestionBanks(); // Clear question banks from memory
            showMessage('Ê≠£Âú®ÁµêÊùüË™≤Á®ã‰∏¶Ê∏ÖÁ©∫Ë≥áÊñô...', 'info');

            // üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager Áµ±‰∏ÄÊ∏ÖÁêÜÊâÄÊúâÁõ£ËÅΩÂô®
            ListenerManager.clearAll();
            
            // üöÄ CRITICAL: Ê∏ÖÁ©∫ÊâÄÊúâÂÖ®Â±ÄÁãÄÊÖãÔºàÈò≤Ê≠¢ÊÆòÁïôÊï∏ÊìöÔºâ
            interactionModeUnsubscribe = null;
            studentResponsesUnsubscribe = null;
            lotteryUnsubscribe = null;
            classroomPresenceUnsubscribe = null;

            try {
                // Delete the entire classroom subcollection for the current classroomCode
                if (classroomCode) {
                    console.log(`[Teacher] Starting cleanup for classroom: ${classroomCode}`);
                    
                    // üöÄ FIX: ÂàÜÂà•ÊçïÁç≤ÊØèÂÄãÂà™Èô§Êìç‰ΩúÁöÑÈåØË™§ÔºåÈÅøÂÖçÂñÆ‰∏ÄÂ§±ÊïóÂ∞éËá¥Êï¥ÂÄãÊµÅÁ®ã‰∏≠Êñ∑
                    try {
                        const classroomRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                        const responsesSnapshot = await getDocs(classroomRef);
                        console.log(`[Teacher] Deleting ${responsesSnapshot.docs.length} student responses...`);
                        for (const docSnap of responsesSnapshot.docs) {
                            await deleteDoc(docSnap.ref);
                        }
                        console.log('[Teacher] ‚úì Student responses deleted');
                    } catch (error) {
                        console.error('[Teacher] ‚úó Failed to delete student responses:', error);
                        // ÁπºÁ∫åÂü∑Ë°åÔºå‰∏ç‰∏≠Êñ∑
                    }

                    try {
                        const presenceRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
                        const presenceSnapshot = await getDocs(presenceRef);
                        console.log(`[Teacher] Deleting ${presenceSnapshot.docs.length} presence records...`);
                        for (const docSnap of presenceSnapshot.docs) {
                            await deleteDoc(docSnap.ref);
                        }
                        console.log('[Teacher] ‚úì Presence records deleted');
                    } catch (error) {
                        console.error('[Teacher] ‚úó Failed to delete presence records:', error);
                        // ÁπºÁ∫åÂü∑Ë°åÔºå‰∏ç‰∏≠Êñ∑
                    }

                    try {
                        const settingsDocRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                        console.log('[Teacher] Deleting control document...');
                        await deleteDoc(settingsDocRef);
                        console.log('[Teacher] ‚úì Control document deleted');
                    } catch (error) {
                        console.error('[Teacher] ‚úó Failed to delete control document:', error);
                        // ÁπºÁ∫åÂü∑Ë°åÔºå‰∏ç‰∏≠Êñ∑
                    }
                    
                    console.log(`[Teacher] ‚úì Cleanup completed for classroom: ${classroomCode}`);
                }
                
                classroomCode = null; // Clear the classroom code after ending session
                localStorage.removeItem('teacherClassroomCode'); // Clear from local storage

                // üöÄ CRITICAL: Ê∏ÖÁ©∫ÊâÄÊúâÂÖ®Â±ÄÁãÄÊÖãËÆäÈáè
                studentName = null;
                currentRole = null;
                currentInteractionMode = null;
                allStudentResponses = [];
                activeStudentNames = [];
                activeStudentsPresenceMap.clear(); // üöÄ FIX: Ê∏ÖÁ©∫Â≠∏ÁîüÂàÜÂøÉÁãÄÊÖã Map
                lastSelectedStudentCard = null;
                lastSelectedModalStudent = null;
                isResponsePaused = false;
                currentMultipleChoiceQuestions = null;
                readingComprehensionData = {text: '', questions: []}; // üöÄ NEW: Ê∏ÖÁ©∫Èñ±ËÆÄÊ∏¨È©óË≥áÊñô
                sequencingData = {question: '', correctOrder: []}; // üöÄ NEW: Ê∏ÖÁ©∫ÊéíÂ∫èÈ°åË≥áÊñô
                matchingData = {question: '', pairs: []}; // üöÄ NEW: Ê∏ÖÁ©∫ÈÖçÂ∞çÈ°åË≥áÊñô
                quickPollOptions = []; // üöÄ NEW: Ê∏ÖÁ©∫Âø´ÈÄüÊäïÁ•®ÈÅ∏È†Ö
                quickPollData = null; // üöÄ NEW: Ê∏ÖÁ©∫Âø´ÈÄüÊäïÁ•®Êï∏Êìö
                quickPollActive = false; // üöÄ NEW: ÈáçÁΩÆÂø´ÈÄüÊäïÁ•®ÁãÄÊÖã
                quickPollVotesUnsubscribe = null; // üöÄ NEW: Ê∏ÖÁ©∫Âø´ÈÄüÊäïÁ•®Áõ£ËÅΩÂô®

                document.getElementById('student-responses-container').innerHTML = '<p class="text-gray-500 text-center col-span-full">Ê≠£Âú®Á≠âÂæÖÂ≠∏Áîü‰ΩúÁ≠î...</p>';
                document.getElementById('active-student-count').textContent = '0';
                // üöÄ FIX: Ê∏ÖÁ©∫Âú®Á∑öÂ≠∏ÁîüÊ®°ÊÖãÊ°ÜÔºåÈÅøÂÖç‰∏ãÊ¨°ÈñãË™≤ÊôÇÁúãÂà∞ËàäÂ≠∏ÁîüÂêçÂñÆÔºà‰ΩøÁî®Áµ±‰∏ÄÁöÑÁ©∫ÁãÄÊÖãÊ®£ÂºèÔºâ
                document.getElementById('modal-student-names').innerHTML = `
                    <div class="empty-state-container w-full h-full min-h-[120px] flex flex-col items-center justify-center text-center py-8 sm:py-10">
                        <div class="w-14 h-14 sm:w-16 sm:h-16 mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-users text-gray-300 text-2xl sm:text-3xl"></i>
                        </div>
                        <span class="block text-gray-400 text-base sm:text-lg font-medium">Ê≤íÊúâÂ≠∏ÁîüÂú®Á∑ö</span>
                        <span class="block text-gray-300 text-sm sm:text-base mt-2">Á≠âÂæÖÂ≠∏ÁîüÂä†ÂÖ•Ë™≤Â†Ç...</span>
                    </div>
                `;
                // REMOVED: document.getElementById('responded-student-count').textContent = '0';
                document.getElementById('teacher-image-status').textContent = 'ÁõÆÂâçÊ≤íÊúâËÉåÊôØÂúñÁâá„ÄÇÂèØÈÅ∏ÊìáÊ™îÊ°àÊàñÁõ¥Êé•Ë≤º‰∏ä(Ctrl+V)„ÄÇ';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');

                // Clear URL/HTML dispatch settings and teacher background image when ending interaction
                clearDispatchSettings(); // Use the combined clear function
                teacherUploadedBackgroundImageDataURL = null;
                document.getElementById('teacher-image-status').textContent = 'ÁõÆÂâçÊ≤íÊúâËÉåÊôØÂúñÁâá„ÄÇÂèØÈÅ∏ÊìáÊ™îÊ°àÊàñÁõ¥Êé•Ë≤º‰∏ä(Ctrl+V)„ÄÇ';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');
                isResponsePaused = false; // NEW: Reset pause state
                updateTeacherPauseButtonUI(); // NEW: Update pause button UI

                await signOut(auth); // Explicitly sign out the user
                
                // NEW: After signing out, explicitly sign in again to get a fresh authenticated state
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Re-authenticated after ending session.");

                showView('entry'); // Show the entry view
                showMessage('Ë™≤Á®ãÂ∑≤ÁµêÊùüÔºåË≥áÊñôÂ∑≤Ê∏ÖÁ©∫„ÄÇ', 'success');

            } catch (error) {
                console.error("ÁµêÊùüË™≤Á®ã‰∏¶Ê∏ÖÁ©∫Ë≥áÊñôÂ§±Êïó:", error);
                showMessage("ÁµêÊùüË™≤Á®ãÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñËÅØÁπ´ÁÆ°ÁêÜÂì°„ÄÇ", "error");
            }
        }

        // NEW: Pause/Resume Response Logic
        const togglePauseBtn = document.getElementById('toggle-pause-btn');
        const togglePauseBtnText = document.getElementById('toggle-pause-btn-text');

        /**
         * Toggles the pause state for student responses in Firestore.
         */
        async function toggleResponsePause() {
            if (!classroomCode) {
                showMessage('Ë´ãÂÖàÈñãÂïü‰∏ÄÂÄãÊïôÂÆ§ÔºÅ', 'error');
                return;
            }
            const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
            try {
                isResponsePaused = !isResponsePaused; // Toggle local state
                await setDoc(controlRef, { isPaused: isResponsePaused }, { merge: true });
                showMessage(`Â≠∏ÁîüÂõûË¶ÜÂ∑≤${isResponsePaused ? 'Êö´ÂÅú' : 'ÊÅ¢Âæ©'}ÔºÅ`, 'info');
                updateTeacherPauseButtonUI();
            } catch (error) {
                console.error("ÂàáÊèõÊö´ÂÅúÂõûË¶ÜÁãÄÊÖãÂ§±Êïó:", error);
                showMessage("ÂàáÊèõÁãÄÊÖãÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ", "error");
                isResponsePaused = !isResponsePaused; // Revert local state on error
            }
        }

        /**
         * Updates the teacher's pause button UI based on the `isResponsePaused` state.
         */
        function updateTeacherPauseButtonUI() {
            if (isResponsePaused) {
                togglePauseBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                togglePauseBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                togglePauseBtnText.textContent = 'ÊÅ¢Âæ©ÂõûË¶Ü';
                togglePauseBtn.querySelector('i').classList.replace('fa-pause', 'fa-play');
            } else {
                togglePauseBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                togglePauseBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                togglePauseBtnText.textContent = 'Êö´ÂÅúÂõûË¶Ü';
                togglePauseBtn.querySelector('i').classList.replace('fa-play', 'fa-pause');
            }
        }

        /**
         * NEW: End current interaction and optionally clean up all settings.
         * @param {Object} options - Configuration options
         * @param {boolean} options.fullReset - If true, clears peer review, dispatch settings, etc. Default: true
         * @param {boolean} options.navigateToMenu - If true, navigates to teacher menu view. Default: true
         */
        async function endInteraction({ fullReset = true, navigateToMenu = true } = {}) {
            console.log(`[endInteraction] Called with fullReset=${fullReset}, navigateToMenu=${navigateToMenu}`);
            
            // üî• CRITICAL FIX: ÈáçÁΩÆÊê∂Á≠îÁãÄÊÖãÔºàÁÑ°Ë´ñ fullReset ÊòØÂê¶ÁÇ∫ÁúüÔºâ
            console.log('[endInteraction] üéØ FIX: Resetting quick answer state');
            quickAnswerWinner = null;
            quickAnswerWinnerDisplayed = false;
            quickAnswerActive = false;
            console.log('[endInteraction] ‚úì Quick answer state reset: winner=null, displayed=false, active=false');
            
            if (fullReset) {
                // Clear peer review data when ending interaction
                try {
                    const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                    await setDoc(peerReviewRef, { active: false });
                    
                    const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes');
                    const votesSnapshot = await getDocs(votesRef);
                    const deletePromises = votesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    
                    peerReviewActive = false;
                    document.getElementById('peer-review-stats-container').classList.add('hidden');
                    
                    const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> ÈñãÂßã‰∫íË©ï ‚ù§Ô∏è';
                    
                    allPeerReviewVotes = {};
                    studentVotedWorks.clear();
                    savedCanvasState = null;
                    
                    if (peerReviewUnsubscribe) {
                        peerReviewUnsubscribe();
                        peerReviewUnsubscribe = null;
                    }
                } catch (error) {
                    console.error('Error clearing peer review data:', error);
                }
            }
            
            // Set mode to waiting
            await setInteractionMode('waiting');
            lastSelectedStudentCard = null;
            
            if (fullReset) {
                // Clear sequencing and matching input fields
                document.getElementById('sequencing-items-textarea').value = '';
                document.getElementById('matching-pairs-textarea').value = '';
                
                // Clear URL/HTML settings and teacher background image
                clearDispatchSettings();
                teacherUploadedBackgroundImageDataURL = null;
                document.getElementById('teacher-image-status').textContent = 'ÁõÆÂâçÊ≤íÊúâËÉåÊôØÂúñÁâá„ÄÇÂèØÈÅ∏ÊìáÊ™îÊ°àÊàñÁõ¥Êé•Ë≤º‰∏ä(Ctrl+V)„ÄÇ';
                document.getElementById('teacher-image-preview').src = '';
                document.getElementById('teacher-image-preview-container').classList.add('hidden');
                isResponsePaused = false;
                updateTeacherPauseButtonUI();
                customMultipleChoiceQuestions = [];
                
                // üöÄ NEW: Clear teacher highlighter data when ending reading comprehension
                console.log('[endInteraction] Clearing teacher highlighter data');
                HighlighterManager.clearTeacherHighlights();
                lastViewedReadingContentHash = null;
            }
            
            if (navigateToMenu) {
                showView('teacherMenu');
                manualRefreshCounts();
            }
            
            console.log('[endInteraction] Completed');
        }

        /**
         * NEW: Reset all student answers to allow starting a new question without exiting the interaction mode.
         * Triggers student UI reset by updating the control document's resetTimestamp.
         */
        async function resetAllAnswers() {
            console.log('[resetAllAnswers] üîÑ CALLED - Starting reset process');
            
            if (!classroomCode) {
                console.log('[resetAllAnswers] ‚ùå No classroom code');
                showMessage('Ë´ãÂÖàÈñãÂïü‰∏ÄÂÄãÊïôÂÆ§ÔºÅ', 'error');
                return;
            }
            
            console.log('[resetAllAnswers] Classroom code:', classroomCode);
            
            // üöÄ NEW: Hide teacher answer display and clear content
            const teacherAnswerDisplay = document.getElementById('teacher-answer-display');
            const teacherAnswerContent = document.getElementById('teacher-answer-content');
            if (teacherAnswerDisplay) {
                teacherAnswerDisplay.classList.add('hidden');
            }
            if (teacherAnswerContent) {
                teacherAnswerContent.innerHTML = '';
            }
            
            try {
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                const controlDoc = await getDoc(controlRef);
                const currentMode = controlDoc.exists() ? controlDoc.data().active_mode : null;
                console.log('[resetAllAnswers] Current mode:', currentMode);
                
                // üéØ STEP 1: Ê∏ÖÈô§ÊâÄÊúâÂ≠∏ÁîüÁ≠îÊ°àÔºàÊâÄÊúâÊ®°ÂºèÈÉΩÈúÄË¶ÅÔºâ
                const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                const querySnapshot = await getDocs(studentsColRef);
                
                const updatePromises = [];
                querySnapshot.forEach((docSnapshot) => {
                    const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', docSnapshot.id);
                    updatePromises.push(
                        updateDoc(studentRef, {
                            answer: deleteField(),
                            interactionMode: deleteField(),
                            timestamp: deleteField()
                        })
                    );
                });
                
                if (updatePromises.length > 0) {
                    await Promise.all(updatePromises);
                }
                
                // üéØ STEP 2: Ê∏ÖÈô§Á≠îÊ°àÈ°ØÁ§∫Ê®ôË™åÔºàÊâÄÊúâÊ®°ÂºèÈÉΩÈúÄË¶ÅÔºâ
                await setDoc(controlRef, { 
                    resetTimestamp: new Date(),
                    showMatchingAnswer: false,
                    showSequencingAnswer: false
                }, { merge: true });
                
                // üöÄ OPTIMIZED: ÊâÄÊúâÊ®°ÂºèÈÉΩÂ¢ûÂä† modeResetTokenÔºåÈÄöÁü•Â≠∏ÁîüÁ´ØÈáçÊñ∞ÈñãÂßã
                console.log('[resetAllAnswers] Â¢ûÂä† modeResetToken ‰ª•ÈÄöÁü•Â≠∏ÁîüÁ´ØÈáçÊñ∞ÈñãÂßã');
                window.lastModeResetToken = (window.lastModeResetToken || 0) + 1;
                console.log('[resetAllAnswers] ‚úì Incremented modeResetToken to', window.lastModeResetToken);
                
                // üöÄ CRITICAL FIX: Ê∫ñÂÇô Firestore Êõ¥Êñ∞ËºâÈ´î
                const updatePayload = {
                    modeResetToken: window.lastModeResetToken
                };
                
                // üöÄ CRITICAL FIX: Â¶ÇÊûúÊòØËÆÄÈ°åÊ®°ÂºèÔºåÊõ¥Êñ∞ readingStartedAt ÊôÇÈñìÊà≥‰ª•ÈáçÊñ∞ÈñãÂßã180ÁßíÂÄíË®àÊôÇ
                if (currentMode === 'reading_comprehension') {
                    console.log('[resetAllAnswers] üéØ ËÆÄÈ°åÊ®°ÂºèÊ™¢Ê∏¨Âà∞ÔºöÊõ¥Êñ∞ readingStartedAt ‰ª•ÈáçÊñ∞ÈñãÂßã180ÁßíÂÄíË®àÊôÇ');
                    updatePayload.readingStartedAt = serverTimestamp();
                    console.log('[resetAllAnswers] ‚úì readingStartedAt Â∑≤Êõ¥Êñ∞ÁÇ∫Ôºö', new Date().toISOString());
                }
                
                // Êõ¥Êñ∞ Firestore ‰∏≠ÁöÑ modeResetToken Âíå readingStartedAtÔºàÂ¶ÇÊûúÈÅ©Áî®ÔºâÔºåÁ¢∫‰øùÂ≠∏ÁîüÁ´ØÊî∂Âà∞‰ø°Ëôü
                await setDoc(controlRef, updatePayload, { merge: true });
                console.log('[resetAllAnswers] ‚úì Firestore control ÊñáÊ™îÂ∑≤Êõ¥Êñ∞Ôºö', updatePayload);
                
                // ÁâπÊÆäËôïÁêÜÂø´ÈÄüÂõûÁ≠îÊ®°ÂºèÔºöÂÆåÊï¥ÈáçÂïü
                if (currentMode === 'quick_answer') {
                    console.log('[resetAllAnswers] üéØ Quick answer mode detected: starting auto-restart sequence');
                    // STEP 1: ËºïÈáèÁ¥öÁµêÊùü‰∫íÂãïÔºà‰∏çÊ∏ÖÈô§ËÉåÊôØÂúñÁâá„ÄÅÊ¥æÈÄÅË®≠ÂÆöÁ≠âÔºâ
                    console.log('[resetAllAnswers] STEP 1: Calling endInteraction() with lightweight options...');
                    await endInteraction({ fullReset: false, navigateToMenu: false });
                    console.log('[resetAllAnswers] STEP 1: ‚úì endInteraction() completed');
                    
                    // STEP 2: Áü≠Êö´Âª∂ÈÅ≤Á¢∫‰øùÁãÄÊÖãÂÆåÂÖ®Ê∏ÖÁêÜ
                    console.log('[resetAllAnswers] STEP 2: Waiting 300ms for cleanup...');
                    await new Promise(resolve => setTimeout(resolve, 300));
                    console.log('[resetAllAnswers] STEP 2: ‚úì Wait completed');
                    
                    // STEP 3: ÈáçÊñ∞ÈñãÂßãÊê∂Á≠îÊ®°Âºè
                    console.log('[resetAllAnswers] STEP 3: Calling setInteractionMode(quick_answer)...');
                    await setInteractionMode('quick_answer');
                    console.log('[resetAllAnswers] STEP 3: ‚úì setInteractionMode completed');
                    
                    showMessage(`‚úì Â∑≤ÈáçÊñ∞ÈñãÂßãÊê∂Á≠îÔºÅ`, 'success');
                    console.log('[resetAllAnswers] ‚úÖ Quick answer auto-restart completed successfully');
                    return;
                }
                
                // ÂÖ∂‰ªñÊ®°ÂºèÔºàÂåÖÊã¨reading_comprehensionÔºâÔºöÊ∏ÖÈô§Á≠îÊ°à‰∏¶È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                if (currentMode === 'reading_comprehension') {
                    showMessage(`‚úì Èñ±ËÆÄÊ∏¨È©óÂ∑≤ÈáçÊñ∞ÈñãÂßãÔºÅÂ≠∏ÁîüÂèØ‰ª•ÈáçÊñ∞‰ΩúÁ≠î„ÄÇ`, 'success');
                    console.log('[resetAllAnswers] ‚úÖ Reading comprehension reset completed - students can now reattempt');
                } else {
                    showMessage(`‚úì Â∑≤Ê∏ÖÈô§ÊâÄÊúâÂ≠∏ÁîüÁ≠îÊ°àÔºåÂèØ‰ª•ÈñãÂßã‰∏ã‰∏ÄÈ°åÔºÅ`, 'success');
                }
                
            } catch (error) {
                console.error("Ê∏ÖÈô§Â≠∏ÁîüÁ≠îÊ°àÂ§±Êïó:", error);
                console.error("ÈåØË™§Ë©≥ÊÉÖ - message:", error.message, "code:", error.code, "stack:", error.stack);
                showMessage(`Ê∏ÖÈô§Á≠îÊ°àÂ§±ÊïóÔºö${error.message || 'Êú™Áü•ÈåØË™§'}`, "error");
            }
        }


        // --- Event Listeners ---
        
        /**
         * NEW: Processes an image file (from upload or paste), resizes it, and applies it.
         * @param {File} file - The image file to process.
         * @param {boolean} isTeacher - True if the image is for the teacher's background.
         */
        function handleImageFile(file, isTeacher) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;

                    // Resize image if it's too large
                    if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                        if (width > height) {
                            height *= MAX_IMAGE_DIMENSION / width;
                            width = MAX_IMAGE_DIMENSION;
                        } else {
                            width *= MAX_IMAGE_DIMENSION / height;
                            height = MAX_IMAGE_DIMENSION;
                        }
                    }
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    const dataUrl = tempCanvas.toDataURL('image/jpeg', JPEG_QUALITY);

                    if (isTeacher) {
                        teacherUploadedBackgroundImageDataURL = dataUrl;
                        // For teacher image, we need to pass statusId, previewId, previewContainerId
                        // These are not directly available in handleImageFile without context.
                        // Let's assume these are passed as arguments or accessed globally.
                        // Re-evaluate how setupImageUpload calls this.
                        document.getElementById('teacher-image-status').textContent = 'Â∑≤‰∏äÂÇ≥ËÉåÊôØÂúñÁâá„ÄÇÂèØÈÅ∏ÊìáÊ™îÊ°àÊàñÁõ¥Êé•Ë≤º‰∏ä(Ctrl+V)„ÄÇ';
                        document.getElementById('teacher-image-preview').src = dataUrl;
                        document.getElementById('teacher-image-preview-container').classList.remove('hidden');
                        showMessage('ËÉåÊôØÂúñÁâáÂ∑≤‰∏äÂÇ≥ÔºÅ', 'success');
                    } else {
                        studentUploadedImageDataURL = dataUrl;
                        showMessage('ÂúñÁâáÂ∑≤‰∏äÂÇ≥ÔºÅ', 'success');
                        loadStudentImage();
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        /**
         * MODIFIED: Sets up image upload functionality for both file input and pasting.
         */
        const setupImageUpload = (inputId, statusId, previewContainerId, previewId, clearBtnId, isTeacher) => {
            const input = document.getElementById(inputId);
            const clearBtn = document.getElementById(clearBtnId);
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                e.target.value = ''; // Reset input to allow re-uploading the same file
                if (file) {
                    // Pass the IDs to handleImageFile for teacher-specific updates
                    if (isTeacher) {
                        handleImageFileForTeacher(file, statusId, previewContainerId, previewId);
                    } else {
                        handleImageFile(file, isTeacher);
                    }
                }
            });

            clearBtn.addEventListener('click', () => {
                if (isTeacher) {
                    teacherUploadedBackgroundImageDataURL = null;
                    document.getElementById(statusId).textContent = 'ÁõÆÂâçÊ≤íÊúâËÉåÊôØÂúñÁâá„ÄÇÂèØÈÅ∏ÊìáÊ™îÊ°àÊàñÁõ¥Êé•Ë≤º‰∏ä(Ctrl+V)„ÄÇ';
                    document.getElementById(previewId).src = '';
                    document.getElementById(previewContainerId).classList.add('hidden');
                    showMessage('ËÉåÊôØÂúñÁâáÂ∑≤Ê∏ÖÈô§ÔºÅ', 'info');
                } else {
                    studentUploadedImageDataURL = null;
                    studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                    showMessage('ÂúñÁâáÂ∑≤Ê∏ÖÈô§ÔºÅ', 'info');
                    drawCombinedCanvas();
                }
            });
        };

        // NEW: Separate function for teacher image handling to pass specific DOM IDs
        function handleImageFileForTeacher(file, statusId, previewContainerId, previewId) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;

                    // Resize image if it's too large
                    if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                        if (width > height) {
                            height *= MAX_IMAGE_DIMENSION / width;
                            width = MAX_IMAGE_DIMENSION;
                        } else {
                            width *= MAX_IMAGE_DIMENSION / height;
                            height = MAX_IMAGE_DIMENSION;
                        }
                    }
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    const dataUrl = tempCanvas.toDataURL('image/jpeg', JPEG_QUALITY);

                    teacherUploadedBackgroundImageDataURL = dataUrl;
                    document.getElementById(statusId).textContent = 'Â∑≤‰∏äÂÇ≥ËÉåÊôØÂúñÁâá„ÄÇÂèØÈÅ∏ÊìáÊ™îÊ°àÊàñÁõ¥Êé•Ë≤º‰∏ä(Ctrl+V)„ÄÇ';
                    document.getElementById(previewId).src = dataUrl;
                    document.getElementById(previewContainerId).classList.remove('hidden');
                    showMessage('ËÉåÊôØÂúñÁâáÂ∑≤‰∏äÂÇ≥ÔºÅ', 'success');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }


        function setupEventListeners() {
            // Entry screen.
            document.getElementById('teacher-entry-btn').addEventListener('click', () => {
                // Check if passwd=no parameter is present in URL
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('passwd') === 'no') {
                    showView('teacherClassroomCode');
                } else {
                    document.getElementById('teacher-password-modal').classList.remove('hidden');
                }
            });
            document.getElementById('student-entry-btn').addEventListener('click', () => {
                currentRole = 'student';
                showView('studentName');
            });
            
            // üöÄ NEW: Back button to return to role selection from student name input view
            document.getElementById('student-back-to-role-btn').addEventListener('click', () => {
                document.getElementById('student-classroom-code-input').value = '';
                document.getElementById('student-name-input').value = '';
                showView('entry');
                showMessage('Â∑≤ËøîÂõûËßíËâ≤ÈÅ∏Êìá', 'info');
                console.log('[Student] ‚úì Returned to role selection view');
            });

            // NEW: Teacher classroom code input.
            document.getElementById('teacher-classroom-code-back-btn').addEventListener('click', () => showView('entry'));
            document.getElementById('teacher-classroom-code-submit-btn').addEventListener('click', async () => {
                const code = document.getElementById('teacher-classroom-code-input').value.trim();
                if (code) {
                    try {
                        classroomCode = code;
                        currentRole = 'teacher';
                        document.getElementById('teacher-menu-code-value').textContent = classroomCode; // Update classroom code in teacher menu
                        document.getElementById('end-class-monitor-button-text').textContent = `‰∏ãË™≤ ÊïôÂÆ§‰ª£Á¢º: ${classroomCode}`; // Update button text for monitor view
                        localStorage.setItem('teacherClassroomCode', classroomCode); // Persist teacher's classroom code

                        // Set initial classroom state in Firestore, including isPaused: false
                        const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                        await setDoc(controlRef, { active_mode: 'waiting', teacherId: userId, backgroundImage: null, isPaused: false, multiple_choice_questions: null }, { merge: true }); 
                        isResponsePaused = false; // Initialize local state
                        updateTeacherPauseButtonUI(); // Update button UI
                        currentMultipleChoiceQuestions = null; // Ensure this is cleared on new class

                        listenToClassroomPresence(); // Ensure presence listener is active
                        showView('teacherMenu');
                        document.getElementById('teacher-classroom-code-input').value = ''; // Clear input
                    } catch (error) {
                        console.error('ÈÄ≤ÂÖ•ÊïôÂÆ§Â§±Êïó:', error);
                        showMessage(`ÈÄ≤ÂÖ•ÊïôÂÆ§Â§±ÊïóÔºö${error.message}`, 'error');
                    }
                } else {
                    showMessage('Ë´ãËº∏ÂÖ•ÊïôÂÆ§‰ª£Á¢ºÔºÅ', 'error');
                }
            });
            document.getElementById('teacher-classroom-code-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('teacher-classroom-code-submit-btn').click();
            });
            
            // üöÄ NEW: Parse URL parameters for quick classroom entry
            (function autoFillClassroomCodeFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const classroomParam = urlParams.get('classroom');
                if (classroomParam) {
                    document.getElementById('student-classroom-code-input').value = classroomParam;
                    console.log('[Student] ‚úÖ Ë™≤Â†ÇÁ¢ºÂ∑≤Âæû URL Ëá™ÂãïÂ°´ÂÖÖ:', classroomParam);
                }
            })();

            // Student name and classroom code submission.
            document.getElementById('submit-name-btn').addEventListener('click', async () => {
                const studentClassroomCode = document.getElementById('student-classroom-code-input').value.trim();
                const name = document.getElementById('student-name-input').value.trim();
                
                // üöÄ NEW: Remember student name for quick re-entry
                if (name) {
                    localStorage.setItem('lastStudentName', name);
                }

                if (!studentClassroomCode) {
                    showMessage('Ë´ãÂãôÂøÖËº∏ÂÖ•ÊïôÂÆ§‰ª£Á¢ºÔºÅ', 'error');
                    return;
                }
                if (!name) {
                    showMessage('Ë´ãÂãôÂøÖËº∏ÂÖ•ÂßìÂêçÔºÅ', 'error');
                    return;
                }

                classroomCode = studentClassroomCode; // Set global classroom code for student
                
                // Check if the classroom exists and is active
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                try {
                    const docSnap = await getDoc(controlRef);
                    if (docSnap.exists() && docSnap.data().teacherId) { // Check if control document exists and has a teacher ID
                        studentName = name;
                        
                        // üîÑ FIX: Clean up any old student records with the same name to prevent duplicates on reconnection
                        try {
                            // 1Ô∏è‚É£ Ê∏ÖÁêÜËàäÁöÑ studentResponses Ë®òÈåÑ
                            const oldStudentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                            const oldStudentSnap = await getDoc(oldStudentRef);
                            if (oldStudentSnap.exists()) {
                                await deleteDoc(oldStudentRef);
                                console.log(`[Student] Â∑≤Ê∏ÖÁêÜËàäÁöÑ studentResponses Ë®òÈåÑ: ${studentName}`);
                            }
                            
                            // 2Ô∏è‚É£ Ê∏ÖÁêÜËàäÁöÑ presence Ë®òÈåÑÔºàÂêåÂêç‰ΩÜ‰∏çÂêå userIdÔºâ
                            const presenceColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence');
                            const presenceQuery = query(presenceColRef);
                            const presenceSnap = await getDocs(presenceQuery);
                            
                            presenceSnap.forEach(async (presenceDoc) => {
                                const presenceData = presenceDoc.data();
                                // Â¶ÇÊûúÂêåÂêç‰ΩÜ userId ‰∏çÂêåÔºåÂà™Èô§ËàäÁöÑ presence Ë®òÈåÑ
                                if (presenceData.name === studentName && presenceDoc.id !== userId) {
                                    await deleteDoc(presenceDoc.ref);
                                    console.log(`[Student] Â∑≤Ê∏ÖÁêÜËàäÁöÑ presence Ë®òÈåÑ (Ëàä userId: ${presenceDoc.id}, Êñ∞ userId: ${userId})`);
                                }
                            });
                        } catch (error) {
                            console.warn(`[Student] Ê∏ÖÁêÜËàäË®òÈåÑÊôÇÂá∫ÈåØ:`, error);
                        }
                        
                        document.getElementById('user-id-display').textContent = `${userId} (${studentName})`;
                        document.getElementById('student-welcome-msg').textContent = `‰Ω†Â•ΩÔºå${studentName}ÔºÅ`;
                        listenToInteractionMode();
                        listenToPeerReviewStatus(); // NEW: Listen for peer review status
                        listenToLottery(); // <-- Âú®Ê≠§Êñ∞Â¢û
                        startStudentAttentionMonitoring(); // NEW: ÂïüÂãïÂ≠∏ÁîüÊ≥®ÊÑèÂäõÁõ£Êéß
                        showView('studentWaiting');
                        // üöÄ FIX: Set student presence with distraction monitoring fields
                        const presenceRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'presence', userId);
                        await setDoc(presenceRef, { 
                            name: studentName, 
                            timestamp: new Date(),
                            isDistracted: false,
                            distractionCount: 0
                        }, { merge: true });
                    } else {
                        showMessage('ÊïôÂÆ§‰ª£Á¢º‰∏çÂ≠òÂú®ÊàñËÄÅÂ∏´Â∞öÊú™ÈñãÂïüÊïôÂÆ§ÔºÅ', 'error');
                    }
                } catch (error) {
                    console.error("Ê™¢Êü•ÊïôÂÆ§‰ª£Á¢ºÂ§±Êïó:", error);
                    showMessage("ÈÄ≤ÂÖ•ÊïôÂÆ§Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÊïôÂÆ§‰ª£Á¢º„ÄÇ", "error");
                }
            });

            // Teacher mode selection.
            // MODIFIED: B button now opens a menu with Choice/Sequencing/Matching options
            document.getElementById('choice-sequencing-matching-menu-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.remove('hidden');
            });

            // Close B menu modal
            document.getElementById('choice-sequencing-matching-menu-close-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');
            });

            // Open Multiple Choice Settings from B menu
            document.getElementById('open-multiple-choice-settings-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');
                // Initialize modal state based on current customMultipleChoiceQuestions
                const mcQuestionTypeNone = document.querySelector('input[name="mcQuestionType"][value="none"]');
                const mcQuestionTypeCustom = document.querySelector('input[name="mcQuestionType"][value="custom"]');
                const customMcQuestionsSection = document.getElementById('custom-mc-questions-section');
                const customMcQuestionsTextarea = document.getElementById('custom-mc-questions-textarea');
                const customMcQuestionsStatus = document.getElementById('custom-mc-questions-status');

                if (customMultipleChoiceQuestions && customMultipleChoiceQuestions.length > 0) {
                    mcQuestionTypeCustom.checked = true;
                    customMcQuestionsSection.classList.remove('hidden');
                    document.getElementById('question-bank-management-section').classList.remove('hidden');
                    customMcQuestionsTextarea.value = customMultipleChoiceQuestions.map(q => {
                        return `${q.question},${q.correctAnswer},${q.options.join(',')}`;
                    }).join('\n');
                } else {
                    mcQuestionTypeNone.checked = true;
                    customMcQuestionsSection.classList.add('hidden');
                    document.getElementById('question-bank-management-section').classList.add('hidden');
                    customMcQuestionsTextarea.value = '';
                }
                customMcQuestionsStatus.classList.add('hidden');
                document.getElementById('multiple-choice-settings-modal').classList.remove('hidden');
            });

            // Open Sequencing Settings from B menu
            document.getElementById('open-sequencing-settings-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('sequencing-settings-modal').classList.remove('hidden');
            });

            // Open Matching Settings from B menu
            document.getElementById('open-matching-settings-btn').addEventListener('click', () => {
                document.getElementById('choice-sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('matching-settings-modal').classList.remove('hidden');
            });

            // Sequencing/Matching Menu Button - Keep for compatibility if needed elsewhere
            // Sequencing Settings Button (from menu)
            document.getElementById('sequencing-settings-btn')?.addEventListener('click', () => {
                document.getElementById('sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('sequencing-settings-modal').classList.remove('hidden');
            });

            // Matching Settings Button (from menu)
            document.getElementById('matching-settings-btn')?.addEventListener('click', () => {
                document.getElementById('sequencing-matching-menu-modal').classList.add('hidden');
                document.getElementById('matching-settings-modal').classList.remove('hidden');
            });

            // È°åÂûãÂàáÊèõÊåâÈàï
            document.getElementById('switch-to-matching-btn').addEventListener('click', () => {
                document.getElementById('sequencing-settings-modal').classList.add('hidden');
                document.getElementById('matching-settings-modal').classList.remove('hidden');
            });

            document.getElementById('switch-to-sequencing-btn').addEventListener('click', () => {
                document.getElementById('matching-settings-modal').classList.add('hidden');
                document.getElementById('sequencing-settings-modal').classList.remove('hidden');
            });

            // REMOVED: Old multiple-choice-settings-btn listener (now handled by open-multiple-choice-settings-btn from B menu)

            // Other teacher mode selection buttons (unchanged, directly set mode)
            document.querySelectorAll('#teacher-menu-view button[data-mode]').forEach(button => {
                button.addEventListener('click', async () => {
                    const mode = button.dataset.mode;
                    // MODIFIED: Check dispatch settings for url_dispatch
                    if (mode === 'url_dispatch') {
                        if (dispatchSettings.type === 'url' && !dispatchSettings.url) {
                            showMessage('Ë´ãÂÖàË®≠ÂÆöË¶ÅÊ¥æÈÄÅÁöÑÁ∂≤ÂùÄÔºÅ', 'error');
                            showUrlDispatchSettingsModal();
                            return;
                        } else if (dispatchSettings.type === 'html' && !dispatchSettings.htmlContent) {
                            showMessage('Ë´ãÂÖà‰∏äÂÇ≥Ë¶ÅÊ¥æÈÄÅÁöÑ HTML Ê™îÊ°àÔºÅ', 'error');
                            showUrlDispatchSettingsModal();
                            return;
                        }
                    }
                    showView('teacherMonitor');
                    await setInteractionMode(mode); // Set mode and handle student responses listener
                });
            });

            // End interaction button.
            document.getElementById('end-interaction-btn').addEventListener('click', async () => {
                await endInteraction(); // Use the new endInteraction function with default options (full reset)
            });
            
            // Student answer buttons for default multiple choice.
            document.querySelectorAll('#interaction-true-false .answer-btn, #default-mc-options .answer-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    // NEW: Check pause state before submitting
                    if (isResponsePaused) {
                        showMessage('ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶ÜÔºåÁÑ°Ê≥ïÈÄÅÂá∫Á≠îÊ°à„ÄÇ', 'error');
                        return;
                    }
                    // üéØ ‰øùÂ≠òÂºïÁî®ÔºàÂú® await ‰πãÂâçÔºâ
                    const answer = e.currentTarget.dataset.answer;
                    const answerText = e.currentTarget.textContent.trim();
                    const clickedButton = e.currentTarget;
                    const parentDiv = e.currentTarget.closest('div');
                    
                    try {
                        await submitAnswer(answer);
                        
                        // üéØ NEW: ÈéñÂÆöÊâÄÊúâÊåâÈàïÔºàÂåÖÊã¨Ë¢´ÈªûÊìäÁöÑÔºâ
                        if (parentDiv) {
                            parentDiv.querySelectorAll('.answer-btn').forEach(b => {
                                b.disabled = true;
                                b.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500', 'bg-yellow-500', 'bg-yellow-600', 'bg-green-600', 'bg-red-600');
                                b.classList.remove('hover:bg-green-600', 'hover:bg-red-600', 'hover:bg-blue-600', 'hover:bg-yellow-600', 'hover:bg-green-600', 'hover:bg-red-600');
                                b.classList.add('bg-gray-400');
                                // üéØ NEW: ÁÇ∫ÊâÄÊúâÊåâÈàïË®≠ÁΩÆÊèê‰∫§Ê®ôË®òÔºàÈò≤Ê≠¢ÊÅ¢Âæ©ÊôÇÈáçÊñ∞ÂïüÁî®Ôºâ
                                b.setAttribute('data-submitted', 'true');
                            });
                        }
                        
                        // üéØ IMPROVED: Âú®Ë¢´ÈªûÊìäÊåâÈàï‰∏äÊ∑ªÂä†Á¢∫Ë™çÂúñÊ®ôÔºà‰øùÁïôÂéüÂßãÁ≠îÊ°àÊñáÂ≠óÔºâ
                        const originalText = clickedButton.getAttribute('data-original-text') || answerText;
                        clickedButton.setAttribute('data-original-text', originalText);
                        clickedButton.innerHTML = `
                            <div class="flex flex-col items-center justify-center gap-1">
                                <span class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold">${answer}</span>
                                <span class="text-xs sm:text-sm flex items-center gap-1">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Â∑≤ÈÄÅÂá∫</span>
                                </span>
                            </div>
                        `;
                        
                        // üéØ NEW: È°ØÁ§∫Á¢∫Ë™çË®äÊÅØÔºàÈ°û‰ººÂø´ÈÄüÊäïÁ•®Ôºâ
                        showMessage(`‚úì Êèê‰∫§ÊàêÂäüÔºÅÊÇ®ÁöÑÁ≠îÊ°àÔºö${answerText}`, 'success');
                    } catch (error) {
                        console.error('[Answer Button] Submit failed:', error);
                        // submitAnswer Â∑≤Á∂ìÈ°ØÁ§∫‰∫ÜÈåØË™§Ë®äÊÅØÔºåÈÄôË£°‰∏çÈúÄË¶ÅÈáçË§á
                    }
                });
            });

            // Text input submission.
            document.getElementById('submit-text-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶ÜÔºåÁÑ°Ê≥ïÈÄÅÂá∫Á≠îÊ°à„ÄÇ', 'error');
                    return;
                }
                const text = document.getElementById('text-input-area').value.trim();
                if (!text) {
                    showMessage('Ë´ãËº∏ÂÖ•Á≠îÊ°àÂæåÂÜçÈÄÅÂá∫ÔºÅ', 'error');
                    return;
                }
                
                // üéØ ‰øùÂ≠òÂºïÁî®ÔºàÂú® await ‰πãÂâçÔºâ
                const submitBtn = e.currentTarget;
                const textArea = document.getElementById('text-input-area');
                
                try {
                    await submitAnswer(text);
                    
                    // üéØ NEW: ÈéñÂÆöÊåâÈàïÂíåÊñáÂ≠óÂçÄÂüü
                    submitBtn.disabled = true;
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-gray');
                    submitBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                    
                    if (textArea) {
                        textArea.disabled = true;
                    }
                    
                    // üéØ NEW: È°ØÁ§∫Á¢∫Ë™çË®äÊÅØ
                    const displayText = text.length > 50 ? text.substring(0, 50) + '...' : text;
                    showMessage(`‚úì Êèê‰∫§ÊàêÂäüÔºÅÊÇ®ÁöÑÁ≠îÊ°àÔºö${displayText}`, 'success');
                } catch (error) {
                    console.error('[Text Input] Submit failed:', error);
                    // submitAnswer Â∑≤Á∂ìÈ°ØÁ§∫‰∫ÜÈåØË™§Ë®äÊÅØÔºåÈÄôË£°‰∏çÈúÄË¶ÅÈáçË§á
                }
            });
            
            // Drawing submission.
            document.getElementById('submit-drawing-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶ÜÔºåÁÑ°Ê≥ïÈÄÅÂá∫Á≠îÊ°à„ÄÇ', 'error');
                    return;
                }
                
                // üéØ ‰øùÂ≠òÂºïÁî®ÔºàÂú® await ‰πãÂâçÔºâ
                const submitBtn = e.currentTarget;
                
                try {
                    const dataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
                    await submitAnswer(dataUrl);
                    
                    // üéØ NEW: ÈéñÂÆöÊåâÈàïÂíåÁï´Â∏É
                    submitBtn.disabled = true;
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-gray');
                    submitBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                    canvas.style.pointerEvents = 'none';
                    
                    // üéØ NEW: È°ØÁ§∫Á¢∫Ë™çË®äÊÅØ
                    showMessage('‚úì Áπ™ÂúñÂ∑≤ÈÄÅÂá∫ÔºÅ', 'success');
                } catch (error) {
                    console.error('[Drawing] Submit failed:', error);
                    // submitAnswer Â∑≤Á∂ìÈ°ØÁ§∫‰∫ÜÈåØË™§Ë®äÊÅØÔºåÈÄôË£°‰∏çÈúÄË¶ÅÈáçË§á
                }
            });

            // Sequencing submission.
            document.getElementById('submit-sequencing-btn').addEventListener('click', async (e) => {
                if (isResponsePaused) {
                    showMessage('ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶ÜÔºåÁÑ°Ê≥ïÈÄÅÂá∫Á≠îÊ°à„ÄÇ', 'error');
                    return;
                }
                const container = document.getElementById('sequencing-items-container');
                const items = Array.from(container.children).map(item => item.dataset.text);
                
                if (items.length === 0) {
                    showMessage('Ë´ãÂÖàÊéíÂ∫èÈ†ÖÁõÆÂæåÂÜçÈÄÅÂá∫ÔºÅ', 'error');
                    return;
                }
                
                // üéØ ‰øùÂ≠òÂºïÁî®ÔºàÂú® await ‰πãÂâçÔºâ
                const submitBtn = e.currentTarget;
                
                try {
                    await submitAnswer(JSON.stringify(items));
                    
                    // üéØ NEW: ÈéñÂÆöÊåâÈàïÂíåÁ¶ÅÁî®ÊãñÂãï
                    submitBtn.disabled = true;
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-gray');
                    submitBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                    container.style.pointerEvents = 'none';
                    
                    // üéØ NEW: È°ØÁ§∫Á¢∫Ë™çË®äÊÅØ
                    showMessage('‚úì ÊéíÂ∫èÂ∑≤ÈÄÅÂá∫ÔºÅ', 'success');
                } catch (error) {
                    console.error('[Sequencing] Submit failed:', error);
                    // submitAnswer Â∑≤Á∂ìÈ°ØÁ§∫‰∫ÜÈåØË™§Ë®äÊÅØÔºåÈÄôË£°‰∏çÈúÄË¶ÅÈáçË§á
                }
            });

            // Matching submission.
            document.getElementById('submit-matching-btn').addEventListener('click', async (e) => {
                if (isResponsePaused) {
                    showMessage('ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶ÜÔºåÁÑ°Ê≥ïÈÄÅÂá∫Á≠îÊ°à„ÄÇ', 'error');
                    return;
                }
                const matches = [];
                document.querySelectorAll('.matching-item.matched').forEach(item => {
                    if (item.dataset.side === 'left' && item.dataset.matchedWith) {
                        matches.push({
                            left: item.dataset.text,
                            right: item.dataset.matchedWith
                        });
                    }
                });

                if (matches.length === 0) {
                    showMessage('Ë´ãËá≥Â∞ëÂÆåÊàê‰∏ÄÂÄãÈÖçÂ∞çÔºÅ', 'error');
                    return;
                }

                // üéØ ‰øùÂ≠òÂºïÁî®ÔºàÂú® await ‰πãÂâçÔºâ
                const submitBtn = e.currentTarget;

                try {
                    await submitAnswer(JSON.stringify(matches));
                    
                    // üéØ NEW: ÈéñÂÆöÊåâÈàïÂíåÁ¶ÅÁî®ÈÖçÂ∞çÈ†ÖÁõÆ
                    submitBtn.disabled = true;
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-gray');
                    submitBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                    document.getElementById('matching-column-a').style.pointerEvents = 'none';
                    document.getElementById('matching-column-b').style.pointerEvents = 'none';
                    
                    // üéØ NEW: È°ØÁ§∫Á¢∫Ë™çË®äÊÅØ
                    showMessage(`‚úì ÈÖçÂ∞çÂ∑≤ÈÄÅÂá∫ÔºÅÂÆåÊàê ${matches.length} ÁµÑÈÖçÂ∞ç`, 'success');
                } catch (error) {
                    console.error('[Matching] Submit failed:', error);
                    // submitAnswer Â∑≤Á∂ìÈ°ØÁ§∫‰∫ÜÈåØË™§Ë®äÊÅØÔºåÈÄôË£°‰∏çÈúÄË¶ÅÈáçË§á
                }
            });

            // üöÄ OPTIMIZED: Drawing board events with throttled draw function
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', throttledDraw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', throttledDraw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            window.addEventListener('resize', () => {
                if (!views.studentInteraction.classList.contains('hidden') && !interactionUIs.drawing.classList.contains('hidden')) {
                    setupCanvas();
                    loadBackgroundImage();
                    loadStudentImage();
                }
                // üé® Redraw matching lines on window resize
                if (!views.studentInteraction.classList.contains('hidden') && !interactionUIs.matching.classList.contains('hidden')) {
                    redrawMatchingLines();
                }
            });

            // Drawing tool controls.
            const colorSelect = document.getElementById('color-select');
            const sizeSelect = document.getElementById('size-select');
            const penToolBtn = document.getElementById('pen-tool-btn');
            const eraserBtn = document.getElementById('eraser-btn');
            colorSelect.addEventListener('change', (e) => {
                drawingCtx.strokeStyle = e.target.value; 
                drawingCtx.globalCompositeOperation = 'source-over'; 
                updateColorSwatch(e.target.value); 
                penToolBtn.classList.add('border-blue-500'); 
                eraserBtn.classList.remove('border-blue-500');
            });
            sizeSelect.addEventListener('change', (e) => { drawingCtx.lineWidth = parseInt(e.target.value); });
            penToolBtn.addEventListener('click', () => {
                drawingCtx.globalCompositeOperation = 'source-over'; 
                drawingCtx.strokeStyle = colorSelect.value; 
                drawingCtx.lineWidth = parseInt(sizeSelect.value); 
                penToolBtn.classList.add('border-blue-500'); 
                eraserBtn.classList.remove('border-blue-500'); 
            });
            eraserBtn.addEventListener('click', () => {
                drawingCtx.globalCompositeOperation = 'destination-out';
                drawingCtx.lineWidth = 15;
                penToolBtn.classList.remove('border-blue-500'); 
                eraserBtn.classList.add('border-blue-500'); 
            });
            document.getElementById('clear-canvas-btn').addEventListener('click', clearDrawingCanvas);
            
            // Image upload handlers (teacher and student).
            setupImageUpload('teacher-image-upload-input', 'teacher-image-status', 'teacher-image-preview-container', 'teacher-image-preview', 'clear-teacher-background-btn', true);
            setupImageUpload('student-image-upload-input', null, null, null, 'clear-student-image-btn', false);

            // NEW: Paste event listener for teacher background image
            document.addEventListener('paste', e => {
                // Only allow pasting when the teacher menu is visible
                if (views.teacherMenu.classList.contains('hidden')) {
                    return;
                }
                
                // Don't interfere if the user is typing in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                const items = (e.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) {
                            // Call the specific teacher image handler
                            handleImageFileForTeacher(file, 'teacher-image-status', 'teacher-image-preview-container', 'teacher-image-preview');
                            e.preventDefault(); // Prevent the image from being pasted as a file object
                            return; // Exit after handling the first image
                        }
                    }
                }
            });

            // Modal close buttons.
            document.getElementById('student-status-area').addEventListener('click', showStudentListModal);
            studentListModalCloseBtn.addEventListener('click', hideStudentListModal);
            document.getElementById('show-statistics-btn').addEventListener('click', showStatisticsModal);
            
            // NEW: View Questions Button
            document.getElementById('view-questions-btn').addEventListener('click', showViewQuestionsModal);
            document.getElementById('view-questions-modal-close-btn').addEventListener('click', hideViewQuestionsModal);
            document.getElementById('cancel-questions-view-btn').addEventListener('click', hideViewQuestionsModal);
            document.getElementById('save-correct-answers-btn').addEventListener('click', saveCorrectAnswers);
            
            // NEW: Download Responses Button
            document.getElementById('download-responses-btn').addEventListener('click', downloadStudentResponses);
            
            // NEW: Show Answer Buttons for Matching and Sequencing
            document.getElementById('show-matching-answer-btn').addEventListener('click', async () => {
                try {
                    const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                    const docSnap = await getDoc(controlRef);
                    const matchingSettings = docSnap.data()?.matchingSettings;
                    
                    await setDoc(controlRef, { showMatchingAnswer: true }, { merge: true });
                    showMessage('Á≠îÊ°àÂ∑≤È°ØÁ§∫Áµ¶Â≠∏ÁîüÔºÅ', 'success');
                    
                    // üöÄ NEW: Display answer on teacher side too
                    if (matchingSettings) {
                        displayTeacherMatchingAnswer(matchingSettings);
                    }
                } catch (error) {
                    console.error('Error showing matching answer:', error);
                    showMessage('È°ØÁ§∫Á≠îÊ°àÂ§±ÊïóÔºÅ', 'error');
                }
            });
            
            document.getElementById('show-sequencing-answer-btn').addEventListener('click', async () => {
                try {
                    const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                    const docSnap = await getDoc(controlRef);
                    const sequencingSettings = docSnap.data()?.sequencingSettings;
                    
                    await setDoc(controlRef, { showSequencingAnswer: true }, { merge: true });
                    showMessage('Á≠îÊ°àÂ∑≤È°ØÁ§∫Áµ¶Â≠∏ÁîüÔºÅ', 'success');
                    
                    // üöÄ NEW: Display answer on teacher side too
                    if (sequencingSettings) {
                        displayTeacherSequencingAnswer(sequencingSettings);
                    }
                } catch (error) {
                    console.error('Error showing sequencing answer:', error);
                    showMessage('È°ØÁ§∫Á≠îÊ°àÂ§±ÊïóÔºÅ', 'error');
                }
            });
            
            // NEW: Start Peer Review Button
            document.getElementById('start-peer-review-btn').addEventListener('click', startPeerReview);
            
            // NEW: Exit Peer Review Button (Student)
            document.getElementById('exit-peer-review-btn').addEventListener('click', exitPeerReview);
            chartModalCloseBtn.addEventListener('click', hideStatisticsModal);
            document.getElementById('download-statistics-btn').addEventListener('click', downloadStatistics);
            magnifiedImageModalCloseBtn.addEventListener('click', hideMagnifiedDrawing);
            magnifiedImageModal.addEventListener('click', (e) => { if (e.target === magnifiedImageModal) hideMagnifiedDrawing(); });
            document.getElementById('close-message-btn').addEventListener('click', hideMessage);

            // NEW: Unsubmitted Students Modal Listeners
            document.getElementById('show-unsubmitted-students-btn').addEventListener('click', showUnsubmittedStudentsModal);
            unsubmittedStudentsModalCloseBtn.addEventListener('click', hideUnsubmittedStudentsModal);
            unsubmittedStudentsModal.addEventListener('click', (e) => { if (e.target === unsubmittedStudentsModal) hideUnsubmittedStudentsModal(); });

            // üöÄ NEW: QR Code Modal Listeners
            document.getElementById('show-qrcode-btn').addEventListener('click', showQRCodeModal);
            document.getElementById('show-qrcode-btn-menu').addEventListener('click', showQRCodeModal);
            
            // üöÄ NEW: Click on classroom code display to open QR code modal
            const classroomCodeDisplay = document.getElementById('teacher-menu-classroom-code-display');
            if (classroomCodeDisplay) {
                classroomCodeDisplay.addEventListener('click', () => {
                    console.log('[Classroom Code] üîë Opening QR Code modal from classroom code click');
                    showQRCodeModal();
                });
            }
            
            document.getElementById('close-qrcode-modal').addEventListener('click', closeQRCodeModal);
            document.getElementById('download-qrcode-btn').addEventListener('click', downloadQRCode);
            
            // üöÄ NEW: Copy classroom link to clipboard
            document.getElementById('copy-classroom-link-btn').addEventListener('click', async () => {
                if (!classroomCode) {
                    showMessage('Â∞öÊú™Ë®≠ÂÆöË™≤Â†Ç‰ª£Á¢º', 'error');
                    return;
                }
                
                const classroomUrl = `${window.location.origin}${window.location.pathname}?classroom=${classroomCode}`;
                try {
                    await navigator.clipboard.writeText(classroomUrl);
                    console.log('[Classroom Link] ‚úÖ Classroom link copied to clipboard:', classroomUrl);
                    showMessage(`‚úÖ Ë™≤Â†ÇÈÄ£ÁµêÂ∑≤Ë§áË£ΩÔºÅ\n${classroomUrl}`, 'success');
                } catch (error) {
                    console.error('[Classroom Link] ‚ùå Failed to copy link:', error);
                    // Fallback: Show the URL in an alert if clipboard API fails
                    alert(`Ë™≤Â†ÇÈÄ£ÁµêÔºö\n${classroomUrl}\n\nË´ãÊâãÂãïË§áË£Ω‰∏äÊñπÈÄ£Áµê`);
                    showMessage('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£ΩÈ°ØÁ§∫ÁöÑÈÄ£Áµê', 'error');
                }
            });
            
            document.getElementById('qrcode-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('qrcode-modal')) closeQRCodeModal(); });

            // Teacher utility buttons.
            document.getElementById('refresh-student-count-btn').addEventListener('click', manualRefreshCounts);
            // Original lottery button in monitor view
            document.getElementById('draw-lottery-btn').addEventListener('click', () => {
                // üöÄ FIX: ÊäΩÁ±§ÈÇèËºØÊîπËâØ - ÂÑ™ÂÖàÂæûÂ∑≤‰ΩúÁ≠îÂ≠∏Áîü‰∏≠ÊäΩÁ±§ÔºåËã•ÁÑ°ÂâáÂæûÊâÄÊúâÂú®Á∑öÂ≠∏Áîü‰∏≠ÊäΩÁ±§
                let selectedStudentName;
                let isFromResponses = false;
                
                // ÂòóË©¶ÂæûÂ∑≤‰ΩúÁ≠îÂ≠∏Áîü‰∏≠ÊäΩÁ±§
                if (allStudentResponses.length > 0) {
                    const randomIndex = Math.floor(Math.random() * allStudentResponses.length);
                    selectedStudentName = allStudentResponses[randomIndex].name;
                    isFromResponses = true;
                    console.log('[Lottery] Drawing from student responses:', selectedStudentName);
                } else if (activeStudentNames.length > 0) {
                    // Ëã•ÁÑ°‰ΩúÁ≠îÂ≠∏ÁîüÔºåÂæûÊâÄÊúâÂú®Á∑öÂ≠∏Áîü‰∏≠ÊäΩÁ±§ÔºàÈÅ©Áî®ÊñºÊê∂Á≠îÊ®°ÂºèÔºâ
                    const randomIndex = Math.floor(Math.random() * activeStudentNames.length);
                    selectedStudentName = activeStudentNames[randomIndex];
                    console.log('[Lottery] Drawing from online students:', selectedStudentName);
                } else {
                    return showMessage('ÁõÆÂâçÊ≤íÊúâÂ≠∏ÁîüÂú®Á∑öÂèØ‰æõÊäΩÁ±§„ÄÇ', 'info');
                }
                
                // Ê∏ÖÈô§‰∏äÊ¨°È´ò‰∫Æ
                if (lastSelectedStudentCard) lastSelectedStudentCard.classList.remove('selected-student-border');
                
                // ÂòóË©¶Âú®Â≠∏ÁîüÂç°Áâá‰∏≠ÊâæÂà∞‰∏¶È´ò‰∫Æ
                if (isFromResponses) {
                    const studentCards = document.querySelectorAll('#student-responses-container .student-response-item');
                    const foundCard = Array.from(studentCards).find(card => card.getAttribute('data-student-name') === selectedStudentName);
                    if (foundCard) {
                        foundCard.classList.add('selected-student-border');
                        lastSelectedStudentCard = foundCard;
                        foundCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                // È°ØÁ§∫ÊäΩÁ±§ÁµêÊûú‰∏¶ÈÄöÁü•Â≠∏Áîü
                showMessage(`üé≤ ÊÅ≠ÂñúÔºÅÊäΩ‰∏≠Â≠∏ÁîüÔºö${selectedStudentName}`, 'success');
                announceDrawnStudent(selectedStudentName);
            });
            // NEW: Lottery button inside the student list modal
            document.getElementById('modal-draw-lottery-btn').addEventListener('click', () => {
                if (activeStudentNames.length === 0) {
                    return showMessage('ÁõÆÂâçÊ≤íÊúâÂ≠∏ÁîüÂú®Á∑öÂèØ‰æõÊäΩÁ±§„ÄÇ', 'info');
                }

                // Remove highlight from previously selected student in the modal
                if (lastSelectedModalStudent) {
                    lastSelectedModalStudent.classList.remove('modal-selected-student-border');
                }

                // Randomly select a student from all active online students
                const randomIndex = Math.floor(Math.random() * activeStudentNames.length);
                const selectedStudentName = activeStudentNames[randomIndex];

                // üöÄ FIX: ‰ΩøÁî® [data-student-name] ÈÅ∏ÊìáÂô®Êü•ÊâæÂ≠∏ÁîüÂÖÉÁ¥†ÔºàÊîØÊè¥ div Êàñ p ÂÖÉÁ¥†Ôºâ
                const studentNameElements = document.querySelectorAll('#modal-student-names [data-student-name]');
                const foundElement = Array.from(studentNameElements).find(el => el.getAttribute('data-student-name') === selectedStudentName);

                if (foundElement) {
                    foundElement.classList.add('modal-selected-student-border');
                    lastSelectedModalStudent = foundElement; // Store the currently selected element
                    foundElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); // üöÄ FIX: ÊªæÂãïÂà∞ÈÅ∏‰∏≠ÁöÑÂ≠∏Áîü
                    showMessage(`ÊÅ≠ÂñúÔºÅÊäΩ‰∏≠Â≠∏ÁîüÔºö${selectedStudentName}`, 'success');
                    announceDrawnStudent(selectedStudentName); // <-- Âú®Ê≠§Êñ∞Â¢û
                } else {
                    console.warn('[Modal Lottery] Student element not found:', selectedStudentName);
                    showMessage(`ÊäΩ‰∏≠Â≠∏ÁîüÔºö${selectedStudentName} (Êú™Âú®ÂàóË°®‰∏≠ÊâæÂà∞)`, 'info');
                }
            });


            document.getElementById('download-media-btn').addEventListener('click', async (e) => { // Changed ID
                const btn = e.currentTarget;
                if (btn.disabled) return;
                
                let mediaResponses = [];
                let filenamePrefix = '';
                let fileExtension = '';

                if (currentInteractionMode === 'drawing') {
                    mediaResponses = allStudentResponses.filter(r => r.answer && r.answer.startsWith('data:image'));
                    filenamePrefix = 'Â≠∏ÁîüÁπ™ÂúñÁ≠îÊ°à';
                    fileExtension = 'jpg';
                } else if (currentInteractionMode === 'recording') {
                    mediaResponses = allStudentResponses.filter(r => r.answer && r.answer.startsWith('data:audio'));
                    filenamePrefix = 'Â≠∏ÁîüÈåÑÈü≥Á≠îÊ°à';
                    // Determine file extension based on the actual mimeType used for recording
                    const firstAudioResponse = mediaResponses.find(r => r.answer);
                    if (firstAudioResponse) {
                        const mime = firstAudioResponse.answer.split(',')[0].match(/:(.*?);/)?.[1];
                        if (mime) {
                            if (mime.includes('webm')) fileExtension = 'webm';
                            else if (mime.includes('mp4')) fileExtension = 'mp4';
                            else if (mime.includes('ogg')) fileExtension = 'ogg';
                            else if (mime.includes('wav')) fileExtension = 'wav';
                            else fileExtension = 'bin'; // Fallback for unknown
                        } else {
                            fileExtension = 'bin'; // Fallback if mime type not found in data URL
                        }
                    } else {
                        fileExtension = 'webm'; // Default if no audio responses
                    }
                } else {
                    return showMessage('ÁõÆÂâçÊ®°Âºè‰∏çÊîØÊè¥‰∏ãËºâÂ™íÈ´î„ÄÇ', 'info');
                }

                if (mediaResponses.length === 0) return showMessage(`ÁõÆÂâçÊ≤íÊúâ${filenamePrefix}ÂèØ‰æõ‰∏ãËºâ„ÄÇ`, 'info');
                
                btn.disabled = true;
                showMessage(`Ê≠£Âú®ÊâìÂåÖ${filenamePrefix}...`, 'info');
                const zip = new JSZip();
                const dataURLToBlob = (dataurl) => {
                    const [header, body] = dataurl.split(',');
                    const mime = header.match(/:(.*?);/)[1];
                    const bstr = atob(body);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    while(n--) u8arr[n] = bstr.charCodeAt(n);
                    return new Blob([u8arr], {type:mime});
                };
                
                mediaResponses.forEach(r => {
                    // Ensure unique filenames for students with same name but different recordings if needed
                    // For now, just use student name.
                    zip.file(`${r.name}.${fileExtension}`, dataURLToBlob(r.answer));
                });

                try {
                    const content = await zip.generateAsync({type:"blob"});
                    const filename = generateFilename(filenamePrefix, 'zip');
                    saveAs(content, filename);
                    showMessage(`Â∑≤ÊàêÂäüÊâìÂåÖ ${mediaResponses.length} ÂÄãÊ™îÊ°à‰∏¶ÈñãÂßã‰∏ãËºâ„ÄÇ`, 'success');
                } catch (error) {
                    console.error("ÊâìÂåÖÂ™íÈ´îÂ§±Êïó:", error);
                    showMessage("ÊâìÂåÖÂ™íÈ´îÂ§±ÊïóÔºåË´ãÊ™¢Êü•ÁÄèË¶ΩÂô®ÊîØÊè¥ÊàñÊ™îÊ°àÂ§ßÂ∞è„ÄÇ", "error");
                } finally {
                    btn.disabled = false;
                }
            });
            
            // AI-related buttons and modals.
            document.getElementById('ai-text-summary-btn').addEventListener('click', async () => {
                // üöÄ UX: Ê™¢Êü• API KEY ÊòØÂê¶Â∑≤Ë®≠ÂÆö
                if (!checkAPIKey()) return;
                
                const textResponses = allStudentResponses.filter(r => currentInteractionMode === 'text_input' && r.answer && r.answer.trim()).map(r => r.answer);
                if (textResponses.length === 0) return showMessage('ÁõÆÂâçÊ≤íÊúâÊñáÂ≠óÂõûÁ≠îÂèØ‰æõ AI ÂàÜÊûê„ÄÇ', 'info');
                const aiSummaryModal = document.getElementById('ai-summary-modal');
                const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
                const aiSummaryResultList = document.getElementById('ai-summary-result-list');
                aiSummaryModal.classList.remove('hidden');
                aiLoadingSpinner.classList.remove('hidden');
                aiSummaryResultList.innerHTML = '';
                const prompt = `Ë´ãÂàÜÊûê‰ª•‰∏ãÂ≠∏ÁîüÂõûÁ≠îÁöÑÊñáÊú¨ÂÖßÂÆπÔºåË≠òÂà•Âá∫Ë™ûÁæ©‰∏äÁõ∏‰ººÁöÑË©ûË™ûÊàñÁü≠Ë™ûÔºåÊ≠∏È°ûÁÇ∫‰∏ªË¶ÅË©ûÂΩô‰∏¶Áµ±Ë®àÁ∏ΩÂá∫ÁèæÊ¨°Êï∏„ÄÇÂàóÂá∫ÊúÄÂ∏∏Âá∫ÁèæÁöÑ10ÂÄã‰∏ªË¶ÅË©ûÂΩô„ÄÇË´ã‰ª•ÁπÅÈ´î‰∏≠ÊñáÂõûÊáâÔºåÊéíÈô§Â∏∏Ë¶ãÂä©Ë©û„ÄÅÈÄ£Êé•Ë©û„ÄÅÊ®ôÈªûÁ¨¶Ëôü„ÄÇ‰ΩøÁî®JSONÊ†ºÂºèËøîÂõûÁµêÊûúÔºö[{"word": "‰∏ªË¶ÅË©ûÂΩô1", "count": 10}]„ÄÇËã•ÁÑ°ÊúâÊÑèÁæ©Ë©ûÂΩôÔºåËøîÂõûÁ©∫Èô£Âàó[]„ÄÇÊñáÊú¨ÂÖßÂÆπÔºö\n${textResponses.join('\n\n')}`;
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "word": { "type": "STRING" }, "count": { "type": "NUMBER" } }, "propertyOrdering": ["word", "count"] } } }
                    };
                    const apiKey = (aiSettings.aiSource === 'gemini-custom' && aiSettings.geminiApiKey) ? aiSettings.geminiApiKey : "";
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`[AI ÊñáÂ≠óÂàÜÊûê] API ÈåØË™§ ${response.status}:`, errorBody);
                        if (response.status === 400) {
                            throw new Error('‚ùå API KEY ÁÑ°ÊïàÊàñÊ†ºÂºèÈåØË™§ÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑ Google AI Studio API Key Ë®≠ÂÆöÔºÅ');
                        }
                        throw new Error(`API request failed: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    aiLoadingSpinner.classList.add('hidden');
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsedResults = jsonText ? JSON.parse(jsonText) : [];
                    if (parsedResults.length > 0) {
                        parsedResults.sort((a, b) => b.count - a.count).forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.word} (${item.count}Ê¨°)`;
                            aiSummaryResultList.appendChild(li);
                        });
                    } else {
                        aiSummaryResultList.innerHTML = '<li>Ê≤íÊúâÊâæÂà∞Â∏∏Áî®Ë©ûÂΩô„ÄÇ</li>';
                    }
                } catch (error) {
                    console.error("AI ÊñáÂ≠óÂàÜÊûêÂ§±Êïó:", error);
                    aiLoadingSpinner.classList.add('hidden');
                    const errorMsg = error.message.includes('API KEY') ? error.message : 'AI ÂàÜÊûêÂ§±ÊïóÔºåË´ãÊ™¢Êü• API Key ÊàñÁ∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ';
                    aiSummaryResultList.innerHTML = `<li class="error-message">${errorMsg}</li>`;
                    showMessage(errorMsg, 'error');
                }
            });
            document.getElementById('ai-summary-modal-close-btn').addEventListener('click', () => document.getElementById('ai-summary-modal').classList.add('hidden'));
            document.getElementById('ai-settings-btn').addEventListener('click', showAISettingsModal);
            aiSettingsModalCloseBtn.addEventListener('click', hideAISettingsModal);
            saveAiSettingsBtn.addEventListener('click', saveAISettings);
            aiSourceSelect.addEventListener('change', (e) => geminiApiKeyGroup.classList.toggle('hidden', e.target.value !== 'gemini-custom'));

            // New: URL/HTML Dispatch Settings Modal listeners.
            document.getElementById('url-dispatch-settings-btn').addEventListener('click', showUrlDispatchSettingsModal);
            urlDispatchModalCloseBtn.addEventListener('click', hideUrlDispatchSettingsModal);
            document.getElementById('save-dispatch-settings-btn').addEventListener('click', saveDispatchSettings); // Renamed
            document.getElementById('clear-dispatch-settings-btn').addEventListener('click', clearDispatchSettings); // Renamed

            // Sequencing Settings Modal listeners
            document.getElementById('sequencing-settings-modal-close-btn').addEventListener('click', () => {
                document.getElementById('sequencing-settings-modal').classList.add('hidden');
            });
            document.getElementById('cancel-sequencing-settings-btn').addEventListener('click', () => {
                document.getElementById('sequencing-settings-modal').classList.add('hidden');
            });
            document.getElementById('start-sequencing-interaction-btn').addEventListener('click', async () => {
                const question = 'ÊéíÂ∫èÈ°å';
                const itemsText = document.getElementById('sequencing-items-textarea').value.trim();

                if (!itemsText) {
                    showMessage('Ë´ãËº∏ÂÖ•ÊéíÂ∫èÈ†ÖÁõÆÔºÅ', 'error');
                    return;
                }

                const items = itemsText.split('\n').map(item => item.trim()).filter(item => item);
                if (items.length < 2) {
                    showMessage('Ëá≥Â∞ëÈúÄË¶ÅÂÖ©ÂÄãÊéíÂ∫èÈ†ÖÁõÆÔºÅ', 'error');
                    return;
                }

                sequencingData.question = question;
                sequencingData.correctOrder = items;

                document.getElementById('sequencing-settings-modal').classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('sequencing', {
                    question: question,
                    correctOrder: items
                });
            });

            // Matching Settings Modal listeners
            document.getElementById('matching-settings-modal-close-btn').addEventListener('click', () => {
                document.getElementById('matching-settings-modal').classList.add('hidden');
            });
            document.getElementById('cancel-matching-settings-btn').addEventListener('click', () => {
                document.getElementById('matching-settings-modal').classList.add('hidden');
            });
            document.getElementById('start-matching-interaction-btn').addEventListener('click', async () => {
                const question = 'ÈÖçÂ∞çÈ°å';
                const pairsText = document.getElementById('matching-pairs-textarea').value.trim();

                if (!pairsText) {
                    showMessage('Ë´ãËº∏ÂÖ•ÈÖçÂ∞çÈ†ÖÁõÆÔºÅ', 'error');
                    return;
                }

                const lines = pairsText.split('\n').map(line => line.trim()).filter(line => line);
                const pairs = [];

                for (const line of lines) {
                    const parts = line.split(/[,\t]/).map(p => p.trim()).filter(p => p);
                    if (parts.length >= 2) {
                        pairs.push({ left: parts[0], right: parts[1] });
                    }
                }

                if (pairs.length < 2) {
                    showMessage('Ëá≥Â∞ëÈúÄË¶ÅÂÖ©Â∞çÈÖçÂ∞çÈ†ÖÁõÆÔºÅ', 'error');
                    return;
                }

                matchingData.question = question;
                matchingData.pairs = pairs;

                document.getElementById('matching-settings-modal').classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('matching', {
                    question: question,
                    pairs: pairs
                });
            });

            // Quick Poll Settings Modal listeners
            document.getElementById('quick-poll-settings-btn').addEventListener('click', showQuickPollSettingsModal);
            document.getElementById('quick-poll-settings-modal-close-btn').addEventListener('click', hideQuickPollSettingsModal);
            document.getElementById('cancel-quick-poll-settings-btn').addEventListener('click', hideQuickPollSettingsModal);
            document.getElementById('start-quick-poll-btn').addEventListener('click', startQuickPoll);

            // Quick Poll Stats Modal listeners
            document.getElementById('quick-poll-stats-modal-close-btn').addEventListener('click', hideQuickPollStatsModal);
            document.getElementById('end-quick-poll-btn').addEventListener('click', endQuickPoll);
            document.getElementById('download-poll-results-btn').addEventListener('click', downloadPollResults);
            document.getElementById('chart-type-bar-btn').addEventListener('click', () => switchChartType('bar'));
            document.getElementById('chart-type-pie-btn').addEventListener('click', () => switchChartType('pie'));

            // Poll type radio button listeners
            document.querySelectorAll('input[name="pollType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const customSection = document.getElementById('custom-poll-options-section');
                    customSection.classList.toggle('hidden', e.target.value !== 'custom');
                });
            });

            // NEW: Event listeners for dispatch type radio buttons
            dispatchTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const selectedType = e.target.value;
                    urlDispatchSection.classList.toggle('hidden', selectedType === 'html');
                    htmlDispatchSection.classList.toggle('hidden', selectedType === 'url');
                });
            });

            // NEW: HTML upload/clear listeners within the dispatch settings modal
            dispatchHtmlUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                e.target.value = ''; // Reset input
                if (file) {
                    handleDispatchHtmlFile(file);
                }
            });
            clearDispatchHtmlBtn.addEventListener('click', () => {
                dispatchSettings.htmlContent = null; // Clear content in global state
                dispatchHtmlUploadInput.value = ''; // Clear file input
                dispatchHtmlStatus.textContent = 'ÁõÆÂâçÊ≤íÊúâ HTML Ê™îÊ°à„ÄÇ';
                showMessage('HTML Ê™îÊ°àÂ∑≤Ê∏ÖÈô§ÔºÅ', 'info');
            });


            // New: Recording button event listeners
            startRecordingBtn.addEventListener('click', async () => {
                // NEW: Check pause state before starting recording
                if (isResponsePaused) {
                    showMessage('ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶ÜÔºåÁÑ°Ê≥ïÈñãÂßãÈåÑÈü≥„ÄÇ', 'error');
                    return;
                }
                startRecording();
            });
            stopRecordingBtn.addEventListener('click', stopRecording);
            playRecordingBtn.addEventListener('click', playRecording);
            resetRecordingBtn.addEventListener('click', resetRecording);
            submitRecordingBtn.addEventListener('click', async () => {
                // NEW: Check pause state before submitting recording
                if (isResponsePaused) {
                    showMessage('ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶ÜÔºåÁÑ°Ê≥ïÈÄÅÂá∫ÈåÑÈü≥„ÄÇ', 'error');
                    return;
                }
                if (!audioDataURL) {
                    showMessage('Ê≤íÊúâÈåÑÈü≥ÂèØÈÄÅÂá∫', 'error');
                    return;
                }
                
                try {
                    await submitAnswer(audioDataURL);
                    
                    // üéØ NEW: ÈéñÂÆöÊâÄÊúâÈåÑÈü≥Áõ∏ÈóúÊåâÈàï
                    submitRecordingBtn.disabled = true;
                    submitRecordingBtn.classList.remove('btn-primary');
                    submitRecordingBtn.classList.add('btn-gray');
                    submitRecordingBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                    startRecordingBtn.disabled = true;
                    stopRecordingBtn.disabled = true;
                    playRecordingBtn.disabled = true;
                    resetRecordingBtn.disabled = true;
                    recordingStatusText.textContent = 'Â∑≤ÈÄÅÂá∫ÈåÑÈü≥Á≠îÊ°à';
                    
                    // üéØ NEW: È°ØÁ§∫Á¢∫Ë™çË®äÊÅØ
                    showMessage('‚úì ÈåÑÈü≥Â∑≤ÈÄÅÂá∫ÔºÅ', 'success');
                } catch (error) {
                    console.error('[Recording] Submit failed:', error);
                    // submitAnswer Â∑≤Á∂ìÈ°ØÁ§∫‰∫ÜÈåØË™§Ë®äÊÅØÔºåÈÄôË£°‰∏çÈúÄË¶ÅÈáçË§á
                }
            });

            // NEW: Toggle Pause Button Event Listener
            togglePauseBtn.addEventListener('click', toggleResponsePause);

            // NEW: Reset Answers Button Event Listener
            const resetAnswersBtn = document.getElementById('reset-answers-btn');
            if (resetAnswersBtn) {
                resetAnswersBtn.addEventListener('click', () => {
                    console.log('üîÑ Reset button clicked!');
                    resetAllAnswers();
                });
                console.log('‚úì Reset answers button event listener attached');
            } else {
                console.error('‚ùå Reset answers button not found!');
            }

            // End Class Session Buttons.
            document.getElementById('end-class-session-menu-btn').addEventListener('click', endClassSession);
            document.getElementById('end-class-session-monitor-btn').addEventListener('click', endClassSession);

            // NEW: Multiple Choice Settings Modal Listeners
            const multipleChoiceSettingsModal = document.getElementById('multiple-choice-settings-modal');
            const multipleChoiceSettingsModalCloseBtn = document.getElementById('multiple-choice-settings-modal-close-btn');
            const mcQuestionTypeRadios = document.querySelectorAll('input[name="mcQuestionType"]');
            const customMcQuestionsSection = document.getElementById('custom-mc-questions-section');
            const customMcQuestionsTextarea = document.getElementById('custom-mc-questions-textarea');
            const customMcQuestionsStatus = document.getElementById('custom-mc-questions-status');
            const startMcInteractionBtn = document.getElementById('start-mc-interaction-btn');
            const cancelMcSettingsBtn = document.getElementById('cancel-mc-settings-btn');
            
            // AI Question Generation elements
            const aiGenerateMcBtn = document.getElementById('ai-generate-mc-btn');
            const aiMcTopicTextarea = document.getElementById('ai-mc-topic-textarea');
            const aiMcCountInput = document.getElementById('ai-mc-count-input');
            const aiMcLoadingSpinner = document.getElementById('ai-mc-loading-spinner');
            const aiMcBtnText = document.getElementById('ai-mc-btn-text');
            const aiMcBtnIcon = document.getElementById('ai-mc-btn-icon');

            // Question Bank Management elements
            const questionBankFileInput = document.getElementById('question-bank-file-input');
            const loadQuestionBankBtn = document.getElementById('load-question-bank-btn');
            const questionBankNameInput = document.getElementById('question-bank-name-input');
            const saveQuestionBankBtn = document.getElementById('save-question-bank-btn');
            const questionBankList = document.getElementById('question-bank-list');


            multipleChoiceSettingsModalCloseBtn.addEventListener('click', () => multipleChoiceSettingsModal.classList.add('hidden'));
            cancelMcSettingsBtn.addEventListener('click', () => multipleChoiceSettingsModal.classList.add('hidden'));

            // Question Bank Management Event Listeners
            loadQuestionBankBtn.addEventListener('click', loadQuestionBankFromFile);
            saveQuestionBankBtn.addEventListener('click', saveQuestionBankFromTextarea);

            // Teacher Password Modal Event Listeners
            const teacherPasswordModal = document.getElementById('teacher-password-modal');
            const teacherPasswordModalCloseBtn = document.getElementById('teacher-password-modal-close-btn');
            const teacherPasswordInput = document.getElementById('teacher-password-input');
            const teacherPasswordSubmitBtn = document.getElementById('teacher-password-submit-btn');
            const teacherPasswordCancelBtn = document.getElementById('teacher-password-cancel-btn');

            teacherPasswordModalCloseBtn.addEventListener('click', () => {
                teacherPasswordModal.classList.add('hidden');
                teacherPasswordInput.value = '';
            });
            teacherPasswordCancelBtn.addEventListener('click', () => {
                teacherPasswordModal.classList.add('hidden');
                teacherPasswordInput.value = '';
            });
            teacherPasswordSubmitBtn.addEventListener('click', () => {
                const password = teacherPasswordInput.value.trim();
                if (password === 'smessmes') {
                    teacherPasswordModal.classList.add('hidden');
                    teacherPasswordInput.value = '';
                    showView('teacherClassroomCode');
                } else {
                    showMessage('ÂØÜÁ¢ºÈåØË™§ÔºÅ', 'error');
                    teacherPasswordInput.value = '';
                    teacherPasswordInput.focus();
                }
            });
            teacherPasswordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    teacherPasswordSubmitBtn.click();
                }
            });

            mcQuestionTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isCustomMode = e.target.value === 'custom';
                    customMcQuestionsSection.classList.toggle('hidden', !isCustomMode);
                    document.getElementById('question-bank-management-section').classList.toggle('hidden', !isCustomMode);
                    customMcQuestionsStatus.classList.add('hidden'); // Hide status when changing radio
                });
            });

            startMcInteractionBtn.addEventListener('click', async () => {
                const selectedType = document.querySelector('input[name="mcQuestionType"]:checked').value;
                let questionsToDispatch = null;

                if (selectedType === 'custom') {
                    const parsedQuestions = parseCustomQuestions(customMcQuestionsTextarea.value);
                    if (!parsedQuestions) {
                        customMcQuestionsStatus.classList.remove('hidden');
                        return; // Stop if parsing failed
                    }
                    questionsToDispatch = parsedQuestions;
                    customMultipleChoiceQuestions = parsedQuestions; // Update global for teacher UI
                } else {
                    customMultipleChoiceQuestions = []; // Clear global if switching to none
                }
                
                customMcQuestionsStatus.classList.add('hidden'); // Hide status on successful dispatch
                multipleChoiceSettingsModal.classList.add('hidden');
                showView('teacherMonitor');
                await setInteractionMode('multiple_choice', { customQuestions: questionsToDispatch });
            });

            // AI Question Generation Button Listener
            aiGenerateMcBtn.addEventListener('click', async () => {
                // üöÄ UX: Ê™¢Êü• API KEY ÊòØÂê¶Â∑≤Ë®≠ÂÆö
                if (!checkAPIKey()) return;
                
                const topic = aiMcTopicTextarea.value.trim();
                const count = parseInt(aiMcCountInput.value);

                if (!topic) {
                    showMessage('Ë´ãËº∏ÂÖ•Âá∫È°å‰∏ªÈ°åÊàñË¶ÅÊ±ÇÔºÅ', 'error');
                    return;
                }
                if (!count || count < 1 || count > 10) {
                    showMessage('Âá∫È°åÊï∏ÈáèÂøÖÈ†à‰ªãÊñº 1 Âà∞ 10 ‰πãÈñìÔºÅ', 'error');
                    return;
                }
                
                // Show loading state
                aiGenerateMcBtn.disabled = true;
                aiMcBtnText.textContent = 'AI ÊÄùËÄÉ‰∏≠...';
                aiMcBtnIcon.classList.remove('fa-magic');
                aiMcBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiMcLoadingSpinner.classList.remove('hidden');

                const prompt = `Ë´ãÊ†πÊìö‰ª•‰∏ãË¶ÅÊ±ÇÔºåÁîüÊàê ${count} È°åÈÅ∏ÊìáÈ°å„ÄÇ
                Ë¶ÅÊ±ÇÔºö${topic}
                Ë´ãÂö¥Ê†ºÈÅµÂÆà‰ª•‰∏ãÊ†ºÂºèÔºåÊØèÈ°å‰∏ÄË°åÔºå‰∏¶Áî®ÈÄóËôüÂàÜÈöîÊØèÂÄãÊ¨Ñ‰ΩçÔºö
                È°åÁõÆ,Ê≠£Á¢∫Á≠îÊ°à(1-4),ÈÅ∏È†Ö1,ÈÅ∏È†Ö2,ÈÅ∏È†Ö3,ÈÅ∏È†Ö4
                Ë´ãÂãøÂåÖÂê´È°åËôü„ÄÅ‰ªª‰ΩïÂ§öÈ§òÁöÑË™™ÊòéÊñáÂ≠óÊàñÁ®ãÂºèÁ¢ºÂçÄÂ°äÊ®ôË®ò„ÄÇ`;

                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 } // Adjust temperature for creativity
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`[AI ÈÅ∏ÊìáÈ°åÁîüÊàê] API ÈåØË™§ ${response.status}:`, errorBody);
                        
                        // üöÄ IMPROVED: ÈáùÂ∞ç‰∏çÂêåÈåØË™§Á¢ºÊèê‰æõÂÖ∑È´îËß£Ê±∫ÊñπÊ°à
                        let errorMessage = '';
                        
                        try {
                            const errorJson = JSON.parse(errorBody);
                            const apiErrorMsg = errorJson.error?.message || '';
                            
                            if (response.status === 429) {
                                // ÈÖçÈ°çË∂ÖÈôêÈåØË™§
                                errorMessage = '‚ö†Ô∏è API ‰ΩøÁî®ÈÖçÈ°çÂ∑≤Áî®ÂÆåÔºÅ\n\n' +
                                             'ÂèØËÉΩÂéüÂõ†Ôºö\n' +
                                             '1Ô∏è‚É£ ÂÖçË≤ªÁâà API ÊúâÊØèÂàÜÈêòË´ãÊ±ÇÊ¨°Êï∏ÈôêÂà∂\n' +
                                             '2Ô∏è‚É£ Áü≠ÊôÇÈñìÂÖßË´ãÊ±ÇÈÅéÂ§öÊ¨°\n\n' +
                                             'Âª∫Ë≠∞Ëß£Ê±∫ÊñπÊ°àÔºö\n' +
                                             '‚úÖ Ë´ãÁ≠âÂæÖ 1-2 ÂàÜÈêòÂæåÂÜçË©¶\n' +
                                             '‚úÖ ÊàñÂâçÂæÄ Google AI Studio Êü•ÁúãÈÖçÈ°çÔºö\n' +
                                             '   https://aistudio.google.com/apikey\n' +
                                             '‚úÖ ËÄÉÊÖÆÂçáÁ¥öÁÇ∫‰ªòË≤ªÊñπÊ°à‰ª•Áç≤ÂæóÊõ¥È´òÈÖçÈ°ç';
                            } else if (response.status === 400) {
                                // API KEY ÁÑ°ÊïàÊàñË´ãÊ±ÇÊ†ºÂºèÈåØË™§
                                if (apiErrorMsg.toLowerCase().includes('api key')) {
                                    errorMessage = '‚ùå API KEY ÁÑ°ÊïàÊàñÊ†ºÂºèÈåØË™§ÔºÅ\n\n' +
                                                 'Ë´ãÊ™¢Êü•Ôºö\n' +
                                                 '1Ô∏è‚É£ ÊòØÂê¶Ê≠£Á¢∫Ë§áË£ΩÂÆåÊï¥ÁöÑ API Key\n' +
                                                 '2Ô∏è‚É£ API Key ÊòØÂê¶Â∑≤ÂïüÁî® Gemini API\n' +
                                                 '3Ô∏è‚É£ ÂâçÂæÄ Google AI Studio ÈáçÊñ∞Á¢∫Ë™çÔºö\n' +
                                                 '   https://aistudio.google.com/apikey';
                                } else {
                                    errorMessage = '‚ùå Ë´ãÊ±ÇÊ†ºÂºèÈåØË™§ÔºÅ\n\n' + apiErrorMsg;
                                }
                            } else if (response.status === 401 || response.status === 403) {
                                // Ë™çË≠âÂ§±ÊïóÊàñÊ¨äÈôê‰∏çË∂≥
                                errorMessage = 'üîí API Ë™çË≠âÂ§±ÊïóÔºÅ\n\n' +
                                             'Ë´ãÊ™¢Êü•Ôºö\n' +
                                             '1Ô∏è‚É£ API Key ÊòØÂê¶ÈÅéÊúü\n' +
                                             '2Ô∏è‚É£ API Key ÊòØÂê¶ÊúâÊ≠£Á¢∫ÁöÑÊ¨äÈôê\n' +
                                             '3Ô∏è‚É£ ÂâçÂæÄ Google AI Studio ÈáçÊñ∞ÁîüÊàêÔºö\n' +
                                             '   https://aistudio.google.com/apikey';
                            } else if (response.status === 503) {
                                // ÊúçÂãôÊö´ÊôÇ‰∏çÂèØÁî®
                                errorMessage = '‚ö†Ô∏è Google AI ÊúçÂãôÊö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®ÔºÅ\n\n' +
                                             'Âª∫Ë≠∞ÔºöË´ãÁ®çÂæåÂÜçË©¶ÔºàÈÄöÂ∏∏ÂπæÂàÜÈêòÂÖßÊúÉÊÅ¢Âæ©Ôºâ';
                            } else {
                                // ÂÖ∂‰ªñÈåØË™§
                                errorMessage = `‚ùå API Ë´ãÊ±ÇÂ§±Êïó (ÈåØË™§Á¢º ${response.status})\n\n` +
                                             `Ë©≥Á¥∞Ë≥áË®äÔºö${apiErrorMsg || 'Êú™Áü•ÈåØË™§'}`;
                            }
                        } catch (parseError) {
                            // ÁÑ°Ê≥ïËß£Êûê JSONÔºå‰ΩøÁî®ÈÄöÁî®ÈåØË™§Ë®äÊÅØ
                            errorMessage = `‚ùå API Ë´ãÊ±ÇÂ§±Êïó (ÈåØË™§Á¢º ${response.status})\n\n` +
                                         `Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÁ®çÂæåÂÜçË©¶`;
                        }
                        
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (generatedText) {
                        // Append to existing content, adding a newline if needed
                        const existingText = customMcQuestionsTextarea.value.trim();
                        customMcQuestionsTextarea.value = existingText ? `${existingText}\n${generatedText.trim()}` : generatedText.trim();
                        showMessage('AI È°åÁõÆÂ∑≤ÊàêÂäüÁîüÊàê‰∏¶Â°´ÂÖ•Â∑¶ÊñπÔºÅ', 'success');
                    } else {
                        throw new Error('AI Êú™ËøîÂõûÊúâÊïàÂÖßÂÆπ„ÄÇ');
                    }

                } catch (error) {
                    console.error("AI ÈÅ∏ÊìáÈ°åÁîüÊàêÂ§±Êïó:", error);
                    // üöÄ IMPROVED: Áõ¥Êé•È°ØÁ§∫Ë©≥Á¥∞ÁöÑÈåØË™§Ë®äÊÅØ
                    showMessage(error.message || 'AI È°åÁõÆÁîüÊàêÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
                } finally {
                    // Hide loading state
                    aiGenerateMcBtn.disabled = false;
                    aiMcBtnText.textContent = 'AI ÈñãÂßãÂá∫È°å';
                    aiMcBtnIcon.classList.add('fa-magic');
                    aiMcBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiMcLoadingSpinner.classList.add('hidden');
                }
            });

            // AI Sequencing Question Generation Button Listener
            const aiGenerateSeqBtn = document.getElementById('ai-generate-seq-btn');
            const aiSeqTopicTextarea = document.getElementById('ai-seq-topic-textarea');
            const aiSeqCountInput = document.getElementById('ai-seq-count-input');
            const aiSeqBtnText = document.getElementById('ai-seq-btn-text');
            const aiSeqBtnIcon = document.getElementById('ai-seq-btn-icon');
            const aiSeqLoadingSpinner = document.getElementById('ai-seq-loading-spinner');

            aiGenerateSeqBtn.addEventListener('click', async () => {
                // üöÄ UX: Ê™¢Êü• API KEY ÊòØÂê¶Â∑≤Ë®≠ÂÆö
                if (!checkAPIKey()) return;
                
                const topic = aiSeqTopicTextarea.value.trim();
                const count = parseInt(aiSeqCountInput.value);

                if (!topic) {
                    showMessage('Ë´ãËº∏ÂÖ•Âá∫È°å‰∏ªÈ°åÊàñË¶ÅÊ±ÇÔºÅ', 'error');
                    return;
                }
                if (!count || count < 3 || count > 10) {
                    showMessage('È†ÖÁõÆÊï∏ÈáèÂøÖÈ†à‰ªãÊñº 3 Âà∞ 10 ‰πãÈñìÔºÅ', 'error');
                    return;
                }

                // Show loading state
                aiGenerateSeqBtn.disabled = true;
                aiSeqBtnText.textContent = 'AI ÊÄùËÄÉ‰∏≠...';
                aiSeqBtnIcon.classList.remove('fa-magic');
                aiSeqBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiSeqLoadingSpinner.classList.remove('hidden');

                const prompt = `Ë´ãÊ†πÊìö‰ª•‰∏ã‰∏ªÈ°åÔºåÁîüÊàê ${count} ÂÄãÊéíÂ∫èÈ†ÖÁõÆ„ÄÇ
‰∏ªÈ°åÔºö${topic}
Ë´ãÊåâÊ≠£Á¢∫È†ÜÂ∫èÂàóÂá∫ÔºåÊØèÂÄãÈ†ÖÁõÆ‰∏ÄË°åÔºå‰∏çË¶ÅÊúâÈ°åËôüÊàñ‰ªª‰ΩïÊ®ôË®ò„ÄÇ
Âè™ÈúÄÊèê‰æõÈ†ÖÁõÆÂÖßÂÆπÔºå‰∏çË¶ÅÂåÖÂê´Ë™™ÊòéÊñáÂ≠óÊàñÁ®ãÂºèÁ¢ºÂçÄÂ°äÊ®ôË®ò„ÄÇ`;

                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 }
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`[AI ÊéíÂ∫èÈ°åÁîüÊàê] API ÈåØË™§ ${response.status}:`, errorBody);
                        
                        // üöÄ IMPROVED: ÈáùÂ∞ç‰∏çÂêåÈåØË™§Á¢ºÊèê‰æõÂÖ∑È´îËß£Ê±∫ÊñπÊ°à
                        let errorMessage = '';
                        
                        try {
                            const errorJson = JSON.parse(errorBody);
                            const apiErrorMsg = errorJson.error?.message || '';
                            
                            if (response.status === 429) {
                                errorMessage = '‚ö†Ô∏è API ‰ΩøÁî®ÈÖçÈ°çÂ∑≤Áî®ÂÆåÔºÅ\n\n' +
                                             'ÂèØËÉΩÂéüÂõ†Ôºö\n' +
                                             '1Ô∏è‚É£ ÂÖçË≤ªÁâà API ÊúâÊØèÂàÜÈêòË´ãÊ±ÇÊ¨°Êï∏ÈôêÂà∂\n' +
                                             '2Ô∏è‚É£ Áü≠ÊôÇÈñìÂÖßË´ãÊ±ÇÈÅéÂ§öÊ¨°\n\n' +
                                             'Âª∫Ë≠∞Ëß£Ê±∫ÊñπÊ°àÔºö\n' +
                                             '‚úÖ Ë´ãÁ≠âÂæÖ 1-2 ÂàÜÈêòÂæåÂÜçË©¶\n' +
                                             '‚úÖ ÊàñÂâçÂæÄ Google AI Studio Êü•ÁúãÈÖçÈ°çÔºö\n' +
                                             '   https://aistudio.google.com/apikey\n' +
                                             '‚úÖ ËÄÉÊÖÆÂçáÁ¥öÁÇ∫‰ªòË≤ªÊñπÊ°à‰ª•Áç≤ÂæóÊõ¥È´òÈÖçÈ°ç';
                            } else if (response.status === 400) {
                                if (apiErrorMsg.toLowerCase().includes('api key')) {
                                    errorMessage = '‚ùå API KEY ÁÑ°ÊïàÊàñÊ†ºÂºèÈåØË™§ÔºÅ\n\n' +
                                                 'Ë´ãÊ™¢Êü•Ôºö\n' +
                                                 '1Ô∏è‚É£ ÊòØÂê¶Ê≠£Á¢∫Ë§áË£ΩÂÆåÊï¥ÁöÑ API Key\n' +
                                                 '2Ô∏è‚É£ API Key ÊòØÂê¶Â∑≤ÂïüÁî® Gemini API\n' +
                                                 '3Ô∏è‚É£ ÂâçÂæÄ Google AI Studio ÈáçÊñ∞Á¢∫Ë™çÔºö\n' +
                                                 '   https://aistudio.google.com/apikey';
                                } else {
                                    errorMessage = '‚ùå Ë´ãÊ±ÇÊ†ºÂºèÈåØË™§ÔºÅ\n\n' + apiErrorMsg;
                                }
                            } else if (response.status === 401 || response.status === 403) {
                                errorMessage = 'üîí API Ë™çË≠âÂ§±ÊïóÔºÅ\n\n' +
                                             'Ë´ãÊ™¢Êü•Ôºö\n' +
                                             '1Ô∏è‚É£ API Key ÊòØÂê¶ÈÅéÊúü\n' +
                                             '2Ô∏è‚É£ API Key ÊòØÂê¶ÊúâÊ≠£Á¢∫ÁöÑÊ¨äÈôê\n' +
                                             '3Ô∏è‚É£ ÂâçÂæÄ Google AI Studio ÈáçÊñ∞ÁîüÊàêÔºö\n' +
                                             '   https://aistudio.google.com/apikey';
                            } else if (response.status === 503) {
                                errorMessage = '‚ö†Ô∏è Google AI ÊúçÂãôÊö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®ÔºÅ\n\n' +
                                             'Âª∫Ë≠∞ÔºöË´ãÁ®çÂæåÂÜçË©¶ÔºàÈÄöÂ∏∏ÂπæÂàÜÈêòÂÖßÊúÉÊÅ¢Âæ©Ôºâ';
                            } else {
                                errorMessage = `‚ùå API Ë´ãÊ±ÇÂ§±Êïó (ÈåØË™§Á¢º ${response.status})\n\n` +
                                             `Ë©≥Á¥∞Ë≥áË®äÔºö${apiErrorMsg || 'Êú™Áü•ÈåØË™§'}`;
                            }
                        } catch (parseError) {
                            errorMessage = `‚ùå API Ë´ãÊ±ÇÂ§±Êïó (ÈåØË™§Á¢º ${response.status})\n\n` +
                                         `Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÁ®çÂæåÂÜçË©¶`;
                        }
                        
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (generatedText) {
                        const sequencingItemsTextarea = document.getElementById('sequencing-items-textarea');
                        sequencingItemsTextarea.value = generatedText.trim();
                        showMessage('AI ÊéíÂ∫èÈ°åÂ∑≤ÊàêÂäüÁîüÊàê‰∏¶Â°´ÂÖ•ÔºÅ', 'success');
                    } else {
                        throw new Error('AI Êú™ËøîÂõûÊúâÊïàÂÖßÂÆπ„ÄÇ');
                    }

                } catch (error) {
                    console.error("AI ÊéíÂ∫èÈ°åÁîüÊàêÂ§±Êïó:", error);
                    // üöÄ IMPROVED: Áõ¥Êé•È°ØÁ§∫Ë©≥Á¥∞ÁöÑÈåØË™§Ë®äÊÅØ
                    showMessage(error.message || 'AI ÊéíÂ∫èÈ°åÁîüÊàêÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
                } finally {
                    // Hide loading state
                    aiGenerateSeqBtn.disabled = false;
                    aiSeqBtnText.textContent = 'AI ÈñãÂßãÂá∫È°å';
                    aiSeqBtnIcon.classList.add('fa-magic');
                    aiSeqBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiSeqLoadingSpinner.classList.add('hidden');
                }
            });

            // AI Matching Question Generation Button Listener
            const aiGenerateMatchBtn = document.getElementById('ai-generate-match-btn');
            const aiMatchTopicTextarea = document.getElementById('ai-match-topic-textarea');
            const aiMatchCountInput = document.getElementById('ai-match-count-input');
            const aiMatchBtnText = document.getElementById('ai-match-btn-text');
            const aiMatchBtnIcon = document.getElementById('ai-match-btn-icon');
            const aiMatchLoadingSpinner = document.getElementById('ai-match-loading-spinner');

            aiGenerateMatchBtn.addEventListener('click', async () => {
                // üöÄ UX: Ê™¢Êü• API KEY ÊòØÂê¶Â∑≤Ë®≠ÂÆö
                if (!checkAPIKey()) return;
                
                const topic = aiMatchTopicTextarea.value.trim();
                const count = parseInt(aiMatchCountInput.value);

                if (!topic) {
                    showMessage('Ë´ãËº∏ÂÖ•Âá∫È°å‰∏ªÈ°åÊàñË¶ÅÊ±ÇÔºÅ', 'error');
                    return;
                }
                if (!count || count < 3 || count > 10) {
                    showMessage('ÈÖçÂ∞çÊï∏ÈáèÂøÖÈ†à‰ªãÊñº 3 Âà∞ 10 ‰πãÈñìÔºÅ', 'error');
                    return;
                }

                // Show loading state
                aiGenerateMatchBtn.disabled = true;
                aiMatchBtnText.textContent = 'AI ÊÄùËÄÉ‰∏≠...';
                aiMatchBtnIcon.classList.remove('fa-magic');
                aiMatchBtnIcon.classList.add('fa-spinner', 'fa-spin');
                aiMatchLoadingSpinner.classList.remove('hidden');

                const prompt = `Ë´ãÊ†πÊìö‰ª•‰∏ã‰∏ªÈ°åÔºåÁîüÊàê ${count} ÁµÑÈÖçÂ∞çÈ°å„ÄÇ
‰∏ªÈ°åÔºö${topic}
ÊØèË°åÊ†ºÂºèÔºöÂ∑¶ÂÅ¥È†ÖÁõÆ,Âè≥ÂÅ¥È†ÖÁõÆ
‰∏çË¶ÅÊúâÈ°åËôü„ÄÅË™™ÊòéÊñáÂ≠óÊàñÁ®ãÂºèÁ¢ºÂçÄÂ°äÊ®ôË®ò„ÄÇ
Áõ¥Êé•Êèê‰æõÈÖçÂ∞çÂÖßÂÆπÔºåÊØèË°å‰∏ÄÁµÑ„ÄÇ`;

                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7 }
                    };
                    const apiKey = aiSettings.geminiApiKey;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`[AI ÈÖçÂ∞çÈ°åÁîüÊàê] API ÈåØË™§ ${response.status}:`, errorBody);
                        
                        // üöÄ IMPROVED: ÈáùÂ∞ç‰∏çÂêåÈåØË™§Á¢ºÊèê‰æõÂÖ∑È´îËß£Ê±∫ÊñπÊ°à
                        let errorMessage = '';
                        
                        try {
                            const errorJson = JSON.parse(errorBody);
                            const apiErrorMsg = errorJson.error?.message || '';
                            
                            if (response.status === 429) {
                                errorMessage = '‚ö†Ô∏è API ‰ΩøÁî®ÈÖçÈ°çÂ∑≤Áî®ÂÆåÔºÅ\n\n' +
                                             'ÂèØËÉΩÂéüÂõ†Ôºö\n' +
                                             '1Ô∏è‚É£ ÂÖçË≤ªÁâà API ÊúâÊØèÂàÜÈêòË´ãÊ±ÇÊ¨°Êï∏ÈôêÂà∂\n' +
                                             '2Ô∏è‚É£ Áü≠ÊôÇÈñìÂÖßË´ãÊ±ÇÈÅéÂ§öÊ¨°\n\n' +
                                             'Âª∫Ë≠∞Ëß£Ê±∫ÊñπÊ°àÔºö\n' +
                                             '‚úÖ Ë´ãÁ≠âÂæÖ 1-2 ÂàÜÈêòÂæåÂÜçË©¶\n' +
                                             '‚úÖ ÊàñÂâçÂæÄ Google AI Studio Êü•ÁúãÈÖçÈ°çÔºö\n' +
                                             '   https://aistudio.google.com/apikey\n' +
                                             '‚úÖ ËÄÉÊÖÆÂçáÁ¥öÁÇ∫‰ªòË≤ªÊñπÊ°à‰ª•Áç≤ÂæóÊõ¥È´òÈÖçÈ°ç';
                            } else if (response.status === 400) {
                                if (apiErrorMsg.toLowerCase().includes('api key')) {
                                    errorMessage = '‚ùå API KEY ÁÑ°ÊïàÊàñÊ†ºÂºèÈåØË™§ÔºÅ\n\n' +
                                                 'Ë´ãÊ™¢Êü•Ôºö\n' +
                                                 '1Ô∏è‚É£ ÊòØÂê¶Ê≠£Á¢∫Ë§áË£ΩÂÆåÊï¥ÁöÑ API Key\n' +
                                                 '2Ô∏è‚É£ API Key ÊòØÂê¶Â∑≤ÂïüÁî® Gemini API\n' +
                                                 '3Ô∏è‚É£ ÂâçÂæÄ Google AI Studio ÈáçÊñ∞Á¢∫Ë™çÔºö\n' +
                                                 '   https://aistudio.google.com/apikey';
                                } else {
                                    errorMessage = '‚ùå Ë´ãÊ±ÇÊ†ºÂºèÈåØË™§ÔºÅ\n\n' + apiErrorMsg;
                                }
                            } else if (response.status === 401 || response.status === 403) {
                                errorMessage = 'üîí API Ë™çË≠âÂ§±ÊïóÔºÅ\n\n' +
                                             'Ë´ãÊ™¢Êü•Ôºö\n' +
                                             '1Ô∏è‚É£ API Key ÊòØÂê¶ÈÅéÊúü\n' +
                                             '2Ô∏è‚É£ API Key ÊòØÂê¶ÊúâÊ≠£Á¢∫ÁöÑÊ¨äÈôê\n' +
                                             '3Ô∏è‚É£ ÂâçÂæÄ Google AI Studio ÈáçÊñ∞ÁîüÊàêÔºö\n' +
                                             '   https://aistudio.google.com/apikey';
                            } else if (response.status === 503) {
                                errorMessage = '‚ö†Ô∏è Google AI ÊúçÂãôÊö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®ÔºÅ\n\n' +
                                             'Âª∫Ë≠∞ÔºöË´ãÁ®çÂæåÂÜçË©¶ÔºàÈÄöÂ∏∏ÂπæÂàÜÈêòÂÖßÊúÉÊÅ¢Âæ©Ôºâ';
                            } else {
                                errorMessage = `‚ùå API Ë´ãÊ±ÇÂ§±Êïó (ÈåØË™§Á¢º ${response.status})\n\n` +
                                             `Ë©≥Á¥∞Ë≥áË®äÔºö${apiErrorMsg || 'Êú™Áü•ÈåØË™§'}`;
                            }
                        } catch (parseError) {
                            errorMessage = `‚ùå API Ë´ãÊ±ÇÂ§±Êïó (ÈåØË™§Á¢º ${response.status})\n\n` +
                                         `Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÁ®çÂæåÂÜçË©¶`;
                        }
                        
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (generatedText) {
                        const matchingPairsTextarea = document.getElementById('matching-pairs-textarea');
                        matchingPairsTextarea.value = generatedText.trim();
                        showMessage('AI ÈÖçÂ∞çÈ°åÂ∑≤ÊàêÂäüÁîüÊàê‰∏¶Â°´ÂÖ•ÔºÅ', 'success');
                    } else {
                        throw new Error('AI Êú™ËøîÂõûÊúâÊïàÂÖßÂÆπ„ÄÇ');
                    }

                } catch (error) {
                    console.error("AI ÈÖçÂ∞çÈ°åÁîüÊàêÂ§±Êïó:", error);
                    // üöÄ IMPROVED: Áõ¥Êé•È°ØÁ§∫Ë©≥Á¥∞ÁöÑÈåØË™§Ë®äÊÅØ
                    showMessage(error.message || 'AI ÈÖçÂ∞çÈ°åÁîüÊàêÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
                } finally {
                    // Hide loading state
                    aiGenerateMatchBtn.disabled = false;
                    aiMatchBtnText.textContent = 'AI ÈñãÂßãÂá∫È°å';
                    aiMatchBtnIcon.classList.add('fa-magic');
                    aiMatchBtnIcon.classList.remove('fa-spinner', 'fa-spin');
                    aiMatchLoadingSpinner.classList.add('hidden');
                }
            });

            // Sequencing Question Bank Management Listeners
            document.getElementById('load-seq-bank-btn').addEventListener('click', loadSequencingBankFromFile);
            document.getElementById('save-seq-bank-btn').addEventListener('click', saveSequencingBank);

            // Matching Question Bank Management Listeners
            document.getElementById('load-match-bank-btn').addEventListener('click', loadMatchingBankFromFile);
            document.getElementById('save-match-bank-btn').addEventListener('click', saveMatchingBank);

            // Reading Comprehension Listeners
            document.getElementById('reading-comprehension-settings-btn')?.addEventListener('click', showReadingComprehensionModal);
            document.getElementById('reading-comprehension-settings-modal-close-btn')?.addEventListener('click', hideReadingComprehensionModal);
            document.getElementById('cancel-reading-settings-btn')?.addEventListener('click', hideReadingComprehensionModal);
            document.getElementById('start-reading-interaction-btn')?.addEventListener('click', startReadingComprehension);
            document.getElementById('submit-reading-btn')?.addEventListener('click', submitReadingAnswer);
            document.getElementById('ai-generate-reading-btn')?.addEventListener('click', generatePIRLSQuestions);
            document.getElementById('load-reading-files-btn')?.addEventListener('click', loadReadingFiles);
            document.getElementById('save-reading-question-bank-btn')?.addEventListener('click', saveReadingQuestionBank);
            
            // üöÄ NEW: Initialize reading scroll-to-top button
            initReadingScrollToTop();

            // View Reading Questions Modal Listeners
            document.getElementById('view-reading-questions-btn')?.addEventListener('click', showViewReadingQuestionsModal);
            document.getElementById('view-reading-questions-modal-close-btn')?.addEventListener('click', hideViewReadingQuestionsModal);
            document.getElementById('close-reading-questions-view-btn')?.addEventListener('click', hideViewReadingQuestionsModal);

            // üöÄ NEW: Edit Reading Answer Modal Listeners
            document.getElementById('edit-reading-answer-modal-close-btn')?.addEventListener('click', hideEditAnswerDialog);
            document.getElementById('cancel-edit-answer-btn')?.addEventListener('click', hideEditAnswerDialog);
            document.getElementById('confirm-edit-answer-btn')?.addEventListener('click', confirmEditAnswer);

            // üöÄ NEW: Rescore All Students Button Listener
            document.getElementById('rescore-all-students-btn')?.addEventListener('click', rescoreAllStudents);

            // NEW: Student side custom multiple choice submission
            document.getElementById('submit-custom-mc-btn').addEventListener('click', async (e) => {
                // NEW: Check pause state before submitting
                if (isResponsePaused) {
                    showMessage('ËÄÅÂ∏´Â∑≤Êö´ÂÅúÂõûË¶ÜÔºåÁÑ°Ê≥ïÈÄÅÂá∫Á≠îÊ°à„ÄÇ', 'error');
                    return;
                }

                // NEW: Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊèê‰∫§ÈÅéÁ≠îÊ°à
                const hasSubmitted = await checkIfStudentSubmitted();
                if (hasSubmitted) {
                    showMessage('ÊÇ®Â∑≤Á∂ìÊèê‰∫§ÈÅéÁ≠îÊ°àÔºåÁÑ°Ê≥ïÈáçË§áÊèê‰∫§„ÄÇ', 'error');
                    return;
                }

                const studentAnswers = [];
                const questionContainers = document.querySelectorAll('#custom-mc-questions-container .mc-question-item');
                let allAnswered = true;

                questionContainers.forEach((qContainer, index) => {
                    const selectedOption = qContainer.querySelector(`input[name="question-${index}"]:checked`);
                    if (selectedOption) {
                        studentAnswers.push({ qIndex: index, ans: selectedOption.value });
                    } else {
                        allAnswered = false;
                    }
                });

                if (!allAnswered) {
                    showMessage('Ë´ãÂõûÁ≠îÊâÄÊúâÈ°åÁõÆÔºÅ', 'error');
                    return;
                }

                // üéØ ‰øùÂ≠òÂºïÁî®ÔºàÂú® await ‰πãÂâçÔºâ
                const submitBtn = e.currentTarget;

                try {
                    await submitAnswer(studentAnswers);
                    
                    // üéØ NEW: Êõ¥Êñ∞UIÈ°ØÁ§∫Â∑≤Êèê‰∫§ÁãÄÊÖã
                    submitBtn.disabled = true;
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-gray');
                    submitBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                    
                    // Disable all radio buttons after submission
                    document.querySelectorAll('#custom-mc-questions-container input[type="radio"]').forEach(radio => {
                        radio.disabled = true;
                    });
                    
                    // üéØ NEW: È°ØÁ§∫Á¢∫Ë™çË®äÊÅØ
                    showMessage(`‚úì Êèê‰∫§ÊàêÂäüÔºÅÂ∑≤ÂÆåÊàê ${studentAnswers.length} È°å`, 'success');
                } catch (error) {
                    console.error('[Custom MC] Submit failed:', error);
                    // submitAnswer Â∑≤Á∂ìÈ°ØÁ§∫‰∫ÜÈåØË™§Ë®äÊÅØÔºåÈÄôË£°‰∏çÈúÄË¶ÅÈáçË§á
                }
            });
        }

        /**
         * NEW: Parses custom multiple choice questions from a textarea string.
         * Expected format per line: Question,CorrectAnswer(1-4/A-D),Option1,Option2,Option3,Option4
         * @param {string} rawText - The raw string from the textarea.
         * @returns {Array|null} An array of question objects, or null if parsing fails.
         */
        function parseCustomQuestions(rawText) {
            const lines = rawText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const questions = [];

            for (const line of lines) {
                // Try splitting by comma first, then by tab if comma yields too few parts
                let parts = line.split(',');
                if (parts.length < 6) {
                    parts = line.split('\t');
                }

                if (parts.length !== 6) {
                    console.error("Invalid line format:", line);
                    return null; // Invalid format
                }

                const questionText = parts[0].trim();
                let correctAnswer = parts[1].trim().toUpperCase();
                const options = parts.slice(2, 6).map(opt => opt.trim());

                // Normalize correct answer to 1, 2, 3, 4
                if (correctAnswer === 'A') correctAnswer = '1';
                else if (correctAnswer === 'B') correctAnswer = '2';
                else if (correctAnswer === 'C') correctAnswer = '3';
                else if (correctAnswer === 'D') correctAnswer = '4';

                if (!['1', '2', '3', '4'].includes(correctAnswer)) {
                    console.error("Invalid correct answer format:", correctAnswer);
                    return null; // Invalid correct answer
                }

                if (questionText === '' || options.some(opt => opt === '')) {
                    console.error("Empty question or option:", line);
                    return null; // Empty question or option
                }

                questions.push({
                    questionText: questionText,
                    correctAnswer: correctAnswer,
                    options: options
                });
            }

            if (questions.length === 0) {
                return null; // No valid questions parsed
            }

            return questions;
        }

        /**
         * NEW: Renders custom multiple choice questions on the student side.
         * @param {Array} questions - An array of question objects.
         */
        async function renderMultipleChoiceQuestions(questions) {
            const defaultMcOptions = document.getElementById('default-mc-options');
            const customMcQuestionsContainer = document.getElementById('custom-mc-questions-container');
            const submitCustomMcBtn = document.getElementById('submit-custom-mc-btn');
            const interactionMultipleChoice = document.getElementById('interaction-multiple-choice');

            if (questions && questions.length > 0) {
                defaultMcOptions.classList.add('hidden');
                customMcQuestionsContainer.classList.remove('hidden');
                submitCustomMcBtn.classList.remove('hidden');
                customMcQuestionsContainer.innerHTML = ''; // Clear previous questions
                interactionMultipleChoice.classList.remove('enlarged-buttons'); // Remove enlarged class for custom questions

                // NEW: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Á∂ìÊèê‰∫§ÈÅéÁ≠îÊ°à
                const hasSubmitted = await checkIfStudentSubmitted();
                
                questions.forEach((q, qIndex) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'mc-question-item bg-white p-4 rounded-lg shadow-md';
                    questionDiv.innerHTML = `
                        <p class="font-bold text-lg mb-3 text-gray-800">Q${qIndex + 1}. ${q.questionText}</p>
                        <div class="space-y-2">
                            ${q.options.map((option, optIndex) => `
                                <label class="flex items-center p-2 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-50 transition-colors">
                                    <input type="radio" name="question-${qIndex}" value="${optIndex + 1}" class="form-radio text-blue-600 h-5 w-5" ${hasSubmitted ? 'disabled' : ''}>
                                    <span class="ml-3 text-gray-700">${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                    customMcQuestionsContainer.appendChild(questionDiv);
                });

                // NEW: Â¶ÇÊûúÂ∑≤Êèê‰∫§ÔºåÊõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
                if (hasSubmitted) {
                    submitCustomMcBtn.disabled = true;
                    submitCustomMcBtn.classList.replace('btn-primary', 'btn-gray');
                    submitCustomMcBtn.textContent = 'Â∑≤Êèê‰∫§Á≠îÊ°à ‚úì';
                    
                    // È°ØÁ§∫Â∑≤Êèê‰∫§ÁöÑÁ≠îÊ°à
                    await displaySubmittedAnswers();
                }
            } else {
                defaultMcOptions.classList.remove('hidden');
                customMcQuestionsContainer.classList.add('hidden');
                submitCustomMcBtn.classList.add('hidden');
                interactionMultipleChoice.classList.add('enlarged-buttons'); // Add enlarged class for no custom questions
            }
        }

        // NEW: Ê™¢Êü•Â≠∏ÁîüÊòØÂê¶Â∑≤Á∂ìÊèê‰∫§ÈÅéÁ≠îÊ°à
        async function checkIfStudentSubmitted() {
            if (!studentName || !classroomCode) return false;
            
            try {
                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                const docSnap = await getDoc(studentRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Ê™¢Êü•ÊòØÂê¶ÊúâÈô£ÂàóÊ†ºÂºèÁöÑÁ≠îÊ°àÔºàËá™Ë®ÇÈÅ∏ÊìáÈ°åÔºâ
                    return Array.isArray(data.answer) && data.answer.length > 0;
                }
                return false;
            } catch (error) {
                console.error('Ê™¢Êü•Êèê‰∫§ÁãÄÊÖãÂ§±Êïó:', error);
                return false;
            }
        }

        // NEW: È°ØÁ§∫Â≠∏ÁîüÂ∑≤Êèê‰∫§ÁöÑÁ≠îÊ°à
        async function displaySubmittedAnswers() {
            if (!studentName || !classroomCode) return;
            
            try {
                const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                const docSnap = await getDoc(studentRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (Array.isArray(data.answer)) {
                        // Ê®ôË®òÂ∑≤ÈÅ∏ÊìáÁöÑÁ≠îÊ°à
                        data.answer.forEach(qAns => {
                            const radio = document.querySelector(`input[name="question-${qAns.qIndex}"][value="${qAns.ans}"]`);
                            if (radio) {
                                radio.checked = true;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('ËºâÂÖ•Â∑≤Êèê‰∫§Á≠îÊ°àÂ§±Êïó:', error);
            }
        }


        // --- Canvas State Management Functions ---
        
        /**
         * Saves the current canvas state when switching to peer review.
         */
        function saveCanvasState() {
            if (canvas && currentInteractionMode === 'drawing') {
                try {
                    savedCanvasState = {
                        mainCanvas: canvas.toDataURL(),
                        drawingCanvas: drawingCanvas.toDataURL(),
                        studentImageCanvas: studentImageCanvas.toDataURL(),
                        canvasWidth: canvas.width,
                        canvasHeight: canvas.height
                    };
                    console.log('Canvas state saved');
                } catch (error) {
                    console.error('Error saving canvas state:', error);
                }
            }
        }
        
        /**
         * Restores the canvas state when returning from peer review.
         */
        function restoreCanvasState() {
            if (savedCanvasState && canvas && currentInteractionMode === 'drawing') {
                try {
                    // Ensure canvas setup is complete
                    if (canvas.width === 0 || canvas.height === 0) {
                        setupCanvas();
                    }
                    
                    // Restore canvas dimensions
                    canvas.width = savedCanvasState.canvasWidth;
                    canvas.height = savedCanvasState.canvasHeight;
                    drawingCanvas.width = savedCanvasState.canvasWidth;
                    drawingCanvas.height = savedCanvasState.canvasHeight;
                    studentImageCanvas.width = savedCanvasState.canvasWidth;
                    studentImageCanvas.height = savedCanvasState.canvasHeight;
                    
                    let imagesLoaded = 0;
                    const totalImages = 2; // drawing and student image
                    
                    function checkAllImagesLoaded() {
                        imagesLoaded++;
                        if (imagesLoaded === totalImages) {
                            // All images loaded, recompose the final canvas
                            redrawCanvas();
                            console.log('Canvas state restored');
                        }
                    }
                    
                    // Restore drawing canvas content
                    if (savedCanvasState.drawingCanvas && savedCanvasState.drawingCanvas !== 'data:,') {
                        const drawingImg = new Image();
                        drawingImg.onload = function() {
                            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                            drawingCtx.drawImage(drawingImg, 0, 0);
                            checkAllImagesLoaded();
                        };
                        drawingImg.onerror = function() {
                            console.warn('Failed to load drawing canvas');
                            checkAllImagesLoaded();
                        };
                        drawingImg.src = savedCanvasState.drawingCanvas;
                    } else {
                        drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                        checkAllImagesLoaded();
                    }
                    
                    // Restore student image canvas content
                    if (savedCanvasState.studentImageCanvas && savedCanvasState.studentImageCanvas !== 'data:,') {
                        const studentImg = new Image();
                        studentImg.onload = function() {
                            studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                            studentImageCtx.drawImage(studentImg, 0, 0);
                            checkAllImagesLoaded();
                        };
                        studentImg.onerror = function() {
                            console.warn('Failed to load student image canvas');
                            checkAllImagesLoaded();
                        };
                        studentImg.src = savedCanvasState.studentImageCanvas;
                    } else {
                        studentImageCtx.clearRect(0, 0, studentImageCanvas.width, studentImageCanvas.height);
                        checkAllImagesLoaded();
                    }
                    
                } catch (error) {
                    console.error('Error restoring canvas state:', error);
                    // Fallback: just redraw what we can
                    redrawCanvas();
                }
            }
        }
        
        /**
         * Redraws the main canvas by compositing all layers.
         */
        function redrawCanvas() {
            if (!canvas || !ctx) return;
            
            // Clear main canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background (teacher's background image)
            if (teacherUploadedBackgroundImageDataURL && backgroundCanvas) {
                try {
                    ctx.drawImage(backgroundCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing background canvas:', error);
                }
            }
            
            // Draw student's uploaded image
            if (studentUploadedImageDataURL && studentImageCanvas) {
                try {
                    ctx.drawImage(studentImageCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing student image canvas:', error);
                }
            }
            
            // Draw student's drawing strokes
            if (drawingCanvas) {
                try {
                    ctx.drawImage(drawingCanvas, 0, 0);
                } catch (error) {
                    console.warn('Error drawing drawing canvas:', error);
                }
            }
        }

        // --- Peer Review Functions ---
        
        /**
         * Toggles the peer review process for the current interaction.
         * Only works for text_input and drawing modes.
         */
        async function startPeerReview() {
            if (!currentInteractionMode || (!['text_input', 'drawing'].includes(currentInteractionMode))) {
                showMessage('‰∫íË©ïÂäüËÉΩÂè™ÊîØÊè¥ÊñáÂ≠óÈ°åÂíåÁπ™ÂúñÈ°åÔºÅ', 'error');
                return;
            }
            
            const startPeerReviewBtn = document.getElementById('start-peer-review-btn');
            
            if (peerReviewActive) {
                // Stop peer review
                try {
                    const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                    await setDoc(peerReviewRef, { active: false });
                    
                    peerReviewActive = false;
                    showMessage('‰∫íË©ïÂ∑≤ÂÅúÊ≠¢ÔºÅÂ≠∏ÁîüÂõûÂà∞Âéü‰∫íÂãïÊ®°Âºè„ÄÇ', 'info');
                    
                    // Hide voting statistics container
                    document.getElementById('peer-review-stats-container').classList.add('hidden');
                    
                    // Update button text
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-heart mr-2"></i> ÈñãÂßã‰∫íË©ï ‚ù§Ô∏è';
                    
                } catch (error) {
                    console.error('Error stopping peer review:', error);
                    showMessage('ÂÅúÊ≠¢‰∫íË©ïÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
                }
            } else {
                // Start peer review
                if (allStudentResponses.length === 0) {
                    showMessage('ÁõÆÂâçÊ≤íÊúâÂ≠∏Áîü‰ΩúÁ≠îÔºåÁÑ°Ê≥ïÈñãÂßã‰∫íË©ïÔºÅ', 'error');
                    return;
                }
                
                try {
                    // Set peer review status in Firebase
                    const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
                    await setDoc(peerReviewRef, {
                        active: true,
                        mode: currentInteractionMode,
                        works: allStudentResponses,
                        timestamp: Date.now()
                    });
                    
                    peerReviewActive = true;
                    showMessage('‰∫íË©ïÂ∑≤ÈñãÂßãÔºÅÂ≠∏ÁîüÂèØ‰ª•ÈñãÂßãËßÄÊë©ÊäïÁ•®„ÄÇ', 'success');
                    
                    // Show voting statistics container
                    document.getElementById('peer-review-stats-container').classList.remove('hidden');
                    
                    // Start listening for votes
                    listenToPeerReviewVotes();
                    
                    // Update button text
                    startPeerReviewBtn.innerHTML = '<i class="fas fa-stop mr-2"></i> ÂÅúÊ≠¢‰∫íË©ï ‚èπÔ∏è';
                    
                } catch (error) {
                    console.error('Error starting peer review:', error);
                    showMessage('ÈñãÂßã‰∫íË©ïÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
                }
            }
        }
        
        /**
         * Exits peer review mode for students and returns to original interaction mode.
         */
        function exitPeerReview() {
            if (currentInteractionMode && currentInteractionMode !== 'waiting') {
                // Return to the original interaction mode
                showView('studentInteraction');
                showInteractionUI(currentInteractionMode);
                
                // Restore canvas state if returning to drawing mode
                if (currentInteractionMode === 'drawing') {
                    // Use a small delay to ensure canvas is ready
                    setTimeout(() => {
                        restoreCanvasState();
                    }, 100);
                }
            } else {
                // Return to waiting if no active interaction
                showView('studentWaiting');
            }
        }
        
        /**
         * Listens for peer review status changes and updates student UI accordingly.
         */
        function listenToPeerReviewStatus() {
            if (!classroomCode) return;
            
            const peerReviewRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'peerReview');
            onSnapshot(peerReviewRef, (doc) => {
                if (doc.exists() && doc.data().active) {
                    const data = doc.data();
                    if (currentRole === 'student') {
                        // Save canvas state before switching to peer review (if in drawing mode)
                        if (currentInteractionMode === 'drawing') {
                            saveCanvasState();
                        }
                        
                        // Switch student to peer review view
                        showView('studentPeerReview');
                        displayPeerReviewWorks(data.works, data.mode);
                        
                        // Restore student's voting history from Firebase
                        restoreStudentVotingHistory().then(() => {
                            listenToPeerReviewVotes();
                        });
                    }
                } else {
                    // Peer review ended, return to original interaction mode
                    if (currentRole === 'student' && !views.studentPeerReview.classList.contains('hidden')) {
                        if (currentInteractionMode && currentInteractionMode !== 'waiting') {
                            // Return to the original interaction mode
                            showView('studentInteraction');
                            showInteractionUI(currentInteractionMode);
                            
                            // Restore canvas state if returning to drawing mode
                            if (currentInteractionMode === 'drawing') {
                                // Use a small delay to ensure canvas is ready
                                setTimeout(() => {
                                    restoreCanvasState();
                                }, 100);
                            }
                        } else {
                            // Return to waiting if no active interaction
                            showView('studentWaiting');
                        }
                    }
                }
            });
        }
        
        /**
         * Displays peer review works for students to vote on.
         */
        function displayPeerReviewWorks(works, mode) {
            const worksGrid = document.getElementById('peer-review-works-grid');
            worksGrid.innerHTML = '';
            
            works.forEach((work, index) => {
                // Create a more stable unique identifier using timestamp and student name
                const workId = `${work.name}-${work.timestamp || index}`;
                
                const workDiv = document.createElement('div');
                workDiv.className = 'peer-review-work-item';
                workDiv.dataset.workId = workId;
                
                let contentHtml = '';
                if (mode === 'drawing') {
                    contentHtml = `<img src="${work.answer}" alt="Â≠∏Áîü‰ΩúÂìÅ">`;
                } else {
                    contentHtml = `<p>${work.answer}</p>`;
                }
                
                workDiv.innerHTML = `
                    <div class="work-author">${work.name}</div>
                    <div class="work-content">${contentHtml}</div>
                    <div class="vote-section">
                        <button class="vote-btn" data-work-id="${workId}" data-tooltip="ÈªûÊìäÊäïÁ•®/ÂèñÊ∂àÊäïÁ•®">
                            <i class="fas fa-heart"></i>
                        </button>
                        <span class="vote-count zero">0</span>
                    </div>
                `;
                
                worksGrid.appendChild(workDiv);
            });
            
            // Add vote button listeners and update vote display
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', handleVote);
                
                // Check if student has already voted for this work
                const workId = btn.dataset.workId;
                if (studentVotedWorks.has(workId)) {
                    btn.classList.add('voted');
                }
            });
            
            // Update vote counts if available
            if (Object.keys(allPeerReviewVotes).length > 0) {
                updateStudentVoteUI(allPeerReviewVotes);
            }
            
            // Update student's vote count display
            updateVoteCountDisplay();
        }
        
        /**
         * Handles voting on a work (toggle vote/unvote).
         */
        async function handleVote(e) {
            const workId = e.currentTarget.dataset.workId;
            const voteBtn = e.currentTarget;
            const voteCountSpan = voteBtn.nextElementSibling;
            
            try {
                if (studentVotedWorks.has(workId)) {
                    // Remove vote (unvote)
                    const voteRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes', `${studentName}-${workId}`);
                    await deleteDoc(voteRef);
                    
                    // Remove from local tracking
                    studentVotedWorks.delete(workId);
                    voteBtn.classList.remove('voted');
                    updateVoteCountDisplay();
                    showMessage('Â∑≤ÂèñÊ∂àÊäïÁ•®ÔºÅ', 'info');
                    
                } else {
                    // Add vote
                    if (studentVotedWorks.size >= MAX_VOTES_PER_STUDENT) {
                        showMessage(`ÊúÄÂ§öÂè™ËÉΩÊäïÁ•® ${MAX_VOTES_PER_STUDENT} ÂÄã‰ΩúÂìÅÔºÅË´ãÂÖàÂèñÊ∂àÂÖ∂‰ªñÊäïÁ•®„ÄÇ`, 'warning');
                        return;
                    }
                    
                    const voteRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes', `${studentName}-${workId}`);
                    await setDoc(voteRef, {
                        voterName: studentName,
                        workId: workId,
                        timestamp: Date.now()
                    });
                    
                    // Mark as voted locally
                    studentVotedWorks.add(workId);
                    voteBtn.classList.add('voted');
                    updateVoteCountDisplay();
                    showMessage('ÊäïÁ•®ÊàêÂäüÔºÅ', 'success');
                }
                
            } catch (error) {
                console.error('Error handling vote:', error);
                showMessage('Êìç‰ΩúÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            }
        }
        
        /**
         * Listens for peer review votes and updates UI.
         * üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager ÁÆ°ÁêÜÁõ£ËÅΩÂô®
         */
        function listenToPeerReviewVotes() {
            if (!classroomCode) return;
            
            const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes');
            
            const unsubscribe = onSnapshot(votesRef, (snapshot) => {
                const votes = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!votes[data.workId]) {
                        votes[data.workId] = 0;
                    }
                    votes[data.workId]++;
                });
                
                allPeerReviewVotes = votes;
                
                // Update student UI
                if (currentRole === 'student' && !views.studentPeerReview.classList.contains('hidden')) {
                    updateStudentVoteUI(votes);
                    updateVoteCountDisplay();
                }
                
                // Update teacher UI
                if (currentRole === 'teacher' && !document.getElementById('peer-review-stats-container').classList.contains('hidden')) {
                    updateTeacherVoteStats(votes);
                }
            });
            
            // üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager Ë®ªÂÜäÁõ£ËÅΩÂô®
            ListenerManager.register('peerReviewVotes', unsubscribe);
            peerReviewUnsubscribe = unsubscribe; // ‰øùÊåÅÂÖºÂÆπÊÄß
        }
        
        /**
         * Updates the vote counts in student UI.
         */
        function updateStudentVoteUI(votes) {
            document.querySelectorAll('.vote-count').forEach(span => {
                const workId = span.previousElementSibling.dataset.workId;
                const count = votes[workId] || 0;
                span.textContent = count;
                span.classList.toggle('zero', count === 0);
            });
        }
        
        /**
         * Updates the student's current vote count display.
         */
        function updateVoteCountDisplay() {
            const voteCountElement = document.getElementById('current-vote-count');
            if (voteCountElement) {
                voteCountElement.textContent = studentVotedWorks.size;
                
                // Change color based on vote count
                const container = voteCountElement.parentElement;
                container.className = 'inline-block px-4 py-2 rounded-full text-sm font-medium';
                
                if (studentVotedWorks.size === 0) {
                    container.classList.add('bg-gray-100', 'text-gray-600');
                } else if (studentVotedWorks.size < MAX_VOTES_PER_STUDENT) {
                    container.classList.add('bg-blue-100', 'text-blue-800');
                } else {
                    container.classList.add('bg-green-100', 'text-green-800');
                }
            }
        }
        
        /**
         * Restores student's voting history from Firebase.
         */
        async function restoreStudentVotingHistory() {
            if (!classroomCode || !studentName) return;
            
            try {
                const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'peerReviewVotes');
                const votesSnapshot = await getDocs(votesRef);
                
                // Clear existing voting history
                studentVotedWorks.clear();
                
                // Find votes made by this student
                votesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.voterName === studentName) {
                        studentVotedWorks.add(data.workId);
                    }
                });
                
                console.log('Restored student voting history:', Array.from(studentVotedWorks));
                
                // Update vote count display after restoration
                updateVoteCountDisplay();
            } catch (error) {
                console.error('Error restoring student voting history:', error);
            }
        }

        /**
         * Updates the teacher's vote statistics display.
         */
        function updateTeacherVoteStats(votes) {
            const statsGrid = document.getElementById('peer-review-stats-grid');
            statsGrid.innerHTML = '';
            
            // Sort works by vote count (descending)
            const sortedWorks = allStudentResponses.map(work => {
                const workId = `${work.name}-${work.timestamp || allStudentResponses.indexOf(work)}`;
                return {
                    ...work,
                    workId: workId,
                    votes: votes[workId] || 0
                };
            }).sort((a, b) => b.votes - a.votes);
            
            sortedWorks.forEach((work, index) => {
                const statsDiv = document.createElement('div');
                statsDiv.className = 'vote-stats-item';
                
                let contentHtml = '';
                if (currentInteractionMode === 'drawing') {
                    contentHtml = `<img src="${work.answer}" alt="Â≠∏Áîü‰ΩúÂìÅ">`;
                } else {
                    contentHtml = `<p>${work.answer}</p>`;
                }
                
                statsDiv.innerHTML = `
                    <div class="stats-author">${work.name}</div>
                    <div class="stats-content">${contentHtml}</div>
                    <div class="stats-votes">
                        <i class="fas fa-heart vote-icon"></i>
                        <span class="vote-count ${work.votes === 0 ? 'zero' : ''}">${work.votes}</span>
                    </div>
                `;
                
                statsGrid.appendChild(statsDiv);
            });
        }

        // --- Initialization Function ---
        async function initialize() {
            // üöÄ OPTIMIZED: È†êËºâÂ∏∏Áî® DOM ÂÖÉÁ¥†Âà∞Âø´Âèñ
            DOMCache.preload();
            
            loadAISettings(); 
            loadDispatchSettings(); // Load saved combined dispatch settings

            onAuthStateChanged(auth, async user => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    console.log("Authenticated User ID:", userId);
                    // setupEventListeners(); // Moved this call outside onAuthStateChanged

                    // Check if teacher has a persisted classroom code
                    const savedTeacherClassroomCode = localStorage.getItem('teacherClassroomCode');
                    if (savedTeacherClassroomCode) {
                        classroomCode = savedTeacherClassroomCode;
                        currentRole = 'teacher';
                        document.getElementById('teacher-menu-code-value').textContent = classroomCode; // Update classroom code in teacher menu
                        document.getElementById('end-class-monitor-button-text').textContent = `‰∏ãË™≤ ÊïôÂÆ§‰ª£Á¢º: ${classroomCode}`; // Update button text for monitor view
                        
                        // NEW: Fetch initial pause state and dispatch settings for teacher
                        const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                        const docSnap = await getDoc(controlRef);
                        if (docSnap.exists()) {
                            isResponsePaused = docSnap.data().isPaused || false;
                            // MODIFIED: Load dispatchSettings from Firestore
                            const fetchedDispatchSettings = docSnap.data().dispatchSettings;
                            if (fetchedDispatchSettings) {
                                dispatchSettings.type = fetchedDispatchSettings.type || 'url';
                                dispatchSettings.url = fetchedDispatchSettings.url || '';
                                dispatchSettings.isYoutube = fetchedDispatchSettings.isYoutube || false;
                                dispatchSettings.htmlContent = fetchedDispatchSettings.htmlContent || null;
                            }
                            // NEW: Load custom multiple choice questions from Firestore
                            currentMultipleChoiceQuestions = docSnap.data().multiple_choice_questions || null;
                            customMultipleChoiceQuestions = currentMultipleChoiceQuestions || []; // Sync for teacher UI
                        } else {
                            isResponsePaused = false; // Default to not paused if control doc doesn't exist
                            // dispatchSettings remains at its default or loaded localStorage value
                            currentMultipleChoiceQuestions = null;
                            customMultipleChoiceQuestions = [];
                        }
                        updateTeacherPauseButtonUI(); // Update button UI based on fetched state

                        listenToClassroomPresence(); // Ensure presence listener is established here and remains active
                        showView('teacherMenu');
                    } else {
                        showView('entry');
                    }
                } else {
                    // üöÄ OPTIMIZED: User is null ÊòØ Firebase Ë™çË≠âÊµÅÁ®ãÁöÑÊ≠£Â∏∏ÈÅéÊ∏°ÁãÄÊÖãÔºå‰∏çÊòØÈåØË™§
                    // signInAnonymously() Âü∑Ë°åÂæåÔºåonAuthStateChanged ÊúÉÂÜçÊ¨°Ëß∏Áôº‰∏¶ÂÇ≥ÂÖ•ÊúâÊïàÁöÑ user
                    console.log("[Auth] Waiting for authentication...");
                    // If user is null (e.g., after signOut), ensure we are on the entry view.
                    showView('entry'); 
                }
            });

            document.getElementById('app-id-display').textContent = baseAppId; // Display the base app ID
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                document.body.innerHTML = `<div class="text-center p-8 text-red-600"><h1 class="text-2xl font-bold">È©óË≠âÂ§±Êïó</h1><p>ÁÑ°Ê≥ïÈÄ£Êé•Ëá≥‰∫íÂãïÊúçÂãôÔºåË´ãÊ™¢Êü• Firebase Ë®≠ÂÆöÊàñÁ∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ</p><p class=\"text-sm mt-2\">${error.message}</p></div>`;
            }
        }

        // Add beforeunload handler to warn user about closing window
        let hasEndedClass = false;
        
        // Track when user clicks the end class button
        function markClassEnded() {
            hasEndedClass = true;
        }
        
        // Set up window close warning
        window.onbeforeunload = function() {
            if (!hasEndedClass) {
                return 'Ë´ãÂÖàÊåâ‰∏ãÁ¥ÖËâ≤‰∏ãË™≤ÈçµÔºåÂÜçÈóúÈñâË¶ñÁ™óÔºåÊú¨ÊèêÁ§∫Ë´ãÂÖàÊåâÂèñÊ∂à';
            }
        };

        // --- Quick Answer Functions ---
        let quickAnswerActive = false;
        let quickAnswerWinner = null;
        let quickAnswerWinnerDisplayed = false;

        function startQuickAnswer() {
            console.log('[startQuickAnswer] Function called - starting quick answer round');
            quickAnswerActive = true;
            quickAnswerWinner = null;
            quickAnswerWinnerDisplayed = false;

            // Update status text
            const statusText = document.getElementById('quick-answer-status-text');
            statusText.textContent = 'Êê∂Á≠îÈñãÂßãÔºÅÂø´ÈªûÊìäÊåâÈàïÔºÅ';
            console.log('[startQuickAnswer] Status text updated to:', statusText.textContent);

            const container = document.getElementById('quick-answer-button-container');
            
            // üöÄ CRITICAL FIX: ÂÆåÂÖ®Ê∏ÖÁêÜÂÆπÂô®ÔºåÁßªÈô§ÊâÄÊúâËàäÊåâÈàïÂíå‰∫ã‰ª∂Áõ£ËÅΩÂô®
            const oldButtons = container.querySelectorAll('.quick-answer-btn');
            oldButtons.forEach(btn => {
                btn.removeEventListener('click', handleQuickAnswerClick);
                btn.remove();
            });
            
            container.innerHTML = '';
            container.classList.remove('pointer-events-none');
            console.log('[startQuickAnswer] Container cleared, all old buttons removed');

            // üöÄ FIX: ‰ΩøÁî® requestAnimationFrame Á¢∫‰øùÂÆπÂô®Â∑≤Á∂ìÊ∏≤ÊüìÂÆåÊàêÂÜçÁîüÊàêÊåâÈàï
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    // üöÄ CRITICAL FIX: Âú®Ê∑ªÂä†Êñ∞ÊåâÈàïÂâçÊ™¢Êü•ÂÆπÂô®ÊòØÂê¶Â∑≤Á∂ìÊúâÊåâÈàïÔºàÈò≤Ê≠¢ÈáçË§áÔºâ
                    const existingButton = container.querySelector('.quick-answer-btn');
                    if (existingButton) {
                        console.warn('[Quick Answer] ‚ö†Ô∏è Button already exists in container, skipping creation');
                        return;
                    }
                    
                    // Double RAF ensures layout is complete
                    console.log('[Quick Answer] Generating random button...');
                    
                    // Create the quick answer button
                    const button = document.createElement('button');
                    button.className = 'quick-answer-btn';
                    button.textContent = 'Âø´ÈªûÊàë';

                    // Calculate random position (ensure button is fully visible)
                    const containerRect = container.getBoundingClientRect();
                    const buttonSize = 200; // 200px width and height
                    
                    // üöÄ FIX: È©óË≠âÂÆπÂô®Â∞∫ÂØ∏ÔºåÂ¶ÇÊûúÁÑ°ÊïàÂâá‰ΩøÁî® viewport Â∞∫ÂØ∏
                    let containerWidth = containerRect.width;
                    let containerHeight = containerRect.height;
                    
                    if (containerWidth < buttonSize || containerHeight < buttonSize) {
                        console.warn('[Quick Answer] Container size invalid, using viewport dimensions');
                        containerWidth = window.innerWidth;
                        containerHeight = window.innerHeight;
                    }
                    
                    console.log(`[Quick Answer] Container size: ${containerWidth}x${containerHeight}`);
                    
                    const maxLeft = containerWidth - buttonSize;
                    const maxTop = containerHeight - buttonSize;

                    const randomLeft = Math.random() * Math.max(0, maxLeft);
                    const randomTop = Math.random() * Math.max(0, maxTop);

                    button.style.left = randomLeft + 'px';
                    button.style.top = randomTop + 'px';
                    
                    console.log(`[Quick Answer] Button position: left=${randomLeft}px, top=${randomTop}px`);

                    // Add click handler
                    button.addEventListener('click', handleQuickAnswerClick);

                    container.appendChild(button);
                    console.log('[startQuickAnswer] ‚úÖ Button added to DOM successfully (exactly 1 button)');
                    console.log('[startQuickAnswer] Current button count:', container.querySelectorAll('.quick-answer-btn').length);
                });
            });
        }

        async function handleQuickAnswerClick() {
            if (!quickAnswerActive || quickAnswerWinner) return;

            try {
                // üî• FIX: Submit with current modeResetToken using submitAnswer to preserve validations
                const response = `Êê∂Á≠îÊàêÂäüÔºö${studentName}`;
                const currentToken = window.lastStudentModeResetToken || 0;
                console.log('[handleQuickAnswerClick] Submitting quick answer with token:', currentToken);
                
                // Use submitAnswer with token in extraFields to preserve pause/validation logic
                await submitAnswer(response, { modeResetToken: currentToken });
                
                console.log('[handleQuickAnswerClick] Quick answer submitted successfully with token:', currentToken);

                // üéâ Mark this student as the winner
                quickAnswerWinner = studentName;

                // Show success message
                document.getElementById('quick-answer-result').classList.remove('hidden');
                document.getElementById('quick-answer-status-text').textContent = '‰Ω†Êê∂Á≠îÊàêÂäü‰∫ÜÔºÅ';
                document.getElementById('quick-answer-locked').classList.add('hidden');

                // üéä Trigger confetti celebration
                if (typeof confetti !== 'undefined') {
                    const duration = 3000;
                    const animationEnd = Date.now() + duration;
                    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10000 };

                    function randomInRange(min, max) {
                        return Math.random() * (max - min) + min;
                    }

                    const interval = setInterval(function() {
                        const timeLeft = animationEnd - Date.now();

                        if (timeLeft <= 0) {
                            return clearInterval(interval);
                        }

                        const particleCount = 50 * (timeLeft / duration);
                        confetti(Object.assign({}, defaults, {
                            particleCount,
                            origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
                        }));
                        confetti(Object.assign({}, defaults, {
                            particleCount,
                            origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
                        }));
                    }, 250);
                }

                // Lock the button
                lockQuickAnswerButton(true);

            } catch (error) {
                console.error('Failed to submit quick answer:', error);
                showMessage('Êê∂Á≠îÊèê‰∫§Â§±ÊïóÔºÅ', 'error');
            }
        }

        function lockQuickAnswerButton(isWinner = false) {
            const button = document.querySelector('.quick-answer-btn');
            if (button) {
                button.classList.add('locked');
                button.disabled = true;
                button.removeEventListener('click', handleQuickAnswerClick);
            }

            // üöÄ FIX: Only show "locked" message to students who DIDN'T win
            if (!isWinner) {
                document.getElementById('quick-answer-locked').classList.remove('hidden');
                document.getElementById('quick-answer-result').classList.add('hidden');
            }
        }

        // Listen for quick answer winner updates
        function listenToQuickAnswerUpdates() {
            if (currentRole !== 'student' || currentInteractionMode !== 'quick_answer') return;

            // üöÄ FIX: Capture current token to ignore stale snapshots
            const capturedToken = window.lastStudentModeResetToken || 0;
            console.log(`[listenToQuickAnswerUpdates] Starting listener with token: ${capturedToken}`);
            
            // üî• CRITICAL FIX: ÈáçÁΩÆÊê∂Á≠îÁãÄÊÖãÁï∂Áõ£ËÅΩÂô®ÂïüÂãïÊôÇ
            quickAnswerWinner = null;
            quickAnswerWinnerDisplayed = false;
            console.log('[listenToQuickAnswerUpdates] üéØ FIX: Reset quick answer state for new round');

            const responsesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            const unsubscribe = onSnapshot(responsesRef, (snapshot) => {
                // üöÄ FIX: Ignore snapshots from old rounds
                if (window.lastStudentModeResetToken !== capturedToken) {
                    console.log(`[listenToQuickAnswerUpdates] Ignoring stale snapshot (current token: ${window.lastStudentModeResetToken}, captured: ${capturedToken})`);
                    return;
                }

                // üî• NEW FIX: Ignore empty snapshots or reset-state snapshots after mode restart
                // After teacher clicks restart, the snapshot will be empty or contain only cleared responses
                // We should NOT rewrite the UI back to "waiting" state - keep the fresh button visible
                if (snapshot.empty) {
                    console.log(`[listenToQuickAnswerUpdates] Ignoring empty snapshot after restart (token: ${capturedToken})`);
                    return;
                }

                const responses = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // üî• CRITICAL FIX: Only process responses from the CURRENT session
                    // Ignore responses without token or with mismatched token
                    const responseToken = data.modeResetToken || 0;
                    if (data.answer && data.answer.includes('Êê∂Á≠îÊàêÂäü') && responseToken === capturedToken) {
                        responses.push(data);
                        console.log(`[listenToQuickAnswerUpdates] Valid response found from ${data.name} with matching token ${responseToken}`);
                    } else if (data.answer && data.answer.includes('Êê∂Á≠îÊàêÂäü')) {
                        console.log(`[listenToQuickAnswerUpdates] Ignoring response from ${data.name} with stale token ${responseToken} (expected: ${capturedToken})`);
                    }
                });

                // üî• NEW FIX: If no valid quick-answer responses found with matching token, don't reset the UI
                // This prevents the race condition where reset clears responses but listener overwrites the fresh button
                if (responses.length === 0) {
                    console.log(`[listenToQuickAnswerUpdates] No valid quick-answer responses with matching token found, keeping current UI (token: ${capturedToken})`);
                    return;
                }

                // If someone already answered and it's not this student, lock the button
                if (responses.length > 0 && !quickAnswerWinner) {
                    const winner = responses[0];
                    if (winner.name !== studentName) {
                        console.log(`[listenToQuickAnswerUpdates] ${winner.name} won the quick answer, locking button`);
                        quickAnswerWinner = winner.name;
                        lockQuickAnswerButton();
                        document.getElementById('quick-answer-status-text').textContent = `${winner.name} Êê∂Á≠îÊàêÂäüÔºÅ`;
                    }
                }
            });

            // üöÄ FIX: Save unsubscribe function globally
            quickAnswerUnsubscribe = unsubscribe;
        }

        function showQuickAnswerWinner(winnerName) {
            console.log('showQuickAnswerWinner called with:', winnerName);
            if (quickAnswerWinnerDisplayed) {
                console.log('Winner already displayed, skipping');
                return; // Prevent showing multiple times
            }
            quickAnswerWinnerDisplayed = true;
            console.log('Displaying winner overlay');

            // Create a big overlay notification for the teacher
            const overlay = document.createElement('div');
            overlay.id = 'quick-answer-winner-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.5s ease-in-out;
            `;

            overlay.innerHTML = `
                <div style="text-align: center; color: white; font-size: 3rem; font-weight: bold;">
                    <i class="fas fa-trophy" style="color: #ffd700; font-size: 6rem; margin-bottom: 20px;"></i>
                    <h1 style="margin: 20px 0; color: #4ade80;">Êê∂Á≠îÊàêÂäüÔºÅ</h1>
                    <h2 style="margin: 20px 0; color: #60a5fa; font-size: 4rem;">${winnerName}</h2>
                    <p style="font-size: 1.5rem; color: #d1d5db;">ÈªûÊìä‰ªªÊÑè‰ΩçÁΩÆÈóúÈñâ</p>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; transform: scale(0.8); }
                        to { opacity: 1; transform: scale(1); }
                    }
                </style>
            `;

            // Add click handler to close the overlay
            overlay.addEventListener('click', () => {
                overlay.remove();
                quickAnswerWinnerDisplayed = false; // Reset for next round
            });

            document.body.appendChild(overlay);

            // Auto close after 5 seconds
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.remove();
                    quickAnswerWinnerDisplayed = false;
                }
            }, 5000);
        }

        // --- Quick Poll Functions ---

        /**
         * Shows the quick poll settings modal
         */
        function showQuickPollSettingsModal() {
            document.getElementById('quick-poll-settings-modal').classList.remove('hidden');
            // Reset form
            document.querySelector('input[name="pollType"][value="emoji"]').checked = true;
            document.getElementById('custom-poll-options-section').classList.add('hidden');
            document.getElementById('custom-poll-options-input').value = '';
            document.getElementById('quick-poll-anonymous-checkbox').checked = true;
        }

        /**
         * Hides the quick poll settings modal
         */
        function hideQuickPollSettingsModal() {
            document.getElementById('quick-poll-settings-modal').classList.add('hidden');
        }

        /**
         * Gets poll options based on selected type
         */
        function getPollOptions(pollType, customOptions = '') {
            switch(pollType) {
                case 'emoji':
                    return ['üòä', 'üòê', 'üòï'];
                case 'simple':
                    return ['ÂêåÊÑè', '‰∏çÂêåÊÑè', '‰∏çÁ¢∫ÂÆö'];
                case 'rating5':
                    return ['1', '2', '3', '4', '5'];
                case 'rating10':
                    return ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
                case 'custom':
                    return customOptions.split('\n').filter(opt => opt.trim() !== '').map(opt => opt.trim());
                default:
                    return [];
            }
        }

        /**
         * Starts a quick poll
         */
        async function startQuickPoll() {
            const question = 'Âø´ÈÄüÊäïÁ•®';
            const pollType = document.querySelector('input[name="pollType"]:checked').value;
            const anonymous = document.getElementById('quick-poll-anonymous-checkbox').checked;
            const customOptions = document.getElementById('custom-poll-options-input').value;

            // Validation
            const options = getPollOptions(pollType, customOptions);
            if (options.length === 0) {
                showMessage('Ë´ãË®≠ÂÆöÊúâÊïàÁöÑÊäïÁ•®ÈÅ∏È†ÖÔºÅ', 'error');
                return;
            }

            try {
                // Initialize vote counts
                const voteCounts = {};
                options.forEach(opt => voteCounts[opt] = 0);

                // Save poll configuration to Firebase
                quickPollData = {
                    question,
                    pollType,
                    options,
                    anonymous,
                    voteCounts,
                    active: true,
                    timestamp: Date.now()
                };

                const pollRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPoll', 'config');
                await setDoc(pollRef, quickPollData);

                // Clear previous votes
                const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes');
                const votesSnapshot = await getDocs(votesRef);
                const deletePromises = votesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                // Set interaction mode to quick_poll
                await setInteractionMode('quick_poll');

                quickPollActive = true;
                hideQuickPollSettingsModal();

                // Show stats modal for teacher
                showQuickPollStatsModal();

                // Start listening to votes
                listenToQuickPollVotes();

                showMessage('Âø´ÈÄüÊäïÁ•®Â∑≤ÈñãÂßãÔºÅ', 'success');
            } catch (error) {
                console.error('Error starting quick poll:', error);
                showMessage('ÂïüÂãïÂø´ÈÄüÊäïÁ•®ÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            }
        }

        /**
         * Shows the quick poll statistics modal
         */
        function showQuickPollStatsModal() {
            const modal = document.getElementById('quick-poll-stats-modal');
            modal.classList.remove('hidden');

            // Display question
            document.getElementById('quick-poll-stats-question').textContent = quickPollData.question;

            // Display online student count
            document.getElementById('poll-online-students').textContent = activeStudentNames.length;

            // Initialize chart
            currentChartType = 'bar';
            updateChartButtonStyles();
            updateQuickPollChart();
        }

        /**
         * Hides the quick poll statistics modal
         */
        function hideQuickPollStatsModal() {
            document.getElementById('quick-poll-stats-modal').classList.add('hidden');
        }

        /**
         * Ends the current quick poll
         */
        async function endQuickPoll() {
            try {
                // Set poll as inactive
                const pollRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPoll', 'config');
                await setDoc(pollRef, { active: false }, { merge: true });

                // Stop interaction
                await setInteractionMode('waiting');

                quickPollActive = false;
                hideQuickPollStatsModal();

                // Unsubscribe from votes listener
                if (quickPollVotesUnsubscribe) {
                    quickPollVotesUnsubscribe();
                    quickPollVotesUnsubscribe = null;
                }

                showMessage('Âø´ÈÄüÊäïÁ•®Â∑≤ÁµêÊùüÔºÅ', 'info');
            } catch (error) {
                console.error('Error ending quick poll:', error);
                showMessage('ÁµêÊùüÊäïÁ•®ÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            }
        }

        /**
         * Listens for vote updates
         * üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager ÁÆ°ÁêÜÁõ£ËÅΩÂô®
         */
        function listenToQuickPollVotes() {
            if (!classroomCode || !quickPollData) return;

            const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes');

            const unsubscribe = onSnapshot(votesRef, (snapshot) => {
                // Aggregate votes
                const voteCounts = {};
                quickPollData.options.forEach(opt => voteCounts[opt] = 0);

                snapshot.forEach(doc => {
                    const voteData = doc.data();
                    if (voteData.option && voteCounts.hasOwnProperty(voteData.option)) {
                        voteCounts[voteData.option]++;
                    }
                });

                // Update quickPollData
                quickPollData.voteCounts = voteCounts;

                // Update UI if teacher is viewing stats
                if (currentRole === 'teacher' && !document.getElementById('quick-poll-stats-modal').classList.contains('hidden')) {
                    updateQuickPollChart();
                    updateQuickPollTable();
                }
            });
            
            // üöÄ OPTIMIZED: ‰ΩøÁî® ListenerManager Ë®ªÂÜäÁõ£ËÅΩÂô®
            ListenerManager.register('quickPollVotes', unsubscribe);
            quickPollVotesUnsubscribe = unsubscribe; // ‰øùÊåÅÂÖºÂÆπÊÄß
        }

        /**
         * Updates the quick poll chart
         */
        function updateQuickPollChart() {
            if (!quickPollData) return;

            const svg = d3.select("#quick-poll-chart-svg");
            svg.selectAll("*").remove(); // Clear previous chart

            const data = quickPollData.options.map(opt => ({
                label: opt,
                value: quickPollData.voteCounts[opt] || 0
            }));

            const totalVotes = data.reduce((sum, d) => sum + d.value, 0);
            document.getElementById('poll-total-votes').textContent = totalVotes;

            if (currentChartType === 'bar') {
                drawQuickPollBarChart(svg, data);
            } else {
                drawQuickPollPieChart(svg, data);
            }
        }

        /**
         * Draws a bar chart for quick poll
         */
        function drawQuickPollBarChart(svg, data) {
            const width = 800;
            const height = 450;
            const margin = {top: 20, right: 20, bottom: 60, left: 60};
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // X scale
            const x = d3.scaleBand()
                .range([0, chartWidth])
                .padding(0.2)
                .domain(data.map(d => d.label));

            // Y scale
            const maxValue = d3.max(data, d => d.value) || 1;
            const y = d3.scaleLinear()
                .range([chartHeight, 0])
                .domain([0, maxValue]);

            // Color scale
            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.label))
                .range(['#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7']);

            // X axis
            g.append("g")
                .attr("transform", `translate(0,${chartHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("font-size", "14px")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Y axis
            g.append("g")
                .call(d3.axisLeft(y).ticks(5))
                .selectAll("text")
                .style("font-size", "14px");

            // Bars
            g.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.label))
                .attr("y", d => y(d.value))
                .attr("width", x.bandwidth())
                .attr("height", d => chartHeight - y(d.value))
                .attr("fill", d => color(d.label))
                .attr("rx", 4);

            // Value labels on top of bars
            g.selectAll(".label")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "label")
                .attr("x", d => x(d.label) + x.bandwidth() / 2)
                .attr("y", d => y(d.value) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .style("fill", "#374151")
                .text(d => d.value);
        }

        /**
         * Draws a pie chart for quick poll
         */
        function drawQuickPollPieChart(svg, data) {
            const width = 800;
            const height = 450;
            const radius = Math.min(width, height) / 2 - 40;

            const g = svg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);

            // Color scale
            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.label))
                .range(['#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7']);

            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);
            const labelArc = d3.arc().innerRadius(radius * 0.6).outerRadius(radius * 0.6);

            const arcs = g.selectAll(".arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.label))
                .attr("stroke", "white")
                .attr("stroke-width", 2);

            // Labels
            arcs.append("text")
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .style("fill", "white")
                .each(function(d) {
                    const text = d3.select(this);
                    text.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "-0.2em")
                        .text(d.data.label);
                    text.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "1.2em")
                        .text(d.data.value);
                });
        }

        /**
         * Updates the quick poll data table
         */
        function updateQuickPollTable() {
            if (!quickPollData) return;

            const tbody = document.getElementById('quick-poll-stats-table-body');
            tbody.innerHTML = '';

            const totalVotes = Object.values(quickPollData.voteCounts).reduce((sum, val) => sum + val, 0);

            quickPollData.options.forEach(opt => {
                const count = quickPollData.voteCounts[opt] || 0;
                const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : '0.0';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border px-4 py-2">${opt}</td>
                    <td class="border px-4 py-2 text-right font-bold">${count}</td>
                    <td class="border px-4 py-2 text-right">${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Switches between chart types
         */
        function switchChartType(type) {
            currentChartType = type;
            updateChartButtonStyles();
            updateQuickPollChart();
        }

        /**
         * Updates chart type button styles
         */
        function updateChartButtonStyles() {
            const barBtn = document.getElementById('chart-type-bar-btn');
            const pieBtn = document.getElementById('chart-type-pie-btn');

            if (currentChartType === 'bar') {
                barBtn.classList.remove('btn-gray');
                barBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                pieBtn.classList.add('btn-gray');
                pieBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            } else {
                pieBtn.classList.remove('btn-gray');
                pieBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                barBtn.classList.add('btn-gray');
                barBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            }
        }

        /**
         * Downloads poll results as CSV
         */
        async function downloadPollResults() {
            if (!quickPollData) return;

            const totalVotes = Object.values(quickPollData.voteCounts).reduce((sum, val) => sum + val, 0);

            let csv = '\uFEFF'; // BOM for Excel UTF-8 support
            csv += `Âø´ÈÄüÊäïÁ•®ÁµêÊûú\n`;
            csv += `ÂïèÈ°å,${quickPollData.question}\n`;
            csv += `Á∏ΩÊäïÁ•®Êï∏,${totalVotes}\n`;
            csv += `ÊäïÁ•®Ê®°Âºè,${quickPollData.anonymous ? 'ÂåøÂêç' : 'Ë®òÂêç'}\n`;
            csv += `\n`;

            // Summary table
            csv += `ÈÅ∏È†ÖÁµ±Ë®à\n`;
            csv += `ÈÅ∏È†Ö,Á•®Êï∏,ÁôæÂàÜÊØî\n`;
            quickPollData.options.forEach(opt => {
                const count = quickPollData.voteCounts[opt] || 0;
                const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : '0.0';
                csv += `${opt},${count},${percentage}%\n`;
            });

            // Detailed votes if not anonymous
            if (!quickPollData.anonymous) {
                csv += `\nË©≥Á¥∞ÊäïÁ•®Ë®òÈåÑ\n`;
                csv += `Â≠∏ÁîüÂßìÂêç,ÈÅ∏È†Ö,ÊäïÁ•®ÊôÇÈñì\n`;

                try {
                    const votesRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes');
                    const votesSnapshot = await getDocs(votesRef);

                    votesSnapshot.forEach(doc => {
                        const voteData = doc.data();
                        const studentName = voteData.studentName || 'Êú™Áü•';
                        const option = voteData.option || '';
                        const timestamp = voteData.timestamp ? new Date(voteData.timestamp).toLocaleString('zh-TW') : '';
                        csv += `${studentName},${option},${timestamp}\n`;
                    });
                } catch (error) {
                    console.error('Error fetching vote details:', error);
                }
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = generateFilename('Âø´ÈÄüÊäïÁ•®ÁµêÊûú', 'csv');
            link.click();

            showMessage('ÊäïÁ•®ÁµêÊûúÂ∑≤‰∏ãËºâÔºÅ', 'success');
        }

        /**
         * Downloads statistics (for True/False and Multiple Choice) as CSV
         */
        async function downloadStatistics() {
            if (!currentInteractionMode || allStudentResponses.length === 0) {
                showMessage('Ê≤íÊúâÁµ±Ë®àÊï∏ÊìöÂèØ‰æõ‰∏ãËºâ', 'info');
                return;
            }

            let csv = '\uFEFF'; // BOM for Excel UTF-8 support
            const timestamp = new Date().toLocaleString('zh-TW');

            if (currentInteractionMode === 'true_false') {
                // True/False Statistics
                const filteredResponses = allStudentResponses.filter(r => r.answer === 'O' || r.answer === 'X');
                const totalResponses = filteredResponses.length;
                const oCount = filteredResponses.filter(r => r.answer === 'O').length;
                const xCount = filteredResponses.filter(r => r.answer === 'X').length;

                csv += `ÊòØÈùûÈ°å‰ΩúÁ≠îÁµ±Ë®à\n`;
                csv += `ÂåØÂá∫ÊôÇÈñì,${timestamp}\n`;
                csv += `Á∏Ω‰ΩúÁ≠î‰∫∫Êï∏,${totalResponses}\n`;
                csv += `\n`;

                // Summary table
                csv += `ÈÅ∏È†ÖÁµ±Ë®à\n`;
                csv += `ÈÅ∏È†Ö,‰∫∫Êï∏,ÁôæÂàÜÊØî\n`;
                csv += `O (Ê≠£Á¢∫),${oCount},${totalResponses > 0 ? ((oCount / totalResponses) * 100).toFixed(1) : '0.0'}%\n`;
                csv += `X (ÈåØË™§),${xCount},${totalResponses > 0 ? ((xCount / totalResponses) * 100).toFixed(1) : '0.0'}%\n`;
                csv += `\n`;

                // Detailed responses
                csv += `Ë©≥Á¥∞‰ΩúÁ≠îË®òÈåÑ\n`;
                csv += `Â≠∏ÁîüÂßìÂêç,Á≠îÊ°à,‰ΩúÁ≠îÊôÇÈñì\n`;
                filteredResponses.forEach(r => {
                    const answerTime = r.timestamp 
                        ? (r.timestamp.toDate ? r.timestamp.toDate().toLocaleString('zh-TW') : new Date(r.timestamp).toLocaleString('zh-TW'))
                        : 'Êú™Áü•';
                    csv += `${r.name},${r.answer},${answerTime}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = generateFilename('ÊòØÈùûÈ°åÁµ±Ë®à', 'csv');
                link.click();

                showMessage('ÊòØÈùûÈ°åÁµ±Ë®àÂ∑≤‰∏ãËºâÔºÅ', 'success');

            } else if (currentInteractionMode === 'multiple_choice') {
                if (currentMultipleChoiceQuestions) {
                    // Custom Multiple Choice Statistics
                    const filteredResponses = allStudentResponses.filter(r => Array.isArray(r.answer));
                    
                    csv += `Ëá™Ë®ÇÈÅ∏ÊìáÈ°å‰ΩúÁ≠îÁµ±Ë®à\n`;
                    csv += `ÂåØÂá∫ÊôÇÈñì,${timestamp}\n`;
                    csv += `Á∏Ω‰ΩúÁ≠î‰∫∫Êï∏,${filteredResponses.length}\n`;
                    csv += `È°åÁõÆÁ∏ΩÊï∏,${currentMultipleChoiceQuestions.length}\n`;
                    csv += `\n`;

                    // Question-by-question statistics
                    csv += `ÂêÑÈ°åÁµ±Ë®à\n`;
                    csv += `È°åËôü,È°åÁõÆ,Ê≠£Á¢∫Á≠îÊ°à,‰ΩúÁ≠î‰∫∫Êï∏,Á≠îÂ∞ç‰∫∫Êï∏,Á≠îÂ∞çÁéá\n`;
                    currentMultipleChoiceQuestions.forEach((q, qIndex) => {
                        let correctCount = 0;
                        let answeredCount = 0;

                        filteredResponses.forEach(studentResponse => {
                            const studentQAnswer = studentResponse.answer.find(ans => ans.qIndex === qIndex);
                            if (studentQAnswer) {
                                answeredCount++;
                                if (String(studentQAnswer.ans) === String(q.correctAnswer)) {
                                    correctCount++;
                                }
                            }
                        });

                        const correctRate = answeredCount > 0 ? ((correctCount / answeredCount) * 100).toFixed(1) : '0.0';
                        csv += `${qIndex + 1},"${q.question}",${q.correctAnswer},${answeredCount},${correctCount},${correctRate}%\n`;
                    });

                    csv += `\n`;

                    // Detailed student responses
                    csv += `Â≠∏ÁîüË©≥Á¥∞‰ΩúÁ≠îË®òÈåÑ\n`;
                    csv += `Â≠∏ÁîüÂßìÂêç,‰ΩúÁ≠îÊôÇÈñì`;
                    currentMultipleChoiceQuestions.forEach((q, qIndex) => {
                        csv += `,Q${qIndex + 1}Á≠îÊ°à,Q${qIndex + 1}ÁµêÊûú`;
                    });
                    csv += `\n`;

                    filteredResponses.forEach(studentResponse => {
                        const answerTime = studentResponse.timestamp 
                            ? (studentResponse.timestamp.toDate ? studentResponse.timestamp.toDate().toLocaleString('zh-TW') : new Date(studentResponse.timestamp).toLocaleString('zh-TW'))
                            : 'Êú™Áü•';
                        csv += `${studentResponse.name},${answerTime}`;
                        
                        currentMultipleChoiceQuestions.forEach((q, qIndex) => {
                            const studentQAnswer = studentResponse.answer.find(ans => ans.qIndex === qIndex);
                            if (studentQAnswer) {
                                // üöÄ FIX: ÊîØÊè¥ÈÄÅÂàÜÈ°åÔºàcorrectAnswer === 0 ÊôÇÁÑ°Ê¢ù‰ª∂ÁÆóÁÇ∫Ê≠£Á¢∫Ôºâ
                                const isCorrect = (q.correctAnswer === 0) || (String(studentQAnswer.ans) === String(q.correctAnswer)) ? '‚úì' : '‚úó';
                                csv += `,${studentQAnswer.ans},${isCorrect}`;
                            } else {
                                csv += `,Êú™‰ΩúÁ≠î,`;
                            }
                        });
                        csv += `\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = generateFilename('Ëá™Ë®ÇÈÅ∏ÊìáÈ°åÁµ±Ë®à', 'csv');
                    link.click();

                    showMessage('Ëá™Ë®ÇÈÅ∏ÊìáÈ°åÁµ±Ë®àÂ∑≤‰∏ãËºâÔºÅ', 'success');

                } else {
                    // Default Multiple Choice Statistics (1-4)
                    const filteredResponses = allStudentResponses.filter(r => r.answer >= '1' && r.answer <= '4');
                    const totalResponses = filteredResponses.length;
                    const counts = { '1': 0, '2': 0, '3': 0, '4': 0 };
                    filteredResponses.forEach(r => { counts[r.answer]++; });

                    csv += `ÈÅ∏ÊìáÈ°å‰ΩúÁ≠îÁµ±Ë®à\n`;
                    csv += `ÂåØÂá∫ÊôÇÈñì,${timestamp}\n`;
                    csv += `Á∏Ω‰ΩúÁ≠î‰∫∫Êï∏,${totalResponses}\n`;
                    csv += `\n`;

                    // Summary table
                    csv += `ÈÅ∏È†ÖÁµ±Ë®à\n`;
                    csv += `ÈÅ∏È†Ö,‰∫∫Êï∏,ÁôæÂàÜÊØî\n`;
                    ['1', '2', '3', '4'].forEach(opt => {
                        const count = counts[opt];
                        const percentage = totalResponses > 0 ? ((count / totalResponses) * 100).toFixed(1) : '0.0';
                        csv += `ÈÅ∏È†Ö${opt},${count},${percentage}%\n`;
                    });
                    csv += `\n`;

                    // Detailed responses
                    csv += `Ë©≥Á¥∞‰ΩúÁ≠îË®òÈåÑ\n`;
                    csv += `Â≠∏ÁîüÂßìÂêç,Á≠îÊ°à,‰ΩúÁ≠îÊôÇÈñì\n`;
                    filteredResponses.forEach(r => {
                        const answerTime = r.timestamp 
                            ? (r.timestamp.toDate ? r.timestamp.toDate().toLocaleString('zh-TW') : new Date(r.timestamp).toLocaleString('zh-TW'))
                            : 'Êú™Áü•';
                        csv += `${r.name},ÈÅ∏È†Ö${r.answer},${answerTime}\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = generateFilename('ÈÅ∏ÊìáÈ°åÁµ±Ë®à', 'csv');
                    link.click();

                    showMessage('ÈÅ∏ÊìáÈ°åÁµ±Ë®àÂ∑≤‰∏ãËºâÔºÅ', 'success');
                }
            } else if (currentInteractionMode === 'reading_comprehension') {
                // üöÄ NEW: Reading Comprehension Statistics with Rankings and Duration
                if (readingComprehensionData && readingComprehensionData.questions && readingComprehensionData.questions.length > 0) {
                    const questions = readingComprehensionData.questions;
                    const filteredResponses = allStudentResponses.filter(r => {
                        try {
                            const answers = JSON.parse(r.answer);
                            return Array.isArray(answers);
                        } catch (e) {
                            return false;
                        }
                    });

                    // Calculate scores and rankings
                    const rankedStudents = [];
                    filteredResponses.forEach(student => {
                        try {
                            const studentAnswers = JSON.parse(student.answer);
                            let correctCount = 0;

                            studentAnswers.forEach((ans, index) => {
                                // üöÄ FIX: ÊîØÊè¥ÈÄÅÂàÜÈ°åÔºàcorrectAnswer === 0 ÊôÇÁÑ°Ê¢ù‰ª∂Ë®àÁÇ∫Ê≠£Á¢∫Ôºâ
                                if (questions[index] && ((questions[index].correctAnswer === 0) || (String(ans) === String(questions[index].correctAnswer)))) {
                                    correctCount++;
                                }
                            });

                            // üöÄ FIX: ÂÑ™ÂÖà‰ΩøÁî® Firestore ÂàÜÊï∏ÔºàÊïôÂ∏´‰øÆÊîπÁ≠îÊ°àÂæåÂ∑≤Êõ¥Êñ∞Ôºâ
                            const hasTeacherUpdatedScore = student.scoreUpdateToken && student.baseScore !== undefined;
                            let accuracy, baseScore, totalScore, highlightBonus;
                            
                            if (hasTeacherUpdatedScore) {
                                // ‰ΩøÁî® Firestore ‰∏≠ÊïôÂ∏´Â∑≤Ë®àÁÆóÂ•ΩÁöÑÂàÜÊï∏ÔºàÂê´ÈÄÅÂàÜÈ°åÈÇèËºØÔºâ
                                baseScore = student.baseScore;
                                totalScore = student.totalScore || baseScore;
                                highlightBonus = (student.highlightAnalysis && student.highlightAnalysis.score) || 0;
                                accuracy = baseScore; // baseScore Â∞±ÊòØÊ≠£Á¢∫ÁéáÁôæÂàÜÊØî
                                correctCount = Math.round((baseScore / 100) * questions.length);
                                console.log(`[CSV Statistics] ‚úÖ Using Firestore scores for ${student.name}: baseScore=${baseScore}, totalScore=${totalScore}`);
                            } else {
                                // Êú¨Âú∞Ë®àÁÆóÔºàÂ≠∏ÁîüÂâõÊèê‰∫§ÊôÇÔºåFirestore Â∞öÊú™Ë¢´ÊïôÂ∏´Êõ¥Êñ∞Ôºâ
                                accuracy = Math.round((correctCount / questions.length) * 100);
                                baseScore = accuracy;
                                highlightBonus = (student.highlightAnalysis && student.highlightAnalysis.score) || 0;
                                totalScore = baseScore + highlightBonus;
                            }
                            
                            rankedStudents.push({
                                name: student.name,
                                correctCount: correctCount,
                                totalQuestions: questions.length,
                                accuracy: accuracy,
                                baseScore: baseScore, // üöÄ UPDATED: ÂÑ™ÂÖà‰ΩøÁî® Firestore ÂàÜÊï∏
                                highlightBonus: highlightBonus, // üöÄ NEW: Á≠ÜË®òÂä†ÂàÜ
                                totalScore: totalScore, // üöÄ UPDATED: ÂÑ™ÂÖà‰ΩøÁî® Firestore ÂàÜÊï∏
                                highlightAnalysis: student.highlightAnalysis || null, // üöÄ NEW: Á≠ÜË®òÂàÜÊûêÊï∏Êìö
                                timestamp: student.timestamp,
                                durationMs: student.durationMs || null,
                                answers: studentAnswers
                            });
                        } catch (e) {
                            console.warn('[CSV Export] Invalid answer format for student:', student.name);
                        }
                    });

                    // üöÄ UPDATED: Sort by total score (base + bonus), then duration, then timestamp
                    rankedStudents.sort((a, b) => {
                        // 1. ‰∏ªË¶ÅÊéíÂ∫èÔºöÁ∏ΩÂàÜÈ´òÁöÑÂú®ÂâçÔºàÂü∫Á§éÂàÜ+Á≠ÜË®òÂä†ÂàÜÔºâ
                        if (b.totalScore !== a.totalScore) {
                            return b.totalScore - a.totalScore;
                        }
                        // 2. Ê¨°Ë¶ÅÊéíÂ∫èÔºö‰ΩúÁ≠îÊôÇÈï∑Áü≠ÁöÑÂú®ÂâçÔºàÂêåÂàÜÊôÇÊõ¥Âø´ÂÆåÊàêÊéíÂêçÊõ¥È´òÔºâ
                        if (a.durationMs && b.durationMs) {
                            return a.durationMs - b.durationMs;
                        }
                        // Â¶ÇÊûúÂè™Êúâ‰∏ÄÊñπÊúâ‰ΩúÁ≠îÊôÇÈï∑ÔºåÊúâ‰ΩúÁ≠îÊôÇÈï∑ÁöÑÊéíÂú®ÂâçÈù¢
                        if (a.durationMs && !b.durationMs) return -1;
                        if (!a.durationMs && b.durationMs) return 1;
                        // 3. Á¨¨‰∏âÊéíÂ∫èÔºöÊèê‰∫§ÊôÇÈñìÊó©ÁöÑÂú®Ââç
                        const aTime = a.timestamp?.toMillis ? a.timestamp.toMillis() : (a.timestamp?.getTime ? a.timestamp.getTime() : 0);
                        const bTime = b.timestamp?.toMillis ? b.timestamp.toMillis() : (b.timestamp?.getTime ? b.timestamp.getTime() : 0);
                        if (aTime !== bTime) {
                            return aTime - bTime;
                        }
                        // 4. ÊúÄÂæåÊéíÂ∫èÔºöÂßìÂêçÂ≠óÊØçÈ†ÜÂ∫è
                        return a.name.localeCompare(b.name);
                    });

                    // üöÄ OPTIMIZED: Assign ranks - each student gets unique rank based on complete sorting (including duration)
                    rankedStudents.forEach((student, index) => {
                        student.rank = index + 1;
                    });

                    // Build CSV
                    csv += `Èñ±ËÆÄÊ∏¨È©óÊàêÁ∏æÁµ±Ë®à\n`;
                    csv += `ÂåØÂá∫ÊôÇÈñì,${timestamp}\n`;
                    csv += `Á∏Ω‰ΩúÁ≠î‰∫∫Êï∏,${rankedStudents.length}\n`;
                    csv += `È°åÁõÆÁ∏ΩÊï∏,${questions.length}\n`;
                    csv += `\n`;

                    // Overall statistics
                    const avgScore = rankedStudents.length > 0 
                        ? (rankedStudents.reduce((sum, s) => sum + s.correctCount, 0) / rankedStudents.length).toFixed(1)
                        : '0.0';
                    const avgAccuracy = rankedStudents.length > 0
                        ? (rankedStudents.reduce((sum, s) => sum + s.accuracy, 0) / rankedStudents.length).toFixed(1)
                        : '0.0';
                    
                    csv += `Êï¥È´îÁµ±Ë®à\n`;
                    csv += `Âπ≥ÂùáÁ≠îÂ∞çÈ°åÊï∏,${avgScore}\n`;
                    csv += `Âπ≥ÂùáÁ≠îÂ∞çÁéá,${avgAccuracy}%\n`;
                    csv += `\n`;

                    // Question-by-question statistics
                    csv += `ÂêÑÈ°åÁµ±Ë®à\n`;
                    csv += `È°åËôü,È°åÁõÆ,Ê≠£Á¢∫Á≠îÊ°à,‰ΩúÁ≠î‰∫∫Êï∏,Á≠îÂ∞ç‰∫∫Êï∏,Á≠îÂ∞çÁéá\n`;
                    questions.forEach((q, qIndex) => {
                        let correctCount = 0;
                        let answeredCount = 0;

                        rankedStudents.forEach(student => {
                            if (student.answers[qIndex] !== undefined && student.answers[qIndex] !== 0) {
                                answeredCount++;
                                // üöÄ FIX: ÊîØÊè¥ÈÄÅÂàÜÈ°åÔºàcorrectAnswer === 0 ÊôÇÁÑ°Ê¢ù‰ª∂Ë®àÁÇ∫Ê≠£Á¢∫Ôºâ
                                if ((q.correctAnswer === 0) || (String(student.answers[qIndex]) === String(q.correctAnswer))) {
                                    correctCount++;
                                }
                            } else if (q.correctAnswer === 0) {
                                // üöÄ FIX: ÈÄÅÂàÜÈ°åÊú™‰ΩúÁ≠î‰πüÁÆóÊ≠£Á¢∫Ôºà‰∏îË®àÂÖ•‰ΩúÁ≠î‰∫∫Êï∏Ôºâ
                                answeredCount++;
                                correctCount++;
                            }
                        });

                        const correctRate = answeredCount > 0 ? ((correctCount / answeredCount) * 100).toFixed(1) : '0.0';
                        const questionText = q.question.length > 50 ? q.question.substring(0, 50) + '...' : q.question;
                        csv += `${qIndex + 1},"${questionText}",ÈÅ∏È†Ö${q.correctAnswer},${answeredCount},${correctCount},${correctRate}%\n`;
                    });

                    csv += `\n`;

                    // Student detailed records (sorted by rank) - üöÄ NEW: Âä†ÂÖ•Á≠ÜË®òÂä†ÂàÜÂàó
                    csv += `Â≠∏ÁîüÊàêÁ∏æÊéíÂêç\n`;
                    csv += `ÊéíÂêç,Â≠∏ÁîüÂßìÂêç,Á∏ΩÂàÜ,Âü∫Á§éÂàÜ,Á≠ÜË®òÂä†ÂàÜ,Á≠îÂ∞çÈ°åÊï∏,Á≠îÂ∞çÁéá,‰ΩúÁ≠îÊôÇÈï∑,Êèê‰∫§ÊôÇÈñì`;
                    questions.forEach((q, qIndex) => {
                        csv += `,Q${qIndex + 1}`;
                    });
                    csv += `\n`;

                    rankedStudents.forEach(student => {
                        const answerTime = student.timestamp 
                            ? (student.timestamp.toDate ? student.timestamp.toDate().toLocaleString('zh-TW') : new Date(student.timestamp).toLocaleString('zh-TW'))
                            : 'Êú™Áü•';
                        
                        // Format duration
                        let durationText = 'Êú™Ë®òÈåÑ';
                        if (student.durationMs) {
                            const duration = formatDuration(student.durationMs);
                            durationText = duration.longLabel.replace('‰ΩúÁ≠î ', '');
                        }

                        // üöÄ NEW: Ëº∏Âá∫Á∏ΩÂàÜ„ÄÅÂü∫Á§éÂàÜ„ÄÅÁ≠ÜË®òÂä†ÂàÜ
                        csv += `${student.rank},${student.name},${Math.round(student.totalScore)},${student.baseScore},${student.highlightBonus},${student.correctCount}/${student.totalQuestions},${student.accuracy}%,${durationText},${answerTime}`;
                        
                        // Add each question's answer and result
                        questions.forEach((q, qIndex) => {
                            const studentAns = student.answers[qIndex];
                            if (studentAns && studentAns !== 0) {
                                // üöÄ FIX: ÊîØÊè¥ÈÄÅÂàÜÈ°åÔºàcorrectAnswer === 0 ÊôÇÁÑ°Ê¢ù‰ª∂ÁÆóÁÇ∫Ê≠£Á¢∫Ôºâ
                                const isCorrect = (q.correctAnswer === 0) || (String(studentAns) === String(q.correctAnswer)) ? '‚úì' : '‚úó';
                                csv += `,ÈÅ∏È†Ö${studentAns}${isCorrect}`;
                            } else {
                                csv += `,Êú™‰ΩúÁ≠î`;
                            }
                        });
                        csv += `\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = generateFilename('Èñ±ËÆÄÊ∏¨È©óÊàêÁ∏æÁµ±Ë®à', 'csv');
                    link.click();

                    showMessage('Èñ±ËÆÄÊ∏¨È©óÊàêÁ∏æÁµ±Ë®àÂ∑≤‰∏ãËºâÔºÅ', 'success');
                } else {
                    showMessage('ÁÑ°Èñ±ËÆÄÊ∏¨È©óÈ°åÁõÆË≥áÊñô', 'info');
                }
            } else {
                showMessage('Ê≠§Ê®°Âºè‰∏çÊîØÊè¥Áµ±Ë®à‰∏ãËºâ', 'info');
            }
        }

        /**
         * Student submits a vote
         */
        async function submitQuickPollVote(option) {
            if (!classroomCode || !studentName) return;

            const pollKey = `quickPoll_${classroomCode}_${quickPollData.timestamp}`;

            // Check if already voted (using localStorage)
            if (localStorage.getItem(pollKey)) {
                showMessage('ÊÇ®Â∑≤Á∂ìÊäïÈÅéÁ•®‰∫ÜÔºÅ', 'info');
                return;
            }

            try {
                // Generate unique vote ID (anonymous or with student name based on settings)
                const voteId = quickPollData.anonymous
                    ? `anonymous_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                    : `${studentName}_${Date.now()}`;

                const voteRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPollVotes', voteId);
                const voteData = {
                    option,
                    timestamp: Date.now()
                };

                // Add student name if not anonymous
                if (!quickPollData.anonymous) {
                    voteData.studentName = studentName;
                }

                await setDoc(voteRef, voteData);

                // Mark as voted in localStorage
                localStorage.setItem(pollKey, 'true');

                // Hide options, show success message
                document.getElementById('quick-poll-options-container').classList.add('hidden');
                document.getElementById('quick-poll-voted-status').classList.remove('hidden');

                showMessage('ÊäïÁ•®ÊàêÂäüÔºÅÊÑüË¨ùÊÇ®ÁöÑÂèÉËàá', 'success');
            } catch (error) {
                console.error('Error submitting vote:', error);
                showMessage('ÊäïÁ•®Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
            }
        }

        /**
         * Displays quick poll for students
         */
        function displayQuickPollForStudent(pollData) {
            if (!pollData || !pollData.active) return;

            quickPollData = pollData;

            // Use timestamp to create unique key for each poll session
            const pollKey = `quickPoll_${classroomCode}_${pollData.timestamp}`;
            const hasVoted = localStorage.getItem(pollKey);

            // Display question
            document.getElementById('quick-poll-question-display').textContent = pollData.question;

            const optionsContainer = document.getElementById('quick-poll-options-container');
            optionsContainer.innerHTML = '';

            if (hasVoted) {
                // Already voted - show success message
                optionsContainer.classList.add('hidden');
                document.getElementById('quick-poll-voted-status').classList.remove('hidden');
            } else {
                // Not voted yet - show options
                optionsContainer.classList.remove('hidden');
                document.getElementById('quick-poll-voted-status').classList.add('hidden');

                // Create buttons based on poll type
                if (pollData.pollType === 'emoji') {
                    optionsContainer.className = 'flex justify-center gap-6';
                    pollData.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'text-8xl hover:scale-110 transition-transform duration-200 p-4 rounded-lg hover:bg-gray-100';
                        btn.textContent = opt;
                        btn.addEventListener('click', () => submitQuickPollVote(opt));
                        optionsContainer.appendChild(btn);
                    });
                } else if (pollData.pollType === 'rating5' || pollData.pollType === 'rating10') {
                    optionsContainer.className = 'flex justify-center gap-3 flex-wrap';
                    pollData.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn bg-lime-500 hover:bg-lime-600 !w-20 !h-20 text-4xl font-bold';
                        btn.textContent = opt;
                        btn.addEventListener('click', () => submitQuickPollVote(opt));
                        optionsContainer.appendChild(btn);
                    });
                } else {
                    optionsContainer.className = 'space-y-3';
                    pollData.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn bg-lime-500 hover:bg-lime-600 w-full h-16 text-2xl';
                        btn.textContent = opt;
                        btn.addEventListener('click', () => submitQuickPollVote(opt));
                        optionsContainer.appendChild(btn);
                    });
                }
            }
        }

        /**
         * Listens for quick poll configuration changes (for students)
         */
        function listenToQuickPollConfig() {
            if (!classroomCode) return;

            const pollRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'quickPoll', 'config');
            onSnapshot(pollRef, (doc) => {
                if (doc.exists()) {
                    const pollData = doc.data();
                    if (pollData.active && currentRole === 'student' && currentInteractionMode === 'quick_poll') {
                        displayQuickPollForStudent(pollData);
                    }
                }
            });
        }

        // === Reading Comprehension Functions ===

        /**
         * Show reading comprehension settings modal
         */
        function showReadingComprehensionModal() {
            document.getElementById('reading-comprehension-settings-modal').classList.remove('hidden');
            // Populate with existing data if any
            document.getElementById('reading-text-textarea').value = readingComprehensionData.text || '';
            if (readingComprehensionData.questions && readingComprehensionData.questions.length > 0) {
                document.getElementById('reading-questions-textarea').value = readingComprehensionData.questions.map(q => {
                    return `${q.question},${q.correctAnswer},${q.options.join(',')},${q.level}`;
                }).join('\n');
            } else {
                document.getElementById('reading-questions-textarea').value = '';
            }
        }

        /**
         * Hide reading comprehension settings modal
         */
        function hideReadingComprehensionModal() {
            document.getElementById('reading-comprehension-settings-modal').classList.add('hidden');
        }

        /**
         * Parse reading comprehension questions
         * Supports both comma and tab delimiters
         */
        function parseReadingQuestions(text) {
            const lines = text.trim().split('\n').filter(line => line.trim().length > 0);
            const questions = [];

            for (const line of lines) {
                // Try to detect delimiter: if line contains tab, use tab; otherwise use comma
                const delimiter = line.includes('\t') ? '\t' : ',';
                const parts = line.split(delimiter).map(p => p.trim());

                if (parts.length < 6) {
                    return null; // Invalid format - need at least question, answer, and 4 options
                }

                const question = parts[0];
                let correctAnswer = parts[1];
                const options = [parts[2], parts[3], parts[4], parts[5]];
                // Level is optional, default to 1 if not provided
                const level = parts[6] ? parseInt(parts[6]) : 1;

                // Convert A-D to 1-4
                if (correctAnswer.match(/^[A-Da-d]$/)) {
                    correctAnswer = correctAnswer.toUpperCase().charCodeAt(0) - 64; // A=1, B=2, C=3, D=4
                } else {
                    correctAnswer = parseInt(correctAnswer);
                }

                if (!question || isNaN(correctAnswer) || correctAnswer < 1 || correctAnswer > 4 ||
                    options.length !== 4 || isNaN(level) || level < 1 || level > 4) {
                    return null; // Invalid format
                }

                questions.push({ question, correctAnswer, options, level });
            }

            return questions.length > 0 ? questions : null;
        }

        /**
         * Start reading comprehension interaction
         */
        async function startReadingComprehension() {
            console.log('[startReadingComprehension] ‚úì Button clicked - function initiated');
            
            const readingText = document.getElementById('reading-text-textarea').value.trim();
            const questionsText = document.getElementById('reading-questions-textarea').value.trim();
            console.log('[startReadingComprehension] Text length:', readingText.length, 'Questions length:', questionsText.length);

            if (!readingText || !questionsText) {
                console.warn('[startReadingComprehension] ‚ö†Ô∏è Missing text or questions');
                showMessage('Ë´ãËº∏ÂÖ•Èñ±ËÆÄÊñáÊú¨ÂíåÈ°åÁõÆÔºÅ', 'error');
                return;
            }

            const questions = parseReadingQuestions(questionsText);
            if (!questions) {
                console.warn('[startReadingComprehension] ‚ö†Ô∏è Question parsing failed');
                document.getElementById('reading-questions-status').classList.remove('hidden');
                return;
            }

            console.log('[startReadingComprehension] ‚úì Questions parsed successfully:', questions.length, 'questions');
            readingComprehensionData = { text: readingText, questions: questions };
            
            // üöÄ CRITICAL FIX: Reset teacher highlight content hash when loading new article
            lastViewedReadingContentHash = null;
            console.log('[startReadingComprehension] ‚úì Teacher highlight hash reset for new content');
            
            document.getElementById('reading-questions-status').classList.add('hidden');
            
            console.log('[startReadingComprehension] ‚úì Hiding modal...');
            hideReadingComprehensionModal();

            // Set mode and dispatch to Firebase
            const mode = 'reading_comprehension';
            try {
                console.log('[startReadingComprehension] ‚úì Calling setInteractionMode with reading data...');
                await setInteractionMode(mode, { readingData: readingComprehensionData });
                console.log('[startReadingComprehension] ‚úì setInteractionMode completed successfully');
                
                // üöÄ OPTIMIZED: ÊïôÂ∏´Á´ØÊáâÈ°ØÁ§∫Áõ£ÊéßË¶ñÂúñÔºå‰∏çÊòØÂ≠∏ÁîüËÆÄÈ°åË¶ñÂúñ
                console.log('[startReadingComprehension] ‚úì Showing teacherMonitor view...');
                showView('teacherMonitor');
                console.log('[startReadingComprehension] ‚úÖ COMPLETE - Teacher monitor view displayed');
            } catch (error) {
                console.error('[startReadingComprehension] ‚ùå ERROR during setInteractionMode:', error);
                showMessage('ÂïüÂãï‰∫íÂãïÊôÇÂá∫ÈåØÔºö' + error.message, 'error');
            }
        }

        /**
         * Display reading comprehension for student
         */
        async function displayReadingComprehensionForStudent(readingData) {
            console.log('[displayReadingComprehensionForStudent] Called with data:', readingData);
            const textDisplay = document.getElementById('reading-text-display');
            const questionsContainer = document.getElementById('reading-questions-container');

            if (!textDisplay || !questionsContainer) {
                console.error('[displayReadingComprehensionForStudent] Elements not found!');
                return;
            }

            // üöÄ CRITICAL FIX: ÁÑ°Ê¢ù‰ª∂Ê∏ÖÈô§ÊâÄÊúâÁÅ∞Ëâ≤ÈÅ∏È†ÖÂíåÁ∂†Ëâ≤Ê°ÜÊ°ÜÔºàÈáçÊñ∞ÈñãÂßãÊàñÊñ∞ÊúÉË©±ÈÉΩÈúÄË¶ÅÔºâ
            console.log('[displayReadingComprehensionForStudent] Clearing all gray and green styles from options');
            const allRadios = questionsContainer.querySelectorAll('input[type="radio"]');
            allRadios.forEach(radio => {
                radio.disabled = false;
            });
            const allLabels = questionsContainer.querySelectorAll('label');
            allLabels.forEach(label => {
                label.classList.remove('opacity-50', 'bg-green-100', 'border-green-400', 'border-2');
            });

            // üöÄ FIX: Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫Êñ∞ÁöÑÈñ±ËÆÄÊ∏¨È©óÊúÉË©±
            // ÊØîËºÉÂÆåÊï¥ÁöÑÈ°åÁõÆÂÖßÂÆπÔºàÂåÖÊã¨ÂïèÈ°å„ÄÅÈÅ∏È†Ö„ÄÅÊ≠£Á¢∫Á≠îÊ°àÔºâ‰ª•ÈÅøÂÖçË™§Âà§
            let isNewSession = false;
            if (!readingComprehensionData) {
                isNewSession = true;
            } else if (readingComprehensionData.questions.length !== readingData.questions.length ||
                      readingComprehensionData.text !== readingData.text) {
                isNewSession = true;
            } else {
                // Ê∑±Â∫¶ÊØîËºÉÈ°åÁõÆÂÖßÂÆπ
                for (let i = 0; i < readingData.questions.length; i++) {
                    const oldQ = readingComprehensionData.questions[i];
                    const newQ = readingData.questions[i];
                    if (oldQ.question !== newQ.question ||
                        oldQ.correctAnswer !== newQ.correctAnswer ||
                        JSON.stringify(oldQ.options) !== JSON.stringify(newQ.options)) {
                        isNewSession = true;
                        break;
                    }
                }
            }
            
            if (isNewSession) {
                console.log('[displayReadingComprehensionForStudent] New session detected, clearing previous answers');
                currentReadingAnswers = [];
                
                // üöÄ CRITICAL FIX: Ê∏ÖÈô§ÊâÄÊúâÈÅ∏È†ÖÁöÑÁÅ∞Ëâ≤ÁãÄÊÖãÂíåÁ¶ÅÁî®ÁãÄÊÖãÔºåÊÅ¢Âæ©ÁÇ∫ÂéüÂßãÈªëËâ≤
                console.log('[displayReadingComprehensionForStudent] Clearing gray state for all options');
                // ÈÄôÂ∞áÂú®‰∏ãÈù¢ÁöÑ forEach ‰∏≠Ê≠£Á¢∫Âü∑Ë°åÔºåÂõ†ÁÇ∫ answersToRestore ÁèæÂú®ÊòØÁ©∫ÁöÑ
            }

            // Store reading data for student to use when submitting
            if (currentRole === 'student') {
                readingComprehensionData = readingData;
            }

            // üöÄ NEW: Parse Markdown bold formatting before displaying
            textDisplay.innerHTML = parseMarkdownBold(readingData.text);
            questionsContainer.innerHTML = '';
            console.log('[displayReadingComprehensionForStudent] Set text:', readingData.text);
            
            // üöÄ NEW: Ë®àÁÆó‰∏¶È°ØÁ§∫ÊñáÁ´†Â≠óÊï∏
            const wordCount = readingData.text.replace(/\s/g, '').length; // ÁßªÈô§ÊâÄÊúâÁ©∫ÁôΩÂ≠óÁ¨¶ÂæåË®àÁÆóÂ≠óÊï∏
            const wordCountDisplay = document.getElementById('reading-word-count');
            if (wordCountDisplay) {
                wordCountDisplay.textContent = `ÂÖ± ${wordCount} Â≠ó`;
            }
            
            // üöÄ NEW: ÂàùÂßãÂåñËû¢ÂÖâÁ≠ÜÂäüËÉΩÔºàÂ≠∏ÁîüÁ´ØÔºâ
            if (currentRole === 'student') {
                console.log('[displayReadingComprehensionForStudent] Initializing highlighter');
                HighlighterManager.init();
                
                // Â¶ÇÊûúÊòØÊñ∞ÊúÉË©±ÔºåÊ∏ÖÈô§ËàäÁöÑÊ®ôË®ª
                if (isNewSession) {
                    HighlighterManager.reset();
                } else {
                    // ÊÅ¢Âæ©‰πãÂâçÁöÑÊ®ôË®ª
                    setTimeout(() => {
                        HighlighterManager.restoreHighlights();
                    }, 100); // Âª∂ÈÅ≤100msÁ¢∫‰øùDOMÂ∑≤ÂÆåÂÖ®Êõ¥Êñ∞
                }
            }

            // Determine which answers to restore and check submission status
            let answersToRestore = [];
            let hasSubmittedToFirebase = false;

            // Priority 1: Use current local answers (not yet submitted)
            if (currentReadingAnswers.length > 0 && !isNewSession) {
                answersToRestore = currentReadingAnswers;
                console.log('[displayReadingComprehensionForStudent] Restoring local answers:', answersToRestore);
            }
            // Priority 2: Check if student has already submitted answers to Firebase
            // üöÄ OPTIMIZED: Â¶ÇÊûúÊòØÊñ∞ÊúÉË©±Ôºå‰∏çÊ™¢Êü• FirebaseÔºåÁõ¥Êé•ÂÖÅË®±ÈáçÊñ∞‰ΩúÁ≠î
            else if (!isNewSession && currentRole === 'student' && studentName && classroomCode) {
                try {
                    const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
                    const docSnap = await getDoc(studentRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Check if answer is a JSON string or array
                        if (typeof data.answer === 'string') {
                            try {
                                const parsed = JSON.parse(data.answer);
                                if (Array.isArray(parsed) && parsed.length > 0) {
                                    answersToRestore = parsed;
                                    hasSubmittedToFirebase = true;
                                }
                            } catch (e) {
                                answersToRestore = [];
                            }
                        } else if (Array.isArray(data.answer) && data.answer.length > 0) {
                            answersToRestore = data.answer;
                            hasSubmittedToFirebase = true;
                        }
                        console.log('[displayReadingComprehensionForStudent] Restoring submitted answers:', answersToRestore, 'hasSubmitted:', hasSubmittedToFirebase);
                    }
                } catch (error) {
                    console.error('Error fetching previous answers:', error);
                }
            }

            // Initialize currentReadingAnswers if empty
            if (currentReadingAnswers.length === 0) {
                currentReadingAnswers = new Array(readingData.questions.length).fill(0);
            }

            readingData.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-white p-4 rounded-lg border';

                // Get answer for this question (if exists)
                const selectedAnswer = answersToRestore[index] || 0;

                // üöÄ FIX: Ê™¢Êü•È°åÁõÆÊòØÂê¶Â∑≤ÂåÖÂê´È°åËôüÔºàÈò≤Ê≠¢ÈáçË§áÈ°ØÁ§∫Â¶Ç "1. 1. ..."Ôºâ
                // Â¶ÇÊûúÈ°åÁõÆ‰ª• "X. " ÈñãÈ†≠ÔºàÂÖ∂‰∏≠XÊòØÊï∏Â≠óÔºâÔºåÂâáÁõ¥Êé•‰ΩøÁî®È°åÁõÆÔºõÂê¶ÂâáÊ∑ªÂä†È°åËôü
                const questionText = q.question.trim();
                const hasQuestionNumber = /^\d+\.\s/.test(questionText);
                const displayQuestionText = hasQuestionNumber ? questionText : `${index + 1}. ${questionText}`;
                
                // üöÄ NEW: ‰ΩøÁî® parseMarkdownBold ÊîØÊè¥ Markdown Á≤óÈ´îÊ†ºÂºè
                const parsedQuestionText = parseMarkdownBold(displayQuestionText);
                const parsedOptions = q.options.map(opt => parseMarkdownBold(opt));

                questionDiv.innerHTML = `
                    <p class="font-bold text-lg mb-3">${parsedQuestionText}</p>
                    <div class="space-y-2">
                        ${parsedOptions.map((parsedOpt, i) => {
                            // üöÄ FIX: Ê™¢Êü•ÈÅ∏È†ÖÊòØÂê¶Â∑≤ÂåÖÂê´ÈÅ∏È†ÖËôüÔºàÈò≤Ê≠¢ÈáçË§áÈ°ØÁ§∫Â¶Ç "A. A. ..." Êàñ "1. 1. ..."Ôºâ
                            const optText = q.options[i].trim();
                            const hasOptNumber = /^[A-Z1-9]\.\s/.test(optText);
                            const displayOptText = hasOptNumber ? optText : `${i + 1}. ${optText}`;
                            const parsedDisplayOpt = parseMarkdownBold(displayOptText);
                            
                            const isChecked = selectedAnswer === (i + 1) ? 'checked' : '';
                            return `
                            <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="radio" name="reading_q${index}" value="${i + 1}" class="mr-3" ${isChecked} data-question-index="${index}">
                                <span>${parsedDisplayOpt}</span>
                            </label>
                        `}).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });

            // Add event listeners to track answer changes
            const radioInputs = questionsContainer.querySelectorAll('input[type="radio"]');
            radioInputs.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const questionIndex = parseInt(e.target.dataset.questionIndex);
                    const selectedValue = parseInt(e.target.value);
                    currentReadingAnswers[questionIndex] = selectedValue;
                    console.log('[Reading] Answer updated:', questionIndex, '=', selectedValue);
                    
                    // üöÄ NEW: Êõ¥Êñ∞È°åÁõÆÈÄ≤Â∫¶È°ØÁ§∫
                    updateReadingQuestionProgress();
                });
            });
            
            // üöÄ NEW: ÂàùÂßãÂåñÈ°åÁõÆÈÄ≤Â∫¶È°ØÁ§∫
            updateReadingQuestionProgress();
            
            // üöÄ FIX: Â¶ÇÊûúÂ≠∏ÁîüÂ∑≤Á∂ìÊèê‰∫§Á≠îÊ°àÂà∞ Firebase ‰∏î‰∏çÊòØÊñ∞ÊúÉË©±ÔºåÊÅ¢Âæ©ÈéñÂÆöÁãÄÊÖã
            if (hasSubmittedToFirebase && !isNewSession) {
                console.log('[displayReadingComprehensionForStudent] Student has submitted, applying lock');
                const submitBtn = document.getElementById('submit-reading-btn');
                submitBtn.disabled = true;
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-gray');
                submitBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                
                // Á¶ÅÁî®ÊâÄÊúâÈÅ∏È†Ö
                const allRadios = questionsContainer.querySelectorAll('input[type="radio"]');
                allRadios.forEach(radio => {
                    radio.disabled = true;
                });
                
                // ÁÇ∫Â∑≤ÈÅ∏ÊìáÁöÑÁ≠îÊ°àÊ∑ªÂä†Ë¶ñË¶∫Ê®ôË®ò
                const allLabels = questionsContainer.querySelectorAll('label');
                allLabels.forEach(label => {
                    const radio = label.querySelector('input[type="radio"]');
                    if (radio && radio.checked) {
                        label.classList.add('bg-green-100', 'border-green-400', 'border-2');
                    } else if (radio) {
                        label.classList.add('opacity-50');
                    }
                });
                
                // üöÄ NEW: Ë®≠ÁΩÆÂØ¶ÊôÇÁõ£ËÅΩÂô®Áõ£ËÅΩÊàêÁ∏æËÆäÂåñÔºàÁï∂Â≠∏ÁîüÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢ÊôÇÔºâ
                setupStudentScoreListener();
            } else {
                // üöÄ CRITICAL FIX: Á¢∫‰øùÈáçÊñ∞ÈñãÂßãÊàñÂÖ∂‰ªñÊÉÖÊ≥ÅÊôÇÊâÄÊúâÈÅ∏È†ÖÈÉΩÊòØÈªëËâ≤‰∏îÂèØ‰∫íÂãï
                console.log('[displayReadingComprehensionForStudent] Ensuring all options are enabled and black (non-new session)');
                const allRadios = questionsContainer.querySelectorAll('input[type="radio"]');
                allRadios.forEach(radio => {
                    radio.disabled = false;
                });
                const allLabels = questionsContainer.querySelectorAll('label');
                allLabels.forEach(label => {
                    label.classList.remove('opacity-50', 'bg-green-100', 'border-green-400', 'border-2');
                });
            }
            
            // üöÄ CRITICAL FIX: ÁÑ°Ê¢ù‰ª∂ÈáçÊñ∞Ë®≠ÁΩÆ180ÁßíÂÄíË®àÊôÇÔºàÁÑ°Ë´ñÊñ∞ÊúÉË≠∞ÈÇÑÊòØÈáçÊñ∞ÈñãÂßãÔºâÔºåÊâÄÊúâÂ≠∏ÁîüÁµ±‰∏ÄÂæûÊúçÂãôÂô®ÊôÇÈñìÈñãÂßã
            console.log('[displayReadingComprehensionForStudent] Setting up/resetting 3-minute (180-second) countdown timer');
            console.log('[displayReadingComprehensionForStudent] readingData object:', readingData);
            const submitBtn = document.getElementById('submit-reading-btn');
            const startTime = readingData.startedAt;
            console.log('[displayReadingComprehensionForStudent] ‚è∞ startTime value:', startTime, 'type:', typeof startTime, 'constructor:', startTime?.constructor?.name);
            
            if (startTime) {
                // Á¶ÅÁî®Êèê‰∫§ÊåâÈàïÔºåÁõ¥Âà∞180ÁßíÈÅéÂéª
                submitBtn.disabled = true;
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-gray');
                submitBtn.textContent = '‚è≥ Ê†°Ê∫ñË®àÊôÇÂô®‰∏≠...';
                console.log('[Timer] ‚è∞ startTime object:', startTime, 'type:', typeof startTime);
                
                // üöÄ CRITICAL FIX: Âú®ÂïüÂãïË®àÊôÇÂô®ÂâçÔºåÂÖàÁ≠âÂæÖÊôÇÈñìÂêåÊ≠•ÂÆåÊàê
                // ÈÄôÁ¢∫‰øùÁ¨¨‰∏ÄÊ¨° elapsedMs Ë®àÁÆó‰ΩøÁî®Ê≠£Á¢∫ÁöÑÂÅèÁßªÈáè
                const startCountdownAfterSync = async () => {
                    // üöÄ FIX: ÊçïÁç≤Áï∂Ââç Promise ÂØ¶‰æãÔºåÈÅøÂÖç Promise Ë¢´ÈáçÂØ´ÂæåÁÑ°Ê≥ï resolve
                    const currentSyncPromise = window.serverTimeSyncPromise;
                    
                    // Á≠âÂæÖÊôÇÈñìÂêåÊ≠•ÂÆåÊàêÔºàÂ¶ÇÊûú Promise Â≠òÂú®Ôºâ
                    if (currentSyncPromise) {
                        console.log('[Timer] ‚è≥ Á≠âÂæÖÊôÇÈñìÂêåÊ≠• Promise...');
                        try {
                            const syncResult = await Promise.race([
                                currentSyncPromise,
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Sync timeout')), 5000))
                            ]);
                            console.log('[Timer] ‚úÖ ÊôÇÈñìÂêåÊ≠•ÂÆåÊàê:', syncResult);
                        } catch (error) {
                            console.warn('[Timer] ‚ö†Ô∏è ÊôÇÈñìÂêåÊ≠•Ë∂ÖÊôÇÊàñÂ§±Êïó:', error.message);
                            // Ë®≠ÁΩÆÈôçÁ¥öÂÄº
                            if (!window.serverTimeOffsetReady) {
                                window.serverTimeOffset = 0;
                                window.serverTimeOffsetReady = true;
                                showMessage('‚ö†Ô∏è Ë®àÊôÇÂô®Ê†°Ê∫ñË∂ÖÊôÇÔºå‰ΩøÁî®Êú¨Âú∞ÊôÇÈñì', 'warning');
                            }
                        }
                    } else if (!window.serverTimeOffsetReady) {
                        // Ê≤íÊúâ Promise ‰∏îÂÅèÁßªÈáèÊú™Â∞±Á∑íÔºåÁ≠âÂæÖ‰∏ÄÊÆµÊôÇÈñì
                        console.log('[Timer] ‚è≥ Á≠âÂæÖ serverTimeOffsetReady Ê®ôË™å...');
                        for (let i = 0; i < 10; i++) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                            if (window.serverTimeOffsetReady) {
                                console.log('[Timer] ‚úÖ ÂÅèÁßªÈáèÂ∑≤Â∞±Á∑í');
                                break;
                            }
                        }
                        if (!window.serverTimeOffsetReady) {
                            console.warn('[Timer] ‚ö†Ô∏è Á≠âÂæÖÂÅèÁßªÈáèË∂ÖÊôÇÔºå‰ΩøÁî®Êú¨Âú∞ÊôÇÈñì');
                            window.serverTimeOffset = 0;
                            window.serverTimeOffsetReady = true;
                            showMessage('‚ö†Ô∏è Ë®àÊôÇÂô®Ê†°Ê∫ñË∂ÖÊôÇÔºå‰ΩøÁî®Êú¨Âú∞ÊôÇÈñì', 'warning');
                        }
                    }
                    
                    // ÁèæÂú®ÂÅèÁßªÈáèÂ∑≤Â∞±Á∑íÔºåÂïüÂãïË®àÊôÇÂô®
                    console.log('[Timer] üïê ÂÅèÁßªÈáè:', window.serverTimeOffset, 'ms (', ((window.serverTimeOffset || 0) / 1000).toFixed(1), 'Áßí)');
                    
                    // ÂïüÂãïÂÄíË®àÊôÇÊõ¥Êñ∞
                    let firstLogPrinted = false;
                    const serverOffset = window.serverTimeOffset || 0;
                    
                    const updateCountdown = () => {
                        // ‰ΩøÁî®Â∑≤Á¢∫ÂÆöÁöÑÂÅèÁßªÈáèÊ†°Ê≠£Êú¨Âú∞ÊôÇÈñì
                        const localNow = Date.now();
                        const now = localNow + serverOffset; // Ê†°Ê≠£ÂæåÁöÑ„Äå‰º∫ÊúçÂô®Á≠âÊïàÊôÇÈñì„Äç
                        
                        let startTimeMs;
                        // üöÄ ROBUST: ÂÆâÂÖ®Âú∞ËΩâÊèõ startTime ÁÇ∫ÊØ´Áßí - ÊîØÊè¥Â§öÁ®ÆFirestoreÊôÇÈñìÊà≥Ê†ºÂºè
                        if (startTime instanceof Date) {
                            startTimeMs = startTime.getTime();
                            if (!firstLogPrinted) { console.log('[Timer] ‚úì Type: Date object, startTimeMs:', startTimeMs, 'ISO:', new Date(startTimeMs).toISOString()); }
                        } else if (typeof startTime === 'object' && startTime !== null && startTime.toDate && typeof startTime.toDate === 'function') {
                            // Firestore Timestamp Áâ©‰ª∂
                            startTimeMs = startTime.toDate().getTime();
                            if (!firstLogPrinted) { console.log('[Timer] ‚úì Type: Firestore Timestamp (toDate), startTimeMs:', startTimeMs, 'ISO:', new Date(startTimeMs).toISOString()); }
                        } else if (typeof startTime === 'object' && startTime !== null && startTime.toMillis && typeof startTime.toMillis === 'function') {
                            // Âè¶‰∏ÄÁ®Æ Firestore Timestamp Ê†ºÂºè
                            startTimeMs = startTime.toMillis();
                            if (!firstLogPrinted) { console.log('[Timer] ‚úì Type: Firestore Timestamp (toMillis), startTimeMs:', startTimeMs, 'ISO:', new Date(startTimeMs).toISOString()); }
                        } else if (typeof startTime === 'number') {
                            startTimeMs = startTime;
                            if (!firstLogPrinted) { console.log('[Timer] ‚úì Type: Number (ms), startTimeMs:', startTimeMs, 'ISO:', new Date(startTimeMs).toISOString()); }
                        } else {
                            console.error('[Timer] ‚ùå CRITICAL: Cannot convert startTime to milliseconds!', 'startTime:', startTime, 'type:', typeof startTime, 'keys:', Object.keys(startTime || {}));
                            startTimeMs = now; // ÈôçÁ¥öÔºö‰ΩøÁî®Áï∂ÂâçÊôÇÈñì
                            if (!firstLogPrinted) { console.log('[Timer] ‚ö†Ô∏è Fallback: using current time, will show 3:00'); }
                        }
                        const elapsedMs = now - startTimeMs;
                        const remainingMs = 180000 - elapsedMs; // 3ÂàÜÈêò = 180Áßí = 180000ms
                        
                        // È¶ñÊ¨°ÊâìÂç∞Ë©≥Á¥∞Êó•Ë™åÔºàÂåÖÂê´ÊôÇÈñìÂêåÊ≠•‰ø°ÊÅØÔºâ
                        if (!firstLogPrinted) {
                            console.log('[Timer] üïê ÊôÇÈñìÂêåÊ≠•Ë®àÁÆó:');
                            console.log('[Timer]   - Êú¨Âú∞ÊôÇÈñì:', new Date(localNow).toISOString());
                            console.log('[Timer]   - ÂÅèÁßªÈáè:', serverOffset, 'ms');
                            console.log('[Timer]   - Ê†°Ê≠£ÂæåÊôÇÈñì:', new Date(now).toISOString());
                            console.log('[Timer]   - ÈñãÂßãÊôÇÈñì:', new Date(startTimeMs).toISOString());
                            console.log('[Timer]   - Â∑≤ÈÅéÊôÇÈñì:', elapsedMs, 'ms (', (elapsedMs / 1000).toFixed(1), 'Áßí)');
                            console.log('[Timer]   - Ââ©È§òÊôÇÈñì:', remainingMs, 'ms (', (remainingMs / 1000).toFixed(1), 'Áßí)');
                            firstLogPrinted = true;
                        }
                        
                        if (remainingMs <= 0) {
                            // 180ÁßíÂ∑≤ÈÅéÔºåÂïüÁî®Êèê‰∫§ÊåâÈàï
                            console.log('[displayReadingComprehensionForStudent] 180 seconds passed (3 minutes), enabling submit button');
                            submitBtn.disabled = false;
                            submitBtn.classList.remove('btn-gray');
                            submitBtn.classList.add('btn-primary');
                            submitBtn.textContent = 'ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è';
                            // ÂÅúÊ≠¢Ë®àÊôÇÂô®
                            if (window.readingCountdownInterval) {
                                clearInterval(window.readingCountdownInterval);
                                window.readingCountdownInterval = null;
                            }
                        } else {
                            // ÈÇÑÈúÄË¶ÅÁ≠âÂæÖÔºåÊõ¥Êñ∞ÂÄíË®àÊôÇÈ°ØÁ§∫
                            const totalSeconds = Math.ceil(remainingMs / 1000);
                            const minutes = Math.floor(totalSeconds / 60);
                            const seconds = totalSeconds % 60;
                            submitBtn.textContent = `‚è≥ Ë´ãÂÖàÈñ±ËÆÄ... (${minutes}:${seconds.toString().padStart(2, '0')})`;
                        }
                    };
                    
                    // Á´ãÂç≥Âü∑Ë°å‰∏ÄÊ¨°
                    updateCountdown();
                    
                    // Ê∏ÖÈô§ËàäÁöÑË®àÊôÇÂô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                    if (window.readingCountdownInterval) {
                        clearInterval(window.readingCountdownInterval);
                    }
                    
                    // ÊØè500msÊõ¥Êñ∞‰∏ÄÊ¨°ÂÄíË®àÊôÇ
                    window.readingCountdownInterval = setInterval(updateCountdown, 500);
                };
                
                // üöÄ CRITICAL: Á´ãÂç≥Ë™øÁî®Áï∞Ê≠•ÂáΩÊï∏ÂïüÂãïË®àÊôÇÂô®
                startCountdownAfterSync();
            } else {
                // Â¶ÇÊûúÊ≤íÊúâ startedAt ÊôÇÈñìÔºåÁõ¥Êé•ÂïüÁî®ÔºàÂêëÂæåÁõ∏ÂÆπÔºâ
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-gray');
                submitBtn.classList.add('btn-primary');
                submitBtn.textContent = 'ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è';
            }
            
            // üöÄ OPTIMIZATION: ÊâãÂãïËß∏ÁôºÊéíË°åÊ¶úÊõ¥Êñ∞ÔºàÈò≤Ê≠¢È°åÁõÆÊõ¥Êñ∞ÊôÇÊéíË°åÊ¶ú‰∏çÂà∑Êñ∞Ôºâ
            // ÈÄôÁ¢∫‰øù‰∫ÜÂç≥‰ΩøÊ≤íÊúâÊñ∞ÁöÑÂ≠∏Áîü‰ΩúÁ≠îÔºåÊéíË°åÊ¶ú‰πüÊúÉÂèçÊò†ÊúÄÊñ∞ÁöÑÈ°åÁõÆÊï∏Êìö
            if (currentRole === 'student' && classroomCode) {
                const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                getDocs(studentsColRef).then(querySnapshot => {
                    const studentsData = [];
                    querySnapshot.forEach(doc => {
                        studentsData.push(doc.data());
                    });
                    updateReadingLeaderboardDisplay(studentsData);
                }).catch(error => {
                    console.error('[displayReadingComprehensionForStudent] Error fetching students for leaderboard:', error);
                });
            }
        }

        /**
         * üöÄ NEW: Update reading question progress display
         */
        function updateReadingQuestionProgress() {
            const progressDisplay = document.getElementById('reading-question-progress');
            if (!progressDisplay || !readingComprehensionData || !readingComprehensionData.questions) {
                return;
            }
            
            const totalQuestions = readingComprehensionData.questions.length;
            const answeredCount = currentReadingAnswers.filter(ans => ans > 0).length;
            
            progressDisplay.textContent = `Â∑≤Á≠î ${answeredCount} / ÂÖ± ${totalQuestions} È°å`;
            
            // Â¶ÇÊûúÂÖ®ÈÉ®‰ΩúÁ≠îÔºåÂèØ‰ª•Ê∑ªÂä†Ë¶ñË¶∫ÊèêÁ§∫ÔºàÂèØÈÅ∏Ôºâ
            if (answeredCount === totalQuestions) {
                progressDisplay.classList.add('text-green-700', 'font-bold');
            } else {
                progressDisplay.classList.remove('text-green-700', 'font-bold');
            }
        }
        
        /**
         * üöÄ NEW: Initialize scroll-to-top button for reading text
         */
        function initReadingScrollToTop() {
            const textDisplay = document.getElementById('reading-text-display');
            const scrollTopBtn = document.getElementById('reading-scroll-top-btn');
            
            if (!textDisplay || !scrollTopBtn) return;
            
            // Áõ£ËÅΩÊñáÁ´†ÂçÄÂüüÁöÑÊªæÂãï‰∫ã‰ª∂
            textDisplay.addEventListener('scroll', () => {
                // Áï∂ÊªæÂãïË∂ÖÈÅé 200px ÊôÇÈ°ØÁ§∫ÊåâÈàï
                if (textDisplay.scrollTop > 200) {
                    scrollTopBtn.classList.remove('hidden');
                } else {
                    scrollTopBtn.classList.add('hidden');
                }
            });
            
            // ÈªûÊìäÊåâÈàïÂõûÂà∞È†ÇÈÉ®
            scrollTopBtn.addEventListener('click', () => {
                textDisplay.scrollTo({
                    top: 0,
                    behavior: 'smooth' // Âπ≥ÊªëÊªæÂãïÊïàÊûú
                });
            });
        }

        /**
         * üöÄ NEW: Format duration in milliseconds to readable time string
         * Returns both short and long labels for responsive display
         * @param {number} durationMs - Duration in milliseconds
         * @returns {object} { shortLabel: "2:30", longLabel: "‰ΩúÁ≠î 2ÂàÜ30Áßí" }
         */
        function formatDuration(durationMs) {
            if (!durationMs || durationMs < 0) {
                return { shortLabel: '-', longLabel: 'Êú™Ë®òÈåÑ' };
            }
            
            const totalSeconds = Math.floor(durationMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            const shortLabel = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            const longLabel = `‰ΩúÁ≠î ${minutes}ÂàÜ${seconds}Áßí`;
            
            return { shortLabel, longLabel };
        }
        
        /**
         * üöÄ NEW: Format timestamp to relative time (e.g., "3ÂàÜÈêòÂâç")
         * @param {Date|Timestamp} timestamp - Firebase timestamp or Date object
         * @returns {string} Relative time string
         */
        function formatRelativeTime(timestamp) {
            if (!timestamp) return 'Êú™Áü•ÊôÇÈñì';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSeconds < 60) {
                return 'ÂâõÂâõ';
            } else if (diffMinutes < 60) {
                return `${diffMinutes}ÂàÜÈêòÂâç`;
            } else if (diffHours < 24) {
                return `${diffHours}Â∞èÊôÇÂâç`;
            } else {
                return `${diffDays}Â§©Ââç`;
            }
        }
        
        /**
         * üöÄ NEW: Format timestamp to absolute time (e.g., "14:35:20" or "2025/11/18 14:35")
         * @param {Date|Timestamp} timestamp - Firebase timestamp or Date object
         * @param {boolean} includeDate - Whether to include date (default: false)
         * @returns {string} Formatted time string
         */
        function formatAbsoluteTime(timestamp, includeDate = false) {
            if (!timestamp) return 'Êú™Áü•ÊôÇÈñì';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            
            if (includeDate) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            }
            
            return `${hours}:${minutes}:${seconds}`;
        }

        /**
         * üöÄ NEW: Parse Markdown formatting to HTML
         * Supports:
         * - **text** ‚Üí <strong class="font-bold text-lg">text</strong>
         * - ### Ê®ôÈ°å ‚Üí <span class="block text-base font-bold mt-2">Ê®ôÈ°å</span>
         * - ## Ê®ôÈ°å ‚Üí <span class="block text-lg font-bold mt-3">Ê®ôÈ°å</span>
         * - # Ê®ôÈ°å ‚Üí <span class="block text-xl font-bold mt-4">Ê®ôÈ°å</span>
         * Only processes matched pairs, escapes HTML to prevent XSS
         */
        function parseMarkdownBold(text) {
            if (!text) return '';
            
            const escapeHtml = (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };
            
            let escaped = escapeHtml(text);
            
            escaped = escaped.replace(/^### (.+)$/gm, '<span class="block text-base font-bold mt-2 mb-1">$1</span>');
            escaped = escaped.replace(/^## (.+)$/gm, '<span class="block text-lg font-bold mt-3 mb-1">$1</span>');
            escaped = escaped.replace(/^# (.+)$/gm, '<span class="block text-xl font-bold mt-4 mb-2">$1</span>');
            
            escaped = escaped.replace(/\*\*([\s\S]+?)\*\*/g, '<strong class="font-bold text-lg">$1</strong>');
            
            return escaped;
        }

        /**
         * Submit reading comprehension answer
         */
        async function submitReadingAnswer() {
            const questionsContainer = document.getElementById('reading-questions-container');
            const submitBtn = document.getElementById('submit-reading-btn');
            
            // üöÄ FIX: Èò≤Ê≠¢ÈáçË§áÈªûÊìäÔºàÊ™¢Êü•ÊåâÈàïÊòØÂê¶Â∑≤Ë¢´Á¶ÅÁî®Ôºâ
            if (submitBtn.disabled) {
                console.log('[submitReadingAnswer] Button already disabled, ignoring click');
                showMessage('‚è≥ Ë´ãËá≥Â∞ëËä±3ÂàÜÈêòÔºà180ÁßíÔºâÈñ±ËÆÄÊñáÁ´†ÔºÅ', 'warning');
                return;
            }
            
            // üöÄ NEW OPTIMIZATION: È©óË≠âÊôÇÈñìÈôêÂà∂ÊòØÂê¶Â∑≤Á∂ìÈÅé‰∫Ü180ÁßíÔºà3ÂàÜÈêòÔºâÔºàÈò≤Ê≠¢‰∫ÇÁåúÔºâ
            if (readingComprehensionData && readingComprehensionData.startedAt) {
                const now = new Date().getTime();
                const startTimeMs = readingComprehensionData.startedAt instanceof Date 
                    ? readingComprehensionData.startedAt.getTime() 
                    : (readingComprehensionData.startedAt.toDate ? readingComprehensionData.startedAt.toDate().getTime() : readingComprehensionData.startedAt.getTime());
                const elapsedMs = now - startTimeMs;
                
                if (elapsedMs < 180000) {
                    // ÈÇÑÊ≤íÊúâÈÅé180ÁßíÔºà3ÂàÜÈêòÔºâÔºåÊãíÁµïÊèê‰∫§
                    console.log('[submitReadingAnswer] Time limit not met, elapsed:', elapsedMs, 'ms');
                    const remainingSeconds = Math.ceil((180000 - elapsedMs) / 1000);
                    showMessage(`‚è≥ Ë´ãËá≥Â∞ëËä±${remainingSeconds}ÁßíÈñ±ËÆÄÊñáÁ´†ÔºÅ`, 'warning');
                    return;
                }
            }
            
            const answers = [];

            // Collect all answers
            for (let i = 0; i < readingComprehensionData.questions.length; i++) {
                const selected = document.querySelector(`input[name="reading_q${i}"]:checked`);
                if (selected) {
                    answers.push(parseInt(selected.value));
                } else {
                    answers.push(0); // No answer
                }
            }

            // üöÄ FIX: È©óË≠âÁ≠îÊ°àÔºàÂú®Á¶ÅÁî®ÊåâÈàï‰πãÂâçÔºâ
            if (answers.filter(a => a > 0).length === 0) {
                showMessage('Ë´ãËá≥Â∞ëÂõûÁ≠î‰∏ÄÈ°åÔºÅ', 'error');
                return;
            }

            // È©óË≠âÈÄöÈÅéÂæåÊâçÁ¶ÅÁî®ÊåâÈàïÔºåÈò≤Ê≠¢Êèê‰∫§ÈÅéÁ®ã‰∏≠ÈáçË§áÈªûÊìä
            submitBtn.disabled = true;
            submitBtn.textContent = 'ÈÄÅÂá∫‰∏≠...';
            
            try {
                // üöÄ NEW: Calculate duration if readingStartedAt exists
                let extraFields = {};
                if (readingComprehensionData.startedAt) {
                    // üöÄ FIX: Convert Firestore Timestamp to milliseconds
                    const startTimeMs = readingComprehensionData.startedAt.toMillis 
                        ? readingComprehensionData.startedAt.toMillis() 
                        : readingComprehensionData.startedAt.getTime();
                    const durationMs = Date.now() - startTimeMs;
                    extraFields.durationMs = durationMs;
                }
                
                // üöÄ NEW: Ë®àÁÆóÁ≠ÜË®òË©ïÂàÜ‰∏¶ÈôÑÂ∏∂Âà∞Êèê‰∫§Êï∏Êìö
                try {
                    const storageKey = `reading_highlights_${classroomCode || 'default'}`;
                    console.log('[submitReadingAnswer] üîç DEBUG: classroomCode =', classroomCode, ', storageKey =', storageKey);
                    
                    const saved = localStorage.getItem(storageKey);
                    console.log('[submitReadingAnswer] üîç DEBUG: localStorage data exists?', !!saved);
                    
                    if (saved) {
                        const saveData = JSON.parse(saved);
                        const highlights = saveData.highlights || [];
                        console.log('[submitReadingAnswer] üîç DEBUG: Parsed highlights count =', highlights.length);
                        console.log('[submitReadingAnswer] üîç DEBUG: First 3 highlights =', highlights.slice(0, 3));
                        
                        if (highlights.length > 0) {
                            console.log('[submitReadingAnswer] Found', highlights.length, 'highlights, calculating score...');
                            
                            // üöÄ FIX: ‰ΩøÁî®ÂéüÂßãÊñáÊú¨Èï∑Â∫¶ÔºàÂê´Á©∫ÁôΩÔºâÔºåËàáhighlight.length‰øùÊåÅ‰∏ÄËá¥
                            // ÈÅøÂÖçË®àÁÆóË¶ÜËìãÁéáÊôÇÂàÜÂ≠êÂàÜÊØç‰∏ç‰∏ÄËá¥Â∞éËá¥Á≤æÁ¢∫Â∫¶Ë©ïÂàÜË™§Â∑Æ
                            const totalTextLength = readingComprehensionData.text 
                                ? readingComprehensionData.text.length 
                                : 0;
                            
                            console.log('[submitReadingAnswer] üîç DEBUG: totalTextLength =', totalTextLength);
                            
                            // Ë™øÁî®Ë©ïÂàÜÂºïÊìé
                            const scoreResult = HighlightScoringEngine.calculateScore({
                                highlights: highlights,
                                totalTextLength: totalTextLength,
                                questions: readingComprehensionData.questions,
                                studentAnswers: answers
                            });
                            
                            console.log('[submitReadingAnswer] ‚úÖ Highlight score result:', JSON.stringify(scoreResult, null, 2));
                            
                            // Â∞áË©ïÂàÜÁµêÊûúÊ∑ªÂä†Âà∞Êèê‰∫§Êï∏Êìö
                            extraFields.highlightAnalysis = {
                                score: scoreResult.totalScore,
                                breakdown: scoreResult.breakdown,
                                stats: scoreResult.stats,
                                timestamp: Date.now()
                            };
                            console.log('[submitReadingAnswer] ‚úÖ highlightAnalysis attached to extraFields');
                        } else {
                            console.log('[submitReadingAnswer] ‚ö†Ô∏è No highlights found in saveData');
                            extraFields.highlightAnalysis = {
                                score: 0,
                                breakdown: {
                                    colorDiversity: 0,
                                    precision: 0,
                                    segmentation: 0,
                                    relevance: 0,
                                    timeDistribution: 0
                                },
                                stats: {
                                    highlightCount: 0,
                                    colorCount: 0,
                                    coverageRate: 0,
                                    segmentCount: 0
                                },
                                timestamp: Date.now()
                            };
                        }
                    } else {
                        console.log('[submitReadingAnswer] ‚ö†Ô∏è No saved highlights in localStorage for key:', storageKey);
                        console.log('[submitReadingAnswer] üîç DEBUG: All localStorage keys:', Object.keys(localStorage));
                        extraFields.highlightAnalysis = null;
                    }
                } catch (highlightError) {
                    console.error('[submitReadingAnswer] ‚ùå Failed to calculate highlight score:', highlightError);
                    // Âç≥‰ΩøË®àÁÆóÂ§±ÊïóÔºå‰πü‰∏çÂΩ±ÈüøÁ≠îÊ°àÊèê‰∫§
                    extraFields.highlightAnalysis = null;
                }
                
                // üöÄ NEW: Ë®àÁÆó baseScore Âíå totalScoreÔºåÂ≠òÂÑ≤Âà∞ Firestore
                // ÈÄôÊ®£Â≠∏ÁîüÁ´ØÁõ£ËÅΩÂô®ÂèØ‰ª•Áõ¥Êé•ËÆÄÂèñÔºåÁÑ°ÈúÄÈáçÊñ∞Ë®àÁÆó
                let correctCount = 0;
                answers.forEach((ans, index) => {
                    if (readingComprehensionData.questions[index]) {
                        const question = readingComprehensionData.questions[index];
                        // üöÄ FIX: ÊîØÊè¥ÈÄÅÂàÜÈ°åÔºàcorrectAnswer = 0 Ë°®Á§∫ÈÄÅÂàÜÈ°åÔºåÊâÄÊúâÂ≠∏ÁîüÈÉΩÁ≠îÂ∞çÔºâ
                        if (question.correctAnswer === 0) {
                            // ÈÄÅÂàÜÈ°åÔºöÁÑ°Ê¢ù‰ª∂ÁÆóÁÇ∫Ê≠£Á¢∫
                            correctCount++;
                            console.log(`[submitReadingAnswer] Question ${index} is a give-points question, auto-correct`);
                        } else if (ans === question.correctAnswer) {
                            // ÊôÆÈÄöÈ°åÔºöÁ≠îÊ°àÂåπÈÖçÊâçÁÆóÊ≠£Á¢∫
                            correctCount++;
                        }
                    }
                });
                const baseScore = Math.round((correctCount / readingComprehensionData.questions.length) * 100);
                const highlightBonus = extraFields.highlightAnalysis ? extraFields.highlightAnalysis.score : 0;
                const totalScore = baseScore + highlightBonus;
                
                extraFields.baseScore = baseScore;
                extraFields.totalScore = totalScore;
                
                console.log('[submitReadingAnswer] Calculated scores:', { baseScore, highlightBonus, totalScore });
                
                await submitAnswer(JSON.stringify(answers), extraFields);
                
                // üöÄ NEW: È°ØÁ§∫Á≠ÜË®òÂìÅË≥™Â†±ÂëäÔºàÂ¶ÇÊûúÊúâÊ®ôË®ªÔºâ
                if (extraFields.highlightAnalysis && extraFields.highlightAnalysis.score > 0) {
                    const analysis = extraFields.highlightAnalysis;
                    
                    // üé® RWDÈüøÊáâÂºèÁ≠ÜË®òÂìÅË≥™ÂàÜÊûêÂç°Áâá
                    const feedbackMessage = `
                        <div class="text-left space-y-2 sm:space-y-3 pr-6 sm:pr-8">
                            <div class="text-base sm:text-lg font-bold text-white mb-2">‚úÖ Á≠îÊ°àÂ∑≤ÊàêÂäüÊèê‰∫§ÔºÅ</div>
                            <div class="bg-white bg-opacity-20 p-2 sm:p-3 rounded-lg border border-white border-opacity-30">
                                <div class="text-sm sm:text-base font-bold text-white mb-2">üìù Á≠ÜË®òÂä†ÂàÜÔºö</div>
                                <div class="text-xl sm:text-2xl font-bold text-yellow-300 mb-2 sm:mb-3">+${analysis.score} ÂàÜ</div>
                                
                                <div class="space-y-1 text-xs sm:text-sm text-white">
                                    <div class="font-bold mb-1 text-yellow-200">Ë©ïÂàÜÊòéÁ¥∞Ôºö</div>
                                    <div class="flex justify-between items-center">
                                        <span>üé® È°èËâ≤Â§öÊ®£ÊÄß:</span>
                                        <span class="font-bold text-yellow-300">+${analysis.breakdown.colorDiversity}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>üéØ Á≤æÁ¢∫Â∫¶:</span>
                                        <span class="font-bold text-yellow-300">+${analysis.breakdown.precision}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>üìç ÂàÜÊÆµÊÄß:</span>
                                        <span class="font-bold text-yellow-300">+${analysis.breakdown.segmentation}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>üîó Á≠îÈ°åÈóúËÅØ:</span>
                                        <span class="font-bold text-yellow-300">+${analysis.breakdown.relevance}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>‚è±Ô∏è ÊôÇÈñìÂàÜÈÖç:</span>
                                        <span class="font-bold text-yellow-300">+${analysis.breakdown.timeDistribution}</span>
                                    </div>
                                </div>
                                
                                <div class="mt-2 pt-2 border-t border-white border-opacity-30 text-xs text-white text-opacity-90">
                                    <div class="grid grid-cols-2 gap-x-2 gap-y-1">
                                        <div>Ê®ôË®ª: ${analysis.stats.highlightCount} ÂÄã</div>
                                        <div>È°èËâ≤: ${analysis.stats.colorCount} Á®Æ</div>
                                        <div>Ë¶ÜËìã: ${Math.round(analysis.stats.coverageRate)}%</div>
                                        <div>ÊÆµËêΩ: ${analysis.stats.segmentCount} ÊÆµ</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs sm:text-sm text-white text-opacity-90 text-center mt-2">
                                üí° Á≠ÜË®òÂìÅË≥™Ë∂äÂ•ΩÔºåÂä†ÂàÜË∂äÂ§öÔºÅË´ãÈªûÊìäÂè≥‰∏äËßí ‚úï ÈóúÈñâ
                            </div>
                        </div>
                    `;
                    
                    showMessage(feedbackMessage, 'success', 0, true, true); // HTMLÊ®°Âºè + ÈúÄË¶ÅÊâãÂãïÈóúÈñâ
                } else {
                    showMessage('Á≠îÊ°àÂ∑≤Êèê‰∫§ÔºÅ', 'success');
                }
                
                // üöÄ FIX: Êèê‰∫§ÊàêÂäüÂæåÊ∞∏‰πÖÈéñÂÆöÊèê‰∫§ÊåâÈàïÂíåÊâÄÊúâÈÅ∏È†Ö
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-gray');
                submitBtn.textContent = '‚úì Â∑≤ÈÄÅÂá∫Á≠îÊ°à';
                
                // Á¶ÅÁî®ÊâÄÊúâÈÅ∏È†ÖÔºåËÆìÂ≠∏ÁîüÁÑ°Ê≥ïÊõ¥ÊîπÁ≠îÊ°à
                const allRadios = questionsContainer.querySelectorAll('input[type="radio"]');
                allRadios.forEach(radio => {
                    radio.disabled = true;
                });
                
                // ÁÇ∫Â∑≤ÈÅ∏ÊìáÁöÑÁ≠îÊ°àÊ∑ªÂä†Ë¶ñË¶∫Ê®ôË®ò
                const allLabels = questionsContainer.querySelectorAll('label');
                allLabels.forEach(label => {
                    const radio = label.querySelector('input[type="radio"]');
                    if (radio && radio.checked) {
                        label.classList.add('bg-green-100', 'border-green-400', 'border-2');
                    } else if (radio) {
                        label.classList.add('opacity-50');
                    }
                });
                
                // üöÄ NEW: Êèê‰∫§ÊàêÂäüÂæåÊâãÂãïËß∏ÁôºÊéíË°åÊ¶úÊõ¥Êñ∞‰∏¶ÊªæÂãïÂà∞ÊúÄ‰∏äÊñπ
                // ÈÄôÊ®£ÂèØ‰ª•ËÆìÂ≠∏ÁîüÁ´ãÂç≥ÁúãÂà∞Ëá™Â∑±ÁöÑÊéíÂêçÔºåÂêåÊôÇ‰∏çÊúÉÂΩ±ÈüøÂÖ∂‰ªñÊ≠£Âú®‰ΩúÁ≠îÁöÑÂ≠∏Áîü
                try {
                    const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                    const querySnapshot = await getDocs(studentsColRef);
                    const studentsData = [];
                    querySnapshot.forEach(doc => {
                        studentsData.push(doc.data());
                    });
                    // ÂÇ≥ÂÖ• shouldScrollToTop = trueÔºåËÆìÊéíË°åÊ¶úÊªæÂãïÂà∞Ë¶ñÁ™óÊúÄ‰∏äÊñπ
                    updateReadingLeaderboardDisplay(studentsData, true);
                } catch (error) {
                    console.warn('[submitReadingAnswer] Failed to update leaderboard after submission:', error);
                }
                
                // üöÄ NEW: Ë®≠ÁΩÆÂØ¶ÊôÇÁõ£ËÅΩÂô®Áõ£ËÅΩÂ≠∏ÁîüËá™Â∑±ÁöÑÊàêÁ∏æËÆäÂåñ
                // Áï∂ÊïôÂ∏´‰øÆÊîπÁ≠îÊ°àÂæåÔºåÂ≠∏ÁîüÁ´ØÂèØ‰ª•Âç≥ÊôÇÁúãÂà∞Êõ¥Êñ∞ÂæåÁöÑÊàêÁ∏æ
                setupStudentScoreListener();
                
                // ‰∏çË¶ÅÊ∏ÖÁ©∫ currentReadingAnswersÔºå‰ª•‰æøÊö´ÂÅúÊÅ¢Âæ©ÊôÇ‰øùÁïô
                // currentReadingAnswers = []; // REMOVED
            } catch (error) {
                // Â¶ÇÊûúÊèê‰∫§Â§±ÊïóÔºåÈáçÊñ∞ÂïüÁî®ÊåâÈàïËÆìÂ≠∏ÁîüÂèØ‰ª•ÈáçË©¶
                console.error('[submitReadingAnswer] Submit failed:', error);
                showMessage('Êèê‰∫§Â§±ÊïóÔºåË´ãÈáçË©¶ÔºÅ', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ÈÄÅÂá∫Á≠îÊ°à ‚úâÔ∏è';
            }
        }

        /**
         * üöÄ NEW: Ë®≠ÁΩÆÂ≠∏ÁîüÁ´ØÂØ¶ÊôÇÊàêÁ∏æÁõ£ËÅΩÂô®
         * Áï∂ÊïôÂ∏´‰øÆÊîπÁ≠îÊ°àÂæåÔºåÂ≠∏ÁîüÁ´ØÂèØ‰ª•Âç≥ÊôÇÁúãÂà∞Êõ¥Êñ∞ÂæåÁöÑÊàêÁ∏æ
         * CRITICAL: Also watches for scoreUpdateToken changes to force UI refresh
         */
        function setupStudentScoreListener() {
            if (!studentName || !classroomCode) {
                console.warn('[setupStudentScoreListener] Missing studentName or classroomCode');
                return;
            }
            
            // Â¶ÇÊûúÂ∑≤Á∂ìÊúâÁõ£ËÅΩÂô®ÔºåÂÖàË®ªÈä∑
            if (ListenerManager.has('studentScoreUpdate')) {
                console.log('[setupStudentScoreListener] Listener already exists, skipping');
                return;
            }
            
            const studentRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentName);
            
            // ËøΩËπ§‰∏ä‰∏ÄÊ¨°ÁöÑÊàêÁ∏æÂíåÁâàÊú¨Êà≥ÔºåÁî®ÊñºÂÅµÊ∏¨ËÆäÂåñ
            let previousBaseScore = null;
            let previousTotalScore = null;
            let previousScoreUpdateToken = null; // üöÄ CRITICAL: Track version stamp for force updates
            let isFirstSnapshot = true;
            
            const unsubscribe = onSnapshot(studentRef, (docSnapshot) => {
                if (!docSnapshot.exists()) {
                    console.log('[setupStudentScoreListener] Document does not exist');
                    return;
                }
                
                const data = docSnapshot.data();
                
                // üöÄ FIX: Áõ¥Êé•Âæû Firestore ËÆÄÂèñÊïôÂ∏´Á´ØÂ∑≤Ë®àÁÆóÂ•ΩÁöÑÊàêÁ∏æÔºåËÄå‰∏çÊòØÈáçÊñ∞Ë®àÁÆó
                // ÈÄôÊ®£ÊâçËÉΩÁ¢∫‰øùÁï∂ÊïôÂ∏´‰øÆÊîπÁ≠îÊ°àÂæåÔºåÂ≠∏ÁîüÁ´ØÁúãÂà∞ÁöÑÊòØÊúÄÊñ∞ÁöÑÊàêÁ∏æ
                const baseScore = data.baseScore || 0;
                const highlightBonus = (data.highlightAnalysis && data.highlightAnalysis.score) || 0;
                const totalScore = data.totalScore || (baseScore + highlightBonus);
                const scoreUpdateToken = data.scoreUpdateToken || null; // üöÄ CRITICAL: Get version stamp from teacher update
                
                // Á¨¨‰∏ÄÊ¨°Âø´ÁÖßÊôÇÔºåÂè™Ë®òÈåÑÂàùÂßãÂÄºÔºå‰∏çÈ°ØÁ§∫ÈÄöÁü•
                if (isFirstSnapshot) {
                    previousBaseScore = baseScore;
                    previousTotalScore = totalScore;
                    previousScoreUpdateToken = scoreUpdateToken; // üöÄ CRITICAL: Initialize token
                    isFirstSnapshot = false;
                    console.log('[setupStudentScoreListener] Initial snapshot:', { baseScore, highlightBonus, totalScore, scoreUpdateToken });
                    return;
                }
                
                // üöÄ CRITICAL: Check both score changes AND token changes for force updates
                // Token change indicates teacher pressed "Update Student Answers" button
                const baseScoreChanged = baseScore !== previousBaseScore;
                const totalScoreChanged = totalScore !== previousTotalScore;
                const tokenChanged = scoreUpdateToken !== previousScoreUpdateToken && scoreUpdateToken !== null; // Token change = force update
                
                // ÂÅµÊ∏¨ÊàêÁ∏æËÆäÂåñÊàñÂº∑Âà∂Êõ¥Êñ∞‰ø°ËôüÔºàtokenChangedÔºâ
                if (previousBaseScore !== null && previousTotalScore !== null) {
                    if (baseScoreChanged || totalScoreChanged || tokenChanged) {
                        console.log('[setupStudentScoreListener] Score changed!', {
                            previous: { baseScore: previousBaseScore, totalScore: previousTotalScore },
                            current: { baseScore, totalScore }
                        });
                        
                        // üéâ È°ØÁ§∫ÈÜíÁõÆÁöÑÊàêÁ∏æÊõ¥Êñ∞ÈÄöÁü•
                        const scoreChange = totalScore - previousTotalScore;
                        const changeIcon = scoreChange > 0 ? 'üìà' : scoreChange < 0 ? 'üìâ' : 'üîÑ';
                        const changeText = scoreChange > 0 ? `+${scoreChange}` : scoreChange < 0 ? `${scoreChange}` : '¬±0';
                        
                        const updateMessage = `
                            <div class="text-left space-y-2 sm:space-y-3 pr-6 sm:pr-8">
                                <div class="text-base sm:text-lg font-bold text-white mb-2">
                                    ${changeIcon} ÊàêÁ∏æÂ∑≤Êõ¥Êñ∞ÔºÅ
                                </div>
                                <div class="bg-white bg-opacity-20 p-2 sm:p-3 rounded-lg border border-white border-opacity-30">
                                    <div class="space-y-2 text-sm sm:text-base text-white">
                                        <div class="flex justify-between items-center">
                                            <span>üìù Âü∫Á§éÂàÜÔºö</span>
                                            <span class="font-bold text-yellow-300">${baseScore} ÂàÜ</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>‚ú® Á≠ÜË®òÂä†ÂàÜÔºö</span>
                                            <span class="font-bold text-yellow-300">+${highlightBonus} ÂàÜ</span>
                                        </div>
                                        <div class="pt-2 border-t border-white border-opacity-30"></div>
                                        <div class="flex justify-between items-center text-base sm:text-lg font-bold">
                                            <span>üèÜ Á∏ΩÂàÜÔºö</span>
                                            <span class="text-yellow-300">${totalScore} ÂàÜ (${changeText})</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs sm:text-sm text-white text-opacity-90 text-center mt-2">
                                    üí° ÊïôÂ∏´Â∑≤‰øÆÊ≠£Á≠îÊ°àÔºåÊÇ®ÁöÑÊàêÁ∏æÂ∑≤Ëá™ÂãïÊõ¥Êñ∞ÔºÅ
                                </div>
                            </div>
                        `;
                        
                        showMessage(updateMessage, scoreChange >= 0 ? 'success' : 'warning', 8000, true, true);
                        
                        // Êõ¥Êñ∞ÊéíË°åÊ¶úÈ°ØÁ§∫Ôºà‰∏çÊªæÂãïÂà∞È†ÇÈÉ®ÔºåÈÅøÂÖçÊâìÊñ∑Â≠∏ÁîüÔºâ
                        try {
                            const studentsColRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                            getDocs(studentsColRef).then(querySnapshot => {
                                const studentsData = [];
                                querySnapshot.forEach(doc => {
                                    studentsData.push(doc.data());
                                });
                                console.log('[setupStudentScoreListener] ‚úÖ Fetched latest studentResponses:', studentsData.length, 'students');
                                // üöÄ CRITICAL: Force clear and rebuild leaderboard
                                updateReadingLeaderboardDisplay(studentsData, false);
                            }).catch(err => {
                                console.error('[setupStudentScoreListener] Failed to fetch studentResponses:', err);
                            });
                        } catch (error) {
                            console.warn('[setupStudentScoreListener] Failed to update leaderboard:', error);
                        }
                        
                        // üöÄ CRITICAL: Update tracking values including token for next comparison
                        previousBaseScore = baseScore;
                        previousTotalScore = totalScore;
                        previousScoreUpdateToken = scoreUpdateToken; // Update token tracker
                        
                        console.log('[setupStudentScoreListener] Tracking updated - token:', scoreUpdateToken, 'tokenChanged:', tokenChanged);
                    }
                }
            }, (error) => {
                console.error('[setupStudentScoreListener] Listener error:', error);
            });
            
            ListenerManager.register('studentScoreUpdate', unsubscribe);
            console.log('[setupStudentScoreListener] Listener registered for student:', studentName);
        }

        /**
         * AI generate PIRLS reading questions
         */
        async function generatePIRLSQuestions() {
            // üöÄ UX: Ê™¢Êü• API KEY ÊòØÂê¶Â∑≤Ë®≠ÂÆö
            if (!checkAPIKey()) return;
            
            const aiTopicTextarea = document.getElementById('ai-reading-topic-textarea');
            const readingTextTextarea = document.getElementById('reading-text-textarea');
            const questionsTextarea = document.getElementById('reading-questions-textarea');
            const aiBtn = document.getElementById('ai-generate-reading-btn');
            const aiIcon = document.getElementById('ai-reading-btn-icon');
            const aiText = document.getElementById('ai-reading-btn-text');
            const aiSpinner = document.getElementById('ai-reading-loading-spinner');

            const topic = aiTopicTextarea.value.trim();

            if (!topic) {
                showMessage('Ë´ãËº∏ÂÖ•Âá∫È°åË¶ÅÊ±ÇÔºÅ', 'error');
                return;
            }

            // Ëá™ÂãïÊ∏ÖÈô§ËàäÂÖßÂÆπÔºåÊèê‰æõÊõ¥Â•ΩÁöÑ UX È´îÈ©ó
            readingTextTextarea.value = '';
            questionsTextarea.value = '';
            
            // Ê∏ÖÈô§ÂæåÔºåexistingText Ê∞∏ÈÅ†ÁÇ∫Á©∫ÔºåÊØèÊ¨°ÈÉΩÁîüÊàêÊñ∞ÊñáÊú¨ÂíåÈ°åÁõÆ
            const existingText = '';

            // Show loading
            aiBtn.disabled = true;
            aiText.textContent = 'ÁîüÊàê‰∏≠...';
            aiIcon.classList.remove('fa-magic');
            aiIcon.classList.add('fa-spinner', 'fa-spin');
            aiSpinner.classList.remove('hidden');

            try {
                const prompt = existingText
                    ? `Ê†πÊìö‰ª•‰∏ãÊñáÊú¨Ôºå‰æùÁÖß PIRLS Èñ±ËÆÄÁêÜËß£ÁöÑ 4 ÂÄãÂ±§Ê¨°ÁîüÊàê 10 È°åÈÅ∏ÊìáÈ°åÔºö
Â±§Ê¨°1ÔºàÁõ¥Êé•ÊèêÂèñË≥áË®äÔºâÔºö3È°å
Â±§Ê¨°2ÔºàÁõ¥Êé•Êé®Ë´ñÔºâÔºö3È°å
Â±§Ê¨°3ÔºàË©ÆÈáãÊï¥ÂêàË≥áË®äÔºâÔºö2È°å
Â±§Ê¨°4ÔºàÊØîËºÉË©ï‰º∞ÂÖßÂÆπÔºâÔºö2È°å

ÊñáÊú¨Ôºö
${existingText}

Ë¶ÅÊ±ÇÔºö${topic}

Ë´ãÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËº∏Âá∫ÔºåÊØèË°å‰∏ÄÈ°åÔºö
È°åÁõÆ,Ê≠£Á¢∫Á≠îÊ°à(1-4),ÈÅ∏È†Ö1,ÈÅ∏È†Ö2,ÈÅ∏È†Ö3,ÈÅ∏È†Ö4,Â±§Ê¨°(1-4)

ÁØÑ‰æãÔºö
‰∏ªËßíÁöÑÂêçÂ≠óÊòØ‰ªÄÈ∫º?,2,Â∞èÊòé,Â∞èËèØ,Â∞èÁæé,Â∞èÂº∑,1`
                    : `Ë´ãÊ†πÊìö‰ª•‰∏ã‰∏ªÈ°åÁîüÊàê‰∏ÄÁØáÈÅ©ÂêàÁöÑÈñ±ËÆÄÊñáÊú¨Ôºå‰∏¶‰æùÁÖß PIRLS Èñ±ËÆÄÁêÜËß£ÁöÑ 4 ÂÄãÂ±§Ê¨°ÁîüÊàê 10 È°åÈÅ∏ÊìáÈ°åÔºö
Â±§Ê¨°1ÔºàÁõ¥Êé•ÊèêÂèñË≥áË®äÔºâÔºö3È°å
Â±§Ê¨°2ÔºàÁõ¥Êé•Êé®Ë´ñÔºâÔºö3È°å
Â±§Ê¨°3ÔºàË©ÆÈáãÊï¥ÂêàË≥áË®äÔºâÔºö2È°å
Â±§Ê¨°4ÔºàÊØîËºÉË©ï‰º∞ÂÖßÂÆπÔºâÔºö2È°å

‰∏ªÈ°åÔºö${topic}

Ë´ãÂÖàËº∏Âá∫ÊñáÊú¨ÔºåÁÑ∂ÂæåËº∏Âá∫„Äå---È°åÁõÆ---„ÄçÔºåÂÜçÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèËº∏Âá∫È°åÁõÆÔºåÊØèË°å‰∏ÄÈ°åÔºö
È°åÁõÆ,Ê≠£Á¢∫Á≠îÊ°à(1-4),ÈÅ∏È†Ö1,ÈÅ∏È†Ö2,ÈÅ∏È†Ö3,ÈÅ∏È†Ö4,Â±§Ê¨°(1-4)`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7 }
                };

                const apiKey = aiSettings.geminiApiKey;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`[AI Èñ±ËÆÄÊ∏¨È©óÁîüÊàê] API ÈåØË™§ ${response.status}:`, errorBody);
                    if (response.status === 400) {
                        throw new Error('‚ùå API KEY ÁÑ°ÊïàÊàñÊ†ºÂºèÈåØË™§ÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑ Google AI Studio API Key Ë®≠ÂÆöÔºÅ');
                    }
                    throw new Error(`AI API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                if (generatedText) {
                    if (!existingText) {
                        // Parse text and questions
                        const parts = generatedText.split('---È°åÁõÆ---');
                        if (parts.length === 2) {
                            readingTextTextarea.value = parts[0].trim();
                            questionsTextarea.value = parts[1].trim();
                        } else {
                            questionsTextarea.value = generatedText;
                        }
                    } else {
                        questionsTextarea.value = generatedText;
                    }
                    showMessage('AI Èñ±ËÆÄÊ∏¨È©óÂ∑≤ÊàêÂäüÁîüÊàêÔºÅ', 'success');
                } else {
                    throw new Error('AI Êú™ËøîÂõûÊúâÊïàÂÖßÂÆπ„ÄÇ');
                }

            } catch (error) {
                console.error("AI Èñ±ËÆÄÊ∏¨È©óÁîüÊàêÂ§±Êïó:", error);
                const errorMsg = error.message.includes('API KEY') ? error.message : 'AI ÁîüÊàêÂ§±ÊïóÔºåË´ãÊ™¢Êü• API Key ÊàñÁ∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ';
                showMessage(errorMsg, 'error');
            } finally {
                aiBtn.disabled = false;
                aiText.textContent = 'AI ÈñãÂßãÂá∫È°å';
                aiIcon.classList.add('fa-magic');
                aiIcon.classList.remove('fa-spinner', 'fa-spin');
                aiSpinner.classList.add('hidden');
            }
        }

        /**
         * Show reading comprehension questions modal for teacher
         * üöÄ FIXED: Only re-render text when content changes to preserve teacher highlights
         */
        function showViewReadingQuestionsModal() {
            if (!readingComprehensionData || !readingComprehensionData.questions || readingComprehensionData.questions.length === 0) {
                showMessage('ÁõÆÂâçÊ≤íÊúâÈñ±ËÆÄÊ∏¨È©óÈ°åÁõÆÂèØ‰ª•Êü•Áúã„ÄÇ', 'info');
                return;
            }

            const modal = document.getElementById('view-reading-questions-modal');
            const textDisplay = document.getElementById('view-reading-text-display');
            const questionsDisplay = document.getElementById('view-reading-questions-display');

            // üöÄ CRITICAL FIX: Calculate content hash to detect if article changed
            const text = readingComprehensionData.text || '(ÁÑ°ÊñáÊú¨)';
            const currentContentHash = simpleHash(text);
            
            // üöÄ Only re-render text HTML if content actually changed
            const isContentChanged = currentContentHash !== lastViewedReadingContentHash;
            
            if (isContentChanged) {
                console.log('[showViewReadingQuestionsModal] Content changed, re-rendering text');
                // Display text with Markdown bold parsing
                textDisplay.innerHTML = parseMarkdownBold(text);
                lastViewedReadingContentHash = currentContentHash;
            } else {
                console.log('[showViewReadingQuestionsModal] Same content, preserving existing highlights');
            }
            
            // üöÄ NEW: Ë®àÁÆó‰∏¶È°ØÁ§∫ÊñáÁ´†Â≠óÊï∏
            const wordCount = text.replace(/\s/g, '').length;
            const wordCountDisplay = document.getElementById('view-reading-word-count');
            if (wordCountDisplay) {
                wordCountDisplay.textContent = `(ÂÖ± ${wordCount} Â≠ó)`;
            }
            
            // üöÄ NEW: È°ØÁ§∫È°åÁõÆÊï∏Èáè
            const questionsCount = readingComprehensionData.questions.length;
            const questionsCountDisplay = document.getElementById('view-reading-questions-count');
            if (questionsCountDisplay) {
                questionsCountDisplay.textContent = `(ÂÖ± ${questionsCount} È°å)`;
            }

            // Display questions
            questionsDisplay.innerHTML = '';
            readingComprehensionData.questions.forEach((q, index) => {
                const levelIcon = ['üìñ', 'üí≠', 'üîó', '‚öñÔ∏è'][q.level - 1];
                const levelText = ['Áõ¥Êé•ÊèêÂèñ', 'Áõ¥Êé•Êé®Ë´ñ', 'Ë©ÆÈáãÊï¥Âêà', 'ÊØîËºÉË©ï‰º∞'][q.level - 1];

                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-white p-4 rounded-lg border';
                questionDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-lg">Á¨¨ ${index + 1} È°å</span>
                        <span class="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded">${levelIcon} Â±§Ê¨°${q.level}: ${levelText}</span>
                    </div>
                    <p class="font-medium text-gray-800 mb-3">${q.question}</p>
                    <div class="space-y-1 ml-4">
                        ${q.options.map((opt, i) => `
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${i + 1 === q.correctAnswer ? 'text-green-600' : 'text-gray-600'}">${i + 1}.</span>
                                <span class="${i + 1 === q.correctAnswer ? 'text-green-600 font-bold' : 'text-gray-700'}">${opt}</span>
                                ${i + 1 === q.correctAnswer ? '<i class="fas fa-check-circle text-green-600 ml-2"></i>' : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        <span class="font-bold">Ê≠£Á¢∫Á≠îÊ°àÔºö</span><span class="text-green-600 font-bold">${q.correctAnswer}</span>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <button 
                            class="edit-answer-btn px-3 py-1.5 text-sm bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors duration-200 flex items-center gap-1.5"
                            data-question-index="${index}"
                        >
                            <i class="fas fa-edit"></i>
                            <span>‰øÆÊîπÁ≠îÊ°à</span>
                        </button>
                    </div>
                `;
                questionsDisplay.appendChild(questionDiv);
            });

            // üöÄ NEW: Á∂ÅÂÆö„Äå‰øÆÊîπÁ≠îÊ°à„ÄçÊåâÈàïÁöÑÈªûÊìä‰∫ã‰ª∂
            const editBtns = questionsDisplay.querySelectorAll('.edit-answer-btn');
            editBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const questionIndex = parseInt(e.currentTarget.dataset.questionIndex);
                    showEditAnswerDialog(questionIndex);
                });
            });

            // üöÄ NEW: ÂàùÂßãÂåñÊïôÂ∏´Á´ØËû¢ÂÖâÁ≠ÜÂäüËÉΩ
            console.log('[showViewReadingQuestionsModal] Initializing teacher highlighter');
            HighlighterManager.initTeacher();
            
            // üöÄ CRITICAL FIX: Always restore highlights to ensure correct state
            // Even if DOM is preserved, we need to restore in case content changed elsewhere
            console.log('[showViewReadingQuestionsModal] Restoring teacher highlights');
            setTimeout(() => {
                HighlighterManager.restoreTeacherHighlights();
            }, 100);

            modal.classList.remove('hidden');
        }
        
        /**
         * üöÄ NEW: Simple hash function for content comparison
         */
        function simpleHash(str) {
            if (!str) return '';
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString();
        }

        /**
         * Hide reading comprehension questions modal
         */
        function hideViewReadingQuestionsModal() {
            document.getElementById('view-reading-questions-modal').classList.add('hidden');
        }

        // === Edit Reading Answer Functions ===
        
        /**
         * üöÄ NEW: Áî®ÊñºËøΩËπ§Áï∂ÂâçÁ∑®ËºØÁöÑÈ°åÁõÆÁ¥¢ÂºïÂíåÈÅ∏ÊìáÁöÑÊñ∞Á≠îÊ°à
         */
        let currentEditingQuestionIndex = null;
        let selectedNewAnswer = null;
        let isGivePoints = false;
        
        // üöÄ NEW: ‰øÆÊîπÊ≠∑Âè≤ÂíåÊàêÁ∏æÂø´ÁÖß
        let answerModificationHistory = [];
        let preModificationScoreSnapshot = {};

        /**
         * üöÄ NEW: È°ØÁ§∫Á∑®ËºØÁ≠îÊ°àÂ∞çË©±Ê°Ü
         * @param {number} questionIndex - È°åÁõÆÁ¥¢ÂºïÔºà0-basedÔºâ
         */
        function showEditAnswerDialog(questionIndex) {
            if (!readingComprehensionData || !readingComprehensionData.questions || !readingComprehensionData.questions[questionIndex]) {
                showMessage('ÁÑ°Ê≥ïËºâÂÖ•È°åÁõÆË≥áÊñô', 'error');
                return;
            }

            const question = readingComprehensionData.questions[questionIndex];
            currentEditingQuestionIndex = questionIndex;
            selectedNewAnswer = null;
            isGivePoints = false;

            // Â°´ÂÖÖÈ°åÁõÆË≥áË®ä
            document.getElementById('edit-answer-question-number').textContent = `Á¨¨ ${questionIndex + 1} È°å`;
            document.getElementById('edit-answer-question-text').textContent = question.question;

            // ÁîüÊàêÈÅ∏È†ÖÊåâÈàï
            const optionsContainer = document.getElementById('edit-answer-options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionNumber = index + 1;
                const isCurrentAnswer = optionNumber === question.correctAnswer;
                
                const optionBtn = document.createElement('button');
                optionBtn.className = `w-full p-3 text-left rounded-lg border-2 transition-all duration-200 ${
                    isCurrentAnswer 
                        ? 'bg-green-50 border-green-400 hover:bg-green-100' 
                        : 'bg-white border-gray-300 hover:bg-gray-50 hover:border-gray-400'
                }`;
                optionBtn.dataset.optionNumber = optionNumber;
                
                optionBtn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-lg ${isCurrentAnswer ? 'text-green-600' : 'text-gray-600'}">${optionNumber}.</span>
                        <span class="${isCurrentAnswer ? 'text-green-700 font-medium' : 'text-gray-800'}">${option}</span>
                        ${isCurrentAnswer ? '<span class="ml-auto text-sm bg-green-600 text-white px-2 py-0.5 rounded">ÁõÆÂâçÁ≠îÊ°à</span>' : ''}
                    </div>
                `;
                
                // Á∂ÅÂÆöÈªûÊìä‰∫ã‰ª∂
                optionBtn.addEventListener('click', () => {
                    selectNewAnswer(optionNumber);
                });
                
                optionsContainer.appendChild(optionBtn);
            });

            // Á∂ÅÂÆöÈÄÅÂàÜÊåâÈàï
            document.getElementById('give-points-btn').addEventListener('click', () => {
                selectGivePoints();
            });

            // ÈáçÁΩÆÁ¢∫Ë™çÊåâÈàïÁãÄÊÖã
            document.getElementById('confirm-edit-answer-btn').disabled = true;

            // È°ØÁ§∫Ê®°ÊÖãÊ°Ü
            document.getElementById('edit-reading-answer-modal').classList.remove('hidden');
        }

        /**
         * üöÄ NEW: ÈÅ∏ÊìáÊñ∞Á≠îÊ°à
         * @param {number} optionNumber - ÈÅ∏È†ÖÁ∑®ËôüÔºà1-4Ôºâ
         */
        function selectNewAnswer(optionNumber) {
            selectedNewAnswer = optionNumber;
            isGivePoints = false;
            
            // Êõ¥Êñ∞ÊâÄÊúâÈÅ∏È†ÖÊåâÈàïÁöÑÊ®£Âºè
            const optionsContainer = document.getElementById('edit-answer-options-container');
            const allBtns = optionsContainer.querySelectorAll('button');
            
            allBtns.forEach(btn => {
                const btnOptionNumber = parseInt(btn.dataset.optionNumber);
                const isCurrentAnswer = btnOptionNumber === readingComprehensionData.questions[currentEditingQuestionIndex].correctAnswer;
                const isSelected = btnOptionNumber === optionNumber;
                
                if (isSelected) {
                    btn.className = 'w-full p-3 text-left rounded-lg border-2 bg-orange-100 border-orange-500 transition-all duration-200';
                    btn.querySelector('div').innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-lg text-orange-600">${btnOptionNumber}.</span>
                            <span class="text-orange-800 font-medium">${readingComprehensionData.questions[currentEditingQuestionIndex].options[btnOptionNumber - 1]}</span>
                            <span class="ml-auto text-sm bg-orange-600 text-white px-2 py-0.5 rounded">‚úì Êñ∞Á≠îÊ°à</span>
                        </div>
                    `;
                } else if (isCurrentAnswer) {
                    btn.className = 'w-full p-3 text-left rounded-lg border-2 bg-green-50 border-green-400 hover:bg-green-100 transition-all duration-200';
                } else {
                    btn.className = 'w-full p-3 text-left rounded-lg border-2 bg-white border-gray-300 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200';
                }
            });

            // ÈáçÁΩÆÈÄÅÂàÜÊåâÈàïÊ®£Âºè
            document.getElementById('give-points-btn').className = 'w-full p-3 text-left rounded-lg border-2 bg-gradient-to-r from-yellow-50 to-amber-50 border-yellow-400 hover:bg-yellow-100 transition-all duration-200 mt-2';
            
            // ÂïüÁî®Á¢∫Ë™çÊåâÈàï
            document.getElementById('confirm-edit-answer-btn').disabled = false;
        }

        /**
         * üöÄ NEW: ÈÅ∏ÊìáÈÄÅÂàÜ
         */
        function selectGivePoints() {
            selectedNewAnswer = null;
            isGivePoints = true;
            
            // ÈáçÁΩÆÊâÄÊúâÈÅ∏È†ÖÊåâÈàï
            const optionsContainer = document.getElementById('edit-answer-options-container');
            const allBtns = optionsContainer.querySelectorAll('button');
            const question = readingComprehensionData.questions[currentEditingQuestionIndex];
            
            allBtns.forEach(btn => {
                const btnOptionNumber = parseInt(btn.dataset.optionNumber);
                const isCurrentAnswer = btnOptionNumber === question.correctAnswer;
                btn.className = `w-full p-3 text-left rounded-lg border-2 transition-all duration-200 ${
                    isCurrentAnswer 
                        ? 'bg-green-50 border-green-400 hover:bg-green-100' 
                        : 'bg-white border-gray-300 hover:bg-gray-50 hover:border-gray-400'
                }`;
            });

            // Êõ¥Êñ∞ÈÄÅÂàÜÊåâÈàïÊ®£Âºè
            document.getElementById('give-points-btn').className = 'w-full p-3 text-left rounded-lg border-2 bg-gradient-to-r from-yellow-200 to-amber-200 border-yellow-600 transition-all duration-200 mt-2';
            document.getElementById('give-points-btn').innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="font-bold text-lg text-yellow-700">üéÅ</span>
                    <span class="text-yellow-800 font-bold">‚úì ÈÄÅÂàÜÈ°åÔºàÂÖ®Áè≠Â≠∏ÁîüÁç≤ÂæóË©≤È°åÊªøÂàÜÔºâ</span>
                </div>
            `;
            
            // ÂïüÁî®Á¢∫Ë™çÊåâÈàï
            document.getElementById('confirm-edit-answer-btn').disabled = false;
        }

        /**
         * üöÄ NEW: Èö±ËóèÁ∑®ËºØÁ≠îÊ°àÂ∞çË©±Ê°Ü
         */
        function hideEditAnswerDialog() {
            document.getElementById('edit-reading-answer-modal').classList.add('hidden');
            currentEditingQuestionIndex = null;
            selectedNewAnswer = null;
        }

        /**
         * üöÄ NEW: Á¢∫Ë™ç‰øÆÊîπÁ≠îÊ°à‰∏¶Ëá™ÂãïÈáçÊñ∞Ë©ïÂàÜ
         */
        async function confirmEditAnswer() {
            if (currentEditingQuestionIndex === null || (!selectedNewAnswer && !isGivePoints)) {
                showMessage('Ë´ãÈÅ∏ÊìáÊñ∞ÁöÑÁ≠îÊ°àÊàñÈÄÅÂàÜ', 'error');
                return;
            }

            const questionIndex = currentEditingQuestionIndex;
            const oldAnswer = readingComprehensionData.questions[questionIndex].correctAnswer;
            const newAnswer = isGivePoints ? 0 : selectedNewAnswer;
            
            // üöÄ NEW: Ë®àÁÆó‰øÆÊîπÂâçÁöÑÂΩ±ÈüøÁØÑÂúçÔºàÊúÉÂΩ±ÈüøÂ§öÂ∞ëÂ≠∏ÁîüÔºâ
            const studentsCollectionRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
            const studentsSnapshot = await getDocs(studentsCollectionRef);
            let affectedStudentsCount = 0;
            preModificationScoreSnapshot = {};
            
            studentsSnapshot.forEach(doc => {
                const studentData = doc.data();
                if (studentData.answer && studentData.hasSubmitted) {
                    affectedStudentsCount++;
                    preModificationScoreSnapshot[doc.id] = {
                        name: studentData.name,
                        baseScore: studentData.baseScore || 0,
                        totalScore: studentData.totalScore || 0
                    };
                }
            });
            
            // üöÄ NEW: ‰øÆÊîπÂâçÊèêÁ§∫„ÄåÂΩ±ÈüøÁØÑÂúç„Äç
            const affectRangeMsg = isGivePoints ? 
                `ÈÄôÂ∞á‰ΩøÂÖ®Áè≠ ${affectedStudentsCount} ÂêçÂ≠∏ÁîüÂú®Á¨¨ ${questionIndex + 1} È°åÈÉΩÁç≤ÂæóÊªøÂàÜ„ÄÇ` :
                `ÈÄôÂ∞áÂΩ±Èüø ${affectedStudentsCount} ÂêçÂ∑≤Êèê‰∫§ÁöÑÂ≠∏ÁîüÁöÑÊàêÁ∏æ„ÄÇ`;
            
            if (!confirm(`${affectRangeMsg}\n\nÁ¢∫ÂÆöË¶ÅÁπºÁ∫å‰øÆÊîπÂóéÔºü`)) {
                return;
            }

            // üöÄ NEW: Â¶ÇÊûúÁ≠îÊ°àÊ≤íÊúâÊîπËÆäÔºåÁõ¥Êé•ËøîÂõû
            if (!isGivePoints && newAnswer === oldAnswer) {
                showMessage('Êñ∞Á≠îÊ°àËàáÂéüÁ≠îÊ°àÁõ∏ÂêåÔºåÁÑ°ÈúÄ‰øÆÊîπ', 'info');
                hideEditAnswerDialog();
                return;
            }

            // üöÄ NEW: È°ØÁ§∫Á¢∫Ë™çÂ∞çË©±Ê°Ü
            let confirmMessage = '';
            if (isGivePoints) {
                confirmMessage = `Á¢∫ÂÆöË¶ÅÂ∞áÁ¨¨ ${questionIndex + 1} È°åË®≠ÁÇ∫ÈÄÅÂàÜÈ°åÂóéÔºü\n\nÈÄôÂ∞á‰ΩøÂÖ®Áè≠Â≠∏ÁîüÂú®ÈÄôÈ°åÈÉΩÁç≤ÂæóÊªøÂàÜÔºå‰∏¶Ëá™ÂãïÈáçÊñ∞Ë®àÁÆóÊâÄÊúâÂ≠∏ÁîüÁöÑÁ∏ΩÊàêÁ∏æ„ÄÇ`;
            } else {
                confirmMessage = `Á¢∫ÂÆöË¶ÅÂ∞áÁ¨¨ ${questionIndex + 1} È°åÁöÑÁ≠îÊ°àÂæûÈÅ∏È†Ö ${oldAnswer} ‰øÆÊîπÁÇ∫ÈÅ∏È†Ö ${newAnswer} ÂóéÔºü\n\nÈÄôÂ∞áËá™ÂãïÈáçÊñ∞Ë®àÁÆóÊâÄÊúâÂ∑≤Êèê‰∫§Â≠∏ÁîüÁöÑÊàêÁ∏æ„ÄÇ`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // Á¶ÅÁî®Á¢∫Ë™çÊåâÈàïÔºåÈò≤Ê≠¢ÈáçË§áÈªûÊìä
            const confirmBtn = document.getElementById('confirm-edit-answer-btn');
            const originalBtnText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ËôïÁêÜ‰∏≠...';

            try {
                // üöÄ STEP 1: Êõ¥Êñ∞ Firestore ‰∏≠ÁöÑ readingComprehensionData
                console.log(`[confirmEditAnswer] Updating question ${questionIndex + 1} answer from ${oldAnswer} to ${newAnswer}`);
                
                // Êõ¥Êñ∞Êú¨Âú∞Êï∏Êìö
                readingComprehensionData.questions[questionIndex].correctAnswer = newAnswer;

                // Êõ¥Êñ∞ Firestore
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                await setDoc(controlRef, {
                    readingComprehensionData: readingComprehensionData
                }, { merge: true });

                console.log('[confirmEditAnswer] Updated readingComprehensionData in Firestore');

                // üöÄ STEP 2: Êü•Ë©¢ÊâÄÊúâÂ∑≤Êèê‰∫§ÁöÑÂ≠∏Áîü
                const studentsCollectionRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                const studentsSnapshot = await getDocs(studentsCollectionRef);

                console.log(`[confirmEditAnswer] Found ${studentsSnapshot.size} students`);

                // üöÄ STEP 3: ÈáçÊñ∞Ë®àÁÆóÊàêÁ∏æ‰∏¶‰ΩøÁî® batch write Êõ¥Êñ∞ÔºàÂÑ™ÂåñÔºö‰ΩøÁî® writeBatch ËÄåÈùûÈÄêÂÄã setDocÔºâ
                const batch = writeBatch(db);
                let updatedCount = 0;
                const questions = readingComprehensionData.questions;
                const postModificationScoreSnapshot = {}; // Ë®òÈåÑ‰øÆÊîπÂæåÁöÑÊàêÁ∏æËÆäÂåñ

                /**
                 * Helper function: Âà§Êñ∑Â≠∏ÁîüÊèê‰∫§ÊòØÂê¶ÁÇ∫Èñ±ËÆÄÊ∏¨È©óÔºå‰∏¶Ëß£ÊûêÁ≠îÊ°à
                 * ÊîØÊåÅÊñ∞Êèê‰∫§ÔºàÊúâ interactionModeÔºâÂíåÊ≠∑Âè≤Êèê‰∫§ÔºàÁÑ° interactionModeÔºâ
                 * @returns {Object} { isReading: boolean, parsedAnswers: Array|null, parseError: boolean, reason: string }
                 */
                function parseReadingSubmission(studentData, questionsLength) {
                    // üöÄ ÁµêÊßãÂåñËøîÂõûÔºöÊòéÁ¢∫ÂçÄÂàÜ„ÄåÁÑ°Á≠îÊ°à„Äç„ÄåËß£ÊûêÂ§±Êïó„Äç„Äå‰∏çÁ¨¶ÂêàÊ¢ù‰ª∂„Äç
                    const result = {
                        isReading: false,
                        parsedAnswers: null,
                        parseError: false,
                        reason: ''
                    };
                    
                    if (!studentData.answer) {
                        result.reason = 'no answer';
                        return result;
                    }
                    
                    // üöÄ ÂòóË©¶Ëß£Êûê answerÔºàÂè™Ëß£Êûê‰∏ÄÊ¨°ÔºåÈÅøÂÖçÈáçË§áÔºâ
                    let parsedAnswers = null;
                    try {
                        if (typeof studentData.answer === 'string') {
                            parsedAnswers = JSON.parse(studentData.answer);
                            if (!Array.isArray(parsedAnswers)) {
                                console.warn(`[parseReadingSubmission] Answer is not an array for ${studentData.name}`);
                                result.parseError = true;
                                result.reason = 'not an array';
                                return result;
                            }
                        } else {
                            console.warn(`[parseReadingSubmission] Answer is not a string for ${studentData.name}`);
                            result.parseError = true;
                            result.reason = 'invalid type';
                            return result;
                        }
                    } catch (e) {
                        console.warn(`[parseReadingSubmission] JSON parse failed for ${studentData.name}:`, e.message);
                        result.parseError = true;
                        result.reason = 'JSON parse error';
                        return result;
                    }
                    
                    // üöÄ Â§öÈáçÊ¢ù‰ª∂Âà§Êñ∑ÊòØÂê¶ÁÇ∫Èñ±ËÆÄÊ∏¨È©óÊèê‰∫§
                    let isReading = false;
                    let reason = '';
                    
                    // 1. È¶ñÈÅ∏ÔºöÊ™¢Êü• interactionMode Ê¨Ñ‰Ωç
                    if (studentData.interactionMode === 'reading_comprehension') {
                        isReading = true;
                        reason = 'interactionMode';
                    }
                    // 2. Ê¨°ÈÅ∏ÔºöÊ™¢Êü• hasSubmitted Ê®ôË®òÔºàÊ≠∑Âè≤Êèê‰∫§Ôºâ
                    else if (studentData.hasSubmitted === true) {
                        isReading = true;
                        reason = 'hasSubmitted';
                    }
                    // 3. Ê™¢Êü•ÊòØÂê¶ÊúâÈñ±ËÆÄÊ∏¨È©óÁâπÊúâÁöÑÊ¨Ñ‰Ωç
                    else if (studentData.highlightAnalysis) {
                        isReading = true;
                        reason = 'highlightAnalysis';
                    }
                    // 4. Êé®Êñ∑ÔºöÊ™¢Êü• answer Èô£ÂàóÈï∑Â∫¶ÊòØÂê¶ËàáÈ°åÁõÆÊï∏ÈáèÂåπÈÖç
                    else if (parsedAnswers.length === questionsLength) {
                        isReading = true;
                        reason = 'array length match';
                    }
                    
                    if (isReading && reason) {
                        console.log(`[parseReadingSubmission] ‚úì Identified ${studentData.name} via ${reason}`);
                        result.isReading = true;
                        result.parsedAnswers = parsedAnswers;
                        result.reason = reason;
                    } else {
                        result.reason = 'not reading comprehension';
                    }
                    
                    return result;
                }
                
                // üöÄ Áµ±Ë®àË®àÊï∏Âô®
                let totalDocs = 0;
                let eligibleCount = 0;
                let skippedCount = 0;
                let parseFailures = 0;
                
                studentsSnapshot.forEach((studentDoc) => {
                    const studentData = studentDoc.data();
                    totalDocs++;
                    
                    // ‰ΩøÁî® helper ÂáΩÊï∏Ëß£Êûê‰∏¶Âà§Êñ∑ÊòØÂê¶ÁÇ∫Èñ±ËÆÄÊ∏¨È©óÊèê‰∫§
                    const result = parseReadingSubmission(studentData, questions.length);
                    
                    // üöÄ Á≤æÁ¢∫ÂàÜÈ°ûÔºöÂçÄÂàÜ„ÄåËß£ÊûêÂ§±Êïó„ÄçËàá„Äå‰∏çÁ¨¶ÂêàÊ¢ù‰ª∂„Äç
                    if (!result.isReading) {
                        if (result.parseError) {
                            // JSON Ëß£ÊûêÂ§±ÊïóÊàñÊ†ºÂºèÈåØË™§
                            parseFailures++;
                            console.warn(`[confirmEditAnswer] Parse error for ${studentData.name || 'unknown'}: ${result.reason}`);
                        } else {
                            // ‰∏çÁ¨¶ÂêàÈñ±ËÆÄÊ∏¨È©óÊ¢ù‰ª∂ÔºàÂÖ∂‰ªñÊ®°Âºè„ÄÅÁÑ°Á≠îÊ°àÁ≠âÔºâ
                            skippedCount++;
                            console.log(`[confirmEditAnswer] Skipped ${studentData.name || 'unknown'} (${result.reason})`);
                        }
                        return;
                    }
                    
                    eligibleCount++;
                    
                    try {
                        const studentAnswers = result.parsedAnswers;
                            
                            // ÈáçÊñ∞Ë®àÁÆóÂü∫Á§éÂàÜÊï∏ÔºàÊ≠£Á¢∫È°åÊï∏ / Á∏ΩÈ°åÊï∏ * 100Ôºâ
                            let correctCount = 0;
                            
                            // üöÄ DEFENSE: Èò≤Ê≠¢È°åÁõÆÊï∏ÈáèÊ∏õÂ∞ëÂ∞éËá¥ÁöÑÊï∏ÁµÑË∂äÁïå
                            const validAnswerCount = Math.min(studentAnswers.length, questions.length);
                            for (let index = 0; index < validAnswerCount; index++) {
                                const ans = studentAnswers[index];
                                // üöÄ FIX: ÊîØÊè¥ÈÄÅÂàÜÈ°åÔºàcorrectAnswer === 0 ÊôÇÁÑ°Ê¢ù‰ª∂ÁÆóÁÇ∫Ê≠£Á¢∫Ôºâ
                                if (questions[index] && ((questions[index].correctAnswer === 0) || (ans === questions[index].correctAnswer))) {
                                    correctCount++;
                                }
                            }
                            
                            // üöÄ DEFENSE: Â¶ÇÊûúÈ°åÁõÆÊï∏Èáè‰∏çÂåπÈÖçÔºåË®òÈåÑË≠¶Âëä
                            if (studentAnswers.length !== questions.length) {
                                console.warn(`[confirmEditAnswer] Question count mismatch for ${studentData.name}: expected ${questions.length}, got ${studentAnswers.length}`);
                            }

                            const baseScore = Math.round((correctCount / questions.length) * 100);
                            
                            // Á≠ÜË®òÂä†ÂàÜ‰øùÊåÅ‰∏çËÆä
                            const highlightBonus = (studentData.highlightAnalysis && studentData.highlightAnalysis.score) || 0;
                            
                            // Ë®àÁÆóÊñ∞ÁöÑÁ∏ΩÂàÜ
                            const totalScore = baseScore + highlightBonus;

                            console.log(`[confirmEditAnswer] Student ${studentData.name}: baseScore=${baseScore}, highlightBonus=${highlightBonus}, totalScore=${totalScore}`);

                            // Âä†ÂÖ•ÊâπÊ¨°Êõ¥Êñ∞ÔºàÊõ¥Êñ∞ studentResponses collectionÔºâ
                            const studentDocRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentDoc.id);
                            batch.update(studentDocRef, {
                                baseScore: baseScore,
                                totalScore: totalScore,
                                lastScoreUpdate: new Date() // Ë®òÈåÑÊõ¥Êñ∞ÊôÇÈñì
                            });
                            
                            // üöÄ NEW: Ë®òÈåÑÊàêÁ∏æËÆäÂåñÔºàÁî®ÊñºÊí§Èä∑ÂäüËÉΩÔºâ
                            postModificationScoreSnapshot[studentDoc.id] = {
                                name: studentData.name,
                                oldScore: studentData.totalScore || 0,
                                newScore: totalScore
                            };

                        updatedCount++;
                    } catch (e) {
                        parseFailures++;
                        console.warn(`[confirmEditAnswer] Failed to recalculate score for student ${studentData.name}:`, e);
                    }
                });

                // üöÄ STEP 4: Âü∑Ë°åÊâπÊ¨°Êõ¥Êñ∞
                if (updatedCount > 0) {
                    await batch.commit();
                    console.log(`[confirmEditAnswer] Batch update completed for ${updatedCount} students`);
                }

                // üöÄ LOG: Ëº∏Âá∫Áµ±Ë®àË≥áË®ä
                console.log(`[confirmEditAnswer] Statistics:`, {
                    totalDocs,
                    eligibleCount,
                    skippedCount,
                    parseFailures,
                    updatedCount
                });

                // üöÄ NEW: Ë®òÈåÑ‰øÆÊîπÊ≠∑Âè≤ÔºàÂê´ÊàêÁ∏æËÆäÂåñÂø´ÁÖßÔºâ
                const modificationRecord = {
                    timestamp: new Date().toISOString(),
                    questionIndex: questionIndex,
                    oldAnswer: oldAnswer,
                    newAnswer: newAnswer,
                    affectedStudentsCount: updatedCount,
                    isGivePoints: isGivePoints,
                    scoreChanges: postModificationScoreSnapshot
                };
                answerModificationHistory.push(modificationRecord);
                console.log('[confirmEditAnswer] Modification history recorded:', modificationRecord);
                
                // üöÄ NEW: Â∞á‰øÆÊîπÊ≠∑Âè≤‰øùÂ≠òÂà∞ FirestoreÔºàÂÇô‰ªΩÔºâ
                try {
                    const historyRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'modificationHistory', `question_${questionIndex}`);
                    await setDoc(historyRef, {
                        history: answerModificationHistory,
                        lastModified: new Date().toISOString()
                    }, { merge: true });
                } catch (e) {
                    console.warn('[confirmEditAnswer] Failed to backup modification history:', e);
                }
                
                // üöÄ SUCCESS: È°ØÁ§∫Ë©≥Á¥∞ÊàêÂäüË®äÊÅØÔºàÂåÖÂê´ÂÆåÊï¥Áµ±Ë®àË≥áË®äÂíåÊàêÁ∏æËÆäÂåñÊëòË¶ÅÔºâ
                const changedCount = Object.keys(postModificationScoreSnapshot).length;
                showMessage(
                    `‚úÖ ÊàêÂäü‰øÆÊîπÁ¨¨ ${questionIndex + 1} È°åÁ≠îÊ°àÔºÅ\n\n` +
                    `üìä ËôïÁêÜÁµ±Ë®àÔºö\n` +
                    `- Á∏ΩÊñáÊ™îÊï∏Ôºö${totalDocs}\n` +
                    `- Á¨¶ÂêàÊ¢ù‰ª∂Ôºö${eligibleCount}\n` +
                    `- ÊàêÂäüÊõ¥Êñ∞Ôºö${updatedCount}\n` +
                    `- ÊàêÁ∏æËÆäÂåñÔºö${changedCount} ‰∫∫\n` +
                    `- Ëß£ÊûêÂ§±ÊïóÔºö${parseFailures}\n` +
                    `- Â∑≤Ë∑≥ÈÅéÔºö${skippedCount}`,
                    'success',
                    6000
                );

                // Èö±ËóèÁ∑®ËºØÂ∞çË©±Ê°Ü
                hideEditAnswerDialog();

                // ÈáçÊñ∞Ê∏≤Êüì„ÄåÈ°ØÁ§∫È°åÁõÆ„ÄçÊ®°ÊÖãÊ°Ü‰ª•È°ØÁ§∫Êñ∞Á≠îÊ°à
                showViewReadingQuestionsModal();

            } catch (error) {
                console.error('[confirmEditAnswer] Error:', error);
                showMessage('‰øÆÊîπÁ≠îÊ°àÂ§±ÊïóÔºö' + error.message, 'error');
                
                // ÊÅ¢Âæ©ÂéüÁ≠îÊ°à
                readingComprehensionData.questions[questionIndex].correctAnswer = oldAnswer;
            } finally {
                // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalBtnText;
            }
        }
        
        /**
         * üöÄ NEW: Êü•Áúã‰øÆÊîπÊ≠∑Âè≤Ë®òÈåÑÔºàÂê´ÊàêÁ∏æËÆäÂåñÂàóË°®Ë©≥Á¥∞ UIÔºâ
         */
        function viewModificationHistory() {
            if (answerModificationHistory.length === 0) {
                showMessage('Êö´ÁÑ°‰øÆÊîπÊ≠∑Âè≤Ë®òÈåÑ', 'info');
                return;
            }
            
            // üöÄ NEW: ÂâµÂª∫ HTML UI È°ØÁ§∫‰øÆÊîπÊ≠∑Âè≤
            let historyHtml = `
                <div style="max-height: 500px; overflow-y: auto; padding: 15px; background: #f9fafb; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: #1f2937; font-weight: bold; font-size: 16px;">üìù ‰øÆÊîπÊ≠∑Âè≤Ë®òÈåÑ & ÊàêÁ∏æËÆäÂåñ</h3>
            `;
            
            answerModificationHistory.forEach((record, index) => {
                const time = new Date(record.timestamp).toLocaleString('zh-TW');
                const change = record.isGivePoints ? 
                    `Á¨¨ ${record.questionIndex + 1} È°åË®≠ÁÇ∫ÈÄÅÂàÜÈ°å` :
                    `Á¨¨ ${record.questionIndex + 1} È°åÁ≠îÊ°àÔºö${record.oldAnswer} ‚Üí ${record.newAnswer}`;
                
                historyHtml += `
                    <div style="background: white; border-left: 4px solid #3b82f6; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                        <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">${index + 1}. ${time}</div>
                        <div style="color: #374151; margin-bottom: 8px;">${change}</div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 5px;">ÂΩ±ÈüøÂ≠∏ÁîüÊï∏Ôºö<span style="font-weight: bold; color: #dc2626;">${record.affectedStudentsCount}</span></div>
                `;
                
                // üöÄ NEW: È°ØÁ§∫ÊàêÁ∏æËÆäÂåñÔºàÊúÄÂ§öÈ°ØÁ§∫ 5 ÂÄãÔºåÂÖ∂‰ªñÊäòÁñäÔºâ
                if (record.scoreChanges && Object.keys(record.scoreChanges).length > 0) {
                    historyHtml += `<div style="background: #f3f4f6; padding: 8px; border-radius: 4px; margin-top: 8px;">`;
                    historyHtml += `<div style="font-size: 12px; font-weight: bold; color: #374151; margin-bottom: 5px;">ÊàêÁ∏æËÆäÂåñ:</div>`;
                    
                    const scoreChanges = Object.values(record.scoreChanges);
                    scoreChanges.slice(0, 5).forEach(change => {
                        const diff = change.newScore - change.oldScore;
                        const diffText = diff > 0 ? `<span style="color: #10b981;">+${diff}</span>` : diff < 0 ? `<span style="color: #ef4444;">${diff}</span>` : `<span style="color: #6b7280;">¬±0</span>`;
                        historyHtml += `<div style="font-size: 12px; color: #4b5563; margin-bottom: 3px;">‚Ä¢ ${change.name}: ${change.oldScore} ‚Üí ${change.newScore} ${diffText}</div>`;
                    });
                    
                    if (scoreChanges.length > 5) {
                        historyHtml += `<div style="font-size: 12px; color: #9ca3af; margin-top: 5px; font-style: italic;">... ÂèäÂÖ∂‰ªñ ${scoreChanges.length - 5} ÂêçÂ≠∏Áîü</div>`;
                    }
                    
                    historyHtml += `</div>`;
                }
                
                historyHtml += `</div>`;
            });
            
            historyHtml += `</div>`;
            
            // üöÄ NEW: ÂâµÂª∫ modal È°ØÁ§∫Ê≠∑Âè≤
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    ${historyHtml}
                    <button onclick="this.closest('div').parentElement.remove();" style="width: 100%; padding: 10px; margin-top: 15px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">ÈóúÈñâ</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        /**
         * üöÄ NEW: Êí§Èä∑ÊúÄÂæå‰∏ÄÊ¨°‰øÆÊîπÔºàÂõûÊªæÂäüËÉΩÔºâ
         */
        async function undoLastModification() {
            if (answerModificationHistory.length === 0) {
                showMessage('Ê≤íÊúâÂèØÊí§Èä∑ÁöÑ‰øÆÊîπ', 'info');
                return;
            }
            
            if (!confirm('Á¢∫ÂÆöË¶ÅÊí§Èä∑ÊúÄÂæå‰∏ÄÊ¨°‰øÆÊîπÂóéÔºü\n\nÈÄôÂ∞áÊÅ¢Âæ©ÊâÄÊúâÂ≠∏ÁîüÁöÑÊàêÁ∏æÂà∞‰øÆÊîπÂâçÁöÑÁãÄÊÖã„ÄÇ')) {
                return;
            }
            
            try {
                const lastRecord = answerModificationHistory[answerModificationHistory.length - 1];
                console.log('[undoLastModification] Undoing modification:', lastRecord);
                
                // üöÄ STEP 1: ÊÅ¢Âæ©ËàäÁ≠îÊ°à
                readingComprehensionData.questions[lastRecord.questionIndex].correctAnswer = lastRecord.oldAnswer;
                
                // üöÄ STEP 2: Êõ¥Êñ∞ Firestore
                const controlRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'settings', 'control');
                await setDoc(controlRef, {
                    readingComprehensionData: readingComprehensionData
                }, { merge: true });
                
                console.log('[undoLastModification] Answer restored in Firestore');
                
                // üöÄ STEP 3: ‰ΩøÁî® batch ÊÅ¢Âæ©ÂèóÂΩ±ÈüøÂ≠∏ÁîüÁöÑÊàêÁ∏æ
                const batch = writeBatch(db);
                let restoredCount = 0;
                
                if (lastRecord.scoreChanges) {
                    Object.entries(lastRecord.scoreChanges).forEach(([studentId, scoreChange]) => {
                        if (preModificationScoreSnapshot[studentId]) {
                            const oldSnapshot = preModificationScoreSnapshot[studentId];
                            const studentDocRef = doc(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses', studentId);
                            batch.update(studentDocRef, {
                                baseScore: oldSnapshot.baseScore,
                                totalScore: oldSnapshot.totalScore,
                                lastScoreUpdate: new Date()
                            });
                            restoredCount++;
                        }
                    });
                }
                
                if (restoredCount > 0) {
                    await batch.commit();
                    console.log(`[undoLastModification] Restored scores for ${restoredCount} students`);
                }
                
                // üöÄ STEP 4: ÁßªÈô§Ê≠∑Âè≤Ë®òÈåÑ
                answerModificationHistory.pop();
                
                showMessage(`‚úÖ ÊàêÂäüÊí§Èä∑‰øÆÊîπÔºÅÂ∑≤ÊÅ¢Âæ© ${restoredCount} ÂêçÂ≠∏ÁîüÁöÑÊàêÁ∏æÂà∞‰øÆÊîπÂâçÁöÑÁãÄÊÖã„ÄÇ`, 'success');
                
                // ÈáçÊñ∞Ê∏≤ÊüìÈ°åÁõÆ
                showViewReadingQuestionsModal();
                
            } catch (error) {
                console.error('[undoLastModification] Error:', error);
                showMessage('Êí§Èä∑‰øÆÊîπÂ§±ÊïóÔºö' + error.message, 'error');
            }
        }
        
        /**
         * üöÄ NEW: È°ØÁ§∫Ë®òÊÜ∂È´îÁõ£ÊéßÈù¢ÊùøÔºàÁõ£ËÅΩÂô®Êï∏Èáè + Firestore ÊÄßËÉΩ + Ë®àÊôÇÂô®Ê™¢Ê∏¨Ôºâ
         */
        function showMemoryMonitoringPanel() {
            const listenerCount = ListenerManager.count();
            const allListeners = ListenerManager.getAll().join(', ') || 'ÁÑ°';
            
            // üöÄ NEW: ÂâµÂª∫Áõ£ÊéßÈù¢Êùø UI
            const monitoringHtml = `
                <div style="max-height: 600px; overflow-y: auto; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 12px;">
                    <h2 style="margin-top: 0; color: #1f2937; font-weight: bold; text-align: center; font-size: 18px;">üîç Ë®òÊÜ∂È´îÁõ£ÊéßÈù¢Êùø</h2>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                        <h3 style="margin-top: 0; color: #1f2937; font-weight: bold; font-size: 14px;">üìä Firebase Áõ£ËÅΩÂô®Áµ±Ë®à</h3>
                        <div style="color: #374151; font-size: 14px; line-height: 1.8;">
                            <div><strong>Áï∂ÂâçÁõ£ËÅΩÂô®Êï∏ÈáèÔºö</strong> <span style="font-weight: bold; color: ${listenerCount > 50 ? '#dc2626' : '#10b981'};\">${listenerCount}</span> ÂÄã</div>
                            <div style="margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 4px; font-size: 12px; max-height: 150px; overflow-y: auto;">
                                <strong>Â∑≤Ë®ªÂÜäÁöÑÁõ£ËÅΩÂô®Ôºö</strong><br/>
                                ${allListeners}
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                                ${listenerCount > 50 ? '‚ö†Ô∏è Ë≠¶ÂëäÔºöÁõ£ËÅΩÂô®Êï∏ÈáèÈÅéÂ§öÔºåÂª∫Ë≠∞Ê™¢Êü•ÊòØÂê¶ÊúâÊ¥©Êºè' : '‚úÖ Áõ£ËÅΩÂô®Êï∏ÈáèÊ≠£Â∏∏'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                        <h3 style="margin-top: 0; color: #1f2937; font-weight: bold; font-size: 14px;">‚ö° Firestore ÂÑ™ÂåñÁãÄÊÖã</h3>
                        <div style="color: #374151; font-size: 14px; line-height: 1.8;">
                            <div>‚úÖ ÊâπÈáèÂØ´ÂÖ•ÂÑ™ÂåñÔºöÂ∑≤ÂïüÁî®</div>
                            <div>‚úÖ writeBatch APIÔºöÊ≠£Âú®‰ΩøÁî®</div>
                            <div>‚úÖ È†êÊúüÊÄßËÉΩÊèêÂçáÔºö50-70%</div>
                            <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                                <em>Â§ßÁè≠Á¥öÂØ´ÂÖ•Êìç‰ΩúÂ∑≤ÊúÄ‰Ω≥ÂåñÔºåÊ∏õÂ∞ë‰∫Ü I/O Êìç‰ΩúÊ¨°Êï∏„ÄÇ</em>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                        <h3 style="margin-top: 0; color: #1f2937; font-weight: bold; font-size: 14px;">‚è±Ô∏è Ë®àÊôÇÂô®ÁÆ°ÁêÜ</h3>
                        <div style="color: #374151; font-size: 14px; line-height: 1.8;">
                            <div>üìç Â≠§Á´ãË®àÊôÇÂô®Ê™¢Ê∏¨ÔºöÂ∑≤ÂïüÂãï</div>
                            <div>‚úÖ ListenerManager Ê∏ÖÁêÜÔºöËá™ÂãïÂü∑Ë°å</div>
                            <div>üîÑ È†ÅÈù¢Âç∏ËºâÊ∏ÖÁêÜÔºöÂ∑≤ÈÖçÁΩÆ</div>
                            <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                                <em>Á≥ªÁµ±ÊúÉËá™ÂãïÊ∏ÖÁêÜÊâÄÊúâÁõ£ËÅΩÂô®ÂíåË®àÊôÇÂô®„ÄÇ</em>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                        <h3 style="margin-top: 0; color: #1f2937; font-weight: bold; font-size: 14px;">üí° Âª∫Ë≠∞</h3>
                        <div style="color: #374151; font-size: 14px; line-height: 1.8;">
                            <div>1Ô∏è‚É£ ÂÆöÊúüÊ™¢Êü•Áõ£ËÅΩÂô®Êï∏ÈáèÔºåÈÅøÂÖçË∂ÖÈÅé 50 ÂÄã</div>
                            <div>2Ô∏è‚É£ Á¢∫‰øùÈ†ÅÈù¢Âç∏ËºâÊôÇÊ≠£Á¢∫Ê∏ÖÁêÜÊâÄÊúâË≥áÊ∫ê</div>
                            <div>3Ô∏è‚É£ ‰ΩøÁî® writeBatch ÈÄ≤Ë°åÊâπÈáèÊìç‰Ωú‰ª•ÊèêÂçáÊÄßËÉΩ</div>
                            <div>4Ô∏è‚É£ Áõ£Êéß Firestore ËÆÄÂØ´ÊàêÊú¨ÔºàÊâπÈáèÂØ´ÂÖ•Â∑≤Â∞áÊàêÊú¨Èôç‰ΩéÔºâ</div>
                        </div>
                    </div>
                </div>
            `;
            
            // üöÄ NEW: ÂâµÂª∫ modal È°ØÁ§∫Áõ£ÊéßÈù¢Êùø
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    ${monitoringHtml}
                    <button onclick="this.closest('div').parentElement.remove();" style="width: 100%; padding: 12px; margin-top: 15px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px;">ÈóúÈñâ</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // === Reading Comprehension Question Bank Functions ===

        /**
         * Load text and questions from separate files
         */
        async function loadReadingFiles() {
            const textFileInput = document.getElementById('reading-text-file-input');
            const questionsFileInput = document.getElementById('reading-questions-file-input');
            const textTextarea = document.getElementById('reading-text-textarea');
            const questionsTextarea = document.getElementById('reading-questions-textarea');

            const textFile = textFileInput.files[0];
            const questionsFile = questionsFileInput.files[0];

            if (!textFile && !questionsFile) {
                showMessage('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÊ™îÊ°àÔºÅ', 'error');
                return;
            }

            try {
                if (textFile) {
                    const textContent = await textFile.text();
                    textTextarea.value = textContent.trim();
                }

                if (questionsFile) {
                    const questionsContent = await questionsFile.text();
                    questionsTextarea.value = questionsContent.trim();
                }

                showMessage('Ê™îÊ°àËºâÂÖ•ÊàêÂäüÔºÅ', 'success');

                // Clear file inputs
                textFileInput.value = '';
                questionsFileInput.value = '';
            } catch (error) {
                console.error('ËÆÄÂèñÊ™îÊ°àÂ§±Êïó:', error);
                showMessage('ËÆÄÂèñÊ™îÊ°àÂ§±ÊïóÔºÅ', 'error');
            }
        }

        /**
         * Save reading question bank to localStorage
         * üöÄ NEW: Áï∞Ê≠•ÂáΩÊï∏Ôºå‰øùÂ≠òÂæåËã•ÊúâÈÄÅÂàÜÈ°åÂâáËá™ÂãïÈáçÊñ∞Ë©ïÂàÜÂ∑≤Êèê‰∫§Â≠∏Áîü
         */
        async function saveReadingQuestionBank() {
            const nameInput = document.getElementById('reading-question-bank-name-input');
            const bankName = nameInput.value.trim();
            const textContent = document.getElementById('reading-text-textarea').value.trim();
            const questionsContent = document.getElementById('reading-questions-textarea').value.trim();

            if (!bankName) {
                showMessage('Ë´ãËº∏ÂÖ•È°åÂ∫´ÂêçÁ®±ÔºÅ', 'error');
                return;
            }

            if (!textContent || !questionsContent) {
                showMessage('Ë´ãÂÖàËº∏ÂÖ•ÊñáÊú¨ÂíåÈ°åÁõÆÔºÅ', 'error');
                return;
            }

            // Check if questions are valid
            const questions = parseReadingQuestions(questionsContent);
            if (!questions) {
                showMessage('È°åÁõÆÊ†ºÂºèÈåØË™§ÔºåË´ãÊ™¢Êü•ÔºÅ', 'error');
                return;
            }

            const bank = {
                name: bankName,
                text: textContent,
                questions: questionsContent,
                timestamp: new Date().toISOString()
            };

            // Check if bank name already exists
            const existingIndex = readingQuestionBanks.findIndex(b => b.name === bankName);
            if (existingIndex >= 0) {
                if (!confirm(`È°åÂ∫´„Äå${bankName}„ÄçÂ∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÜËìãÔºü`)) {
                    return;
                }
                readingQuestionBanks[existingIndex] = bank;
            } else {
                readingQuestionBanks.push(bank);
            }

            localStorage.setItem('readingQuestionBanks', JSON.stringify(readingQuestionBanks));
            updateReadingBankList();
            showMessage(`È°åÂ∫´„Äå${bankName}„ÄçÂ∑≤ÂÑ≤Â≠òÔºÅ`, 'success');
            nameInput.value = '';

            // üöÄ NEW: Ê™¢Êü•È°åÁõÆ‰∏≠ÊòØÂê¶ÊúâÈÄÅÂàÜÈ°åÔºåËã•Êúâ‰∏îÁï∂ÂâçÊúâÊ¥ªÂãïÈñ±ËÆÄÊ∏¨È©óÔºåÂâáËá™ÂãïÈáçÊñ∞Ë©ïÂàÜ
            const hasGivePointsQuestions = questions.some(q => q.correctAnswer === 0);
            
            if (hasGivePointsQuestions && readingComprehensionData && readingComprehensionData.questions && readingComprehensionData.questions.length > 0) {
                console.log('[saveReadingQuestionBank] üöÄ Ê™¢Ê∏¨Âà∞ÈÄÅÂàÜÈ°åÔºåÊ∫ñÂÇôÈáçÊñ∞Ë©ïÂàÜ...');
                
                // Ê™¢Êü•ÊòØÂê¶ÊúâÊ¥ªÂãïÁöÑÊïôÂÆ§
                if (!classroomCode || !baseAppId) {
                    console.log('[saveReadingQuestionBank] ‚ö†Ô∏è ÁÑ°Ê¥ªÂãïÊïôÂÆ§ÔºåË∑≥ÈÅéËá™ÂãïÈáçÊñ∞Ë©ïÂàÜ');
                    return;
                }

                try {
                    // üöÄ STEP 1: Êü•Ë©¢ÊâÄÊúâÂ∑≤Êèê‰∫§ÁöÑÂ≠∏Áîü
                    const studentsCollectionRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                    const studentsSnapshot = await getDocs(studentsCollectionRef);

                    if (studentsSnapshot.size === 0) {
                        console.log('[saveReadingQuestionBank] ÁÑ°Â∑≤Êèê‰∫§ÁöÑÂ≠∏ÁîüÔºåË∑≥ÈÅéÈáçÊñ∞Ë©ïÂàÜ');
                        return;
                    }

                    console.log(`[saveReadingQuestionBank] ÈñãÂßãÈáçÊñ∞Ë©ïÂàÜ ${studentsSnapshot.size} ÂêçÂ≠∏Áîü...`);

                    // üöÄ STEP 2: ‰ΩøÁî® batch write ÈáçÊñ∞Ë®àÁÆóÊâÄÊúâÂ≠∏ÁîüÊàêÁ∏æ
                    const batch = writeBatch(db);
                    let updatedCount = 0;
                    const validQuestions = questions;

                    studentsSnapshot.forEach((studentDoc) => {
                        const studentData = studentDoc.data();

                        // Âè™ËôïÁêÜÊúâÁ≠îÊ°àÁöÑÂ≠∏Áîü
                        if (!studentData.answer || !studentData.hasSubmitted) {
                            return;
                        }

                        try {
                            let parsedAnswers = null;
                            try {
                                parsedAnswers = typeof studentData.answer === 'string' 
                                    ? JSON.parse(studentData.answer) 
                                    : studentData.answer;
                            } catch (e) {
                                console.warn(`[saveReadingQuestionBank] JSON Ëß£ÊûêÂ§±Êïó: ${studentData.name}`);
                                return;
                            }

                            if (!Array.isArray(parsedAnswers)) {
                                return;
                            }

                            // üöÄ ÈáçÊñ∞Ë®àÁÆóÂü∫Á§éÂàÜÊï∏ÔºàÊîØÊåÅÈÄÅÂàÜÈ°åÈÇèËºØÔºâ
                            let correctCount = 0;
                            const validAnswerCount = Math.min(parsedAnswers.length, validQuestions.length);
                            
                            for (let index = 0; index < validAnswerCount; index++) {
                                const ans = parsedAnswers[index];
                                // ‚úÖ ÈÄÅÂàÜÈ°åÁÑ°Ê¢ù‰ª∂Ë®àÁÇ∫Ê≠£Á¢∫
                                if (validQuestions[index] && ((validQuestions[index].correctAnswer === 0) || (ans === validQuestions[index].correctAnswer))) {
                                    correctCount++;
                                }
                            }

                            const baseScore = Math.round((correctCount / validQuestions.length) * 100);
                            const highlightBonus = (studentData.highlightAnalysis && studentData.highlightAnalysis.score) || 0;
                            const totalScore = baseScore + highlightBonus;

                            // Âè™Âú®ÂàÜÊï∏ÊîπËÆäÊôÇÊâçÊõ¥Êñ∞
                            if (baseScore !== studentData.baseScore || totalScore !== studentData.totalScore) {
                                batch.update(studentDoc.ref, {
                                    baseScore: baseScore,
                                    totalScore: totalScore
                                });
                                updatedCount++;
                                console.log(`[saveReadingQuestionBank] ‚úì Êõ¥Êñ∞ ${studentData.name}: ${studentData.baseScore}‚Üí${baseScore} (ÈÄÅÂàÜÈ°åÂΩ±Èüø)`);
                            }
                        } catch (error) {
                            console.warn(`[saveReadingQuestionBank] ËôïÁêÜÂ≠∏Áîü ${studentData.name} ÊôÇÂá∫ÈåØ:`, error.message);
                        }
                    });

                    // üöÄ STEP 3: Êèê‰∫§ batch
                    if (updatedCount > 0) {
                        await batch.commit();
                        console.log(`[saveReadingQuestionBank] ‚úÖ ÊàêÂäüÈáçÊñ∞Ë©ïÂàÜ ${updatedCount} ÂêçÂ≠∏Áîü`);
                        showMessage(`‚úÖ È°åÂ∫´Â∑≤ÂÑ≤Â≠òÔºÅÂ∑≤Ëá™ÂãïÁÇ∫ ${updatedCount} ÂêçÂ≠∏ÁîüÈáçÊñ∞Ë®àÂàÜÔºàÂåÖÂê´ÈÄÅÂàÜÈ°åÔºâ`, 'success');
                    } else {
                        console.log('[saveReadingQuestionBank] ÁÑ°Â≠∏ÁîüÈúÄË¶ÅÈáçÊñ∞Ë©ïÂàÜ');
                    }
                } catch (error) {
                    console.error('[saveReadingQuestionBank] Ëá™ÂãïÈáçÊñ∞Ë©ïÂàÜÂ§±Êïó:', error);
                    showMessage('È°åÂ∫´Â∑≤ÂÑ≤Â≠òÔºå‰ΩÜËá™ÂãïÈáçÊñ∞Ë©ïÂàÜÂ§±Êïó„ÄÇË´ãÊâãÂãï‰ΩøÁî®„Äå‰øÆÊîπÁ≠îÊ°à„ÄçÂäüËÉΩÈáçÊñ∞Ë®àÂàÜ„ÄÇ', 'warning');
                }
            }
        }

        /**
         * üöÄ NEW: Rescore all students immediately (triggered by teacher button)
         * CRITICAL: Always force update to sync give-points changes to student side
         */
        async function rescoreAllStudents() {
            if (!readingComprehensionData || !readingComprehensionData.questions || readingComprehensionData.questions.length === 0) {
                showMessage('ÁõÆÂâçÁÑ°Èñ±ËÆÄÊ∏¨È©óÈ°åÁõÆÔºåÁÑ°Ê≥ïÊõ¥Êñ∞Â≠∏ÁîüÁ≠îÊ°à„ÄÇ', 'error');
                return;
            }

            if (!classroomCode || !baseAppId) {
                showMessage('ÁÑ°Ê¥ªÂãïÊïôÂÆ§ÔºåÁÑ°Ê≥ïÊõ¥Êñ∞Â≠∏ÁîüÁ≠îÊ°à„ÄÇ', 'error');
                return;
            }

            if (!confirm('Á¢∫ÂÆöË¶ÅÁ´ãÂç≥ÁÇ∫ÊâÄÊúâÂ∑≤Êèê‰∫§ÁöÑÂ≠∏ÁîüÈáçÊñ∞Ë®àÂàÜÂóéÔºü')) {
                return;
            }

            const rescoreBtn = document.getElementById('rescore-all-students-btn');
            const originalBtnText = rescoreBtn.textContent;
            rescoreBtn.disabled = true;
            rescoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Êõ¥Êñ∞‰∏≠...';

            try {
                console.log('[rescoreAllStudents] ÈñãÂßãÈáçÊñ∞Ë©ïÂàÜÊâÄÊúâÂ≠∏Áîü...');
                
                // Êü•Ë©¢ÊâÄÊúâÂ∑≤Êèê‰∫§ÁöÑÂ≠∏Áîü
                const studentsCollectionRef = collection(db, 'artifacts', baseAppId, 'public', 'data', 'classrooms', classroomCode, 'studentResponses');
                const studentsSnapshot = await getDocs(studentsCollectionRef);

                if (studentsSnapshot.size === 0) {
                    showMessage('ÁõÆÂâçÁÑ°Â∑≤Êèê‰∫§ÁöÑÂ≠∏Áîü„ÄÇ', 'info');
                    rescoreBtn.disabled = false;
                    rescoreBtn.innerHTML = originalBtnText;
                    return;
                }

                console.log(`[rescoreAllStudents] ÈñãÂßãËôïÁêÜ ${studentsSnapshot.size} ÂêçÂ≠∏Áîü...`);

                const batch = writeBatch(db);
                let updatedCount = 0;
                const questions = readingComprehensionData.questions;
                const forceUpdateToken = Date.now(); // üöÄ CRITICAL: Force update token to trigger student-side refresh

                studentsSnapshot.forEach((studentDoc) => {
                    const studentData = studentDoc.data();

                    // üöÄ CRITICAL FIX: Only check for answer existence, not hasSubmitted
                    // hasSubmitted may not be set or may be in different states
                    if (!studentData.answer) {
                        return;
                    }

                    try {
                        let parsedAnswers = null;
                        try {
                            parsedAnswers = typeof studentData.answer === 'string' 
                                ? JSON.parse(studentData.answer) 
                                : studentData.answer;
                        } catch (e) {
                            console.warn(`[rescoreAllStudents] JSON Ëß£ÊûêÂ§±Êïó: ${studentData.name}`);
                            return;
                        }

                        if (!Array.isArray(parsedAnswers)) {
                            return;
                        }

                        let correctCount = 0;
                        const validAnswerCount = Math.min(parsedAnswers.length, questions.length);
                        
                        for (let index = 0; index < validAnswerCount; index++) {
                            const ans = parsedAnswers[index];
                            if (questions[index] && ((questions[index].correctAnswer === 0) || (ans === questions[index].correctAnswer))) {
                                correctCount++;
                            }
                        }

                        const baseScore = Math.round((correctCount / questions.length) * 100);
                        const highlightBonus = (studentData.highlightAnalysis && studentData.highlightAnalysis.score) || 0;
                        const totalScore = baseScore + highlightBonus;

                        // üöÄ CRITICAL: Always force update (remove comparison check) to ensure give-points changes sync to student side
                        batch.update(studentDoc.ref, {
                            baseScore: baseScore,
                            totalScore: totalScore,
                            lastScoreUpdate: new Date(),
                            scoreUpdateToken: forceUpdateToken  // üöÄ CRITICAL: Version stamp to force student UI refresh
                        });
                        updatedCount++;
                        console.log(`[rescoreAllStudents] ‚úì Âº∑Âà∂Êõ¥Êñ∞ ${studentData.name}: ${studentData.baseScore}‚Üí${baseScore}`);
                    } catch (error) {
                        console.warn(`[rescoreAllStudents] ËôïÁêÜÂ≠∏Áîü ${studentData.name} ÊôÇÂá∫ÈåØ:`, error.message);
                    }
                });

                if (updatedCount > 0) {
                    await batch.commit();
                    console.log(`[rescoreAllStudents] ‚úÖ ÊàêÂäüÂº∑Âà∂Êõ¥Êñ∞ ${updatedCount} ÂêçÂ≠∏ÁîüÁöÑÊàêÁ∏æ`);
                    showMessage(`‚úÖ ÊàêÂäüÁÇ∫ ${updatedCount} ÂêçÂ≠∏ÁîüÊõ¥Êñ∞ÊàêÁ∏æÔºÅ`, 'success');
                } else {
                    showMessage('ÁõÆÂâçÁÑ°Â∑≤Êèê‰∫§ÁöÑÂ≠∏ÁîüÂèØÊõ¥Êñ∞„ÄÇ', 'info');
                }
            } catch (error) {
                console.error('[rescoreAllStudents] Êõ¥Êñ∞Â§±Êïó:', error);
                showMessage('Êõ¥Êñ∞Â≠∏ÁîüÁ≠îÊ°àÂ§±ÊïóÔºö' + error.message, 'error');
            } finally {
                rescoreBtn.disabled = false;
                rescoreBtn.innerHTML = originalBtnText;
            }
        }

        /**
         * Update reading question bank list display
         */
        function updateReadingBankList() {
            const listContainer = document.getElementById('reading-question-bank-list');

            if (readingQuestionBanks.length === 0) {
                listContainer.innerHTML = '<div class="text-gray-500 text-sm italic text-center">ÁõÆÂâçÊ≤íÊúâÂÑ≤Â≠òÁöÑÈ°åÂ∫´</div>';
                return;
            }

            listContainer.innerHTML = readingQuestionBanks.map((bank, index) => `
                <div class="flex items-center justify-between p-2 bg-white border rounded hover:bg-gray-50">
                    <button onclick="loadReadingBankToTextarea(${index})" class="text-left flex-1 text-sm text-blue-600 hover:underline">
                        ${bank.name}
                    </button>
                    <div class="flex gap-1 ml-2">
                        <button onclick="exportReadingBank(${index})" class="text-green-600 hover:text-green-700" title="ÂåØÂá∫È°åÂ∫´">
                            <i class="fas fa-download text-xs"></i>
                        </button>
                        <button onclick="deleteReadingBank(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Load reading bank to textarea
         */
        function loadReadingBankToTextarea(index) {
            if (index >= 0 && index < readingQuestionBanks.length) {
                const bank = readingQuestionBanks[index];
                document.getElementById('reading-text-textarea').value = bank.text;
                document.getElementById('reading-questions-textarea').value = bank.questions;
                showMessage(`È°åÂ∫´„Äå${bank.name}„ÄçÂ∑≤ËºâÂÖ•`, 'success');
            }
        }

        /**
         * Export reading bank as JSON file
         */
        function exportReadingBank(index) {
            try {
                if (index >= 0 && index < readingQuestionBanks.length) {
                    const bank = readingQuestionBanks[index];
                    console.log('[exportReadingBank] ÈñãÂßãÂåØÂá∫È°åÂ∫´:', bank.name);
                    
                    const exportData = {
                        name: bank.name,
                        text: bank.text,
                        questions: bank.questions,
                        timestamp: bank.timestamp || new Date().toISOString(),
                        exportedAt: new Date().toISOString()
                    };
                    
                    console.log('[exportReadingBank] Â∫èÂàóÂåñÊï∏Êìö...');
                    const jsonString = JSON.stringify(exportData, null, 2);
                    console.log('[exportReadingBank] JSONÂ≠óÁ¨¶‰∏≤Èï∑Â∫¶:', jsonString.length);
                    
                    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                    console.log('[exportReadingBank] Blob created:', blob.size, 'bytes');
                    
                    const filename = `${bank.name}_Èñ±ËÆÄÈ°åÂ∫´_${new Date().toISOString().slice(0, 10)}.json`;
                    console.log('[exportReadingBank] Ê∫ñÂÇô‰∏ãËºâÊñá‰ª∂:', filename);
                    
                    // ‰ΩøÁî® window.saveAs Á¢∫‰øùÂÖ®Â±Ä‰ΩúÁî®Âüü
                    if (typeof window.saveAs === 'function') {
                        window.saveAs(blob, filename);
                        console.log('[exportReadingBank] ‚úì Êñá‰ª∂Â∑≤‰∏ãËºâ');
                        showMessage(`È°åÂ∫´„Äå${bank.name}„ÄçÂ∑≤ÂåØÂá∫ÔºÅ`, 'success');
                    } else {
                        throw new Error('saveAs ÂáΩÊï∏‰∏çÂèØÁî®ÔºåË´ãÁ¢∫‰øù FileSaver.js Â∑≤Ê≠£Á¢∫ËºâÂÖ•');
                    }
                }
            } catch (error) {
                console.error('[exportReadingBank] ÂåØÂá∫Â§±Êïó:', error);
                console.error('[exportReadingBank] ÈåØË™§Ë©≥ÊÉÖ:', error.message, error.stack);
                showMessage(`ÂåØÂá∫Â§±Êïó: ${error.message}`, 'error');
            }
        }

        /**
         * Import reading bank from JSON file
         */
        function importReadingBankFromFile() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const jsonContent = await file.text();
                    const importedBank = JSON.parse(jsonContent);
                    
                    if (!importedBank.name || !importedBank.text || !importedBank.questions) {
                        showMessage('È°åÂ∫´Ê†ºÂºèÈåØË™§ÔºåË´ãÁ¢∫Ë™çÊòØÊúâÊïàÁöÑÈ°åÂ∫´Ê™îÊ°àÔºÅ', 'error');
                        return;
                    }
                    
                    const bankName = importedBank.name;
                    const existingIndex = readingQuestionBanks.findIndex(b => b.name === bankName);
                    
                    if (existingIndex >= 0) {
                        if (!confirm(`È°åÂ∫´„Äå${bankName}„ÄçÂ∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÜËìãÔºü`)) {
                            return;
                        }
                        readingQuestionBanks[existingIndex] = {
                            name: importedBank.name,
                            text: importedBank.text,
                            questions: importedBank.questions,
                            timestamp: importedBank.timestamp || new Date().toISOString()
                        };
                    } else {
                        readingQuestionBanks.push({
                            name: importedBank.name,
                            text: importedBank.text,
                            questions: importedBank.questions,
                            timestamp: importedBank.timestamp || new Date().toISOString()
                        });
                    }
                    
                    localStorage.setItem('readingQuestionBanks', JSON.stringify(readingQuestionBanks));
                    updateReadingBankList();
                    showMessage(`È°åÂ∫´„Äå${bankName}„ÄçÂ∑≤ÂåØÂÖ•ÔºÅ`, 'success');
                } catch (error) {
                    console.error('ÂåØÂÖ•È°åÂ∫´Â§±Êïó:', error);
                    showMessage('ÂåØÂÖ•È°åÂ∫´Â§±ÊïóÔºåË´ãÁ¢∫Ë™çÊ™îÊ°àÊ†ºÂºèÊ≠£Á¢∫ÔºÅ', 'error');
                }
            });
            fileInput.click();
        }

        /**
         * Delete reading bank
         */
        function deleteReadingBank(index) {
            if (index >= 0 && index < readingQuestionBanks.length) {
                const bankName = readingQuestionBanks[index].name;
                if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§È°åÂ∫´„Äå${bankName}„ÄçÂóéÔºü`)) {
                    readingQuestionBanks.splice(index, 1);
                    localStorage.setItem('readingQuestionBanks', JSON.stringify(readingQuestionBanks));
                    updateReadingBankList();
                    showMessage(`È°åÂ∫´„Äå${bankName}„ÄçÂ∑≤Âà™Èô§`, 'success');
                }
            }
        }

        // Make functions globally accessible
        window.loadReadingBankToTextarea = loadReadingBankToTextarea;
        window.deleteReadingBank = deleteReadingBank;
        window.exportReadingBank = exportReadingBank;
        window.importReadingBankFromFile = importReadingBankFromFile;

        // Load reading question banks from localStorage on init
        const savedReadingBanks = localStorage.getItem('readingQuestionBanks');
        if (savedReadingBanks) {
            try {
                readingQuestionBanks = JSON.parse(savedReadingBanks);
                updateReadingBankList();
            } catch (e) {
                console.error('Failed to parse reading question banks:', e);
            }
        }

        // ========================================
        // üéÆ MEMORY GAME SYSTEM (Waiting Page)
        // ========================================
        const gameEmojis = ['üåü', 'üé®', 'üé≠', 'üé™', 'üéØ', 'üé≤', 'üé∏', 'üé∫', 'üéª', 'üéÆ', 'üèÄ', '‚öΩ'];
        let gameCards = [];
        let flippedCards = [];
        let matchedCards = new Set();
        let gameStarted = false;
        let gameTimer = null;
        let gameTime = 0;
        let gameMoves = 0;
        let isChecking = false;
        let bestGameTime = localStorage.getItem('memoryGameBestTime') ? parseInt(localStorage.getItem('memoryGameBestTime')) : null;
        let bestGameMoves = localStorage.getItem('memoryGameBestMoves') ? parseInt(localStorage.getItem('memoryGameBestMoves')) : null;

        function initializeMemoryGame() {
            const grid = document.getElementById('memory-game-grid');
            const pairsCount = 12;
            gameCards = [];
            flippedCards = [];
            matchedCards.clear();
            gameMoves = 0;
            gameTime = 0;

            // Âª∫Á´ãÂç°ÁâáÂ∞çÔºàÊØèÂÄãemojiÂá∫ÁèæÂÖ©Ê¨°Ôºâ
            const cardSet = [];
            for (let i = 0; i < pairsCount; i++) {
                cardSet.push(gameEmojis[i], gameEmojis[i]);
            }

            // Êâì‰∫ÇÂç°Áâá
            for (let i = cardSet.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardSet[i], cardSet[j]] = [cardSet[j], cardSet[i]];
            }

            // ÁîüÊàêÂç°Áâá DOM
            grid.innerHTML = '';
            cardSet.forEach((emoji, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card bg-gradient-to-br from-purple-400 to-blue-500 rounded-lg p-2 sm:p-3 cursor-pointer transform transition-all duration-300 hover:scale-105 shadow-lg flex items-center justify-center text-3xl sm:text-4xl md:text-5xl h-16 sm:h-20 md:h-24';
                card.dataset.index = index;
                card.dataset.emoji = emoji;
                card.textContent = '?';
                card.addEventListener('click', () => flipCard(card, index));
                grid.appendChild(card);
                gameCards.push({ emoji, revealed: false, matched: false });
            });

            // Êõ¥Êñ∞ UI
            updateGameStats();
            document.getElementById('game-completion-msg').classList.add('hidden');
            document.getElementById('start-game-btn').classList.add('hidden');
            document.getElementById('reset-game-btn').classList.remove('hidden');
        }

        function flipCard(cardElement, index) {
            if (!gameStarted || gameCards[index].matched || flippedCards.includes(index) || isChecking) return;

            // ÈñãÂßãË®àÊôÇ
            if (gameStarted && !gameTimer) {
                gameTimer = setInterval(() => {
                    gameTime++;
                    document.getElementById('game-time').textContent = gameTime + 'Áßí';
                }, 1000);
            }

            // üéÆ Ê∑ªÂä†3DÁøªËΩâÂãïÁï´
            cardElement.classList.add('flip-animation');
            
            // ÁøªËΩâÂç°Áâá
            flippedCards.push(index);
            cardElement.textContent = gameCards[index].emoji;
            cardElement.classList.add('flipped');

            // Ê™¢Êü•ÈÖçÂ∞ç
            if (flippedCards.length === 2) {
                isChecking = true;
                gameMoves++;
                updateGameStats();

                const [idx1, idx2] = flippedCards;
                if (gameCards[idx1].emoji === gameCards[idx2].emoji) {
                    // ÈÖçÂ∞çÊàêÂäü - ÊáâÁî®Á∂†Ëâ≤ÁôºÂÖâÊïàÊûú
                    const card1 = document.querySelector(`[data-index="${idx1}"]`);
                    const card2 = document.querySelector(`[data-index="${idx2}"]`);
                    
                    gameCards[idx1].matched = true;
                    gameCards[idx2].matched = true;
                    matchedCards.add(idx1);
                    matchedCards.add(idx2);
                    
                    setTimeout(() => {
                        if (card1) card1.classList.add('matched-success');
                        if (card2) card2.classList.add('matched-success');
                    }, 200);
                    
                    flippedCards = [];
                    isChecking = false;

                    // Ê™¢Êü•ÊòØÂê¶ÂÆåÊàê
                    if (matchedCards.size === gameCards.length) {
                        completeGame();
                    }
                } else {
                    // ÈÖçÂ∞çÂ§±Êïó - ÊáâÁî®Á¥ÖËâ≤ÊäñÂãïÊïàÊûú
                    const card1 = document.querySelector(`[data-index="${idx1}"]`);
                    const card2 = document.querySelector(`[data-index="${idx2}"]`);
                    
                    setTimeout(() => {
                        if (card1) card1.classList.add('matched-fail');
                        if (card2) card2.classList.add('matched-fail');
                    }, 200);
                    
                    setTimeout(() => {
                        if (card1) {
                            card1.textContent = '?';
                            card1.classList.remove('flipped', 'matched-fail');
                        }
                        if (card2) {
                            card2.textContent = '?';
                            card2.classList.remove('flipped', 'matched-fail');
                        }
                        flippedCards = [];
                        isChecking = false;
                    }, 800);
                }
            }
        }

        function updateGameStats() {
            document.getElementById('game-matches').textContent = matchedCards.size / 2;
            document.getElementById('game-moves').textContent = gameMoves;
        }

        function completeGame() {
            gameStarted = false;
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }

            // üèÜ Êõ¥Êñ∞ÊúÄ‰Ω≥ÊàêÁ∏æ
            let isNewBestTime = false;
            let isNewBestMoves = false;
            
            if (!bestGameTime || gameTime < bestGameTime) {
                bestGameTime = gameTime;
                localStorage.setItem('memoryGameBestTime', bestGameTime);
                isNewBestTime = true;
            }
            
            if (!bestGameMoves || gameMoves < bestGameMoves) {
                bestGameMoves = gameMoves;
                localStorage.setItem('memoryGameBestMoves', bestGameMoves);
                isNewBestMoves = true;
            }

            document.getElementById('final-time').textContent = gameTime;
            document.getElementById('final-moves').textContent = gameMoves;
            
            // üéâ È°ØÁ§∫ÊúÄ‰Ω≥ÊàêÁ∏æ
            let bestScoreText = 'üìä ÊúÄ‰Ω≥ÊàêÁ∏æ: ';
            if (bestGameTime) bestScoreText += `‚è±Ô∏è ${bestGameTime}Áßí`;
            if (bestGameTime && bestGameMoves) bestScoreText += ' | ';
            if (bestGameMoves) bestScoreText += `üéØ ${bestGameMoves}Ê¨°ÁøªËΩâ`;
            
            let recordMessage = '';
            if (isNewBestTime && isNewBestMoves) {
                recordMessage = ' üéä Êñ∞Á¥ÄÈåÑÔºÅÈõôÊñôÂÜ†ËªçÔºÅ';
            } else if (isNewBestTime) {
                recordMessage = ' ‚ö° Êñ∞ÁöÑÈÄüÂ∫¶Á¥ÄÈåÑÔºÅ';
            } else if (isNewBestMoves) {
                recordMessage = ' üéØ ÊúÄÂ∞ëÁøªËΩâÊ¨°Êï∏ÔºÅ';
            }
            
            const completionMsg = document.getElementById('game-completion-msg');
            const finalTimeEl = document.getElementById('final-time');
            if (finalTimeEl) {
                finalTimeEl.parentElement.innerHTML = `Áî®ÊôÇ: <span id="final-time">${gameTime}</span> Áßí | ÁøªËΩâÊ¨°Êï∏: <span id="final-moves">${gameMoves}</span> Ê¨°${recordMessage}`;
            }
            
            // üéä Ëß∏ÁôºÂΩ©Â∏∂ÊÖ∂Á•ùÂãïÁï´
            if (typeof confetti !== 'undefined') {
                const duration = 3000;
                const animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10000 };

                function randomInRange(min, max) {
                    return Math.random() * (max - min) + min;
                }

                const interval = setInterval(function() {
                    const timeLeft = animationEnd - Date.now();

                    if (timeLeft <= 0) {
                        return clearInterval(interval);
                    }

                    const particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, {
                        particleCount,
                        origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
                    }));
                    confetti(Object.assign({}, defaults, {
                        particleCount,
                        origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
                    }));
                }, 250);
            }

            completionMsg.classList.remove('hidden');
            document.getElementById('reset-game-btn').classList.remove('hidden');
        }

        function resetGame() {
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            document.getElementById('start-game-btn').classList.remove('hidden');
            document.getElementById('reset-game-btn').classList.add('hidden');
            document.getElementById('game-completion-msg').classList.add('hidden');
            gameStarted = false;
            gameTime = 0;
            gameMoves = 0;
            flippedCards = [];
            matchedCards.clear();
            isChecking = false;
            document.getElementById('game-time').textContent = '0Áßí';
            document.getElementById('game-matches').textContent = '0';
            document.getElementById('game-moves').textContent = '0';
            
            // Ê∏ÖÈô§ÊâÄÊúâÂãïÁï´È°û
            const grid = document.getElementById('memory-game-grid');
            if (grid) {
                grid.querySelectorAll('.memory-card').forEach(card => {
                    card.classList.remove('flip-animation', 'matched-success', 'matched-fail', 'flipped');
                });
            }
        }

        // ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        document.getElementById('start-game-btn').addEventListener('click', () => {
            initializeMemoryGame();
            gameStarted = true;
        });

        document.getElementById('reset-game-btn').addEventListener('click', resetGame);

        // --- Start Application ---
        initialize();
        setupEventListeners(); // Call setupEventListeners only once here.

    </script>
</body>
</html>